<?php
require_once 'app/model/database.php';
require_once 'app/model/model.ftc.php';
require_once 'app/model/class.ctrid.php';
require_once 'app/model/verificaID.php';
require_once 'app/model/pegaso.model.reparto.php';
require_once 'app/views/unit/commonts/numbertoletter.php';
require_once 'app/model/facturacion.php';
require_once 'app/controller/controller.coi.php';
require_once 'app/simplexlsx-master/src/SimpleXLSX.php';

class pegaso extends database{
	/*Comprueba datos de login*/
	function AccesoLogin($user, $pass){
		$u=$user;
			$this->creaPeriodo();
			$this->query = "SELECT  USER_LOGIN, USER_PASS, USER_ROL, LETRA, LETRA2, LETRA3, LETRA4, LETRA5, LETRA6, NUMERO_LETRAS, NOMBRE, CC, CR, aux_comp, COORDINADOR_COMP, USER_EMAIL, POLIZA_TIPO, CATEGORIA 
						FROM PG_USERS 
						WHERE USER_LOGIN = '$u' and USER_PASS = '$pass' and user_status = 'alta'"; /*Contraseña va encriptada con MD5*/
		 	$res = $this->EjecutaQuerySimple();
		 	$log = ibase_fetch_object($res);
		 	if(isset($log) > 0){
				/*Creamos variable de sesion*/
					$mySQL = new ftc;
					$empresas = $mySQL->loginMysql($user, $pass);	
					$_SESSION['user'] = $log;
					$_SESSION['coi']=$empresas;
					$logFtc=$this->registroLogin();
					return $_SESSION['user'];				
			}else{
				echo 'Retorna: 0';
				return 0;
			}
	}

	function creaPeriodo(){
		$mes = date('n');
		$anio = date('Y');
		if($mes == 12){
			$mes = 1;
			$anio = $anio + 1;
		}
		$this->query="SELECT * FROM PERIODOS_2016 WHERE numero=$mes AND ANHIO = $anio";
		$rs=$this->EjecutaQuerySimple();
		$row=ibase_fetch_object($rs);
		if(empty($row)){
			$this->query="INSERT INTO PERIODOS_2016 (id, nombre, numero, fecha_ini, fecha_fin, anhio, siguiente) 
							values (null, (SELECT MAX(NOMBRE) FROM PERIODOS_2016 WHERE numero = ($mes + 1)), $mes +1, (SELECT MAX(fecha_ini) FROM PERIODOS_2016 WHERE numero = ($mes + 1)), (SELECT MAX(fecha_fin) FROM PERIODOS_2016 WHERE numero = ($mes + 1)), $anio, (SELECT MAX(SIGUIENTE) FROM PERIODOS_2016 WHERE numero = ($mes + 1)))";
			$this->grabaBD();
		}
		return;
	}

	function registroLogin(){
		$usuario =$_SESSION['user']->USER_LOGIN;
		$nombre = $_SESSION['user']->NOMBRE;
		$ip= $_SERVER['REMOTE_ADDR'];
		$equipo=php_uname();
		$p=session_id();
		$pn=$_SERVER['HTTP_USER_AGENT'];
		//echo 'Nombre de la session de PHP:'.$pn;
		$this->query="INSERT INTO FTC_INICIO_LOGS (ID, USR_LOGIN, USR_NOMBRE, USR_EQUIPO, FECHA, STATUS, IP, PHP, navegador)
							VALUES (null, '$usuario', '$nombre', '$equipo',current_timestamp, 'I','$ip', '$p', '$pn')";
		$this->grabaBD();
		if($usuario == 'ofarias' and $_SESSION['empresa']['auto']== 'si'){
			$this->revisaParametros($uuid = false);
		}
		return;
	}

	function revisaParametros($uuid){
		$data=array();
		$data2=array();
		$fi = $_SESSION['empresa']['fecha_inicio'];
		if(!empty($uuid)){
			$this->query="SELECT * FROM XML_DATA XD LEFT JOIN XML_POLIZAS XP ON XP.UUID = XD.UUID WHERE XD.UUID = '$uuid'";
		}else{
			$this->query="SELECT * FROM XML_DATA XD LEFT JOIN XML_POLIZAS XP ON XP.UUID = XD.UUID WHERE XD.STATUS = 'P' and (XD.TIPO = 'I' or XD.TIPO = 'E') and xd.fecha >= '$fi' ";
		}

		$rs=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($rs)) {
			$data[]=$tsArray;
		}
		if(count($data)>0){
			$controller_coi = new controller_coi;
			foreach($data as $k){
				$tcont = $_SESSION['empresa']['rfc'] == $k->CLIENTE? 'rfce':'cliente';
				$tip=$_SESSION['empresa']['rfc'] == $k->CLIENTE? 'Proveedor':'Cliente';
				$this->query="SELECT xd.*, xpa.cuenta_Contable as pcc, xc.cuenta_Contable as ccc FROM XML_DATA XD LEFT JOIN XML_PARTIDAS XPA ON XPA.UUID = XD.UUID left join xml_clientes xc on xd.$tcont = xc.rfc and xc.tipo = '$tip' where xd.uuid='$k->UUID'";
				$r=$this->EjecutaQuerySimple();
					while ($tsA=ibase_fetch_object($r)) {
						$data2[]=$tsA;
					}
				$ln=0;
				$l= 0;
				foreach ($data2 as $key){
					$ln++;
					if(empty($key->CCC)){
						unset($data2);
					}else{
						if(!empty($key->PCC)){
							$l++;
						}
					}
				}
				if($ln == $l){
					$tipo = 'Dr';
					$uuid = $key->UUID;
					$ide = $_SESSION['empresa']['rfc'] == $key->CLIENTE? 'Recibidos':'Emitidos';
					//$ide = $_SESSION['empresa']['ide'];
					//exit('Valor de IDE. '.$ide);
					$res=$controller_coi->creaPoliza($tipo, $uuid, $ide);
					//exit('Realizar la poliza del uuid '.$k->UUID.' con la respuesta: '.print_r($res));
				}
				//exit('No se pudo realizar la poliza del uuid '.$k->UUID);
				unset($data2);
			}
		}
	}

	function salir(){
		$php= session_id();
		$usuario = $_SESSION['user']->USER_LOGIN;
		$this->query="UPDATE FTC_INICIO_LOGS SET STATUS = 'O', salida = current_timestamp WHERE PHP='$php' and USR_LOGIN='$usuario' and status='I' ";
		$this->EjecutaQuerySimple();
		//$_SESSION=array();
        	//header('Location: index.php?action=login');
        	return;
	}

	function cambioSenia($nuevaSenia, $actual, $usuario){
		$nuevaSenia = md5($nuevaSenia);
		$actual= md5($actual);
		$a='';
		$this->query="SELECT IIF(USER_PASS IS NULL, 0, USER_PASS) AS PASSWORD, IIF(ID IS NULL, 0 , ID) AS ID FROM PG_USERS WHERE USER_LOGIN = '$usuario'";
		$rs=$this->EjecutaQuerySimple();
		$row=ibase_fetch_object($rs);
		$pass = $row->PASSWORD;
		$id=$row->ID;
		if( $pass == $actual){
			$this->query="UPDATE PG_USERS SET user_pass = '$nuevaSenia' where id = $id";
			$this->EjecutaQuerySimple();
			$a=array("status"=>'ok', "mensaje"=>'Cambio la contraseña');
		}
		return $a;
	}

	function cambioMultiple($nuevaSenia, $actual, $usuario, $data){
        $o = $_SESSION['bd'];
       	$nuevaSenia=md5($nuevaSenia);
        foreach($data as $emp){
        	$_SESSION['bd']=$emp['rutaBD'];
			$this->query="UPDATE PG_USERS SET user_pass = '$nuevaSenia' where id = (SELECT ID FROM PG_USERS WHERE USER_LOGIN = '$usuario')";
			$this->EjecutaQuerySimple();
			$a=array("status"=>'ok', "mensaje"=>'Cambio la contraseña');
			$_SESSION['bd']=$o;
        }
        return;
    }
///// Lista los pedidos PENDIENTES.
	function LPedidos(){
		$l = $_SESSION['user']->LETRA;
		$l2 = $_SESSION['user']->LETRA2;
		$l3 = $_SESSION['user']->LETRA3;
		$l4 = $_SESSION['user']->LETRA4;
		$l5 = $_SESSION['user']->LETRA5;
		$l6 = $_SESSION['user']->LETRA6;
		$n = $_SESSION['user']->NUMERO_LETRAS;
		if ($n==1){
		$this ->query = " SELECT cotiza, max(nom_cli) as cliente,max (urgente) as urgente, max(fechasol) as fecha, sum (cant_orig) as piezas, sum(ordenado) as Ordenado, count (prod) as productos, MAX(current_timestamp) as HOY, MAX(datediff(day, fechasol, current_date )) as Dias, MAX(FACTURA) as factura, max (importe) as importe
                          from preoc01 a
                          where status_ventas = 'Pe' and (letra_v = '$l') group by cotiza";  
        }elseif($n==2){
		$this ->query = " SELECT cotiza, max(nom_cli) as cliente,max (urgente) as urgente, max(fechasol) as fecha, sum (cant_orig) as piezas, sum(ordenado) as Ordenado, count (prod) as productos, MAX(current_timestamp) as HOY, MAX(datediff(day, fechasol, current_date )) as Dias, MAX(FACTURA) as factura, max (importe) as importe
                          from preoc01 a
                          where  status_ventas = 'Pe' and (letra_v = '$l' or letra_v = '$l2')
                          group by cotiza";
        }elseif($n==3){
		$this ->query = " SELECT cotiza, max(nom_cli) as cliente,max (urgente) as urgente, max(fechasol) as fecha, sum (cant_orig) as piezas, sum(ordenado) as Ordenado, count (prod) as productos, MAX(current_timestamp) as HOY, MAX(datediff(day, fechasol, current_date )) as Dias, MAX(FACTURA) as factura, max (importe) as importe
                          from preoc01 a
                          where  status_ventas = 'Pe' and (letra_v = '$l' or letra_v = '$l2' or letra_v = '$l3)' 
                          group by cotiza";

        }elseif($n==5){
		$this ->query = " SELECT cotiza, max(nom_cli) as cliente,max (urgente) as urgente, max(fechasol) as fecha, sum (cant_orig) as piezas, sum(ordenado) as Ordenado, count (prod) as productos, MAX(current_timestamp) as HOY, MAX(datediff(day, fechasol, current_date )) as Dias, MAX(FACTURA) as factura, max (importe) as importe
                          from preoc01 a
                          where status_ventas = 'Pe' AND (letra_v = '$l' or letra_v = '$l2' or letra_v = '$l3' or letra_v = '$l4' or letra_v = '$l5') 
                          group by cotiza";

        }elseif($n==6){
		$this ->query = " SELECT cotiza, max(nom_cli) as cliente,max (urgente) as urgente, max(fechasol) as fecha, sum (cant_orig) as piezas, sum(ordenado) as Ordenado, count (prod) as productos, MAX(current_timestamp) as HOY, MAX(datediff(day, fechasol, current_date )) as Dias, MAX(FACTURA) as factura, max (importe) as importe
                          from preoc01 a
                          where status_ventas = 'Pe' AND (letra_v = '$l' or letra_v = '$l2' or letra_v = '$l3' or letra_v = '$l4' or letra_v = '$l5' or letra_v = '$l6') 
                          group by cotiza";

        }elseif($n==99){
        $this ->query = " SELECT cotiza, max(nom_cli) as cliente,max (urgente) as urgente, max(fechasol) as fecha, sum (cant_orig) as piezas, sum(ordenado) as Ordenado, count (prod) as productos, MAX(current_timestamp) as HOY, MAX(datediff(day, fechasol, current_date )) as Dias, MAX(FACTURA) as factura, max (importe) as importe
                          from preoc01 a
                          where status_ventas = 'Pe'
                          group by cotiza";	
        }
                          //status_ventas is null or (status_ventas ='') and '
		$result = $this->EjecutaQuerySimple();
		if($this->NumRows($result)>0){
			while ( $tsArray = $this->FetchAs($result))
				$data[]=$tsArray;
		
				return $data;
		}	
	return 0;
	}

	function get_client_ip_env() {
	    $ipaddress = '';
	    if (getenv('HTTP_CLIENT_IP'))
	        $ipaddress = getenv('HTTP_CLIENT_IP');
	    else if(getenv('HTTP_X_FORWARDED_FOR'))
	        $ipaddress = getenv('HTTP_X_FORWARDED_FOR');
	    else if(getenv('HTTP_X_FORWARDED'))
	        $ipaddress = getenv('HTTP_X_FORWARDED');
	    else if(getenv('HTTP_FORWARDED_FOR'))
	        $ipaddress = getenv('HTTP_FORWARDED_FOR');
	    else if(getenv('HTTP_FORWARDED'))
	        $ipaddress = getenv('HTTP_FORWARDED');
	    else if(getenv('REMOTE_ADDR'))
	        $ipaddress = getenv('REMOTE_ADDR');
	    else
	        $ipaddress = 'UNKNOWN';
	    return $ipaddress;
	}
	/// LISTA TODOS LOS PEDIDOS.

	function LPedidosTodos(){
		
		$l = $_SESSION['user']->LETRA;
		$l2 = $_SESSION['user']->LETRA2;
		$l3 = $_SESSION['user']->LETRA3;
		$l4 = $_SESSION['user']->LETRA4;
		$l5 = $_SESSION['user']->LETRA5;
		$n = $_SESSION['user']->NUMERO_LETRAS;

		if ($n == 1){
		$this ->query = " SELECT cotiza, max(nom_cli) as cliente,max (urgente) as urgente, max(fechasol) as fecha, sum (cant_orig) as piezas, sum(ordenado) as Ordenado, count (prod) as productos, MAX(current_timestamp) as HOY, MAX(datediff(day, fechasol, current_date )) as Dias, MAX(FACTURA) as factura, max (importe) as importe
                          from preoc01 a
                          where letra_v = '$l' 
                          group by cotiza";
                          echo $l." ".$n;
        }elseif($n == 2){
		$this ->query = " SELECT cotiza, max(nom_cli) as cliente,max (urgente) as urgente, max(fechasol) as fecha, sum (cant_orig) as piezas, sum(ordenado) as Ordenado, count (prod) as productos, MAX(current_timestamp) as HOY, MAX(datediff(day, fechasol, current_date )) as Dias, MAX(FACTURA) as factura, max (importe) as importe
                          from preoc01 a
                          where letra_v = '$l' or letra_v = '$l2' 
                          group by cotiza";
                          echo $l;
        
        }elseif($n == 3){
		$this ->query = " SELECT cotiza, max(nom_cli) as cliente,max (urgente) as urgente, max(fechasol) as fecha, sum (cant_orig) as piezas, sum(ordenado) as Ordenado, count (prod) as productos, MAX(current_timestamp) as HOY, MAX(datediff(day, fechasol, current_date )) as Dias, MAX(FACTURA) as factura, max (importe) as importe
                          from preoc01 a
                          where letra_v = '$l' or letra_v = '$l2' or letra_v = '$l3' 
                          group by cotiza";
                          echo $l;
        }elseif($n==5){
        $this ->query = " SELECT cotiza, max(nom_cli) as cliente,max (urgente) as urgente, max(fechasol) as fecha, sum (cant_orig) as piezas, sum(ordenado) as Ordenado, count (prod) as productos, MAX(current_timestamp) as HOY, MAX(datediff(day, fechasol, current_date )) as Dias, MAX(FACTURA) as factura, max (importe) as importe
                          from preoc01 a
                          where letra_v = '$l' or letra_v = '$l2' or letra_v = '$l3' or letra_v = '$l4' or letra_v = '$l5' 
                          group by cotiza";      
        }elseif($n==6){
        $this ->query = " SELECT cotiza, max(nom_cli) as cliente,max (urgente) as urgente, max(fechasol) as fecha, sum (cant_orig) as piezas, sum(ordenado) as Ordenado, count (prod) as productos, MAX(current_timestamp) as HOY, MAX(datediff(day, fechasol, current_date )) as Dias, MAX(FACTURA) as factura, max (importe) as importe
                          from preoc01 a
                          where letra_v = '$l' or letra_v = '$l2' or letra_v = '$l3' or letra_v = '$l4' or letra_v = '$l5' or letra_v = '$l6' 
                          group by cotiza";      
        }elseif($n==99){ $this ->query = " SELECT cotiza, max(nom_cli) as cliente,max (urgente) as urgente, max(fechasol) as fecha, sum (cant_orig) as piezas, sum(ordenado) as Ordenado, count (prod) as productos, MAX(current_timestamp) as HOY, MAX(datediff(day, fechasol, current_date )) as Dias, MAX(FACTURA) as factura, max (importe) as importe
                          from preoc01 a
                          group by cotiza";      
        }
                          //status_ventas is null or (status_ventas ='') and '
		$result = $this->EjecutaQuerySimple();
		if($this->NumRows($result)>0){
			while ( $tsArray = $this->FetchAs($result))
				$data[]=$tsArray;
		
				return $data;
		}	
	return 0;	
	}
	/*consulta para mostrar los componentes dados de alta*/
	function MuestraComp(){
		$this->query = "SELECT a.ID, a.SEG_NOMBRE, a.SEG_DURACION, a.SEG_TIPO, a.USUARIO, a.FECHAR_CREACION, a.FECHA_MODIFICACION, a.STATUS
						FROM PG_SEGCOMP a 
						WHERE status = 'alta' ORDER BY a.SEG_NOMBRE ASC";
		$result = $this->EjecutaQuerySimple();
		if($this->NumRows($result) > 0){
			while ( $tsArray = $this->FetchAs($result) ) 
					$data[] = $tsArray;			
		
				return $data;
		}
		
		return 0;
	}

	//// Inicia el Detalle del Pedido.

	function CabeceraPedidoDoc($doc){

		$this->query = "SELECT a.CVE_DOC, b.nombre, a.fechaelab, a.can_tot, a.importe, current_timestamp as Hoy, datediff(day,a.fecha_doc, current_date ) as Dias
						from factp01 a left join clie01 b on a.cve_clpv = b.clave where cve_doc = '$doc'";
		$result = $this->QueryObtieneDatosN();
			while ( $tsArray = ibase_fetch_object($result)){ 
					$data[] = $tsArray;			
			}
				return $data;
	}


	function LoginA($user, $pass){
		session_cache_limiter('private_no_expire');
		$data = new pegaso;
			$rs = $data->AccesoLogin($user, $pass);
			//var_dump($rs);
				if(count($rs) > 0){					
					$r = $data->CompruebaRol($user);
					//var_dump($r);
					switch ($r->USER_ROL){
						case 'administrador':
						$this->MenuAdmin();
						break;
						case 'administracion':
						$this->MenuAd();
						break;
						case 'usuario':
						$this->MenuUsuario();
						break;
						case 'ventas':
						$this->MenuVentas();
						break;
						case 'compras':
						$this->MenuCompras();
						break;
						case 'recepcion':
						$this->MenuRecep();
						break;
						default:
						$e = "Error en acceso 1, favor de revisar usuario y/o contraseña";
						header('Location: index.php?action=login&e='.urlencode($e)); exit;
						break;
						}
					/*if($r->USER_ROL == 'administrador'){ /*Cambio el fetch_assoc cambia la forma en acceder al dato
						$this->MenuAdmin();
					}elseif($r->USER_ROL == 'administracion'){
						$this->MenuAd();
					}elseif($r->USER_ROL == 'usuario'){
						$this->MenuUsuario();
					}else{
						
						
					}*/
				}else{
					$e = "Error en acceso 2, favor de revisar usuario y/o contraseña";
						header('Location: index.php?action=login&e='.urlencode($e)); exit;
				}
	}

	function DetallePedidoDoc($doc){

			$this->query = "SELECT a.id, a.cotiza as pedido, a.nom_cli, a.urgente, a.fact_ant, a.fechasol, a.prod, a.nomprod,  a.cant_orig , a.status, b.cve_doc as Orden_de_Compra, b.CANT as Cant_Solicitada, b.status, a.rest as Falta_Solicitar, c.cve_doc as Recepcion, c.cant as Cant_Recibida, a.REC_faltante, c.status , d.cve_doc as factura, d.fechaelab as fecha_fac, d.importe, e.cve_doc as remision, e.fechaelab as Fecha_rem, f.tp_tes, f.ruta, f.unidad
                from preoc01 a
                left join par_compo01 b on a.id = b.id_preoc  and b.status <> 'C'
                left join compo01 f on b.cve_doc = f.cve_doc
                left join par_compr01 c on b.cve_doc = c.doc_ant and a.id = c.id_preoc and c.status <> 'C'
                left join factf01 d on  a.cotiza = d.doc_ant and d.status <> 'C'
                left join factr01 e on a.cotiza = e.doc_ant and e.status <> 'C'
                where cotiza = '$doc'";
		$result = $this->QueryObtieneDatosN();

		$result = $this->QueryObtieneDatosN();
			
			while ( $tsArray = ibase_fetch_object($result)){ 
					$data[] = $tsArray;			
			}
				return $data;
	}


	/// INICIA la Orden de compra, Cabecera y Detalles.
	function CabeceraDoc($doc){
		$this->query = "select a.CVE_DOC, b.nombre, a.fechaelab, a.can_tot, a.importe, current_timestamp as Hoy, datediff(day,a.fecha_doc, current_date ) as Dias
						from compo01 a left join PROV01 b on a.cve_clpv = b.clave where cve_doc =  '$doc'";
		$result = $this->QueryObtieneDatosN();
			while ( $tsArray = ibase_fetch_object($result)){ 
					$data[] = $tsArray;			
			}
				return $data;
	}

	/// Detalles del documento

	function DetalleDoc($doc){
		$this->query = "SELECT a.cve_art, b.descr, a.num_par, a.cant, a.pxr, a.cost, a.uni_venta, a.num_alm, a.tot_partida, a.doc_recep, a.doc_recep_status, a.fecha_doc_recep
						from par_compo01 a 
						left join inve01 b on a.cve_art = b.cve_art 
						where cve_doc = '$doc'";
		$result = $this->QueryObtieneDatosN();
			while ( $tsArray = ibase_fetch_object($result)){ 
					$data[] = $tsArray;			
			}
				return $data;
	}


	

	/// Asigna la Unidad o Asigna Ruta.
		
	function ARuta(){
		$data=array();
		$this->query="SELECT iif(a.docs is null, 'No', a.docs) as DOCS, a.cve_doc, b.nombre, a.fecha_pago, a.pago_tes, a.tp_tes, a.pago_entregado, c.camplib2 , a.unidad, a.estado, a.fechaelab, (datediff(day, a.fechaelab, current_date )) as Dias, a.urgencia, b.codigo, b.estado as estadoprov, a.vueltas
					    from compo01 a
						left join prov01 b on a.cve_clpv = b.clave
						left join compo_clib01 c on a.cve_doc = c.clave_doc
						where a.status <> 'C' AND status_log = 'Nuevo' and tp_tes is not Null ";

		$result = $this->QueryObtieneDatosN();
			while ( $tsArray = ibase_fetch_object($result)){ 
					$data[] = $tsArray;			
			}
		/// Codigo para anexar las nuevas Ordenes de Compra:
		$this->query="SELECT iif(ftc.docs is null, 'No', ftc.docs) as DOCS, ftc.OC AS cve_doc, p.nombre, ftc.fecha_pago, ftc.pago_tes, ftc.tp_tes, '' as pago_entregado, ftc.tipo as camplib2, ftc.unidad, '' as estado, ftc.fecha_oc as fechaelab, datediff(day, ftc.fecha_oc, current_date) as dias, '' as urgencia, p.codigo, p.estado as estadoprov, ftc.vueltas 
			from ftc_poc ftc
			left join prov01 p on ftc.cve_prov = p.clave 
			where (ftc.status ='PAGADA' or ftc.status = 'LOGISTICA') 
			and ftc.status_log = 'Nuevo' 
			and tp_tes is not null ";
  
		$result = $this->QueryObtieneDatosN();
			while ( $tsArray = ibase_fetch_object($result)){ 
					$data[] = $tsArray;			
			}
		return $data;
	}

         
    function InsertaNUnidad($numero, $marca, $modelo, $placas, $operador, $tipo, $tipo2, $coordinador){
    	$this->query = "INSERT INTO unidades (NUMERO, MARCA, MODELO, PLACAS, OPERADOR, TIPO, TIPO2, COORDINADOR, STATUS)
                                VALUES ('$numero', '$marca', '$modelo', '$placas', '$operador','$tipo', '$tipo2', '$coordinador', 'A')";
		$rs = $this->EjecutaQuerySimple();
		return $rs;
    }     
	function altaunidades1($numero, $marca, $modelo, $placas, $operador, $tipo){
		$idu = $this->obtieneidu();
		$iduf = $idu + 1;
		$this->query = "INSERT INTO unidades (IDU, NUMERO, MARCA, MODELO, PLACAS, OPERADO, TIPO, STATUS)
				VALUES ($idu, '$numero', '$marca', '$modelo', '$placas', '$operador','$tipo', 'A')";
				$rs = $this->EjecutaQuerySimple();
		unset($iduf);
		return $rs;
	}

	function obtieneidu(){
		$this->query="SELECT count(*) FROM unidades";
		$result = $this->QueryObtieneDatosN();
			while ( $tsArray = ibase_fetch_object($result)){ 
					return $tsArray->COUNT;		
			}
				
	}

	function GuardaPagoCorrecto($cuentaban, $docu, $tipop, $monto, $nomprov, $cveclpv, $fechadoc){
		$TIME = time();
		$HOY = date("Y-m-d H:i:s", $TIME);
		$usuario= $_SESSION['user']->NOMBRE;
		//echo 'Logitud: '.strlen($docu).'<br/>';
		if(substr($docu,0,2) != 'OP' and strlen($docu)>7){
			$this->query="UPDATE compo01
					  SET TP_TES = '$tipop', PAGO_TES = $monto, FECHA_PAGO = '$HOY', STATUS_PAGO = 'PP'
					  WHERE Trim(CVE_DOC) = trim('$docu')";
		}elseif(substr($docu,0,2) == 'OP' or strlen($docu < 6)){
			//echo 'Entra a actualizar FTC_POC<br/>';
			$this->query="UPDATE FTC_POC_DETALLE set status_real = 'LOGISTICA 1' where OC = '$docu'";
			$this->EjecutaQuerySimple();

			$this->query="UPDATE ftc_poc
					  SET TP_TES = '$tipop', PAGO_TES = $monto, FECHA_PAGO = '$HOY', STATUS = 'PAGADA'
					  WHERE Trim(OC) = trim('$docu')";
			//echo $this->query;
		}elseif(substr($docu, 0,1 !='O')){
			echo 'El pago es de una solicitud';
			$this->query="UPDATE SOLICITUD_PAGO
						SET TP_TES_FINAL='$tipop' , MONTO_FINAL=$monto, BANCO_FINAL = '$cuentaban', fecha_reg_pago_final = current_date, fecha_pago = current_timestamp, status = 'Pagado', usuario_pago = '$usuario'
						where idsol =$docu";
			$rs = $this->EjecutaQuerySimple();
			$this->query="SELECT MAX(FOLIO) as FOLIO FROM SOLICITUD_PAGO WHERE TP_TES_FINAL ='$tipop'";
			$res=$this->QueryObtieneDatosN();
			$row = ibase_fetch_object($res);
			$folioNuevo = $row->FOLIO + 1;
			$this->query = "UPDATE SOLICITUD_PAGO SET FOLIO = $folioNuevo where idsol = $docu";
			$result = $this->EjecutaQuerySimple();
			return $rs;
		}else{
				$this->query="UPDATE compR01
					  SET TP_TES = '$tipop', PAGO_TES = $monto, FECHA_PAGO = '$HOY', STATUS_PAGO = 'PP'
					  WHERE Trim(CVE_DOC) = trim('$docu')";
		}
		$rs = $this->EjecutaQuerySimple();
		$rs+= $this->ActPagoParOC($docu, $tipop, $monto, $nomprov, $cveclpv, $fechadoc, $cuentaban);
		$rs += $this->GuardaCuentaBan($docu, $cuentaban);
		return $rs;
	}

	function GuardaCuentaBan($docu, $cuentaban){
		$this->query = "INSERT INTO 
							pg_pagoBanco
							(documento, cuenta, Banco)
						VALUES
							('$docu', '$cuentaban',TRIM(SUBSTRING('$cuentaban' from 1 for 8)))";
		$rs = $this->EjecutaQuerySimple();
	}
	/// Insertar Pagos a tablas P_CHEQUES
	function ActPagoParOC($docu, $tipop, $monto, $nomprov, $cveclpv, $fechadoc, $cuentaban){
		$TIME = time();
		$HOY = date("Y-m-d H:i:s", $TIME);
		$iva = $monto - ($monto / 1.16);
		$usuario = $_SESSION['user']->NOMBRE;

		//echo 'Tipo: '.$tipop.'<p>';
		if($tipop == 'ch'){
		$query="INSERT INTO P_CHEQUES (TIPO, FECHA, MONTO, BENEFICIARIO, IVA, DOCUMENTO, FECHAELAB, CVE_PROV,STATUS,FECHA_DOC, FECHA_APLI, CHEQUE, USUARIO_PAGO, BANCO) VALUES (";
		$query .=" '".$tipop."',";
		$query .=" '".$fechadoc."',";
		$query .=" '".$monto."',";
		$query .=" '".$nomprov."',";
		$query .=" '".$iva."',";
		$query .=" '".$docu."',";
		$query .=" '".$HOY."',";
		$query .=" '".$cveclpv."',";
		$query .=" 'N',";
		$query .=" '".$HOY."',";
		$query .=" '".$HOY."',";
		$query .=" '0',";
		$query .=" '$usuario',";
		$query .=" '$cuentaban'";
		$query .=")"; 
		//echo $query;
		$this->query =$query;
		$rs = $this->EjecutaQuerySimple();

		}elseif ($tipop == 'tr') {
		
		//echo 'Es de transfer: <p>';

		$query="INSERT INTO P_TRANS (TIPO, FECHA, MONTO, BENEFICIARIO, IVA, DOCUMENTO, FECHAELAB, CVE_PROV,STATUS,FECHA_DOC, FECHA_APLI, TRANS, USUARIO_PAGO, BANCO) VALUES (";
		$query .=" '".$tipop."',";
		$query .=" '".$fechadoc."',";
		$query .=" '".$monto."',";
		$query .=" '".$nomprov."',";
		$query .=" '".$iva."',";
		$query .=" '".$docu."',";
		$query .=" '".$HOY."',";
		$query .=" '".$cveclpv."',";
		$query .=" 'N',";
		$query .=" '".$HOY."',";
		$query .=" '".$HOY."',";
		$query .=" '0',";
		$query .=" '$usuario',";
		$query .=" '$cuentaban'";
		$query .=")";
		//echo $query; 
		$this->query =$query;
		//echo 'Consulta para ingresar la nueva transfer:'.$this->query.'<p>';
		//break;
		$rs = $this->EjecutaQuerySimple();	
		}elseif($tipop == 'cr'){
		$query="INSERT INTO P_CREDITO (TIPO, FECHA, MONTO, BENEFICIARIO, IVA, DOCUMENTO, FECHAELAB, CVE_PROV,STATUS,FECHA_DOC, FECHA_APLI, CREDITO) VALUES (";
		$query .=" '".$tipop."',";
		$query .=" '".$fechadoc."',";
		$query .=" '".$monto."',";
		$query .=" '".$nomprov."',";
		$query .=" '".$iva."',";
		$query .=" '".$docu."',";
		$query .=" '".$HOY."',";
		$query .=" '".$cveclpv."',";
		$query .=" 'N',";
		$query .=" '".$HOY."',";
		$query .=" '".$HOY."',";
		$query .=" '0'";
		$query .=")";
		//echo $query; 
		$this->query =$query;
		$rs = $this->EjecutaQuerySimple();
		}elseif($tipop == 'e'){
		$query="INSERT INTO P_EFECTIVO (TIPO, FECHA, MONTO, BENEFICIARIO, IVA, DOCUMENTO, FECHAELAB, CVE_PROV,STATUS,FECHA_DOC, FECHA_APLI, EFECTIVO, USUARIO_PAGO, BANCO) VALUES (";
		$query .=" '".$tipop."',";
		$query .=" '".$fechadoc."',";
		$query .=" '".$monto."',";
		$query .=" '".$nomprov."',";
		$query .=" '".$iva."',";
		$query .=" '".$docu."',";
		$query .=" '".$HOY."',";
		$query .=" '".$cveclpv."',";
		$query .=" 'N',";
		$query .=" '".$HOY."',";
		$query .=" '".$HOY."',";
		$query .=" '0',";
		$query .=" '$usuario',";
		$query .=" '$cuentaban'";
		$query .=")";
		//Secho $query; 
		$this->query =$query;
		$rs = $this->EjecutaQuerySimple();
		}
	}

	function TraeUnidades(){
		$data=array();
		$this->query="SELECT numero, operador, idu as idunidad
						FROM unidades where status = 'A'";
		$result = $this->QueryObtieneDatosN();
			while ( $tsArray = ibase_fetch_object($result)){ 
					$data[] = $tsArray;			
			}
				return $data;
	}
	
	function detallePago($documento){
		$data=array();	
		if(substr($documento, 0,1) != 'O'){
				$this->query=" SELECT s.idsol as cve_doc, p.nombre, s.monto as importe, s.fechaelab, s.fecha as fecha_doc, 'Contrarecibos' as Recepcion, 'NA' as enlazado, s.tipo as TipoPagoR, 'NA' as FER, 'NA' as TE, usuario as Confirmado, s.tipo as PagoTesoreria, 'NA' as pago_tes
								from SOLICITUD_PAGO s
								left join prov01 p on s.proveedor = p.clave
								where idsol = $documento";
		}elseif(substr($documento,0,2) != 'OP'){
			echo 'Entro a COMPO01';
				$this->query="	SELECT a.cve_doc, b.nombre, a.importe, a.fechaelab, a.fecha_doc, doc_sig as Recepcion, a.enlazado, c.camplib1 as TipoPagoR, c.camplib3 as FER,c.camplib2 as TE, c.camplib4 as Confirmado, a.tp_tes as PagoTesoreria, a.pago_tes, pago_entregado, c.camplib6, a.cve_clpv, a.URGENTE, datediff(day, a.fechaelab, current_date ) as Dias 
						from compo01 a
						left join Prov01 b on a.cve_clpv = b.clave
						LEFT JOIN compo_clib01 c on a.cve_doc = c.clave_doc
						where cve_doc = '$documento'";
		}else{
				$this->query="SELECT ftcpoc.OC AS CVE_DOC, p.nombre, ftcpoc.costo_total as importe, ftcpoc.fecha_oc as fechaelab, 'Ver Documentos' as Recepcion, 'NA' as enlazado, 'p.tipo_pago' as tipopagoR, 'NA' as fer, 'NA' as TE, ftcpoc.usuario_oc as confirmado, 'Tipo' as PagoTesoreria, 'NA' as pago_entregado, 'NA' as camplib6, ftcpoc.cve_prov as cve_clpv, 'NA' as urgente, 'NA' as DIAS, 
		        	(select iif(sum(lp.cantidad * poc.cost )is null, 0 , sum(lp.cantidad * poc.cost)) FROM LIB_PARTIDAS lp left join par_compo01 poc on poc.cve_doc = lp.oc and poc.num_par = lp.partida_oc WHERE PROVEEDOR = p.clave group by Proveedor) as saldoprov    	
        			from FTC_POC ftcpoc 
   				    left join prov01 p on p.clave = ftcpoc.cve_prov
    			    where oc='$documento'";
        			//echo $this->query;
		}
		$result = $this->QueryObtieneDatosN();
			while ( $tsArray = ibase_fetch_object($result)){ 
					$data[] = $tsArray;				
			}		
		return $data;
	}

	function CompruebaRol($user, $pass){
		$this->query = "SELECT USER_ROL FROM PG_USERS WHERE USER_LOGIN = '$user' and USER_PASS ='$pass' and user_status = 'alta'";/*Falta Tabla*/
		 $log = $this->QueryObtieneDatos();
			if(isset($log) > 0){
				return $log;
			}else{
				return 0;
			}
			
	}
		
	function ObtieneReg(){
		$this->query = "SELECT COUNT(*)
  						FROM PG_USERS";
						
		$r = $this->QueryObtieneDatos();
		
		return	$r;
	}
	
	function ObtieneRegSC(){
		$this->query = "SELECT COUNT(*)
  						FROM PG_SEGCOMP";
						
		$r = $this->QueryObtieneDatos();
		
		return	$r;
	}
	
	function AsignadosComp(){
		$this->query = "SELECT CVE_DOC, CVE_CLPV, IMPORTE, ID_SEG, STATUS_FACT 
						FROM FACTF01
						WHERE STATUS_FACT = 'a'";
		$result = $this->EjecutaQuerySimple();
		if($this->NumRows($result) > 0){
			while ( $tsArray = $this->FetchAs($result) ) 
					$data[] = $tsArray;			
		
				return $data;
		}
		
		return 0;
	}

	function valUsr($usr){
		$data= array();
		$this->query="SELECT * FROM PG_USERS WHERE USER_LOGIN = '$usr'";
		$res=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($res)) {
			$data[]=$tsArray;
		}
		if(count($data) > 0){
			return array("status"=>'no');
		}else{
			return array("status"=>'ok');
		}
	}
	
	function NuevoUser($usuario, $contra, $email, $rol, $letra, $nomcom, $letras, $paterno, $materno){
		$e = strtolower($email);
		$c = md5($contra);
		$nomcom=$nomcom.' '.$paterno.' '.$materno;
		$nomcom = htmlentities($nomcom, ENT_QUOTES);
		$this->query = "INSERT INTO PG_USERS (user_login, user_pass, user_email, user_registro, user_status, user_rol, letra, nombre, numero_letras, letra_nueva) 
						VALUES ('$usuario', '$c', '$e', current_date, 'alta', '$rol', '$letra', '$nomcom', $letras, upper('$letra'))";
		$rs = $this->EjecutaQuerySimple();
		return $rs;
	}		
	
	/*###################################Cambios de OFA###################################*/
	
	// INSERTA LAS PARTIDAS DE LA ORDEN DE COMPRA
	function NuevaPartidaOrdenCompra($Doc, $IdPreoco, $Rest, $Prod, $Cantidad, $Costo, $unimed, $facconv, $cveuser) {
		//echo $partida ="<br/>".$CVE_DOC."<br/>".$TOTAL."<br/>".$TIME."<br/>HOY=".$HOY."<br/>".$IdPreoco."<br/>".$Consecutivo."<br/>".$Doc."<br/>".$Prod."<br/>".$Costo."<br/>".$unimed."<br/>".$facconv."<br/>".$Cantidad."<br/>".$Rest."<br/>".$consecutivo2;		
		$Costoa = $Costo;
		$nuevoRest=$Rest-$Cantidad;		
		if($nuevoRest<=0){ 
			$status='B';
		}else{ 
			$status='N';
		}
		$totalPartida = $Cantidad * $Costo;	
		if($Rest==NULL || $Rest==''){ 
			$Rest=0; 
		}
	    
		$a =" UPDATE PREOC01 set status='".$status."', rest='".$nuevoRest."'  WHERE ID= $IdPreoco ";
		//echo "Actualiza Pre Orden de compra: $a";
		
		$this->query = $a;
		$rs = $this->EjecutaQuerySimple();

		$consultPartMAX  =" SELECT COUNT(NUM_PAR) as FOLIO FROM PAR_COMPO01 WHERE CVE_DOC_REAL='".$Doc."'";
              // echo "sql: $consultPartMAX";
		$this->query = $consultPartMAX;
		$result = $this->EjecutaQuerySimple();
		$row = ibase_fetch_object($result);
               //echo "row: ".$row->FOLIO;
               $COD = $row->FOLIO;
               $COD = $COD+1;
		$CVEDOCCOMPUESTO=$Doc.'000'.$COD;
		
		$partida =" INSERT INTO PAR_COMPO01 (CVE_DOC, NUM_PAR, CVE_ART,CANT, PXR, PREC, COST, IMPU1,IMPU2, IMPU3, IMPU4, IMP1APLA,";
		$partida .=" IMP2APLA, IMP3APLA, IMP4APLA,TOTIMP1, TOTIMP2, TOTIMP3, TOTIMP4,DESCU, ACT_INV, TIP_CAM, UNI_VENTA,TIPO_ELEM, TIPO_PROD, CVE_OBS, E_LTPD,";
		$partida .=" REG_SERIE, FACTCONV, COST_DEV, NUM_ALM,MINDIRECTO, NUM_MOV, TOT_PARTIDA,CVE_DOC_REAL, ID_PREOC, USUARIO_PHP) VALUES (";
		$partida .=" '".$Doc."',"; 
		$partida .=" ".$COD.", ";
		$partida .=" '".$Prod."',";
		$partida .=" ".$Cantidad." ,";
		$partida .=" ".$Cantidad." ,";
		$partida .=" 99, ";
		$partida .=" ".$Costoa.", ";
		$partida .=" 0, ";
		$partida .=" 0, ";
		$partida .=" 0, ";
		$partida .=" 16, ";
		$partida .=" 0, ";
		$partida .=" 0, ";
		$partida .=" 0, ";
		$partida .=" 0, ";
		$partida .=" 0, ";
		$partida .=" 0, ";
		$partida .=" 0, ";
		$partida .=" 0, ";
		$partida .=" 0, ";
		$partida .=" 'N', ";
		$partida .=" 1, ";
		$partida .=" '".$unimed."', ";
		$partida .=" 'N', ";
		$partida .=" 'P', ";
		$partida .=" 0, ";
		$partida .=" 0, ";
		$partida .=" 0, ";
		$partida .=" ".$facconv.", ";
		$partida .=" NULL, ";
		$partida .=" 95, ";
		$partida .=" NULL,"; 
		$partida .=" NULL, ";
		$partida .=" '".$totalPartida."',";
		$partida .=" '".$Doc."',";
		$partida .=" '".$IdPreoco."',"; 
		$partida .=" '".$cveuser."')";
		
		$this->query = $partida;
		$s = $this->EjecutaQuerySimple();
			
		//echo $this->query;
		//break;

		$consultPart  =" SELECT SUM(TOT_PARTIDA) TOT FROM PAR_COMPO01 WHERE CVE_DOC_REAL='".$Doc."' ";
		$this->query = $consultPart;
		$result = $this->EjecutaQuerySimple();
		$row = ibase_fetch_object($result);
    	$SUMATOTALPARTIDAS= $row->TOT;

    	$urgente = "SELECT URGENTE from PREOC01 where id = '".$IdPreoco."'";
    	$this->query = $urgente;
    	$result = $this->EjecutaQuerySimple();
    	$row = ibase_fetch_object($result);
    	$urgentes = $row->URGENTE;

    	if ($urgentes == 'U'){
			$esurgente = "UPDATE COMPO01 SET URGENTE = 'U' WHERE CVE_DOC ='".$Doc."'";
    		$this->query = $esurgente;
    		$result = $this->EjecutaQuerySimple();    		
    	}

	}	
	
	//INSERTA ORDEN DE COMPRA
	//function NuevoOrdComp($PROVEEDOR,$CVE_DOC,$TOTAL,$TIME,$HOY,$IdPreoco,$Consecutivo,$Doc,$Prod,$Costo,$unimed,$facconv,$Cantidad,$Rest){
	function NuevoOrdComp($PROVEEDOR,$CVE_DOC,$TOTAL,$TIME,$HOY,$Doc){
	
		$Control=$PROVEEDOR.'A';

		$consultFOLIO  =" SELECT MAX(folio) FOLIO  FROM COMPO01";
		$this->query = $consultFOLIO;
		$result = $this->EjecutaQuerySimple();
		$row = ibase_fetch_object($result);
    	$FOLIO= $row->FOLIO;
    	$FOL=$FOLIO+1;
  		//echo "folio=".$FOL;
  		//echo "CVE_DOC=".$CVE_DOC;
    	$cveuser= $_SESSION['user']->USER_LOGIN;
        $nombre = "SELECT NOMBRE FROM PG_USERS WHERE User_login = '$cveuser'";
        $this->query=$nombre;
        $result = $this->EjecutaQuerySimple();
        $row=ibase_fetch_object($result);
        $NOM_USUARIO = $row->NOMBRE;

    	$PEDID=substr($CVE_DOC,0,2);
        //echo "PEDIDO=".$PEDID;

        $NUEVACVEDOC = $PEDID.$FOL;    		
    	$HOYY        = date("Y-m-d");
    	//list($day,$mon,$year) = explode('-',$HOYY);
    	//$oldDate =date('d-m-Y',mktime(0,0,0,$mon,$day+30,$year));
		//$arr = explode('-', $oldDate);
		//$newDate30 = $arr[2].'-'.$arr[1].'-'.$arr[0];
    	$PROVV=trim($PROVEEDOR);
		$pp=str_pad($PROVV, 10, " ", STR_PAD_LEFT);

		$cabecera  =" INSERT INTO COMPO01 (";
		$cabecera  .="	 TIP_DOC, CVE_DOC, CVE_CLPV, STATUS,";
		$cabecera  .="	 SU_REFER, FECHA_DOC, FECHA_REC, FECHA_PAG,";
		$cabecera  .="	 FECHA_CANCELA, CAN_TOT,";
		$cabecera  .="	 IMP_TOT1, IMP_TOT2, IMP_TOT3, IMP_TOT4,";
		$cabecera  .="	 DES_TOT, DES_FIN, TOT_IND,";
		$cabecera  .="	 OBS_COND, CVE_OBS, NUM_ALMA, ACT_CXP, ACT_COI,";
		$cabecera  .="	 NUM_MONED, TIPCAMB, ENLAZADO, TIP_DOC_E, NUM_PAGOS,";
		$cabecera  .="	 FECHAELAB, SERIE, FOLIO, CTLPOL, ESCFD, CONTADO, BLOQ,";
		$cabecera  .="	 DES_FIN_PORC, DES_TOT_PORC, IMPORTE, TIP_DOC_ANT,";
		$cabecera  .="	 DOC_ANT, TIP_DOC_SIG, DOC_SIG, FORMAENVIO,CONTROL, STATUS_LOG, REALIZA)";
	 	$cabecera  .="	VALUES ( ";
		$cabecera  .="	'o', ";
		$cabecera  .="	'".$NUEVACVEDOC."', ";
		$cabecera  .="	'".$pp."',"; 
		$cabecera  .="	'O', ";
		$cabecera  .="	'', ";
		$cabecera  .="	'".$HOYY."', ";
		$cabecera  .="	'".$HOYY."', ";
		$cabecera  .="	'".$HOYY."', "; //mas 30 dias $nuevafecha = strtotime ( '+1 day' , strtotime ($fechaFFase ) ) ;
		$cabecera  .="	NULL, ";
		//$cabecera  .="	".$SUMATOTALPARTIDAS.", "; //cantidad total suma
		$cabecera  .="	'22', "; //cantidad total suma
		$cabecera  .="	0, ";
		$cabecera  .="	0, ";
		$cabecera  .="	0, ";
		$cabecera  .="	2, "; //totaliva
		$cabecera  .="	0, ";
		$cabecera  .="	0, ";
		$cabecera  .="	0, ";
		$cabecera  .="	'', ";
		$cabecera  .="	0, ";
		$cabecera  .="	95, ";
		$cabecera  .="	'S', ";
		$cabecera  .="	'N', ";
		$cabecera  .="	1, ";
		$cabecera  .="	1, ";
		$cabecera  .="	'O',"; 
		$cabecera  .="	'O', ";
		$cabecera  .="	NULL,"; 
		$cabecera  .="	'".$HOY."', ";
		$cabecera  .="	'OZ', "; //rest 
		//$cabecera  .="	'".$Consecutivo."', ";
		$cabecera  .="	'".$FOL."', ";
		$cabecera  .="	0, ";
		$cabecera  .="	'N', ";
		$cabecera  .="	'N', ";
		$cabecera  .="	'N', ";
		$cabecera  .="	0, ";
		$cabecera  .="	0, ";
		$cabecera  .="	0, "; //suma total
		$cabecera  .="	'', ";
		$cabecera  .="	'', ";
		$cabecera  .="	NULL, ";
		$cabecera  .="	NULL, ";
		$cabecera  .="	NULL, ";
		$cabecera  .="	'".$Control."',";
		$cabecera  .="  'Nuevo',";
		$cabecera  .="	'".$NOM_USUARIO."'";
		$cabecera  .="	) ";
		//echo $cabecera;
		$this->query = $cabecera;
		$rs = $this->EjecutaQuerySimple();		

		$paga      = " INSERT INTO PAGA_M01 (";
		$paga     .= " CVE_PROV, REFER, NUM_CARGO, NUM_CPTO, CVE_FOLIO, CVE_OBS, NO_FACTURA,";
		$paga     .= " DOCTO, IMPORTE, FECHA_APLI, FECHA_VENC, AFEC_COI, NUM_MONED, TCAMBIO,"; 
		$paga     .= " IMPMON_EXT, FECHAELAB, CTLPOL, TIPO_MOV, CVE_BITA, SIGNO, CVE_AUT, ";
		$paga     .= " USUARIO, ENTREGADA, FECHA_ENTREGA, REF_SIST, STATUS)";
		$paga     .= " VALUES (";
		$paga     .= " '".$PROVEEDOR."',";
		$paga     .= " '".$NUEVACVEDOC."',";
		$paga     .= " 1,24,'',0,";
		$paga     .= " '".$NUEVACVEDOC."',";
		$paga     .= " '".$NUEVACVEDOC."',";
		$paga     .= " ".$TOTAL.",";
		$paga     .= " '".$HOYY."',";
		$paga     .= " '".$HOYY."', ";
		$paga     .= " '', 1, 1, ";
		$paga     .= " ".$TOTAL.",";
		$paga     .= " '".$HOYY."',";
		$paga     .= " 0, 'C', 0, 1, 0, 0, '',";
		$paga     .= " '".$HOYY."',";
		$paga     .= " '', 'A')";
		$this->query = $paga;
		$s = $this->EjecutaQuerySimple();

        //$a=" UPDATE PREOC01 set status=Ω".$status."', rest='".$nuevoRest."'  WHERE ID= $IdPreoco ";
		//$this->query = $a;
		//$rs = $this->EjecutaQuerySimple();

		return $NUEVACVEDOC;

	}	
	// actualiza totales en orden de compra
       function actualizaTotalPaga($proveedor, $documento, $importe){
           
           $query = "UPDATE PAGA_M01 SET IMPORTE = $importe WHERE DOCTO = '$documento' AND CVE_PROV = '$proveedor';";
           //echo "query: $query";
           $this->query = $query;
           $result = $this->EjecutaQuerySimple();
           if(count($result) > 0){
               return 1;
           }else{
               return 0;
           }
           
       }
	// actualiza totales en orden de compra
       function actualizaTotalOrdenCompra($documento, $cantidad, $impuesto, $importe){

       		$cantidad = $importe;
       		$importe = $impuesto + $importe;
           
           $query = "UPDATE COMPO01 SET CAN_TOT = $cantidad, IMP_TOT4 = $impuesto, IMPORTE = $importe WHERE CVE_DOC = '$documento'";
           //echo "query: $query";
           $this->query = $query;
           $result = $this->EjecutaQuerySimple();
           if(count($result) > 0){
               return 1;
           }else{
               return 0;
           }
           
       }
	
	//ORDEN DE COMPRA
	function ConsultaOrdenComp($id){
		$this->query = "SELECT p.id, p.fechasol, p.fecha_auto, p.cotiza, p.par, p.status, p.prod, p.nomprod, p.canti, p.cant_orig, p.costo, p.prove, p.nom_prov, p.total, p.rest, p.docorigen, p.urgente, p.um, datediff(day, p.fechasol,current_date) as DIAS, p.costo_maximo, iif(fecharec is null, current_date, fecharec) as fecharec,
							  (select count(id) from LIB_PARTIDAS where idpreoc = p.id) as Liberaciones
							  from preoc01 p
							  WHERE status='N' and rest > 0 and rec_faltante > 0 ORDER BY  nom_prov  ASC ";
		$result = $this->QueryObtieneDatosN();
			while ( $tsArray = $this->FetchAs($result) ) 
					$data[] = $tsArray;			
		
			return $data;
		}
	

	// Listar partidas no recibidad

	function ListaPartidasNoRecibidas (){
		
		$this->query = "SELECT a.ID_PREOC, a.cve_doc, a.cve_art, ftc.nombre as camplib7, a.cant, a.pxr, c.nombre, a.fecha_doc_recep, a.doc_recep, a.DOC_RECEP_STATUS, a.vuelta, a.num_par, b.fechaelab
			from par_compo01 a
			left join compo01 b on a.cve_doc = b.cve_doc and b.status <> 'C'
			left join prov01 c on b.cve_clpv = c.clave
			left join PRODUCTO_FTC ftc on ftc.clave = a.cve_art 
			where pxr > 0 and a.status_log2 = 'Tesoreria'";

		$result = $this->QueryObtieneDatosN();
			while ( $tsArray = ibase_fetch_object($result)){ 
					$data[] = $tsArray;			
		}
				return $data;
	}

	//ACTUALIZA actualizaPreOc
	function actualizaPreOc($provcostid,$provedor,$costo,$total,$nombreprovedor,$cantidad,$rest, $fe){

		$query = " UPDATE PREOC01 SET"; 
		$query .= " prove=$provedor,";
		$query .= " costo=$costo,"; 
		$query .= " total=$total,";
		$query .= " canti=$cantidad,";
		$query .= " nom_prov='$nombreprovedor',";
		$query .= " fecharec = '$fe'";
		$query .= " WHERE id=$provcostid ";
		$this->query = $query;

		print_r($this->query);
		//break;
		$result = $this->EjecutaQuerySimple();
			if(count($result) > 0){
			return 1;
		}else{
			return 0;
		}
	}
	//SABER SI EL PROVEEDOR EXISTE
	function valorPreOcProvedor($provedor){
		$query = " SELECT NOMBRE FROM PROV01 WHERE"; 
		$query .= " CLAVE=$provedor ";
		$query .= " AND STATUS='A' ";
		$this->query = $query;
		$result = $this->EjecutaQuerySimple();
			while ($row = ibase_fetch_object($result)) {
    				$nom= $row->NOMBRE;
    			return $nom;
			}
	}
 
	//SABER SI EL UNI_MED DEL ARTICULO EXISTE
	function valorArticulo($Prod){
		//unset($$_SESSION["unimed"]);
		$query = " SELECT uni_med,fac_conv FROM INVE01 WHERE"; 
		$query .= " cve_art='".$Prod."' ";
		$query .= " AND STATUS='A' ";

		$this->query = $query;
		$result = $this->EjecutaQuerySimple();
			while ($row = ibase_fetch_object($result)) {
    				$nom= $row->UNI_MED;
    				$fac= $row->FAC_CONV;
    			return $nom.'|'.$fac;
			}
	}	
	/*############################Cambios de OFA####################################*/	
	

	//// Consulta donde muesta la informacion de los pedidos, desde la pagina de Buscar Pedidos, primer parte es la cabecera
	function ConsultaPreoc($pre){
		$l = $_SESSION['user']->LETRA;
		$u = $_SESSION['user']->USER_LOGIN;
		$n = $_SESSION['user']->NUMERO_LETRAS;
		if($n<99){
		$this->query = "SELECT a.*, FACTURAS as factura, b.fechaelab as fecha_fac, c.cve_doc as remision, c.fechaelab as fecha_rem,
cast((select list(documento||'—-'|| round( cantidad)) from ftc_facturas_detalle where idpreoc =a.id) as varchar(100)) as facts
						FROM preoc01 a
						left join factf01 b on a.cotiza = b.doc_ant
						left join factp01 c on a.cotiza = c.doc_ant
						WHERE cotiza = '".strtoupper($pre)."'";
		}elseif($n==99){
		$this->query = "SELECT a.*, Facturas as factura, b.fechaelab as fecha_fac, c.cve_doc as remision, c.fechaelab as fecha_rem,
cast((select list(documento||'—-'|| round( cantidad)) from ftc_facturas_detalle where idpreoc =a.id) as varchar(100)) as facts
						FROM preoc01 a
						left join factf01 b on a.cotiza = b.doc_ant
						left join factp01 c on a.cotiza = c.doc_ant
						WHERE cotiza = '".strtoupper($pre)."'";			
		}		
		$result = $this->QueryObtieneDatosN();
			while ( $tsArray = ibase_fetch_object($result)){ 
					$data[] = $tsArray;			
			}
				return $data;
	}
	
	/// Segunda parte de Buscar Pedidos Detalle del pedido.
	function ConsultaMov($mov){
		$l = $_SESSION['user']->LETRA;
		$u = $_SESSION['user']->USER_LOGIN;
		$n = $_SESSION['user']->NUMERO_LETRAS;
		if($n==1){
		$this->query = "SELECT a.id, a.cotiza as pedido, a.nom_cli, a.urgente, a.fact_ant, a.fechasol, a.prod, a.nomprod,  a.cant_orig , a.status, 
						b.cve_doc as Orden_de_Compra, b.CANT as CANT_SOLICITADA, b.status, a.rest as Falta_Solicitar, c.cve_doc as Recepcion, 
						c.cant as Cant_Recibida, a.REC_faltante, c.status , d.cve_doc, d.fechaelab, d.importe, e.fechaelab as fecha_oc, f.fechaelab as fecha_r, 
						e.tp_tes, e.ruta, e.unidad, e.fecha_secuencia, e.status_log, e.cant_rec
            	from preoc01 a
            	left join par_compo01 b on a.id = b.id_preoc  and b.status <> 'C'
            	left join compo01 e on b.cve_doc = e.cve_doc
            	left join par_compr01 c on b.cve_doc = c.doc_ant and b.id_preoc = c.id_preoc and c.status <> 'C'
            	left join compr01 f on c.cve_doc = f.cve_doc
            	left join factf01 d on  a.cotiza = d.doc_ant and d.status <> 'C' 
				WHERE COTIZA = ('".strtoupper($mov)."')";
				//var_dump($this->query);
		}elseif($n>1){
		$this->query = "SELECT a.id, a.cotiza as pedido, a.nom_cli, a.urgente, a.fact_ant, a.fechasol, a.prod, a.nomprod,  a.cant_orig , a.status, 
						b.cve_doc as Orden_de_Compra, b.CANT as CANT_SOLICITADA, b.status, a.rest as Falta_Solicitar, c.cve_doc as Recepcion, 
						c.cant as Cant_Recibida, a.REC_faltante, c.status , d.cve_doc, d.fechaelab, d.importe, e.fechaelab as fecha_oc, f.fechaelab as fecha_r,
						e.tp_tes, e.ruta, e.unidad, e.fecha_secuencia, e.status_log, e.cant_rec
            	from preoc01 a
            	left join par_compo01 b on a.id = b.id_preoc  and b.status <> 'C'
            	left join compo01 e on b.cve_doc = e.cve_doc
            	left join par_compr01 c on b.cve_doc = c.doc_ant and b.id_preoc = c.id_preoc and c.status <> 'C'
            	left join compr01 f on c.cve_doc = f.cve_doc
            	left join factf01 d on  a.cotiza = d.doc_ant and d.status <> 'C' 
				WHERE COTIZA ='".strtoupper($mov)."'";	
		}
		$result = $this->QueryObtieneDatosN();
			while ( $tsArray = ibase_fetch_object($result)){ 
					$data[] = $tsArray;			
			}
				return $data;
	}


	function InsertaCompo($nombre, $duracion, $tipo, $usuario){
		//$usuario = $_SESSION['user']; antes de insertar tomar el ultimo valor de id sumarle 1 e insertar
		$user = $_SESSION['user']["USER_LOGIN"];
		//print_r($user);
		$fecha = date('d-m-Y');
		$rs = $this->ObtieneRegSC();
		$id = (int) $rs["COUNT"] + 1;
		$this->query = "INSERT INTO PG_SEGCOMP VALUES ($id, '$nombre', '$duracion', '$tipo', '$user', '$fecha', '$fecha', 'alta')";
		$result = $this->EjecutaQuerySimple();
		//print_r($result);
		return $result;
	}
	
	function ConsultaProd(){
		$this->query ="SELECT a.cve_art, e.clave ,e.nombre as Proveedor, c.exist, d.costo, b.camplib7 as Nombre, b.camplib1 as Marca, c.cve_alm as Almacen, b.camplib8 as Categoria, 
						b.camplib2 as modelo, b.camplib3 as division, b.camplib4 as piezas, b.camplib9 as subcategoria, b.camplib10 as Codigo_Fabricante, b.camplib11 as Proveedor_Empaque, 
						b.camplib12 as Costo_x_Empaque, b.camplib13 as Unidad_de_Empaque, b.camplib14 as Piezas_por_empaque
						from inve01  a 
						left join inve_clib01 b on a.cve_art = b.cve_prod 
						left join mult01 c on a.cve_art = c.cve_art 
						left join prvprod01 d on a.cve_art = d.cve_art 
						left join prov01 e on d.cve_prov = e.clave 
						where c.cve_alm = '9'";
		
		$result = $this->EjecutaQuerySimple();
		if($this->NumRows($result) > 0){
			while ( $tsArray = $this->FetchAs($result) ) 
					$data[] = $tsArray;			
		
				return $data;
		}	
		return 0;
	}

	
    
    function VerPagadas(){
    	$this->query="SELECT * FROM compo01 where status_compra = 'Co'";
    	$result = $this->QueryObtieneDatosN();
    	while ($tsArray = ibase_fetch_object($result)){
    		$data[] = $tsArray;
    	}
    		return $data;
    }
	function Idproducto($id){

			$l = $_SESSION['user']->LETRA;
			$l2 = $_SESSION['user']->LETRA2;
			$l3 = $_SESSION['user']->LETRA3;
			$l4 = $_SESSION['user']->LETRA4;
			$l5 = $_SESSION['user']->LETRA5;
			$l6 = $_SESSION['user']->LETRA6;
			$n = $_SESSION['user']->NUMERO_LETRAS;
			switch ($id){
				case '1':
				echo $l;	
				echo $n;
				if ($n==1){

				$this->query ="SELECT a.id, a.cotiza as pedido, a.nom_cli, a.urgente, a.fact_ant, a.fechasol, a.prod, a.nomprod,  a.cant_orig , a.status, b.cve_doc as Orden_de_Compra, b.CANT as Cant_Solicitada, b.status, a.rest as Falta_Solicitar, c.cve_doc as Recepcion, c.cant as Cant_Recibida, a.REC_faltante, c.status , d.cve_doc, d.fechaelab, d.importe
            		from preoc01 a
            		left join par_compo01 b on a.id = b.id_preoc  and b.status <> 'C'
            		 left join par_compr01 c on b.doc_recep = c.cve_doc and a.id = c.id_preoc and c.status <> 'C'
                left join factf01 d on  a.cotiza = d.doc_ant and d.status <> 'C
            		where letra_v = '$l'";            	
				}elseif($n==5){
					$this->query ="SELECT a.id, a.cotiza as pedido, a.nom_cli, a.urgente, a.fact_ant, a.fechasol, a.prod, a.nomprod,  a.cant_orig , a.status, b.cve_doc as Orden_de_Compra, b.CANT as Cant_Solicitada, b.status, a.rest as Falta_Solicitar, c.cve_doc as Recepcion, c.cant as Cant_Recibida, a.REC_faltante, c.status , d.cve_doc, d.fechaelab, d.importe
            		from preoc01 a
            		left join par_compo01 b on a.id = b.id_preoc  and b.status <> 'C'
            		 left join par_compr01 c on b.doc_recep = c.cve_doc and a.id = c.id_preoc and c.status <> 'C'
                left join factf01 d on  a.cotiza = d.doc_ant and d.status <> 'C
            		where letra_v = '$l' or letra_v = '$l2' or letra_v = '$l3' or letra_v = '$l4' or letra_v = '$l5'"; 

				}elseif($n==3){
					$this->query ="SELECT a.id, a.cotiza as pedido, a.nom_cli, a.urgente, a.fact_ant, a.fechasol, a.prod, a.nomprod,  a.cant_orig , a.status, b.cve_doc as Orden_de_Compra, b.CANT as Cant_Solicitada, b.status, a.rest as Falta_Solicitar, c.cve_doc as Recepcion, c.cant as Cant_Recibida, a.REC_faltante, c.status , d.cve_doc, d.fechaelab, d.importe
            		from preoc01 a
            		left join par_compo01 b on a.id = b.id_preoc  and b.status <> 'C'
            		 left join par_compr01 c on b.doc_recep = c.cve_doc and a.id = c.id_preoc and c.status <> 'C'
                left join factf01 d on  a.cotiza = d.doc_ant and d.status <> 'C
            		where letra_v = '$l' or letra_v = '$l2' or letra_v = '$l3'";
				}elseif($n==6){	
					$this->query ="SELECT a.id, a.cotiza as pedido, a.nom_cli, a.urgente, a.fact_ant, a.fechasol, a.prod, a.nomprod,  a.cant_orig , a.status, b.cve_doc as Orden_de_Compra, b.CANT as Cant_Solicitada, b.status, a.rest as Falta_Solicitar, c.cve_doc as Recepcion, c.cant as Cant_Recibida, a.REC_faltante, c.status , d.cve_doc, d.fechaelab, d.importe
            		from preoc01 a
            		left join par_compo01 b on a.id = b.id_preoc  and b.status <> 'C'
            		 left join par_compr01 c on b.doc_recep = c.cve_doc and a.id = c.id_preoc and c.status <> 'C'
                left join factf01 d on  a.cotiza = d.doc_ant and d.status <> 'C
            		where letra_v = '$l' or letra_v = '$l2' or letra_v = '$l3' or letra_v = '$l4' or letra_v = '$l5' or letra_v = '$l6";
				}elseif($n==2){
					$this->query ="SELECT a.id, a.cotiza as pedido, a.nom_cli, a.urgente, a.fact_ant, a.fechasol, a.prod, a.nomprod,  a.cant_orig , a.status, b.cve_doc as Orden_de_Compra, b.CANT as Cant_Solicitada, b.status, a.rest as Falta_Solicitar, c.cve_doc as Recepcion, c.cant as Cant_Recibida, a.REC_faltante, c.status , d.cve_doc, d.fechaelab, d.importe
            		from preoc01 a
            		left join par_compo01 b on a.id = b.id_preoc  and b.status <> 'C'
            		left join par_compr01 c on b.doc_recep = c.cve_doc and a.id = c.id_preoc and c.status <> 'C'
                	left join factf01 d on  a.cotiza = d.doc_ant and d.status <> 'C'
            		where letra_v = '$l' or letra_v = '$l2'";
			
				}

				break;


		  		case '19':
		  		$this->query ="SELECT a.id, a.cotiza as pedido, a.nom_cli, a.urgente, a.fact_ant, a.fechasol, a.prod, a.nomprod,  a.cant_orig , a.status, b.cve_doc as Orden_de_Compra, b.CANT as Cant_Solicitada, b.status, a.rest as Falta_Solicitar, c.cve_doc as Recepcion, c.cant as Cant_Recibida, a.REC_faltante, c.status , d.cve_doc, d.fechaelab, d.importe
                from preoc01 a
                left join par_compo01 b on a.id = b.id_preoc  and b.status <> 'C'
                left join par_compr01 c on b.doc_recep = c.cve_doc and a.id = c.id_preoc and c.status <> 'C'
                left join factf01 d on  a.cotiza = d.doc_ant and d.status <> 'C'
                where a.status <> 'C'";
            	break;

		  		case '2':
		  		$this->query ="SELECT a.id, a.cotiza as pedido, a.nom_cli, a.urgente, a.fact_ant, a.fechasol, a.prod, a.nomprod,  a.cant_orig , a.status, b.cve_doc as Orden_de_Compra, b.CANT as Cant_Solicitada, b.status, a.rest as Falta_Solicitar, c.cve_doc as Recepcion, c.cant as Cant_Recibida, a.REC_faltante, c.status , d.cve_doc, d.fechaelab, d.importe
					from preoc01 a
					left join par_compo01 b on a.id = b.id_preoc and b.status <> 'C'
					left join par_compr01 c on b.cve_doc = c.doc_ant and b.id_preoc = c.id_preoc and c.status <> 'C'
					left join factf01 d on  a.cotiza = d.doc_ant and d.status <> 'C'
                where ((UPPER(COTIZA) CONTAINING UPPER('PA'))) and a.status <> 'C'";
            	break;

		  		case '3':
		  		$this->query ="SELECT a.id, a.cotiza as pedido, a.nom_cli, a.urgente, a.fact_ant, a.fechasol, a.prod, a.nomprod,  a.cant_orig , a.status, b.cve_doc as Orden_de_Compra, b.CANT as Cant_Solicitada, b.status, a.rest as Falta_Solicitar, c.cve_doc as Recepcion, c.cant as Cant_Recibida, a.REC_faltante, c.status , d.cve_doc, d.fechaelab, d.importe
					from preoc01 a
					left join par_compo01 b on a.id = b.id_preoc and b.status <> 'C'
					left join par_compr01 c on b.cve_doc = c.doc_ant and b.id_preoc = c.id_preoc and c.status <> 'C'
					left join factf01 d on  a.cotiza = d.doc_ant and d.status <> 'C'
                where ((UPPER(COTIZA) CONTAINING UPPER('PB'))) and a.status <> 'C'";

		  		case '4':
		  		$this->query ="SELECT a.id, a.cotiza as pedido, a.nom_cli, a.urgente, a.fact_ant, a.fechasol, a.prod, a.nomprod,  a.cant_orig , a.status, b.cve_doc as Orden_de_Compra, b.CANT as Cant_Solicitada, b.status, a.rest as Falta_Solicitar, c.cve_doc as Recepcion, c.cant as Cant_Recibida, a.REC_faltante, c.status , d.cve_doc, d.fechaelab, d.importe
					from preoc01 a
					left join par_compo01 b on a.id = b.id_preoc and b.status <> 'C'
					left join par_compr01 c on b.cve_doc = c.doc_ant and b.id_preoc = c.id_preoc and c.status <> 'C'
					left join factf01 d on  a.cotiza = d.doc_ant and d.status <> 'C'
                where ((UPPER(COTIZA) CONTAINING UPPER('PC'))) and a.status <> 'C'";
            	break;

   		  		case '5':
		  		$this->query ="SELECT a.id, a.cotiza as pedido, a.nom_cli, a.urgente, a.fact_ant, a.fechasol, a.prod, a.nomprod,  a.cant_orig , a.status, b.cve_doc as Orden_de_Compra, b.CANT as Cant_Solicitada, b.status, a.rest as Falta_Solicitar, c.cve_doc as Recepcion, c.cant as Cant_Recibida, a.REC_faltante, c.status , d.cve_doc, d.fechaelab, d.importe
					from preoc01 a
					left join par_compo01 b on a.id = b.id_preoc and b.status <> 'C'
					left join par_compr01 c on b.cve_doc = c.doc_ant and b.id_preoc = c.id_preoc and c.status <> 'C'
					left join factf01 d on  a.cotiza = d.doc_ant and d.status <> 'C'
                where ((UPPER(COTIZA) CONTAINING UPPER('PD'))) and a.status <> 'C'";
            	break;
            	

            	case '6':
		  		$this->query ="SELECT a.id, a.cotiza as pedido, a.nom_cli, a.urgente, a.fact_ant, a.fechasol, a.prod, a.nomprod,  a.cant_orig , a.status, b.cve_doc as Orden_de_Compra, b.CANT as Cant_Solicitada, b.status, a.rest as Falta_Solicitar, c.cve_doc as Recepcion, c.cant as Cant_Recibida, a.REC_faltante, c.status , d.cve_doc, d.fechaelab, d.importe
					from preoc01 a
					left join par_compo01 b on a.id = b.id_preoc and b.status <> 'C'
					left join par_compr01 c on b.cve_doc = c.doc_ant and b.id_preoc = c.id_preoc and c.status <> 'C'
					left join factf01 d on  a.cotiza = d.doc_ant and d.status <> 'C'
                where ((UPPER(COTIZA) CONTAINING UPPER('PE')) OR (UPPER(COTIZA) CONTAINING UPPER('PS'))) and a.status <> 'C'";
            	break;

            	case '7':
		  		$this->query ="SELECT a.id, a.cotiza as pedido, a.nom_cli, a.urgente, a.fact_ant, a.fechasol, a.prod, a.nomprod,  a.cant_orig , a.status, b.cve_doc as Orden_de_Compra, b.CANT as Cant_Solicitada, b.status, a.rest as Falta_Solicitar, c.cve_doc as Recepcion, c.cant as Cant_Recibida, a.REC_faltante, c.status , d.cve_doc, d.fechaelab, d.importe
					from preoc01 a
					left join par_compo01 b on a.id = b.id_preoc and b.status <> 'C'
					left join par_compr01 c on b.cve_doc = c.doc_ant and b.id_preoc = c.id_preoc and c.status <> 'C'
					left join factf01 d on  a.cotiza = d.doc_ant and d.status <> 'C'
                where ((UPPER(COTIZA) CONTAINING UPPER('PF'))) and a.status <> 'C'";
				break;
            	
            	case '8':
		  		$this->query ="SELECT a.id, a.cotiza as pedido, a.nom_cli, a.urgente, a.fact_ant, a.fechasol, a.prod, a.nomprod,  a.cant_orig , a.status, b.cve_doc as Orden_de_Compra, b.CANT as Cant_Solicitada, b.status, a.rest as Falta_Solicitar, c.cve_doc as Recepcion, c.cant as Cant_Recibida, a.REC_faltante, c.status , d.cve_doc, d.fechaelab, d.importe
					from preoc01 a
					left join par_compo01 b on a.id = b.id_preoc and b.status <> 'C'
					left join par_compr01 c on b.cve_doc = c.doc_ant and b.id_preoc = c.id_preoc and c.status <> 'C'
					left join factf01 d on  a.cotiza = d.doc_ant and d.status <> 'C'
                where ((UPPER(COTIZA) CONTAINING UPPER('PG'))) and a.status <> 'C'";
            	break;
            	
            	case '9':
		  		$this->query ="SELECT a.id, a.cotiza as pedido, a.nom_cli, a.urgente, a.fact_ant, a.fechasol, a.prod, a.nomprod,  a.cant_orig , a.status, b.cve_doc as Orden_de_Compra, b.CANT as Cant_Solicitada, b.status, a.rest as Falta_Solicitar, c.cve_doc as Recepcion, c.cant as Cant_Recibida, a.REC_faltante, c.status , d.cve_doc, d.fechaelab, d.importe
					from preoc01 a
					left join par_compo01 b on a.id = b.id_preoc and b.status <> 'C'
					left join par_compr01 c on b.cve_doc = c.doc_ant and b.id_preoc = c.id_preoc and c.status <> 'C'
					left join factf01 d on  a.cotiza = d.doc_ant and d.status <> 'C'
                where ((UPPER(COTIZA) CONTAINING UPPER('PH'))) and a.status <> 'C'";
            	break;

            	case '10':
		  		$this->query ="SELECT a.id, a.cotiza as pedido, a.nom_cli, a.urgente, a.fact_ant, a.fechasol, a.prod, a.nomprod,  a.cant_orig , a.status, b.cve_doc as Orden_de_Compra, b.CANT as Cant_Solicitada, b.status, a.rest as Falta_Solicitar, c.cve_doc as Recepcion, c.cant as Cant_Recibida, a.REC_faltante, c.status , d.cve_doc, d.fechaelab, d.importe
					from preoc01 a
					left join par_compo01 b on a.id = b.id_preoc and b.status <> 'C'
					left join par_compr01 c on b.cve_doc = c.doc_ant and b.id_preoc = c.id_preoc and c.status <> 'C'
					left join factf01 d on  a.cotiza = d.doc_ant and d.status <> 'C'
                where ((UPPER(COTIZA) CONTAINING UPPER('PI'))) and a.status <> 'C'";
            	break;
            	
            	case '11':
		  		$this->query ="SELECT a.id, a.cotiza as pedido, a.nom_cli, a.urgente, a.fact_ant, a.fechasol, a.prod, a.nomprod,  a.cant_orig , a.status, b.cve_doc as Orden_de_Compra, b.CANT as Cant_Solicitada, b.status, a.rest as Falta_Solicitar, c.cve_doc as Recepcion, c.cant as Cant_Recibida, a.REC_faltante, c.status , d.cve_doc, d.fechaelab, d.importe
					from preoc01 a
					left join par_compo01 b on a.id = b.id_preoc and b.status <> 'C'
					left join par_compr01 c on b.cve_doc = c.doc_ant and b.id_preoc = c.id_preoc and c.status <> 'C'
					left join factf01 d on  a.cotiza = d.doc_ant and d.status <> 'C'
                where ((UPPER(COTIZA) CONTAINING UPPER('PJ'))) and a.status <> 'C'";
            	break;

            	case '12':
				$this->query ="SELECT a.id, a.cotiza as pedido, a.nom_cli, a.urgente, a.fact_ant, a.fechasol, a.prod, a.nomprod,  a.cant_orig , a.status, b.cve_doc as Orden_de_Compra, b.CANT as Cant_Solicitada, b.status, a.rest as Falta_Solicitar, c.cve_doc as Recepcion, c.cant as Cant_Recibida, a.REC_faltante, c.status , d.cve_doc, d.fechaelab, d.importe
					from preoc01 a
					left join par_compo01 b on a.id = b.id_preoc and b.status <> 'C'
					left join par_compr01 c on b.cve_doc = c.doc_ant and b.id_preoc = c.id_preoc and c.status <> 'C'
					left join factf01 d on  a.cotiza = d.doc_ant and d.status <> 'C'
                where ((UPPER(COTIZA) CONTAINING UPPER('PK'))) and a.status <> 'C'";
            	break;

            	case '13':
				$this->query ="SELECT a.id, a.cotiza as pedido, a.nom_cli, a.urgente, a.fact_ant, a.fechasol, a.prod, a.nomprod,  a.cant_orig , a.status, b.cve_doc as Orden_de_Compra, b.CANT as Cant_Solicitada, b.status, a.rest as Falta_Solicitar, c.cve_doc as Recepcion, c.cant as Cant_Recibida, a.REC_faltante, c.status , d.cve_doc, d.fechaelab, d.importe
					from preoc01 a
					left join par_compo01 b on a.id = b.id_preoc and b.status <> 'C'
					left join par_compr01 c on b.cve_doc = c.doc_ant and b.id_preoc = c.id_preoc and c.status <> 'C'
					left join factf01 d on  a.cotiza = d.doc_ant and d.status <> 'C'
                where ((UPPER(COTIZA) CONTAINING UPPER('PL'))) and a.status <> 'C'";
            	break;

            	case '14':
				$this->query ="SELECT a.id, a.cotiza as pedido, a.nom_cli, a.urgente, a.fact_ant, a.fechasol, a.prod, a.nomprod,  a.cant_orig , a.status, b.cve_doc as Orden_de_Compra, b.CANT as Cant_Solicitada, b.status, a.rest as Falta_Solicitar, c.cve_doc as Recepcion, c.cant as Cant_Recibida, a.REC_faltante, c.status , d.cve_doc, d.fechaelab, d.importe
					from preoc01 a
					left join par_compo01 b on a.id = b.id_preoc and b.status <> 'C'
					left join par_compr01 c on b.cve_doc = c.doc_ant and b.id_preoc = c.id_preoc and c.status <> 'C'
					left join factf01 d on  a.cotiza = d.doc_ant and d.status <> 'C'
                where ((UPPER(COTIZA) CONTAINING UPPER('PM'))) and a.status <> 'C'";
            	break;

            	case '15':
				$this->query ="SELECT a.id, a.cotiza as pedido, a.nom_cli, a.urgente, a.fact_ant, a.fechasol, a.prod, a.nomprod,  a.cant_orig , a.status, b.cve_doc as Orden_de_Compra, b.CANT as Cant_Solicitada, b.status, a.rest as Falta_Solicitar, c.cve_doc as Recepcion, c.cant as Cant_Recibida, a.REC_faltante, c.status , d.cve_doc, d.fechaelab, d.importe
					from preoc01 a
					left join par_compo01 b on a.id = b.id_preoc and b.status <> 'C'
					left join par_compr01 c on b.cve_doc = c.doc_ant and b.id_preoc = c.id_preoc and c.status <> 'C'
					left join factf01 d on  a.cotiza = d.doc_ant and d.status <> 'C'
					where ((UPPER(COTIZA) CONTAINING UPPER('PN'))) and a.status <> 'C'";
            	break;

            	case '16':
				$this->query ="SELECT a.id, a.cotiza as pedido, a.nom_cli, a.urgente, a.fact_ant, a.fechasol, a.prod, a.nomprod,  a.cant_orig , a.status, b.cve_doc as Orden_de_Compra, b.CANT as Cant_Solicitada, b.status, a.rest as Falta_Solicitar, c.cve_doc as Recepcion, c.cant as Cant_Recibida, a.REC_faltante, c.status , d.cve_doc, d.fechaelab, d.importe
					from preoc01 a
					left join par_compo01 b on a.id = b.id_preoc and b.status <> 'C'
					left join par_compr01 c on b.cve_doc = c.doc_ant and b.id_preoc = c.id_preoc and c.status <> 'C'
					left join factf01 d on  a.cotiza = d.doc_ant and d.status <> 'C'
                where ((UPPER(COTIZA) CONTAINING UPPER('PO'))) and a.status <> 'C'";
            	break;

            	case '17':
				$this->query ="SELECT a.id, a.cotiza as pedido, a.nom_cli, a.urgente, a.fact_ant, a.fechasol, a.prod, a.nomprod,  a.cant_orig , a.status, b.cve_doc as Orden_de_Compra, b.CANT as Cant_Solicitada, b.status, a.rest as Falta_Solicitar, c.cve_doc as Recepcion, c.cant as Cant_Recibida, a.REC_faltante, c.status , d.cve_doc, d.fechaelab, d.importe
					from preoc01 a
					left join par_compo01 b on a.id = b.id_preoc and b.status <> 'C'
					left join par_compr01 c on b.cve_doc = c.doc_ant and b.id_preoc = c.id_preoc and c.status <> 'C'
					left join factf01 d on  a.cotiza = d.doc_ant and d.status <> 'C'
                where ((UPPER(COTIZA) CONTAINING UPPER('PQ'))) and a.status <> 'C'";
            	break;

            	case '18':
				$this->query ="SELECT a.id, a.cotiza as pedido, a.nom_cli, a.urgente, a.fact_ant, a.fechasol, a.prod, a.nomprod,  a.cant_orig , a.status, b.cve_doc as Orden_de_Compra, b.CANT as Cant_Solicitada, b.status, a.rest as Falta_Solicitar, c.cve_doc as Recepcion, c.cant as Cant_Recibida, a.REC_faltante, c.status , d.cve_doc, d.fechaelab, d.importe
					from preoc01 a
					left join par_compo01 b on a.id = b.id_preoc and b.status <> 'C'
					left join par_compr01 c on b.cve_doc = c.doc_ant and b.id_preoc = c.id_preoc and c.status <> 'C'
					left join factf01 d on  a.cotiza = d.doc_ant and d.status <> 'C'
                where ((UPPER(COTIZA) CONTAINING UPPER('PR'))) and a.status <> 'C'";
            	break;
}
		$result = $this->EjecutaQuerySimple();
		if($this->NumRows($result)> 0){
				while ($tsArray = $this->FetchAs($result))
						$data[] = $tsArray;
					return $data;
		}
		return 0;
	}

	function PorFacturar(){	
        $this->query= "SELECT a.*, a.cve_fact as cotiza, cl.nombre as cliente, a.fecha_creacion, pe.fechaelab, datediff(day, a.fecha_creacion, current_date) as dias
        			   FROM CAJAS a 
        			   left join factp01 pe on pe.cve_doc = a.cve_fact
        			   left join clie01 cl on pe.cve_clpv = cl.clave 
        			   WHERE a.STATUS = 'cerrado' and a.factura ='' and a.remision =''";			
		$result = $this->EjecutaQuerySimple();
		if($this->NumRows($result)> 0){
				while ($tsArray = $this->FetchAs($result))
						$data[] = $tsArray;
					return $data;
		}
		return 0;
	}

	function PorFacturarEntrega(){		//01072016

		$this->query="SELECT a.cotiza, 
		sum(rec_faltante) as Faltante, 
		MAX(NOM_CLI) AS NOM_CLI, 
		MAX (CLIEN) AS CLIEN, 
		max(c.codigo) as CODIGO, 
        MAX(b.doc_sig) as FACTURA, 
        max (a.fechasol) as FECHASOL, 
        max(b.importe) as IMPORTE, 
        max(datediff(day,b.FECHAELAB,current_date)) as DIAS,
        MAX(b.CITA) as CITA, 
        max(factura) as factura, 
        max(fecha_fact) as fecha_factu, 
        sum(a.recepcion) as recibido,  
        sum(a.empacado) as empacado, 
        max(f.fechaelab) as fecha_fact,
        sum(a.facturado) as facturado, 
        sum(a.remisionado) as remisionado, 
        sum(pendiente_facturar) as penfact, 
        sum(pendiente_remisionar) as penrem
                FROM preoc01 a
                LEFT JOIN FACTP01 b on a.cotiza = b.cve_doc
                LEFT JOIN CLIE01 c on b.cve_clpv = c.Clave
                left join factf01 f on f.cve_doc = a.factura 
                left join factr01 r on r.cve_doc = a.remision 
                where fechasol >= '01.08.2016'
                group by cotiza
                HAVING (SUM(REC_FALTANTE) = 0 
                and (sum(a.empacado) < sum(a.recepcion))  
                AND (sum(a.recepcion) = sum(a.cant_orig)))";
               /* and (max(f.fechaelab) > '01.08.2016' or max(r.fechaelab) > '01.07.2016')"; /*PENDIENTE*/
		$result = $this->QueryObtieneDatosN();
		while ($tsArray = ibase_fetch_object($result)){
						$data[] = $tsArray;
				
		}
			return $data;
	}
	
	function ConsultaUsur(){		
		$data = array();
		$this->query ="SELECT *FROM PG_USERS order by id";
		$result = $this->EjecutaQuerySimple();
		while ( $tsArray = ibase_fetch_object($result)){ 
					$data[] = $tsArray;			
		}
			return $data;
	}
	
	function ConsultaUsurEmail($email){
			$this->query ="SELECT a.*, coalesce((select descripcion from ftc_roles where nombre = a.USER_ROL ), 'Rol Antiguo') AS nomrol FROM PG_USERS a WHERE a.USER_LOGIN = '$email'";
		$result = $this->QueryObtieneDatos();
		$data[] = $result;
		return $data;

		}
	
	
	function ActualizaStatusSegdoc($compo){
		$this->query = "UPDATE PG_SEGDOC
						SET ESTATUS = 1
						WHERE ID = $compo";
		$result = $this->EjecutaQuerySimple();
		if(count($result) > 0){		
		$d = $this->ConsultaUsur();
		return $d;
	}else{
		return 0;
	}
		
	}
	
	function ActualizaFactf($factura, $compo){
		$this->query = "UPDATE FACTF01 
						SET STATUS_FACT = 'a', ID_SEG = '$compo'
						WHERE CVE_DOC = '$factura'";
		$result = $this->EjecutaQuerySimple();
		if(count($result) > 0){		
		$this->ActualizaStatusSegdoc($compo);
		return $result;
	}else{
		return 0;
	}
		
	}
	
	function ActualizaUsr($mail, $usuario, $contrasena, $email, $rol, $estatus){
		$this->query="SELECT * FROM PG_USERS WHERE USER_LOGIN = '$usuario' and USER_PASS ='$contrasena'";
		$res=$this->EjecutaQuerySimple();
		$row=ibase_fetch_object($res);
		if(!empty($row)){
			$v = '';
		}else{
			$contrasena= md5($contrasena);
			$v = " , USER_PASS='".$contrasena."' ";
			$a = array("status"=>'ok',"contra"=>$contrasena);
		}
		$this->query = "UPDATE PG_USERS 
						SET  USER_EMAIL = '$email', USER_ROL = (select nombre from ftc_roles where 'r_'||idr = '$rol' or nombre = '$rol' ), USER_STATUS = '$estatus' $v
						WHERE USER_LOGIN = '$usuario'";
		$result = $this->EjecutaQuerySimple();

		return $a;
	}
	
	
	function ObtieneRegIC(){
		$this->query = "SELECT COUNT(*)
  						FROM PG_SEGDOC";
						
		$r = $this->QueryObtieneDatos();
		
		return	$r;
	}
	
	function InsertaComp($comp, $nombre, $desc){
		$rs = $this->ObtieneRegIC();
		$id = (int) $rs["COUNT"] + 1;
		//$i = 0;
		
		/*for($i = 0; $i = count($comp);$i++){
			if(isset($comp[$i])){$_ . $i = $comp[$i];}else{$_ . $i =  0;}
		}*/
		
		if(isset($comp[0])){$_1 = $comp[0];}else{$_1 =  0;}
		if(isset($comp[1])){$_2 = $comp[1];}else{$_2 =  0;}
		if(isset($comp[2])){$_3 = $comp[2];}else{$_3 =  0;}
		if(isset($comp[3])){$_4 = $comp[3];}else{$_4 =  0;}
		if(isset($comp[4])){$_5 = $comp[4];}else{$_5 =  0;}
		if(isset($comp[5])){$_6 = $comp[5];}else{$_6 =  0;}
		if(isset($comp[6])){$_7 = $comp[6];}else{$_7 =  0;}
		if(isset($comp[7])){$_8 = $comp[7];}else{$_8 =  0;}
		if(isset($comp[8])){$_9 = $comp[8];}else{$_9 =  0;}
		if(isset($comp[9])){$_10 = $comp[9];}else{$_10 =  0;}
		if(isset($comp[10])){$_11 = $comp[10];}else{$_11 =  0;}
		if(isset($comp[11])){$_12 = $comp[11];}else{$_12 =  0;}
		if(isset($comp[12])){$_13 = $comp[12];}else{$_13 =  0;}
		if(isset($comp[13])){$_14 = $comp[13];}else{$_14 =  0;}
		if(isset($comp[14])){$_15 = $comp[14];}else{$_15 =  0;}
		if(isset($comp[15])){$_16 = $comp[15];}else{$_16 =  0;}
		if(isset($comp[16])){$_17 = $comp[16];}else{$_17 =  0;}
		if(isset($comp[17])){$_18 = $comp[17];}else{$_18 =  0;}
		if(isset($comp[18])){$_19 = $comp[18];}else{$_19 =  0;}
		if(isset($comp[19])){$_20 = $comp[19];}else{$_20 =  0;}
		
		echo $this->query = "INSERT INTO PG_SEGDOC 
					VALUES ($id, '$nombre', '$desc', '$_1', '$_2', '$_3', '$_4', '$_5', 
					'$_6', '$_7', '$_8', '$_9', '$_10', '$_11', '$_12', '$_13', '$_14', '$_15', '$_16', '$_17', '$_18', 
					'$_19', '$_20')";
		//echo $this->query;
		//$result = $this->EjecutaQuerySimple();
		
		/*Cambia el status de los componentes*/
		//$cambia = 1;
		for($i = 1; $i <= 20; $i++){
			if($_ . $i != 0){
				$this->CambiaStatus($_ . $i);
			} 			
		}
		
		return $result;
			
	}

	function CambiaStatus($comp){
		$this->query = "UPDATE PG_SEGCOMP
						SET STATUS = 'baja''
						WHERE SEG_NOMBRE = '$comp'"; 
						
		//$result = $this->EjecutaQuerySimple();						
	}

	function CompruebaComp($nombre){
		$this->query = "SELECT SEG_NOMBRE FROM PG_SEGCOMP WHERE SEG_NOMBRE = '$nombre'";
		$result = $this->QueryObtieneDatos();
		return $result;
	}
	
	/*Funcion que obtiene los componentes existentes*/
	function ConsultaComp(){
		$this->query = "SELECT ID, SEG_NOMBRE 
						FROM PG_SEGCOMP 
						WHERE status = 'alta'";
						
		$result = $this->EjecutaQuerySimple();
		if($this->NumRows($result) > 0){
			while ( $tsArray = $this->FetchAs($result) ) 
					$data[] = $tsArray;			
		
				return $data;
				unset($data);
		}
		
		return 0;
				
	}
	
	/*metodo para mostrar facturas sin asignar*/
	function MuestraFact(){
		$this->query = "SELECT CVE_DOC, TIP_DOC, CVE_CLPV, STATUS, ID_SEG, STATUS_FACT
						FROM FACTF01 
						WHERE status != 'C' and STATUS_FACT is null";
		$result = $this->EjecutaQuerySimple();
		if($this->NumRows($result) > 0){
			while ( $tsArray = $this->FetchAs($result) ) 
					$data[] = $tsArray;
				return $data;
				unset($data);
		}
		
		return 0;
	}
	
	/*metodo para mostrar componentes disponibles para asignar*/
	function MuestraDisp(){
		$this->query = "SELECT a.ID, a.NOMBRE, a.DESCRIPCION, a.ESTATUS
						FROM PG_SEGDOC a
						WHERE a.ESTATUS is null";
		$result = $this->EjecutaQuerySimple();
		if($this->NumRows($result) > 0){
			while ( $tsArray = $this->FetchAs($result) ) 
					$data[] = $tsArray;
				return $data;
				unset($data);
		}
		
		return 0;
	}
	/*Consulta para mostrar los componentes asignados a una factura*/
	function ConsultaFac(){
		$this->query = "SELECT CVE_DOC, TIP_DOC, CVE_CLPV, STATUS, ID_SEG, STATUS_FACT
						FROM FACTF01 
						WHERE status != 'C' and STATUS_FACT = 'a'";
										
		$result = $this->EjecutaQuerySimple();
		if($this->NumRows($result) > 0){
			while ( $tsArray = $this->FetchAs($result) ) 
					$data[] = $tsArray;
				return $data;
				unset($data);
		}
		
		return 0;
	}

	function ConsultaFlu(){
		$this->query = "SELECT ID, NOMBRE FROM PG_SEGDOC
						WHERE ESTATUS != 1";
										
		$result = $this->EjecutaQuerySimple();
		if($this->NumRows($result) > 0){
			while ( $tsArray = $this->FetchAs($result) ) 
					$data[] = $tsArray;			
		
				return $data;
				unset($data);
		}
		
		return 0;
	}
    
    function insertaDocumentoXML($documento, $archivo, $archivoPDF, $emisorRFC, $emisorNombre, $receptorRFC, $receptorNombre, $fecha, $uuid, $importe) {
        $this->query = "INSERT INTO COMP_XML (RFC_E, NOMBRE_E, RFC_R, NOMBRE_R, FECHA_TIM, UUIDC, IMPORTE, ARCHIVO, PDF, OC)
                        VALUES ('$emisorRFC', '$emisorNombre', '$receptorRFC', '$receptorNombre', '$fecha', '$uuid', $importe, '$archivo', '$archivoPDF', '$documento')";
        $result = $this->EjecutaQuerySimple();


        $result+= $this->actualizaComprobado($documento, $importe);
        return $result>0;
    }

    function actualizaComprobado($documento, $total) {
        $porComprobar = 0;
        $this->query = "SELECT POR_COMPROBAR, COMPROBADO FROM compo01 WHERE CVE_DOC = '$documento'";
        $result = $this->EjecutaQuerySimple();
        while ($row =ibase_fetch_object($result)){
            $porComprobar = $row->POR_COMPROBAR;
            $comprobado = $row->COMPROBADO;
        }
        if ($porComprobar > $total) {
            $Comprobado = $comprobado + $total;
            $por_comprobar = $porComprobar - $total;
            $this->query = "UPDATE compo01 SET status_compra = 'Co', comprobado = $Comprobado, por_comprobar = $por_comprobar WHERE cve_doc = '$documento'";
        } elseif($porComprobar == $total){
            $comprobado = $porComprobar + $total;
            $this->query = "UPDATE compo01 SET status_compra = 'CC', comprobado = $comprobado, por_comprobar = $por_comprobar WHERE cve_doc = '$documento'";
        } else {
            return false;
        }
        echo $por_comprobar;
        $updated = $this->EjecutaQuerySimple();        
        $vuelta = count($updated);
        return $vuelta>0;
    }

	function validaEmisor($documento, $emisorRFC){
        $this->query = "SELECT a.cve_doc, b.nombre, b.rfc FROM compo01 a LEFT JOIN prov01 b on a.cve_clpv = b.clave WHERE cve_doc = '$documento' AND b.rfc = '$emisorRFC'";
        $result = $this->EjecutaQuerySimple();
        if ($this->NumRows($result) > 0) {            
            return true;
        }
        return false;
    }

    function verOrdenes(){
        $this->query = "SELECT a.cve_doc, a.enlazado, a.folio, a.status, a.fechaelab, datediff(day, a.fechaelab, current_date ) as Dias, can_tot, cve_clpv, Nombre, a.TP_TES, a.fecha_pago
						from compo01 a
						left join Prov01 b on a.cve_clpv = b.clave
						where a.enlazado <> 'T' and a.status <>'C'";
        $result = $this->EjecutaQuerySimple();
        while ($tsArray = ibase_fetch_object($result)){
        	$data[] =$tsArray;
        }
        return $data;
    }

	function OC($doco){

		if(substr($doco,0,2 ) == 'OP'){	
			$this->query="SELECT ftcoc.oc as cve_doc, '' as enlazado, '' as folio, ftcoc.status, ftcoc.fecha_oc as fechaelab, datediff(day, ftcoc.fecha_oc, CURRENT_DATE) as dias, ftcoc.costo_total as can_tot, ftcoc.cve_prov  as cve_clpv, p.nombre, ftcoc.tp_tes_req as camplib2, ftcoc.tp_tes, ftcoc.pago_tes 
				from ftc_poc ftcoc 
				left join prov01 p on p.clave = ftcoc.cve_prov
				where oc = '$doco'";
		}else{
			$this->query = "SELECT a.cve_doc, a.enlazado, a.folio, a.status, a.fechaelab, datediff(day, a.fechaelab, current_date ) as Dias, can_tot, cve_clpv, Nombre, c.CAMPLIB2, a.tp_tes, a.pago_tes
						from 
						(compo01 a
						LEFT JOIN compo_clib01 c
						ON a.cve_doc = c.clave_doc)
						left join Prov01 b on a.cve_clpv = b.clave
						where a.cve_doc = '$doco'";
        	}
        	$result = $this->EjecutaQuerySimple();
		
        while ($tsArray = ibase_fetch_object($result)){
        	$data[] =$tsArray;
        }
        return $data;
    }


     function detalleOC($doco){

     	if(substr($doco,0,2) != 'OP'){
     		$this->query = "SELECT 1 as id, a.id_preoc, a.cve_doc, a.num_par, a.cve_art, b.descr,  a.cant, a.pxr, a.TOT_PARTIDA, a.status, a.recep, a.fecha_doc_recep, c.cotiza, a.num_par as partida, a.cve_art as art,
         	(select NOMBRE FROM PRODUCTO_FTC WHERE CLAVE = a.CVE_ART) as descripcion,
          a.cant as cantidad, a.cost as costo, (a.cost * a.cant) as costo_total, b.uni_med as um, 'n/a' as CVE_PROD, a.id_preoc as idpreoc, c.nom_cli as cliente, c.cotiza as cotizacion, c.fechasol, c.cant_orig, a.CANT_RECIBIDA, a.status_val 
						from par_compo01 a
						left join inve01 b on a.cve_art = b.cve_art
						left join preoc01 c on a.id_preoc = c.id
						left join compo01 oc on oc.cve_doc = a.cve_doc
						where a.cve_doc = '$doco' and oc.status_recepcion <> 2";  	
     	}elseif(substr($doco,0,2)=='OP'){
     		$this->query = "SELECT 1 as id, a.idpreoc as id_Preoc, ftcpoc.oc as cve_doc, a.partida as num_par, a.partida, a.art as cve_art, a.art, a.idpreoc, b.descr,  a.cantidad as cant, a.pxr as pxr, a.COSTO_TOTAL, a.status, 'recepcion' as recep, ftcpoc.fecha_oc as fecha_doc_recep, c.cotiza,	(select NOMBRE FROM PRODUCTO_FTC WHERE CLAVE = a.ART) as descripcion,
          a.cantidad as cantidad, a.costo as costo, (a.costo * a.cantidad) as costo_total, b.uni_med as um, 'n/a' as CVE_PROD, c.nom_cli as cliente, c.cotiza as cotizacion, c.fechasol, c.cant_orig, a.Cant_Recibida as CANT_RECIBIDA, a.status_val as status_val, a.costo_total as tot_partida 
						from FTC_POC_DETALLE a
						left join ftc_poc ftcpoc on ftcpoc.cve_doc = a.cve_doc
						left join inve01 b on a.art = b.cve_art
						left join preoc01 c on a.idpreoc = c.id
						left join ftc_poc o on o.cve_doc = a.cve_doc
						where ftcpoc.oc = '$doco' and o.status_recepcion <> 2";
				//echo $this->query;
     	}
        $result = $this->EjecutaQuerySimple();
        while ($tsArray = ibase_fetch_object($result)){
        	$data[] =$tsArray;
        }
        return $data;
    }


    function OCL($doco){


    	if(substr($doco,0,2) != 'OP'){
    		$this->query = "SELECT a.cve_doc, a.enlazado, a.folio, a.status, a.fechaelab, datediff(day, a.fechaelab, current_date ) as Dias, can_tot, cve_clpv as cve_prov, Nombre, b.calle, b.numext, b.numint, b.colonia, b.codigo, b.municipio, b.telefono, c.camplib4, c.camplib2,  a.realiza, c.camplib3, d.str_obs, a.tp_tes, a.pago_tes, b.rfc, a.can_tot as costo, (a.can_tot * .16) as total_iva, (a.can_tot *1.16) as costo_total, b.diascred, b.codigo as cp, b.tp_efectivo, b.tp_cheque, b.tp_transferencia, b.tp_credito, b.cuenta, b.nom_banco
						from compo01 a
						left join Prov01 b on a.cve_clpv = b.clave
						left join COMPO_CLIB01 c on a.cve_doc = c.clave_doc
						left join  obs_docc01 d on a.cve_obs = d.cve_obs  
						where cve_doc = '$doco'";
    	}elseif(substr($doco,0,2)=='OP'){
			$this->query = "SELECT a.OC as cve_doc, 'NA' AS enlazado, a.oc as folio, a.status, a.fecha_oc as fechaelab, datediff(day, a.fecha_oc, current_date ) as Dias, a.costo_total as can_tot, a.cve_prov as cve_prov, Nombre, b.calle, b.numext, b.numint, b.colonia, b.codigo, b.municipio, b.telefono, c.camplib4, c.camplib2,  a.usuario_oc, c.camplib3, a.tp_tes, a.pago_tes, b.rfc, a.costo, a.total_iva, a.costo_total, b.diascred, b.codigo as cp, b.tp_efectivo, b.tp_cheque, b.tp_transferencia, b.tp_credito, b.cuenta, b.nom_banco, 'observaciones' as STR_OBS, a.usuario_oc as realiza
						from FTC_POC a
						left join Prov01 b on a.cve_prov = b.clave
						left join COMPO_CLIB01 c on a.cve_doc = c.clave_doc
						where OC = '$doco'";    		
    	}
    	//echo $this->query;
        
    	$result = $this->QueryObtieneDatosN();
    	while ($tsArray = ibase_fetch_object($result)){
    		$data[] = $tsArray;
    	}
    		return $data;
    }


    function detalleOC_Imp($doco){
    	if(substr($doco,0,2) != 'OP'){
     		$this->query = "SELECT 1 as id, a.id_preoc, a.cve_doc, a.num_par, a.cve_art, b.descr,  a.cant, a.pxr, a.TOT_PARTIDA, a.status, a.recep, a.fecha_doc_recep, c.cotiza, a.num_par as partida, a.cve_art as art,
         	(select NOMBRE FROM PRODUCTO_FTC WHERE CLAVE = a.CVE_ART) as descripcion,
          a.cant as cantidad, a.cost as costo, (a.cost * a.cant) as costo_total, b.uni_med as um, 'n/a' as CVE_PROD, a.id_preoc as idpreoc, c.nom_cli as cliente, c.cotiza as cotizacion, c.fechasol, c.cant_orig, a.CANT_RECIBIDA, a.status_val 
						from par_compo01 a
						left join inve01 b on a.cve_art = b.cve_art
						left join preoc01 c on a.id_preoc = c.id
						left join compo01 oc on oc.cve_doc = a.cve_doc
						where a.cve_doc = '$doco' ";  	
     	}elseif(substr($doco,0,2)=='OP'){
     		$this->query = "SELECT 1 as id, a.idpreoc as id_Preoc, ftcpoc.oc as cve_doc, a.partida as num_par, a.partida, a.art as cve_art, a.art, a.idpreoc, b.descr,  a.cantidad as cant, a.pxr as pxr, a.COSTO_TOTAL, a.status, 'recepcion' as recep, ftcpoc.fecha_oc as fecha_doc_recep, c.cotiza,	(select NOMBRE FROM PRODUCTO_FTC WHERE CLAVE = a.ART) as descripcion,
          a.cantidad as cantidad, a.costo as costo, (a.costo * a.cantidad) as costo_total, b.uni_med as um, 'n/a' as CVE_PROD, c.nom_cli as cliente, c.cotiza as cotizacion, c.fechasol, c.cant_orig, a.Cant_Recibida as CANT_RECIBIDA, a.status_val as status_val, a.costo_total as tot_partida 
						from FTC_POC_DETALLE a
						left join ftc_poc ftcpoc on ftcpoc.cve_doc = a.cve_doc
						left join inve01 b on a.art = b.cve_art
						left join preoc01 c on a.idpreoc = c.id
						left join ftc_poc o on o.cve_doc = a.cve_doc
						where ftcpoc.oc = '$doco' ";
				//echo $this->query;
     	}
        $result = $this->EjecutaQuerySimple();
        while ($tsArray = ibase_fetch_object($result)){
        	$data[] =$tsArray;
        }
        return $data;	
    }


    function idPreoc($idd){
    	$this->query = "SELECT id, COTIZA, prod, STATUS, cant_orig, ordenado, rest, recepcion, REC_faltante,status_ventas
    					FROM preoc01
    					where id = $idd";
        $result = $this->EjecutaQuerySimple();
        while ($tsArray = ibase_fetch_object($result)){
        	$data[] = $tsArray;
        }
        return $data;
    }

    function idCompo($idd){
    	$this->query = "SELECT id_preoc, cve_doc, cve_art, cant, pxr, tot_partida, num_par
    					FROM par_compo01
    					where id_preoc = $idd";
        $result = $this->EjecutaQuerySimple();
        while ($tsArray = ibase_fetch_object($result)){
        	$data[] = $tsArray;
        }
        return $data;
    }

    function idCompr($idd){
    	$this->query = "SELECT a.id_preoc, a.cve_art, a.cant, a.CVE_DOC, a.TOT_PARTIDA, a.NUM_PAR, b.DESCR, a.status, a.fecha_doc
    					FROM par_compr01 a
    					left join inve01 b on a.cve_art = b.cve_art
    					where id_preoc = $idd";
        $result = $this->EjecutaQuerySimple();
        while ($tsArray = ibase_fetch_object($result)){
        	$data[] = $tsArray;
        }
        return $data;
    }

    	///// BOTON  VER / IMPRIMIR COMPROBANTES.

		function verPagos(){
		$data=array();
		$this->query="SELECT a.cve_doc, a.cve_clpv, b.nombre, a.importe, a.fechaelab, a.fecha_doc, doc_sig as Recepcion, a.enlazado,c.camplib1 as TipoPagoR, c.camplib3 as FER, c.camplib2 as TE, c.camplib4 as Confirmado, a.tp_tes as PagoTesoreria, a.pago_tes, pago_entregado, c.camplib6 
					from compo01 a 
					left join Prov01 b on a.cve_clpv = b.clave
					left join compo_clib01 c on a.cve_doc = c.clave_doc
					where a.status <> 'C' and TP_TES <> ''";
					$result = $this->QueryObtieneDatosN();
			while ( $tsArray = ibase_fetch_object($result)){ 
					$data[] = $tsArray;				
			}
				return $data;
	}

	function verEfectivos(){
		$data=array();
		$this->query="SELECT a.*, b.CON_CREDITO, b.diascred, b.clabe, b.BENEFICIARIO as Benef, b.telefono FROM P_EFECTIVO a
					  left join Prov01 b on a.cve_prov = b.clave 
					  where a.status = 'N'";
		$result = $this->QueryObtieneDatosN();
		while ($tsArray = ibase_fetch_object($result)){
			$data[] = $tsArray;
		}

			return $data;
	}


	function verCheques(){
		$data=array();
		$this->query="SELECT a.*, b.CON_CREDITO, b.diascred, b.clabe, b.BENEFICIARIO as Benef, b.telefono FROM P_CHEQUES a
					  left join Prov01 b on a.cve_prov = b.clave 
					  where a.status = 'N'";
		$result = $this->QueryObtieneDatosN();
		while ($tsArray = ibase_fetch_object($result)){
			$data[] = $tsArray;
		}

			return $data;
	}

	function verTrans(){
		$data=array();
		$this->query="SELECT a.*, b.CON_CREDITO, b.diascred, b.clabe, b.BENEFICIARIO as Benef, b.telefono FROM P_TRANS a
					  left join Prov01 b on a.cve_prov = b.clave 
					  where a.status = 'N'";
		$result = $this->QueryObtieneDatosN();
		while ($tsArray = ibase_fetch_object($result)){
			$data[] = $tsArray;
		}

			return $data;
	}

	function verCreditos(){
		$data=array();
		$this->query="SELECT a.*, b.CON_CREDITO, b.diascred, b.clabe, b.BENEFICIARIO as Benef, b.telefono FROM P_CREDITO a
					  left join Prov01 b on a.cve_prov = b.clave 
					  where a.status = 'N'";
		$result = $this->QueryObtieneDatosN();
		while ($tsArray = ibase_fetch_object($result)){
			$data[] = $tsArray;
		}

			return $data;
	}


	function verPXL(){
		$this->query="SELECT a.*, b.*, c.*
					  FROM factp01 a
					  LEFT JOIN clie01 b on a.cve_clpv = b.clave 
					  left join factp_clib01 c on a.cve_doc = c.clave_doc
					  where status2 is null and a.status <> 'C' ";
		$result = $this->QueryObtieneDatosN();
		while ($tsArray = ibase_fetch_object($result)){
			$data[] = $tsArray;
		}
		return $data;
	}

	function liberaPedido($pedido){
		$this->query="UPDATE Preoc01 set Status = 'N', fecha_auto = current_timestamp where cotiza = '$pedido'";
		$result = $this->EjecutaQuerySimple();
		$result+= $this->actPedido($pedido);
			if (count($result) > 0){
				return 1;
			}else{
				return 0;
			}
	}

	function actPedido($pedido){
		$this->query="UPDATE factp01 set STATUS2 = 'L' where cve_doc = '$pedido'";
		$result = $this->EjecutaQuerySimple();
		if (count($result) > 0){
	   		return 1;   	
	   		}else{
	   			return 0;
	   		}
	}

	function GuardaPagoCorrectoOLD($docuOLD, $tipopOLD, $montoOLD, $nomprovOLD, $cveclpvOLD){
		$TIME = time();
		$HOY = date("Y-m-d H:i:s", $TIME);


		$this->query="UPDATE compo01
					  SET TP_TES = '$tipopOLD', PAGO_TES = $montoOLD, FECHA_PAGO = '$HOY', STATUS_PAGO = 'PP'
					  WHERE CVE_DOC = '$docuOLD'";
		$rs = $this->EjecutaQuerySimple();
		$rs+= $this->ActPagoParOCOLD($docuOLD, $tipopOLD, $montoOLD, $nomprovOLD, $cveclpvOLD);
		echo $rs;
		return $rs;
	}

		function Pagos_OLD(){
		$this->query="	SELECT a.cve_doc, b.nombre, a.importe, a.fechaelab, a.fecha_doc, doc_sig as Recepcion, a.enlazado, c.camplib1 as TipoPagoR, c.camplib3 as FER,c.camplib2 as TE, c.camplib4 as Confirmado, a.tp_tes as PagoTesoreria, a.pago_tes, pago_entregado, c.camplib6, a.cve_clpv from compo01 a
						left join Prov01 b on a.cve_clpv = b.clave
						LEFT JOIN compo_clib01 c on a.cve_doc = c.clave_doc
						where a.fechaelab < '02/22/2016' and a.status <> 'C' and  TP_TES is null and (STATUS_PAGO = 'Ch' or STATUS_PAGO = 'CH')";
		$result = $this->QueryObtieneDatosN();
			while ( $tsArray = ibase_fetch_object($result)){ 
					$data[] = $tsArray;				
			}
				return $data;
	}

	//// Insertar Pagos OLD

	function ActPagoParOCOLD($docuOLD, $tipopOLD, $montoOLD, $nomprovOLD, $cveclpvOLD){
		$TIME = time();
		$HOY = date("Y-m-d H:i:s", $TIME);
		$iva = $montoOLD - ($montoOLD / 1.16);

		if($tipopOLD == 'ch'){
		$query="INSERT INTO P_CHEQUES (TIPO, FECHA, MONTO, BENEFICIARIO, IVA, DOCUMENTO, FECHAELAB, CVE_PROV,STATUS,FECHA_DOC, FECHA_APLI, CHEQUE) VALUES (";
		$query .=" '".$tipopOLD."',";
		$query .=" '".$HOY."',";
		$query .=" '".$montoOLD."',";
		$query .=" '".$nomprovOLD."',";
		$query .=" '".$iva."',";
		$query .=" '".$docuOLD."',";
		$query .=" '".$HOY."',";
		$query .=" '".$cveclpvOLD."',";
		$query .=" 'N',";
		$query .=" '".$HOY."',";
		$query .=" '".$HOY."',";
		$query .=" '0'";
		$query .=")"; 
		//echo $query;		
		$this->query =$query;
		$rs = $this->EjecutaQuerySimple();
		

		}elseif ($tipopOLD == 'tr') {
		
		$query="INSERT INTO P_TRANS (TIPO, FECHA, MONTO, BENEFICIARIO, IVA, DOCUMENTO, FECHAELAB, CVE_PROV,STATUS,FECHA_DOC, FECHA_APLI, TRANS) VALUES (";
		$query .=" '".$tipopOLD."',";
		$query .=" '".$HOY."',";
		$query .=" '".$montoOLD."',";
		$query .=" '".$nomprovOLD."',";
		$query .=" '".$iva."',";
		$query .=" '".$docuOLD."',";
		$query .=" '".$HOY."',";
		$query .=" '".$cveclpvOLD."',";
		$query .=" 'N',";
		$query .=" '".$HOY."',";
		$query .=" '".$HOY."',";
		$query .=" '0'";
		$query .=")"; 
		$this->query =$query;
		$rs = $this->EjecutaQuerySimple();	
		}elseif($tipopOLD == 'cr'){
		$query="INSERT INTO P_CREDITO (TIPO, FECHA, MONTO, BENEFICIARIO, IVA, DOCUMENTO, FECHAELAB, CVE_PROV,STATUS,FECHA_DOC, FECHA_APLI, CREDITO) VALUES (";
		$query .=" '".$tipopOLD."',";
		$query .=" '".$HOY."',";
		$query .=" '".$montoOLD."',";
		$query .=" '".$nomprovOLD."',";
		$query .=" '".$iva."',";
		$query .=" '".$docuOLD."',";
		$query .=" '".$HOY."',";
		$query .=" '".$cveclpvOLD."',";
		$query .=" 'N',";
		$query .=" '".$HOY."',";
		$query .=" '".$HOY."',";
		$query .=" '0'";
		$query .=")"; 
		$this->query =$query;
		$rs = $this->EjecutaQuerySimple();
		}elseif($tipopOLD == 'e'){
		$query="INSERT INTO P_EFECTIVO (TIPO, FECHA, MONTO, BENEFICIARIO, IVA, DOCUMENTO, FECHAELAB, CVE_PROV,STATUS,FECHA_DOC, FECHA_APLI, EFECTIVO) VALUES (";
		$query .=" '".$tipopOLD."',";
		$query .=" '".$HOY."',";
		$query .=" '".$montoOLD."',";
		$query .=" '".$nomprovOLD."',";
		$query .=" '".$iva."',";
		$query .=" '".$docuOLD."',";
		$query .=" '".$HOY."',";
		$query .=" '".$cveclpvOLD."',";
		$query .=" 'N',";
		$query .=" '".$HOY."',";
		$query .=" '".$HOY."',";
		$query .=" '0'";
		$query .=")"; 
		$this->query =$query;
		$rs = $this->EjecutaQuerySimple();
		}
	}

		/*obtiene datos para imprimir*/
	function ObtieneDatosTrans($id){
		$this->query="SELECT a.*, b.CLABE, b.BANCO
					  FROM p_trans a
					  left join Prov01 b on a.cve_prov = b.clave
					  WHERE id = $id";
		$res = $this->QueryObtieneDatos();
		
		return $res;
		
	}

	function ObtieneDatosOc($oc){
		$this->query="SELECT a.*, b.CLABE, b.BANCO
					  FROM p_trans a
					  left join Prov01 b on a.cve_prov = b.clave
					  WHERE id = $id";
		$res = $this->QueryObtieneDatos();
		if(count($res) > 0){
				return $res;
		}
		return 0;
	}

	function ActStatusImpresoTrans($id){
		$this->query= "UPDATE P_TRANS 
					   set STATUS = 'I' 
					   where id = '$id'";
		$res = $this->EjecutaQuerySimple();		
	}

	function ActRuta($id, $doc){
		if(substr($doc,0,2) != 'OP'){
			$this->query="UPDATE COMPO01 set RUTA = 'N'  where cve_doc = '$doc'";	
		}else{
			$this->query="UPDATE FTC_POC SET RUTA = 'N' where cve_doc = '$doc'";
		}
		$res = $this->EjecutaQuerySimple();
	}

	function actRutaAdmon($secuenciaentrega, $tipo){
		$tipoO = $tipo;
		$usuario =$_SESSION['user']->NOMBRE;
		$mysql= new pegaso_rep;
		foreach ($secuenciaentrega as $key ) {
			$key1=$key->ID;
			if($tipo == 1){
				$tipo = "'admon'";
				$SIG = 2;
			}elseif($tipo == 2 ){
				$idk = $key->ID;
				$tipo="(SELECT status_log from cajas where id=";
				$SIG = 3;
			}elseif($tipo == 3){
				$SIG = 5;
				$tipo="(SELECT status_log from cajas where id=";
			}
			if($key->STATUS_RECEPCION <= 5 ){

				if($SIG ==3 and ($key->STATUS_LOG == 'admon' or empty($key->STATUS_LOG))){	
					/// 	no hace nada.... si es 2 desde Administracion	, 	
				}elseif(strtoupper($key->STATUS_LOG) != 'REENRUTAR'){	
					if($tipo == "'admon'"){	
						$this->query="INSERT INTO FTC_HISTORIA_CAJA VALUES(NULL,(SELECT STATUS_RECEPCION FROM CAJAS WHERE ID = $key->ID), $SIG, CURRENT_TIMESTAMP, '$usuario', $key->ID, (SELECT iif(factura = '', remision , factura) from cajas where id = $key->ID))";
						$this->grabaBD();
	
						$this->query="UPDATE CAJAS SET STATUS_RECEPCION=$SIG, status_log = $tipo where id = $key->ID";
						$rs=$this->queryActualiza();	
					
						$datos = array('admon', $key->ID);
						$sql = $mysql->asignaUnidad($datos);  
				
					}else{
	
						$this->query="INSERT INTO FTC_HISTORIA_CAJA VALUES(NULL,(SELECT STATUS_RECEPCION FROM CAJAS WHERE ID = $key->ID), $SIG, CURRENT_TIMESTAMP, '$usuario', $key->ID, (SELECT iif(factura = '', remision , factura) from cajas where id = $key->ID))";
						$this->grabaBD();
	
						$this->query="UPDATE CAJAS SET STATUS_RECEPCION=$SIG, status_log = $tipo$key1) where id = $key->ID";
						$rs=$this->queryActualiza();
					}
					//echo $this->query.'<br/>';
				}elseif(strtoupper($key->STATUS_LOG) == 'REENRUTAR' and $key->VUELTAS <=3 and $tipoO==3){
					/// sUMAMOS EN 1 EL CONTADOR DE ENVIOS HASTA EL 3 SER ENVIO.
					$this->query="INSERT INTO FTC_HISTORIA_CAJA VALUES(NULL,(SELECT STATUS_RECEPCION FROM CAJAS WHERE ID = $key->ID), 0, CURRENT_TIMESTAMP, '$usuario', $key->ID, (SELECT iif(factura = '', remision , factura) from cajas where id = $key->ID))";
						$this->grabaBD();
	
					$this->query="UPDATE CAJAS SET VUELTAS = VUELTAS + 1, STATUS_RECEPCION = 0, DOCS = 'No', U_LOGISTICA = '', status_log = '', unidad = '', idu = null, ruta =	 'N' WHERE ID = $key->ID";	
						$this->queryActualiza();	
						//echo	 $this->query.'<br/>	';	
						if(!empty($key->FACTURA)){	
							$documento = $key->FACTURA;	
						}else{	
							$documento = $key->REMISION;	
						}	
					$this->query="INSERT INTO FTC_REG_VUELTAS (ID, CAJA, PEDIDO, DOCUMENTO, UNIDAD, CHOFER, FECHA, MOTIVO, VUELTA ) 	
										VALUES (NULL, $key->ID, '$key->CVE_FACT', '$documento', '$key->UNIDAD', (SELECT OPERADOR FROM UNIDADES WHERE NUMERO 	= '$key->UNIDAD'), 
										'$key->FECHA_U_LOGISTICA', '', $key->VUELTAS + 1  )";
					$this->grabaBD();
				}elseif(strtoupper($key->STATUS_LOG) == 'REENRUTAR' and $key->VUELTAS >=4 and $tipoO==3) {
	
					$this->query="INSERT INTO FTC_HISTORIA_CAJA VALUES(NULL,(SELECT STATUS_RECEPCION FROM CAJAS WHERE ID = $key->ID), 6, CURRENT_TIMESTAMP,'$usuario', $key->ID, (SELECT iif(factura = '', remision , factura) from cajas where id = $key->ID))";
						$this->grabaBD();
	
					$this->query="UPDATE CAJAs SET STATUS_RECEPCION = 6 WHERE ID = $key->ID";
					$this->queryActualiza();				
					//echo $this->query.'<br/>';
				}elseif(strtoupper($key->STATUS_LOG) == 'REENRUTAR' and $tipoO==2){
	
					$this->query="INSERT INTO FTC_HISTORIA_CAJA VALUES(NULL,(SELECT STATUS_RECEPCION FROM CAJAS WHERE ID = $key->ID), $SIG, 	CURRENT_TIMESTAMP, '$usuario', $key->ID, (SELECT iif(factura = '', remision , factura) from cajas where id = $key->ID))";
							$this->grabaBD();
	
					$this->query="UPDATE CAJAS SET STATUS_RECEPCION=$SIG, status_log = $tipo$key1) where id = $key->ID";
					$rs=$this->queryActualiza();
					//echo $this->query.'<br/>';
				}
			}else{
			$this->query="INSERT INTO FTC_HISTORIA_CAJA VALUES(NULL,(SELECT STATUS_RECEPCION FROM CAJAS WHERE ID = $key->ID), 0, CURRENT_TIMESTAMP, 	'$usuario', $key->ID, (SELECT iif(factura = '', remision , factura) from cajas where id = $key->ID))";
						$this->grabaBD();
			$this->query="UPDATE CAJAS SET STATUS_RECEPCION = 4 WHERE ID = $key->ID";
			$this->queryActualiza();
			}
		}
		return;
	}

	function ObtieneDatosEfectivo($id){
		$this->	query="SELECT * 
					  FROM P_EFECTIVO 
					  WHERE id = $id";
		$res = $this->QueryObtieneDatos();
		
		return $res;
	}

	function ActStatusImpresoEfectivo($id){
		$this->query= "UPDATE P_efectivo 
					   set STATUS = 'I' 
					   where id = '$id'";
		$res = $this->EjecutaQuerySimple();		
	}

	function ObtieneDatosCheque($id){
		$this->query="SELECT * 
					  FROM P_Cheques 
					  WHERE id = $id";
		$res = $this->QueryObtieneDatos();
		
		return $res;
	}

	function ActStatusImpresoCheque($id){
		$this->query= "UPDATE P_Cheques 
					   set STATUS = 'I' 
					   where id = '$id'";
		$res = $this->EjecutaQuerySimple();		
	}

		function ObtieneDatosCredito($id){
		$this->query="SELECT * 
					  FROM P_CREDITO
					  WHERE id = $id";
		$res = $this->QueryObtieneDatos();
		return $res;
	}

	function ActStatusImpresoCredito($id){
		$this->query= "UPDATE P_Credito 
					   set STATUS = 'I' 
					   where id = '$id'";
		$res = $this->EjecutaQuerySimple();		
	}
	function verEfectivosImp(){
		$data=array();
		$this->query="SELECT a.*, b.CON_CREDITO, b.diascred, b.clabe, b.BENEFICIARIO as Benef, b.telefono FROM P_EFECTIVO a
					  left join Prov01 b on a.cve_prov = b.clave 
					  where a.status = 'I'";
		$result = $this->QueryObtieneDatosN();
		while ($tsArray = ibase_fetch_object($result)){
			$data[] = $tsArray;
		}

			return $data;
	}

	function verChequesImp(){
		$data = array();
		$this->query="SELECT a.*, b.CON_CREDITO, b.diascred, b.clabe, b.BENEFICIARIO as Benef, b.telefono FROM P_CHEQUES a
					  left join Prov01 b on a.cve_prov = b.clave 
					  where a.status = 'I'";
		$result = $this->QueryObtieneDatosN();
		while ($tsArray = ibase_fetch_object($result)){
			$data[] = $tsArray;
		}
			return $data;
	}

	function verTransImp(){
		$this->query="SELECT a.*, b.CON_CREDITO, b.diascred, b.clabe, b.BENEFICIARIO as Benef, b.telefono FROM P_TRANS a
					  left join Prov01 b on a.cve_prov = b.clave 
					  where a.status = 'I'";
		$result = $this->QueryObtieneDatosN();
		while ($tsArray = ibase_fetch_object($result)){
			$data[] = $tsArray;
		}

			return $data;
	}

	function verCreditosImp(){
		$this->query="SELECT a.*, b.CON_CREDITO, b.diascred, b.clabe, b.BENEFICIARIO as Benef, b.telefono FROM P_CREDITO a
					  left join Prov01 b on a.cve_prov = b.clave 
					  where a.status = 'I'";
		$result = $this->QueryObtieneDatosN();
		while ($tsArray = ibase_fetch_object($result)){
			$data[] = $tsArray;
		}

			return $data;
	}

   	function ActualizaRuta($docu, $unidad){
   		#echo "Este es el valor de unidad: ".$unidad;
		$TIME = time();
		$HOY = date("Y-m-d");
		$date=DateTime::createFromFormat('Y-m-d',$HOY);
		$formatdate=$date->format('m-d-Y');
		$idunidad = "SELECT * FROM UNIDADES WHERE NUMERO = '$unidad'";
		$this->query = $idunidad;
		$result=$this->EjecutaQuerySimple();
		$row=ibase_fetch_object($result);
		$idunidad=$row->IDU;

		if(substr($docu,0 ,2) =='OP'){
			$this->query="UPDATE FTC_POC_DETALLE SET STATUS_REAL = 'LOGISTICA 3' WHERE OC ='$docu'";
			$this->EjecutaQuerySimple();

			$this->query="UPDATE FTC_POC SET UNIDAD = '$unidad', RUTA='A', IDU = $idunidad, status_log='secuencia', status='LOGISTICA' where oc = '$docu'";
			$rs=$this->EjecutaQuerySimple();
		}else{
			$this->query="UPDATE compo01
					  SET UNIDAD = '$unidad', RUTA = 'A', idu= '$idunidad', STATUS_LOG = 'secuencia'
					  WHERE CVE_DOC = '$docu'";
			$rs = $this->EjecutaQuerySimple();
		}
		return $rs;
	}

	function ActualizaRutaEdoMex($docu, $unidad){
		$TIME = time();
		$HOY = date("Y-m-d H:i:s", $TIME);
		$this->query="UPDATE compo01
					  SET UNIDAD = '$unidad', RUTA = 'A'
					  WHERE CVE_DOC = '$docu'";
		$rs = $this->EjecutaQuerySimple();
		return $rs;
	}

	function verUnidades(){
		$data=array();
		$this->query = "SELECT * FROM UNIDADES where status = 'A'";
     	$result = $this->QueryObtieneDatosN();
     	while ($tsArray = ibase_fetch_object($result)){
     		$data[] = $tsArray;
     	}
     	return $data;
	}

	function verUnidad($unidad){
		$uni = "SELECT NUMERO FROM UNIDADES WHERE IDU = '$unidad'";
		$this->query = $uni;
		$result = $this->EjecutaQuerySimple();
		$row = ibase_fetch_object($result);
		$uni = $row->NUMERO;
     	$this->query="SELECT  a.*, b.NOMBRE, (datediff(day, a.fechaelab, current_date )) as Dias, b.codigo, b.estado as ESTADOPROV, b.codigo 
     				  from compo01 a
     				  left join PROV01 b on a.cve_clpv = b.clave 
     				  where UNIDAD = '$uni'";
     	$result = $this->QueryObtieneDatosN();
     	while ($tsArray = ibase_fetch_object($result)){
     		$data[] = $tsArray;
     	}
     		return $data; 
    }

    function eliminaUn($unidad){
    	$usuario=$_SESSION['user']->NOMBRE; 
    	$this->query="UPDATE UNIDADES SET STATUS='B', FECHA_ELIMINA = CURRENT_TIMESTAMP, USUARIO_ELIMINA='$usuario' WHERE IDU = $unidad";
    	$this->queryActualiza();
    	return;
    }

     function verUnidadesRutas($unidad){
     	$uni = "SELECT * FROM UNIDADES WHERE idu = '$unidad'";
		$this->query = $uni;
		$result = $this->EjecutaQuerySimple();
		$row = ibase_fetch_object($result);
		$uni = $row->NUMERO;

     	$this->query="SELECT  a.*, b.NOMBRE, (datediff(day, a.fechaelab, current_date )) as Dias, b.codigo, b.estado as ESTADOPROV, b.codigo
     				  from compo01 a
     				  left join PROV01 b on a.cve_clpv = b.clave 
     				  where UNIDAD = '$uni' and secuencia is null 
     				  order by b.clave asc";
     	$result = $this->QueryObtieneDatosN();
     	while ($tsArray = ibase_fetch_object($result)){
     		$data[] = $tsArray;
     	}

     		return $data;  		
     }

         function verUnidadesRuta(){
     	$this->query="SELECT  a.*, b.NOMBRE, (datediff(day, a.fechaelab, current_date )) as Dias, b.codigo, b.estado as ESTADOPROV, b.codigo
     				  from compo01 a
     				  left join PROV01 b on a.cve_clpv = b.clave 
     				  where secuencia is null and unidad <> '' 
     				  order by b.clave asc";
     	$result = $this->QueryObtieneDatosN();
     	while ($tsArray = ibase_fetch_object($result)){
     		$data[] = $tsArray;
     	}

     		return $data;  		
     }

    function verUnidadesRutas2($unidad){

     	$this->query="SELECT  a.*, b.NOMBRE, (datediff(day, a.fechaelab, current_date )) as Dias, b.codigo, b.estado as ESTADOPROV, b.codigo
     				  from compo01 a
     				  left join PROV01 b on a.cve_clpv = b.clave 
     				  where UNIDAD = '$unidad'  and secuencia is null 
     				  order by b.clave asc";
     	$result = $this->QueryObtieneDatosN();
     	while ($tsArray = ibase_fetch_object($result)){
     		$data[] = $tsArray;

     	}

     		return $data;  		
     }

 	function verUnidadesRuta3(){

     	$this->query="SELECT  a.*, b.NOMBRE, (datediff(day, a.fechaelab, current_date )) as Dias, b.codigo, b.estado as ESTADOPROV, b.codigo
     				  from compo01 a
     				  left join PROV01 b on a.cve_clpv = b.clave 
     				  where unidad <> '' and secuencia is null 
     				  order by b.clave asc";
     	$result = $this->QueryObtieneDatosN();
     	while ($tsArray = ibase_fetch_object($result)){
     		$data[] = $tsArray;

     	}

     		return $data;  		
     }

	function asignaSecu($docu, $secu, $unidad, $fechai, $fechaf){
		$TIME = time();
		$HOY = date("Y-m-d H:i:s", $TIME);
		$this->query="UPDATE COMPO01 
					  SET SECUENCIA = '$secu', fecha_secuencia = '$HOY', fecha_log_i = '$fechai', fecha_log_f = '$fechaf'
					  where cve_doc = '$docu'";
		$rs = $this->EjecutaQuerySimple();
		return $rs;
	}     	

	function ConsultaUnidad($unidad){
		$this->query="SELECT a.IDU, a.NUMERO, a.MARCA, a.MODELO, a.PLACAS, a.OPERADOR, a.TIPO, a.TIPO2, a.COORDINADOR FROM UNIDADES a WHERE a.IDU = '$unidad'";
     	$result = $this->QueryObtieneDatosN();
     	while ($tsArray = ibase_fetch_object($result)){
     		$data[] = $tsArray;

     	}

     		return $data;  
	}

	function ActualizaNUnidad($numero, $marca, $modelo, $placas, $operador, $tipo, $tipo2, 
		$coordinador, $idu){
		$this->query="UPDATE UNIDADES 
					  SET NUMERO = '$numero', MARCA = '$marca', MODELO = '$modelo', PLACAS = '$placas', OPERADOR = '$operador', TIPO = '$tipo', TIPO2 = '$tipo2', 
					  COORDINADOR = $coordinador 
					  where IDU = '$idu'";
		$rs = $this->EjecutaQuerySimple();
		return $rs;
	}

	function verRutasxUnidad($id){
		$uni = "SELECT * FROM UNIDADES WHERE idu = '$id'";
		$this->query = $uni;
		$result = $this->EjecutaQuerySimple();
		$row = ibase_fetch_object($result);
		$uni = $row->NUMERO;

		$this->query="SELECT  a.*, b.NOMBRE, (datediff(day, a.fechaelab, current_date )) as Dias, b.codigo, b.estado as ESTADOPROV, b.codigo
     				  from compo01 a
     				  left join PROV01 b on a.cve_clpv = b.clave 
     				  where UNIDAD = '$uni' and secuencia is null 
     				  order by b.clave asc";
     	$result = $this->QueryObtieneDatosN();

     	//echo $this->query;

     	while ($tsArray = ibase_fetch_object($result)){
     		$data[] = $tsArray;
     	}



     	$this->query="SELECT ";

     		return $data;  	
	}


	function AdmonRutasxUnidad($idr, $tipo){
			$data=array();
			$uni = "SELECT * FROM UNIDADES WHERE idu = '$idr'";
			$this->query = $uni;
			$result = $this->EjecutaQuerySimple();
			$row = ibase_fetch_object($result);
			$uni = $row->NUMERO;
		if($tipo == 'total'){
			$this->query="SELECT ORDEN, MAX(ID_RECEPCION) AS RECEPCION, sum(cantidad_rec) as recibido, sum(cantidad_oc) as cant_ord 
						FROM FTC_DETALLE_RECEPCIONES 
						WHERE STATUS = 0 AND FECHA >= '01.11.2018' AND ORDEN CONTAINING('OP') GROUP BY ORDEN, CAST(FECHA  AS DATE)";
			$rs=$this->EjecutaQuerySimple();
			while ($tsArray=ibase_fetch_object($rs)) {
				$data2[]=$tsArray;
			}
			foreach ($data2 as $key) {
				$this->query="SELECT ftc.oc as cve_doc, ftc.fecha_oc as fecha_doc, ftc.cve_prov as cve_clpv, datediff(day, ftc.fecha_oc, current_date) as dias, p.nombre, ftc.vueltas, 
            				p.estado, p.codigo, ftc.fecha_oc as fechaelab, ftc.unidad, ftc.fecha_pago, ftc.tp_tes, ftc.pago_tes, ftc.costo_total as importe, ftc.idu, p.clave as prov, p.estado as estadoprov, ftc.secuencia, current_date as hoy, ftc.horai, ftc.horaf, $key->RECEPCION AS RECEPCION, $key->RECIBIDO AS RECIBIDO, $key->CANT_ORD AS CANT_ORD 
						FROM FTC_POC ftc 
						left join PROV01 p on ftc.cve_prov = p.clave
                        left join unidades u on u.idu = ftc.idu 
                        WHERE ftc.OC = '$key->ORDEN' and ftc.idu = $idr";
                $res=$this->EjecutaQuerySimple();
                while($tsArray=ibase_fetch_object($res)){
                	$data[]=$tsArray;
                }
			}
		}else{
			$this->query = "SELECT a.CVE_DOC, a.FECHA_DOC,a.CVE_CLPV, datediff(day, a.fechaelab, current_date) AS DIAS, b.nombre, a.vueltas, 
            				b.estado, b.estado , b.codigo, a.fechaelab, a.unidad, a.fecha_pago, a.tp_tes, a.pago_tes, A.IMPORTE, a.idu, b.clave as prov, a.secuencia, a.fecha_secuencia, horai, horaf, b.estado as estadoprov, current_date as hoy
                            from compo01 a
                            left join PROV01 b on a.cve_clpv = b.clave
                            where IDU = $idr and status_log ='$tipo'";
            $resultado = $this->QueryObtieneDatosN();
            while($tsArray = ibase_fetch_object($resultado)){
                $data[] = $tsArray;
            }
            $this->query="SELECT ftc.oc as cve_doc, ftc.fecha_oc as fecha_doc, ftc.cve_prov as cve_clpv, datediff(day, ftc.fecha_oc, current_date) as dias, p.nombre, ftc.vueltas, 
            				p.estado, p.codigo, ftc.fecha_oc as fechaelab, ftc.unidad, ftc.fecha_pago, ftc.tp_tes, ftc.pago_tes, ftc.costo_total as importe, ftc.idu, p.clave as prov, p.estado as estadoprov, ftc.secuencia, current_date as hoy, ftc.horai, ftc.horaf 
            				from ftc_poc ftc 
            				left join prov01 p on p.clave = ftc.cve_prov
            				where ftc.idu = '$idr'  and ftc.status_log = '$tipo'";
     		$result = $this->QueryObtieneDatosN();
    	 	while ($tsArray = ibase_fetch_object($result)){
     			$data[] = $tsArray;
     		} 	
		}
	
     	return $data;  	
	}


	function cambiaPOCuni($poc, $idu){
		$this->query="SELECT * FROM FTC_POC WHERE oc = '$poc'";
		$res=$this->EjecutaQuerySimple();
		$row=ibase_fetch_object($res);
		if($row){
			$sta= empty($row->STATUS_RECEPCION)? 0:$row->STATUS_RECEPCION;
			$status=$row->STATUS_LOG;
			$uniAct =$row->IDU;
			if($uniAct == $idu ){
				return array("status"=>'ok', "mensaje"=>"El Documento ".$poc." ya se encuentra en la unidad ".$idu);
			}elseif($status != 'secuencia'){
				return array("status"=>'no', "mensaje"=>"El Documento ".$poc.", se encuentra en status".$status.', por lo cual no se puede cambiar, favor de actualizar su navegador');
			}else{
				$this->query="UPDATE FTC_POC SET IDU=$idu, Unidad=(SELECT NUMERO FROM UNIDADES WHERE IDU = $idu AND STATUS = 'A') where oc ='$poc'";
				$res=$this->queryActualiza();

				if($res= 1){
					$usuario=$_SESSION['user']->NOMBRE;
					$this->query="INSERT INTO FTC_REG_LOG (ID, U_A, U_N, FECHA, USUARIO, POC, STA_A, STA_N, STA_LOG_A, STA_LOG_N) VALUES (NULL, $uniAct, $idu, current_timestamp, '$usuario', '$poc',$sta, $sta, '$status', '$status')";
					//echo $this->query;
					$this->grabaBD();
				
					return array("status"=>'ok',"mensaje"=>"El Documento".$poc.", se ha cambiado correctamente y ya no pertenece a esta ruta");
				}
			}
		}else{
			return array("status"=>"no","mensaje"=>"No se encontro la informacion, favor de actualizar");
		}
	}

	function AdmonRutasxUnidad2($doc, $secuencia, $uni, $tipo){
		$data=array();
		$this->query="SELECT  a.*, b.NOMBRE, (datediff(day, a.fechaelab, current_date )) as Dias, b.codigo, b.estado as ESTADOPROV, b.codigo, a.secuencia, (current_date) as HOY
     				  from compo01 a
     				  left join PROV01 b on a.cve_clpv = b.clave 
     				  where UNIDAD = '$uni' and secuencia is not null and a.status_log = 'admon'
     				  order by a.secuencia asc ";
     	$result = $this->QueryObtieneDatosN();
     	while ($tsArray = ibase_fetch_object($result)){
     		$data[] = $tsArray;

     	}
     	 $this->query="SELECT ftc.oc as cve_doc, ftc.fecha_oc as fecha_doc, ftc.cve_prov as cve_clpv, datediff(day, ftc.fecha_oc, current_date) as dias, p.nombre, ftc.vueltas, 
            				p.estado, p.codigo, ftc.fecha_oc as fechaelab, ftc.unidad, ftc.fecha_pago, ftc.tp_tes, ftc.pago_tes, ftc.costo_total as importe, ftc.idu, p.clave as prov, p.estado as estadoprov, ftc.secuencia, current_date as hoy, ftc.horai, ftc.horaf 
            				from ftc_poc ftc 
            				left join prov01 p on p.clave = ftc.cve_prov
            				where ftc.unidad = '$uni' and ftc.status_log = 'admon'";
        $result = $this->QueryObtieneDatosN();
     	while ($tsArray = ibase_fetch_object($result)){
     		$data[] = $tsArray;

     	} 	// and a.status_log = 'Nuevo' 
     		return $data;  	
	}
        
function AdmonRutasxUnidadEntrega($idr){
		$a="SELECT a.*, c.NOMBRE, c.estado, c.codigo, b.fechaelab, d.fechaelab as fechfact, d.cve_doc as FACTURA, (datediff(day, a.FECHA_CREACION,current_date)) as DIAS, iif(a.factura is null or a.factura ='', a.remision, a.factura) as documento 
			FROM CAJAS a 
			LEFT JOIN FACTP01 b ON a.CVE_FACT = b.cve_doc
			LEFT JOIN CLIE01 c ON c.clave = b.cve_clpv
			LEFT JOIN FACTF01 d ON b.doc_sig = d.cve_doc
			WHERE idu = $idr and a.status_recepcion= 1";
		$this->query=$a;
		$result=$this->QueryObtieneDatosN();
		while ($tsArray=ibase_fetch_object($result)){
			$data[]=$tsArray;
		}
		return $data;
	}

	function AdmonRutasxUnidadEntregaForaneo($idr){		// para las entregas foraneas 
		$a="SELECT a.*, c.NOMBRE, c.estado, c.codigo, b.fechaelab, d.fechaelab as fechfact, d.cve_doc as FACTURA, (datediff(day, a.FECHA_CREACION,current_date)) as DIAS, cast(cl.CAMPLIB7 as char(255)) as destino_predeterminado
			FROM CAJAS a 
			LEFT JOIN FACTP01 b ON a.CVE_FACT = b.cve_doc
			LEFT JOIN CLIE01 c ON c.clave = b.cve_clpv
			LEFT JOIN FACTF01 d ON b.doc_sig = d.cve_doc
			LEFT JOIN CLIE_CLIB01 cl on cl.cve_clie = c.clave
			WHERE idu = $idr and a.status_log = 'admon'";
		$this->query=$a;
		$result=$this->QueryObtieneDatosN();
		while ($tsArray=ibase_fetch_object($result)){
			$data[]=$tsArray;
		}
		return $data;
	}
        
	function AdmonRutasxUnidadEntrega2($idr){
		$a="SELECT a.*, c.NOMBRE, c.estado, c.codigo, b.fechaelab, d.fechaelab as fechfact, d.cve_doc as FACTURA, (datediff(day, a.FECHA_CREACION,current_date)) as DIAS, iif(a.factura is null or a.factura ='', a.remision, a.factura) as documento 
			FROM CAJAS a 
			LEFT JOIN FACTP01 b ON a.CVE_FACT = b.cve_doc
			LEFT JOIN CLIE01 c ON c.clave = b.cve_clpv
			LEFT JOIN FACTF01 d ON b.doc_sig = d.cve_doc
			WHERE unidad = '$idr' and a.status_log = 'admon'";
		$this->query=$a;
		$result=$this->QueryObtieneDatosN();
		while ($tsArray=ibase_fetch_object($result)){
			$data[]=$tsArray;
		}
		return @$data;
	}

	function AsignaSec($unidad, $docs){
		$data=array();
		$uni = "SELECT * FROM UNIDADES WHERE idu = '$unidad'";
		$this->query = $uni;
		$result = $this->EjecutaQuerySimple();
		$row = ibase_fetch_object($result);
		$uni = $row->NUMERO;
		$docs= explode(",",$docs );
		$doc="";
		for($i=0; $i<count($docs);$i++){
			$doco= $docs[$i];
			$doc.= ",'".$doco."'";
     	}

     	$doc = substr($doc,1);
     		$this->query="SELECT  b.NOMBRE, count (a.cve_doc) as cve_doc, MAX(current_date ) as Fecha, MAX (b.codigo) as codigo, 
                                      MAX (b.estado) as ESTADOPROV, MAX (b.codigo) as codigo, MAX(unidad) as unidad, 
                                      MAX (datediff(day, a.fechaelab, current_date )) as Dias, max(a.cve_clpv) as prov, a.IDU
                       from compo01 a
                       left join PROV01 b on a.cve_clpv = b.clave
                       where idu = '$unidad' and status_log = 'secuencia'
                       group by b.nombre, a.idu";
     		$result = $this->QueryObtieneDatosN();
	     		while ($tsArray = ibase_fetch_object($result)){
	     			$data[] = $tsArray;
	
     		}
     		$this->query="SELECT  b.NOMBRE, count (a.cve_doc) as cve_doc, MAX(current_date ) as Fecha, MAX (b.codigo) as codigo, 
                                      MAX (b.estado) as ESTADOPROV, MAX (b.codigo) as codigo, MAX(unidad) as unidad, 
                                      MAX (datediff(day, a.fecha_elab, current_date )) as Dias, max(a.cve_prov) as prov, a.IDU
                       from FTC_POC a
                       left join PROV01 b on trim(a.cve_prov) = trim(b.clave)
                       where idu = '$unidad' and status_log = 'secuencia' and oc in ($doc)
                       group by b.nombre, a.idu";
     		$result = $this->QueryObtieneDatosN();
	     		while ($tsArray = ibase_fetch_object($result)){
	     			$data[] = $tsArray;
     			}
     	return $data;  	
	}


	function AsignaSec2($prove, $secuencia, $uni, $fecha){
		$this->query="SELECT  b.NOMBRE, count (a.cve_doc) as cve_doc, MAX(current_date ) as Fecha, MAX (b.codigo) as codigo, MAX (b.estado) as ESTADOPROV, MAX (b.codigo) as codigo, MAX(unidad) as unidad, MAX (datediff(day, a.fechaelab, current_date )) as Dias, max(a.cve_clpv) as prov, max(idu) as IDU
                       from compo01 a
                       left join PROV01 b on a.cve_clpv = b.clave
                       where a.UNIDAD = '$uni' and secuencia is null AND status_log = 'secuencia'
                        group by b.nombre ";
     	$result = $this->QueryObtieneDatosN();
     	while ($tsArray = ibase_fetch_object($result)){
     		$data[] = $tsArray;

     	}
     		return @$data;  	
	}

	function SecUni($prove, $secuencia, $uni, $fecha, $doco){
		$documentos=$doco;
		$usuario= $_SESSION['user']->NOMBRE;
		$ip= $_SERVER['REMOTE_ADDR'];
		$equipo=php_uname();
		$docs=explode(",", $doco);
		$contador=0;
		for($i= 0; $i <count($docs);$i++){
			$doco = $docs[$i];
			$sec ="UPDATE compo01 
				        set secuencia ='$secuencia', status_log = 'admon', fecha_secuencia = current_date, vueltas = vueltas + 1
				        where cve_doc = '$doco'";
			$this->query = $sec;	      
			$rs = $this->EjecutaQuerySimple();

			$this->query="UPDATE FTC_POC_DETALLE SET STATUS_REAL = 'LOGISTICA 4' WHERE OC ='$doco'";
			$this->EjecutaQuerySimple();
			$this->query="UPDATE FTC_POC SET secuencia = $secuencia, status_log = 'admon', fecha_secuencia = current_timestamp, vueltas = vueltas + 1 where OC ='$doco'";
			$res=$this->queryActualiza();
			if($res == 1){
				$contador+=$res;
			}
			$this->query="INSERT INTO FTC_DOC_RECOLECCION (IDDOC, OPERADOR, FECHA_RUTA, DOC, MONTO, STATUS, IDU) 
					VALUES ( NULL, (select operador from UNIDADES WHERE NUMERO = '$uni'),
							current_timestamp, (select id from ftc_poc where oc = '$doco'), (select costo_total from FTC_POC WHERE OC = '$doco'),
							0, (SELECT IDU FROM UNIDADES WHERE NUMERO = '$uni' and status='A'))";
			$this->grabaBD();
		}
			$this->query="INSERT INTO FTC_CTRL_IMP_LOG (ID, FECHA, TIPO, USUARIO, DOCUMENTOS, Contador, equipo, unidad ) 
				values (null, current_timestamp, 'secuencia', '$usuario', '$documentos', $contador,'$ip', $uni)";
				$this->grabaBD();

	return $rs;
	}		
		
	function ObiteneDataSecRO($prove, $uni){
		$sec ="SELECT CVE_DOC FROM COMPO01 where cve_clpv = '$prove' and unidad = '$uni' and secuencia is null and status_log = 'secuencia' ";
		$this->query = $sec;	      
		$resultado = $this->QueryObtieneDatosN();
		while($tsArray = ibase_fetch_object($resultado)){
			$data[] = $tsArray; 	
		}
		return @$data;
	}
	
	function SecRo($doco,$secuencia){
			$this->query = "UPDATE REGISTRO_OPERADORES SET SECUENCIA = '$secuencia', RESULTADO ='admon' WHERE DOCUMENTO = '$doco' AND (SECUENCIA IS NULL OR (SECUENCIA IS NOT NULL AND MOTIVO IS NOT NULL)) ";
			$resultado = $this->EjecutaQuerySimple();
		return @$resultado;
	}
			

	function DefineRuta($doc, $secuencia, $uni, $tipo){
		$tabla = 'compo01';
		$docu = 'CVE_DOC';
		if (substr($doc,0,1) != 'O'){
			$tabla = 'CAJAS';
			$docu = 'CVE_FACT';		
		}

		if($tipo == 'Fallido'){
			$sec ="UPDATE $tabla set status_log = '$tipo', MOTIVO = NULL, doc_sig = null
					where $docu = '$doc'";
			$this->query = $sec;		        
			$rs = $this->EjecutaQuerySimple();
			//echo $this->query;
		}else{
			$sec ="UPDATE $tabla 				
				set status_log = '$tipo', MOTIVO = NULL, status_recepcion = null
					where $docu = '$doc'";
			$this->query = $sec;		        
			$rs = $this->EjecutaQuerySimple();
			//echo $this->query;
		}
		
		if($tabla == 'CAJAS' ){
			$b = "UPDATE CAJAS SET ADUANA = NULL, docs = 'Si' WHERE 	$docu = '$doc'";
			$this->query=$b;
			$result= $this->EjecutaQuerySimple();
		}

		$this->query = "UPDATE FTC_POC_DETALLE SET STATUS_REAL = 'LOGISTICA 5' WHERE CVE_DOC = '$doc'";
		$this->EjecutaQuerySimple();


		$this->query="UPDATE FTC_POC SET status_log = '$tipo', motivo = null, status_recepcion = null, status= 'RECEPCION' where oc = '$doc'";
		$this->EjecutaQuerySimple();
		//echo $this->query;
		//break;
		return $rs;
		}


	function defineRutaForaneo($doc,$guia,$fletera,$cpdestino,$destino,$fechaestimada){
		$this->query = "UPDATE cajas SET status_log = 'Envio', guia_fletera = '$guia', fletera = '$fletera', fecha_guia = current_timestamp, fecha_entrega = '$fechaestimada', destino = '$destino', cp_destino = $cpdestino WHERE cve_fact = '$doc'";
		$resultado = $this->EjecutaQuerySimple();
		return $resultado;
	}

	function guardaGuiaForaneo($ped,$target_file_cc){ //guarda la ruta de la guia foranea en la bd
		$this->query="UPDATE cajas SET f_guia_fletera = '$target_file_cc' WHERE cve_fact = '$ped'";
		$resultado = $this->EjecutaQuerySimple();
		return $resultado;
	}
		
	function DefineResultadoFinRO($doc,$tipo){
		$this->query = "UPDATE REGISTRO_OPERADORES SET RESULTADO = '$tipo' WHERE DOCUMENTO = '$doc'";
		$resultado = $this->EjecutaQuerySimple();
		return $resultado;
	}

	function VerFallidos($idf){
		$this->query="SELECT  b.NOMBRE, a.cve_doc, (current_date ) as Fecha, (b.codigo) as codigo, (b.estado) as ESTADOPROV, (unidad) as unidad, (datediff(day, a.fechaelab, current_date )) as Dias, (a.cve_clpv) as prov, status_log, fechaelab, pago_tes, fecha_pago, secuencia, (current_date) as HOY, idu
                       from compo01 a
                       left join PROV01 b on a.cve_clpv = b.clave
                       where a.idu = '$idf' and status_log = 'Fallido' and Motivo is null";

     	$result = $this->QueryObtieneDatosN();
     	while ($tsArray = ibase_fetch_object($result)){
     		$data[] = $tsArray;

     	}

     		return $data;  	
	}


	function VerOCFallidas(){
		$this->query="SELECT  b.NOMBRE, a.cve_doc, (current_date ) as Fecha, (b.codigo) as codigo, (b.estado) as ESTADOPROV, (unidad) as unidad, (datediff(day, a.fechaelab, current_date )) as Dias, (a.cve_clpv) as prov, status_log, fechaelab, pago_tes, fecha_pago, secuencia, (current_date) as HOY, idu, motivo
                       from compo01 a
                       left join PROV01 b on a.cve_clpv = b.clave
                       where (status_log = 'Fallido') and motivo is not null";              
     	$result = $this->QueryObtieneDatosN();
     	while ($tsArray = ibase_fetch_object($result)){
     		$data[] = $tsArray;

     	}

     		return $data;  	
	}


	function FinalizaRuta($idf, $secuencia, $uni, $motivo, $doc){
		$sec ="UPDATE compo01 
				set Motivo ='$motivo' 
				where cve_doc = '$doc'";
		$this->query = $sec;		        
		$rs = $this->EjecutaQuerySimple();
	
		return $rs;
		}
		
	function FinalizaReEnRuta($idf, $motivo, $doc){					//FINALIZA RE ENRUTA
		$sec ="UPDATE compo01 
				set Motivo ='$motivo', STATUS_LOG = 'Nuevo',  UNIDAD = NULL,SECUENCIA = NULL, 
				FECHA_SECUENCIA = NULL, IDU = NULL, RUTA = 'N', HORAI = NULL, HORAF = NULL
				where cve_doc = '$doc'";
		$this->query = $sec;		        
		$rs = $this->EjecutaQuerySimple();
		return $rs;
		}

	function VerRutaDia(){

		//$TIME = time();
		$HOY = date("Y-m-d"); 
		$date=DateTime::createFromFormat("Y-m-d",$HOY);
		$formatdate=$date->format("m-d-Y");
		$this->query="SELECT  b.NOMBRE, a.cve_doc, (current_date ) as Fecha, (b.codigo) as codigo, (b.estado) as ESTADOPROV, (unidad) as unidad, (datediff(day, a.fechaelab, current_date )) as Dias, (a.cve_clpv) as prov, status_log, fechaelab, pago_tes, fecha_pago, secuencia, (current_date) as HOY, idu, motivo
                       from compo01 a
                       left join PROV01 b on a.cve_clpv = b.clave
                       where fecha_secuencia >= '$formatdate'";              
     	$result = $this->QueryObtieneDatosN();
     	while ($tsArray = ibase_fetch_object($result)){
     		$data[] = $tsArray;

     	}

     		return $data;  	
	}

	function VerRutaXDia($idr){

		$HOY = date("Y-m-d"); 
		$date=DateTime::createFromFormat("Y-m-d",$HOY);
		$formatdate=$date->format("m-d-Y");
		$this->query="SELECT  b.NOMBRE, a.cve_doc, (current_date ) as Fecha, (b.codigo) as codigo, (b.estado) as ESTADOPROV, (unidad) as unidad, 
                              (datediff(day, a.fechaelab, current_date )) as Dias, (a.cve_clpv) as prov, status_log, fechaelab, pago_tes, fecha_pago, 
                              secuencia, (current_date) as HOY, idu, motivo, LEFT(c.camplib3,10) AS CITA, a.urgente
                       from (compo01 a
                       LEFT JOIN COMPO_CLIB01 c
                       ON  a.cve_doc = c.clave_doc)
                       left join PROV01 b on a.cve_clpv = b.clave
                       where fecha_secuencia >= '$formatdate' and idu = '$idr'";              
     	$result = $this->QueryObtieneDatosN();
     	while ($tsArray = ibase_fetch_object($result)){
     		$data[] = $tsArray;

     	}

            return $data;  	
	}

	function asignaHoraInicio($documento) {
		$pedido=substr($documento, 0,1);
		$tabla= 'COMPO01';
		$campo= 'CVE_DOC';
		if($pedido <> 'O'){
			$tabla= 'CAJAS';
			$campo= 'CVE_FACT';
		}
		$ahora = date("H:i:s");
		$sec = "UPDATE $tabla SET HORAI = '$ahora' WHERE $campo = '$documento'";
		$this->query = $sec;
		$rs = $this->EjecutaQuerySimple();

		$this->query="UPDATE ftc_poc set horai = '$ahora' where oc = '$documento'";
		$this->EjecutaQuerySimple();

		return $rs;
	}

	function asignaHoraFin($documento) {
		$pedido=substr($documento, 0, 1);
		$tabla= 'COMPO01';
		$campo= 'CVE_DOC';
		if($pedido <> 'O'){
			$tabla= 'CAJAS';
			$campo= 'CVE_FACT';
		}
		$ahora = date("H:i:s");
		$sec = "UPDATE $tabla SET HORAF = '$ahora' WHERE $campo = '$documento'";
		$this->query = $sec;
		$rs = $this->EjecutaQuerySimple();
		
		$this->query="UPDATE FTC_POC SET HORAF = '$ahora' where oc = '$documento'";
		$this->EjecutaQuerySimple();

		return $rs;
	}
	
	
	function asignaHoraInicioRO($documento) {
		$ahora = date("H:i:s");
		$sec = "UPDATE REGISTRO_OPERADORES SET HORAINI = '$ahora' WHERE DOCUMENTO = '$documento'";
		$this->query = $sec;
		$rs = $this->EjecutaQuerySimple();
		return $rs;
	}

	function asignaHoraFinRO($documento) {
		$ahora = date("H:i:s");
		$sec = "UPDATE REGISTRO_OPERADORES SET HORAFIN = '$ahora' WHERE DOCUMENTO = '$documento'";
		$this->query = $sec;
		$rs = $this->EjecutaQuerySimple();
		return $rs;
	}
	
	
	function VerTotales($idf){
		$this->query="SELECT  b.NOMBRE, a.cve_doc, (current_date ) as Fecha, (b.codigo) as codigo, (b.estado) as ESTADOPROV, (unidad) as unidad, (datediff(day, a.fechaelab, current_date )) as Dias, (a.cve_clpv) as prov, status_log, fechaelab, pago_tes, fecha_pago, secuencia, (current_date) as HOY, idu
                       from compo01 a
                       left join PROV01 b on a.cve_clpv = b.clave
                       where a.idu = '$idf' and status_log = 'Total'";

     	$result = $this->QueryObtieneDatosN();
     	while ($tsArray = ibase_fetch_object($result)){
     		$data[] = $tsArray;

     	}

     		return $data;  	
	}
	
	function VerPnoEnrutar($idf){
		$this->query="SELECT  b.NOMBRE, a.cve_doc, (current_date ) as Fecha, (b.codigo) as codigo, (b.estado) as ESTADOPROV, (unidad) as unidad, (datediff(day, a.fechaelab, current_date )) as Dias, (a.cve_clpv) as prov, status_log, fechaelab, pago_tes, fecha_pago, secuencia, (current_date) as HOY, idu
                       from compo01 a
                       left join PROV01 b on a.cve_clpv = b.clave
                       where a.idu = '$idf' and status_log = 'PNR' and MOTIVO is null";

     	$result = $this->QueryObtieneDatosN();
     	while ($tsArray = ibase_fetch_object($result)){
     		$data[] = $tsArray;

     	}

     		return $data;  	
	}
	
	function VerReEnrutar($idf){
		$this->query="SELECT  b.NOMBRE, a.cve_doc, (current_date ) as Fecha, (b.codigo) as codigo, (b.estado) as ESTADOPROV, (unidad) as unidad, (datediff(day, a.fechaelab, current_date )) as Dias, (a.cve_clpv) as prov, status_log, fechaelab, pago_tes, fecha_pago, secuencia, (current_date) as HOY, idu
                       from compo01 a
                       left join PROV01 b on a.cve_clpv = b.clave
                       where  a.idu = '$idf' AND (status_log = 'Parcial' OR status_log = 'Tiempo') and a.MOTIVO is null";

     	$result = $this->QueryObtieneDatosN();
     	while ($tsArray = ibase_fetch_object($result)){
     		$data[] = $tsArray;

     	}

     		return $data;  	
	}

	
	
	// Ver Todos los registros de logistica que Tengan un status asignado.
	function Logistica(){
		$TIME = time();
		$HOY = date("Y-m-d H:i:s", $TIME);
		$logistica="SELECT a.*, b.*,p.NOMBRE , (datediff(day, a.fechaelab, current_date )) as Dias, '$HOY' AS HOY
		FROM
        (COMPO01 a LEFT JOIN prov01 p ON a.cve_clpv = p.clave)
        left join UNIDADES b on a.idu = b.idu 
        where status_log is not null and a.fechaelab >= '04/01/2016' and a.status != 'C' and a.ENLAZADO != 'T'";
		$this->query=$logistica;
		$result=$this->QueryObtieneDatosN();
		while ($tsArray=ibase_fetch_object($result)){
		$data[] =$tsArray;
	}
		return$data;
	}
	
	/*
	 	function Logistica(){
		$logistica="SELECT a.*, b.*  FROM COMPO01 a 
					left join UNIDADES b on a.idu = b.idu
					where status_log is not null";
		$this->query=$logistica;
		$result=$this->QueryObtieneDatosN();
		while ($tsArray=ibase_fetch_object($result)){
		$data[] =$tsArray;
	}
		return$data;
	}*/


	/// Modificar los Status de Logistica.

	function LinUniOC($doc, $tipo, $uni, $tipoA){		//22-03-2016 ICA
		$Statusi=$tipoA;
		$Statusn=$tipo;
		
		if($Statusi != 'Nuevo')
		{
			if($Statusn=='Total'){
			$rs="UPDATE compo01
				set status_log = 'Total',
				hist_logistica = CASE
								WHEN hist_logistica IS NULL THEN '$Statusn' || '/'
								WHEN hist_logistica IS NOT NULL THEN hist_logistica || '$Statusn' || '/'
								ELSE hist_logistica
								END
			where cve_doc='$doc'";
			}elseif($Statusn=='Parcial'){
			$rs="UPDATE compo01 
				set status_log = 'Parcial', 
				motivo = null,
				hist_logistica = CASE
								WHEN hist_logistica IS NULL THEN '$Statusn' || '/'
								WHEN hist_logistica IS NOT NULL THEN hist_logistica || '$Statusn' || '/'
								ELSE hist_logistica
								END
			where cve_doc='$doc'";
			}elseif ($Statusn=='PNR'){
			$rs="UPDATE compo01 
				set status_log = 'PNR', 
				motivo = null, 
				hist_logistica = CASE
								WHEN hist_logistica IS NULL THEN '$Statusn' || '/'
								WHEN hist_logistica IS NOT NULL THEN hist_logistica || '$Statusn' || '/'
								ELSE hist_logistica
								END
			 where cve_doc='$doc'";
			}elseif ($Statusn=='Tiempo'){
			$rs="UPDATE compo01 
			set status_log='Tiempo', 
			motivo = null, 
			hist_logistica = CASE
								WHEN hist_logistica IS NULL THEN '$Statusn' || '/'
								WHEN hist_logistica IS NOT NULL THEN hist_logistica || '$Statusn' || '/'
								ELSE hist_logistica
								END
			where cve_doc='$doc'";
			}elseif ($Statusn=='Fallido'){
				$rs="UPDATE compo01 
				set status_log='Fallido',
				motivo = null, 
				hist_logistica = CASE
								WHEN hist_logistica IS NULL THEN '$Statusn' || '/'
								WHEN hist_logistica IS NOT NULL THEN hist_logistica || '$Statusn' || '/'
								ELSE hist_logistica
								END
				where cve_doc='$doc'";
			}elseif ($Statusn=='AsignaU' || $Statusn=='Nuevo'){
				$rs="UPDATE compo01 
				set motivo = null, 
				STATUS_LOG = 'Nuevo',  
				UNIDAD = NULL,
				SECUENCIA = NULL, 
				FECHA_SECUENCIA = NULL, 
				IDU = NULL, 
				RUTA = 'N', 
				HORAI = NULL, 
				HORAF = NULL, 
				DOC_SIG = NULL, 
				hist_logistica = CASE
								WHEN hist_logistica IS NULL THEN '$Statusn' || '/'
								WHEN hist_logistica IS NOT NULL THEN hist_logistica || '$Statusn' || '/'
								ELSE hist_logistica
								end
					where cve_doc='$doc'";
			}
		$this->query=$rs;
		$result=$this->EjecutaQuerySimple();
		}
	}

		/*
		$urgente = "SELECT URGENTE from PREOC01 where id = '".$IdPreoco."'";
    	$this->query = $urgente;
    	$result = $this->EjecutaQuerySimple();
    	$row = ibase_fetch_object($result);
    	$urgentes = $row->URGENTE;

    	if ($urgentes == 'U'){
			$esurgente = "UPDATE COMPO01 SET URGENTE = 'U' WHERE CVE_DOC ='".$Doc."'";
    		$this->query = $esurgente;
    		$result = $this->EjecutaQuerySimple(); 
		*/


    function TraeProveedores($prov){
    	$this->query = "SELECT CLAVE, NOMBRE FROM prov01 
    					WHERE nombre CONTAINING '$prov'";
    	$result = $this->QueryDevuelveAutocomplete();
        return $result;
    }

    function TraeClientes2($clie){
    	$this->query = "SELECT CLAVE, NOMBRE FROM clie01 
    					where nombre containing '$clie'";
    	$rs = $this->QueryDevuelveAutocomplete();
    	return $rs;
    }
    
	function TraeProductos($prod){
    	$this->query = "SELECT CVE_ART, DESCR FROM inve01 
    					WHERE DESCR CONTAINING '$prod'";
    	$result = $this->QueryDevuelveAutocompleteP();
        return $result;
    }

    function TraeCveSat($cve){
    	$this->query = "SELECT CVE_PROD_SERV, DESCRIPCION FROM CLAVES_SAT 
    					WHERE (DESCRIPCION CONTAINING '$cve' or PALABRAS_SIMILARES CONTAINING '$cve') 
    						or cve_prod_serv starting with '$cve'";
    	$result = $this->QueryDevuelveAutocompleteC();
        return $result;
    }

    function TraeCliente($clie){
    	$clie = trim($clie);
    	$this->query = "SELECT CLAVE, NOMBRE FROM clie01 
    					where clave_trim = '$clie'";
    	//echo $this->query;
    	$rs=$this->EjecutaQuerySimple();
    	$row=ibase_fetch_object($rs);
    	return $row;	
    }

    /*
    function traeProductosFTC($descripcion){
        $COMPLETO = false;
        if(strpos($descripcion, ' ')){
            $desc2 = explode(' ', $descripcion);
            $contado  = count($desc2);
            for($i = 0; $i < $contado; $i++){
                $COMPLETO = $COMPLETO." AND nombre containing('".$desc2[$i]."') ";
            }
        }else{
            $COMPLETO = " and nombre containing ('".$descripcion."')";
        }
        //$this->query = "INSERT INTO DICCIONARIO (ID, PALABRA)"
        $this->query="SELECT pftc.* FROM producto_ftc pftc left join FTC_Articulos ftca on ftca.id = pftc.clave_ftc where ftca.status = 'A' $COMPLETO";
        //echo $this->query;
        $rs=$this->QueryDevuelveAutocompletePFTC();

        return @$rs;
    }*/
    
	function verRecepciones(){
   	$this->query="SELECT a.*, b.NOMBRE, c.OPERADOR, iif(d.cve_doc is null, a.doc_sig, d.cve_doc) as Recepcion
   				  from compo01 a
   				  left join prov01 b on a.cve_clpv = b.clave
   				  left join unidades c on a.unidad = c.numero  
   				  left join compr01 d on a.doc_sig = d.cve_doc
   				  where (a.status_rec is null or a.status_rec = 'par') 
   				  and (Status_log = 'Total' or Status_log = 'Parcial' or Status_log = 'PNR' or Status_log = 'Fallido' or Status_log = 'fallido') 
   				  and a.fechaelab >= '04/01/2016' 
   				  AND a.STATUS != 'C' 
   				  and (a.status_log2 is null or a.status_log2 = 'R' or a.status_log2  like '%Nuevo/')";
   				  //// modificcion el 22 de Julio "and (a.status_log2 is null or a.status_log2 = 'R' or a.status_log2 ='Nuevo/' )""
   	//echo $this->query;

   	$result=$this->QueryObtieneDatosN();
   	while ($tsArray=ibase_fetch_object($result)){
   		$data[]=$tsArray;
   	}
   	return @$data;
   }

   	/*function verRecepciones(){

   		// VALIDACION INICIAL = 0, VALIDACION INCOMPLETA = 1 VALIDACION COMPLETA = 2
   		$this->query="SELECT r.*, p.nombre
   				from compr01 r
   				left join prov01 p on p.clave = r.cve_clpv 
   				where cve_doc in (SELECT CVE_DOC FROM DOCTOSIGC01  GROUP BY CVE_DOC having max(tip_doc) = 'r' and (min(VALIDACION) = 0 OR min(VALIDACION) = 1) and min(ubica) = 0)";
   		$rs=$this->QueryObtieneDatosN();
   		while($tsArray=ibase_fetch_object($rs)){
   			$data[]=$tsArray;
   		}
   		return $data;
   	}*/


	function RECEP($doc){
		$test="SELECT a.*, b.CAMPLIB2, b.camplib4, c.codigo, c.municipio, c.telefono, c.nombre, d.fechaelab as fechaoc, d.cve_doc as OC
					  FROM COMPR01 a
					  left join compo_clib01 b on a.doc_ant = b.CLAVE_doc
					  left join prov01 c on a.cve_clpv = c.clave
					  left join  compo01 d on a.doc_ant = d.cve_doc
					  where trim(a.cve_doc) = trim('$doc')";
		$this->query=$test;
		$result=$this->QueryObtieneDatosN();
		while($tsArray=ibase_fetch_object($result)){
			$data[]=$tsArray;
		}
		return $data;
	}

	function detalleRECEP($doc){
		$test2="SELECT a.*, b.descr, c.cotiza
					  FROM PAR_COMPR01 a
					  left join inve01 b on a.cve_art = b.cve_art
					  left join preoc01 c on a.id_preoc = c.id
					  where trim(cve_doc) = trim('$doc')";
		
		$this->query=$test2;
		$result=$this->QueryObtieneDatosN();
		while($tsArray=ibase_fetch_object($result)){
			$data[]=$tsArray;
		}
		return $data;
	}
	
	function CotizacionSinCompra(){
		//$hoy = date("d.m.y");
		$this->query="select id, fechasol, cotiza, par, status, prod, nomprod, canti,cant_orig, costo, prove, nom_prov, total,rest,docorigen, urgente, um, datediff(day,fechasol,current_date) as DIAS 
					from preoc01 WHERE status='N' and rest > 0 and rec_faltante > 0 AND fechasol > '29.02.2016' ORDER BY  nom_prov  ASC ";
		$result=$this->QueryObtieneDatosN();
		while($tsArray=ibase_fetch_object($result)){
			$data[]=$tsArray;
		}
		return $data;
	}
	
	function OCSinPago(){
		$hoy = date("d.m.y");
		$this->query= "	SELECT a.cve_doc, b.nombre, a.importe, a.fechaelab, a.fecha_doc, doc_sig as Recepcion, a.enlazado, c.camplib1 as TipoPagoR, c.camplib3 as FER,c.camplib2 as TE, c.camplib4 as Confirmado, a.tp_tes as PagoTesoreria, a.pago_tes, pago_entregado, c.camplib6, a.cve_clpv, a.URGENTE, datediff(day, a.fechaelab, current_date ) as Dias 
						from compo01 a
						left join Prov01 b on a.cve_clpv = b.clave
						LEFT JOIN compo_clib01 c on a.cve_doc = c.clave_doc
						where a.status <> 'C' and  TP_TES is null and fechaelab > '03/14/2016' order by a.fechaelab asc";
		/*"SELECT cve_doc, datediff(day, fecha_doc, date '$hoy') AS dias
						FROM compo01
						WHERE status_pago = 'PP' AND fecha_doc > '15.03.2016'";*/
		$result=$this->QueryObtieneDatosN();
		while($tsArray=ibase_fetch_object($result)){
			$data[]=$tsArray;
		}
		return $data;
	}
	
	function OCSinRuta(){
		//$hoy = date("d.m.y");
		$this->query="SELECT a.cve_doc, b.nombre, a.fecha_pago, a.pago_tes, a.tp_tes, a.pago_entregado, c.camplib2 , a.unidad, a.estado, a.fechaelab, (datediff(day, a.fechaelab, current_date )) as Dias, a.urgencia, b.codigo, b.estado as estadoprov 
					    from compo01 a
						left join prov01 b on a.cve_clpv = b.clave
						left join compo_clib01 c on a.cve_doc = c.clave_doc
						where a.ruta = 'N' and a.doc_sig is null";
		/*"SELECT a.cve_doc, b.nombre, b.estado, b.codigo, a.fecha_doc, datediff(day, a.fecha_doc, date '$hoy') AS dias,
					  a.pago_tes, a.fecha_pago
					  FROM 
					  	compo01 a 
					  	INNER JOIN prov01 b
					  	ON a.cve_clpv = b.clave
					  WHERE a.status_log = 'Nuevo' AND a.fecha_doc > '15.03.2016'";*/
		$result=$this->QueryObtieneDatosN();
		while($tsArray = ibase_fetch_object($result)){
			$data[]=$tsArray;
		}
		return $data;
	}
	
	function OCSinRecepcion(){
		$hoy = date("d.m.y");
		$this->query="SELECT a.cve_doc, b.nombre, b.estado, b.codigo, a.fecha_doc, datediff(day, a.fecha_doc, date '$hoy') AS dias,
							  a.UNIDAD, a.RUTA, c.OPERADOR
							  FROM 
							  	(compo01 a
							  	LEFT JOIN UNIDADES c
								ON a.idu = c.idu) 
							  	LEFT JOIN prov01 b
							  	ON a.cve_clpv = b.clave
							  	WHERE DOC_SIG IS NULL AND fecha_doc > '15.03.2016'";
		$result=$this->QueryObtieneDatosN();
		while($tsArray = ibase_fetch_object($result)){
			$data[] = $tsArray;	
		}
		return $data;
	}

	function ValidarRecepcion($docr){

		$this->query="SELECT a.*, a.cve_doc as RECEPCION, a.doc_ant as OC, b.nombre, c.unidad, d.operador, c.status_log
					  FROM COMPR01 a
					  left join prov01 b on a.cve_clpv = b.clave
					  left join compo01 c on a.cve_doc = c.doc_sig
					  left join unidades d on c.unidad = d.numero
					  where a.cve_doc = '$docr'";
		$result=$this->QueryObtieneDatosN();
		while ($tsArray=ibase_fetch_object($result)){
			$data[]=$tsArray;
		}
		return @$data;
	}

	function PartidasRecep($docr, $doco){
		$tipo = substr($docr, 0,1);
		//echo 'Valor del Tipo: '.$tipo;
		if($tipo == 'F'){
			$a="SELECT a.*, b.descr, a.cant as Cant_oc, b.uni_alt, a.pxr as PXR_OC, 'F' as DOCO, c.cant as CANT
					, a.id_preoc as ID_PREOC, e.fechaelab as fecha_doco, b.cve_art 
				      from par_compo01 a
				      left join Inve01 b on a.cve_art = b.cve_art
				      left join compr01 d on a.cve_doc = d.doc_ant
				      left join par_compr01 c on c.id_preoc = a.id_preoc AND c.cve_doc = d.cve_doc
				      left join compo01 e on a.cve_doc = e.cve_doc
				      where a.cve_doc = '$doco' 
				      and a.status != 'c' 
				      and (a.status_rec is null or a.status_rec = 'f' or a.status_rec = 'p' or a.status_rec = 'par') 
				      and (a.status_log2 ='R' or a.status_log2 is null)";	
		}else{
			$a="SELECT poc.num_par,pr.tot_partida, pr.cant as Cant_oc, i.uni_alt, pr.pxr as PXR_OC, r.cve_doc as DOCO, pr.cant as CANT,
			 			  r.fechaelab, pr.id_preoc as ID_PREOC, r.fechaelab as fecha_doco, i.cve_art, i.descr, oc.cve_doc, pr.pxr, pr.cost
						  FROM par_compr01 pr
						  left join inve01 i on pr.cve_art = i.cve_art 
						  left join compr01 r on r.cve_doc = pr.cve_doc
						  left join compo01 oc on r.doc_ant = oc.cve_doc
						  left join par_compo01 poc on poc.cve_doc = r.doc_ant and poc.id_Preoc = pr.id_Preoc 
						  where trim(pr.cve_doc) = trim('$docr') 
						  and (poc.status_log2 is null or poc.status_log2 = 'R')";
		}
		$this->query=$a;

		//echo $this->query;
		
	    $result=$this->QueryObtieneDatosN();
	    while ($tsArray=ibase_fetch_object($result)){
	    	$data[]=$tsArray;
	    }
	    return @$data;
	}
 

	function PartidasNoRecep($docr, $doco){
		$c="SELECT a.*, b.descr, b.uni_alt, e.cant_rec as L, e.cost_rec as J, d.doc_sig, iif(a.saldo is null, 0, a.saldo) as SALDO
				      from par_compo01 a
				      left join Inve01 b on a.cve_art = b.cve_art
				      left join compo01 d on a.cve_doc = d.cve_doc
				      left join compr01 c on d.cve_doc = c.doc_ant 
				      left join par_compr01 e on c.cve_doc = e.cve_doc and a.id_preoc = e.id_preoc
				      where a.cve_doc = '$doco' and (a.status_rec is not null)";
				      //echo $this->query;
	    $this->query=$c;
	    $result=$this->QueryObtieneDatosN();
	    while ($tsArray=ibase_fetch_object($result)){
	    	$data[]=$tsArray;
	    }
	    return @$data;
	}

	function ActCantParRecep($docr, $doco, $cantn, $coston, $cantorig, $costoorig, $idpreoc){
		$actcant = "UPDATE par_compr01 set cant = $cantn where cve_doc = '$docr'  and id_preoc = '$idpreoc'";
		$this->query=$actcant;
		$result = $this->EjecutaQuerySimple();
	}
//// Revisarar para que sirve esta funcion y de donde viene.

	function ActPXR($docr, $doco, $cantn, $coston, $cantorig, $costoorig, $idpreoc){
		$pxr = "SELECT pxr from par_compo01 where cve_doc = '$doco' and id_preoc = idpreoc";
		$this->query=$pxr;
		$result=$this->EjecutaQuerySimple();
		$row=ibase_fetch_object($result);
		$pxroc = $row->$PXR; 

		if ($cantn > $cantorig){
			$cantfinal = $cantn - $cantorig;
			$pxrfinal = $pxroc - $cantfinal;
			$actpxr="UPDATE par_comoo01 set pxr = '$pxrfinal' where cve_doc = '$doco' and id_preoc = $idPreoc";	
		}else{
			$cantfinal = $cantorig - $cantn;
			$pxrfinal = $pxroc + $cantfinal;
			$actpxr="UPDATE par_compo01 set pxr = $pxrfinal where cve_doc = '$doco' and id_preoc = $idpreoc";
		}
		$this->query=$actpxr;
		$result=$this->EjecutaQuerySimple();
	}

	
	function VerNoSuministrableC(){
		$hoy = date("d.m.y");
			$this->query = "select id, fechasol, cotiza, par, status, prod, nomprod, canti, cant_orig, costo, prove, nom_prov, total,rest,docorigen, urgente, um, datediff(day,fechasol,date '$hoy') as DIAS 
								from preoc01 WHERE status='S' and rest > 0 and rec_faltante > 0 AND OBS IS NULL ";
		$result = $this->QueryObtieneDatosN();
			while ($tsArray = ibase_fetch_object($result)){ 
					$data[] = $tsArray;		
		}
		return $data;
	}
	
	function VerNoSuministrableCMotivo(){
		$hoy = date("d.m.y");
			$this->query = "select id, fechasol, cotiza, par, status, prod, nomprod, canti,cant_orig, costo, prove, nom_prov, total,rest,docorigen, urgente, um, datediff(day,fechasol,date '$hoy') as DIAS, obs
								from preoc01 WHERE status='S' and rest > 0 and rec_faltante > 0 AND OBS IS NOT NULL ORDER BY  nom_prov  ASC ";
		$result = $this->EjecutaQuerySimple();
		if($this->NumRows($result) > 0){
			while ( $tsArray = $this->FetchAs($result) ) 
					$data[] = $tsArray;			
		
				return $data;
		}
		
		return $result;
		
	}
	
	
	
	function MotivoNoSuministrable($id,$motivo){
		$this->query = "UPDATE PREOC01 SET OBS = '$motivo' WHERE id = '$id'";
		$resultado = $this->EjecutaQuerySimple();
		return $resultado;
	}
		
	function VerNoSuministrableV(){
		$numeroletras = $_SESSION['user']->NUMERO_LETRAS;
		$letra1 = $_SESSION['user']->LETRA;
		$letra2 = $_SESSION['user']->LETRA2;
		$letra3 = $_SESSION['user']->LETRA3;
		$letra4 = $_SESSION['user']->LETRA4;
		$letra5 = $_SESSION['user']->LETRA5;
		switch ($numeroletras){
			
			case 1:
					 $this->query = "select id, fechasol, cotiza, par, status, prod, nomprod, canti,cant_orig, costo, prove, nom_prov, total,rest,docorigen, urgente, um, datediff(day,fechasol,current_date) as DIAS, OBS
								from preoc01 WHERE status='S' and rest > 0 and rec_faltante > 0 AND OBS IS NOT NULL AND LETRA_V IN ('$letra1') ORDER BY  nom_prov  ASC ";
				break;
				
			case 2:
					$this->query = "select id, fechasol, cotiza, par, status, prod, nomprod, canti,cant_orig, costo, prove, nom_prov, total,rest,docorigen, urgente, um, datediff(day,fechasol,current_date) as DIAS, OBS
								from preoc01 WHERE status='S' and rest > 0 and rec_faltante > 0 AND OBS IS NOT NULL 
								AND LETRA_V IN ('$letra1','$letra2') ORDER BY  nom_prov  ASC ";
				break;
						
			case 3:
					$this->query = "select id, fechasol, cotiza, par, status, prod, nomprod, canti,cant_orig, costo, prove, nom_prov, total,rest,docorigen, urgente, um, datediff(day,fechasol,current_date) as DIAS, OBS
								from preoc01 WHERE status='S' and rest > 0 and rec_faltante > 0 AND OBS IS NOT NULL 
								AND LETRA_V IN ('$letra1','$letra2','$letra3') ORDER BY  nom_prov  ASC ";
				break;
			
			case 4:
					$this->query = "select id, fechasol, cotiza, par, status, prod, nomprod, canti,cant_orig, costo, prove, nom_prov, total,rest,docorigen, urgente, um, datediff(day,fechasol,current_date) as DIAS, OBS
								from preoc01 WHERE status='S' and rest > 0 and rec_faltante > 0 AND OBS IS NOT NULL 
								AND LETRA_V IN ('$letra1','$letra2','$letra3','$letra4') ORDER BY  nom_prov  ASC ";
				break;	

			case 5:
					$this->query = "select id, fechasol, cotiza, par, status, prod, nomprod, canti,cant_orig, costo, prove, nom_prov, total,rest,docorigen, urgente, um, datediff(day,fechasol,current_date) as DIAS, OBS
								from preoc01 WHERE status='S' and rest > 0 and rec_faltante > 0 AND OBS IS NOT NULL 
								AND LETRA_V IN ('$letra1','$letra2','$letra3','$letra4','$letra5') ORDER BY  nom_prov  ASC ";
				break;
			
			case 6:
					$this->query = "select id, fechasol, cotiza, par, status, prod, nomprod, canti,cant_orig, costo, prove, nom_prov, total,rest,docorigen, urgente, um, datediff(day,fechasol,current_date) as DIAS, OBS
								from preoc01 WHERE status='S' and rest > 0 and rec_faltante > 0 AND OBS IS NOT NULL 
								AND LETRA_V IN ('$letra1','$letra2','$letra3','$letra4','$letra5','$letra6') ORDER BY  nom_prov  ASC ";
				break;
				
			case 99:
					$this->query = "select id, fechasol, cotiza, par, status, prod, nomprod, canti,cant_orig, costo, prove, nom_prov, total,rest,docorigen, urgente, um, datediff(day,fechasol,current_date) as DIAS, OBS
								from preoc01 WHERE status='S' and rest > 0 and rec_faltante > 0 AND OBS IS NOT NULL ORDER BY  nom_prov  ASC ";
				break;
				
			default:
				berak;
		}
		$result=$this->QueryObtieneDatosN();
		while($tsArray = ibase_fetch_object($result)){
			$data[] = $tsArray;	
		}
		return $data;
	}
	
	function StatusNoSuministrableV($id,$status){
		$this->query = "UPDATE PREOC01 SET status = '$status' WHERE id = '$id'";
		$resultado = $this->EjecutaQuerySimple();
		return $resultado;
	}
	

	///// Cuando se actuliza el Costo pero la cantidad es la misma.

	function ActRecCosto($docr, $doco, $cantn, $coston, $cantorig, $costoorig, $idpreoc){
		$subtot="SELECT sum(tot_partida) as TOTAL, sum(totimp4) as TOTALIVA from par_compr01 where trim(cve_doc) = trim('".$docr."')";
		//echo $subtot;
		$this->query=$subtot;
		$result=$this->EjecutaQuerySimple();
		$row=ibase_fetch_row($result);
		//print $row[0];
		//print $row[1];
		$t=$row[0];
		$TotalIVA=$row[1];
		$SubTotal = $t - $TotalIVA; 
		return $result;
	}


	function ActStatusParRec($docr, $doco, $cantn, $coston, $cantorig, $costoorig, $idpreoc){
		$actpar= "UPDATE par_compr01 set status_rec = 'CCo' where cve_doc = '$docr' and Id_Preoc = '$idpreoc'";
		$this->query=$actpar;
		$result=$this->EjecutaQuerySimple();
		return $result;
	}

	function ActCostoPar($docr, $doco, $cantn, $coston, $cantorig, $costoorig, $idpreoc){

		$consulta= "UPDATE PAR_COMPR01 SET cost = ('$coston'*'$cantn'), TOTIMP4 = (('$coston'*'$cantn') * 0.16), TOT_PARTIDA = (('$coston'*'$cantn') * 1.16)

					WHERE ID_PREOC = '$IDPREOC'";	

		$this->query = $consulta;

		$result=$this->EjecutaQuerySimple();

	}



//// Cuando Atualiza Cantidad y Costo

	function ActRecCCx($docr, $doco, $cantn, $coston, $cantorig, $costoorig, $idpreoc){
		$subtot="SELECT sum(tot_part) as TOTAL , sum(tot_imp4) as TOTALIVA from par_compr01 where cve_doc = '".$docr."'";
		$this->query=$subtot;
		$result-> $this->EjecutaQuerySimple();
		$row = ibase_fetch_object($result);
		$Total= $row-> $TOTAL;
		$TotalIVA=$row->$TOTALIVA;
		$SubTotal = $TOTALIVA - $TOTAL; 

		/*$ActDoc= "UPDATE compr01 set CAN_TOT = $SubTotal, IMPORTE = $Total, IMP_TOT4 = $TotalIVA where CVE_DOC = '$docr'";
		$this->query=$ActDoc;
		$result=$this->EjecutaQuerySimple();
		return $result;*/
	}

    

/// actuaiza es estatus de recepcion.


	function ActRecepOk($docr, $doco, $cantn, $coston, $cantorig, $costoorig, $idpreoc,$idordencompra,$par, $fechadoco, $descripcion,$cveart, $fval, $desc1, $desc2, $desc3){
		$usuario=$_SESSION['user']->NOMBRE;
				
		$a="INSERT INTO VALIDA_RECEPCION (DOCUMENTO, ID_PREOC, PRODUCTO, DESCRIPCION, PARTIDA, FECHA_DOC,FECHA_VAL, CANT_ORIGINAL, CANT_VALIDADA, CANT_ACUMULADA, COSTO_ORIGINAL, COSTO_VALIDADO, SERIE, APLICADO, IMPRESO, USUARIO, FOLIO_VAL, DESC1 ,DESC2, DESC3)
			VALUES ('$doco',$idpreoc,'$cveart',
					iif('$cveart' starting with ('PGS'), (select nombre from producto_ftc where clave = '$cveart'), (select camplib7 from inve_clib01 where cve_prod = '$cveart')),
					$par,'$fechadoco', current_timestamp, '$cantorig', '$cantn', 0, $costoorig, $coston, 'RV', 'No', 'No', '$usuario', $fval, $desc1 , $desc2, $desc3)";	

					//echo $a;
					//break;
		$this->query=$a;
		$result=$this->EjecutaQuerySimple();
		//echo $a;
		//break;
		$b="SELECT SUM(CANT_VALIDADA) AS ACUMULADO, MAX(ID) AS MID FROM VALIDA_RECEPCION WHERE id_preoc = $idpreoc group by id_preoc";
		$this->query=$b;
		$result=$this->EjecutaQuerySimple();
		$row=ibase_fetch_object($result);
		$acumulado = $row->ACUMULADO;
		$id = $row->MID;
		//echo $id;
		//break;
		$c="UPDATE VALIDA_RECEPCION SET CANT_ACUMULADA = $acumulado where id = $id";
		$this->query=$c;
		$result = $this->EjecutaQuerySimple();

		$d="UPDATE PREOC01 SET RECEPCION = iif(recepcion = 0, $acumulado, recepcion + $cantn), rec_faltante = cant_orig - iif(recepcion = 0, $acumulado, recepcion + $cantn) where id = $idpreoc";

		$this->query=$d;
		$result=$this->EjecutaQuerySimple();

		$e="UPDATE VALIDA_RECEPCION SET APLICADO = 'Si' WHERE id = $id";
		$this->query=$e;
		$result=$this->EjecutaQuerySimple();

		$f="SELECT DOCUMENTO, SUM(CANT_VALIDADA) as cantval, MAX(PARTIDA) AS PARTIDA, MAX(ID_PREOC) AS ID_PREOC  FROM VALIDA_RECEPCION  WHERE documento = '$doco' and PARTIDA = $par and id_preoc= $idpreoc GROUP BY DOCUMENTO";
		$this->query=$f;
	
		$result=$this->EjecutaQuerySimple();
		$row=ibase_fetch_object($result);
		$oc=$row->DOCUMENTO;
		$cantval=$row->CANTVAL;
		$partida=$row->PARTIDA;
		$idpreoc=$row->ID_PREOC;

		$g="UPDATE par_compo01 set pxr = cant - $cantval, status_rec = iif((cant - $cantval)= 0, 'ok', 'par' ), doc_recep = iif(doc_recep is null, 'f', doc_recep), doc_recep_status = iif(doc_recep_status is null, 'f', doc_recep_status), cant_rec = iif(cant_rec is null, $cantn, cant_rec + $cantn),status_log2 = iif((cant - $cantval) = 0, 'T', 'Suministros'), cost_rec = $coston, saldo =tot_partida - ($coston * $cantn), folio_falso = 'No' where cve_doc = '$oc' and num_par = $partida and id_preoc = $idpreoc";
		//echo $g;
		//break;
		$this->query = $g;
		$result=$this->EjecutaQuerySimple();


		$partidas="SELECT count(num_par) as PARTIDAS from par_compo01 where cve_doc = '$doco' and status_rec = 'ok'";
		$this->query=$partidas;
		$rspoc=$this->EjecutaQuerySimple();
		$row=ibase_fetch_row($rspoc);
		$paroc=$row[0];
		//echo $partidas;
		//echo "Este es el total de partidad comprobadas: ".$paroc;

		$part="SELECT count(num_par) as PARTOT FROM PAR_COMPO01 WHERE CVE_DOC = '$doco'";
		$this->query=$part;
		$rspocr=$this->EjecutaQuerySimple();
		$row2=ibase_fetch_object($rspocr);
		$partot= $row2->PARTOT;
		//echo " Total de las partidas del Documento: ".$partot;

		if ($partot == $paroc){
			$actrecep_status = "UPDATE compo01 set status_rec = 'OK' where cve_doc = '$doco'";
		}else{
			$actrecep_status = "UPDATE compo01 set status_rec = 'par', status_log2 = 'Suministros' where cve_doc = '$doco'";
		}
			$this->query=$actrecep_status;
			$result=$this->EjecutaQuerySimple();
		//	echo $actrecep_status;
		///// hasta aqui es codigo nuevo.
		///Se define si se visualiza en el area de imprimir comprbante.
		$partidasrec="SELECT count(num_par) as PARTIDAS from par_compr01 where trim(cve_doc) = trim('$docr') and status_rec is not null";
		$this->query=$partidasrec;
		$rsprec=$this->EjecutaQuerySimple();
		$row5=ibase_fetch_row($rsprec);
		$parrec=$row5[0];
		//echo $partidasrec;
		//echo "Este es el total de partidad comprobadas: ".$parrec;
		$partrec="SELECT max(num_par) as PARTOT FROM PAR_COMPR01 WHERE Trim(CVE_DOC) = Trim('$docr')";
		$this->query=$partrec;
		$rsprecr=$this->EjecutaQuerySimple();
		$row6=ibase_fetch_object($rsprecr);
		$partotrec= $row6->PARTOT;
		//echo " Total de las partidas del Documento: ".$partotrec;

		if ($partotrec == $parrec){
			$actrecep_status_rec = "UPDATE compr01 set status_rec = 'ok' where trim(cve_doc) = trim('$docr')";
			$this->query=$actrecep_status_rec;
			$result=$this->EjecutaQuerySimple();
		//	echo $actrecep_status_rec;
		}	

			/*
			//// Inicia la actualizacion del Pedido para validar si se puede preparar.

				$b="SELECT max(par) as PAR from preoc01 where cotiza = '$doc' group by cotiza";
				$this->query=$b;
				$result=$this->QueryObtieneDatosN();
				$row = ibase_fetch_object($result);
				$partidas=$row->PAR;

				$c="SELECT iif(count(id)= 0, 0,count(id)) as PARPEND from preoc01 where emp_status = 'pendiente' and cotiza = '$doc' group by cotiza";
				$this->query= $c;
				$result = $this->QueryObtieneDatosN();
				$row = ibase_fetch_object($result);
				@$parpen = $row->PARPEND;


				$d="SELECT iif(count(id) is null, 0, count(id)) as PARPAR from preoc01 where emp_status = 'parcial' and cotiza = '$doc' group by cotiza";
				$this->query= $d;
				$result = $this->QueryObtieneDatosN();
				$row = ibase_fetch_object($result);
				@$parpar = $row->PARPAR;

				if ($parpen == $partidas){
					$update= "UPDATE FACTP01 SET EMP_STATUS='pendiente' where cve_doc = '$doc'";
				}elseif ($partidas == $parcom){
					$update= "UPDATE FACTP01 SET EMP_STATUS='completo' where cve_doc = '$doc'";
				}elseif($partidas == $parpar){
					$update= "UPDATE FACTP01 SET EMP_STATUS='parcial' where cve_doc = '$doc'";	
				}else{
					$update= "UPDATE FACTP01 SET EMP_STATUS='eparcial' where cve_doc = '$doc'";
				}
				$this->query=$update;
				$result = $this->EjecutaQuerySimple();

		*/
		return $result;


	}


	//function verRecepcion(){
    //	$this->query="SELECT a.*, b.NOMBRE, c.OPERADOR, d.cve_doc as Recepcion
    //				  from compo01 a
    //				  left join prov01 b on a.cve_clpv = b.clave
    //				  left join unidades c on a.unidad = c.numero  
    //				  left join compr01 d on a.doc_sig = d.cve_doc
    //				  where (Status_log = 'Total' or Status_log = 'Parcial' or Status_log = 'PNR') and a.status_rec is null ";
//
//    //	$result=$this->QueryObtieneDatosN();
//    //	while ($tsArray=ibase_fetch_object($result)){
//    //		$data[]=$tsArray;
//    //	}
//    //	return $data;
    //}

    function verRecepcion($idr){
    	$this->query="SELECT * FROM FTC_DETALLE_RECEPCIONES F left join PREOC01 P ON F.IDPREOC  = P.ID WHERE ID_RECEPCION = $idr";
    	$res=$this->EjecutaQuerySimple();
    	while ($tsArray = ibase_fetch_object($res)){
    		$data[]=$tsArray;
    	}
    	return $data;
    }
	
	function StatusNoSuministrable($id){
		$this->query = "UPDATE PREOC01 
						SET 
							status = 'S', 
							MOTIVOS_NOSUMINISTRABLE = IIF(MOTIVOS_NOSUMINISTRABLE IS NULL, OBS, MOTIVOS_NOSUMINISTRABLE || '/' || OBS),
							OBS = NULL
						 WHERE id = '$id'";
		$resultado = $this->EjecutaQuerySimple();
		return $resultado;
	}


	function verRecepV(){
    	$recepv="SELECT a.*, b.nombre, c.cve_doc as OC, d.numero, c.unidad, d.operador
    	         from compr01 a
    	         left join prov01 b on a.cve_clpv = b.clave
    	         left join compo01 c on a.doc_ant = c.cve_doc
    	         left join unidades d on c.unidad = d.numero 
    	         where a.status_rec is not null";
    	$this->query=$recepv;
    	$result=$this->QueryObtieneDatosN();
    	while($tsArray = ibase_fetch_object($result)){
			$data[] = $tsArray;	
		}
		return $data;
    }

    function ConsultaPagadas(){
        /*$this->query ="SELECT recepciones.CVE_DOC AS recepcion,ordenes.CVE_DOC AS orden, proveedor.nombre AS proveedor,
    					recepciones.importe,recepciones.folio,ordenes.STATUS_PAGO
    					FROM
        					(compr01 recepciones
       						 INNER JOIN prov01 proveedor
       						 ON proveedor.clave = recepciones.cve_clpv)
     					   	INNER JOIN compo01 ordenes
        					ON recepciones.doc_ant = ordenes.cve_doc
    						WHERE ordenes.status_pago = 'PP'";
		*/
    	$this->query ="SELECT recepciones.CVE_DOC AS recepcion,ordenes.CVE_DOC AS orden, proveedor.nombre AS proveedor,
    					recepciones.importe,recepciones.folio,ordenes.STATUS_PAGO
    					FROM
        					(compr01 recepciones
       						 INNER JOIN prov01 proveedor
       						 ON proveedor.clave = recepciones.cve_clpv)
     					   	INNER JOIN compo01 ordenes
        					ON recepciones.doc_ant = ordenes.cve_doc
    						WHERE recepciones.status_rec is not null";
        $result = $this->QueryObtieneDatosN();
        while ($tsArray = ibase_fetch_object($result)){
                $data[] = $tsArray;
        }
            return $data;
    }

    function ActRecepNo($docr, $doco, $cantn, $coston, $cantorig, $costoorig, $idpreoc){

        $dif = $cantorig;
		//echo "Esta es la diferencia : ".$dif;
			/// Obtener los pendientes por recibir actuales:
		$pxra="SELECT pxr from par_compo01 where cve_doc = '$doco' and id_preoc = '$idpreoc'";
		$this->query=$pxra;
		$respxr=$this->EjecutaQuerySimple();
		$row4= ibase_fetch_object($respxr);
		$pxrnow=$row4->PXR;
		$npxr = $pxrnow + $dif;
		//echo "Obtener el pendiente por recibir actual: ".$pxra;
		//echo "Esta es la diferecia : ".$dif;
		//echo "Este es el nuevo pendiente por recibir : ".$npxr;
		$actdif="UPDATE par_compo01 set pxr = $npxr where trim(cve_doc) = trim('$doco') and id_preoc = '$idpreoc'";
		$this->query=$actdif;
		$result=$this->EjecutaQuerySimple();
		//echo "Cosnulta para actualizar el PXR : ".$actdif;
		//// Actualiza los estatus de recepcion de partidas. 
		$recepo="UPDATE par_compo01 set status_rec = 'ko' where cve_doc = '$doco' and id_preoc = $idpreoc";
		$recepr="UPDATE par_compr01 set status_rec = 'ko' where cve_doc = '$docr' and id_preoc = $idpreoc";
		$this->query=$recepo;
		$result=$this->EjecutaQuerySimple();
		$this->query=$recepr;
		$result=$this->EjecutaQuerySimple();
        //// Actualiza las cantidades recibidas y los costos recibidos.
        $costtp=$cantn * $coston;
        $actparr="UPDATE par_compr01 set cant_rec = 0, cost_rec = 0 where cve_doc = '$docr' and id_preoc = $idpreoc";
        $this->query=$actparr;
        $result=$this->EjecutaQuerySimple();
        /// ACTUALIZA NUEVOS TOTALES 
            /// Obtenemos el costo todal del documento a la fecha.
        $costotot = "SELECT SUM(iif(cost_rec is null, 0, cost_rec)) FROM PAR_COMPR01 WHERE TRIM(CVE_DOC) = TRIM('$docr') and status_rec is not null";
        $this->query=$costotot;
        $rct=$this->EjecutaQuerySimple();
        $row3=ibase_fetch_row($rct);
        $nct=$row3[0];
        //echo "Este es el nuevo costo: ".$nct;
        $actcostdoc="UPDATE compr01 set Cost_rec = $nct where TRIM(cve_doc) = Trim('$docr')";
        $this->query=$actcostdoc;
		$result=$this->EjecutaQuerySimple();
		//echo "Actualiza Totales : ".$actcostdoc;
		////Se define si el documento de Orde de compra se vuelve a mostrar para su validacion de partidas restantes.
		$partidas="SELECT count(num_par) as PARTIDAS from par_compo01 where cve_doc = '$doco' and status_rec is not null";
		$this->query=$partidas;
		$rspoc=$this->EjecutaQuerySimple();
		$row=ibase_fetch_row($rspoc);
		$paroc=$row[0];
		//echo $partidas;
		//echo "Este es el total de partidad comprobadas: ".$paroc;
		$part="SELECT max(num_par) as PARTOT FROM PAR_COMPO01 WHERE CVE_DOC = '$doco'";
		$this->query=$part;
		$rspocr=$this->EjecutaQuerySimple();
		$row2=ibase_fetch_object($rspocr);
		$partot= $row2->PARTOT;
		//echo " Total de las partidas del Documento: ".$partot;
		if ($partot == $paroc){
			$actrecep_status = "UPDATE compo01 set status_rec = 'OK' where cve_doc = '$doco'";
			$this->query=$actrecep_status;
			$result=$this->EjecutaQuerySimple();
		//	echo $actrecep_status;
		}

		///Se define si se visualiza en el area de imprimir comprbante.

		$partidasrec="SELECT count(num_par) as PARTIDAS from par_compr01 where trim(cve_doc) = trim('$docr') and status_rec is not null";
		$this->query=$partidasrec;
		$rsprec=$this->EjecutaQuerySimple();
		$row5=ibase_fetch_row($rsprec);
		$parrec=$row5[0];
		//echo $partidasrec;
		//echo "Este es el total de partidad comprobadas: ".$parrec;

		$partrec="SELECT max(num_par) as PARTOT FROM PAR_COMPR01 WHERE Trim(CVE_DOC) = Trim('$docr')";
		$this->query=$partrec;
		$rsprecr=$this->EjecutaQuerySimple();
		$row6=ibase_fetch_object($rsprecr);
		$partotrec= $row6->PARTOT;
		//echo " Total de las partidas del Documento: ".$partotrec;

		if ($partotrec == $parrec){
			$actrecep_status_rec = "UPDATE compr01 set status_rec = 'ok' where trim(cve_doc) = trim('$docr')";
			$this->query=$actrecep_status_rec;
			$result=$this->EjecutaQuerySimple();
		//	echo $actrecep_status_rec;
		}


	}
  

/***
     * cfa: 210316
     * consulta todas las cotizaciones registradas en la aplicación. Esta consulta es preparada para mostrar el grid 
     * en la pantalla de p.cotizacion.php
    ***/

    function consultarCotizaciones($cerradas=false){
        $usuario = $_SESSION['user']->USER_LOGIN;
        $this->query = "SELECT CDFOLIO as folio, CVE_CLIENTE as cliente, NOMBRE, RFC, IDPEDIDO, INSTATUS as estatus, EXTRACT(DAY FROM DTFECREG) || '/' || EXTRACT(MONTH FROM DTFECREG) || '/' || EXTRACT(YEAR FROM DTFECREG) AS FECHA 
            FROM FTC_COTIZACION A INNER JOIN CLIE01 B 
              ON TRIM(A.CVE_CLIENTE) = TRIM(B.CLAVE) 
            WHERE CDUSUARI = '$usuario'";        
        $cerradas?$this->query.=" AND upper(INSTATUS) <> upper('PENDIENTE') ":$this->query.=" AND upper(INSTATUS) = upper('PENDIENTE') ";
        $this->query.=" ORDER BY CDFOLIO";
        $result = $this->QueryObtieneDatosN();
        while ($tsArray = ibase_fetch_object($result)){
                $data[] = $tsArray;
        }
        return $data;
    }    

    function cabeceraCotizacion($folio) {
        $this->query = "SELECT CDFOLIO, CVE_CLIENTE, NOMBRE, RFC, INSTATUS, DSIDEDOC, IDPEDIDO, EXTRACT(DAY FROM DTFECREG) || '/' || EXTRACT(MONTH FROM DTFECREG) || '/' || EXTRACT(YEAR FROM DTFECREG) AS FECHA,
                                DSPLANTA, DSENTREG, DBIMPSUB, DBIMPIMP, DBIMPTOT 
                          FROM FTC_COTIZACION A INNER JOIN CLIE01 B 
                            ON TRIM(A.CVE_CLIENTE) = TRIM(B.CLAVE)
                        WHERE CDFOLIO = '$folio'";
        $result = $this->QueryObtieneDatosN();
        while ($tsArray = ibase_fetch_object($result)){
                $data[] = $tsArray;
        }
        return $data;
    }

    function detalleCotizacion($folio) {
        $this->query = "SELECT CDFOLIO, A.CVE_ART, DESCR, FLCANTID, DBIMPCOS, DBIMPPRE, DBIMPDES  
                          FROM FTC_COTIZACION_DETALLE A 
                        INNER JOIN INVE01 B
                          ON A.CVE_ART = B.CVE_ART
                        WHERE CDFOLIO = '$folio'";
        $result = $this->QueryObtieneDatosN();
        $data = array();
        while ($tsArray = ibase_fetch_object($result)){
                $data[] = $tsArray;
        }
        return $data;
    }

    function listaArticulos($cliente, $articulo, $descripcion){
        $data = array();        
        if($articulo!=''){
            $this->query = "SELECT A.CVE_ART, DESCRIPCION, COSTO, PRECIO 
                              FROM FTC_Articulos A INNER JOIN PRECIO_X_PROD01 B
                                ON A.CVE_ART = B.CVE_ART 
                                AND A.CVE_ART = '".$articulo."'
                                AND CVE_PRECIO = (SELECT LISTA_PREC FROM CLIE01 WHERE TRIM(CLAVE) = '".$cliente."')";        
        } elseif($descripcion!=''){
            $this->query = "SELECT A.CVE_ART, DESCRIPCION, COSTO, PRECIO 
                              FROM FTC_Articulos A INNER JOIN PRECIO_X_PROD01 B
                                ON A.CVE_ART = B.CVE_ART 
                                AND upper(DESCRIPCION) LIKE upper('%".$descripcion."%')
                                AND CVE_PRECIO = (SELECT LISTA_PREC FROM CLIE01 WHERE TRIM(CLAVE) = '".$cliente."')";        
        } else {
            return $data;
        }
        
        $result = $this->QueryObtieneDatosN();
        while ($tsArray = ibase_fetch_object($result)){
                $data[] = $tsArray;
        }
        return $data;
    }
    
    function actualizaTotales($folio){
        $this->query = "SELECT FLCANTID, DBIMPPRE, DBIMPDES FROM FTC_COTIZACION_DETALLE WHERE CDFOLIO = $folio";
        $result = $this->QueryObtieneDatosN();
        $data = array();
        while ($tsArray = ibase_fetch_object($result)){
            $data[] = $tsArray;
        }
        $subtotal = 0;
        $impuesto = 0;
        $descuento = 0;
        $total = 0;        
        if(count($data)>0){            
            foreach ($data as $row){
                $cantidad = $row->FLCANTID;
                $precio = $row->DBIMPPRE;
                $descuentoPartida = $row->DBIMPDES;
                $subtotalPartida = round($cantidad * $precio, 2) - round($cantidad * $descuentoPartida, 2);
                //echo "Subtotal Partida: $subtotalPartida <br />";
                $subtotal += $subtotalPartida;                
                $descuento+= $descuentoPartida;
                //echo "Subtotal: $subtotal <br />";
            }
            $descuento = round($descuento, 2);
            $impuesto = round(($subtotal * 0.16), 2);
            //echo "Impuesto: $impuesto <br />";
            $total = round(($subtotal + $impuesto), 2);                    
            //echo "Total: $total <br />";
        } 
        $this->query = "UPDATE FTC_COTIZACION SET DBIMPSUB = $subtotal, DBIMPIMP = $impuesto, DBIMPTOT = $total, DBIMPDES = $descuento "
                . " WHERE CDFOLIO = $folio";
        
        $rs = $this->EjecutaQuerySimple();
        return $rs;
    }
    
    function insertaCotizacion($cliente, $identificadorDocumento){
        $folio = 1;
        $this->query = "SELECT MAX(cdfolio)+1 folio FROM FTC_COTIZACION";
        $result = $this->QueryObtieneDatosN();
        $data = array();
        while ($tsArray = ibase_fetch_object($result)){
            $data[] = $tsArray;
        }
        if(count($data)>0){            
            foreach ($data as $row){
                $folio = $row->FOLIO;
            }
        }        
        $usuario = $_SESSION['user']->USER_LOGIN;
        $this->query = "INSERT INTO FTC_COTIZACION (CDFOLIO, CVE_CLIENTE, DSIDEDOC, DTFECREG, INSTATUS, DBIMPSUB, DBIMPIMP, DBIMPTOT, DSPLANTA, DSENTREG, CDUSUARI) "
                . "VALUES ($folio, TRIM('$cliente'), '$identificadorDocumento', CAST('Now' as date),'PENDIENTE',0,0,0,(SELECT COALESCE(CAMPLIB7, '') FROM CLIE_CLIB01 WHERE TRIM(CVE_CLIE) = TRIM('$cliente')),(SELECT COALESCE(CAMPLIB8, '') FROM CLIE_CLIB01 WHERE TRIM(CVE_CLIE) = TRIM('$cliente')),'$usuario')";        
        
        $rs = $this->EjecutaQuerySimple();
        return $rs;
        
    }
    
    function avanzaCotizacion($folio){
        $this->generaDocumentoCotizacion($folio);
        
        $this->query = "UPDATE FTC_COTIZACION SET INSTATUS = 'CERRADA' WHERE CDFOLIO = $folio";
        //echo "<br />query: ".$this->query;
        $rs = $this->EjecutaQuerySimple();
        return $rs;
    }
    
    function generaDocumentoCotizacion($folio) {
        $this->query = "SELECT CDFOLIO, CVE_CLIENTE, DSIDEDOC, IDPEDIDO, DBIMPSUB, DBIMPIMP, DBIMPTOT, DBIMPDES FROM FTC_COTIZACION WHERE CDFOLIO = $folio";
        $result = $this->QueryObtieneDatosN();
        $data = array();
        while ($tsArray = ibase_fetch_object($result)){
            $data[] = $tsArray;
        }
        $existeFolio = false;
        if(count($data)>0){  
            $existeFolio =true;
            foreach ($data as $row){
                $folio = $row->CDFOLIO;
                $cliente = $row->CVE_CLIENTE;
                $letra = $row->DSIDEDOC;
                $pedido = $row->IDPEDIDO;
                $subtotal = $row->DBIMPSUB;
                $impuesto = $row->DBIMPIMP;
                $total = $row->DBIMPTOT;
                $descuento = $row->DBIMPDES;
            }
        }
        $serie = 'C'.substr($letra,1);
        //echo "serie: $serie";
        if(!$existeFolio){
            return NULL;
        } else {
            $usuario = $_SESSION['user']->USER_LOGIN;
            $consecutivo = $this->obtieneConsecutivoClaveDocumento($serie);
            $cve_doc = $letra.$consecutivo;
        }
        
        $insert = "INSERT INTO FACTC01 ";
        $insert.="(TIP_DOC, CVE_DOC, CVE_CLPV, STATUS, CVE_PEDI, FECHA_DOC, FECHA_ENT, CAN_TOT, IMP_TOT1, IMP_TOT2, IMP_TOT3, IMP_TOT4, DES_TOT, DES_FIN, IMPORTE, CVE_OBS, NUM_ALMA, ACT_COI, NUM_MONED, TIPCAMB, ENLAZADO, TIP_DOC_E, NUM_PAGOS, FECHAELAB, SERIE, FOLIO, CTLPOL, ESCFD, CONTADO, BLOQ, DES_FIN_PORC, DES_TOT_PORC, TIP_DOC_ANT, DOC_ANT, TIP_DOC_SIG, DOC_SIG, FORMAENVIO, REALIZA)";
        $insert.="VALUES";
        $insert.="('C' ,'$cve_doc', (SELECT CLAVE FROM CLIE01 WHERE TRIM(CLAVE) = TRIM('$cliente')), 'O' , '$pedido' , CAST('Now' as date), CAST('Now' as date), $subtotal, 0, 0, 0 , $impuesto, $descuento, 0, $total, 0, 9, 'N', 1, 1, 'O', 'O',NULL, CAST('Now' as date),'$serie', $consecutivo, 0, 'N', 'N', 'N', 0 , 0, '', '',  '', '', '', '$usuario')";
         //echo "insert: ".$insert;
        $this->query = $insert;
        $rs = $this->EjecutaQuerySimple();
         
        $this->query = "SELECT CVE_ART, DBIMPCOS, FLCANTID, DBIMPPRE, DBIMPDES FROM FTC_COTIZACION_DETALLE WHERE CDFOLIO = $folio";
        $result = $this->QueryObtieneDatosN();
        $data = array();
        while ($tsArray = ibase_fetch_object($result)){
            $data[] = $tsArray;
        }
        if(count($data)>0){            
            foreach ($data as $row){
                $cve_art = $row->CVE_ART;
                $costo = $row->DBIMPCOS;
                $cantidad = $row->FLCANTID;
                $precio = $row->DBIMPPRE;
                $descuentoPartida = $row->DBIMPDES;
                $subtotalPartida = round($cantidad * $precio, 2) - round($cantidad * $descuentoPartida, 2);
                //echo "Subtotal Partida: $subtotalPartida <br />";
                $subtotal += $subtotalPartida;                
                $descuento+= $descuentoPartida;
                //echo "Subtotal: $subtotal <br />";
                $actualiza = "INSERT INTO PAR_FACTC01 
                (CVE_DOC, NUM_PAR, CVE_ART,CANT, PREC, COST, IMPU1,IMPU2, IMPU3, IMPU4, IMP1APLA, IMP2APLA, IMP3APLA, IMP4APLA,TOTIMP1, TOTIMP2,TOTIMP3,TOTIMP4,DESC1,ACT_INV, TIP_CAM, UNI_VENTA,TIPO_ELEM, TIPO_PROD, CVE_OBS, E_LTPD, NUM_ALM, NUM_MOV, TOT_PARTIDA, USUARIO_PHP) 
                VALUES
                ('$cve_doc',(SELECT COALESCE(MAX(NUM_PAR), 0) FROM PAR_FACTC01) + 1,'$cve_art',$cantidad,$precio,$costo,0,0,0,16,0,0,0,0,0,0,0,$impuesto,$descuento,'N',1,(SELECT UNI_MED FROM INVE01 WHERE CVE_ART = '$cve_art'),'P','P',0,0,9,NULL,($subtotalPartida),'$usuario')";
                //echo "<br />UPDATE: ".$actualiza;
                $this->query = $actualiza;
                $rs = $this->EjecutaQuerySimple();
            }
        }
        return $rs;
         
    }
        
    function obtieneConsecutivoClaveDocumento($letra){
        $this->query = "SELECT COALESCE(MAX(FOLIO), 1)+1 FOLIO FROM FACTC01 WHERE TIP_DOC = 'C' AND SERIE = '$letra'";        
        $result = $this->QueryObtieneDatosN();
        //echo "query: ".$this->query;
        $data = array();
        while ($tsArray = ibase_fetch_object($result)){
            $data[] = $tsArray;
        }
        $consecutivo = 1;
        if(count($data)>0){            
           foreach ($data as $row){
                $consecutivo = $row->FOLIO;
            } 
        }
        //echo "consecutivo : $consecutivo";
        return $consecutivo;
    }
    
    function actualizaPedidoCotizacion($folio, $pedido) {
        $this->query = "UPDATE FTC_COTIZACION SET IDPEDIDO = '$pedido' WHERE CDFOLIO = $folio";
        $rs = $this->EjecutaQuerySimple();
        return $rs;
    }
            
    function cancelaCotizacion($folio){
        $this->query = "UPDATE FTC_COTIZACION SET INSTATUS = 'CANCELADA' WHERE CDFOLIO = $folio";        
        $rs = $this->EjecutaQuerySimple();
        return $rs;
    }
    
    function quitarCotizacionPartida($folio, $partida) {
        $this->query = "DELETE FROM FTC_COTIZACION_DETALLE WHERE CDFOLIO = $folio AND CVE_ART = '$partida'";        
        $rs = $this->EjecutaQuerySimple();
        $this->actualizaTotales($folio);
        return $rs;
    }
    
    function actualizaCotizacion($folio, $partida, $articulo, $precio, $descuento, $cantidad){
        if($partida!=''){
            $this->query = "UPDATE FTC_COTIZACION_DETALLE SET "
                    . " CVE_ART = '$articulo', FLCANTID = $cantidad, DBIMPCOS = (SELECT MAX(costo) FROM PRVPROD01 A WHERE A.CVE_ART = '$articulo' GROUP BY cve_art), DBIMPPRE = $precio, DBIMPDES = $descuento "
                    . " WHERE CDFOLIO = '$folio' AND CVE_ART = '$partida'";
        } else {
            $this->query = "INSERT INTO FTC_COTIZACION_DETALLE "
                    . "(CDFOLIO,CVE_ART,FLCANTID,DBIMPPRE,DBIMPCOS,DBIMPDES)"
                    . "VALUES ('$folio','$articulo',$cantidad,$precio,(SELECT MAX(costo) FROM PRVPROD01 A WHERE A.CVE_ART = '$articulo' GROUP BY cve_art), $descuento)";
        }        
        $rs = $this->EjecutaQuerySimple();
        $this->actualizaTotales($folio);
        return $rs;        
    }
    
    function autocompletaArticulo($descripcion) {
        $this->query="SELECT DESC FROM INVE01 WHERE DESC LIKE '$descripcion%'";
        $result = $this->QueryObtieneDatosN();
        $data = array();
        while ($tsArray = ibase_fetch_object($result)){
                $data[] = $tsArray->descripcion;
        }        
        $json = json_encode($data);
        return $json;
    }
    
    function listadoClientes($clave, $cliente){
        $data = array();
        $usuario = $_SESSION['user']->USER_LOGIN;
        $select_letras = ", (SELECT COALESCE(LETRA, '') || ',' || COALESCE(LETRA2, '') || ',' || COALESCE(LETRA3, '') || ',' || COALESCE(LETRA4, '') || ',' || COALESCE(LETRA5, '') LETRAS ";
        $select_letras.= " FROM PG_USERS ";
        $select_letras.= " WHERE USER_LOGIN = '$usuario') letras";
        if($clave!=''){
            $this->query = "SELECT TRIM(CLAVE) CLAVE, STATUS, NOMBRE, RFC ".$select_letras." FROM CLIE01 WHERE STATUS <> 'S' AND TRIM(CLAVE) = '$clave'";
        } elseif($cliente!=''){
            $this->query = "SELECT TRIM(CLAVE) CLAVE, STATUS, NOMBRE, RFC ".$select_letras." FROM CLIE01 WHERE upper(NOMBRE) LIKE upper('%$cliente%') AND STATUS <> 'S'";
        } else {
            return $data;
        }
        $result = $this->QueryObtieneDatosN();  
        
        while ($tsArray = ibase_fetch_object($result)){
            $data[] = $tsArray;
        }
        return $data;
    }

    function listadoLetras() {
        $usuario = $_SESSION['user'];
        $this->query = "SELECT COALESCE(LETRA, '') || ',' || COALESCE(LETRA2, '') || ',' || COALESCE(LETRA3, '') || ',' || COALESCE(LETRA4, '') || ',' || COALESCE(LETRA5, '') LETRAS";
        $this->query .= " FROM PG_USERS ";
        $this->query .= " WHERE USER_LOGIN = '$usuario'";
        $data = array();
        $result = $this->QueryObtieneDatosN();        
        while ($tsArray = ibase_fetch_object($result)){
            $data[] = $tsArray;
        }
        $letras = "";
        if(count($data)>0){            
            foreach ($data as $row){
                $letras = $row->LETRAS;
            }
        } 
        $myArray = explode(',', $letras);
        print_r($myArray);
        return $myArray;
    }
    
////// FINALIZA COTIZACION CFA- 
    
///// Modulo de productos almacen 10.
    function VerCat10($alm){
    	$prod="SELECT * from PRODUCTOS WHERE ACTIVO = 'S'";
    	$this->query=$prod;
    	$result=$this->QueryObtieneDatosN();
    	while ($tsArray=ibase_fetch_object($result)){
    		$data[]=$tsArray;
    	}
    	return $data;
    }

    function ARutaEntrega(){
    	$data=array();
		$entrega="SELECT iif(a.docs is null, 'No', a.docs) as DOCS, a.*, c.nombre, c.estado, c.codigo, b.fechaelab, (datediff(day, a.fecha_creacion, current_date)) as DIAS, a.Factura as Factura, e.cve_doc as remisiondoc 
		          from CAJAS a
		          LEFT JOIN FACTP01 d ON a.cve_fact = d.cve_doc
		          LEFT JOIN FACTF01 b ON a.factura = b.cve_doc
		          LEFT JOIN CLIE01 c ON d.cve_clpv = c.clave
		          LEFT JOIN FACTR01 e on a.remision = e.cve_doc 
		          where a.ruta = 'N' AND (a.STATUS = 'cerrado' OR a.STATUS = 'PENDIENTE')
		          and fecha_creacion >='01.01.2018'
		          and (factura is not null or remision is not null) and status_recepcion = 0";
		$this->query=$entrega;
		$result = $this->QueryObtieneDatosN();
		while ($tsArray=ibase_fetch_object($result)){
			$data[]=$tsArray;
		}
		return $data;
	}

	function FacturaSinMaterial(){
		$SinMaterial="SELECT a.*, (datediff(day, fechaelab, current_date )) as Dias, b.*
					  FROM FACTF01 a
					  left join CLIE01 b on a.cve_clpv = b.clave
				      WHERE STATUS_MAT IS NULL";
	    $this->query=$SinMaterial;
	    $result = $this->QueryObtieneDatosN();
	    while ($tsArray=ibase_fetch_object($result)){
	    	$data[]=$tsArray;
	    }
	    return $data;
	}

	function FacturasSinMat($docf){
		$data = array();
		$SinMaterial="SELECT a.*, (datediff(day, fechaelab, current_date )) as Dias, b.*
					  FROM FACTP01 a
					  left join CLIE01 b on a.cve_clpv = b.clave
				      WHERE cve_doc = '$docf'";
				      //echo $SinMaterial;
	    $this->query=$SinMaterial;
	    $result = $this->QueryObtieneDatosN();
	    while ($tsArray=ibase_fetch_object($result)){
	    	$data[]=$tsArray;
	    }			
	    return $data;
	}

	function ParFactMaterialPar($docf){     //26072016 correccion a la consulta
		$parfact="SELECT * FROM PAQUETES WHERE (EMBALADO IS NULL OR EMBALADO ='S') AND DOCUMENTO = '$docf'";
		$this->query=$parfact;
		$result=$this->QueryObtieneDatosN();
		while($tsArray=ibase_fetch_object($result)){
			$data[]=$tsArray;
		}
		return @$data;
	}

	function ParFactMaterial($docf){
		/*$parmat="SELECT a.*, iif(pftc.nombre is null,c.descr, pftc.nombre) as CAMPLIB7, c.uni_med, d.recepcion, d.rec_faltante
		         FROM PAR_FACTP01 a
		         left join inve01 c on a.cve_art = c.cve_art
		         left join producto_ftc pftc on pftc.clave = a.cve_art
		         left join preoc01 d on a.id_preoc = d.id
		         WHERE (STATUS_MAT <> 'OK' OR STATUS_MAT IS NULL) AND CVE_DOC = '$docf'";
		$this->query=$parmat;
		$result=$this->QueryObtieneDatosN();
		*/
		$this->query="SELECT * FROM PREOC01 WHERE RECEPCION > EMPACADO AND COTIZA = '$docf'";
		$result=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($result)){
			$data[]=$tsArray;
		}
	
		return @$data;
	}
    
	function EditProd($id){
    $this->query="SELECT a.*, b.NOMBRE AS proveedor from PRODUCTOS a LEFT JOIN Prov01 b ON a.PROV1 = b.CLAVE where a.id =$id";
    $result=$this->QueryObtieneDatosN();
    while ($tsArray=ibase_fetch_object($result)){
    $data[]=$tsArray;
    }
    return $data;
    }

    function AltaProductos($clave,$descripcion,$marca1,$categoria,$desc1,$desc2,$desc3,$desc4,$desc5,$iva,$costo_total,$clave_prov,$codigo_prov1,$costo_prov1,$prov2,$codigo_prov2,$costo_prov2,$unidadcompra,$factorcompra,$unidadventa,$factorventa){
		$this->query="EXECUTE PROCEDURE sp_producto_nuevo
                        ('$clave','$descripcion','$marca1','$categoria','$desc1','$desc2','$desc3','$desc4','$desc5','$iva','$costo_total','".rtrim($clave_prov)."','$codigo_prov1','$costo_prov1','$prov2','$codigo_prov2','$costo_prov2','$unidadcompra','$factorcompra','$unidadventa','$factorventa')";
                
		$rs = $this->EjecutaQuerySimple();
		return $rs;	
	}

	function ActualizaProductos($id,$clave,$descripcion,$marca1,$categoria,$desc1,$desc2,$desc3,$desc4,$desc5,$iva,$costo_total,$clave_prov,$codigo_prov1,$costo_prov1,$prov2,$codigo_prov2,$costo_prov2,$unidadcompra,$factorcompra,$unidadventa,$factorventa,$activo){
				$this->query=" EXECUTE PROCEDURE sp_modifica_producto
                                             ('$id','$clave','$descripcion','$marca1','$categoria',$desc1,$desc2,$desc3,$desc4,$desc5,$iva,$costo_total,'".rtrim($clave_prov)."','$codigo_prov1',$costo_prov1,'$prov2','$codigo_prov2',$costo_prov2,'$unidadcompra',$factorcompra,'$unidadventa',$factorventa,'$activo')"; 
		$rs = $this->EjecutaQuerySimple();
		return $rs;	
	}
	
	
	function DatosPreorden($id){
		$this->query = "SELECT a.ID, a.PROD, a.COTIZA, a.PAR, a.NOMPROD, a.CANTI, a.COSTO,a.PROVE, a.NOM_PROV, a.OBS, a.MOTIVOS_NOSUMINISTRABLE, b.CAMPLIB1 AS MARCA, c.PREC AS PRECIO
						FROM (PREOC01 a
						LEFT JOIN par_factp01 c 
						ON c.CVE_DOC = a.COTIZA AND c.NUM_PAR = a.PAR)
						LEFT JOIN INVE_CLIB01 b
						ON a.PROD = b.CVE_PROD
						WHERE ID = '$id'";
		
		$result = $this->QueryObtieneDatosN();
		while($tsArray = ibase_fetch_object($result)){
			$data[] = $tsArray; 
		}
		return $data;
	}
	
/*	function UpdateParFactP($cotizacion,$partida){
		$this->query = "UPDATE PAR_FACTP01 SET PXS = 0, STATUS_PRE = 'M' WHERE  CVE_DOC = '$cotizacion' AND NUM_PAR = '$partida'";
		$resultado = $this->EjecutaQuerySimple();
		return $resultado;
	} */
	
	function UpdatePreoc($idPreorden,$motivo,$costo,$claveproveedor,$nombreproveedor){
		$prove = rtrim($claveproveedor);
		$nomprov = trim($nombreproveedor);
		$this->query = "UPDATE PREOC01 
						SET STATUS = 'N', 
							OBS = 'Ventas Modifica: ' || '$motivo',
							COSTO = '$costo',
							TOTAL = (CANTI * $costo),
							PROVE = '$prove',
							NOM_PROV = '$nomprov'
						 WHERE  ID = '$idPreorden'";
		$resultado = $this->EjecutaQuerySimple();
		return $resultado;
	}
	
	
	 function RegistroOperadores($docu,$unidad){
		$this->query = "SELECT * FROM ftc_poc a WHERE a.OC = '$docu'";				
		$result = $this->QueryObtieneDatosN();
		$compo;
		while($tsArray = ibase_fetch_row($result)){
			$compo=$tsArray;
		}		
		$this->query = "SELECT OPERADOR FROM UNIDADES WHERE NUMERO = '$unidad'";				
		$resultado = $this->QueryObtieneDatosN();
		$uni;
		while($TsArray = ibase_fetch_row($resultado)){
			$uni=$TsArray;
		}
		$this->query = "INSERT INTO REGISTRO_OPERADORES(OPERADOR,FECHAASIG,UNIDAD,DOCUMENTO,FECHADOC,URGENCIA,CITA,TIPO,FORMAPAGO,FOLIO_FP,RESULTADO)
			VALUES('$uni[0]',CURRENT_DATE,'$unidad','$docu','$compo[3]','','$compo[18]','R','$compo[22]','$compo[22]','secuencia')";
		$rs = $this->EjecutaQuerySimple();

		return $rs;	
	} 
	 
	function ActRecepRO($idordencompra,$congruencia){
		$this->query ="UPDATE REGISTRO_OPERADORES SET ESTVSREAL = '$congruencia' WHERE DOCUMENTO = '$idordencompra'";
		$resultado = $this->EjecutaQuerySimple();
		return $resultado;
	}	


	function ActEmpaque($idpreoc, $empaque, $idcaja, $tipopaq, $docf){
		//// Cambios para facturacion directa OFA 12-03-2018 ///
		$usuario=$_SESSION['user']->NOMBRE;
		$this->query="SELECT * FROM PREOC01 WHERE ID = $idpreoc";
		$res =$this->EjecutaQuerySimple();
		$row = ibase_fetch_object($res);
		$empacado = $row->EMPACADO;
		$recibido = $row->RECEPCION;
		echo 'Empacado: '.$empacado.' , Recibido: '.$recibido;
		if(($recibido - $empacado) > 0){
			$this->query = "INSERT INTO CONTROL_FACT_REM (ID, COTIZACION, PARTIDA, CANTIDAD, PRODUCTO, CAJA, IDPREOC, STATUS, PXF, USUARIO , FECHA, FECHA_FACT_REM, FACTURAS, REMISIONES, caja_original)
								values (null, (select cve_fact from cajas where id = $idcaja), (select par from preoc01 where id = $idpreoc), (select recepcion - empacado from preoc01 where id = $idpreoc), (select prod from preoc01 where id = $idpreoc ), $idcaja, $idpreoc, 'Nuevo',(select recepcion - empacado from preoc01 where id = $idpreoc), '$usuario', CURRENT_TIMESTAMP, NULL, NULL, NULL, $idcaja)";
			$this->grabaBD();
			//echo 'Consulra de insercion en control factura '.$this->query.'<br/>';
			$emp="INSERT INTO PAQUETES (DOCUMENTO, ARTICULO, PARTIDA, DESCRIPCION, CANTIDAD, FECHA_PAQUETE, EMPAQUE,  STATUS_LOG, ID_PREOC, TIPO_EMPAQUE, BASE_TIPO, CONSECUTIVO_TIPO, PAQUETE, FECHA_EMPAQUE, IDCAJA, usuario_paquete, caja_original) 
		      VALUES ((select cve_fact from cajas where id = $idcaja), (select prod from preoc01 where id = $idpreoc ),(select par from preoc01 where id = $idpreoc), (select nomprod from PREOC01 where id=$idpreoc), (select recepcion - empacado from preoc01 where id = $idpreoc), current_date, $empaque, 'nuevo', $idpreoc, '$tipopaq', 0, 0, 1, current_timestamp, $idcaja, '$usuario', $idcaja)";
			$this->query=$emp;
			$result=$this->grabaBD();
			
			$this->query="UPDATE preoc01 set empacado = recepcion where id = $idpreoc";
			$result=$this->queryActualiza();
			
			$mensaje = "Listo para facturara";
			
			
		}else{
			$mensaje = "Ya procesado";
		}
		echo $mensaje;
		//break; 
		return $mensaje;
	}

	function paquetes($docf , $idcaja){
		$usuario = $_SESSION['user']->NOMBRE;
		$this->query="SELECT * FROM PAQUETES PQ LEFT JOIN PREOC01 P ON P.ID = PQ.ID_PREOC WHERE idcaja = $idcaja";
		$rs = $this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($rs)) {
			$data[]=$tsArray;
		}
		return @$data;
	}

	//// Tiene que actualizar el dumento para que ya no se muestre en la pantalla para actualizar empaque
	function ActEmpaqueDoc($idpreoc, $empaque, $idcaja, $tipopaq){
		//$pedido=strpos($docf, 'P');
		//$tabla= 'PAR_FACTP01';
		//$tabla2= 'FACTF01';
		//if($pedido !== false){ 
			$tabla='PAR_FACTP01';
			$tabla2='FACTP01';
		//}		
		$part = "SELECT MAX (NUM_PAR) as PARTIDAS FROM $tabla WHERE CVE_DOC = '$docf'";
		$this->query=$part;
		$result=$this->QueryObtieneDatosN();
		$row=ibase_fetch_object($result);
		$partmax=$row->PARTIDAS;

		$partok = "SELECT COUNT(cve_doc) as PARTOK FROM $tabla WHERE CVE_DOC = '$docf' and STATUS_MAT = 'OK'";
		$this->query=$partok;
		$result=$this->QueryObtieneDatosN();
		$row=ibase_fetch_object($result);
		$partidasok=$row->PARTOK;

		if ($partidasok == $partmax){
			$actdoc="UPDATE $tabla2 SET STATUS_MAT = 'COM' WHERE CVE_DOC = '$docf'";
			$this->query=$actdoc;
			$result=$this->EjecutaQuerySimple();
			return $result;
		}
	}	

	function verPaquetes(){
		$paq="SELECT DOCUMENTO, MAX(EMPAQUE) AS PAQUETE, MAX(FECHA_PAQUETE) AS FECHA FROM PAQUETES WHERE STATUS_LOG='nuevo' group by DOCUMENTO";
		$this->query=$paq;
		$result=$this->QueryObtieneDatosN();
		//echo $paq;
		while ($tsArray=ibase_fetch_object($result)){
			$data[]=$tsArray;
		}
		return $data;
	}

	function verPaquetesEmb($docf){     //23062016
		//$paq="SELECT * from PAQUETES WHERE embalado is null and DOCUMENTO = '$docf' ";
		$this->query="SELECT TIPO_ENVIO,DOCUMENTO, IDCAJA, FECHA_PAQUETE, EMPAQUE, TIPO_EMPAQUE
                                from PAQUETES WHERE embalado is null and DOCUMENTO = '$docf'
                                group by  TIPO_ENVIO,DOCUMENTO, IDCAJA, FECHA_PAQUETE, EMPAQUE, TIPO_EMPAQUE";
		$result=$this->QueryObtieneDatosN();
		//echo $this->query;
		//break;
		while ($tsArray=ibase_fetch_object($result)){
			$data[]=$tsArray;
		}
		return @$data;
	}

	function verDetallePaq($docf){      //23062016
            		$this->query="SELECT ID_PREOC, TIPO_ENVIO,DOCUMENTO, IDCAJA, FECHA_PAQUETE, EMPAQUE,ARTICULO,DESCRIPCION, CANTIDAD
                                        from PAQUETES WHERE embalado is null and DOCUMENTO = '$docf'";
		$result=$this->QueryObtieneDatosN();
		//echo $this->query;
		while ($tsArray=ibase_fetch_object($result)){
			$data[]=$tsArray;
		}
		return $data;
    }
        
	function verCajasAbiertas(){
		$a="SELECT a.id, CVE_FACT as CVE_FACT, c.nombre as NOMBRE, '' as PAQUETE, fecha_creacion as FECHA_CREACION, iif(factura ='', remision, factura) as factura, iif((select fechaelab from factf01 where cve_doc = factura ) is null,(select fechaelab from factr01 where cve_doc = remision), (select fechaelab from factf01 where cve_doc = factura )) as fecha_fact, embalaje 
			FROM CAJAS a
			LEFT JOIN FACTP01 b on a.cve_fact = b.cve_doc
			LEFT JOIN CLIE01 c on b.cve_clpv = c.clave
			WHERE a.STATUS = 'abierto' and (a.embalaje != 'TOTAL' or a.embalaje is null) and fecha_creacion >= '16.03.2018'";
		$this->query=$a;

		$result=$this->QueryObtieneDatosN();
		//echo $paq;
		while ($tsArray=ibase_fetch_object($result)){
			$data[]=$tsArray;
		}
		return $data;
	}

	function AsignaEmbalaje($docf,$paquete1, $paquete2, $tipo, $peso, $alto, $largo, $ancho, $pesovol, $idc, $idemp){       //23062016
		$a="UPDATE PAQUETES SET PAQUETE1=$paquete1, PAQUETE2 = $paquete2, PESO= $peso, LARGO=$largo, ANCHO=$ancho, ALTO=$alto, PESO_VOLUMETRICO=$pesovol, embalado = 'S', fecha_embalaje = current_timestamp where documento = '$docf' and idcaja = $idc and tipo_empaque = '$tipo' AND EMPAQUE = $idemp ";
		$this->query=$a;
		$this->EjecutaQuerySimple();
		$this->query="SELECT PARTIDA, cantidad FROM PAQUETES WHERE  documento = '$docf' and idcaja = $idc and tipo_empaque = '$tipo' AND EMPAQUE = $idemp";
		$res=$this->EjecutaQuerySimple();
		while($tsArray=ibase_fetch_object($res)){
			$data[]=$tsArray;
		}
		foreach ($data as $key) {
			$partida = $key->PARTIDA;
			$cantidad = $key->CANTIDAD;
			$this->query="UPDATE FACTP01 SET ENLAZADO = 'O' WHERE CVE_DOC = '$docf'";
			$this->EjecutaQuerySimple();
			$this->query="UPDATE PAR_FACTP01 SET PXS = PXS + $cantidad  WHERE CVE_DOC = '$docf' and num_par = $partida";
			$this->EjecutaQuerySimple();
		}
		//$result=$this->EjecutaQuerySimple();
		$c="SELECT DOCUMENTO, COUNT(PARTIDA) PARTOT, SUM(PESO) AS PESO FROM PAQUETES WHERE documento = '$docf' AND EMBALADO = 'S' GROUP BY DOCUMENTO";
		$this->query=$c;
		$result=$this->QueryObtieneDatosN();
		$row=ibase_fetch_object($result);
		$parf=$row->PARTOT;
		$peso=$row->PESO;
		$d="SELECT COUNT(PARTIDA) PARTOTP FROM PAQUETES WHERE documento = '$docf'";
		$this->query=$d;
		$result=$this->QueryObtieneDatosN();
		$row=ibase_fetch_object($result);
		$parr=$row->PARTOTP;

		if($parr == $parf){
			$e="UPDATE cajas set EMBALAJE = 'TOTAL', peso = $peso where cve_fact='$docf' AND ID = $idc";
			$this->query=$e;
			$result=$this->EjecutaQuerySimple();
			return $result;
		}
		return $result;
	}

	function embalados($docf, $caja){
		$b="SELECT * FROM PAQUETES WHERE idcaja = $caja and EMBALADO='S'";
		$this->query=$b;
		//echo $b;
		$result=$this->QueryObtieneDatosN();
		while ($tsArray=ibase_fetch_object($result)){
			$data[]=$tsArray;
		}
		return @$data;
	}

	function DataCaja($caja){
		$c="SELECT * FROM Cajas WHERE ID = '$caja'";
	    $this->query=$c;
		$resultado = $this->QueryObtieneDatosN();
		while($tsArray = ibase_fetch_object($resultado)){
			$data[] = $tsArray;
		}
		return $data;
	}

	function embaladosTotales($docf, $caja){
		$d="SELECT documento, count(partida) as partidas, sum(cantidad) as cantidades, sum (peso) as PESO 
		 from paquetes 
		 where documento = '$doc' and idcaja = $caja group by documento";
		 echo $d;
		$this->query=$d;
		$result=$this->QueryObtieneDatosN();
		while($tsArray=ibase_fetch_object($result)){
			$data[]=$tsArray;
		}
		return $data; 
	}


	function CajasXFactura($docf){
		$this->query="SELECT * FROM Cajas WHERE CVE_FACT = '$docf'";
		$resultado = $this->QueryObtieneDatosN();
		while($tsArray = ibase_fetch_object($resultado)){
			$data[] = $tsArray;
		}
		return $data;
	}
        

	function DataFactCaja($docf){
			$a="SELECT CVE_DOC FROM FACTP01 WHERE CVE_DOC = '$docf' GROUP BY CVE_DOC";
			$this->query=$a;
			$result=$this->QueryObtieneDatosN();
			while($tsArray=ibase_fetch_object($result)){
				$data[]=$tsArray;
			}
		return @$data;
	}

function NuevaCaja($facturanuevacaja){
		$usuario = $_SESSION['user']->USER_LOGIN;
		//// Algoritmo para validar la caja antes de la creacion.
		$this->query = "SELECT iif(COUNT(STATUS) is null , 0, count(status)) AS CAJAS FROM CAJAS
    				WHERE STATUS = 'abierto' 
    				AND CVE_FACT='$facturanuevacaja'";
   		$resultado = $this->EjecutaQuerySimple();
		$row=ibase_fetch_object($resultado);
		$cajas = $row->CAJAS;
		//echo 'Valor de cajas antes: '.$cajas.'<br/>';
		if($cajas == 0){
			$this->query="SELECT SUM(recepcion) as recibido, sum(empacado) as empacado FROM PREOC01 where cotiza = '$facturanuevacaja'";
			$res=$this->EjecutaQuerySimple();
			$row2=ibase_fetch_object($res);
			$rec = $row2->RECIBIDO;
			$emp = $row2->EMPACADO;
			echo 'Recibido: '.$rec.'<br/>';
			echo 'Empacado: '.$emp.'<br/>';
			if( $rec-$emp <= 0 ){
				$cajas = 1;
			}	
		}
		//echo $cajas.'<br/>';
		if($cajas == 0){
			$a="SELECT MAX(ENVIO) as envio , MAX(REV_DOSPASOS) as rev_dospasos, MAX(CLIEN) AS CLIEN FROM preoc01 where cotiza = '$facturanuevacaja'";

			$this->query = $a;
			$result=$this->EjecutaQuerySimple();
			$row = ibase_fetch_object($result);
			$envio =$row->ENVIO;
			$revdp =$row->REV_DOSPASOS;
			$cliente=$row->CLIEN;

			$b="SELECT CARTERA_REVISION, CARTERA_COBRANZA, dias_revision, DIAS_PAGO FROM CARTERA WHERE TRIM(IDCLIENTE) = TRIM($cliente)";
			$this->query=$b;
			$result=$this->EjecutaQuerySimple();
			$row=ibase_fetch_object($result);
			$cr = $row->CARTERA_REVISION;
			$cc = $row->CARTERA_COBRANZA;
			$dr = $row->DIAS_REVISION;
			$dp = $row->DIAS_PAGO;

			$c="SELECT iif(max(CVE_DOC) is null, '',max(CVE_DOC)) AS FACTURA FROM FACTF01 WHERE DOC_ANT = '$facturanuevacaja' and idc is null ";
			$this->query = $c;
			$result=$this->EjecutaQuerySimple();
			$row=ibase_fetch_object($result);
			$factura=$row->FACTURA;
			$d="SELECT iif(max(CVE_DOC) is null, '',max(CVE_DOC)) AS REMISION FROM FACTR01 WHERE DOC_ANT = '$facturanuevacaja' and idc is null";
			$this->query=$d;
			$result=$this->EjecutaQuerySimple();
			$row=ibase_fetch_object($result);
			$remision=$row->REMISION;

			$vcaja="SELECT COUNT(STATUS) as STATUS
						FROM CAJAS
	    				WHERE (STATUS = 'abierto' or ( STATUS='cerrado' and  FACTURA= '' and REMISION= '')) 
	    				AND CVE_FACT = '$facturanuevacaja'";
	    	$this->query=$vcaja;
	    	$rs=$this->EjecutaQuerySimple();
	    	$row=ibase_fetch_object($rs);
	    	$val=$row->STATUS;

	    	if($val== 0){
			$this->query="INSERT INTO CAJAS (FECHA_CREACION,STATUS,CVE_FACT, FACTURA, REMISION, envio, rev_dospasos, usuario_caja, cr, dias_revision, cc, dias_pago, IMP_COMP_REENRUTAR)
						  VALUES(current_timestamp,'abierto','$facturanuevacaja', '$factura','$remision', '$envio', '$revdp', '$usuario','$cr', '$dr', '$cc','$dp', 'Nu')";
			//echo $this->query;
			$this->grabaBD();
			$this->query="SELECT MAX(ID) AS ID  FROM CAJAS";
			$res=$this->EjecutaQuerySimple();
			$c=ibase_fetch_object($res);
			return $caja = $c->ID;
			}	
		}else{
			$resultado = "<script>alert('No se logro crear la caja, revise la informacion');</script>";
		}
		return $resultado;
	}

	function ValidaCajasAbiertas($facturanuevacaja){
		$this->query = "SELECT COUNT(STATUS) AS CAJAS FROM CAJAS
    				WHERE STATUS = 'abierto' 
    				AND CVE_FACT='$facturanuevacaja'";
   		$resultado = $this->EjecutaQuerySimple();
		$row=ibase_fetch_object($resultado);
		$cajas = $row->CAJAS;
		//echo 'Valor de cajas antes: '.$cajas.'<br/>';
		if($cajas == 0){
			$this->query="SELECT SUM(recepcion) as recibido, sum(empacado) as empacado FROM PREOC01 where cotiza = '$facturanuevacaja'";
			$res=$this->EjecutaQuerySimple();
			$row2=ibase_fetch_object($res);
			$rec = $row2->RECIBIDO;
			$emp = $row2->EMPACADO;
			
			if( $rec-$emp <= 0 ){
				$cajas = 1;
			}	
		}
		//echo 'Valor de cajas, despues : '.$cajas.'<br/>';
		return $cajas;
	}

	function ConsultaRO($buscar){
		//var_dump($buscar);
		$this->query = "SELECT a.*, c.nombre AS PROVEEDOR
						FROM REGISTRO_OPERADORES a 
						LEFT JOIN (COMPO01 b
						LEFT JOIN PROV01 c ON b.cve_clpv = c.CLAVE) 
						ON a.documento = b.CVE_DOC 
						WHERE 
						 a.DOCUMENTO = '$buscar' OR a.OPERADOR CONTAINING '$buscar' OR a.UNIDAD = '$buscar' ";
		$resultado = $this->QueryObtieneDatosN();
		while($tsArray = ibase_fetch_object($resultado)){
			$data[] = $tsArray;
		}
		//var_dump($data);
		return @$data;
	}
	
	function CabeceraConsultaRO($buscar){
		$this->query = "SELECT FIRST 1 ID, OPERADOR, UNIDAD FROM REGISTRO_OPERADORES WHERE DOCUMENTO = '$buscar' OR OPERADOR CONTAINING '$buscar' OR UNIDAD = '$buscar'
						GROUP BY ID,OPERADOR,UNIDAD ORDER BY ID ASC";
		$resultado = $this->QueryObtieneDatosN();
		while($tsArray = ibase_fetch_row($resultado)){
			$data[] = $tsArray;
		}
		//var_dump($data);
		return @$data;
	}

	function RutasDelDia(){
		$this->query="SELECT a.cve_doc, b.nombre, a.fecha_pago, a.pago_tes, a.tp_tes, a.pago_entregado, c.camplib2 , a.unidad, a.estado, a.fechaelab, (datediff(day, a.fechaelab, current_date )) as Dias, a.urgencia, b.codigo, b.estado as estadoprov, a.unidad
					    from compo01 a
						left join prov01 b on a.cve_clpv = b.clave
						left join compo_clib01 c on a.cve_doc = c.clave_doc
						where a.ruta = 'A' AND idu IS NOT NULL AND STATUS_LOG = 'secuencia' 
						AND  FECHA_SECUENCIA >= dateadd(-1 day to current_date)";
		$resultado = $this->QueryObtieneDatosN();
		while($tsArray = ibase_fetch_object($resultado)){
			$data[] = $tsArray;
		}
		return $data;
	}

	function RutasDelDiaEntrega(){
		$a="SELECT a.*, c.nombre, c.estado, c.codigo, b.fechaelab, b.cita, b.importe, (datediff(day,b.fechaelab,CURRENT_DATE)) as Dias 
		    FROM CAJAS a
			LEFT JOIN FACTF01 b on a.cve_fact = b.cve_doc
			LEFT JOIN CLIE01 c on b.cve_clpv = c.clave
			where UNIDAD is not null  ";
		$this->query=$a;
		$result=$this->QueryObtieneDatosN();
		while($tsArray=ibase_fetch_object($result)){
			$data[]=$tsArray;
		}
		return $data;
	}


	function DataRecepcionesAC(){
    	$this->query="SELECT a.*, b.NOMBRE AS PROVEEDOR, c.OPERADOR, c.NUMERO AS UNIDAD, d.FECHA_SECUENCIA, d.STATUS_LOG
    				  from compr01 a
    				  left join prov01 b on a.cve_clpv = b.clave 
    				  left join compo01 d on a.doc_ant = d.cve_doc
    				  left join unidades c on d.unidad = c.numero 
    				  where a.status <> 'C' AND  (a.status_rec <> 'ok' OR a.status_rec is null)";

    	$result=$this->QueryObtieneDatosN();
    	while ($tsArray=ibase_fetch_object($result)){
    		$data[]=$tsArray;
    	}
    	return $data;
    }

	 function DataRecepcionAC($recepcion){
    	$this->query="SELECT a.CVE_DOC,a.DOC_ANT,a.FECHAELAB, a.ENLAZADO, b.NOMBRE AS PROVEEDOR, c.OPERADOR, c.NUMERO AS UNIDAD, d.FECHA_SECUENCIA, d.STATUS_LOG
    				  from compr01 a
    				  left join prov01 b on a.cve_clpv = b.clave 
    				  left join compo01 d on a.doc_ant = d.cve_doc
    				  left join unidades c on d.unidad = c.numero 
    				  where a.CVE_DOC = '$recepcion'
    				  GROUP BY a.CVE_DOC,a.DOC_ANT,a.FECHAELAB, a.ENLAZADO, b.NOMBRE, c.OPERADOR, c.NUMERO, d.FECHA_SECUENCIA, d.STATUS_LOG";
    	$result=$this->QueryObtieneDatosN();
    	while ($tsArray=ibase_fetch_object($result)){
    		$data[]=$tsArray;
    	}
    	return $data;
    }
    
	function PartidasRecepcionAC($recepcion){
    		$this->query="SELECT a.NUM_PAR, b.DESCR, a.CANT, a.COST, a.TOTIMP4 , a.TOT_PARTIDA
    				  FROM PAR_COMPR01 a 
    				  LEFT JOIN  inve01 b 
    				  ON b.CVE_ART = a.CVE_ART 
    				  WHERE CVE_DOC = '$recepcion'";
    		$result=$this->QueryObtieneDatosN();
    		while ($tsArray=ibase_fetch_object($result)){
    			$data[]=$tsArray;
    		}
    		return $data;
	    }

	function OrdenSinRecepcion(){
		$this->query="SELECT a.cve_doc, b.nombre, a.fecha_pago, a.pago_tes, a.tp_tes, a.pago_entregado, c.camplib2 , a.unidad, a.estado, a.fechaelab, (datediff(day, a.fechaelab, current_date )) as Dias, a.urgencia, b.codigo, b.estado as estadoprov, a.unidad
					    from compo01 a
						left join prov01 b on a.cve_clpv = b.clave
						left join compo_clib01 c on a.cve_doc = c.clave_doc
						where STATUS_LOG != 'Nuevo' AND DOC_SIG IS NULL";
		$resultado = $this->QueryObtieneDatosN();
		while($tsArray = ibase_fetch_object($resultado)){
			$data[] = $tsArray;
		}
		return $data;
	}


	function Cajas(){
		  $a="SELECT a.*, c.NOMBRE, d.CAMPLIB7, c.CODIGO, b.FECHAELAB, b.importe, b.cita, (datediff(day, b.fechaelab, current_date)) as DIAS, b.DOC_SIG,
		  	(select count(i.cve_art) from preoc01 idp left join inve01 i on idp.prod =i.cve_art where idp.cotiza = a.cve_fact and ((i.cve_prodserv = '' or i.cve_prodserv is null) or (i.cve_unidad = '' or i.cve_unidad is null))) as validacion
		    FROM CAJAS a
		    left join factP01 b on b.cve_doc = a.cve_fact
		    left join clie01 c on b.cve_clpv = c.clave
		    left join CLIE_CLIB01 d on d.cve_clie = c.clave
		    WHERE a.STATUS='abierto' and a.embalaje = 'TOTAL'";  
		$this->query=$a;
		$result=$this->QueryObtieneDatosN();
		while ($tsArray=ibase_fetch_object($result)){
			$data[]=$tsArray;
		}
		return $data;
	}

	function CerrarCaja($idcaja, $docf, $tipo){
        if($tipo=='remision'){
            $this->query="SELECT iif(sum(pxf) is null, 0, sum(pxf)) as pxf from CONTROL_FACT_REM where caja = $idcaja";
            $rs=$this->EjecutaQuerySimple();
            $row=ibase_fetch_object($rs);
            $pxf = $row->PXF;
            $this->query="SELECT iif(sum(FACT_REM) is null, 0, sum(FACT_REM)) as FACT_REM from CONTROL_FACT_REM where caja = $idcaja";
            $rs=$this->EjecutaQuerySimple();
            $row2=ibase_fetch_object($rs);
            $pxfr = $row2->FACT_REM;
            if($pxf==0 ){
                $a="UPDATE CAJAS SET STATUS = 'cerrado', ruta = 'N', Docs = 'No', fecha_cierre = current_timestamp, status_recepcion = 0 where id = $idcaja and CVE_FACT = '$docf'";
                $this->query=$a;
                $result=$this->EjecutaQuerySimple();
                $mensaje = array("status"=>'ok', "mensaje"=>'Se ha cerrado la caja.');
            }else{
                $mensaje = array("status"=>'error',"mensaje"=>'Se debe de facturar lo embalado!!!!!');
            }    
        }elseif($tipo=='Refac'){

                $this->query="UPDATE CAJAS SET REMISION='PF'||ID, STATUS = 'cerrado', ruta = 'N', Docs = 'No', fecha_cierre = current_timestamp, status_recepcion = 0  where id = $idcaja and CVE_FACT = '$docf'";
                $result=$this->EjecutaQuerySimple();

                $lineas=$this->impPreFactDetalle($idcaja,$cajas='');

                foreach ($lineas as $key ){
                    $this->query="UPDATE CONTROL_FACT_REM SET remisiones = iif(remisiones is null, '', remisiones)||'PF'||$idcaja, FACT_REM = fact_rem + $key->CANTIDAD,
                                  PXF = PXF - $key->CANTIDAD, status = 'remisionado' where caja = $idcaja and PARTIDA = $key->PARTIDA";
                    $this->EjecutaQuerySimple();
                }
                $mensaje = array("status"=>'ok', "mensaje"=>'Se ha cerrado la caja.');
                //echo "<script>alert('Se ha cerrado la caja y se avanzo a Logistica.')</script>";
        }elseif ($tipo=='') {
            $mensaje = array("status"=>'ok', "mensaje"=>'Se creo la factura correctamente.');
        }
        return $mensaje;
    }
	
	function AsignaSecEntrega($unidad, $tipo){
		$data = array();
		if($tipo != 3){
			$a="SELECT a.*, c.nombre, c.estado, c.codigo, b.fechaelab, (datediff(day,b.fechaelab,current_date)) as dias, 
			remision||' / '||factura  as DOCUMENTO, iif(a.factura is null or a.factura = '', r.importe, b.importe) as importe
		    FROM CAJAS a
		    LEFT JOIN FACTP01 d ON a.cve_fact = d.cve_doc
		    LEFT JOIN FACTF01 b on a.factura = b.cve_doc 
		    left join factr01 r on a.remision = r.cve_doc
		    LEFT JOIN CLIE01 c on d.cve_clpv = c.clave
		    where idu = $unidad and status_recepcion = $tipo";	
		}elseif($tipo ==3){
			$a="SELECT a.*, c.nombre, c.estado, c.codigo, b.fechaelab, (datediff(day,b.fechaelab,current_date)) as dias, 
			iif(b.cve_doc is null or b.cve_doc = '', r.cve_doc, b.cve_doc)  as DOCUMENTO, iif(a.factura is null or a.factura = '', r.importe, b.importe) as importe
			FROM CAJAS a
			LEFT JOIN FACTP01 d ON a.cve_fact = d.cve_doc
			LEFT JOIN FACTF01 b on a.factura = b.cve_doc 
			left join factr01 r on a.remision = r.cve_doc
			LEFT JOIN CLIE01 c on d.cve_clpv = c.clave
			where (status_recepcion = 3 or status_recepcion = 4) 
			and idu = $unidad";		
		}
			$this->query=$a;
			$result=$this->QueryObtieneDatosN();
			while($tsArray=ibase_fetch_object($result)){
			 	$data[]=$tsArray;
		 }
		 return @$data;
	}
 	
 	function AsignaSecEntrega2($prove, $secuencia, $uni, $fecha, $idu){
 		$data = array();
		$a="SELECT a.*, c.nombre, c.estado, c.codigo, b.fechaelab, (datediff(day,b.fechaelab,current_date)) as dias, 
			b.cve_doc as FACTURA, iif(a.factura is null or a.factura = '', r.importe, b.importe) as importe
		    FROM CAJAS a
		    LEFT JOIN FACTP01 d ON a.cve_fact = d.cve_doc
		    LEFT JOIN FACTF01 b on d.cve_doc = b.doc_ant 
		    left join factr01 r on a.remision = r.cve_doc
		    LEFT JOIN CLIE01 c on d.cve_clpv = c.clave 
		    where idu = $idu";
		 $this->query=$a;
		 $result=$this->QueryObtieneDatosN();
		 while($tsArray=ibase_fetch_object($result)){
		 	$data[]=$tsArray;
		 }
		 return $data;
	}

	function traeStatus($idcaja){
		$this->query = "SELECT * FROM CAJAS WHERE ID = $idcaja";
		$rs=$this->EjecutaQuerySimple();
		$val=ibase_fetch_object($rs);
		return $val->STATUS_RECEPCION;
	}

	function AsignaSecuenciaEntrega($idcaja, $sec, $tipo){
		$mysql= new pegaso_rep;
  		$usuario =$_SESSION['user']->NOMBRE;
  		$sa=$this->traeStatus($idcaja);
	  		if($tipo == 6){
	  			if($sa == 1){
					$this->query="INSERT INTO FTC_HISTORIA_CAJA VALUES(NULL,(SELECT STATUS_RECEPCION FROM CAJAS WHERE ID = $idcaja), 1, CURRENT_TIMESTAMP, '$usuario', $idcaja, (SELECT iif(factura = '', remision , factura) from cajas where id = $idcaja))";
					$this->grabaBD();
					$this->query="UPDATE CAJAS SET UNIDAD = '$sec', idu = (select idu from unidades where numero = '$sec' and status = 'A') where id = $idcaja";
					$result=$this->queryActualiza();
					$datos = array($sec, $idcaja);
					$sql=$mysql->asignaUnidad($datos);
					if($result == 1){
						return array("status"=>'ok');
					}else{
						return array("status"=>'error');
					}
				}else{
					return array("status"=>'error');
				}
			}else{
				if($sa == 3){
					$this->query="INSERT INTO FTC_HISTORIA_CAJA VALUES(NULL,(SELECT STATUS_RECEPCION FROM CAJAS WHERE ID = $idcaja), 1, CURRENT_TIMESTAMP, '$usuario', $idcaja, (SELECT iif(factura = '', remision , factura) from cajas where id = $idcaja))";
					$this->grabaBD();

					$a="UPDATE CAJAS 
				    SET SECUENCIA = $sec, status_log = 'admon', status_recepcion = 1, fecha_secuencia = current_timestamp, STATUS_MER ='', vueltas=vueltas + 1
				    where id = $idcaja";
					$this->query=$a;
					$result=$this->queryActualiza();
					
					if($result == 1){
						return array("status"=>'ok');
					}else{
						return array("status"=>'error');
					}
				}else{
					return array("status"=>'error');	
				}
			}	
	}

	function buscaOC2($doco){

		if(substr($doco,0,2) <> 'OP'){
			$this->query="SELECT OC.CVE_DOC, oc.fecha_doc, OC.FECHAELAB, OC.IMPORTE, OC.STATUS_LOG, OC.STATUS_REC, OC.STATUS_LOG2, OC.UNIDAD, OC.TP_TES, OC.PAGO_TES, P.NOMBRE, '' as status FROM COMPO01 OC LEFT JOIN PROV01 P ON P.CLAVE = OC.CVE_CLPV WHERE upper(CVE_DOC) =upper('$doco')";
		}else{
			$this->query="SELECT  ftc.oc as cve_doc, ftc.fecha_oc as fecha_doc, ftc.fecha_oc as fechaelab, ftc.costo_total as importe, ftc.status_log, ftc.status_recepcion as status_rec, ftc.status_log2, ftc.unidad, ftc.tp_tes, ftc.pago_tes, p.nombre, ftc.status 
			from ftc_poc ftc
			left join prov01 p on p.clave = ftc.cve_prov
			where upper(ftc.oc) = upper('$doco')";	
		}

		$rs=$this->EjecutaQuerySimple();

		while($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}

		return @$data;
	}


	
	function partidasLiberadas($doco){
		$this->query="SELECT p.*, 
						(select i.descr from inve01 i where i.cve_art = p.cve_art) as nombreinve,
						(select pf.nombre from producto_ftc pf where pf.clave = p.cve_art) as nombreftc
						FROM PAR_COMPO01 p
						 WHERE CVE_DOC = '$doco' and (status = 'L' or status = 'D')";
						 //echo $this->query;
		$rs=$this->EjecutaQuerySimple();

		while($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}

		return @$data;
	}

	function partidasValidadas($doco){
		$this->query="SELECT vr.*, 
						(select i.descr from inve01 i where i.cve_art = vr.producto) as nombreinve,
						(select pf.nombre from producto_ftc pf where pf.clave = vr.producto) as nombreftc,
						(select pc.cant from par_compo01 pc where pc.cve_art = vr.producto and pc.num_par = vr.partida and pc.cve_doc = '$doco') as cant_oc,
						(select max(CANT_ACUMULADA) from VALIDA_RECEPCION vr1 where vr1.id_Preoc = vr.id_Preoc) as totalValidaciones
						FROM VALIDA_RECEPCION vr
						WHERE DOCUMENTO = '$doco'";
						//echo $this->query;
		$rs=$this->EjecutaQuerySimple();
		while($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}

		return @$data;
	}

	function recepcionDeOrdenes($doco){
		$this->query="SELECT pr.*,
		 				(select i.descr from inve01 i where i.cve_art = pr.cve_art) as nombreinve,
						(select pf.nombre from producto_ftc pf where pf.clave = pr.cve_art) as nombreftc
						from compr01 r 
						left join compo01 oc on oc.cve_doc = r.doc_ant
						left join par_compr01 pr on pr.cve_doc = r.cve_doc
				where oc.cve_doc  = '$doco'";
		$rs=$this->EjecutaQuerySimple();
		while($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}
		return @$data;
	}


	function historiaIDPREOC($id){
		$this->query="SELECT p.*, 
							(select iif(sum(cantidad) is null, 0, sum(cantidad)) from ftc_poc_detalle where idPreoc = p.id and oc is null ) as cant_preoc,
							(select sum(pxr) from par_compo01 where id_preoc = p.id) as enordenes, 
							(select sum(pxr) from FTC_POC_DETALLE where idpreoc = p.id and oc is not null) as enordenesn,
							(select sum(cantidad_rec) from ftc_detalle_recepciones where idpreoc = p.id) as recibidon
							FROM PREOC01 p 
							WHERE p.ID = $id";
		$rs=$this->EjecutaQuerySimple();
		while($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}
		return @$data;
	}

	function ordenesIDPREOC($id){

		$data=array();
		$this->query="SELECT 'N/A' AS CVE_FTCPOC, poc.status_log2, poc.pxr, poc.id_preoc, oc.realiza, poc.cant, poc.cve_doc, poc.num_par, 
						oc.tp_tes, oc.fecha_pago, oc.status_log as status_orden, oc.unidad, oc.fecha_secuencia,
						(select nombre from producto_ftc pftc where poc.cve_art = pftc.clave) as nombreftc,
						(select camplib7 from inve_clib01 i where i.cve_prod = poc.cve_art) as nombreinve,
						(select sum(cantidad_rec) from FTC_DETALLE_RECEPCIONES WHERE ORDEN = oc.cve_doc and partida = poc.num_par) as cantidad_rec,
						'' as status_real 
						from par_compo01 poc 
						left join compo01 oc on oc.cve_doc = poc.cve_doc 
						where poc.id_preoc = $id";
		$rs=$this->EjecutaQuerySimple();
		//echo $this->query.'<p>';
		while($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
			}	
		
		
$this->query="SELECT ftcpocd.cve_doc as cve_ftcpoc,ftcpocd.status_log2, ftcpocd.pxr, ftcpocd.idpreoc as id_preoc, ftcpoc.usuario_oc as realiza,ftcpocd.cantidad as cant, ftcpocd.oc as cve_doc, ftcpocd.partida as num_par, 
						ftcpoc.tp_tes, ftcpoc.fecha_pago, ftcpoc.status as status_orden, ftcpoc.unidad, ftcpoc.fecha_secuencia,ftcpoc.fecha_oc,
                        (select nombre from producto_ftc ftcp where ftcpocd.art = ftcp.clave) as nombreftc,
                        (select sum(cantidad_rec) from ftc_detalle_recepciones where orden = ftcpocd.oc and partida = ftcpocd.partida) as cantidad_rec,
                      	status_real
                      from FTC_POC_DETALLE ftcpocd
                      left join ftc_poc ftcpoc on ftcpoc.oc = ftcpocd.oc
                       where idpreoc = $id";
		$rs=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($rs)) {
			$data[]=$tsArray;
		}
		//echo $this->query.'<p>';

		return @$data;
	}

	function validacionesIDPREOC($id){
		$this->query="SELECT vr.*, 
						(select i.descr from inve01 i where i.cve_art = vr.producto) as nombreinve,
						(select pf.nombre from producto_ftc pf where pf.clave = vr.producto) as nombreftc,
						(select max(CANT_ACUMULADA) from VALIDA_RECEPCION vr1 where vr1.id_Preoc = vr.id_Preoc) as totalValidaciones
						FROM VALIDA_RECEPCION vr
						WHERE id_preoc = $id";
		$rs=$this->EjecutaQuerySimple();
		while($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}
		return @$data;
	}

	function recepcionesIDPREOC($id){
		$data=array();
		$this->query="SELECT pr.*, 
							(select nombre from producto_ftc pftc where pr.cve_art = pftc.clave) as nombreftc,
						(select camplib7 from inve_clib01 i where i.cve_prod = pr.cve_art) as nombreinve  
						FROM PAR_COMPR01 pr
						left join compr01 r on r.cve_doc = pr.cve_doc
						WHERE ID_PREOC = $id";
		$rs=$this->EjecutaQuerySimple();
			while($tsArray=ibase_fetch_object($rs)){
				$data[]=$tsArray;
			}
		return @$data;
	}


	function recepcionesNuevasIDPREOC($id){
		$this->query="SELECT * FROM FTC_DETALLE_RECEPCIONES ftcr left join preoc01 poc on poc.id = ftcr.idpreoc left join producto_ftc pftc on pftc.clave = poc.prod WHERE IDPREOC = $id";
		$rs=$this->EjecutaQuerySimple();
		while($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}
		
		return @$data;
	}

		function AsignaSec3($idu){
		$this->query="SELECT  b.NOMBRE, count (a.cve_doc) as cve_doc, MAX(current_date ) as Fecha, MAX (b.codigo) as codigo, MAX (b.estado) as ESTADOPROV, MAX (b.codigo) as codigo, MAX(unidad) as unidad, MAX (datediff(day, a.fechaelab, current_date )) as Dias, max(a.cve_clpv) as prov, max(idu) as IDU
                       from compo01 a
                       left join PROV01 b on a.cve_clpv = b.clave
                       where a.idu = $idu and secuencia is null
                        group by b.nombre ";

     	$result = $this->QueryObtieneDatosN();
     	while ($tsArray = ibase_fetch_object($result)){
     		$data[] = $tsArray;

     	}

     		return $data;  	
	}
		
//################# Ordenes de compra a avanzar #################
	function DataOrdenesAA(){
		$this->query = "SELECT a.CVE_DOC, b.NOMBRE AS PROVEEDOR, a.FECHAELAB, a.IMPORTE, a.STATUS, datediff(day FROM FECHAELAB TO current_date) AS DIAS
						FROM COMPO01 a INNER JOIN PROV01 b
						ON a.CVE_CLPV = b.CLAVE 
						WHERE DOC_SIG IS NULL AND STATUS_LOG != 'Falso' AND a.STATUS != 'C'
						ORDER BY DIAS";	
		$resultado = $this->QueryObtieneDatosN();
		while($tsArray = ibase_fetch_object($resultado)){
			$data[] = $tsArray;
		}
		return $data;
	}
		
	function DataOrdenAA($idorden){
		$this->query = "SELECT a.CVE_DOC, b.NOMBRE AS PROVEEDOR, a.FECHAELAB, a.IMPORTE, a.STATUS, datediff(day FROM FECHAELAB TO current_date) AS DIAS
						FROM COMPO01 a INNER JOIN PROV01 b
						ON a.CVE_CLPV = b.CLAVE 
						WHERE a.CVE_DOC = '$idorden' ";
		
		$resultado = $this->QueryObtieneDatosN();
		while($tsArray = ibase_fetch_object($resultado)){
			$data[] = $tsArray;
		}
		return $data;
	}
	
	function PartidasOrdenAA($idorden){
		$this->query = "SELECT a.CVE_DOC,a.NUM_PAR, a.ID_PREOC, a.CVE_ART, b.DESCR, a.CANT, a.PXR, a.TOT_PARTIDA, a.FECHA_DOC_RECEP
						FROM PAR_COMPO01 a INNER JOIN INVE01 b ON a.CVE_ART = b.CVE_ART
						WHERE a.CVE_DOC = '$idorden' AND PXR > 0  AND FOLIO_FALSO IS NULL";
		$resultado = $this->QueryObtieneDatosN();
		while($tsArray = ibase_fetch_object($resultado)){
			$data[] = $tsArray;
		}
		return $data;
	}
	
	function ObtienFolioFalso(){
		$this->query = "SELECT COUNT(FOLIO_FALSO) FROM COMPO01 WHERE FOLIO_FALSO IS NOT NULL ";
		$resultado = $this->QueryObtieneDatosN();
		while($tsArray = ibase_fetch_row($resultado)){
			$data[] = $tsArray;			
		}
		return $data;
	}

	function AvanzaCompo($idorden, $folio){
		$this->query = "UPDATE COMPO01 SET STATUS_LOG = 'Falso', FOLIO_FALSO = 'F-'||'$folio'   WHERE CVE_DOC = '$idorden'";
		$resultado = $this->EjecutaQuerySimple();
		
		return $resultado;
	}	

	function ObtienFolioFalsoPar(){
		$this->query = "SELECT COUNT(FOLIO_FALSO) FROM PAR_COMPO01 WHERE FOLIO_FALSO IS NOT NULL ";
		$resultado = $this->QueryObtieneDatosN();
		while($tsArray = ibase_fetch_row($resultado)){
			$data[] = $tsArray;			
		}
		return $data;
	}
	
	function AvanzaParCompo($idorden, $partida, $folio){
		$this->query = "UPDATE PAR_COMPO01 SET PXR = 0.00, FOLIO_FALSO = 'F-'||'$folio' WHERE CVE_DOC = '$idorden' AND NUM_PAR = '$partida' ";
		$resultado = $this->EjecutaQuerySimple();
		//var_dump($partida);
		return $resultado;
	}
	
	function ValidarPartidas($idorden){
		$this->query = "SELECT COUNT(NUM_PAR) FROM PAR_COMPO01 WHERE CVE_DOC = '$idorden' AND FOLIO_FALSO IS NULL";
		$resultado = $this->QueryObtieneDatosN();
		while($tsArray = ibase_fetch_row($resultado)){
			$data[] = $tsArray;			
		}
		return $data;
	}
		
//################# Finaliza orden de compra a avanzar #################
//// Produntos por RFC

	function prodxrfc($rfc){
		$a="SELECT a.clave 
				from clie01 a 
				where RFC = '$rfc'";
			$this->query=$a;
			$result=$this->QueryObtieneDatosN();
			while($tsArray=ibase_fetch_object($result)){
				$data2[]="'".$tsArray->CLAVE."'";
				$claves=implode(",",$data2);
		}

		//$b="SELECT A.PROD, max(ID) as ID, max(COTIZA) AS COTIZA, MAX(NOMPROD) AS NOMPROD, SUM(CANTI) AS CANTI, AVG(b.prec) AS PREC, SUM(CANT_ORIG) AS CANT_ORIG, MAX(NOM_CLI) AS NOM_CLI, MAX(CLIEN) AS CLIEN, MAX(FECHASOL) AS FECHASOL, AVG(PREC) AS PREC
		//		FROM PREOC01 a
		//		left join par_factp01 b on a.cotiza = b.cve_doc and a.par = b.num_par
		//		WHERE CLIEN in ($claves) group by PROD";

		$b="SELECT P.*, par.prec FROM PREOC01 P left join par_factp01 par on par.cve_doc = P.cotiza and par.num_par = P.par WHERE CLIEN IN ($claves)";				
			$this->query=$b;
			$result=$this->QueryObtieneDatosN();
			while($tsArray=ibase_fetch_object($result)){
				$data[]=$tsArray;
			}
		return $data;
	
		}
                
        function DatosUnidad($unidad){
            $this->query = "SELECT numero, marca, modelo, placas, operador, coordinador FROM unidades WHERE idu = $unidad";
            $resultado = $this->QueryObtieneDatosN();
            while($tsArray = ibase_fetch_row($resultado)){
            	$data[] = $tsArray;
            }
            return $data;   
           }

        function recibirDoc($doc, $docf, $docr){
        	$tabla='COMPO01';
        	$campo='cve_doc';
        	if(substr($doc, 0, 1) != 'O'){
        	$tabla='CAJAS';
        	$campo='CVE_FACT';        		
        	}elseif(substr($doc,0, 2) == 'OP'){
        		$tabla = 'FTC_POC';
        		$campo = 'OC';
        	}
        	if($tabla == 'COMPO01'){
        		$a="UPDATE $tabla set docs = 'S',  RUTA = 'A' where $campo = '$doc'";
        	}elseif($tabla == 'CAJAS'){
        		$a="UPDATE $tabla set docs = 'S',  RUTA = 'N' where $campo = '$doc'";
        	}elseif($tabla == 'FTC_POC'){
        		$this->query="UPDATE FTC_POC_DETALLE SET STATUS_REAL = 'LOGISTICA 2' WHERE OC = '$doc'";
        		$this->EjecutaQuerySimple();

        		$a="UPDATE $tabla set docs = 'S', RUTA = 'A' where $campo = '$doc'";

        	}
        	//echo $a;
        	$this->query=$a;
        	$result=$this->EjecutaQuerySimple();
        	if(!empty($docf)){$this->query="UPDATE factf01 set status_fact = 'Logistica' where cve_doc = '$docf'";        	
        	$rs = $this->EjecutaQuerySimple();}
        	if(!empty($docr)){$this->query="UPDATE FACTR01 SET status_rem = 'Logistica' where cve_doc = '$docr'"; 
        	$rs=$this->EjecutaQuerySimple();}
        	return $result;
        }

   function AsignaSecDetalle($unidad, $docs){
   			$data=array();
   			if(strlen($docs)>0){
   				$docs= explode(",",$docs );
				$doc="";
   				for($i=0; $i<count($docs);$i++){
				$doco= $docs[$i];
				$doc.= ",'".$doco."'";
    	 		}
    	 		$doc=substr($doc, 1);
            		$this->query="SELECT ftc.oc as cve_doc, ftc.fecha_oc as fecha_doc, ftc.cve_prov as cve_clpv, datediff(day, ftc.fecha_oc, current_date) as dias, p.nombre, ftc.vueltas, 
	            				p.estado, p.codigo, ftc.fecha_oc as fechaelab, ftc.unidad, ftc.fecha_pago, ftc.tp_tes, ftc.pago_tes, ftc.costo_total as importe, ftc.idu, p.clave as prov, u.operador as operador,
	            				ftc.status as status, ftc.status_log as status_log 
	            				from ftc_poc ftc 
	            				left join prov01 p on p.clave = ftc.cve_prov
	            				left join unidades u on u.idu=ftc.idu
	            				where ftc.idu = $unidad and (ftc.status = 'LOGISTICA' or ftc.status = 'PAGADA') AND (ftc.status_log = 'secuencia') and oc in ($doc)";
	            	//echo $this->query; //  or ftc.status_log is null
					$resultado = $this->QueryObtieneDatosN();
	            	while($tsArray = ibase_fetch_object($resultado)){
	            	    $data[] = $tsArray;
	            	}	
   			}else{
   				$this->query="SELECT ftc.oc as cve_doc, ftc.fecha_oc as fecha_doc, ftc.cve_prov as cve_clpv, datediff(day, ftc.fecha_oc, current_date) as dias, p.nombre, ftc.vueltas, 
	            				p.estado, p.codigo, ftc.fecha_oc as fechaelab, ftc.unidad, ftc.fecha_pago, ftc.tp_tes, ftc.pago_tes, ftc.costo_total as importe, ftc.idu, p.clave as prov, u.operador as operador,
	            				ftc.status as status, ftc.status_log as status_log 
	            				from ftc_poc ftc 
	            				left join prov01 p on p.clave = ftc.cve_prov
	            				left join unidades u on u.idu=ftc.idu
	            				where ftc.idu = $unidad and (ftc.status = 'LOGISTICA' or ftc.status = 'PAGADA') AND (ftc.status_log = 'secuencia')";
	            	//echo $this->query; //  or ftc.status_log is null
					$resultado = $this->QueryObtieneDatosN();
	            	while($tsArray = ibase_fetch_object($resultado)){
	            	    $data[] = $tsArray;
	            	}	
   			}
   			            
  
            return @$data;
        }

    function valCheck($doco, $idu){
    	$this->query="SELECT * FROM FTC_POC WHERE OC = '$doco'";
    	$res=$this->EjecutaQuerySimple();
    	$row=ibase_fetch_object($res);
    	if($row){
    		$sta_log = $row->STATUS_LOG;
    		$idun = $row->IDU;
    		if($idu != $idun){
    			return array("status"=>'ok', "mensaje"=>"El usuario".$x.", ha movido el documento a otra unidad");
    		}elseif ($sta_log != "secuencia") {
    			return array("status"=>"no","mensaje"=>"El documento ya ha sido avanzado por el usuario".$row->USUARIO_LOG." con la fecha: ".$row->FECHA_SECUENCIA);
    		}else{ 
    			return array("status"=>'ok',"mensaje"=>"El documento esta en la ruta");
    		}
    	}else{
    		return array("status"=>"no", "mensaje"=>"No se encontro el documento".$doco);
    	}
    }

    function RutaUnidadRec($idr){
        	$HOY = date("Y-m-d");
        	$today = getdate();
			if($today['wday'] == 1){
				$a="SELECT iif(a.doc_sig is null,'No', a.doc_sig) as DOC_SIG,
                         a.*,
                         b.nombre,
                         b.ESTADO,
                         b.codigo,
                         datediff(day,a.fechaelab, current_date) as DIAS,
                         current_date as HOY,
                         a.cierre_uni as cierre
                         FROM COMPO01 a
                         LEFT JOIN PROV01 b on a.cve_clpv = b.clave
                         WHERE IDU = $idr AND (FECHA_SECUENCIA between DATEADD(DAY,-4,current_date)
                         and cast('TOMORROW' AS DATE))
                         and
                         (cierre_uni is null or cierre_uni != 'impreso') and (status_log != 'admon' and Status_log != 'Nuevo' and status_log != 'secuencia')";
        		///echo $a;
			}else{
        	$a="SELECT iif(a.doc_sig is null,'No', a.doc_sig) as DOC_SIG, a.*, b.nombre, b.ESTADO, b.codigo, datediff(day,a.fechaelab, current_date) as DIAS, current_date as HOY, a.cierre_uni as cierre 
        		FROM COMPO01 a 
        		LEFT JOIN PROV01 b on a.cve_clpv = b.clave
        		WHERE IDU = $idr AND (FECHA_SECUENCIA between CAST('YESTERDAY'AS date)  and cast('TODAY' AS DATE)) and (cierre_uni is null or cierre_uni != 'impreso') and (status_log != 'admon' and Status_log != 'Nuevo' and status_log != 'secuencia')";
        		//echo $a; (fecha_rev between CAST('TODAY' AS DATE) AND CAST('TOMORROW' AS DATE)  
        	}

        	$this->query=$a;
        	$result=$this->QueryObtieneDatosN();
        	while($tsArray=ibase_fetch_object($result)){
        		$data[]=$tsArray;
        	}  

        	return @$data;
        }

       function RutaUnidadEnt($idr){
       		$HOY = date("Y-m-d");
        	$today = getdate();
			if($today['wday'] == 1){
			$b="SELECT a.*, d.nombre, d.estado, d.codigo, b.fechaelab, c.fechaelab as fechfact, c.cve_doc as factura, datediff(day, c.fechaelab, current_date) as Dias, a.Docs, a.idu, a.val_aduana as aduana, iif(a.factura is null or a.factura = '', a.remision, a.factura) as documento
        		FROM CAJAS a
        		left join factp01 b on a.cve_fact = b.cve_doc
        		left join factf01 c on b.cve_doc = c.doc_ant
        		left join Clie01 d on d.clave = b.cve_clpv
        		WHERE IDU = $idr and (cierre_uni is null or cierre_uni != 'impreso') 
        		AND FECHA_SECUENCIA >= DATEADD(DAY, -4 , current_date) 
        		AND (a.STATUS_LOG = 'Entregado' or a.status_log = 'NC' or a.status_log = 'Reenviar' or a.status_log = 'Recibido')";
        	
			}else{
        	$b="SELECT a.*, d.nombre, d.estado, d.codigo, b.fechaelab, c.fechaelab as fechfact, c.cve_doc as factura, datediff(day, c.fechaelab, current_date) as Dias, a.Docs, a.idu, a.val_aduana as aduana, iif(a.factura is null or a.factura = '', a.remision, a.factura) as documento
        		FROM CAJAS a
        		left join factp01 b on a.cve_fact = b.cve_doc
        		left join factf01 c on b.cve_doc = c.doc_ant
        		left join Clie01 d on d.clave = b.cve_clpv
        		WHERE IDU = $idr and (cierre_uni is null or cierre_uni != 'impreso') AND FECHA_SECUENCIA >= cast('YESTERDAY' as date) AND (a.STATUS_LOG = 'Entregado' or a.status_log = 'NC' or a.status_log = 'Reenviar' or a.status_log = 'Recibido')";
        	}
        	$this->query=$b;
        	$result=$this->QueryObtieneDatosN();
        	while($tsArray=ibase_fetch_object($result)){
        		$data[]=$tsArray;
        	}  
        	return $data;
        }

      

      
     function RegresaDocs($doc, $idr, $docs){

        	$pedido=strrpos($doc,'P');
    			$tabla = 'COMPO01';
        		$campo = 'CVE_DOC';
    		if ($pedido !== false){
    			$tabla='CAJAS';
    			$campo='CVE_FACT';
    		}

    		//echo $docs;
    		if($docs == 'No'){
    			$b="UPDATE $tabla set docs = 'Si' where $campo = '$doc'";
    		//	echo $b;
        		$this->query=$b;
        		$result=$this->EjecutaQuerySimple();
        		return $result;
    		}

        	$b="UPDATE $tabla set docs = 'N' where $campo = '$doc'";
        	$this->query=$b;
        	$result=$this->EjecutaQuerySimple();
        	return $result;
        }

      function CerrarOC($doc,$idr,$tipo,$idc){
        	$pedido=substr($doc, 0, 1);        	
        	$tabla='COMPO01';
        	$campo='CVE_DOC';
        	if($pedido <> 'O'){
        		$tabla='CAJAS';
        		$campo='ID';
        	};
        	if ($tipo == 'Parcial'){
        		$valor = 'Parcial';
 	       	}elseif($tipo =='Tiempo'){
 	       		$valor ='Tiempo';
        	}else{
        		$valor='ok';
        	};
        	if ($campo == 'ID'){
        		$c="UPDATE $tabla set cierre_uni = '$valor' where $campo=$idc";
        	}else{
        		$c="UPDATE $tabla set cierre_uni = '$valor' where $campo='$doc'";
        	}
           	//echo "Valor de la consulta: ".$c;
        	$this->query=$c;
        	$result=$this->EjecutaQuerySimple();
        	return $result;
        }



        function RutaUnidadRecGen(){
        	$a="SELECT a.*, b.nombre, CURRENT_DATE as HOY, datediff(day,a.fechaelab, current_date) as DIAS 
        		FROM COMPO01 a 
        		LEFT JOIN prov01 b on a.cve_clpv = b.clave
        		WHERE (FECHA_SECUENCIA between CAST('TODAY'AS date)  and cast('YESTERDAY' AS DATE)) 
        		AND CIERRE_TOT IS NULL";
        	$this->query=$a;
        	$result=$this->QueryObtieneDatosN();
        	while($tsArray=ibase_fetch_object($result)){

        		$data[]=$tsArray;
        	}
        	return $data;
        }

        function CerrarGen(){
        	$b="SELECT fecha_secuencia, count(a.cve_doc) as Documentos, count (a.cierre_uni) as DOCS
                FROM COMPO01 a 
                LEFT JOIN prov01 b on a.cve_clpv = b.clave
                WHERE FECHA_SECUENCIA = current_date AND CIERRE_TOT IS NULL
                group by fecha_secuencia";
             $this->query=$b;
             $result=$this->QueryObtieneDatosN();
             $row=ibase_fetch_object($result);
             $Docs=$row->DOCUMENTOS;
             $Cerrados=$row->DOCS;
             if ($Docs == $Cerrados){
             	$var= true;
             }else{
             	$var=false;
             }
             return $var;
        }

		function CerrarRutasRecoleccion($documentos){
            $arrayLength = count($documentos);
            for($contador = 0; $contador < $arrayLength; $contador++){
                if((substr($documentos[$contador][0],0,1)) == 'P'){
                    $tabla = 'CAJAS';
                    $campo = 'CVE_FACT';
                } else{
                    $tabla = 'COMPO01';
                    $campo = 'CVE_DOC';
                }

                $doc = $documentos[$contador][0];
                $vueltas = (int)$documentos[$contador][2];
               // var_dump($vueltas);
                if($vueltas >= 5){
                    $this->query = "UPDATE $tabla SET STATUS_LOG = 'Fallido' WHERE $campo = '$doc'";
                    }else{
                        switch ($documentos[$contador][1]) {
                                case 'Total':
                                    $this->query = "UPDATE $tabla SET CIERRE_TOT = 'OK', VUELTAS = VUELTAS + 1 WHERE $campo = '$doc' ";
                                    break;
                                case 'Parcial':
                                    $this->query = "UPDATE $tabla SET STATUS_LOG = 'Parcial', RUTA = 'N', SECUENCIA = NULL, UNIDAD = NULL, idu = NULL, VUELTAS = VUELTAS + 1, CIERRE_TOT = 'R' WHERE $campo = '$doc'";
                                    break;
                                case 'Tiempo':
                                    $this->query = "UPDATE $tabla SET STATUS_LOG = 'Nuevo', RUTA = 'N', SECUENCIA = NULL, UNIDAD = NULL, idu = NULL, VUELTAS = VUELTAS + 1 WHERE $campo = '$doc'";
                                    break;
                                case 'PNR':
                                    $this->query = "UPDATE $tabla SET CIERRE_TOT = 'OK', VUELTAS = VUELTAS + 1 WHERE $campo = '$doc' ";
                                    break;
                                case 'Fallido':
                                    $this->query = "UPDATE $tabla SET CIERRE_TOT = 'OK', VUELTAS = VUELTAS + 1 WHERE $campo = '$doc' ";
                                    break;
                                case 'Reenvio':
                                    $this->query = "UPDATE $tabla SET CIERRE_TOT = 'OK', VUELTAS = VUELTAS + 1 WHERE $campo = '$doc' ";
                                    break;
                                case 'Tiempo2':
                                	 $this->query = "UPDATE $tabla SET STATUS_LOG = 'FalloProv', RUTA = 'N', SECUENCIA = NULL, UNIDAD = NULL, idu = NULL, VUELTAS = VUELTAS + 1, CIERRE_TOT = 'R' WHERE $campo = '$doc'";
                                    break;
                                default:
                                    break;
                            }
                    }
                $resultado = $this->EjecutaQuerySimple();
            }
         return $resultado;
        }


        function VentasVsCobrado($fechaini, $fechafin, $vend){
            if(!empty($vend))
                $filtrovend = "and v.nombre LIKE '($vend%'";
                else
                    $filtrovend = " ";


           	$this->query="SELECT f.*, iif(substring(trim(fa.doc_ant) from 1 for 1) = '0',
						(select fr.doc_ant from factr01 fr where fr.cve_doc = fa.doc_ant) , fa.doc_ant) as doc_ant, u.NOMBRE AS NOMBREVENDEDOR
						FROM FACTURAS f 
						left join factf01 fa on fa.cve_doc = f.cve_doc 
						left join PG_USERS u on u.letra_nueva = substring(iif(substring(trim(fa.doc_ant) from 1 for 1) = '0',
						(select fr.doc_ant from factr01 fr where fr.cve_doc = fa.doc_ant) , fa.doc_ant) from 1 for  1) and (u.sub_letra is null or u.sub_letra = '')
						where UPPER(f.vendedor) containing UPPER('')
						AND f.fecha_doc BETWEEN '$fechaini' AND '$fechafin' order by u.nombre";
            
           /* $this->query = "SELECT
                                cm.CVE_CLIE AS CLIENTE,
                                cm.REFER AS REFERENCIA,
                                iif(fd.CVE_DOC IS NULL, '',fd.CVE_DOC) AS NC_ASOCIADA,
                                cm.FECHAELAB AS FECHA_ELABORACION,
                                cd.FECHA_APLI AS FECHA_APLICACION,
                                cm.IMPORTE AS IMPORTE_VENDIDO,
                                SUM(iif(cd.IMPORTE IS null, 0, cd.IMPORTE)) AS IMPORTE_COBRADO,
                                iif(fd.IMPORTE IS NULL, 0, fd.IMPORTE) AS IMPORTE_NC,
                                round(cm.IMPORTE,2) - round((iif(fd.IMPORTE IS NULL, 0, fd.IMPORTE)),2) AS VENTA_REAL,
                                round(cm.IMPORTE,2) - round(SUM(iif(cd.IMPORTE IS null, 0, cd.IMPORTE)),2) AS SALDO,
                                iif(v.nombre IS NULL, '', v.nombre) AS VENDEDOR,
                                (cm.IMPORTE - (iif(fd.IMPORTE IS NULL, 0, fd.IMPORTE))) - (cm.IMPORTE - SUM(iif(cd.IMPORTE IS null, 0, cd.IMPORTE))) AS VENTA_SALDO,
                                (((cm.IMPORTE - (iif(fd.IMPORTE IS NULL, 0, fd.IMPORTE))) - (cm.IMPORTE - SUM(iif(cd.IMPORTE IS null, 0, cd.IMPORTE)))) / 1.16) * 0.01 AS COMISION
                                FROM
                                    ((cuen_m01 cm
                                    LEFT JOIN factd01 as fd
                                    ON fd.doc_ant = cm.refer)
                                    LEFT JOIN vend01 v
                                    ON v.CVE_VEND = cm.strcvevend)
                                    INNER JOIN cuen_det01 cd
                                    ON cm.refer = cd.refer
								WHERE
								cm.tipo_mov = 'C'
                                GROUP BY
                                cm.CVE_CLIE,
                                cm.REFER ,
                                fd.CVE_DOC,
                                cm.FECHAELAB,
                                cd.FECHA_APLI,
                                cm.IMPORTE,
                                fd.IMPORTE,
                                cm.IMPORTE,
                                v.nombre
								HAVING
								cd.FECHA_APLI BETWEEN '$fechaini' AND '$fechafin'
								$filtrovend
								ORDER BY REFERENCIA";
			*/
            $resultado = $this->QueryObtieneDatosN();
            while($tsArray = ibase_fetch_object($resultado)){
                $data[] = $tsArray;
            }
            //var_dump($this->query);
            return $data;
        }
        
        function VerCatGastos(){
            $this->query = "SELECT * FROM CAT_GASTOS WHERE ACTIVO = 'S' ORDER BY ID ASC";
            $resultado = $this->QueryObtieneDatosN();
            while($tsArray = ibase_fetch_object($resultado)){
                $data[] = $tsArray;
            }
            return $data;
        }
        
        function guardarNuevaCuenta($concepto, $descripcion, $iva, $cc, $cuenta, $gasto, $presupuesto, $retieneiva, $retieneisr, $retieneflete){
            $viva = (!empty($retieneiva) ? $retieneiva : 0);
            $visr = (!empty($retieneisr) ? $retieneisr : 0);
            $vflete = (!empty($retieneflete) ? $retieneflete : 0);
            $this->query= "INSERT INTO CAT_GASTOS (CONCEPTO,DESCRIPCION,CAUSA_IVA,CENTRO_COSTOS,CUENTA_CONTABLE,GASTO,PRESUPUESTO,IVA,ISR,FLETE)
                           VALUES ('$concepto', '$descripcion', '$iva', '$cc', '$cuenta', '$gasto', $presupuesto, $viva, $visr, $vflete)";
            $resultado = $this->EjecutaQuerySimple();
            return $resultado;
        }
        
        function editCuentaGasto($id){
            $this->query = "SELECT * FROM CAT_GASTOS WHERE ID = $id";
            $resultado = $this->QueryObtieneDatosN();
            while($tsArray = ibase_fetch_object($resultado)){
                $data[] = $tsArray;
            }
            return $data;
        }
        
        function guardarCambiosCuenta($concepto, $descripcion, $iva, $cc, $cuenta, $gasto, $presupuesto, $id, $retieneiva, $retieneisr, $retieneflete, $activo, $cveprov){
        	if (empty($presupuesto)){
        		$presupuesto = 0;
        	}

        	if (empty($cveprov)){
        		$cveprov ='No';
        		$Nombre = 'No';
        	}else{
        	$a="SELECT NOMBRE FROM PROV01 WHERE CLAVE = '$cveprov'";
        	$this->query=$a;
        	$result=$this->QueryObtieneDatosN();
        	$row=ibase_fetch_object($result);
        	$Nombre=$row->NOMBRE;
        	}

            $this->query= "UPDATE CAT_GASTOS SET CONCEPTO = '$concepto',DESCRIPCION = '$descripcion',CAUSA_IVA = '$iva',
                           CENTRO_COSTOS = '$cc',CUENTA_CONTABLE = '$cuenta',GASTO = '$gasto',PRESUPUESTO = iif($presupuesto=0,presupuesto,$presupuesto), IVA = $retieneiva, ISR = $retieneisr, FLETE = $retieneflete, ACTIVO = '$activo', cve_prov = iif('$cveprov' = 'No',cve_prov, '$cveprov'), proveedor=iif('$Nombre'= 'No', proveedor,'$Nombre')
                           WHERE ID = $id";
            $resultado = $this->EjecutaQuerySimple();
            return $resultado;
        }
        
        /*editado por GDELEON 3/Ago/2016*/
        function delCuentaGasto($id){
        	/*no eliminar solo cambiar ACTIVO N*/
            //$this->query = "DELETE FROM CAT_GASTOS WHERE ID = $id";
            $this->query = "UPDATE CAT_GASTOS 
            				SET ACTIVO = 'N'
            				WHERE ID = $id";
            $resultado = $this->EjecutaQuerySimple();
            return $resultado;
        }
		
		/*Modificado por GDELEON 3/Ago/2016*/
        function traeProveedoresGastos(){
        	$data=array();
            $this->query = "SELECT p.CLAVE, p.NOMBRE FROM PROV01 p WHERE p.fax = 'Servicio' or p.fax = 'Mixto'";
            $resultado = $this->QueryObtieneDatosN();
            while($tsArray = ibase_fetch_object($resultado)){
                $data[] = $tsArray;
            }
            $this->query = "SELECT * from xml_clientes WHERE tipo = 'Proveedor'";
            $resultado = $this->QueryObtieneDatosN();
            while($tsArray = ibase_fetch_object($resultado)){
                $data[] = $tsArray;
            }
            return $data;
        }

      function LiberarPartidasNoRecibidas($doco, $id_preoc, $pxr, $par){
      		/// cancelacion de Partida
      		if(substr($doco,0,3) == 'AAA'){
      				$doco = substr($doco,3,10);
      				echo 'Se ha Cancelado el ID: '.$id_preoc;
      					$this->query="SELECT * FROM PREOC01 WHERE ID = $id_preoc";
				        	$rs=$this->QueryObtieneDatosN();
				        	//echo $this->query.'<p>';
				        	$row= ibase_fetch_object($rs);
				        	$co= $row->CANT_ORIG;
				        	$cs= $row->CANTI;

				        	if ($cs > $co){
				        		$this->query = "SELECT iif(sum(cant) is null, 0, sum(cant)) as cantpedida FROM FTC_POC_DETALLE WHERE IDPREOC = $id_preoc and status = '2'";
				        		$rs=$this->QueryObtieneDatosN();
				        		$row=ibase_fetch_object($rs);
				        		$cp = $row->CANTPEDIDA;
				        		$this->query="UPDATE preoc01 set canti= ($co-$cp), rest=($co-$cp), ordenado=$cp, status = 'F' where id=$id_preoc";
				        		$rs= $this->EjecutaQuerySimple();
				        		$this->query="UPDATE FTC_POC_DETALLE set pxr = 0, status = 4, status_real = 'Cancelada' where idpreoc = $id_preoc and oc = '$doco'";
				        		$rs=$this->EjecutaQuerySimple();
				        		throw new Exception("Se esta tratando de solicitar mas de lo debido, se reporta a Direccion");
				        		return $rs;
				        	}
				        	echo 'Cantidad de los pendientes pxr: '.$pxr.' valor de Cantidad Original: '.$co.'<p>';
				        	if ($pxr <= $co){
				        		$query = "UPDATE FTC_POC_DETALLE SET";
					    		$query .= " pxr= (pxr - $pxr) ,";
					    		$query .= " status = 5, ";
					    		$query .= " status_log2 = 'Cancelado'";
					    		$query .= " WHERE idpreoc = $id_preoc and oc = '$doco'";
					    		$this->query = $query;
					    		$result = $this->EjecutaQuerySimple();
					    		echo $this->query.'<p>';


				        		$query = "UPDATE PREOC01 SET";
								$query .= " rest= 0,";
								$query .= " canti= 0,";
								$query .= " ordenado= ordenado,";
								$query .= " status='C'";
								$query .= " WHERE id=$id_preoc";
								$this->query = $query;
								$this->EjecutaQuerySimple();

								echo $this->query.'<p>';
								$this->libSaldo($id_preoc, $pxr, $doco);
						
						$this->query="SELECT sum(cantidad_REC) as cantidad FROM FTC_DETALLE_RECEPCIONES WHERE ORDEN = '$doco'";
		        		$rs=$this->EjecutaQuerySimple();
		        		$row=ibase_fetch_object($rs);


		        		if($row->CANTIDAD > 0){
		        			$this->query="UPDATE FTC_POC SET STATUS = 'CANCELADA_PAR' WHERE OC = '$doco'";
		        			$rs=$this->EjecutaQuerySimple();
		        		}else{
		        			$this->query="UPDATE FTC_POC SET STATUS = 'CANCELADA_TOT' where OC = '$doco'";
		        			$rs=$this->EjecutaQuerySimple();	
		        		}		        
      			}
      				return;	
      		}
      		
      		if(substr($doco,0, 2) == 'OP' or substr($doco,0,3) =='AAA'){
      			$this->query="SELECT STATUS_LOG2 as status from FTC_POC_DETALLE where oc = '$doco' and partida = $par";
      			$rs=$this->EjecutaQuerySimple();
      			$row=ibase_fetch_object($rs);
      			$status =$row->STATUS;
      		}else{
      			$this->query="SELECT STATUS_LOG2 as status FROM PAR_COMPO01 WHERE CVE_DOC = '$doco' and num_par = '$par'"; 
    	  		$rs=$this->EjecutaQuerySimple();
	      		$row=ibase_fetch_object($rs);
      			$status = $row->STATUS;
      		}
      		if($status == 'Tesoreria' and substr($doco, 0,2) <> 'OP'){
      				$usuario =$_SESSION['user']->NOMBRE;
					$this->query="SELECT p.clave, p.nombre, oc.fechaelab FROM COMPO01 oc left join prov01 p on p.clave=oc.cve_clpv WHERE CVE_DOC = '$doco'";
					$rs=$this->EjecutaQuerySimple();
					$row=ibase_fetch_object($rs);
					$cveprov=$row->CLAVE;
					$nomprov = $row->NOMBRE;
					$fecha = $row->FECHAELAB;

					$this->query="INSERT INTO LIB_PARTIDAS (ID, IDPREOC, CANTIDAD, PROVEEDOR, NOMBRE_PROVEEDOR, OC, FECHA_OC, PARTIDA_OC, USUARIO, FECHA ) 
									VALUES (NULL, $id_preoc, $pxr,'$cveprov', '$nomprov', '$doco', '$fecha', $par, '$usuario', current_timestamp )";
					$rs=$this->EjecutaQuerySimple();

					if($rs){
						echo 'Entro a la liberacion';
				        	$this->query="SELECT * FROM PREOC01 WHERE ID = $id_preoc";
				        	$rs=$this->QueryObtieneDatosN();
				        	//echo $this->query.'<p>';
				        	$row= ibase_fetch_object($rs);
				        	$co= $row->CANT_ORIG;
				        	$cs= $row->CANTI;

				        	if ($cs > $co){
				        		$this->query = "SELECT iif(sum(cant) is null, 0, sum(cant)) as cantpedida FROM PAR_COMPO01 WHERE ID_PREOC = $id_preoc and status = 'E'";
				        		$rs=$this->QueryObtieneDatosN();
				        		$row=ibase_fetch_object($rs);
				        		$cp = $row->CANTPEDIDA;
				        		$this->query="UPDATE preoc01 set canti= ($co-$cp), rest=($co-$cp), ordenado=$cp, status ='F' where id=$id_preoc";
				        		$rs= $this->EjecutaQuerySimple();
				        		$this->query="UPDATE par_compo01 set pxr = 0, status = 'D' where id_preoc = $id_preoc and cve_doc = '$doco'";
				        		$rs=$this->EjecutaQuerySimple();
				        		throw new Exception("Se esta tratando de solicitar mas de lo debido, se reporta a Direccion");
				        		return $rs;
				        	}
				        	echo 'Cantidad de los pendientes pxr: '.$pxr.' valor de Cantidad Original: '.$co.'<p>';
				        	if ($pxr <= $co){
				        		$query = "UPDATE PAR_COMPO01 SET";
					    		$query .= " pxr= (pxr - $pxr) ,";
					    		$query .= " status = 'L', ";
					    		$query .= " status_log2 = 'Cancelado'";
					    		$query .= " WHERE id_preoc = $id_preoc and cve_doc = '$doco'";
					    		$this->query = $query;
					    		$result = $this->EjecutaQuerySimple();

				        		$query = "UPDATE PREOC01 SET";
								$query .= " rest= (rest + $pxr),";
								$query .= " canti= (rest + $pxr),";
								$query .= " ordenado= ordenado - $pxr,";
								$query .= " status='F'";
								$query .= " WHERE id=$id_preoc";
								$this->query = $query;
								$this->EjecutaQuerySimple();
								$this->libSaldo($id_preoc, $pxr, $doco);
								echo 'Se ha liberado y registrado;'.'<p>';
							}
	        		} 
        	}elseif($status =='Tesoreria' and substr($doco,0,2)=='OP'){
        			$usuario =$_SESSION['user']->NOMBRE;
					$this->query="SELECT p.clave, p.nombre, oc.fecha_elab FROM FTC_POC oc left join prov01 p on p.clave=oc.cve_prov WHERE OC = '$doco'";
					$rs=$this->EjecutaQuerySimple();
					$row=ibase_fetch_object($rs);
					$cveprov=$row->CLAVE;
					$nomprov = $row->NOMBRE;
					$fecha = $row->FECHA_ELAB;
					$this->query="SELECT * FROM FTC_POC_DETALLE ftd left join ftc_poc ftc on ftc.oc = ftd.oc where ftd.OC = '$doco' AND ftd.PARTIDA = $par";
					$res=$this->EjecutaQuerySimple();
					$row2=ibase_fetch_object($res);
					//var_dump($row2);
					$this->query="INSERT INTO LIB_PARTIDAS (ID, IDPREOC, CANTIDAD, PROVEEDOR, NOMBRE_PROVEEDOR, OC, FECHA_OC, PARTIDA_OC, USUARIO, FECHA ) 
									VALUES (NULL, 
										$row2->IDPREOC, 
										$row2->PXR , 
										(SELECT CVE_PROV FROM FTC_POC WHERE CVE_DOC = '$doco'), 
									(SELECT NOMBRE FROM PROV01 WHERE CLAVE = (SELECT CVE_PROV FROM FTC_POC WHERE CVE_DOC = '$doco')), 
									'$doco', 
									'$row2->FECHA_OC', 
									$par, 
									'$usuario', 
									current_timestamp
								)";

					$rs=$this->EjecutaQuerySimple();
					//echo $this->query;
					if($rs){
						echo 'Entro a la liberacion';	
							$dao = new idpegaso;
							$idp = $dao->revisaDuplicado($id_preoc);
							var_dump($idp);

							$co = $idp['original'];
							/*
								["ordenado"]=>
								  float(200)
								  ["recibido"]=>
								  float(162)
								  ["pendiente"]=>
								  float(0)
								  ["original"]=>
								  float(200)
								  ["status"]=>
								  string(1) "B"
								  ["ID"]=>
								  string(6) "159863"
							*/							
				        	if (($row2->PXR + $idp['recibido']) <= $co ){
				        		$canti = $co - ($idp['ordenado'] - $row2->PXR);
				        		$rest = $co - ($idp['ordenado'] - $row2->PXR);
				        		$ordenado= $idp['ordenado'] - $row2->PXR;
				        		echo 'entra a liberacion a devolver: '.$pxr.' recibido al momento'.$idp['recibido'].' original '.$idp['original'].'<br/>';
				        		$this->query = "SELECT iif(sum(cantidad) is null, 0, sum(cantidad)) as cantpedida FROM FTC_POC_DETALLE WHERE IDPREOC = $id_preoc and status = '2'";
				        		$rs=$this->QueryObtieneDatosN();
				        		$row=ibase_fetch_object($rs);
				        		$cp = $row->CANTPEDIDA;
				        		$this->query="UPDATE preoc01 set canti= $canti, rest=$rest, ordenado= $ordenado, status= 'F' where id=$id_preoc";
				        		$rs= $this->EjecutaQuerySimple();
				        		echo $this->query;
				        		$this->query="UPDATE FTC_POC_DETALLE set pxr = 0, status = 4, status_real = 'Cancelada' where idpreoc = $id_preoc and oc = '$doco' and partida = $row2->PARTIDA";
				        		$rs=$this->EjecutaQuerySimple();
				        		//throw new Exception("Se esta tratando de solicitar mas de lo debido, se reporta a Direccion");
				        		return $rs;
				        	}
				        	echo 'Cantidad de los pendientes pxr: '.$pxr.' valor de Cantidad Original: '.$co.'<p>';
				        	/*if ($pxr <= $co){
				        		$query = "UPDATE FTC_POC_DETALLE SET";
					    		$query .= " pxr= (pxr - $pxr) ,";
					    		$query .= " status = 3, ";
					    		$query .= " status_log2 = 'Cancelado'";
					    		$query .= " WHERE idpreoc = $id_preoc and oc = '$doco'";
					    		$this->query = $query;
					    		$result = $this->EjecutaQuerySimple();

				        		$query = "UPDATE PREOC01 SET";
								$query .= " rest= (rest + $pxr),";
								$query .= " canti= (rest + $pxr),";
								$query .= " ordenado= ordenado - $pxr,";
								$query .= " status='F'";
								$query .= " WHERE id=$id_preoc";
								$this->query = $query;
								$this->EjecutaQuerySimple();
								$this->libSaldo($id_preoc, $pxr, $doco);
								echo 'Se ha liberado y registrado;'.'<p>';
							}*/
	        		} 

        		$this->query="SELECT sum(cantidad_REC) as cantidad FROM FTC_DETALLE_RECEPCIONES WHERE ORDEN = '$doco'";
        		$rs=$this->EjecutaQuerySimple();
        		$row=ibase_fetch_object($rs);
        		if($row->CANTIDAD > 0){
        			$this->query="UPDATE FTC_POC SET STATUS = 'CANCELADA_PAR' WHERE OC = '$doco'";
        			$rs=$this->EjecutaQuerySimple();
        		}else{
        			$this->query="UPDATE FTC_POC SET STATUS = 'CANCELADA_TOT' where OC = '$doco'";
        			$rs=$this->EjecutaQuerySimple();	
        		}

        	}
			return;
	}


	function libSaldo($id_preoc, $pxr, $doco){
		$usuario = $_SESSION['user']->NOMBRE;

		if(substr($doco,0,2) == 'OP'){
			$b="SELECT a.costo, b.cve_prov
				from FTC_POC_DETALLE a 
				left join ftc_poc b on a.oc = b.oc
				where a.oc = '$doco' and a.idpreoc = $id_preoc";
			$this->query=$b;
			$result=$this->EjecutaQuerySimple();
			$row=ibase_fetch_object($result);
			$costo = $row->COSTO;
			$prov = $row->CVE_PROV;
		}else{
			$b="SELECT a.cost, b.cve_clpv
			from par_compo01 a 
			left join compo01 b on b.cve_doc = a.cve_doc
			where a.cve_doc = '$doco' and a.id_preoc = $id_preoc";
			$this->query=$b;
			$result=$this->QueryObtieneDatosN();
			$row=ibase_fetch_object($result);
			$costo=$row->COST;
			$prov=$row->CVE_CLPV;
		}
		
		$a="UPDATE PROV01 SET SALDO_LIBERADO = SALDO_LIBERADO + ($costo * $pxr) where clave = '$prov'";
		$this->query=$a;
		$this->EjecutaQuerySimple();

		$this->query="INSERT INTO LIBERACIONES (ID, ORDEN, ID_PREOC, CANTIDAD, COSTO, COSTO_TOTAL, IVA,  PROVEEDOR,  USUARIO, FECHA ) VALUES (NULL, '$doco', $id_preoc,  $pxr, $costo, ($pxr * $costo) * 1.16, ($pxr * $costo) *.16, '$prov', '$usuario', current_timestamp )";
		$this->EjecutaQuerySimple();
		//echo $this->query;
		//break;
		return;
	}

function ReEnrutar($id_preoc, $pxr, $doco){
		$usuario = $_SESSION['user']->USER_LOGIN;
		$data=array();
		if(substr($doco, 0, 2) == 'OP' ){
			$this->query="SELECT * FROM FTC_POC WHERE OC = '$doco'";
			$rs=$this->EjecutaQuerySimple();
			$row = ibase_fetch_object($rs);
			$fecha = $row->FECHA_OC;
			$unidad = $row->UNIDAD;
			$s_log = $row->STATUS_LOG;
			$idu = $row->IDU;
			$vuelta = $row->VUELTAS;
			$secuencia = $row->SECUENCIA;
			$fechas = $row->FECHA_SECUENCIA;
			$s_log2 = $row->STATUS_LOG2;

		}else{
			$getData="SELECT * FROM COMPO01 WHERE CVE_DOC = '$doco'";
			$this->query = $getData;
			$result=$this->QueryObtieneDatosN();
			$row=ibase_fetch_object($result);
			$fecha=$row->FECHAELAB;
			$unidad=$row->UNIDAD;
			$s_log=$row->STATUS_LOG;
			$idu=$row->IDU;
			$vuelta=$row->VUELTAS;
			$secuencia=$row->SECUENCIA;
			$fechas=$row->FECHA_SECUENCIA;
			$s_log2=$row->STATUS_LOG2;
		}

		if(empty($idu)){
			$idu = 0;
		}
		if(empty($secuecia)){
			$secuencia = 0;
		}
		if(empty($fechas)){
			$fechas='01.01.2017';
		}

		$b="INSERT INTO LOG_REENRUTAR (DOCUMENTO, FECHA_DOC, FECHA, USUARIO, UNIDAD, STATUS_LOG, IDU, VUELTAS, SECUENCIA, FECHA_SECUENCIA, STATUS_LOG2)
			VALUES ('$doco', '$fecha', current_timestamp, '$usuario', '$unidad', '$s_log', $idu, $vuelta, $secuencia, '$fechas', '$s_log2')";
		$this->query=$b;

		$result=$this->EjecutaQuerySimple();
		
		if(substr($doco,0,2) == 'OP'){

			$this->query="UPDATE FTC_POC_DETALLE SET STATUS_REAL = 'LOGISTICA 2' WHERE OC = '$doco'";
			$this->EjecutaQuerySimple();


			$a="UPDATE ftc_poc set unidad = null, ruta = 'N', status_log ='Nuevo', idu = null, vueltas = vueltas + 1, secuencia = null, fecha_secuencia = null, status_log2 = 'R', status_recepcion = null, status = 'LOGISTICA' where oc = '$doco'";
		}else{
			$a="UPDATE compo01 set unidad = null, ruta = 'N', status_log ='Nuevo', idu = null, vueltas = vueltas + 1, secuencia = null, fecha_secuencia = null, status_log2 = 'R', status_recepcion = null where cve_doc = '$doco'";
		}
		$this->query=$a;
		$result=$this->EjecutaQuerySimple();

		$result+=$this->VueltaPartida($id_preoc, $pxr, $doco);
		return $result;
	}



	function VueltaPartida($id_preoc, $pxr, $doco){
		
		if(substr($doco,0,2) == 'OP'){
			$this->query="UPDATE FTC_POC_DETALLE SET STATUS_LOG2 = NULL, vuelta = vuelta +1 where oc = '$doco' and pxr !=0";
			$this->EjecutaQuerySimple();

		}else{
			$this->query="UPDATE PAR_COMPO01 SET STATUS_LOG2 = null, vuelta = vuelta + 1 where cve_doc  = '$doco' and pxr != 0";
			$this->EjecutaQuerySimple();
		}

		return;
	}

       function traeConceptoGastos() {
        $this->query = "SELECT ID, CONCEPTO, PRESUPUESTO FROM CAT_GASTOS WHERE ACTIVO = 'S'";
        $resultado = $this->QueryObtieneDatosN();
        while ($tsArray = ibase_fetch_object($resultado)) {
            $data[] = $tsArray;
        }
        return $data;
    }
        
        function traeImpuestoGasto($concepto){
            $this->query = "SELECT CAUSA_IVA,IVA,ISR,FLETE FROM CAT_GASTOS WHERE ID = $concepto";
            $resultado = $this->QueryObtieneDatosN();
            while($tsArray = ibase_fetch_object($resultado)){
                $data[] = $tsArray;
            }
            return $data;
        }

        function traeClasificacionGastos(){
            $this->query = "SELECT * FROM CLA_GASTOS WHERE ACTIVO = 'S'";
            $resultado = $this->QueryObtieneDatosN();
            while($tsArray = ibase_fetch_object($resultado)){
                $data[] = $tsArray;
            }
            return $data;
        }

        function dataClasificacion($id){
            $this->query = "SELECT * FROM CLA_GASTOS WHERE ID = $id";
            $resultado = $this->QueryObtieneDatosN();
            while($tsArray = ibase_fetch_assoc($resultado)){
                $data[] = $tsArray;
            }
            return $data;
        }
     
         function guardaCambiosCG($id,$clasif,$descripcion,$activo){
            $this->query="UPDATE CLA_GASTOS SET CLASIFICACION = '$clasif', DESCRIPCION = '$descripcion', ACTIVO = '$activo' WHERE ID = $id";
            $resultado = $this->EjecutaQuerySimple();
            return $resultado;
        }
        
        function guardaNuevaClaGasto($clasif,$descripcion){
            $this->query="INSERT INTO CLA_GASTOS (CLASIFICACION, DESCRIPCION) VALUES ('$clasif','$descripcion')";
            $resultado = $this->EjecutaQuerySimple();
            return $resultado;
        }
    
	function verEntregas(){
		$a="SELECT a.*,  e.nombre, c.CVE_DOC as Remision, d.cve_doc as FACTURA, c.fechaelab as FECHAREM, d.FECHAELAB as FECHAFAC
			FROM CAJAS a 
			left join FACTP01 b ON a.cve_fact = b.cve_doc
			left join FACTR01 c on a.cve_fact = c.doc_ant
			left join FACTF01 d on a.cve_fact = d.doc_ant
			left join clie01 e on b.cve_clpv = e.clave
			WHERE a.STATUS_LOG = 'Entregado' and CONTRARECIBO IS NULL";
		$this->query=$a;
		$result = $this->QueryObtieneDatosN();
		while($tsArray=ibase_fetch_object($result)){
        		$data[]=$tsArray;
        	}  
        return $data;
	}

	function verNoEntregas(){   //21
		$data=array();
		$a="SELECT a.*,  e.nombre, a.remision as Remisiondoc, 
			a.factura as FACTURADOC,
			coalesce ((select fr.fechaelab from factr01 fr where fr.cve_doc = a.remision), a.fecha_cierre, a.fecha_creacion) as fecharem,
			coalesce ((select ff.fechaelab from factf01 ff where ff.cve_doc = a.factura), (select fecha_doc from ftc_facturas where documento = a.factura)) as fechafac
			FROM CAJAS a 
			left join FACTP01 b ON a.cve_fact = b.cve_doc
			left join clie01 e on b.cve_clpv = e.clave
			WHERE a.STATUS_LOG = 'NC'
			and status_recepcion >= 5
			and (a.fecha_secuencia >= '15.01.2018' or a.fecha_secuencia is null)
			";
			//or a.status_log = 'Reenviar' or a.status_log = 'recibido'
		$this->query=$a;
		$result = $this->QueryObtieneDatosN();
		while($tsArray=ibase_fetch_object($result)){
        		$data[]=$tsArray;
        	}  
        return $data;
	}

	function insContra($cr, $idc, $docf){
		$a="UPDATE CAJAS SET CONTRARECIBO = '$cr' 
			where CVE_FACT = '$docf' and id = $idc";
		$this->query=$a;
		$result = $this->EjecutaQuerySimple();
		return $result;
	}

	function verFacturas(){        //26072016 Aduana  debe mostrar aquí tambien regresan los facturados y devueltos
            $a="SELECT c.*, FOLIO_RECMCIA as folio_rm, c.status_log as resultado, cl.nombre, f.cve_doc, f.impreso, iif(f.cve_doc is null, r.cve_doc, f.cve_doc) as doc, iif(f.fechaelab is null, r.fechaelab, f.fechaelab) as fechaelab, c.cve_fact as pedido,datediff(day, c.fecha_secuencia, current_timestamp) as dias, sol_des_aduana as Solucion
            	from cajas c
				left join factp01 p on p.cve_doc = c.cve_fact 
 				left join factf01 f on f.cve_doc = c.factura
				left join factr01 r on r.cve_doc = c.remision
				left join clie01 cl on p.cve_clpv = cl.clave
				where (c.status_log = 'Entregado' or c.status_log = 'Bodega' or c.status_log = 'Reenviar' or c.status_log = 'NC' or c.status_log='BodegaNC' or c.status_log ='Deslinde' or c.status_log = 'Envio' or c.status_log = 'Facturado' or c.status_log = 'Devuelto' or c.status_log = 'Recibido') 
					and f.impreso is null
					and c.fecha_creacion >= '09.07.2016'
					and (aduana = 'Facturado' or aduana = 'Devuelto' or aduana = 'Acuse' or aduana is null or aduana = '' or aduana = 'Deslinde Cobranza' or aduana ='Solucion Deslinde' or aduana = 'Solucion Deslinde 2p' or aduana = 'Solucion Deslinde NC')"; 
         $this->query= $a;
         $result=$this->EjecutaQuerySimple();
         while($tsArray=ibase_fetch_object($result)){
         	$data[]=$tsArray;
         }
			return $data;
	}
        
        function verFacturasCompF($docf, $docp, $idcaja){        //20062016
            $this->query="SELECT   a.CVE_DOC AS FACTURA, a.FECHAELAB AS FECHA_FACTURA, b.nombre AS CLIENTE,
                                    p.cve_fact as pedido, p.unidad AS UNIDAD, p.idu,
                                    p.status_log, p.docs, p.CIERRE_TOT, p.motivo,
                                    p.id AS CAJA, a.impreso, a.status_log as Resultado
                           FROM FACTF01 a
                           INNER JOIN CLIE01 b ON a.cve_clpv = b.clave
                           INNER JOIN cajas p on a.doc_ant = p.cve_fact
                           WHERE  a.CVE_DOC = '$docf' AND p.CVE_FACT = '$docp' AND p.id =  $idcaja";
            	$result=$this->QueryObtieneDatosN();
		while ($tsArray=ibase_fetch_object($result)){
			$data[]=$tsArray;
		}
		return $data;  
        }
        
        function insertaRevFact($docf, $docp, $idcaja, $tipo){
            $this->query="EXECUTE PROCEDURE insert_revfact('$docf','$docp',$idcaja,'$tipo')";
            $resultado = $this->QueryObtieneDatosN();
            while($tsArray = ibase_fetch_object($resultado)){
                $data[] = $tsArray;
            }
           // var_dump($data);
            return $data;
        }

    function actualizaStatusCaja($idcaja){      //21
            $this->query="UPDATE CAJAS SET status_log = 'Recibido' WHERE id = $idcaja";
            $resultado = $this->EjecutaQuerySimple();
            return $resultado;
    }
        //fin 20062016

	function recDocFact($docf, $docp, $idcaja){
		$b="UPDATE CAJAS SET DOCS = 'No' where id = $idcaja";
		$this->query=$b;
		$result=$this->EjecutaQuerySimple();
		return $result; 
	}

	function recDocFactNC($docf, $docp, $idcaja){
		$b="UPDATE CAJAS SET DOCS = 'No' where id = $idcaja";
		$this->query=$b;
		$result=$this->EjecutaQuerySimple();
		return $result; 
	}

	function imprimeReciboFact($docf, $docp, $idcaja){
		$a="SELECT * 
			FROM FACTF01 
			WHERE CVE_DOC='$docf'";
		$this->query=$a;
		$result=$this->EjecutaQuerySimple();
		$result+=$this->infoPedido();
		$result+=$this->infolog();
		$result+=$this->infoCom();
		$result+=$this->infoPreOC();
		return $result;
	}

	function verembalaje($id, $docf){

		$a="SELECT * FROM PAQUETES WHERE IDCAJA = $id and documento = '$docf' and devuelto < cantidad ";
		$this->query=$a;
		$result=$this->QueryObtieneDatosN();
		while ($tsArray=ibase_fetch_object($result)){
			$data[]=$tsArray;
		}

		return @$data;
	}

	function devueltoNC($id, $docf){
		$a="SELECT * FROM PAQUETES WHERE idcaja = $id and devuelto > 0";
		$this->query=$a;
		$result=$this->QueryObtieneDatosN();
		while($tsArray=ibase_fetch_object($result)){
			$data[]=$tsArray;
		} 
		return @$data;
	}

    function recibeCaja($id, $docf, $idc){    //21
		$a="UPDATE CAJAS set status_mer = 'recibido' where id = $idc and cve_fact = '$docf'";
		$this->query =$a;
		$result=$this->EjecutaQuerySimple();
		$result+=$this->InsertaFolio($id, $docf, $idc); 
		return $result;

	}

	function InsertaFolio($id,$docf, $idc){
		$usuario = $_SESSION['user']->USER_LOGIN;
		$z="SELECT max(f.cve_doc) as FACT, max(f.fechaelab) as FECHAFACT, max(p.cve_doc) as remi, max(p.fechaelab) as fecharemi 
			FROM factp01 a
			left join factf01 f on f.doc_ant= '$docf'  
			left join factr01 p on p.doc_ant= '$docf'
 			WHERE a.cve_doc = '$docf'
 			group by a.cve_doc";
 		$this->query=$z;
 		$result=$this->QueryObtieneDatosN();
 		$row=ibase_fetch_object($result);
 		$factura=$row->FACT;
 		$remision = $row->REMI;
 		$ffact=$row->FECHAFACT;
 		$fremi=$row->FECHAREMI;

 		if(is_null($ffact)){
 			$ffact = '01/01/2016';
 		}elseif(is_null($fremi) ){
 			$fremi = '01/01/2016';
 		}

		$a="INSERT INTO RECMCIA (IDCAJA, IDU, PEDIDO, FACTURA, REMISION, FECHA_RECEP, USUARIO, SERIE, FECHA_FACT, FECHA_PEDI, RECIBIDO)
			VALUES ($idc, $idc ,'$docf', '$factura', '$remision', current_timestamp ,'$usuario','R','$ffact','$fremi', 'No')";
		$this->query=$a;
		$result=$this->EjecutaQuerySimple();

		$b="SELECT ID as FOLIO FROM RECMCIA WHERE IDCAJA = $idc and RECIBIDO = 'No'";
		$this->query=$b;
		$result=$this->QueryObtieneDatosN();
		$row=ibase_fetch_object($result);
		$folio=$row->FOLIO;

		$c="UPDATE CAJAS SET FOLIO_RECMCIA = $folio, aduana = null WHERE ID = $idc";
		$this->query = $c;
		$result = $this->EjecutaQuerySimple();
		return $result;

	}

    function statusImpresoCaja($id){ //21        
            $this->query = "EXECUTE PROCEDURE SP_Status_Bodega($id)";
            $resultado = $this->EjecutaQuerySimple();
            return $resultado;
        }
        //14062016
        
        function traeDocumentosxCliente(){
        	$data=array();
           $this->query="SELECT * FROM CATALOGO_DOCUMENTOS";
           $resultado = $this->QueryObtieneDatosN();
           while($tsArray = ibase_fetch_object($resultado)){
               $data[] = $tsArray;
           }
           return $data;
        }
        
        function guardaNuevoDocC($nombre, $descripcion, $tipoDoc, $tipoReq){
            $this->query="EXECUTE PROCEDURE SP_DOCUMENTOC_NUEVO('$nombre', '$descripcion', '$tipoDoc', '$tipoReq')";
            $resultado = $this->EjecutaQuerySimple();
            return $resultado;
        }
        
        function  traeDocumentoC($id){
            $this->query="SELECT * FROM CATALOGO_DOCUMENTOS WHERE ID = $id";
           $resultado = $this->QueryObtieneDatosN();
           while($tsArray = ibase_fetch_object($resultado)){
               $data[] = $tsArray;
           }
           return $data;
        }

        function guardaCambiosDocC($activo,$nombre,$descripcion,$id, $tipoReq, $tipoDoc){
        	$this->query = "EXECUTE PROCEDURE SP_MODIFICA_DOCUMENTOC('$activo','$nombre','$descripcion',$id, '$tipoReq', '$tipoDoc')";
            $resultado = $this->EjecutaQuerySimple();
         
            return $resultado;
        }
        
        function traeClientesParaDocs(){
        	$data=array();
            $this->query = "SELECT * FROM CATALOGO_CLIENTES_DOCS";
            $resultado = $this->QueryObtieneDatosN();
            while($tsArray = ibase_fetch_object($resultado)){
                $data[] = $tsArray;
            }
            return $data;
        }

        function quitarReq($cl, $iddoc){
        	$usuario = $_SESSION['user']->NOMBRE;
        	$this->query="UPDATE DOCS_CLIENTE SET REQUERIDO = 'N', FECHA = current_timestamp, USUARIO= '$usuario' WHERE CVE_CLI = '$cl' and ID_DOC = $iddoc";
        	$this->queryActualiza();

        	return $response=array("status"=>'ok', "mensaje"=>'Se Quito');
        }
        
        function traeDocumentosCliente($clave){
            $data= array();
            $this->query = "SELECT * FROM SP_DOCUMENTOS_CLIENTE('$clave', 0)";
            $resultado = $this->QueryObtieneDatosN();
            while($tsArray = ibase_fetch_object($resultado)){
                $data[] = $tsArray;
            }
            //exit(var_dump($data));
            return $data;
        }

        function ordenaDocs($clie, $iddoc, $orden){
        	$usuario=$_SESSION['user']->NOMBRE;
        	$this->query="SELECT * FROM DOCS_CLIENTE WHERE CVE_CLI = '$clie' and REQUERIDO = 'S'";
        	$res=$this->EjecutaQuerySimple();
        	while($tsArray = ibase_fetch_object($res)){
        		$data[]=$tsArray;
        	}

        	$this->query="UPDATE DOCS_CLIENTE SET POSICION = $orden, FECHA= current_timestamp, usuario ='$usuario' WHERE CVE_CLI = '$clie' AND id_doc =$iddoc and REQUERIDO = 'S'";
        	$this->EjecutaQuerySimple();
        	return $mensaje=array("status"=>'ok');
        }
        
        function NuevoDocCliente($cliente,$requerido,$copias,$documento){
        	$usuario = $_SESSION['user']->NOMBRE;
        	$this->query="SELECT count(cve_cli) as val from DOCS_CLIENTE where trim(cve_cli) = trim('$cliente') and id_doc =$documento";
        	$rs=$this->EjecutaQuerySimple();
        	$row=ibase_fetch_object($rs);
        	if($row->VAL == 0){
        		$this->query="EXECUTE PROCEDURE SP_ASIGNA_DOCUMENTOC('$cliente',$documento,'$requerido',$copias, '$usuario')";
            	$resultado = $this->EjecutaQuerySimple();
        	}elseif($row->VAL == 1){
        		$this->query="UPDATE DOCS_CLIENTE SET REQUERIDO = 'S', fecha=CURRENT_TIMESTAMP, usuario = '$usuario' WHERE cve_cli = '$cliente' and id_doc = $documento";
        		$resultado=$this->queryActualiza();
        	}
            //var_dump($cliente);
            //var_dump($this->query);
            return $resultado;
        }

		function FolioRecMcia($id, $docf, $docr, $fact){
        	$this->query = "SELECT idu, max(id) as id, max(usuario) as usuario, max(fecha_recep) as fecha_recep, max(factura) as factura, max(remision) as remision
        					FROM RECMCIA 
        					WHERE idcaja=$id group by idu";
        	$resultado = $this->QueryObtieneDatosN();
        	while($tsArray=ibase_fetch_object($resultado)){
        		$data[]=$tsArray;
        	}
        	return $data;
        }

	function verNoEntregasImpresas(){       //22062016
		$a="SELECT a.*,  e.nombre, c.CVE_DOC as Remision, d.cve_doc as FACTURA, c.fechaelab as FECHAREM, d.FECHAELAB as FECHAFAC
			FROM CAJAS a 
			left join FACTP01 b ON a.cve_fact = b.cve_doc
			left join FACTR01 c on a.cve_fact = c.doc_ant
			left join FACTF01 d on a.cve_fact = d.doc_ant
			left join clie01 e on b.cve_clpv = e.clave
			WHERE a.STATUS_LOG = 'Recibido' AND  CONTRARECIBO IS NULL";
		$this->query=$a;
		$result = $this->QueryObtieneDatosN();
		while($tsArray=ibase_fetch_object($result)){
        		$data[]=$tsArray;
        	}  
        return $data;
	}

	function recibirCajaNC($id, $docf, $idc, $idpreoc, $cantr, $motivo){
		$usuario=$_SESSION['user']->NOMBRE;
		if($id == 'T'){
				echo 'Entro a la devolucion Total de la factura: '.$docf.' con la caja '.$idc;
				$this->query="SELECT * FROM PAQUETES WHERE IDCAJA = $idc and devuelto != cantidad";
				$rs=$this->EjecutaQuerySimple();
				while ($tsArray=ibase_fetch_object($rs)) {
					$data[]=$tsArray;
				}
				foreach($data as $key){
						$cantr = $key->CANTIDAD;
						$id = $key->ID;
						$idpreoc = $key->ID_PREOC;
						$c="UPDATE preoc01 set devuelto = $cantr where id =$idpreoc";
						$this->query=$c;
						$result=$this->queryActualiza();
						$d="UPDATE PAQUETES SET Devuelto =  $cantr, motivo = '$motivo', usuario_dev = '$usuario', fecha_ultima_dev = current_timestamp, status = 'DEVOLUCION' where id = $id";
						$this->query = $d;
						$result=$this->queryActualiza();
						$this->query="UPDATE PAR_FACTF01 SET VALIDACION = 'OK' WHERE CVE_DOC = (select factura from cajas where id = $idc)";
						//echo 'libera la partida: '.$this->query;
						$rs=$this->queryActualiza();
						if($rs >= 1 ){
							$this->query="UPDATE FACTF01 SET VALIDACION = 'Total' WHERE CVE_DOC = (select factura from cajas where id = $idc)";
							//echo 'libera la factura: '.$this->query;
							$this->queryActualiza();	
						
							//// aqui se hace la NC de la factura.

							/// Finaliza la NC de la Factura.
						}
				}				
		}else{
			$c="UPDATE preoc01 set devuelto = iif(devuelto is null, $cantr, devuelto + $cantr) where id =$idpreoc";
			$this->query=$c;
			$result=$this->EjecutaQuerySimple();
			$this->query="UPDATE PAQUETES SET Devuelto = (devuelto + $cantr), motivo = '$motivo', usuario_dev = '$usuario', fecha_ultima_dev=current_timestamp, status = 'DEVOLUCION' where id = $id";
			$this->queryActualiza();
			$this->query="UPDATE PAR_FACTF01 SET VALIDACION = 'OK' WHERE CVE_DOC = (select factura from cajas where id = $idc)";
			//echo 'libera la partida: '.$this->query;
			$rs=$this->queryActualiza();
			if($rs == 1 ){
				$this->query="UPDATE FACTF01 SET VALIDACION = 'Parcial' WHERE CVE_DOC = (select factura from cajas where id = $idc)";
				//echo 'libera la partida: '.$this->query;
				$this->queryActualiza();
			}
			/// permitimos la creacion de NC para esa Partida:
		}
		//// aqui va el codigo para liberar el pedido.
		return $result;
	}

	 function procesarDev($idp, $cantDec, $tipo, $origen){
		$usuario=$_SESSION['user']->NOMBRE;
		//exit('IDP'.$idp.' , cantDec'.$cantDec);
		if($origen == 'CAJA'){
			$this->query="SELECT * FROM PAQUETES WHERE ID = $idp";
			$rs=$this->EjecutaQuerySimple();
			$row = ibase_fetch_object($rs);
			$val = $row->STATUS;

			if($val== 'DEVOLUCION'){
				$this->query="UPDATE PAQUETES SET STATUS = '$tipo' where id = $idp";
				$this->EjecutaQuerySimple();
				if($tipo == 'ingresoBodega'){
					$this->query="INSERT INTO INGRESOBODEGA (PRODUCTO, DESCRIPCION, CANT, FECHA, MARCA, Proveedor, Costo, unidad, restante, usuario, origen) 
			    	VALUES ('$row->ARTICULO',(select nombre from producto_ftc where clave = '$row->ARTICULO'), $cantDec, current_timestamp, 'DEV-'||$row->FOLIO_DEV, '', (select costo_ventas from producto_ftc where clave = '$row->ARTICULO'), '', $cantDec,'$usuario', 'Devolucion')";
			    	$rs =  $this->EjecutaQuerySimple();		
				}
			}else{
				return array("status"=>'proc', "valida"=>$val);
			}
		}elseif($origen == 'INGBOD' ){

			$this->query="SELECT STATUS FROM INGRESOBODEGA WHERE ID = $idp";
			$rs=$this->EjecutaQuerySimple();
			$row=ibase_fetch_object($rs);
				if(empty($row->STATUS)){
						if($tipo == 'devProv'){
							$status = 3;
						}elseif ($tipo == 'ingresoBodega') {
							$status = 1;
						}elseif($tipo == 'merma'){
							$status = 4;
						}
						$this->query="UPDATE INGRESOBODEGA SET STATUS = $status where id = $idp";
						$this->EjecutaQuerySimple();	
				}else{
					return array("status"=>'proc', "valida"=>$val);
				}
		}
		return array("status"=>'ok', "valida"=>'ok');
	}


	function IngresarBodega($desc, $cant, $marca, $proveedor, $costo, $unidad){
    	$desc = explode(":", $desc);
    	$prod = trim($desc[0]);
    	$descripcion = $desc[1];
    	$usuario = $_SESSION['user']->NOMBRE;
    	$this->query="INSERT INTO INGRESOBODEGA (PRODUCTO, DESCRIPCION, CANT, FECHA, MARCA, Proveedor, Costo, unidad, restante, usuario, origen) 
    	VALUES ('$prod',(select nombre from producto_ftc where clave = '$prod'), $cant, current_timestamp, '$marca', '$proveedor', (select costo_ventas from producto_ftc where clave = '$prod'), '$unidad', $cant,'$usuario', 'Directo')";
    	$rs =  $this->EjecutaQuerySimple();
    	
    	$this->query="SELECT MAX(ID) AS FOLIO FROM INGRESOBODEGA";
    	$rs=$this->EjecutaQuerySimple();
    	$row=ibase_fetch_object($rs);
    	$folio=$row->FOLIO;
    	return $folio;
    }


	function verRecepSinProcesar(){
		$this->query="SELECT p.id, p.DOCUMENTO, PRE.NOM_PROV, p.CANTIDAD, p.DEVUELTO, p.ARTICULO, p.DESCRIPCION, P.fecha_ultima_dev, P.FOLIO_DEV, P.MOTIVO, 'CAJA' AS ORI FROM PAQUETES P LEFT JOIN PREOC01 PRE ON PRE.ID = P.ID_PREOC  WHERE p.STATUS = 'DEVOLUCION' ";
		$rs=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($rs)) {
			$data[]=$tsArray;
		}
		$this->query="SELECT id as id ,ib.DOCUMENTO, P.NOMBRE AS NOM_PROV, ib.CANT AS CANTIDAD, ib.CANT AS DEVUELTO, ib.PRODUCTO AS ARTICULO, (SELECT NOMBRE FROM PRODUCTO_FTC WHERE CLAVE = ib.producto) as descripcion, ib.fecha as fecha_ultima_dev, 'N/A' as folio_dev, 'Orden Interna' as Motivo, 'INGBOD' AS ORI FROM INGRESOBODEGA ib left join prov01 p on p.clave = ib.proveedor where ib.origen = 'Orden Interna' and ib.status = 0";
		//echo $this->query;
		$res=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($res)) {
			$data[]=$tsArray;
		}

		return $data;
	}


	function guardaContraRecibo($contrarecibo,$idcaja){         //22062016
            $this->query="EXECUTE PROCEDURE sp_nuevo_contrarecibo ('$contrarecibo',$idcaja)";
            $resultado = $this->EjecutaQuerySimple();
            return $resultado;
        }


	function avanzaCobranza($docf, $docp, $idcaja, $tipo, $nstatus){      //21
            $usuario = $_SESSION['user']->USER_LOGIN;
            switch(trim($nstatus)){
            	case 'Reenviar': /// la inicializa para que aparezca en Asignar unidad y cuenta + 1 en vueltas.
            		$status='Reenviar';
            		$getData="SELECT id, vueltas, status_log, unidad, idu, iif(cierre_uni is null, 'Sin Cierre', cierre_uni) as cierreu, iif(cierre_tot is null, 'Sin Cierre', cierre_tot) as cierret, iif(fletera is null, 'Sin Fletera',fletera) as fletera, iif(guia_fletera is null, 'Sin guia', guia_fletera) as guia, FECHA_SECUENCIA, iif(usuario_log is null, 'ninguno', usuario_log) as usuario_log  from CAJAS where id= $idcaja";
            		$this->query = $getData;
            		$result=$this->EjecutaQuerySimple();
            		$row=ibase_fetch_object($result);
            		$vueltas=$row->VUELTAS;
            		$sl = $row->STATUS_LOG;
            		$unidad = $row->UNIDAD;
            		$idu=$row->IDU;
            		$cierreu=$row->CIERREU;
            		$cierret=$row->CIERRET;
            		$fletera=$row->FLETERA;
            		$guia=$row->GUIA;
            		$fecha_sec=$row->FECHA_SECUENCIA;
            		$usu_log=$row->USUARIO_LOG;
            		$h="INSERT INTO HISTORIA_CAJA (IDCAJA, FECHA_MOV, H_STATUS, H_VUELTAS, H_STATUS_LOG, H_UNIDAD, H_IDU, H_CIERRE_UNI, H_CIERRE_TOT, H_FLETERA, H_GUIA, H_FECHA_SECUENCIA, H_USUARIO_LOG, H_USUARIO_ADUANA) 
            			values ($idcaja, current_timestamp, '$tipo', $vueltas , '$sl', '$unidad', $idu, '$cierreu', '$cierret', '$fletera', '$guia', '$fecha_sec', '$usu_log', '$usuario')";
            			//echo $h;
            		$this->query=$h;
            		$result=$this->EjecutaQuerySimple();

            		$a="UPDATE CAJAS SET
            			aduana = null, 
            			ruta = 'N', 
            			status='cerrado', 
            			vueltas = vueltas + 1, 
            			logistica = iif(logistica is null, '$tipo',(logistica||'-'||'$tipo')), 
            			unidad = null, 
            			fecha_secuencia = null, 
            			idu = null,
            			DOCS = 'No',
            			cierre_uni = null,
            			cierre_tot = null, 
            			fletera = null, 
            			guia_fletera = null, 
            			status_log = 'nuevo', 
            			secuencia = null, 
            			fecha_aduana = current_timestamp, 
            			usuario_aduana ='$usuario', 
            			reenvio = 'Si',
            			IMP_COMP_REENRUTAR = 'No',
            			status_mer = null 
            			where id = $idcaja";
            			//echo $a;
            		$this->query=$a;
            		$result=$this->EjecutaQuerySimple();

            		$b="UPDATE RECMCIA SET RECIBIDO = 'Si', fecha_recibo = current_date, usuario_recibo = '$usuario' where idcaja = $idcaja and recibido = 'No'";
            		$this->query=$b;
            		$result=$this->EjecutaQuerySimple();

            	break;
            	case 'Facturar':////La manda a la pantalla de Factuar Remisiones.
            		$status='Facturar';
            		$a="UPDATE CAJAS SET aduana = '$nstatus' , fecha_aduana = current_timestamp, usuario_aduana ='$usuario'  where id = $idcaja";
            	break;
            	case 'NC': //// La manda a la pantalla de Realizar Nota de Credito.
            		$status='NC';
            		$a="UPDATE CAJAS SET aduana ='$nstatus', fecha_aduana = current_timestamp, usuario_aduana ='$usuario'  where id = $idcaja";
            	break;
            	case 'Deslinde': /// La manda a la pantalla para que revisen el documento,
            		$status='Deslinde';
            		$a="UPDATE CAJAS SET ADUANA = '$nstatus', fecha_aduana = current_timestamp, usuario_aduana ='$usuario'  where id = $idcaja";
            	/*case 'Revision':
            		$status='Revision';
            		$a="UPDATE CAJAS SET ADUANA = '$nstatus', fecha_aduana = current_timestamp, usuario_aduana ='$usuario'  where id = $idcaja";*/
            	case 'Acuse':
            		$status='Acuse';
            		$a="UPDATE CAJAS SET ADUANA = '$nstatus', fecha_aduana = current_timestamp, usuario_aduana ='$usuario'  where id = $idcaja";
            	break;
            	case 'Revision':
            		$status='Revision';
            		
            		$this->query="UPDATE FACTF01 SET STATUS_FACT = 'Revision', status_log = '$status' where cve_doc = '$docf'";
            		$rs=$this->EjecutaQuerySimple();
            		
            		$a="UPDATE CAJAS SET ADUANA = '$nstatus', status_log='Recibido', fecha_aduana = current_timestamp, usuario_aduana ='$usuario'  where id = $idcaja";

            	break;
            	case 'Revision2p':
            		$status='Revision2p ';

            		$this->query="UPDATE FACTF01 SET STATUS_FACT = 'Revision', status_log = '$status' where cve_doc = '$docf'";
            		$rs=$this->EjecutaQuerySimple();
            		

            		$a="UPDATE CAJAS SET ADUANA = '$nstatus', status_log='Revision', fecha_aduana = current_timestamp, usuario_aduana ='$usuario' 
            		 where id = $idcaja";
            	break;
            	default:
            		$status='Errorparam';
            	break;
            }

		////$a="UPDATE FACTF01 SET STATUS_LOG = '$status' where cve_doc = '$docf'";
		$this->query=$a;
		$result=$this->EjecutaQuerySimple();

		//$b="UPDATE CAJAS SET status = 'Recibido' where id = $idcaja and cve_fact = '$docp'";
		//$this->query=$b;
        //        $result=$this->EjecutaQuerySimple();		        
		//$result=$this->EjecutaQuerySimple();		
		return $result;
	}



        function PendientesGenNC(){     //2306-
            $this->query="SELECT f.cve_doc AS FACTURA, f.doc_ant AS PEDIDO FROM factf01 f INNER JOIN CAJAS c on f.doc_ant = c.cve_fact
                            WHERE f.status_log = 'GenerarNC' AND c.status_log = 'Recibido' AND doc_sig IS NULL";            
            $resultado = $this->QueryObtieneDatosN();
            while($tsArray = ibase_fetch_object($resultado)){
                $data[] = $tsArray;
            }
            return @$data;
        }
        
        function PendientesGenRee(){     //2306-
            $this->query="SELECT f.cve_doc AS FACTURA, f.doc_ant AS PEDIDO,c.ID AS CAJA FROM factf01 f 
            				INNER JOIN CAJAS c on f.doc_ant = c.cve_fact
                            WHERE f.status_log = 'Reenviar' AND c.status_log = 'Recibido'";
            $resultado = $this->QueryObtieneDatosN();
            while($tsArray = ibase_fetch_object($resultado)){
                $data[] = $tsArray;
            }
            return $data;
        }

        function reenviaCaja($factura,$caja){
        	$this->query="UPDATE cajas SET ruta = 'N', STATUS = 'cerrado',fecha_cierre = null, completa = null, idu = null, secuencia = null, horai = null, horaf = null, cierre_uni = null, cierre_tot = null, caja = null, contrarecibo = null, motivo = null WHERE id = $caja ";
            $result=$this->EjecutaQuerySimple();		
			return $result;
        }

        function datosCobranzaC($idCliente){    //28062016
            $this->query = "SELECT ca.*, c.cve_maestro as clave_m, m.nombre as nombre_maestro, c.nombre, c.banco_deposito, c.banco_origen, c.metodo_pago, c.refer_Edo
            				FROM cartera ca 
            				left join clie01 c on trim(c.clave) = trim(ca.idCliente)
            				left join maestros m on c.cve_maestro= m.clave 
            				WHERE trim(ca.idcliente) = trim('$idCliente')";
            				//echo $this->query;
            $resultado = $this->QueryObtieneDatosN();
            while($tsArray = ibase_fetch_object($resultado)){
                $data[] = $tsArray;
            }
 
            return $data;
        }
        
        //28062016
        function salvarDatosCobranza($cliente,$carteraCob,$carteraRev,$diasRevision,$diasPago,$dosPasos,$plazo,$addenda,$portal,$usuario,$contrasena,$observaciones,$envio,$cp,$maps,$tipo,$ln,$pc, $bancoDeposito, $bancoOrigen, $referEdo, $metodoPago){
            $revision = implode(",",$diasRevision);
            $pago = implode(",",$diasPago);
            $this->query="EXECUTE PROCEDURE sp_inserta_datacobranza('$cliente','$carteraCob','$carteraRev','$revision','$pago','$dosPasos',$plazo,'$addenda','$portal','$usuario','$contrasena','$observaciones','$envio',$cp,'$maps','$tipo',$ln,'$pc')";
            $result=$this->EjecutaQuerySimple();
            
            $this->query="UPDATE CLIE01 SET CVE_MAESTRO = '$tipo', limcred = $ln, banco_deposito = '$bancoDeposito', banco_origen= '$bancoOrigen', refer_Edo = '$referEdo', metodo_pago = '$metodoPago', codigo = '$cp' where trim(clave) = trim('$cliente')";
            $rs=$this->EjecutaQuerySimple();

            return $result;
        }
        
        //28062016
        function salvarCambiosCobranza($cliente,$carteraCob,$carteraRev,$diasRevision,$diasPago,$dosPasos,$plazo,$addenda,$portal,$usuario,$contrasena,$observaciones,$envio,$cp,$maps,$tipo,$ln,$pc, $bancoDeposito, $bancoOrigen, $referEdo, $metodoPago){
            $revision = implode(",",$diasRevision);
            $pago = implode(",",$diasPago);
            $this->query="EXECUTE PROCEDURE sp_actualiza_datacobranza('$cliente','$carteraCob','$carteraRev','$revision','$pago','$dosPasos',$plazo,'$addenda','$portal','$usuario','$contrasena','$observaciones','$envio',$cp,'$maps','$tipo',$ln,'$pc','$bancoDeposito', '$bancoOrigen', '$referEdo', '$metodoPago')";
            $result=$this->EjecutaQuerySimple();

            return $result;
        }

    	function verCierreDiaEntregas(){         //27062016
            $this->query="SELECT a.*,  e.nombre, c.CVE_DOC as Remision, d.cve_doc as FACTURA, c.fechaelab as FECHAREM, d.FECHAELAB as FECHAFAC
                	FROM CAJAS a 
			left join FACTP01 b ON a.cve_fact = b.cve_doc
			left join FACTR01 c on a.cve_fact = c.doc_ant
			left join FACTF01 d on a.cve_fact = d.doc_ant
			left join clie01 e on b.cve_clpv = e.clave
					WHERE (a.STATUS_LOG = 'NC' or a.status_log = 'Reenviar' or a.status_log = 'recibido') AND a.cierre_tot is null ";
			$result = $this->QueryObtieneDatosN();
		        while($tsArray=ibase_fetch_object($result)){
		            $data[]=$tsArray;
		        }  
		        return $data;
        }
        
        
        function insertCierreDiaEntregas(){      //27062016
            $usuario = $_SESSION['user']->USER_LOGIN;
            $this->query="EXECUTE PROCEDURE SP_CIERRE_ENT('$usuario')";
            $result = $this->QueryObtieneDatosN();
            while($tsArray = ibase_fetch_object($result)){
                $data[] = $tsArray;
            }
            return $data;
        }

        function insCierreRutaRecoleccion(){    //27062016
            $usuario = $_SESSION['user']->USER_LOGIN;
            $this->query="EXECUTE PROCEDURE SP_CIERRE_REC('$usuario')";
            $result=$this->QueryObtieneDatosN();
            while($tsArray=ibase_fetch_object($result)){
                $data[]=$tsArray;
            }
            return $data;
        }

        function imprimeCierre($idu){
        	$a="SELECT c.*, p.nombre FROM COMPO01 c
        		left join prov01 p on p.clave = c.cve_clpv WHERE c.IDU = $idu and c.fecha_secuencia = current_date";
        	$this->query=$a;
        	$result=$this->QueryObtieneDatosN();
        	while ($tsArray=ibase_fetch_object($result)){
        		$data[]=$tsArray;
        	}
        	return $data;
        }

        function imprimeCierreCab($idu){
        	$a="SELECT max(UNIDAD) as unidad, max(fecha_secuencia) as fecha_secuencia FROM COMPO01 WHERE IDU = $idu and fecha_secuencia = current_date";
        	$this->query=$a;
        	$result=$this->QueryObtieneDatosN();
        	while ($tsArray=ibase_fetch_object($result)){
        		$data[]=$tsArray;
        	}
        	return $data;
        }

        function actCierreUni($idu){
        	$a="UPDATE COMPO01 SET CIERRE_UNI ='impreso' where idu = $idu and fecha_secuencia = current_date";
      		$this->query=$a;
      		$result =$this->EjecutaQuerySimple();
      		return $result;
        }

    function habilitaImpresionCierre($idr){
	    	$c="SELECT COUNT(CVE_DOC) as documentos FROM COMPO01 WHERE idu = $idr and fecha_secuencia = CURRENT_DATE ";
	    	$this->query = $c;
	    	////echo $c;

	    	$result=$this->EjecutaQuerySimple();
	    	$row= ibase_fetch_object($result);
	    	$TotalOC= $row->DOCUMENTOS;
	    	
	    	$d="SELECT COUNT(CVE_DOC) AS docc from compo01 where idu=$idr and fecha_secuencia = current_date and (cierre_uni is not null)";
	    	///echo $d;
	    	$this->query =$d;
	    	$result=$this->EjecutaQuerySimple();
	    	$row=ibase_fetch_object($result);
	    	$TotalOCC= $row->DOCC;
	    
	    	$cierre = 'No';
	    	if($TotalOC == $TotalOCC){
	    		$cierre = 'Si';
	    	}

	    	return $cierre;

	    }

        function traeCarteras(){        //2806
            $this->query="SELECT * FROM CARTERAS_REVISION";
            $resultado = $this->QueryObtieneDatosN();
            while($tsArray = ibase_fetch_object($resultado)){
                $data[] = $tsArray;
            }
            return $data;
        }
        
        function verCartera($cr){       //02082016 
            $this->query=
                    "SELECT id,clave,nombre,cve_fact,status_log,remision,importe_remision,FACTURA,importe_factura,fechaelab,-- inicia consulta
                    cr,dias,contrarecibo_cr,sol_deslinde,FECHAFAC,FECHAREM
                    FROM(
                    SELECT a.id,cl.clave,cl.nombre,a.cve_fact,a.status_log, -- Consulta que trae las cajas
                    a.remision,r.importe as importe_remision,
                    a.FACTURA,f.importe as importe_factura,
                    p.fechaelab,
                    a.cr,datediff(day,a.fecha_secuencia,current_date) AS dias,a.contrarecibo_cr,a.sol_deslinde,f.fecha_doc as FECHAFAC,r.fecha_doc as FECHAREM
                    FROM ((CAJAS a
                    LEFT JOIN factr01 r on a.remision = r.cve_doc)
                    LEFT JOIN factf01 f on a.factura = f.cve_doc)
                    INNER JOIN (FACTP01 p
                    INNER JOIN clie01 cl ON cl.clave = p.cve_clpv) ON a.cve_fact = p.cve_doc
                    WHERE a.STATUS_LOG = 'Recibido' AND a.cr = '$cr' AND a.statuscr_cr = 'N'
                    UNION
                    SELECT 'Total Cliente' as id,cl.clave,cl.nombre,'Total Cliente' as cve_fact, null as status_log, -- consulta que totaliza por cliente
                    null as remision,sum(r.importe) as importe_remision,
                    null as FACTURA, sum(f.importe) as importe_factura,
                    null as fechaelab,null as cr,null AS dias,null as contrarecibo_cr,null as sol_deslinde,null as FECHAFAC,null as FECHAREM
                    FROM ((CAJAS a
                    LEFT JOIN factr01 r on a.remision = r.cve_doc)
                    LEFT JOIN factf01 f on a.factura = f.cve_doc)
                    INNER JOIN (FACTP01 p
                    INNER JOIN clie01 cl ON cl.clave = p.cve_clpv) ON a.cve_fact = p.cve_doc
                    WHERE a.STATUS_LOG = 'Recibido' AND a.cr = '$cr' AND a.statuscr_cr = 'N'
                    GROUP BY cl.clave,cl.nombre
                    UNION
                    SELECT 'Total General' as id,'Total General' as clave,null as nombre,'Total General' as cve_fact, null as status_log, -- consulta de total general
                    null as remision,sum(r.importe) as importe_remision,
                    null as FACTURA, sum(f.importe) as importe_factura,
                    null as fechaelab,null as cr,null AS dias,null as contrarecibo_cr,null as sol_deslinde,null as FECHAFAC,null as FECHAREM
                    FROM ((CAJAS a
                    LEFT JOIN factr01 r on a.remision = r.cve_doc)
                    LEFT JOIN factf01 f on a.factura = f.cve_doc)
                    INNER JOIN (FACTP01 p
                    INNER JOIN clie01 cl ON cl.clave = p.cve_clpv) ON a.cve_fact = p.cve_doc
                    WHERE a.STATUS_LOG = 'Recibido' AND a.cr = '$cr' AND a.statuscr_cr = 'N'
                    )ORDER BY clave,nombre,id  -- Fin de la consulta";
            $resultado = $this->QueryObtieneDatosN();
            while($tsArray = ibase_fetch_object($resultado)){
                $data[] = $tsArray;
            }
            return $data;
        }

        function sinCartera(){       //2906
            $this->query="SELECT * FROM SP_MOSTRAR_SINCARTERA_REVISION";
            $resultado = $this->QueryObtieneDatosN();
            while($tsArray = ibase_fetch_object($resultado)){
                $data[] = $tsArray;
            }
            return $data;
        }
        
        function salvarContraRecibo($contraRecibo,$caja){     //02082016

        	$this->query = "SELECT FACTURA FROM CAJAS WHERE ID = $caja";
        	$rs=$this->QueryObtieneDatosN();
        	$row=ibase_fetch_object($rs);

        	if(isset($row)){

        		$docf = $row->FACTURA;

        		$this->query="UPDATE CAJAS SET contrarecibo_cr = '$contraRecibo' WHERE ID = $caja, iif(CR is null or CR ='', CR='CR1', CR=CR)";
            	$resultado = $this->EjecutaQuerySimple();

            	$this->query="UPDATE FACTF01 SET contrarecibo_cr = '$contraRecibo' where cve_doc = '$docf'";
            	$res=$this->EjecutaQuerySimple();

            	echo $this->query;
            	//break;
            	return $resultado;
        	}

        	//break;
            
        }  
             
        function salvarStatusECR($caja){     //02082016
            $this->query="UPDATE CAJAS SET statuscr_cr = 'E' WHERE id = $caja";
            $resultado = $this->EjecutaQuerySimple();
            return $resultado;
        }
        
        function traeDataContraRecibo($caja){       //02082016
            $this->query="  SELECT a.id,a.cve_fact,a.status_log,c.nombre, r.CVE_DOC as Remision, f.cve_doc as FACTURA,
                            r.fechaelab as FECHAREM, f.FECHAELAB as FECHAFAC, a.cr,
                            datediff(day,a.fecha_secuencia,current_date) AS dias,a.contrarecibo_cr
                            FROM (CAJAS a
                            INNER join (FACTP01 p
                            INNER JOIN clie01 c on c.clave = p.cve_clpv) ON a.cve_fact = p.cve_doc)
                            left join FACTR01 r on a.remision = r.cve_doc
                            left join FACTF01 f on a.factura = f.cve_doc
                            WHERE a.STATUS_LOG = 'Recibido'  AND a.ID = $caja";    
            $resultado = $this->QueryObtieneDatosN();
            while($tsArray = ibase_fetch_object($resultado)){
                $data[] = $tsArray;
            }
            return $data;  
        }
        
        function verCarteraDia($cr){       //02082016 Modificación cartera revisión
            switch (date('w')){
                case '0':
                    $dia = 'D';
                    break;
                case '1':
                    $dia = 'L';
                    break;
                case '2':
                    $dia = 'MA';
                    break;
                case '3':
                    $dia = 'MI';
                    break;
                case '4':
                    $dia = 'J';
                    break;
                case '5':
                    $dia = 'V';
                    break;
                case '6':
                    $dia = 'S';
                    break;
                default:
                    break;                  
            }
            
            $this->query=
                    "SELECT id,clave,nombre,cve_fact,status_log,remision,importe_remision,FACTURA,importe_factura,fechaelab,-- inicia consulta
                    cr,dias,contrarecibo_cr,sol_deslinde,FECHAFAC,FECHAREM
                    FROM(
                    SELECT a.id,cl.clave,cl.nombre,a.cve_fact,a.status_log, -- Consulta que trae las cajas
                    a.remision,r.importe as importe_remision,
                    a.FACTURA,f.importe as importe_factura,
                    p.fechaelab,
                    a.cr,datediff(day,a.fecha_secuencia,current_date) AS dias,a.contrarecibo_cr,a.sol_deslinde,f.fecha_doc as FECHAFAC,r.fecha_doc as FECHAREM
                    FROM ((CAJAS a
                    LEFT JOIN factr01 r on a.remision = r.cve_doc)
                    LEFT JOIN factf01 f on a.factura = f.cve_doc)
                    INNER JOIN (FACTP01 p
                    INNER JOIN clie01 cl ON cl.clave = p.cve_clpv) ON a.cve_fact = p.cve_doc
                    WHERE a.STATUS_LOG = 'Recibido' AND a.cr = '$cr' AND a.dias_revision CONTAINING '$dia' AND a.statuscr_cr = 'N'
                    UNION
                    SELECT 'Total Cliente' as id,cl.clave,cl.nombre,'Total Cliente' as cve_fact, null as status_log, -- consulta que totaliza por cliente
                    null as remision,sum(r.importe) as importe_remision,
                    null as FACTURA, sum(f.importe) as importe_factura,
                    null as fechaelab,null as cr,null AS dias,null as contrarecibo_cr,null as sol_deslinde,NULL as FECHAFAC,NULL as FECHAREM
                    FROM ((CAJAS a
                    LEFT JOIN factr01 r on a.remision = r.cve_doc)
                    LEFT JOIN factf01 f on a.factura = f.cve_doc)
                    INNER JOIN (FACTP01 p
                    INNER JOIN clie01 cl ON cl.clave = p.cve_clpv) ON a.cve_fact = p.cve_doc
                    WHERE a.STATUS_LOG = 'Recibido' AND a.cr = '$cr' AND a.dias_revision CONTAINING '$dia' AND a.statuscr_cr = 'N'
                    GROUP BY cl.clave,cl.nombre
                    UNION
                    SELECT 'Total General' as id,'Total General' as clave,null as nombre,'Total General' as cve_fact, null as status_log, -- consulta de total general
                    null as remision,sum(r.importe) as importe_remision,
                    null as FACTURA, sum(f.importe) as importe_factura,
                    null as fechaelab,null as cr,null AS dias,null as contrarecibo_cr,null as sol_deslinde,NULL as FECHAFAC,NULL as FECHAREM
                    FROM ((CAJAS a
                    LEFT JOIN factr01 r on a.remision = r.cve_doc)
                    LEFT JOIN factf01 f on a.factura = f.cve_doc)
                    INNER JOIN (FACTP01 p
                    INNER JOIN clie01 cl ON cl.clave = p.cve_clpv) ON a.cve_fact = p.cve_doc
                    WHERE a.STATUS_LOG = 'Recibido' AND a.cr = '$cr' AND a.dias_revision CONTAINING '$dia' AND a.statuscr_cr = 'N'
                    )ORDER BY clave,nombre,id  -- Fin de la consulta";
            $resultado = $this->QueryObtieneDatosN();
            while($tsArray = ibase_fetch_object($resultado)){
                $data[] = $tsArray;
            }
            return $data;
        }


        function verCarteraDia10($cr){       //3006
            switch (date('w')){
                case '0':
                    $dia = 'D';
                    break;
                case '1':
                    $dia = 'L';
                    break;
                case '2':
                    $dia = 'MA';
                    break;
                case '3':
                    $dia = 'MI';
                    break;
                case '4':
                    $dia = 'J';
                    break;
                case '5':
                    $dia = 'V';
                    break;
                case '6':
                    $dia = 'S';
                    break;
                default:
                    break;                  
            }
            $this->query="SELECT id,clave,nombre,cve_fact,status_log,remision,importe_remision,FACTURA,importe_factura,fechaelab,-- inicia consulta
                    cr,dias,contrarecibo_cr,sol_deslinde,FECHAFAC,FECHAREM
                    FROM(
                    SELECT a.id,cl.clave,cl.nombre,a.cve_fact,a.status_log, -- Consulta que trae las cajas
                    a.remision,r.importe as importe_remision,
                    a.FACTURA,f.importe as importe_factura,
                    p.fechaelab,
                    a.cr,datediff(day,a.fecha_secuencia,current_date) AS dias,a.contrarecibo_cr,a.sol_deslinde,f.fecha_doc as FECHAFAC,r.fecha_doc as FECHAREM
                    FROM ((CAJAS a
                    LEFT JOIN factr01 r on a.remision = r.cve_doc)
                    LEFT JOIN factf01 f on a.factura = f.cve_doc)
                    INNER JOIN (FACTP01 p
                    INNER JOIN clie01 cl ON cl.clave = p.cve_clpv) ON a.cve_fact = p.cve_doc
                    WHERE a.STATUS_LOG = 'Recibido' AND a.cr = '$cr' AND a.dias_revision CONTAINING '$dia' AND a.statuscr_cr = 'N' AND datediff(day,a.fecha_secuencia,current_date) > 10
                    UNION
                    SELECT 'Total Cliente' as id,cl.clave,cl.nombre,'Total Cliente' as cve_fact, null as status_log, -- consulta que totaliza por cliente
                    null as remision,sum(r.importe) as importe_remision,
                    null as FACTURA, sum(f.importe) as importe_factura,
                    null as fechaelab,null as cr,null AS dias,null as contrarecibo_cr,null as sol_deslinde,NULL as FECHAFAC,NULL as FECHAREM
                    FROM ((CAJAS a
                    LEFT JOIN factr01 r on a.remision = r.cve_doc)
                    LEFT JOIN factf01 f on a.factura = f.cve_doc)
                    INNER JOIN (FACTP01 p
                    INNER JOIN clie01 cl ON cl.clave = p.cve_clpv) ON a.cve_fact = p.cve_doc
                    WHERE a.STATUS_LOG = 'Recibido' AND a.cr = '$cr' AND a.dias_revision CONTAINING '$dia' AND a.statuscr_cr = 'N' AND datediff(day,a.fecha_secuencia,current_date) > 10
                    GROUP BY cl.clave,cl.nombre
                    UNION
                    SELECT 'Total General' as id,'Total General' as clave,null as nombre,'Total General' as cve_fact, null as status_log, -- consulta de total general
                    null as remision,sum(r.importe) as importe_remision,
                    null as FACTURA, sum(f.importe) as importe_factura,
                    null as fechaelab,null as cr,null AS dias,null as contrarecibo_cr,null as sol_deslinde,NULL as FECHAFAC,NULL as FECHAREM
                    FROM ((CAJAS a
                    LEFT JOIN factr01 r on a.remision = r.cve_doc)
                    LEFT JOIN factf01 f on a.factura = f.cve_doc)
                    INNER JOIN (FACTP01 p
                    INNER JOIN clie01 cl ON cl.clave = p.cve_clpv) ON a.cve_fact = p.cve_doc
                    WHERE a.STATUS_LOG = 'Recibido' AND a.cr = '$cr' AND a.dias_revision CONTAINING '$dia' AND a.statuscr_cr = 'N' AND datediff(day,a.fecha_secuencia,current_date) > 10
                    )ORDER BY clave,nombre,id  -- Fin de la consulta";
            $resultado = $this->QueryObtieneDatosN();
            while($tsArray = ibase_fetch_object($resultado)){
                $data[] = $tsArray;
            }
            return $data;
        }
        
        function verCartera10($cr){       //3006
            $this->query="SELECT id,clave,nombre,cve_fact,status_log,remision,importe_remision,FACTURA,importe_factura,fechaelab,-- inicia consulta
                    cr,dias,contrarecibo_cr,sol_deslinde,FECHAFAC,FECHAREM
                    FROM(
                    SELECT a.id,cl.clave,cl.nombre,a.cve_fact,a.status_log, -- Consulta que trae las cajas
                    a.remision,r.importe as importe_remision,
                    a.FACTURA,f.importe as importe_factura,
                    p.fechaelab,
                    a.cr,datediff(day,a.fecha_secuencia,current_date) AS dias,a.contrarecibo_cr,a.sol_deslinde,f.fecha_doc as FECHAFAC,r.fecha_doc as FECHAREM
                    FROM ((CAJAS a
                    LEFT JOIN factr01 r on a.remision = r.cve_doc)
                    LEFT JOIN factf01 f on a.factura = f.cve_doc)
                    INNER JOIN (FACTP01 p
                    INNER JOIN clie01 cl ON cl.clave = p.cve_clpv) ON a.cve_fact = p.cve_doc
                    WHERE a.STATUS_LOG = 'Recibido' AND a.cr = '$cr' AND a.statuscr_cr = 'N' AND datediff(day,a.fecha_secuencia,current_date) > 10
                    UNION
                    SELECT 'Total Cliente' as id,cl.clave,cl.nombre,'Total Cliente' as cve_fact, null as status_log, -- consulta que totaliza por cliente
                    null as remision,sum(r.importe) as importe_remision,
                    null as FACTURA, sum(f.importe) as importe_factura,
                    null as fechaelab,null as cr,null AS dias,null as contrarecibo_cr,null as sol_deslinde,null as FECHAFAC,null as FECHAREM
                    FROM ((CAJAS a
                    LEFT JOIN factr01 r on a.remision = r.cve_doc)
                    LEFT JOIN factf01 f on a.factura = f.cve_doc)
                    INNER JOIN (FACTP01 p
                    INNER JOIN clie01 cl ON cl.clave = p.cve_clpv) ON a.cve_fact = p.cve_doc
                    WHERE a.STATUS_LOG = 'Recibido' AND a.cr = '$cr' AND a.statuscr_cr = 'N' AND datediff(day,a.fecha_secuencia,current_date) > 10
                    GROUP BY cl.clave,cl.nombre
                    UNION
                    SELECT 'Total General' as id,'Total General' as clave,null as nombre,'Total General' as cve_fact, null as status_log, -- consulta de total general
                    null as remision,sum(r.importe) as importe_remision,
                    null as FACTURA, sum(f.importe) as importe_factura,
                    null as fechaelab,null as cr,null AS dias,null as contrarecibo_cr,null as sol_deslinde,null as FECHAFAC,null as FECHAREM
                    FROM ((CAJAS a
                    LEFT JOIN factr01 r on a.remision = r.cve_doc)
                    LEFT JOIN factf01 f on a.factura = f.cve_doc)
                    INNER JOIN (FACTP01 p
                    INNER JOIN clie01 cl ON cl.clave = p.cve_clpv) ON a.cve_fact = p.cve_doc
                    WHERE a.STATUS_LOG = 'Recibido' AND a.cr = '$cr' AND a.statuscr_cr = 'N' AND datediff(day,a.fecha_secuencia,current_date)  > 10
                    )ORDER BY clave,nombre,id  -- Fin de la consulta";
            $resultado = $this->QueryObtieneDatosN();
            while($tsArray = ibase_fetch_object($resultado)){
                $data[] = $tsArray;
            }
            return $data;
        }
        
        function sinCartera10(){       //3006
            $this->query="SELECT * FROM SP_MOSTRAR_SINCARTERA_REV10";
            $resultado = $this->QueryObtieneDatosN();
            while($tsArray = ibase_fetch_object($resultado)){
                $data[] = $tsArray;
            }
            return $data;
        }

        function RechazarPedido($docp, $motivo){
        	$a="UPDATE PREOC01 SET STATUS = 'RE', MOTIVO_RECHAZO = '$motivo', fecha_rechazo = current_timestamp WHERE COTIZA = '$docp'";
        	$this->query=$a;
        	$result=$this->EjecutaQuerySimple();
        	$b="UPDATE FACTP01 SET STATUS2 = 'RE' WHERE CVE_DOC = '$docp'";
        	$this->query=$b;
        	$result = $this->EjecutaQuerySimple();
        	return $result;
        }

        function traeDataContraReciboSCR($factura,$remision){       //3006
            if(!empty($factura))
                $documento = $factura;
                else 
                    $documento = $remision;
            $this->query="SELECT * FROM SP_DATOSDELCONTRARECIBO_SINCR('$documento')";    
            $resultado = $this->QueryObtieneDatosN();
            while($tsArray = ibase_fetch_object($resultado)){
                $data[] = $tsArray;
            }
            return $data;  
        }

 
        function verCarteraCierreDia($cr){     //07072016
            /*switch (date('w')){
                case '0':
                    $dia = 'D';
                    break;
                case '1':
                    $dia = 'L';
                    break;
                case '2':
                    $dia = 'MA';
                    break;
                case '3':
                    $dia = 'MI';
                    break;
                case '4':
                    $dia = 'J';
                    break;
                case '5':
                    $dia = 'V';
                    break;
                case '6':
                    $dia = 'S';
                    break;
                default:
                    break;                  
            }*/
            $this->query="SELECT a.id, a.aduana , a.cve_fact,a.status_log, a.Remision,
    			c.importe as ImpRem,  a.FACTURA, d.importe as ImpFac,
    			c.fechaelab as FECHAREM, d.FECHAELAB as FECHAFAC, a.cr,
    			datediff(day,a.fecha_secuencia,current_date) AS dias,
    			a.CONTRARECIBO_CR , cl.nombre as CLIENTE, a.cr as CARTERA_REV
    			FROM CAJAS a
    			left join FACTR01 c on c.cve_doc = a.remision
    			left join FACTF01 d on d.cve_doc = a.factura
    			left join factp01 p on p.cve_doc = a.cve_fact
    			left join clie01 cl on p.cve_clpv = cl.clave
    			WHERE a.aduana = 'Cobranza'
    			and (a.CR = '$cr')
    			and a.contrarecibo_cr is not null
    			and a.imp_cierre = 0";
    		//echo $this->query;
            $resultado = $this->QueryObtieneDatosN();
            while($tsArray = ibase_fetch_object($resultado)){
                $data[] = $tsArray;
            }
            return @$data;
        }

        function verCarteraCierreDiaSinCR($cr){     //07072016
            switch (date('w')){
                case '0':
                    $dia = 'D';
                    break;
                case '1':
                    $dia = 'L';
                    break;
                case '2':
                    $dia = 'MA';
                    break;
                case '3':
                    $dia = 'MI';
                    break;
                case '4':
                    $dia = 'J';
                    break;
                case '5':
                    $dia = 'V';
                    break;
                case '6':
                    $dia = 'S';
                    break;
                default:
                    break;                  
            }

            $a="SELECT a.*, c.nombre as cliente, f.importe as ImpFac, r.importe as ImpRem, f.fechaelab as fechafac, r.fechaelab as fecharem, datediff(day, fecha_aduana, current_date) as dias, a.cr as CARTERA_REV, a.CONTRARECIBO_CR, m.motivo as mot
            	FROM CAJAS a
            	left join factp01 p on a.cve_fact = p.cve_doc
            	left join clie01 c on c.clave = p.cve_clpv
            	left join factf01 f on f.cve_doc = a.factura
            	left join factr01 r on r.cve_doc = a.remision 
            	left join motivos_nocr m on (m.cve_doc = a.factura or m.cve_doc = a.remision) AND m.fecha = current_date
            	WHERE a.aduana='Revision' 
            	and a.dias_revision CONTAINING('$dia') 
            	and a.cr = '$cr' 
            	and a.imp_cierre = 0";
            #$this->query="SELECT * FROM SP_CRCIERRESINCR('$dia','$cr')";
            	//echo $this->query;
            $this->query=$a;
            $resultado = $this->QueryObtieneDatosN();
            while($tsArray = ibase_fetch_object($resultado)){
                $data[] = $tsArray;
            }
            return @$data;
        }

 		function salvarMotivoSinContraR($motivo,$factura,$remision){        //06072016
            $documento = (!empty($factura))?$factura:$remision;
            $this->query="INSERT INTO motivos_nocr (cve_doc,motivo) VALUES ('$documento','$motivo')";
            $resultado = $this->EjecutaQuerySimple();

            $this->query= "UPDATE CAJAS SET MOTIVO = (cast('now' as date)||' - '||'$motivo'), fecha_ultimo_motivo = (cast('Now' as date )) where factura = '$factura'";
            $rs=$this->EjecutaQuerySimple();

            return $rs;
        }
        
         function GenerarCierreCR($cr){     //07072016
            switch (date('w')){
                case '0':
                    $dia = 'D';
                    break;
                case '1':
                    $dia = 'L';
                    break;
                case '2':
                    $dia = 'MA';
                    break;
                case '3':
                    $dia = 'MI';
                    break;
                case '4':
                    $dia = 'J';
                    break;
                case '5':
                    $dia = 'V';
                    break;
                case '6':
                    $dia = 'S';
                    break;
                default:
                    break;                  
            }
            $this->query="EXECUTE PROCEDURE SP_GENERARCIERRE_CR('$dia','$cr')";
            $resultado = $this->EjecutaQuerySimple();
            return $resultado;
        }


  		function CobranzaSinCierre($cc){  //07072016
        		// Cobranza sin Cierrre.
  			if($cc =='CCA'){
  				$this->query = "SELECT c.cc, f.fechaelab, a.fecha, a.id as aplicacion, a.idpago as pagos, a.documento, f.importe, a.monto_aplicado, f.saldofinal, f.cve_clpv, f.id_aplicaciones, f.aplicado
			    , f.fecha_vencimiento, datediff(day, f.fechaelab, a.fecha) as dias, ca.plazo, c.contraRecibo_cr, cl.nombre, f.fecha_vencimiento as vencimiento, datediff(day, f.fecha_vencimiento, current_date) - 7 as diasgc 
			    from aplicaciones a
			    left join factf01 f on f.cve_doc = a.documento
			    left join cajas c on c.factura = a.documento
			    left join cartera ca on trim(ca.idcliente) = trim(f.cve_clpv)
			    left join clie01 cl on cl.clave = f.cve_clpv
			    where a.fecha BETWEEN (select max(inicio) from semanas) and (select max(fin) from semanas)
			    and cierre_cc = 0
			    and (c.cc = '$cc' or c.cc is null)
			    order by (a.fecha)";
			   // echo $this->query;            	
  			}else{
  				$this->query = "SELECT c.cc, f.fechaelab, a.fecha, a.id as aplicacion, a.idpago as pagos, a.documento, f.importe, a.monto_aplicado, f.saldofinal, f.cve_clpv, f.id_aplicaciones, f.aplicado
			    , f.fecha_vencimiento, datediff(day, f.fechaelab, a.fecha) as dias, ca.plazo, c.contraRecibo_cr, cl.nombre, f.fecha_vencimiento as vencimiento, datediff(day, f.fecha_vencimiento, current_date) - 7 as diasgc 
			    from aplicaciones a
			    left join factf01 f on f.cve_doc = a.documento
			    left join cajas c on c.factura = a.documento
			    left join cartera ca on trim(ca.idcliente) = trim(f.cve_clpv)
			    left join clie01 cl on cl.clave = f.cve_clpv
			    where a.fecha BETWEEN (select max(inicio) from semanas) and (select max(fin) from semanas)
			    and cierre_cc = 0
			    and c.cc = '$cc' 
			    order by (a.fecha)";
			    //echo $this->query;
  			}
            $resultado = $this->QueryObtieneDatosN();

            while($tsArray = ibase_fetch_object($resultado)){
                $data[] = $tsArray;
            }
            return @$data;
        }  


        function genCierreCobranza($cc){

        	$usuario =$_SESSION['user']->NOMBRE;

        	$this->query="SELECT MAX(CIERRE_CC) AS cierrec FROM  APLICACIONES ";
        	$rs=$this->QueryObtieneDatosN();
        	$row=ibase_fetch_object($rs);
        	$folio= $row->CIERREC + 1;
        	
        	if($cc = 'CCA'){
        			$this->query = "SELECT a.documento as DOCUMENTO
			    		from aplicaciones a
					    left join factf01 f on f.cve_doc = a.documento
					    left join cajas c on c.factura = a.documento
					    left join cartera ca on trim(ca.idcliente) = trim(f.cve_clpv)
					    left join clie01 cl on cl.clave = f.cve_clpv
					    where a.fecha BETWEEN (select max(inicio) from semanas) and (select max(fin) from semanas)
					    and cierre_cc = 0
					    and c.cc = '$cc' order by (a.fecha)";
					  echo $this->query;
					$rs=$this->QueryObtieneDatosN();
					//break;
					while($tsArray=ibase_fetch_object($rs)){
						$data[]= $tsArray;
					}
					
					foreach ($data as $key ){
						$this->query="UPDATE APLICACIONES a SET a.CIERRE_CC = $folio, FECHA_CIERRE_CC = current_timestamp,
						USUARIO_CIERRE_CC = '$usuario'
	        			where documento= '$key->DOCUMENTO'";
	        			$result=$this->EjecutaQuerySimple();	
					}
        	}else{
        			$this->query = "SELECT a.documento as DOCUMENTO
			    		from aplicaciones a
					    left join factf01 f on f.cve_doc = a.documento
					    left join cajas c on c.factura = a.documento
					    left join cartera ca on trim(ca.idcliente) = trim(f.cve_clpv)
					    left join clie01 cl on cl.clave = f.cve_clpv
					    where a.fecha BETWEEN (select max(inicio) from semanas) and (select max(fin) from semanas)
					    and cierre_cc = 0
					    and c.cc = '$cc' order by (a.fecha)";
					$rs=$this->QueryObtieneDatosN();
					while($tsArray = ibase_fetch_object($rs)){
						$data[]=$tsArray;
					}
					foreach ($data as $key){
						$this->query="UPDATE APLICACIONES a SET a.CIERRE_CC = $folio, FECHA_CIERRE_CC = current_timestamp,
						USUARIO_CIERRE_CC = '$usuario'
	        			where documento= '$key->DOCUMENTO'";
	        			$result=$this->EjecutaQuerySimple();
					}

        	}

        	$res = 'falso';
        	if($result){
        		$res = $folio;
        	}
        	return $res;
        }


        function traeAplicaciones($folio){
        	$this->query="SELECT f.cve_doc, cl.nombre, f.fechaelab, a.id, a.idpago, a.monto_Aplicado, f.saldofinal, a.fecha, f.importe, cp.monto, cp.banco 
        				from APLICACIONES a
        				left join factf01 f on f.cve_doc = a.documento
        				left join clie01 cl on cl.clave = f.cve_clpv
        				left join carga_pagos cp on cp.id = a.idpago 
        				WHERE CIERRE_CC = $folio";

        	$rs=$this->QueryObtieneDatosN();
        	echo $this->query;
        	while($tsArray=ibase_fetch_object($rs)){
        		$data[]=$tsArray;
        	}

        	return @$data;

        }
        
        function verNoCobradosDia($cc){  //07072016
            //$this->query = "SELECT * FROM SP_VERCOBRANZA('$cc')";
             switch (date('w')){
                case '0':
                    $dia = 'D';
                    break;
                case '1':
                    $dia = 'L';
                    break;
                case '2':
                    $dia = 'MA';
                    break;
                case '3':
                    $dia = 'MI';
                    break;
                case '4':
                    $dia = 'J';
                    break;
                case '5':
                    $dia = 'V';
                    break;
                case '6':
                    $dia = 'S';
                    break;
                default:
                    break;                  
            }

            if($cc == 'CCA'){
            		$this->query="SELECT f.cve_doc, f.saldofinal, m.cartera , m.cc_dp, f.fecha_vencimiento as vencimiento, datediff(day, fecha_vencimiento, current_date) as DiasVencido, datediff(day, current_date, date '02.03.2017') as diasgc, cl.nombre,f.importe, f.aplicado, f.id_aplicaciones, f.aplicado,
            			(select max(c.contraRecibo_cr) from cajas c where f.cve_doc = factura) as CR, f.fechaelab as fecha 
            from factf01 f
            left join maestros m on f.cve_maestro = m.clave
            left join clie01 cl on cl.clave = f.cve_clpv
            where fecha_vencimiento <= cast('TODAY' as date)
            and f.saldofinal >= 2
            and (m.cc_dp containing '$dia' or m.cc_dp is null or m.cc_dp = '')
            and (m.cartera = '$cc' or m.cartera is null or m.cartera = '')
            order by m.cartera, f.fechaelab";	
            }else{
            	$this->query="SELECT f.cve_doc, f.saldofinal, m.cartera , m.cc_dp, f.fecha_vencimiento as vencimiento, datediff(day, fecha_vencimiento, current_date) as DiasVencido, datediff(day, current_date, date '02.03.2017') as diasgc, cl.nombre,f.importe, f.aplicado, f.id_aplicaciones, f.aplicado,
            			(select max(c.contraRecibo_cr) from cajas c where f.cve_doc = factura) as CR, f.fechaelab as fecha 
            from factf01 f
            left join maestros m on f.cve_maestro = m.clave
            left join clie01 cl on cl.clave = f.cve_clpv
            where fecha_vencimiento <= cast('TODAY' as date)
            and f.saldofinal >= 2
            and m.cc_dp containing '$dia'
            and (m.cartera = '$cc' or m.cartera is null or m.cartera = '')
            order by m.cartera, f.fechaelab";
            
            }
            //echo $this->query;
            $resultado = $this->QueryObtieneDatosN();
            while($tsArray = ibase_fetch_object($resultado)){
                $data[] = $tsArray;
            }
            return @$data;
        }
        
      

        function verCatCobranza10d(){  //06072016
            $this->query = "SELECT * FROM SP_VERCOBRANZA_10D";
            $resultado = $this->QueryObtieneDatosN();
            while($tsArray = ibase_fetch_object($resultado)){
                $data[] = $tsArray;
            }
            return $data;
        }

        function traeCarterasCobranza(){        //07072016
            $this->query="SELECT * FROM CARTERAS_COBRANZA";
            $resultado = $this->QueryObtieneDatosN();
            while($tsArray = ibase_fetch_object($resultado)){
                $data[] = $tsArray;
            }
            return $data;
        }

        function acuse_revision(){
        	$a="SELECT a.cve_fact, id as caja, c.nombre as Cliente, f.cve_doc as FACTURA, f.importe as IMPFAC, f.fechaelab as FECHAFAC, r.cve_doc as remision, r.importe as IMPREM, r.fechaelab as FECHAREM, a.status_log, cr.CARTERA_REVISION as CARTERA_REV, datediff(day, a.fecha_secuencia, current_date ) as Dias  FROM CAJAS a 
        	left join factp01 p on a.cve_fact = p.cve_doc
        	left join factr01 r on p.cve_doc = r.doc_ant 
        	left join factf01 f on p.cve_doc = f.doc_ant 
        	left join clie01 c on p.cve_clpv = c.clave
        	left join cartera cr on c.clave = cr.idcliente
        	WHERE a.status_log = 'Entregado' and a.envio = 'foraneo' and cr.CARTERA_REVISION ='CR1' and (guia_fletera is null or fletera is null)";
        	$this->query = $a;
        	$result=$this->QueryObtieneDatosN();
        	while($tsArray = ibase_fetch_object($result)){
        		$data[] =$tsArray;
        	}
        	return $data;
        }

        function info_foraneo($caja, $doccaja, $guia, $fletera){
        	$a="UPDATE cajas set guia_fletera = '$guia', fletera ='$fletera' where id = $caja and CVE_FACT = '$doccaja'";
        	$this->query=$a;
        	$result=$this->EjecutaQuerySimple();

        	return $result;
        }

        function VerRemisiones(){       //20072016
        	$a="SELECT a.*, r.fechaelab, c.nombre, iif(a.remision is null, r.cve_doc, a.remision) as REM,comp.archivo as archivo,r.doc_sig,x.archivo as xmlfile, fecha_aduana as fecha, datediff(day, fecha_aduana, current_date) as DIAS
                FROM CAJAS a
                left join factr01 r on a.cve_fact = r.doc_ant and r.tip_doc_sig = 'F'
                left join factp01 p on p.cve_doc = a.cve_fact
                left join clie01 c on p.cve_clpv = c.clave
                left join comprobantes_caja comp on comp.idcaja = a.id
                left join xmldocven x on x.cve_doc = r.doc_sig
                WHERE ADUANA = 'Facturar'";

        	$this->query=$a;
        	
        	$result=$this->QueryObtieneDatosN();
        	while ($tsArray=ibase_fetch_object($result)){
        		$data[]=$tsArray;
        	}
        	return $data;
        }





        function asociarFactura($caja, $docp, $factura){    //03082016 
        	$a="UPDATE CAJAS set FACTURA = '$factura' ,ADUANA = 'Facturado', STATUS_LOG = 'Facturado' where id = $caja";
        	$this->query=$a;
        	$result = $this->EjecutaQuerySimple();
        	return $result;
        }		////////////// Se modifica el status_log = Facturado para que el documento regrese a Aduana y desde aduana
        		///////////// se mande a revisión o revisión dos pasos el formulario de aduana manda a llamar a otro metodo 
        		///////////// que actualiza aduana a Revision2p y Revision y status_log a recibido
     
     	function verNCFactura(){ //20072016
     		$a="SELECT a.*, f.fechaelab, c.nombre, f.cve_doc as docfactura,comp.archivo as archivo, f.doc_sig,x.archivo as xmlfile
     			from cajas a 
     			left join factp01 p on p.cve_doc = a.cve_fact
     			left join factf01 f on f.cve_doc = a.factura
     			left join clie01 c on p.cve_clpv = c.clave
                left join comprobantes_caja comp on comp.idcaja = a.id
                left join xmldocven x on x.cve_doc = f.doc_sig
     			where aduana = 'NC'";
     		$this->query=$a;
     		$result=$this->QueryObtieneDatosN();
     		while($tsArray=ibase_fetch_object($result)){
     			$data[]=$tsArray;
     		}

     		return $data;
     	}

     	function asociarNC($caja, $docp, $nc){      //03082016
     		$a="UPDATE CAJAS set NC = '$nc', ADUANA = 'Devuelto', STATUS_LOG = 'Devuelto' where id = $caja";
     		$this->query=$a;
     		$result=$this->EjecutaQuerySimple();

     		return $result; 

     	} ////////////// Se modifica el status_log = Devuelto para que el documento regrese a Aduana y desde aduana
        		///////////// se mande a revisión o revisión dos pasos el formulario de aduana manda a llamar a otro metodo 
        		///////////// que actualiza aduana a Revision2p y Revision y status_log a recibido


     	function VerFacturasDeslinde(){ //20072016
     		$a="SELECT a.*, f.fechaelab, c.nombre, f.cve_doc as docfactura,md.motivo AS motivodes,comp.archivo as archivo
                 from cajas a 
                 left join factp01 p on p.cve_doc = a.cve_fact
                 left join factf01 f on a.cve_fact = f.doc_ant
                 left join clie01 c on p.cve_clpv = c.clave
                 left join motivos_deslinde md on md.idcaja = a.id and md.fecha = current_date
                 left join comprobantes_caja comp on comp.idcaja = a.id
                 where aduana = 'Deslinde' ";
     		$this->query=$a;
     		$result=$this->QueryObtieneDatosN();
     		while($tsArray=ibase_fetch_object($result)){
     			$data[]=$tsArray;
     		}

     		return $data;
     	}

     	function AvanzaDeslinde($caja,$pedido,$motivo){
     		//$this->query="UPDATE cajas SET aduana = null WHERE id = '$caja'";
     		//$resultado = $this->EjecutaQuerySimple();
     		$this->query="INSERT INTO motivos_deslinde(idcaja,pedido,motivo,fecha) VALUES($caja,'$pedido','$motivo',current_timestamp)";
     		$resultado = $this->EjecutaQuerySimple();
     		var_dump($this->query);
     		return $resultado;
     	}

     	function VerFacturasAcuse(){ //20072016
     		$a="SELECT a.*, f.fechaelab, c.nombre, f.cve_doc as docfactura ,comp.archivo as archivo
     			from cajas a 
     			left join factp01 p on p.cve_doc = a.cve_fact
     			left join factf01 f on a.cve_fact = f.doc_ant
     			left join clie01 c on p.cve_clpv = c.clave
                        left join comprobantes_caja comp on comp.idcaja = a.id
     			where aduana = 'Acuse'";
     		$this->query=$a;
     		$result=$this->QueryObtieneDatosN();
     		while($tsArray=ibase_fetch_object($result)){
     			$data[]=$tsArray;
     		}

     		return $data;
     	}

     	function GuardaAcuse($caja,$pedido,$guia,$fletera){
     		$this->query="UPDATE cajas SET guia_fletera = '$guia',fletera = '$fletera' WHERE id = '$caja'";
     		$resultado = $this->EjecutaQuerySimple();
     		return $resultado;
     	}


     	function CierreNcFactura(){
     		$this->query="EXECUTE BLOCK
			     			AS
			     				declare variable caja int;
			     			BEGIN
				     			FOR SELECT a.id 
				     			from cajas a 
				     			left join factp01 p on p.cve_doc = a.cve_fact
				     			left join factf01 f on a.cve_fact = f.doc_ant
				     			left join clie01 c on p.cve_clpv = c.clave
				     			where aduana = 'NC' INTO :caja DO
				     			begin
				     				UPDATE cajas SET aduana = 'CierreNC' WHERE id = :caja;
				     			end
			     			END";
     		$resultado = $this->EjecutaQuerySimple();
     		return $resultado;
     	}

     	function CierreFacturaDeslinde(){
     		$this->query="EXECUTE BLOCK
			     			AS
			     				declare variable caja int;
			     			BEGIN
				     			FOR SELECT a.id
				                 from cajas a 
				                 left join factp01 p on p.cve_doc = a.cve_fact
				                 left join factf01 f on a.cve_fact = f.doc_ant
				                 left join clie01 c on p.cve_clpv = c.clave
				                 left join motivos_deslinde md on md.idcaja = a.id and md.fecha = current_date
				                 where aduana = 'Deslinde' INTO :caja DO
				     			begin
				     				UPDATE cajas SET aduana = null WHERE id = :caja;
				     			end
			     			END";
     		$resultado = $this->EjecutaQuerySimple();
     		return $resultado;
     	}

     	function CierreFacturaAcuse(){
     		$this->query="EXECUTE BLOCK
			     			AS
			     				declare variable caja int;
			     			BEGIN
				     			FOR SELECT a.id
					     			from cajas a 
					     			left join factp01 p on p.cve_doc = a.cve_fact
					     			left join factf01 f on a.cve_fact = f.doc_ant
					     			left join clie01 c on p.cve_clpv = c.clave
					     			where aduana = 'Acuse' INTO :caja DO
				     			begin
				     				UPDATE cajas SET aduana = NULL WHERE id = :caja;
				     			end
			     			END";
     		$resultado = $this->EjecutaQuerySimple();
     		return $resultado;
     	}

     	function CierrePendienteFacturar(){
     		$this->query="EXECUTE BLOCK
			     			AS
			     				declare variable caja int;
			     			BEGIN
				     			FOR SELECT a.id
					        		FROM CAJAS a
					        		left join factr01 r on a.cve_fact = r.doc_ant and r.doc_sig is null
					        		left join factp01 p on p.cve_doc = a.cve_fact
					        		left join clie01 c on p.cve_clpv = c.clave
					        		WHERE ADUANA = 'Facturar' INTO :caja DO
				     			begin
				     				UPDATE cajas SET aduana = null WHERE id = :caja;
				     			end
			     			END";
     		$resultado = $this->EjecutaQuerySimple();
     		return $resultado;
     	}

        function traeSaldosMaestro(){     //12072016
            $this->query="SELECT * FROM saldosmaestro";
            $resultado = $this->QueryObtieneDatosN();
            while($tsArray = ibase_fetch_object($resultado)){
                $data[] = $tsArray;
            }
            return $data;
        }
        
        function actualizaSaldoVencido(){       //19072016
            $this->query=" EXECUTE PROCEDURE SP_ACTUALIZAR_SALDOS_VENCIDOS";
            $resultado = $this->EjecutaQuerySimple();
            return $resultado;
        }

        function saldoMaestro($cartera){
        	$this->query="UPDATE MAESTROS SET saldo_2016 = 0, saldo_2017= 0";
    		$rs=$this->EjecutaQuerySimple();
        	$this->query="SELECT clave_maestro as clave, anio, sum(saldofinal) as saldo from facturas group by clave_maestro, anio";
        	$rs=$this->EjecutaQuerySimple();

        	while($tsArray=ibase_fetch_object($rs)){
        		$data[]=$tsArray;
        	}
        	foreach ($data as $key) {
        		$maestro = $key->CLAVE;
        		$anio = $key->ANIO;
        		$campo = 'saldo_'.$anio; 
        		$saldo = $key->SALDO;

        		$this->query="UPDATE MAESTROS SET $campo= $saldo where clave = '$maestro'";
        		$rs=$this->EjecutaQuerySimple();
        		
        	}
			switch (date('w')){
                                    case '0':
                                        $dia = 'D';
                                        break;
                                    case '1':
                                        $dia = 'L';
                                        break;
                                    case '2':
                                        $dia = 'MA';
                                        break;
                                    case '3':
                                        $dia = 'MI';
                                        break;
                                    case '4':
                                        $dia = 'J';
                                        break;
                                    case '5':
                                        $dia = 'V';
                                        break;
                                    case '6':
                                        $dia = 'S';
                                        break;
                                    default:
                                        break;                  
                                }               

			if ($cartera == '99'){
				$this->query="SELECT clave as maestro, nombre as NOM_MAESTRO, sucursales, saldo_2015 as S15 , saldo_2016 as saldo2016, saldo_2017 as S17, acreedor, CARTERA as cartera_cobranza, CC_DP, limite_global as CREDITOXMAESTRO  
				FROM MAESTROS 
				where clave <> '' 
				and clave is not null 
				and (saldo_2015 > 0 or saldo_2016 > 0 or saldo_2017 > 0)
				and (not CC_DP containing ('$dia') or cc_dp is null)";
				$rs=$this->QueryObtieneDatosN();
				while($tsArray=ibase_fetch_object($rs)){
					$data1[]=$tsArray;

				}	
			}else{
				$this->query="SELECT clave as maestro, nombre as NOM_MAESTRO, sucursales, saldo_2015 as S15 , saldo_2016 as saldo2016, saldo_2017 as S17, acreedor, CARTERA as cartera_cobranza, CC_DP, limite_global as CREDITOXMAESTRO  
				FROM MAESTROS 
				where clave <> '' 
				and clave is not null 
				and (saldo_2015 > 0 or saldo_2016 > 0 or saldo_2017 > 0) 
				and cartera  = '$cartera' ";
				$rs=$this->QueryObtieneDatosN();
				while($tsArray=ibase_fetch_object($rs)){
					$data1[]=$tsArray;
				}	
			}
			//echo $this->query;
        	return $data1;
        }

        function saldoMaestrodia($cartera){
        	switch (date('w')){
                                    case '0':
                                        $dia = 'D';
                                        break;
                                    case '1':
                                        $dia = 'L';
                                        break;
                                    case '2':
                                        $dia = 'MA';
                                        break;
                                    case '3':
                                        $dia = 'MI';
                                        break;
                                    case '4':
                                        $dia = 'J';
                                        break;
                                    case '5':
                                        $dia = 'V';
                                        break;
                                    case '6':
                                        $dia = 'S';
                                        break;
                                    default:
                                        break;                  
                                }               

			if ($cartera == '99'){
				$this->query="SELECT clave as maestro, nombre as NOM_MAESTRO, sucursales, saldo_2015 as S15 , saldo_2016 as saldo2016, saldo_2017 as S17, acreedor, CARTERA as cartera_cobranza, CC_DP, limite_global as CREDITOXMAESTRO  
				FROM MAESTROS 
				where clave <> '' 
				and clave is not null 
				and (saldo_2015 > 0 or saldo_2016 > 0 or saldo_2017 > 0)
				and CC_DP containing ('$dia')";
				$rs=$this->QueryObtieneDatosN();
				while($tsArray=ibase_fetch_object($rs)){
					$data1[]=$tsArray;

				}	
			}else{
				$this->query="SELECT clave as maestro, nombre as NOM_MAESTRO, sucursales, saldo_2015 as S15 , saldo_2016 as saldo2016, saldo_2017 as S17, acreedor, CARTERA as cartera_cobranza, CC_DP, limite_global as CREDITOXMAESTRO  
				FROM MAESTROS 
				where clave <> '' 
				and clave is not null 
				and (saldo_2015 > 0 or saldo_2016 > 0 or saldo_2017 > 0) 
				and cartera  = '$cartera'
				and CC_DP containing ('$dia')";
				$rs=$this->QueryObtieneDatosN();
				while($tsArray=ibase_fetch_object($rs)){
					$data1[]=$tsArray;
				}	
			}
			//echo $this->query;
        	return @$data1;
        }        

        function saldoAcumulado(){
        	$this->query="SELECT 
        						SUM(SALDOFINAL) AS SA15,
        						(SELECT SUM(SALDOFINAL) FROM FACTF01 WHERE EXTRACT(YEAR FROM FECHAELAB) = 2016 ) AS SA16,
        						(SELECT SUM(SALDOFINAL) FROM FACTF01 WHERE EXTRACT(YEAR FROM FECHAELAB) = 2017 ) AS SA17,
        						 (select sum(SALDO) from acreedores where status != 99) as SAC,
        						 (select sum(saldo) from carga_pagos where tipo_pago is null and status <> 'C' and CVE_MAESTRO is not null) as Identificado,
        						 (select sum(saldo) from carga_pagos where tipo_pago is null and status <> 'C' and CVE_MAESTRO is null) as NoIdentificado,
        						 (select sum(saldo) from carga_pagos where tipo_pago is null and status <>'C') as porAplicar
        						 FROM FACTF01 WHERE EXTRACT(YEAR FROM FECHAELAB)= 2015 and saldofinal > 5";
	        	$rs=$this->QueryObtieneDatosN();
	        	while($tsArray=ibase_fetch_object($rs)){
	        		$data[]=$tsArray;
	        	}
        	return $data;
        }

        function saldoIndividual($cve_maestro){
        	$this->query="SELECT sum(saldofinal) as s166, (max(c.nombre)||'( '||trim(max(c.clave))||' )') as nombre, c.clave as clave,
							max(c.identificador_maestro) as idm, max(c.clave) as cc, max(c.diascred) as plazo, max(c.limcred) as linea_cred,
							(select sum(saldofinal) from factf01 fa where trim(fa.cve_clpv) = trim(c.clave ) and extract(year from fa.fechaelab) = 2015 and (deuda2015 = 1 or deuda2015 is null)) as s15,
							(select sum(saldofinal) from factf01 fe where c.clave = fe.cve_clpv and extract(year from fe.fechaelab) = 2017) as s17,
							(select sum (saldo) from acreedores ac where c.clave = ac.cliente ) as acreedor,
							(select sum(saldofinal) from factf01 fe where c.clave = fe.cve_clpv and extract(year from fe.fechaelab) = 2016) as s16
							FROM FACTF01 f left join clie01 c on c.clave= f.cve_clpv
							WHERE c.cve_maestro = '$cve_maestro'
							and f.status <> 'C' group by c.clave";
        	//echo $this->query;
        	$rs = $this->QueryObtieneDatosN();
        	while($tsArray=ibase_fetch_object($rs)){
        		$data[]=$tsArray;
        	}
        	return $data;
        	
        }

        
        function traeSaldosCliente($rfc){     //19072016
            $this->query="SELECT clave,nombre,rfc,ca.linea_cred,ca.plazo, saldo,saldo_vencido,saldo_corriente
                            FROM clie01 c
                            INNER JOIN cartera ca on ca.idcliente = c.clave
                            WHERE rfc = '$rfc'";
            $resultado = $this->QueryObtieneDatosN();
            while($tsArray = ibase_fetch_object($resultado)){
                $data[] = $tsArray;
            }
            return $data;
        }
        
        function traeSaldosDoc($cliente, $historico){     //12072016
            
            if($historico =='Si'){	
            $this->query="SELECT  f.cve_clpv,
            				f.cve_doc,
            				f.fechaelab,
            				f.fecha_cr,
            				f.fecha_vencimiento,
            				'Guia' as guia,
            				f.importe,
                            datediff(day, current_timestamp, f.fecha_vencimiento) as dias , 
                            f.contrarecibo_cr,
                            f.cve_pedi as pedido,
                            f.saldofinal,
                            f.aplicado,
                            f.importe_nc,
                            f.id_pagos,
                            f.nc_aplicadas,
                             iif(f.id_pagos = '' or f.id_pagos is null,0,
						    ((select (FOLIO_X_banco||' $ '||cast(monto as decimal(7,2)))
						    from carga_pagos where
						    id = iif( char_length(f.id_pagos) = 1,substring(f.id_pagos from 1 for 1),
						    iif(char_length(f.id_pagos) = 2,substring(f.id_pagos from 1 for 2),
						    iif(char_length(f.id_pagos) = 3,substring(f.id_pagos from 1 for 3),
						    iif(char_length(f.id_pagos) = 4, substring(f.id_pagos from 1 for 4),
						    iif(char_length(f.id_pagos) = 5, substring(f.id_pagos from 1 for 5),
						     '0')))))))) as info_pago
                            FROM  factf01 f
                            WHERE trim(f.cve_clpv) = trim('$cliente')
                            and f.status <> 'C'
                            and (deuda2015 = 1 or deuda2015 is null or deuda2015 = 0)
                            order by f.fecha_vencimiento asc";
                            //echo $this->query;

            }else{
            $this->query="SELECT  f.cve_clpv,
            				f.cve_doc,
            				f.fechaelab,
            				f.fecha_cr,
            				f.fecha_vencimiento,
            				'Guia' as guia,
            				f.importe,
                            datediff(day, current_timestamp, f.fecha_vencimiento) as dias, 
                            f.contrarecibo_cr,
                            f.cve_pedi as pedido,
                            f.saldofinal,
                            f.aplicado,
                            f.importe_nc,
                            f.id_pagos,
                            f.nc_aplicadas, 
                            iif(f.id_pagos = '' or f.id_pagos is null,0,
						    ((select (FOLIO_X_banco||' $ '||cast(monto as decimal(7,2)))
						    from carga_pagos where
						    id = iif( char_length(f.id_pagos) = 1,substring(f.id_pagos from 1 for 1),
						    iif(char_length(f.id_pagos) = 2,substring(f.id_pagos from 1 for 2),
						    iif(char_length(f.id_pagos) = 3,substring(f.id_pagos from 1 for 3),
						    iif(char_length(f.id_pagos) = 4, substring(f.id_pagos from 1 for 4),
						    iif(char_length(f.id_pagos) = 5, substring(f.id_pagos from 1 for 5),
						     '0')))))))) as info_pago
                            FROM  factf01 f
                            left join aplicaciones a on f.cve_doc = a.documento  and a.cancelado = 0 
                            WHERE trim(f.cve_clpv) = trim('$cliente') and saldoFinal > 2 
                            and f.status <> 'C' 
                            and (deuda2015 = 1 or deuda2015 is null or deuda2015 = 0)
                            and extract(year from f.fecha_doc) >= 2016
                            order by f.fecha_vencimiento asc";
                            //echo $this->query;
            }
            $resultado = $this->QueryObtieneDatosN();
            //echo $this->query;
            while($tsArray = ibase_fetch_object($resultado)){
                $data[] = $tsArray;
            }
            return $data;
        }
        
        function traeDatacliente($cliente){
            $this->query= "SELECT c.nombre, rfc, telefono, fax, emailpred,clave,lista_prec,v.nombre as vendedor,descuento, (iif(calle is null, '', calle ||', ')|| iif(numext is null, '',numext|| ', ') || iif(numint is null, '',numint||', ')|| iif(municipio is null, '', municipio||', ')|| iif(estado is null, '', estado||', ')||iif(pais is null, '',pais||', ')||iif(codigo is null, '', codigo) ) as direccion, c.diascred, 
            	c.banco_deposito, c.banco_origen, c.refer_edo, c.metodo_pago
            	 FROM clie01 c left join vend01 v on c.cve_vend = v.cve_vend WHERE trim(c.clave) =trim('$cliente')";
                    //echo $this->query;
            $resultado = $this->QueryObtieneDatosN();
            while($tsArray = ibase_fetch_object($resultado)){
                $data[] = $tsArray;
            }
            //var_dump($this->query);
            return $data;
        }
        
        function SaldosDelCliente($cliente){
            $this->query="SELECT ca.linea_cred,
            					 ca.plazo,
            					 (select sum(importe) from factp01 where doc_sig is null and status <> 'C' and trim(cve_clpv) = trim($cliente)) as pedidos,
            					 (select sum(saldofinal) from factf01 where trim(cve_clpv) = trim('$cliente') and status <> 'C' and extract(year from fecha_doc) >=2016 ) as facturas,
            					 (select sum(saldofinal) from factf01 where trim(cve_clpv) = trim('$cliente') and datediff(day, CURRENT_DATE, fecha_vencimiento) <= 0 and status <> 'C' and extract(year from fecha_doc) >= 2016 ) as saldo_vencido,
            					 (select sum(saldofinal) from factf01 where trim(cve_clpv) = trim('$cliente') and datediff(day, CURRENT_DATE, fecha_vencimiento) > 0 and status <> 'C' and extract(year from fecha_doc) >= 2016 ) as saldo_corriente,
            					 (select sum(monto) from acreedores where trim(cliente) = trim('$cliente')) as acreedores
                          FROM clie01 c 
                          left JOIN cartera ca on ca.idcliente = c.clave 
                          where trim(c.clave) = trim('$cliente')";
            //echo $this->query;
            $resultado = $this->QueryObtieneDatosN();
            while($tsArray = ibase_fetch_object($resultado)){
                $data[] = $tsArray;
            }
            return $data;
        }


        function saldoVencidoCliente($cliente){
        	$this->query="SELECT SUM(SALDOFINAL) as saldovencido from factf01 WHERE trim(cve_clpv) = trim($cliente)";
        	$rs=$this->QueryObtieneDatosN();
        	$row=ibase_fetch_object($rs);
        	$saldoVencido=$row->SALDOVENCIDO;
        	return $saldoVencido;
        }

        function saldoComprometido($cliente){
        	$this->query="SELECT SUM(IMPORTE) as Saldo 
        					FROM FACTP01 
        					WHERE trim(CVE_CLPV) = trim($cliente) 
        					and (doc_sig is null or doc_sig = '')";
        	$rs=$this->QueryObtieneDatosN();
        	$row=ibase_fetch_object($rs);
        	$saldoSinSig= $row->SALDO;

        	$this->query="SELECT SUM(p.IMPORTE) as saldo 
        					FROM FACTP01 p
        					inner join factf01 f on p.doc_sig = f.cve_doc and  
        					WHERE TRIM(CVE_CLPV) = TRIM($cliente)";
        	return $saldoComprometido;
        }

        function saldoCliente($cliente){
        	$this->query = "SELECT SUM(SALDO) as saldo FROM FACTF01 WHERE TRIM(CVE_CLPV) = TRIM($cliente)";
        	$rs=$this->QueryObtieneDatosN();
        	$row = ibase_fetch_object($rs);
        	$saldo = $row->SALDO;
        	return $saldo;
        }
       
        function ContactosDelCliente($cliente){     //12072016
            $this->query="SELECT ncontacto,nombre,direccion,telefono,email,tipocontac FROM contac01 WHERE cve_clie = '$cliente'";
            $resultado = $this->QueryObtieneDatosN();
            while($tsArray = ibase_fetch_object($resultado)){
                $data[] = $tsArray;
            }
            return $data;
        }

         function guardaCompCaja($caja,$ruta){
            $this->query="INSERT INTO comprobantes_caja(idcaja,archivo) VALUES($caja,'$ruta')";
            $resultado = $this->EjecutaQuerySimple();
            return $resultado;
        }

       function  pedidosAnticipados(){
           $this->query="SELECT a.cotiza, 
           				SUM(a.rec_faltante) AS FALTANTE,
    					max(a.NOM_CLI) as nom_cli,
    					max(a.CLIEN) as clien,
    					max(c.codigo) as codigo,
    					max(b.doc_sig) as doc_sig,
    					max(a.FECHASOL) as fechasol,
    					max(b.IMPORTE) as importe,
    					datediff(day,max(b.FECHAELAB),current_date) AS DIAS,
    					max(b.CITA) as cita,
    					iif(max(a.factura) IS NOT NULL, max(a.factura), max(a.remision)) AS documento,
    					iif(max(fecha_fact) is not null, max(fecha_fact), max(fecha_rem)) as fecha_fact,
    					sum(a.recepcion) as recibido,
    					sum(a.empacado) as empacado
              		FROM preoc01 a
              		LEFT JOIN FACTP01 b on a.cotiza = b.cve_doc
              		LEFT JOIN CLIE01 c on b.cve_clpv = c.Clave
              		where fechasol > '15.05.2017' /*AND (b.STATUS_MAT <> 'OK' OR b.STATUS_MAT IS NULL)*/
              		group by a.cotiza
              		HAVING SUM(REC_FALTANTE) >= 0
                		and sum(recepcion) > 0
                		--AND max(a.REMISION) IS NULL
                		--and max(a.FACTURA) IS NULL";
            /*  HAVING SUM(REC_FALTANTE) > 0 and  ((sum(a.empacado) < sum(a.FACTURADO)) OR (sum(a.empacado) < sum(a.REMISIONADO))) AND (a.REMISION IS NOT NULL OR a.FACTURA IS NOT NULL)"   Condicion original*/
           $resultado = $this->QueryObtieneDatosN();
           while($tsArray = ibase_fetch_object($resultado)){
                $data[] = $tsArray;
           }
           return $data;
       }


       
    function  anticipadosUrgencias(){
           /*$a="SELECT a.cotiza, SUM(a.rec_faltante) AS FALTANTE,a.NOM_CLI,a.CLIEN, c.codigo, b.doc_sig, a.FECHASOL, b.IMPORTE, datediff(day,
           				b.FECHAELAB,current_date) AS DIAS, b.CITA, iif(a.factura IS NOT NULL, a.factura, a.remision) AS documento, iif(fecha_fact is not null, 
           				fecha_fact,fecha_rem) as fecha_fact, sum(a.recepcion) as recibido,  sum(a.empacado) as empacado
                        FROM preoc01 a
                        LEFT JOIN FACTP01 b on a.cotiza = b.cve_doc
                        LEFT JOIN CLIE01 c on b.cve_clpv = c.Clave
                        where fechasol > '15.05.2016'  AND urgente = 'U'
                        group by a.cotiza
                        HAVING SUM(REC_FALTANTE) > 0 and  ((sum(a.empacado) = 0) OR (sum(a.empacado) = 0)) AND (a.REMISION IS NOT NULL OR a.FACTURA IS NOT NULL)   AND sum(a.recepcion) = 0";*/
           $b = "SELECT * FROM PEDIDO";
           $this->query=$b;
           $resultado = $this->QueryObtieneDatosN();
           while($tsArray = ibase_fetch_object($resultado)){
                $data[] = $tsArray;
           }
           return @$data;
       }


    function facturasDelDia(){
		$a= date("N");
		if($a== 1){
			$this->query="SELECT f.cve_doc,iif(f.status='E', 'Emitida','Cancelado') as STATUS, f.cve_clpv,c.nombre,c.rfc,f.fecha_doc,f.imp_tot4,f.importe, fechaelab as dia, iif(ca.status_log is null, 'En Bodega', ca.status_log) as Logistica,  iif(ca.aduana is null, 'Sin Aduana', ca.aduana) as aduana, datediff(day, f.fechaelab, CURRENT_DATE) as DIAS
                FROM factf01 f 
                INNER JOIN clie01 c on f.cve_clpv = c.clave
                left join cajas ca on ca.factura = f.cve_doc
                WHERE f.fechaelab >= '01.08.2016' and (ca.status_log='Entregado' or ca.status_log='admon' or ca.status_log='secuencia' or ca.status_log ='nueva' or ca.status_log is null) and Aduana is null order by f.cve_doc asc ";	
		}else{$this->query="SELECT f.cve_doc,iif(f.status='E', 'Emitida','Cancelado') as STATUS, f.cve_clpv,c.nombre,c.rfc,f.fecha_doc,f.imp_tot4,f.importe, fechaelab as dia, iif(ca.status_log is null, 'En Bodega', ca.status_log) as Logistica,  iif(ca.aduana is null, 'Sin Aduana', ca.aduana) as aduana, datediff(day, f.fechaelab, CURRENT_DATE) as DIAS
                FROM factf01 f 
                INNER JOIN clie01 c on f.cve_clpv = c.clave
                left join cajas ca on ca.factura = f.cve_doc
                WHERE f.fechaelab >= '01.08.2016' and (ca.status_log != 'Total' or ca.status_log = 'admon' or ca.status_log = 'secuencia' or ca.status_log ='nueva' or ca.status_log is null) order by f.cve_doc";
		}

		$resultado = $this->QueryObtieneDatosN();
		while($tsArray = ibase_fetch_object($resultado)){
			$data[] = $tsArray;
		}
		return $data;
    }

    function resumenFacturasDelDia(){
    	$b = date("N");
    	if($b==1){
    		$a="SELECT count(CVE_DOC) as factot FROM factf01 f
                INNER JOIN clie01 c on f.cve_clpv = c.clave
                left join cajas ca on ca.factura = f.cve_doc
                WHERE f.fechaelab >= '01.08.2016' ";
                $this->query =$a;
        }else{
        	$a="SELECT count(CVE_DOC) as factot FROM factf01 f
                INNER JOIN clie01 c on f.cve_clpv = c.clave
                left join cajas ca on ca.factura = f.cve_doc
                WHERE f.fechaelab >= '01.08.2016' ";
                $this->query =$a;
        }
                $result = $this->EjecutaQuerySimple();
                $row=ibase_fetch_object($result);
                $totfact = $row->FACTOT;
        return $totfact;
    }

    function resumenFacturasDelDiaAduana(){

		$b=date("N");
		if($b==1){
			$a="SELECT count(CVE_DOC) as factot FROM factf01 f
                INNER JOIN clie01 c on f.cve_clpv = c.clave
                left join cajas ca on ca.factura = f.cve_doc
                WHERE f.fechaelab >= '01.08.2016' and aduana is not null";
                $this->query =$a;

		}else{
			$a="SELECT count(CVE_DOC) as factot FROM factf01 f
                INNER JOIN clie01 c on f.cve_clpv = c.clave
                left join cajas ca on ca.factura = f.cve_doc
                WHERE f.fechaelab >= '01.08.2016' and aduana is not null";
                $this->query =$a;
		}    	
                $result = $this->EjecutaQuerySimple();
                $row=ibase_fetch_object($result);
                $totaduana = $row->FACTOT;
        return $totaduana;
    }

    function resumenFacturasDelDiaLogistica(){
    	$b=date("N");
    	if($b==1){
    		$a="SELECT count(CVE_DOC) as factot FROM factf01 f
                INNER JOIN clie01 c on f.cve_clpv = c.clave
                left join cajas ca on ca.factura = f.cve_doc
                WHERE f.fechaelab >= '01.08.2016' and (ca.status_log = 'admon' or ca.status_log = 'secuencia' or ca.status_log is null)";
                $this->query =$a;
        }else{
        	$a="SELECT count(CVE_DOC) as factot FROM factf01 f
                INNER JOIN clie01 c on f.cve_clpv = c.clave
                left join cajas ca on ca.factura = f.cve_doc
                WHERE f.fechaelab >= '01.08.2016' and  (ca.status_log = 'admon' or ca.status_log = 'secuencia' or ca.status_log is null)";
                $this->query =$a;
        }
                $result = $this->EjecutaQuerySimple();
                $row=ibase_fetch_object($result);
                $totlog = $row->FACTOT;
        return $totlog;
    }

    function facturasAyer(){
    	$this->query="SELECT f.cve_doc,f.status, f.cve_clpv,c.nombre,c.rfc,f.fecha_doc,f.imp_tot4,f.importe
						FROM factf01 f INNER JOIN clie01 c on f.cve_clpv = c.clave
						WHERE cast(f.fecha_doc as date) = dateadd(-1 day to current_date)";
		$resultado = $this->QueryObtieneDatosN();
		while($tsArray = ibase_fetch_object($resultado)){
			$data[] = $tsArray;
		}
		return $data;
    }

    function UtilidadFacturas($fechaini,$fechafin,$rango,$utilidad,$letras,$status){        //01082016
      
        $filtroLetras = (empty($letras)?"":"WHERE substring(f.doc_ant FROM 2 FOR 1) IN({$letras}) ");
        
       $filtroStatus = (empty($status)?"":"AND f.status IN({$status})");
        
    	$this->query="SELECT f.cve_doc,iif(f.tip_doc_ant = 'P',f.doc_ant,'') as pedido,f.doc_sig as nc,f.status, f.cve_clpv,c.nombre,c.rfc,f.fecha_doc,f.imp_tot4,f.can_tot,round(sum(pf.cost * pf.cant),2) as costo,
					round(((f.can_tot - sum(pf.cost * pf.cant)) * 100)/f.can_tot,2) AS utilidad, 
                                        (f.can_tot - sum(pf.cost * pf.cant)) as monto_utilidad,
					iif(sum(d.importe)/10 is null, 0,sum(d.importe)/10) as cobrado ,
					f.importe as importe_Total, f.fecha_vencimiento,
					f.importe - iif(sum(d.importe)/10 is null, 0,sum(d.importe)/10) as saldo
					FROM ((factf01 f 
                                        left join cuen_det01 d on f.cve_doc = d.refer)
					INNER JOIN clie01 c on c.clave = f.cve_clpv)
					INNER JOIN par_factf01 pf ON f.cve_doc = pf.cve_doc
                                        {$filtroLetras}
					GROUP BY f.cve_doc,f.status, f.cve_clpv,c.nombre,c.rfc,f.fecha_doc,f.imp_tot4,f.can_tot,f.importe,f.fecha_vencimiento,iif(f.tip_doc_ant = 'P',f.doc_ant,''),f.doc_sig
					HAVING f.fecha_doc BETWEEN '$fechaini' AND '$fechafin' AND (((f.can_tot - sum(pf.cost * pf.cant)) * 100)/f.can_tot) {$rango} {$utilidad} {$filtroStatus} ";


		$resultado = $this->QueryObtieneDatosN();
		while($tsArray = ibase_fetch_object($resultado)){
			$data[] = $tsArray;
		}
		//var_dump($this->query);
		return $data;
    }

    function UtilidadFacturasTot($fechaini,$fechafin,$rango,$utilidad,$letras,$status){ //01082016
    	$filtroLetras = (empty($letras)?"":"AND substring(f.doc_ant FROM 2 FOR 1) IN({$letras}) ");
       $filtroStatus = (empty($status)?"":"AND f.status IN({$status})");
    	$this->query=
                    "SELECT SUM(pf.tot_partida) as IMPORTE, SUM(pf.cost * pf.cant) AS COSTO,
					(SUM(pf.tot_partida) - SUM(pf.cost * pf.cant)) * 100 / SUM(pf.tot_partida) AS utilidadp,
					(SUM(pf.tot_partida) - SUM(pf.cost * pf.cant)) AS utilidad_monto,
					SUM(pf.tot_partida + pf.totimp4) as Importe_Total,
					SUM(iif(d.importe is null,0,d.importe)) AS COBRADO,
					SUM(pf.tot_partida + pf.totimp4) - SUM(iif(d.importe is null,0,d.importe)) AS SALDO
                    FROM ((factf01 f left join cuen_det01 d on f.cve_doc = d.refer)
                    INNER JOIN clie01 c on c.clave = f.cve_clpv)
                    INNER JOIN par_factf01 pf ON f.cve_doc = pf.cve_doc
                    WHERE f.status != 'C' AND f.fecha_doc BETWEEN '$fechaini' AND '$fechafin'  {$filtroLetras}  {$filtroStatus}
                    HAVING (SUM(f.can_tot) - SUM(pf.cost * pf.cant)) * 100 / SUM(f.can_tot) {$rango} {$utilidad}";
		$resultado = $this->QueryObtieneDatosN();
		while($tsArray = ibase_fetch_object($resultado)){
			$data[] = $tsArray;
		}
		//var_dump($this->query);
		return $data;
    }

    function UtilidadXFacturaHead($fact){
        if(substr($fact,0,1) == 'N'){
            $tabla = "factd01"; 
            $tabla2 = "par_factd01";
        }elseif(substr($fact,0,1) == 'F'){
            $tabla = "factf01";
            $tabla2 = "par_factf01";
        }
		$this->query="SELECT f.cve_doc,f.status, f.cve_clpv,c.nombre,c.rfc,f.fecha_doc,f.imp_tot4,f.can_tot,round(sum(pf.cost * pf.cant),2) as costo,  round(((f.can_tot - sum(pf.cost * pf.cant)) * 100)/f.can_tot,2) AS utilidad, (f.can_tot - sum(pf.cost * pf.cant)) as monto_utilidad
						FROM ({$tabla} f
						LEFT JOIN clie01 c on c.clave = f.cve_clpv)
						INNER JOIN {$tabla2} pf ON f.cve_doc = pf.cve_doc
						WHERE f.status != 'C'
						GROUP BY f.cve_doc,f.status, f.cve_clpv,c.nombre,c.rfc,f.fecha_doc,f.imp_tot4,f.can_tot
						HAVING f.cve_doc = '$fact' ";
		$resultado = $this->QueryObtieneDatosN();
		while($tsArray = ibase_fetch_object($resultado)){
			$data[] = $tsArray;
		}
		return $data;
    }

    function UtilidadXFactura($fact){
            if(substr($fact,0,1) == 'N'){
            $tabla = "factd01"; 
            $tabla2 = "par_factd01";
        }elseif(substr($fact,0,1) == 'F'){
            $tabla = "factf01";
            $tabla2 = "par_factf01";
        }
		$this->query="SELECT pf.cve_doc, pf.cve_art, i.descr, pf.cant, pf.prec, pf.cost, pf.tot_partida, pf.cost * pf.cant as tot_costo, ((tot_partida-(pf.cost*pf.cant)) * 100) /pf.tot_partida AS utilidad,(tot_partida-(pf.cost*pf.cant)) as monto_utilidad
						FROM {$tabla2} pf
						INNER JOIN inve01 i on pf.cve_art = i.cve_art
						WHERE pf.cve_doc = '$fact' ";
		$resultado = $this->QueryObtieneDatosN();
		while($tsArray = ibase_fetch_object($resultado)){
			$data[] = $tsArray;
		}
		return $data;
    }

    function TotalesUtilidadxFactura($fact){
        if(substr($fact,0,1) == 'N'){
            $tabla = "factd01"; 
            $tabla2 = "par_factd01";
        }elseif(substr($fact,0,1) == 'F'){
            $tabla = "factf01";
            $tabla2 = "par_factf01";
        }
    	$this->query = "
					SELECT
					sum(pf.cant) as cantidad_total,
					sum(pf.tot_partida) as partida_total,
					sum(pf.cost * pf.cant) as tot_costo,
					sum((tot_partida-(pf.cost*pf.cant))) as monto_utilidad_total,
					sum(    iif((((tot_partida-(pf.cost*pf.cant)) * 100) /pf.tot_partida)=100, 25,(((tot_partida-(pf.cost*pf.cant)) * 100) /pf.tot_partida)     ))/count(pf.cve_doc)  AS utilidad_total_ponderada,
					iif(sum(((tot_partida-(pf.cost*pf.cant)) * 100) /pf.tot_partida   )/count(pf.cve_doc) = 100,'si','no' ) as oro
					FROM {$tabla2} pf
					INNER JOIN inve01 i on pf.cve_art = i.cve_art
					WHERE pf.cve_doc = '$fact'";
		$resultado = $this->QueryObtieneDatosN();
		while($tsArray = ibase_fetch_object($resultado)){
			$data[] = $tsArray;
		}
		return $data;
    }

    function deslindecr(){
    	$a="SELECT a.*, a.id as caja, c.nombre as cliente, cr.CARTERA_REVISION, datediff(day,a.fecha_deslinde_revision,current_date) AS DIAS, f.importe as fimporte, p.importe as rimporte, f.fechaelab as fechafac, r.fechaelab as fecharem
    		from cajas a
    		left join factp01 p on p.cve_doc = a.cve_fact 
    		left join clie01 c on c.clave = p.cve_clpv
    		left join CARTERA cr on cr.idcliente = p.cve_clpv
    		left join factf01 f on f.cve_doc = a.factura
    		left join factr01 r on r.cve_doc = a.remision
    		where a.STATUSCR_CR = 'D' and a.contrarecibo_cr is not null";
    	$this->query=$a;
    	$result=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($result)){
    		$data[]=$tsArray;
    	}
    	return $data;
    }

    function deslindearevision($caja, $docf, $docr, $sol, $cr){
    	$a="UPDATE CAJAS SET sol_deslinde = '$sol', statuscr_cr = 'N', fecha_sol = current_timestamp where id = $caja";
    	$this->query=$a;
    	$result=$this->EjecutaQuerySimple();
    	return $result;
    }

	function guardarXmlDocF($doc,$archivo){  //03082016
    	$this->query="INSERT INTO xmldocven(cve_doc,archivo,tip_doc) VALUES('$doc','$archivo','F')";
    	$result=$this->EjecutaQuerySimple();
    	return $result;
	}

	function guardarXmlDocD($doc,$archivo){   //03082016
    	$this->query="INSERT INTO xmldocven(cve_doc,archivo,tip_doc) VALUES('$doc','$archivo','D')";
    	$result=$this->EjecutaQuerySimple();
    	return $result;
	}

    function revConDosPasos($cr){  //11082016
   $this->query="SELECT
            caja,pedido,resultado,aduana, nombre,fecha_secuencia,docs,rev_dospasos,dias,
            factura,impfact, remision,imprec,cr
            FROM
            (SELECT c.id as caja,c.cve_fact as pedido, c.status_log as resultado,c.aduana, cl.nombre,
            c.fecha_secuencia,c.docs,c.rev_dospasos,datediff(day, c.fecha_secuencia, current_timestamp) as dias,
            c.factura,f.importe as impfact,c.remision,r.importe as imprec,c.cr
            from cajas c
            left join factp01 p on c.cve_fact = p.cve_doc
            left join clie01 cl on p.cve_clpv = cl.clave
            left join factf01 f on f.cve_doc = c.factura
            left join factr01 r on r.cve_doc = c.remision
            --where (c.ADUANA = 'Revision2p' or c.ADUANA = 'Facturado')
            where c.ADUANA = 'Revision2p'
            AND c.CR = '$cr'
            UNION
            SELECT
            'Total cliente' as caja,null as pedido, null as resultado,null as aduana, cl.nombre,
            null as fecha_secuencia, null as docs,null as rev_dospasos,null as dias,
            null as factura,sum(f.importe) as impfact, null as remision,sum(r.importe) as imprec,null as cr
            from cajas c
            left join factp01 p on c.cve_fact = p.cve_doc
            left join clie01 cl on p.cve_clpv = cl.clave
            left join factf01 f on f.cve_doc = c.factura
            left join factr01 r on r.cve_doc = c.remision
            where c.ADUANA = 'Revision2p'
            --where (c.ADUANA = 'Revision2p' or c.ADUANA = 'Facturado')
            AND c.CR = '$cr'
            GROUP BY cl.nombre
            UNION
            SELECT
            'Total general' as caja,null as pedido, null as resultado,null as aduana, 'Total General' as nombre,
            null as fecha_secuencia, null as docs,null as rev_dospasos,null as dias,
            null as factura,sum(f.importe) as impfact, null as remision,sum(r.importe) as imprec,null as cr
            from cajas c
            left join factp01 p on c.cve_fact = p.cve_doc
            left join clie01 cl on p.cve_clpv = cl.clave
            left join factf01 f on f.cve_doc = c.factura
            left join factr01 r on r.cve_doc = c.remision
            where c.ADUANA = 'Revision2p'
            --where (c.ADUANA = 'Revision2' or c.ADUANA = 'Facturado')
            AND c.CR = '$cr')
            ORDER BY
            nombre,caja";

    /*	$this->query="SELECT c.id as caja,c.cve_fact as pedido, c.status_log as resultado,c.aduana, cl.nombre,c.fecha_secuencia,c.docs,c.rev_dospasos,datediff(day, c.fecha_secuencia, current_timestamp) as dias,
                        c.factura,c.remision,c.cr
                        from cajas c
                        left join factp01 p on c.cve_fact = p.cve_doc
                        left join clie01 cl on p.cve_clpv = cl.clave
                        where (c.ADUANA = 'Revision' or c.ADUANA = 'Facturado' or c.ADUANA = 'Devuelto') AND c.status_log='Recibido'  AND c.rev_dospasos = 'S' AND c.CR = '$cr'"; */
    	$result=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($result)){
    		$data[]=$tsArray;
    	}
    	return $data;
    }
    
        function revConDosPasosNoCr(){  //05082016
    $this->query="SELECT
            caja,pedido,resultado,aduana, nombre,fecha_secuencia,docs,rev_dospasos,dias,
            factura,impfact, remision,imprec,cr
            FROM
            (SELECT c.id as caja,c.cve_fact as pedido, c.status_log as resultado,c.aduana, cl.nombre,
            c.fecha_secuencia,c.docs,c.rev_dospasos,datediff(day, c.fecha_secuencia, current_timestamp) as dias,
            c.factura,f.importe as impfact,c.remision,r.importe as imprec,c.cr
            from cajas c
            left join factp01 p on c.cve_fact = p.cve_doc
            left join clie01 cl on p.cve_clpv = cl.clave
            left join factf01 f on f.cve_doc = c.factura
            left join factr01 r on r.cve_doc = c.remision
            --where (c.ADUANA = 'Revision2p' or c.ADUANA = 'Facturado')
            where c.ADUANA = 'Revision2p'
            AND (c.CR is null or c.CR = '')

            UNION
            SELECT
            'Total cliente' as caja,null as pedido, null as resultado,null as aduana, cl.nombre,
            null as fecha_secuencia, null as docs,null as rev_dospasos,null as dias,
            null as factura,sum(f.importe) as impfact, null as remision,sum(r.importe) as imprec,null as cr
            from cajas c
            left join factp01 p on c.cve_fact = p.cve_doc
            left join clie01 cl on p.cve_clpv = cl.clave
            left join factf01 f on f.cve_doc = c.factura
            left join factr01 r on r.cve_doc = c.remision
            --where (c.ADUANA = 'Revision2p' or c.ADUANA = 'Facturado')
            where c.ADUANA = 'Revision2p'
            AND (c.CR is null or c.CR = '')
            GROUP BY cl.nombre
            UNION
            SELECT
            'Total general' as caja,null as pedido, null as resultado,null as aduana, 'Total General' as nombre,
            null as fecha_secuencia, null as docs,null as rev_dospasos,null as dias,
            null as factura,sum(f.importe) as impfact, null as remision,sum(r.importe) as imprec,null as cr
            from cajas c
            left join factp01 p on c.cve_fact = p.cve_doc
            left join clie01 cl on p.cve_clpv = cl.clave
            left join factf01 f on f.cve_doc = c.factura
            left join factr01 r on r.cve_doc = c.remision
            --where (c.ADUANA = 'Revision2p' or c.ADUANA = 'Facturado')
            where c.ADUANA = 'Revision2p'
            AND (c.CR is null or c.CR = '') )
            ORDER BY
            nombre,caja";
    	/*$this->query="SELECT c.id as caja,c.cve_fact as pedido, c.status_log as resultado,c.aduana, cl.nombre,c.fecha_secuencia,c.docs,c.rev_dospasos,datediff(day, c.fecha_secuencia, current_timestamp) as dias,
                        c.factura,c.remision,c.cr
                        from cajas c
                        left join factp01 p on c.cve_fact = p.cve_doc
                        left join clie01 cl on p.cve_clpv = cl.clave
                        where (c.ADUANA = 'Revision' or c.ADUANA = 'Facturado' or c.ADUANA = 'Devuelto') AND c.status_log='Recibido'  AND c.rev_dospasos = 'S' AND c.CR is null";*/
    	$result=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($result)){
    		$data[]=$tsArray;
    	}
    	return $data;
    }
 
    function revConDosPasosDia($cr){  //05082016        documentos de revision dos pasos del día 
            switch (date('w')){
                case '0':
                    $dia = 'D';
                    break;
                case '1':
                    $dia = 'L';
                    break;
                case '2':
                    $dia = 'MA';
                    break;
                case '3':
                    $dia = 'MI';
                    break;
                case '4':
                    $dia = 'J';
                    break;
                case '5':
                    $dia = 'V';
                    break;
                case '6':
                    $dia = 'S';
                    break;
                default:
                    break;                  
            }

         $this->query ="SELECT
            caja,pedido,resultado,aduana, nombre,fecha_secuencia,docs,rev_dospasos,dias,
            factura,impfact, remision,imprec,cr
            FROM
            (SELECT c.id as caja,c.cve_fact as pedido, c.status_log as resultado,c.aduana, cl.nombre,
            c.fecha_secuencia,c.docs,c.rev_dospasos,datediff(day, c.fecha_secuencia, current_timestamp) as dias,
            c.factura,f.importe as impfact,c.remision,r.importe as imprec,c.cr
            from cajas c
            left join factp01 p on c.cve_fact = p.cve_doc
            left join clie01 cl on p.cve_clpv = cl.clave
            left join factf01 f on f.cve_doc = c.factura
            left join factr01 r on r.cve_doc = c.remision
           -- where (c.ADUANA = 'Revision2p' or c.ADUANA = 'Facturado')
            where c.ADUANA = 'Revision2p'
            AND c.CR = '$cr' AND c.dias_revision CONTAINING('$dia')

            UNION
            SELECT
            'Total cliente' as caja,null as pedido, null as resultado,null as aduana, cl.nombre,
            null as fecha_secuencia, null as docs,null as rev_dospasos,null as dias,
            null as factura,sum(f.importe) as impfact, null as remision,sum(r.importe) as imprec,null as cr
            from cajas c
            left join factp01 p on c.cve_fact = p.cve_doc
            left join clie01 cl on p.cve_clpv = cl.clave
            left join factf01 f on f.cve_doc = c.factura
            left join factr01 r on r.cve_doc = c.remision
            --where (c.ADUANA = 'Revision2p' or c.ADUANA = 'Facturado')
            where c.ADUANA = 'Revision2p'
            AND c.CR = '$cr' AND c.dias_revision CONTAINING('$dia')
            GROUP BY cl.nombre
            UNION
            SELECT
            'Total general' as caja,null as pedido, null as resultado,null as aduana, 'Total General' as nombre,
            null as fecha_secuencia, null as docs,null as rev_dospasos,null as dias,
            null as factura,sum(f.importe) as impfact, null as remision,sum(r.importe) as imprec,null as cr
            from cajas c
            left join factp01 p on c.cve_fact = p.cve_doc
            left join clie01 cl on p.cve_clpv = cl.clave
            left join factf01 f on f.cve_doc = c.factura
            left join factr01 r on r.cve_doc = c.remision
            --where (c.ADUANA = 'Revision2p' or c.ADUANA = 'Facturado')
            where c.ADUANA = 'Revision2p'
            AND c.CR = '$cr' AND c.dias_revision CONTAINING('$dia'))
            ORDER BY
            nombre,caja";


    	/*$this->query="SELECT c.id as caja,c.cve_fact as pedido, c.status_log as resultado,c.aduana, cl.nombre,c.fecha_secuencia,c.docs,c.rev_dospasos,datediff(day, c.fecha_secuencia, current_timestamp) as dias,
                        c.factura,c.remision,c.cr
                        from cajas c
                        left join factp01 p on c.cve_fact = p.cve_doc
                        left join clie01 cl on p.cve_clpv = cl.clave
                        where (c.ADUANA = 'Revision' or c.ADUANA = 'Facturado' or c.ADUANA = 'Devuelto') AND c.status_log='Recibido'  AND c.rev_dospasos = 'S' AND c.CR = '$cr' AND c.dias_revision CONTAINING('$dia')";*/
    	$result=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($result)){
    		$data[]=$tsArray;
    	}
    	return $data;
    }
    
    function revSinDosPasosDia($cr){      //05082016
            switch (date('w')){
                case '0':
                    $dia = 'D';
                    break;
                case '1':
                    $dia = 'L';
                    break;
                case '2':
                    $dia = 'MA';
                    break;
                case '3':
                    $dia = 'MI';
                    break;
                case '4':
                    $dia = 'J';
                    break;
                case '5':
                    $dia = 'V';
                    break;
                case '6':
                    $dia = 'S';
                    break;
                default:
                    break;                  
            }
    	$this->query="
         SELECT
			caja,pedido,resultado,aduana, nombre,fecha_secuencia,docs,rev_dospasos,dias,
			factura,impfact, remision,imprec,cr
			FROM
			(SELECT c.id as caja,c.cve_fact as pedido, c.status_log as resultado,c.aduana, (cl.nombre||'( '||cl.clave||' )') as nombre,
			c.fecha_secuencia,c.docs,c.rev_dospasos,datediff(day, c.fecha_secuencia, current_timestamp) as dias,
			c.factura,f.importe as impfact,c.remision,r.importe as imprec,c.cr
			from cajas c
			left join factp01 p on c.cve_fact = p.cve_doc
			left join clie01 cl on p.cve_clpv = cl.clave
			left join factf01 f on f.cve_doc = c.factura
			left join factr01 r on r.cve_doc = c.remision
			--where (c.ADUANA = 'Revision' or c.ADUANA = 'Facturado')
			where c.ADUANA = 'Revision'
			AND c.CR = '$cr' AND c.dias_revision CONTAINING('$dia')

			UNION
			SELECT
			'Total cliente' as caja,null as pedido, null as resultado,null as aduana, cl.nombre,
			null as fecha_secuencia, null as docs,null as rev_dospasos,null as dias,
			null as factura,sum(f.importe) as impfact, null as remision,sum(r.importe) as imprec,null as cr
			from cajas c
			left join factp01 p on c.cve_fact = p.cve_doc
			left join clie01 cl on p.cve_clpv = cl.clave
			left join factf01 f on f.cve_doc = c.factura
			left join factr01 r on r.cve_doc = c.remision
			--where (c.ADUANA = 'Revision' or c.ADUANA = 'Facturado')
			where c.ADUANA = 'Revision'
			AND c.CR = '$cr' AND c.dias_revision CONTAINING('$dia')
			GROUP BY cl.nombre
			UNION
			SELECT
			'Total general' as caja,null as pedido, null as resultado,null as aduana, 'Total General' as nombre,
			null as fecha_secuencia, null as docs,null as rev_dospasos,null as dias,
			null as factura,sum(f.importe) as impfact, null as remision,sum(r.importe) as imprec,null as cr
			from cajas c
			left join factp01 p on c.cve_fact = p.cve_doc
			left join clie01 cl on p.cve_clpv = cl.clave
			left join factf01 f on f.cve_doc = c.factura
			left join factr01 r on r.cve_doc = c.remision
			--where (c.ADUANA = 'Revision' or c.ADUANA = 'Facturado')
			where c.ADUANA = 'Revision'
			AND c.CR = '$cr' AND c.dias_revision CONTAINING('$dia'))
			ORDER BY
			nombre,caja";

    	$result=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($result)){
    		$data[]=$tsArray;
    	}
    	return $data;
    }
    
    function revSinDosPasos($cr){      //05082016
    	$this->query="
         SELECT
			caja,pedido,resultado,aduana, nombre,fecha_secuencia,docs,rev_dospasos,dias,
			factura,impfact, remision,imprec,cr
			FROM
			(SELECT c.id as caja,c.cve_fact as pedido, c.status_log as resultado,c.aduana, cl.nombre,
			c.fecha_secuencia, c.docs,c.rev_dospasos, datediff(day, c.fecha_secuencia, current_timestamp) as dias,
			c.factura,f.importe as impfact,c.remision,r.importe as imprec,c.cr
			from cajas c
			left join factp01 p on c.cve_fact = p.cve_doc
			left join clie01 cl on p.cve_clpv = cl.clave
			left join factf01 f on f.cve_doc = c.factura
			left join factr01 r on r.cve_doc = c.remision
			--where (c.ADUANA = 'Revision' or c.ADUANA = 'Facturado')
			where c.ADUANA = 'Revision'
			AND c.CR = '$cr'

			UNION
			SELECT
			'Total cliente' as caja,null as pedido, null as resultado,null as aduana, cl.nombre,
			null as fecha_secuencia, null as docs,null as rev_dospasos,null as dias,
			null as factura,sum(f.importe) as impfact, null as remision,sum(r.importe) as imprec,null as cr
			from cajas c
			left join factp01 p on c.cve_fact = p.cve_doc
			left join clie01 cl on p.cve_clpv = cl.clave
			left join factf01 f on f.cve_doc = c.factura
			left join factr01 r on r.cve_doc = c.remision
			--where (c.ADUANA = 'Revision' or c.ADUANA = 'Facturado')
			where c.ADUANA = 'Revision'
			AND c.CR = '$cr'
			GROUP BY cl.nombre
			UNION
			SELECT
			'Total general' as caja,null as pedido, null as resultado,null as aduana, 'zTotal General' as nombre,
			null as fecha_secuencia, null as docs,null as rev_dospasos,null as dias,
			null as factura,sum(f.importe) as impfact, null as remision,sum(r.importe) as imprec,null as cr
			from cajas c
			left join factp01 p on c.cve_fact = p.cve_doc
			left join clie01 cl on p.cve_clpv = cl.clave
			left join factf01 f on f.cve_doc = c.factura
			left join factr01 r on r.cve_doc = c.remision
			--where (c.ADUANA = 'Revision' or c.ADUANA = 'Facturado')
			where c.ADUANA = 'Revision'
			AND c.CR = '$cr')
			ORDER BY
			nombre,caja";
    	$result=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($result)){
    		$data[]=$tsArray;
    	}
    	return $data;
    }
    
    function revSinDosPasosNoCr($cr){      //05082016
    	/*$this->query="
         SELECT
			caja,pedido,resultado,aduana, nombre,fecha_secuencia,docs,rev_dospasos,dias,
			factura,impfact, remision,imprec,cr
			FROM
			(SELECT c.id as caja,c.cve_fact as pedido, c.status_log as resultado,c.aduana, cl.nombre,
			c.fecha_secuencia,c.docs,c.rev_dospasos,datediff(day, c.fecha_secuencia, current_timestamp) as dias,
			c.factura,f.importe as impfact,c.remision,r.importe as imprec,c.cr
			from cajas c
			left join factp01 p on c.cve_fact = p.cve_doc
			left join clie01 cl on p.cve_clpv = cl.clave
			left join factf01 f on f.cve_doc = c.factura
			left join factr01 r on r.cve_doc = c.remision
			--where (c.ADUANA = 'Revision' or c.ADUANA = 'Facturado')
			where c.ADUANA = 'Revision'
			AND (c.CR is null or c.Cr ='')

			UNION
			SELECT
			'Total cliente' as caja,null as pedido, null as resultado,null as aduana, cl.nombre,
			null as fecha_secuencia, null as docs,null as rev_dospasos,null as dias,
			null as factura,sum(f.importe) as impfact, null as remision,sum(r.importe) as imprec,null as cr
			from cajas c
			left join factp01 p on c.cve_fact = p.cve_doc
			left join clie01 cl on p.cve_clpv = cl.clave
			left join factf01 f on f.cve_doc = c.factura
			left join factr01 r on r.cve_doc = c.remision
			--where (c.ADUANA = 'Revision' or c.ADUANA = 'Facturado')
			where c.ADUANA = 'Revision'
			AND (c.CR is null or c.Cr ='')
			GROUP BY cl.nombre
			UNION
			SELECT
			'Total general' as caja,null as pedido, null as resultado,null as aduana, 'zTotal General' as nombre,
			null as fecha_secuencia, null as docs,null as rev_dospasos,null as dias,
			null as factura,sum(f.importe) as impfact, null as remision,sum(r.importe) as imprec,null as cr
			from cajas c
			left join factp01 p on c.cve_fact = p.cve_doc
			left join clie01 cl on p.cve_clpv = cl.clave
			left join factf01 f on f.cve_doc = c.factura
			left join factr01 r on r.cve_doc = c.remision
			--where (c.ADUANA = 'Revision' or c.ADUANA = 'Facturado')
			where c.ADUANA = 'Revision'
			AND (c.CR is null or c.CR =''))
			ORDER BY
			nombre,caja";
			*/
		$this->query="SELECT c.*, m.*, f.*, (SELECT NOMBRE FROM CLIE01 WHERE clave = f.cve_clpv) as CLIENTE 
					FROM CAJAS c 
					left join factf01 f on f.cve_doc = c.factura 
					left join maestros m on m.clave = f.cve_maestro

            		where  m.cartera_revision = '$cr' 
            			and c.fecha_rev is null 
            			and f.saldofinal > 2 
            			and (c.factura is not null or c.factura != '')";
    	$result=$this->EjecutaQuerySimple();
    	while($tsArray=ibase_fetch_object($result)){
    		$data[]=$tsArray;
    	}
    	return $data;
    }
    
    function statusDeslindeConDP($caja, $numcr){
        $this->query="UPDATE cajas SET ADUANA='Deslinde2P', fecha_deslinde_revision = current_timestamp WHERE ID = $caja";
    	$result=$this->EjecutaQuerySimple();
    	return $result;
    }
    
    function statusDeslindeSinDP($caja, $numcr){
        $this->query="UPDATE cajas SET ADUANA='Deslinde', DESLINDE_REVISION = '$numcr', fecha_deslinde_revision = current_timestamp WHERE ID = $caja";
    	$result=$this->EjecutaQuerySimple();
    	return $result;
    }
    
    function DeslindeDosPasos($cr){     //05082016      Trae las cajas enviadas a delinde dos pasos donde su cartera revisión coincide con $cr
    	$this->query="SELECT c.id as caja,c.cve_fact as pedido, c.status_log as resultado,c.aduana, cl.nombre,c.fecha_secuencia,c.docs,c.rev_dospasos,datediff(day, c.fecha_secuencia, current_timestamp) as dias,
                        c.factura,c.remision, c.cr
                        from cajas c
                        left join factp01 p on c.cve_fact = p.cve_doc
                        left join clie01 cl on p.cve_clpv = cl.clave
                        where c.ADUANA = 'Deslinde2P' AND c.cr = '$cr'";
    	$result=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($result)){
    		$data[]=$tsArray;
    	}
    	return $data;
    }
    
    function DeslindeDosPasosDia($cr){     //05082016      Trae las cajas enviadas a delinde dos pasos donde su cartera revisión coincide con $cr del día
            switch (date('w')){
                case '0':
                    $dia = 'D';
                    break;
                case '1':
                    $dia = 'L';
                    break;
                case '2':
                    $dia = 'MA';
                    break;
                case '3':
                    $dia = 'MI';
                    break;
                case '4':
                    $dia = 'J';
                    break;
                case '5':
                    $dia = 'V';
                    break;
                case '6':
                    $dia = 'S';
                    break;
                default:
                    break;                  
            }
    	$this->query="SELECT c.id as caja,c.cve_fact as pedido, c.status_log as resultado,c.aduana, cl.nombre,c.fecha_secuencia,c.docs,c.rev_dospasos,datediff(day, c.fecha_secuencia, current_timestamp) as dias,
                        c.factura,c.remision, c.cr
                        from cajas c
                        left join factp01 p on c.cve_fact = p.cve_doc
                        left join clie01 cl on p.cve_clpv = cl.clave
                        where c.ADUANA = 'Deslinde2P' AND c.cr = '$cr' AND c.dias_revision CONTAINING('$dia')";
    	$result=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($result)){
    		$data[]=$tsArray;
    	}
    	return $data;
    }
    
    function DeslindeNoDosPasos($cr){   //05082016      Trae las cajas enviadas a delinde que no son dos pasos donde su cartera revisión  coincide con $cr
    	$this->query="SELECT c.id as caja,c.cve_fact as pedido, c.status_log as resultado,c.aduana, cl.nombre,c.fecha_secuencia,c.docs,c.rev_dospasos,datediff(day, c.fecha_secuencia, current_timestamp) as dias,
                        c.factura,c.remision, c.cr
                        from cajas c
                        left join factp01 p on c.cve_fact = p.cve_doc
                        left join clie01 cl on p.cve_clpv = cl.clave
                        where c.ADUANA = 'Deslinde' AND c.cr = '$cr'";
    	$result=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($result)){
    		$data[]=$tsArray;
    	}
    	return $data;
    }
    
    function DeslindeNoDosPasosDia($cr){   //05082016      Trae las cajas enviadas a delinde que no son dos pasos donde su cartera revisión  coincide con $cr
            switch (date('w')){
                case '0':
                    $dia = 'D';
                    break;
                case '1':
                    $dia = 'L';
                    break;
                case '2':
                    $dia = 'MA';
                    break;
                case '3':
                    $dia = 'MI';
                    break;
                case '4':
                    $dia = 'J';
                    break;
                case '5':
                    $dia = 'V';
                    break;
                case '6':
                    $dia = 'S';
                    break;
                default:
                    break;                  
            }
    	$this->query="SELECT c.id as caja,c.cve_fact as pedido, c.status_log as resultado,c.aduana, cl.nombre,c.fecha_secuencia,c.docs,c.rev_dospasos,datediff(day, c.fecha_secuencia, current_timestamp) as dias,
                        c.factura,c.remision, c.cr
                        from cajas c
                        left join factp01 p on c.cve_fact = p.cve_doc
                        left join clie01 cl on p.cve_clpv = cl.clave
                        where c.ADUANA = 'Deslinde' AND c.cr = '$cr' AND c.dias_revision CONTAINING('$dia')";
    	$result=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($result)){
    		$data[]=$tsArray;
    	}
    	return $data;
    }
    
    function salvaMotivoDesDP($caja,$motivo){
        $this->query="UPDATE cajas SET ADUANA = 'Solucion Deslinde 2p', SOL_DESLINDE = '$motivo', FECHA_SOL= current_timestamp WHERE ID = $caja";
    	$result=$this->EjecutaQuerySimple();
    	return $result;
    }
    
    function salvaMotivoDesNoDP($caja,$motivo){
        $this->query="UPDATE cajas SET ADUANA = 'Solucion Deslinde', SOL_DESLINDE = '$motivo', FECHA_SOL= current_timestamp WHERE ID = $caja";
    	$result=$this->EjecutaQuerySimple();
    	return $result;
    }

    function avanzarCajaCobranza($caja, $numcr){
    	$usuario = $_SESSION['user']->USER_LOGIN;
        $this->query="UPDATE cajas SET ADUANA = 'Revision', USUARIO_REVDP = '$usuario', FECHA_REVDP = current_timestamp WHERE ID = $caja";
    	$result=$this->EjecutaQuerySimple();
    	return $result;
    }

    function CajaCobranza($caja, $revdp, $numcr){
    	$usuario =$_SESSION['user']->USER_LOGIN;

    	$this->query="SELECT FACTURA FROM CAJAS WHERE ID = $caja";
    	$res=$this->QueryObtieneDatosN();
    	$row=ibase_fetch_object($res);
    	if(isset($row)){
    		$docf= $row->FACTURA;
    		$a="UPDATE CAJAS SET ADUANA = 'Cobranza', usuario_rev = '$usuario', fecha_rev = current_timestamp, contraRecibo_cr = '$numcr', CR=iif(CR is null or CR= '', 'CR1', CR) where id = $caja";
	    	$this->query=$a;
	    	$result = $this->EjecutaQuerySimple();
	    	$this->query ="UPDATE FACTF01 SET CONTRARECIBO_CR = '$numcr', fecha_rev = current_timestamp where cve_doc = '$docf'";
	    	$res=$this->EjecutaQuerySimple();	
	    	return $result;	
    	}
    	
    
    }
	
	/*creado por GDELEON 3/Ago/2016*/
        function delClaGasto($id){
        	$this->query = "UPDATE CLA_GASTOS
        					SET ACTIVO = 'N'
        					WHERE ID = $id";
        	$resultado = $this->EjecutaQuerySimple();
            return $resultado;
        }
		
		/*function created by GDELEON 3/Ago/2016*/
		function TraePresupuestoConceptGasto($concept){
			$this->query = "SELECT 
								presupuesto
							FROM CAT_GASTOS
							WHERE ID = $concept";
			$resultado = $this->QueryObtieneDatosN();
			while($tsArray = ibase_fetch_object($resultado)){
				$data[] = $tsArray;
			}
			return $data;
		}
		
		/*functoin created by GDELEON 3/Ago/2016*/
    function CuentasBancos(){
    	$data=array();
    	$this->query = "SELECT id, 
    						banco || ' - ' || NUM_CUENTA as banco
    					FROM pg_bancos";
    	$resultado = $this->QueryObtieneDatosN();
		while($tsArray = ibase_fetch_object($resultado)){
			$data[] = $tsArray;
		}
		return $data;
    }

	function deslindeaduana(){
    	$a="SELECT c.*, datediff(day, c.fecha_aduana, current_timestamp) as dias FROM CAJAS c WHERE ADUANA = 'Deslinde' or aduana = 'DeslindeNC'";
    	$this->query = $a;
    	$result=$this->QueryObtieneDatosN();
    	while ($tsArray =ibase_fetch_object($result)){
    		$data[]=$tsArray;
    	}
    	return $data;
    }

    function DesaAdu($caja, $solucion){
    	$usuario = $_SESSION['user']->USER_LOGIN;
    	$datos="SELECT * FROM CAJAS WHERE ID = $caja";
    	$this->query=$datos;
    	$result=$this->QueryObtieneDatosN();
    	$row=ibase_fetch_object($result);
    	$pedido=$row->CVE_FACT;
    	$factura=$row->FACTURA;
    	$status_log=$row->STATUS_LOG;
    	
    	$l="INSERT INTO DESLINDES_ADUANA (IDCAJA, FECHA_DESLINDE, PEDIDO, FACTURA, USUARIO, STATUS_LOG, SOLUCION)
    		values ($caja, current_timestamp, '$pedido', '$factura', '$usuario', '$status_log', '$solucion')";
    	$this->query=$l;
    	$result=$this->EjecutaQuerySimple();

    	$a="UPDATE CAJAS SET STATUS_LOG = 'Deslinde', ADUANA= NULL, sol_des_aduana = '$solucion', fecha_sol_desadu = current_timestamp, usuario_des_adu = '$usuario' where id = $caja";
    	$this->query=$a;
    	$result=$this->EjecutaQuerySimple();
    	return $result;
    }

    function traeCajasxPedido($docp){
    	$this->query="SELECT a.*, f.importe as impfac,f.fecha_doc as fechafac, r.importe as imprec, r.fecha_doc as fecharec, fecha_aduana as fechaa
    	FROM cajas a
    	left join factf01 f on a.factura = f.cve_doc
    	left join factr01 r on a.remision = r.cve_doc
    	WHERE a.cve_fact = upper('$docp')";
    	$resultado=$this->QueryObtieneDatosN();
    	while($tsArray = ibase_fetch_object($resultado)){
    		$data[] = $tsArray;
    	}

    	return @$data;
    }

    function RecibirDocsRevision(){
    	$a="SELECT a.*, f.fechaelab, c.nombre, datediff(day, fecha_ini_cob, current_timestamp) as dias, iif(docs_cobranza is null, 'No', docs_cobranza) as EnCobranza
    		from cajas a 
    		left join factf01 f on f.cve_doc = a.factura
    		left join clie01 c on f.cve_clpv = c.clave
    		where ADUANA = 'Cobranza' and (docs_cobranza = 'No' or docs_cobranza is null or docs_cobranza = 'S') and imp_cierre = 1 ORDER BY c.nombre asc";
    	$this->query=$a;
    	$resultado = $this->QueryObtieneDatosN();
    	while($tsArray = ibase_fetch_object($resultado)){
    		$data[]=$tsArray;
    	}
    	return $data;
    }

    function recDocCob($idc, $docf){
    	$usuario = $_SESSION['user']->USER_LOGIN;
    	$a="UPDATE cajas set docs_cobranza = 'S', usuario_rec_cobranza = '$usuario', fecha_rec_cobranza = current_timestamp where id = $idc";
    	$this->query=$a;
    	$result=$this->EjecutaQuerySimple();

    	$this->query="SELECT cl.diascred as plazoClie, ct.plazo as plazoCart, f.cve_clpv FROM factf01 f 
    		left join clie01 cl on f.cve_clpv = cl.clave
    		left join cartera ct on trim(ct.idCliente) = trim(cl.clave)
    		WHERE cve_doc = '$docf'";
    	$rs=$this->EjecutaQuerySimple();
    	$row=ibase_fetch_object($rs);
    	$plazoCL = $row->PLAZOCLIE;
    	$plazoCT = $row->PLAZOCART;
    	$cliente = $row->CVE_CLPV;

    	if(empty($plazoCT) and empty($plazoCL)){
    		$plazo = 0;
    	}elseif(!empty($plazoCT)){
    		$plazo = $plazoCT;
    		
    	}else{
    		$plazo = $plazoCL;
    	
    	}

    	$this->query="UPDATE FACTF01 SET STATUS_FACT = 'Cobranza', fecha_vencimiento = dateadd(day, $plazo ,current_date)  where cve_doc = '$docf'";
    	echo $this->query;
    	$rs=$this->EjecutaQuerySimple();

    	return $result; 

    }

    function desDocCob($idc){
    	$usuario =$_SESSION['user']->USER_LOGIN;
    	$a="UPDATE CAJAS SET aduana = 'Deslinde Cobranza', usuario_rec_cobranza = 'usuario', fecha_rec_cobranza = current_timestamp where id = $idc";
    	$this->query=$a;
    	$result=$this->EjecutaQuerySimple();
    	return $result; 
    }


       function VerCobranza(){      //05082016
    	$this->query="
         SELECT
			caja,pedido,resultado,aduana, nombre,fecha_secuencia,docs,rev_dospasos,dias,
			factura,impfact, remision,imprec,cc
			FROM
			(SELECT c.id as caja,c.cve_fact as pedido, c.status_log as resultado,c.aduana, cl.nombre,
			c.fecha_secuencia,c.docs,c.rev_dospasos,datediff(day, c.fecha_secuencia, current_timestamp) as dias,
			c.factura,f.importe as impfact,c.remision,r.importe as imprec,c.cc
			from cajas c
			left join factp01 p on c.cve_fact = p.cve_doc
			left join clie01 cl on p.cve_clpv = cl.clave
			left join factf01 f on f.cve_doc = c.factura
			left join factr01 r on r.cve_doc = c.remision
			--where (c.ADUANA = 'Revision' or c.ADUANA = 'Facturado')
			where c.ADUANA = 'Cobranza' and imp_cierre = 1 and docs_cobranza = 'Si'
			AND (c.CC is null or c.CC ='')

			UNION
			SELECT
			'Total cliente' as caja,null as pedido, null as resultado,null as aduana, cl.nombre,
			null as fecha_secuencia, null as docs,null as rev_dospasos,null as dias,
			null as factura,sum(f.importe) as impfact, null as remision,sum(r.importe) as imprec,null as cc
			from cajas c
			left join factp01 p on c.cve_fact = p.cve_doc
			left join clie01 cl on p.cve_clpv = cl.clave
			left join factf01 f on f.cve_doc = c.factura
			left join factr01 r on r.cve_doc = c.remision
			--where (c.ADUANA = 'Revision' or c.ADUANA = 'Facturado')
			where c.ADUANA = 'Cobranza' and imp_cierre = 1 and docs_cobranza = 'Si'
			AND (c.CC is null or c.CC ='')
			GROUP BY cl.nombre
			UNION
			SELECT
			'Total general' as caja,null as pedido, null as resultado,null as aduana, 'zTotal General' as nombre,
			null as fecha_secuencia, null as docs,null as rev_dospasos,null as dias,
			null as factura,sum(f.importe) as impfact, null as remision,sum(r.importe) as imprec,null as cc
			from cajas c
			left join factp01 p on c.cve_fact = p.cve_doc
			left join clie01 cl on p.cve_clpv = cl.clave
			left join factf01 f on f.cve_doc = c.factura
			left join factr01 r on r.cve_doc = c.remision
			--where (c.ADUANA = 'Revision' or c.ADUANA = 'Facturado')
			where c.ADUANA = 'Cobranza' and imp_cierre = 1 and docs_cobranza = 'Si'
			AND (c.CC is null or c.CC =''))
			ORDER BY
			nombre,caja";
    	$result=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($result)){
    		$data[]=$tsArray;
    	}
    	return $data;
    }
 function VerCobranzaDia($cc){      
            switch (date('w')){
                case '0':
                    $dia = 'D';
                    break;
                case '1':
                    $dia = 'L';
                    break;
                case '2':
                    $dia = 'MA';
                    break;
                case '3':
                    $dia = 'MI';
                    break;
                case '4':
                    $dia = 'J';
                    break;
                case '5':
                    $dia = 'V';
                    break;
                case '6':
                    $dia = 'S';
                    break;
                default:
                    break;                  
            }
    	$this->query="
         SELECT
			caja,pedido,resultado,aduana, nombre,fecha_secuencia,docs,rev_dospasos,dias,
			factura,impfact, remision,imprec,cc
			FROM
			(SELECT c.id as caja,c.cve_fact as pedido, c.status_log as resultado,c.aduana, cl.nombre,
			c.fecha_secuencia,c.docs,c.rev_dospasos,datediff(day, c.fecha_secuencia, current_timestamp) as dias,
			c.factura,f.importe as impfact,c.remision,r.importe as imprec,c.cc
			from cajas c
			left join factp01 p on c.cve_fact = p.cve_doc
			left join clie01 cl on p.cve_clpv = cl.clave
			left join factf01 f on f.cve_doc = c.factura
			left join factr01 r on r.cve_doc = c.remision
			--where (c.ADUANA = 'Revision' or c.ADUANA = 'Facturado')
			where c.ADUANA = 'Cobranza' and imp_cierre = 1 and docs_cobranza = 'Si'
			AND c.Cc = '$cc' AND c.dias_pago CONTAINING( iif(dias_pago is null, 'L, Ma, Mi, J,  V, S, D', dias_pago))

			UNION
			SELECT
			'Total cliente' as caja,null as pedido, null as resultado,null as aduana, cl.nombre,
			null as fecha_secuencia, null as docs,null as rev_dospasos,null as dias,
			null as factura,sum(f.importe) as impfact, null as remision,sum(r.importe) as imprec,null as cc
			from cajas c
			left join factp01 p on c.cve_fact = p.cve_doc
			left join clie01 cl on p.cve_clpv = cl.clave
			left join factf01 f on f.cve_doc = c.factura
			left join factr01 r on r.cve_doc = c.remision
			--where (c.ADUANA = 'Revision' or c.ADUANA = 'Facturado')
			where c.ADUANA = 'Cobranza' and imp_cierre = 1 and docs_cobranza = 'Si'
			AND c.Cc = '$cc' AND c.dias_pago CONTAINING( iif(dias_pago is null, 'L, Ma, Mi, J,  V, S, D', dias_pago))
			GROUP BY cl.nombre
			UNION
			SELECT
			'Total general' as caja,null as pedido, null as resultado,null as aduana, 'Total General' as nombre,
			null as fecha_secuencia, null as docs,null as rev_dospasos,null as dias,
			null as factura,sum(f.importe) as impfact, null as remision,sum(r.importe) as imprec,null as cc
			from cajas c
			left join factp01 p on c.cve_fact = p.cve_doc
			left join clie01 cl on p.cve_clpv = cl.clave
			left join factf01 f on f.cve_doc = c.factura
			left join factr01 r on r.cve_doc = c.remision
			--where (c.ADUANA = 'Revision' or c.ADUANA = 'Facturado')
			where c.ADUANA = 'Cobranza' and imp_cierre = 1 and docs_cobranza = 'Si'
			AND c.Cc = '$cc' AND c.dias_pago CONTAINING( iif(dias_pago is null, 'L, Ma, Mi, J,  V, S, D', dias_pago)))
			ORDER BY
			nombre,caja";

    	$result=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($result)){
    		$data[]=$tsArray;
    	}
    	return $data;
    }

function VerCobranzaC($cc){ 
    	$this->query="
         SELECT
			caja,pedido,resultado,aduana, nombre,fecha_secuencia,docs,rev_dospasos,dias,
			factura,impfact, remision,imprec,cc
			FROM
			(SELECT c.id as caja,c.cve_fact as pedido, c.status_log as resultado,c.aduana, cl.nombre,
			c.fecha_secuencia,c.docs,c.rev_dospasos,datediff(day, c.fecha_secuencia, current_timestamp) as dias,
			c.factura,f.importe as impfact,c.remision,r.importe as imprec,c.cc
			from cajas c
			left join factp01 p on c.cve_fact = p.cve_doc
			left join clie01 cl on p.cve_clpv = cl.clave
			left join factf01 f on f.cve_doc = c.factura
			left join factr01 r on r.cve_doc = c.remision
			--where (c.ADUANA = 'Revision' or c.ADUANA = 'Facturado')
			where c.ADUANA = 'Cobranza'
			AND c.CC = '$cc'

			UNION
			SELECT
			'Total cliente' as caja,null as pedido, null as resultado,null as aduana, cl.nombre,
			null as fecha_secuencia, null as docs,null as rev_dospasos,null as dias,
			null as factura,sum(f.importe) as impfact, null as remision,sum(r.importe) as imprec,null as cc
			from cajas c
			left join factp01 p on c.cve_fact = p.cve_doc
			left join clie01 cl on p.cve_clpv = cl.clave
			left join factf01 f on f.cve_doc = c.factura
			left join factr01 r on r.cve_doc = c.remision
			--where (c.ADUANA = 'Revision' or c.ADUANA = 'Facturado')
			where c.ADUANA = 'Cobranza'
			AND c.CC = '$cc'
			GROUP BY cl.nombre
			UNION
			SELECT
			'Total general' as caja,null as pedido, null as resultado,null as aduana, 'zTotal General' as nombre,
			null as fecha_secuencia, null as docs,null as rev_dospasos,null as dias,
			null as factura,sum(f.importe) as impfact, null as remision,sum(r.importe) as imprec,null as cc
			from cajas c
			left join factp01 p on c.cve_fact = p.cve_doc
			left join clie01 cl on p.cve_clpv = cl.clave
			left join factf01 f on f.cve_doc = c.factura
			left join factr01 r on r.cve_doc = c.remision
			--where (c.ADUANA = 'Revision' or c.ADUANA = 'Facturado')
			where c.ADUANA = 'Cobranza'
			AND c.CC = '$cc')
			ORDER BY
			nombre,caja";
    	$result=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($result)){
    		$data[]=$tsArray;
    	}
    	return $data;
    }

    function traeProveedoresGasto(){
    	$a="SELECT * FROM PROV01
    		INNER JOIN PROV_CLIB01 ON CLAVE = CVE_PROV 
    		WHERE (UPPER(CAMPLIB2) STARTING WITH UPPER('G'))";
    		$this->query=$a;
    		$result=$this->QueryObtieneDatosN();
    		while ($tsArray=ibase_fetch_object($result)){
    			$data[]=$tsArray;
    		}
    		return $data;
    }

    function cajabodeganc($idc, $docf){
    	$a="UPDATE CAJAS SET STATUS='NC', STATUS_LOG='BodegaNC' WHERE ID=$idc and cve_fact='$docf'";
    	$this->query=$a;
    	$result= $this->EjecutaQuerySimple();
    	return $result;
    }

    function paquetedevolucion($idc, $docf){
    	$usuario = $_SESSION['user']->NOMBRE;
    	$folio="SELECT MAX(FOLIO_DEV) as folio FROM PAQUETES";
    	$this->query =$folio;
    	$result=$this->QueryObtieneDatosN();
    	$row=ibase_fetch_object($result);
    	$folact=$row->FOLIO;
    	$folsig=$folact + 1;

    	$a="UPDATE PAQUETES SET IMPRESION_DEV = 'Si', FOLIO_DEV = $folsig, fecha_ultima_dev = current_date, STATUS='ingresoBodega' WHERE IDCAJA = $idc and documento = '$docf'";
    	$this->query=$a;
    	$result=$this->grabaBD();
		#### PENDIENTE colocar la diferencia entre factura y remision.
    	$folsigstr=(string)$folsig;

    	$this->query="UPDATE FACTF01 SET VALIDACION = ('DNC'||'$folsigstr') where cve_doc =(select factura from cajas where id = $idc)";
    	$rs=$this->EjecutaQuerySimple();

    	$this->query="UPDATE FACTR01 SET VALIDACION = ('DNC'||'$folsigstr') where cve_doc =(select factura from cajas where id = $idc)";
    	$rs=$this->EjecutaQuerySimple();

    	$c="UPDATE CAJAS SET FOLIO_DEV = ('DNC'||'$folsigstr') where id =$idc";
    	$this->query=$c;
    	$result=$this->grabaBD();
    	//echo $folsig;
    	$this->query="SELECT * FROM CAJAS WHERE ID= $idc and cve_fact ='$docf'";
    	$rs=$this->EjecutaQuerySimple();
    	$row=ibase_fetch_object($rs);
    	if($row){
    		//echo 'Debe de entrar si encuentra algo. <br/>';
    		if(empty($row->FACTURA)){
    			//echo 'No puede llegar aqui por que no tendria relacion de facturas entonces es una Remision o prefactrura. <br/>';
    			$fact= new factura;
		    	$docNC = $fact->creaFolioNCI();
		    	$docNCD=$docNC['docNCD'];
		    	$folio = $docNC['folioNC'];
		    	$serie = $docNC['serieNC'];
		    	$factura = $row->REMISION;
		    	$pedido = $row->CVE_FACT;
		    	$tabla = 'FTC_NCI';
		    	$tablad = 'FTC_NCI_DETALLE';
		    	$this->query="EXECUTE PROCEDURE SP_PF_NCI ('$factura','$pedido','$docNCD','$folio','$serie', '$usuario')";
		    		$r=$this->EjecutaQuerySimple();
		    		$row2=ibase_fetch_object($r);		
		    }else{
    			//echo 'Actualizamos las facturas con su NC.<br/>';
    			$fact= new factura;
		    	$docNC = $fact->creaFolioNCD();
		    	$docNCD=$docNC['docNCD'];
		    	$folio = $docNC['folioNC'];
		    	$serie = $docNC['serieNC'];
		    	$factura = $row->FACTURA;
		    	$tabla = 'FTC_NC';
		    	$tablad = 'FTC_NC_DETALLE';
		    	if(substr($factura, 0,3) == 'FAA' or (substr($factura,0,2) == 'RF' and substr($factura,0,3) != 'RFP')){
		    		$this->query="EXECUTE PROCEDURE SP_FAA_NCD ('$factura', '$docNCD','$folio','$serie', '$usuario')";
		    		$r=$this->EjecutaQuerySimple();
		    		$row2=ibase_fetch_object($r);		
		    	}else{
		    		$this->query="EXECUTE PROCEDURE SP_FP_NC('$folio','$serie','$factura', '$usuario', '$docNCD')";
		    		$r=$this->EjecutaQuerySimple();
		    		$row2=ibase_fetch_object($r);
		    	}
    		}
		    $this->insertaDetalleNC($folsig, $tablad, $row2->TERMINO, $docNCD, $docf, $usuario, $idc,$factura );
		    $this->query="UPDATE $tabla SET 
			 	SUBTOTAL = (select sum(subtotal) from $tablad where DOCUMENTO = '$docNCD'),
			  	 TOTAL = (SELECT SUM(TOTAL) FROM $tablad WHERE DOCUMENTO = '$docNCD'),
			  	  IVA = (SELECT SUM(SUBTOTAL)*.16 from $tablad WHERE DOCUMENTO = '$docNCD'), 
			  	  desc1 = (SELECT sum(DESC1) FROM $tablad WHERE DOCUMENTO = '$docNCD') 
			  	where documento = '$docNCD'";
			$this->EjecutaQuerySimple();
    	}else{
    		echo ' esto no debe de pasar por que vienen todos los datos correctos.
    		Debe de entrar si no encuentra nada, para crear la caja asociada a la factura';
    	}

    	$this->query="SELECT * FROM $tabla where documento = '$docNCD'";
    	$res=$this->EjecutaQuerySimple();
    	$rowM=ibase_fetch_object($res);
    	$montonc = $rowM->TOTAL;

    	//echo '<br/>'.substr($factura, 0,3 == 'FAA').'<br/>';
    	if(substr($factura, 0,3) == 'FAA' or (substr($factura, 0,2) == 'RF' and substr($factura, 0,3) != 'RFP')){
    	$this->query="UPDATE FACTF01 SET NC_APLICADAS = iif(NC_APLICADAS='','$docNCD', NC_APLICADAS||','||'$docNCD'), IMPORTE_NC= IMPORTE_NC + $montonc, saldofinal = saldofinal - $montonc where CVE_DOC = '$factura'"; 	
    	}else{

    	$this->query="UPDATE FTC_FACTURAS SET NOTAS_CREDITO = iif(NOTAS_CREDITO='','$docNCD', NOTAS_CREDITO||','||'$docNCD'), MONTO_NC= MONTO_NC + $montonc, saldo_final = saldo_final - $montonc where documento = '$factura'";
    	}
    	
    	$rs=$this->queryActualiza();
    	if($rs == 1){
	    	return array("status"=>"ok","devolucion"=>$folsig, "idcaja"=>$idc, "docf"=>$docf);
    	}else{
    		return array("status"=>"no","devolucion"=>$folsig, "idcaja"=>$idc, "docf"=>$docf);
    	}

    }

    function insertaDetalleNC($folsig, $tablad, $termino, $docNCD, $docf, $usuario, $idc, $factura){
    	$this->query="SELECT * FROM PAQUETES WHERE FOLIO_DEV = $folsig";
		    	$res = $this->EjecutaQuerySimple();
		    	while ($tsArray=ibase_fetch_object($res)) {
		    		$data[]=$tsArray;
		    	}
		    	$partida = 0;
		    	foreach ($data as $i) {
		    		$cant = $i->DEVUELTO;
		    		if($cant>0){
		    			$partida++;
			    		$acumulado = 0;
			    		$this->query="SELECT sum(cantidad) AS CANTIDAD FROM FTC_NC_DETALLE WHERE IDPAQUETE =$i->ID";
			    		$res = $this->EjecutaQuerySimple();
			    		$row3 =ibase_fetch_object($res);
			    		//echo 'Revisamos lo ya devuelto'.$this->query.'<br/>';
			    		if($row3){
			    			$acumulado=$row3->CANTIDAD;
			    		}

			    		$this->query="SELECT sum(cantidad) AS CANTIDAD FROM FTC_NCI_DETALLE WHERE IDPAQUETE =$i->ID";
			    		$res = $this->EjecutaQuerySimple();
			    		$row4 =ibase_fetch_object($res);
			    		//echo 'Revisamos lo ya devuelto'.$this->query.'<br/>';
			    		if($row4){
			    			$acumulado=$row4->CANTIDAD;
			    		}
			    		$devuelto = $i->DEVUELTO - $acumulado;
			    		if($devuelto > 0){
			    			$this->query="INSERT INTO $tablad (IDFP, IDF, DOCUMENTO, PARTIDA, CANTIDAD, ARTICULO, UM, DESCRIPCION, IMP1, IMP2, IMP3, IMP4, DESC1, DESC2, DESC3, DESCF, SUBTOTAL, TOTAL, CLAVE_SAT, MEDIDA_SAT, PEDIMENTOSAT, LOTE, USUARIO, FECHA, IDPREOC, IDCAJA, IDPAQUETE, PRECIO, STATUS) VALUES 
			  				(NULL, $termino, '$docNCD', $partida, $devuelto, '$i->ARTICULO',
			  				(select coalesce(uni_med, 'Pza') from inve01 where cve_art = '$i->ARTICULO'), 
			  				'$i->DESCRIPCION', 0.16, 0,0,0, 
			  				(SELECT (((DBIMPDES/100) * DBIMPPRE)*$devuelto) FROM FTC_COTIZACION_DETALLE FTCD WHERE FTCD.CDFOLIO = (SELECT FTC.CDFOLIO FROM FTC_COTIZACION FTC WHERE CVE_COTIZACION = '$docf') AND 'PGS'||FTCD.CVE_ART = '$i->ARTICULO'),
			  				 0, 0, 0,
			  				 (((SELECT DBIMPPRE FROM FTC_COTIZACION_DETALLE FTCD WHERE FTCD.CDFOLIO = (SELECT FTC.CDFOLIO FROM FTC_COTIZACION FTC WHERE FTC.CVE_COTIZACION = '$docf') AND 'PGS'||FTCD.CVE_ART = '$i->ARTICULO') * $devuelto) 
			  				 - 
			  				 (SELECT (((DBIMPDES/100) * DBIMPPRE)*$devuelto) FROM FTC_COTIZACION_DETALLE FTCD WHERE FTCD.CDFOLIO = (SELECT CDFOLIO FROM FTC_COTIZACION FTC WHERE CVE_COTIZACION = '$docf') AND 'PGS'||FTCD.CVE_ART = '$i->ARTICULO'))
			  				  ,
			  				  (
			  				 ((SELECT DBIMPPRE FROM FTC_COTIZACION_DETALLE FTCD WHERE FTCD.CDFOLIO = (SELECT FTC.CDFOLIO FROM FTC_COTIZACION FTC WHERE CVE_COTIZACION = '$docf') AND 'PGS'||FTCD.CVE_ART = '$i->ARTICULO') * $devuelto) 
			  				 - 
			  				 (SELECT ( ((DBIMPDES/100) * DBIMPPRE)*$devuelto) FROM FTC_COTIZACION_DETALLE FTCD WHERE FTCD.CDFOLIO = (SELECT CDFOLIO FROM FTC_COTIZACION WHERE CVE_COTIZACION = '$docf'  AND 'PGS'||FTCD.CVE_ART = '$i->ARTICULO'))
			  				  )*1.16, 
			  				  (select coalesce(cve_prodserv, '41071014') from inve01 where cve_art = '$i->ARTICULO'),
			  				(select coalesce(cve_unidad, 'H87') from inve01 where cve_art = '$i->ARTICULO'),
			  				'','', '$usuario', current_timestamp, $i->ID_PREOC, $idc, $i->ID, 
			  				(SELECT DBIMPPRE FROM FTC_COTIZACION_DETALLE FTCD WHERE FTCD.CDFOLIO = (SELECT CDFOLIO FROM FTC_COTIZACION WHERE CVE_COTIZACION = '$docf'  AND 'PGS'||FTCD.CVE_ART = '$i->ARTICULO')), 
			  				0)";
			  				$this->EjecutaQuerySimple();		
			  				$this->query="INSERT INTO INGRESOBODEGA (ID, DESCRIPCION, CANT, FECHA, MARCA, PROVEEDOR, COSTO, UNIDAD, PRODUCTO, RESTANTE, ASIGNADO, USUARIO, RECIBIDO, ORIGEN, documento)
			    						  VALUES (NULL, '$i->DESCRIPCION', $devuelto, CURRENT_TIMESTAMP, (SELECT MARCA FROM PRODUCTO_FTC WHERE CLAVE = '$i->ARTICULO'), 
			    						  (SELECT coalesce(PROV_ALT, PROVE) FROM PREOC01 WHERE ID = $i->ID_PREOC), 
			    						  (SELECT MAX(COSTO) FROM FTC_POC_DETALLE WHERE IDPREOC =$i->ID_PREOC), 
			    						  (SELECT UM FROM PREOC01 WHERE ID = $i->ID_PREOC),
			    						  '$i->ARTICULO', 
			    						  $devuelto,
			    						  0, '$usuario', $devuelto, 'Devolucion Factura', '$factura')";
			    						$this->grabaBD();
			    		}
			  		}
		    	}
		return;
    }

    function verRecepDev(){
    	$this->query="SELECT p.idcaja, max(p.fecha_empaque) as fechaEmpaque, p.documento, p.folio_dev, max(p.impresion_dev) as impresion_dev, 
    		max(p.usuario_dev) as usuario_dev, 
    		max(p.motivo) as motivo,
    		max(p.fecha_ultima_dev) as fecha_ultima_dev, iif((select max(factura) from cajas where id = p.idcaja) is null or (select max(factura) from cajas where id = p.idcaja) = '', (select remision from cajas where id = p.idcaja), (select max(factura) from cajas where id = p.idcaja)) AS FACTURA,
    		(SELECT CL.NOMBRE FROM FACTP01 FP LEFT JOIN CLIE01 CL on CL.CLAVE= FP.CVE_CLPV WHERE CVE_DOC = p.DOCUMENTO) as nombre,
    		coalesce(max(f.saldofinal), max(fp.saldo_final)) as saldo,
    		max(fp.NOTAS_CREDITO) as NOTAS_CREDITO
			from paquetes p
			left join cajas c on c.id = p.idcaja
			left join factf01 f on f.cve_doc = c.factura
			left join ftc_facturas fp on fp.documento = c.factura
			where p.folio_dev > 0 and p.impresion_dev = 'Si'
			group by p.folio_dev, p.documento, p.idcaja";
    	$rs=$this->EjecutaQuerySimple();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return @$data;
    }

    function saldosFacturasDevolucion($facturas){
    	foreach ($facturas as $key) {
    		if(substr($key->FACTURA,0,3) == 'FAA' or (substr($key->FACTURA ,0,2) == 'RF' AND substr($key->FACTURA ,0,3) != 'RFp' )){
    			$this->query="SELECT CVE_DOC, SALDOFINAL FROM FACTF01 WHERE CVE_DOC = '$key->DOCUMENTO'";
    			$rs=$this->EjecutaQuerySimple();
    			while ($tsArray=ibase_fetch_object($rs)) {
    				$data[]=$tsArray;
    			}
    		}elseif(substr($key->FACTURA,0,2) == 'FP' or (substr($key->FACTURA ,0,3) == 'RFP')){
    			$this->query="SELECT documento, SALDO_FINAL FROM FTC_FACTURAS WHERE DOCUMENTO = '$key->DOCUMENTO'";
    			$rs=$this->EjecutaQuerySimple();
    			while ($tsArray=ibase_fetch_object($rs)) {
    				$data[]=$tsArray;
    			}
    		}
    	}

    	return $data;
    }

    function quitarOciImp($oc){
    	$this->query="SELECT avg(status) as status FROM INGRESOBODEGA WHERE DOCUMENTO = '$oc'";
    	$rs=$this->EjecutaQuerySimple();
    	$row =ibase_fetch_object($rs);
    	$status=$row->STATUS;

    	if($status == 0){
    		$mensaje = array("status"=>'no', "mensaje"=>'No se puede quitar por que no ha sido impresa');
    	}else{
    		$this->query="UPDATE INGRESOBODEGA SET STATUS = 1 WHERE DOCUMENTO='$oc'";
    		$rs=$this->queryActualiza();
    		if($rs > 0){
    			$mensaje = array("status"=>'ok', "mensaje"=>'Se ha quitado de la lista, para que el cambio surga efecto favor de actualizar la pantalla');
    		}
    	}
    	return $mensaje;
    }


    function verRecepOCI(){
    	$data=array();
    	$this->query="SELECT DOCUMENTO, (SELECT NOMBRE FROM PROV01 WHERE CLAVE=MAX(PROVEEDOR)) AS PROVEEDOR, MAX(FECHA) AS FECHA, SUM(COSTO) AS IMPORTE, COUNT(PRODUCTO) AS PARTIDAS, MAX(USUARIO) AS USUARIO FROM INGRESOBODEGA WHERE STATUS = 0 AND ORIGEN = 'Orden Interna' GROUP BY DOCUMENTO";
    	$rs=$this->EjecutaQuerySimple();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}	
    	return $data;
    }

    function quitarRecepDev($folio){
    	$this->query="UPDATE PAQUETES SET IMPRESION_DEV='ou' where folio_dev = $folio ";
    	$this->EjecutaQuerySimple();
    	echo $this->query;
    	return array("status"=>'ok');
    }


    function cabeceraDevolucion($idc, $docf){
    	$b="SELECT iif(factura is null, remision, factura) as factura, c.nombre as cliente, iif(f.fechaelab is null, r.fechaelab, f.fechaelab) as fecha_factura, a.cve_fact as pedido, id as caja, a.unidad, a.status_log, (select vendedor from FTC_COTIZACION WHERE (SERIE||FOLIO) = '$docf') as vendedor
    		FROM CAJAS a
    		left join factf01 f on f.cve_doc = a.factura
    		left join factr01 r on trim(r.cve_doc)  = trim(a.remision) 
    		left join clie01 c on c.clave = f.cve_clpv
    	    WHERE ID = $idc";
    	$this->query=$b;
    	$result=$this->QueryObtieneDatosN();
    	while ($tsArray=ibase_fetch_object($result)){
    		$data[]=$tsArray;
    	}
    	return $data;
    }


    function ImprimirDevolucion($idc, $docf){
    	$a="SELECT * FROM PAQUETES WHERE IDCAJA =$idc AND DOCUMENTO = '$docf' and DEVUELTO > 0 ";
    	$this->query=$a;
    	echo $a;
    	$result=$this->QueryObtieneDatosN();
    	while ($tsArray=ibase_fetch_object($result)){
    		$data[]=$tsArray;
    	}
    	return $data;
    }
    
    function ImprimirDevolucionEntrega($idc, $docf){
    	$a="SELECT * FROM PAQUETES WHERE IDCAJA =$idc AND DOCUMENTO = '$docf' and DEVUELTO = 0 ";
    	$this->query=$a;
    	echo $a;
    	$result=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($result)){
    		$data[]=$tsArray;
    	}
    	return $data;
    }

    function verCajasLogistica(){
    	$a="SELECT a.*, c.nombre, c.estado, c.codigo, p.fechaelab, f.fechaelab as fechfact, datediff(day, a.fecha_creacion, current_date) as dias
    		from cajas a 
    		left join factp01 p on a.cve_fact = p.cve_doc
    		left join clie01 c on c.clave = p.cve_clpv
    		left join factf01 f on f.cve_doc = a.factura 
    		where a.fecha_creacion >= '01.07.2016' and ADUANA IS NULL AND a.status_log != 'nuevo' and a.status_log != 'Depurado' order by a.fecha_creacion asc";
    	$this->query=$a;
    	$result=$this->QueryObtieneDatosN();
    	while ($tsArray = ibase_fetch_object($result)){
    		$data[]= $tsArray;
    	}
    	return $data;
    }

    function cambiarStatus($idcaja, $docp, $secuencia, $unidad, $idu, $ntipo){

    	switch ($ntipo) {
    		case 'nuevo':
    				$getlog="SELECT * FROM CAJAS WHERE ID = $idcaja";
    				$this->query = $getlog;
    				$result = $this->QueryObtieneDatosN();
    				$row = ibase_fetch_object($result);
    				$hstatus= $row->STATUS;
    				$hvueltas = $row->VUELTAS;
    				$hstatuslog = $row->STATUS_LOG;
    				$hunidad = $row->UNIDAD;
    				$hidu = $row->IDU;
    				$hfechasecuencia= $row->FECHA_SECUENCIA;
    				$husuariolog = $row->USUARIO_LOG;
    				if (empty($hidu)){
    					$hidu = '0';	
    				}
    				if(empty($hfechasecuencia)){
    					$hfechasecuencia = '01.01.2016';
    				}

    				$log = "INSERT INTO HISTORIA_CAJA(IDCAJA, FECHA_MOV, H_STATUS, H_VUELTAS, H_STATUS_LOG, H_UNIDAD, H_IDU, H_FECHA_SECUENCIA, H_USUARIO_LOG, MOVIMIENTO)
    						VALUES 
    						($idcaja, current_timestamp,'$hstatus',$hvueltas, '$hstatuslog', '$hunidad', $hidu, '$hfechasecuencia', '$husuariolog','Cambio')";
    				$this->query=$log;
    				$result= $this->EjecutaQuerySimple();
    				$a="UPDATE CAJAS SET STATUS_LOG = 'nuevo', unidad = null, fecha_secuencia = null, idu = null, horai = null, horaf = null, secuencia = null, vueltas = (iif(vueltas is null, 0, vueltas) +  1),  ruta = 'N' where id = $idcaja";
    				
    			break;
    		case 'sec':
    				$a="UPDATE CAJAS SET STATUS_LOG = 'sec' where id = $idcaja";
    		case 'admin':
    				$a="UPDATE CAJAS SET STATUS_LOG = 'admon' where id = $idcaja";
    		default:
    			# code...
    			break;
    	
    	}
    		$this->query =$a;
    		$result=$this->EjecutaQuerySimple();
    		return $result;
    }

    function DesNC($idc){
    	$a="UPDATE CAJAS SET ADUANA = 'DeslindeNC' where id = $idc";
    	$this->query=$a;
    	$result=$this->EjecutaQuerySimple();
    	return $result;
    }

    function verLoteEnviar(){
    $a="SELECT a.* , c.nombre, c.estado, c.codigo, f.fechaelab, datediff(day,f.fechaelab, current_date) as dias, a.remision as remisiondoc
    	FROM CAJAS a 
    	left join factp01 p on p.cve_doc = a.cve_fact
    	left join clie01 c on c.clave = p.cve_clpv 
    	left join factf01 f on f.cve_doc = a.factura
    	left join factr01 r on r.cve_doc = a.remision
    	WHERE a.ruta = 'N' and fecha_creacion >='08.08.2016' and  (IMP_COMP_REENRUTAR = 'No')
    	order by factura asc";
    $this->query=$a;
    $result=$this->QueryObtieneDatosN();
    while ($tsArray=ibase_fetch_object($result)){
    	$data[]=$tsArray;
    	}
    	return $data;
	}

	function verLoteEnviarReenrutar(){
	 /*$a="SELECT a.* , c.nombre, c.estado, c.codigo, f.fechaelab, datediff(day,f.fechaelab, current_date) as dias, a.remision as remisiondoc
    	FROM CAJAS a 
    	left join factp01 p on p.cve_doc = a.cve_fact
    	left join clie01 c on c.clave = p.cve_clpv 
    	left join factf01 f on f.cve_doc = a.factura
    	left join factr01 r on r.cve_doc = a.remision
    	WHERE a.ruta = 'N' and fecha_creacion >='08.08.2016' and reenvio = 'Si'";*/

    	$a="SELECT a.*, c.nombre, c.estado, c.codigo, datediff(day, a.fechaelab, current_date) as dias, idc as id, DOC_ANT AS CVE_FACT, ca.DOCS, a.cve_doc as FACTURA, ca.remision as remisiondoc, ca.U_bodega, ca.u_logistica, ca.status_ctrl_doc_entrega
    		FROM FACTF01 a
    		LEFT JOIN CLIE01 c ON c.clave = a.cve_clpv
    		LEFT JOIN CAJAS ca on ca.id = a.idc 
    		WHERE fechaelab > '01.08.2016' and Lote='Faltante'
    		ORDER BY a.cve_doc";

    $this->query=$a;
    $result=$this->QueryObtieneDatosN();
    while ($tsArray=ibase_fetch_object($result)){
    	$data[]=$tsArray;
    }
    	return $data;	
	}

	function entaduana($idc, $docf, $docp){
		$usuario=$_SESSION['user']->USER_LOGIN;
		$a="UPDATE FACTF01 SET ENTREGA_BODEGA = 'Si', U_ENTREGA = '$usuario', fecha_entrega = current_timestamp where cve_doc = '$docf'";
		$this->query=$a;
		$result = $this->EjecutaQuerySimple();
		return $result;
	}

	function recbodega($idc, $docf, $docp){
		$usuario=$_SESSION['user']->USER_LOGIN;
		$a="UPDATE FACTF01 SET ENTREGA_BODEGA = 'Bd', U_RECIBE = '$usuario', FECHA_RECIBE=current_timestamp where cve_doc = '$docf'";
		$this->query=$a;
		$result = $this->EjecutaQuerySimple();
		return $result;
	}

	function reclogistica($idc, $docf, $docp){
		$usuario=$_SESSION['user']->USER_LOGIN;
		$a="UPDATE CAJAS SET 
		U_ENTREGA = (select U_ENTREGA FROM FACTF01 WHERE idc = $idc),
		FECHA_U_ENTREGA = (SELECT FECHA_ENTREGA FROM FACTF01 WHERE idc = $idc),
		U_BODEGA = (select U_RECIBE from factf01 where idc = $idc), 
		FECHA_U_BODEGA =(SELECT FECHA_RECIBE FROM FACTF01 WHERE IDC= $idc),
		U_LOGISTICA = '$usuario',
		FECHA_U_LOGISTICA = current_timestamp where id = $idc";
		$this->query=$a;
		$result=$this->EjecutaQuerySimple();
		return $result; 
	}

	function impLoteDia(){
		$a="SELECT * FROM CAJAS WHERE IMP_COMP_REENRUTAR = 'Nu'";
		$this->query=$a;
		$result=$this->QueryObtieneDatosN();
		while ($tsArray = (ibase_fetch_object($result))){
			$data[]=$tsArray;
		}
		return $data;
	}

	function impLoteReeenrutar(){
		$a="SELECT * FROM CAJAS WHERE IMP_COMP_REENRUTAR = 'No'";
		$this->query=$a;
		$result=$this->QueryObtieneDatosN();
		while ($tsArray=(ibase_fetch_object($result))){
			$data[]=$tsArray;
			}
			return $data;
		}

	function totfactn(){
		$a="SELECT COUNT(id) AS TOTFACT FROM CAJAS WHERE IMP_COMP_REENRUTAR = 'Nu'";
		$this->query=$a;
		$result=$this->QueryObtieneDatosN();
		$row= ibase_fetch_object($result);
		$total=$row->TOTFACT;
		return $total; 
	}

	function totfactr(){
		$a="SELECT COUNT(id) AS TOTFACT FROM CAJAS WHERE IMP_COMP_REENRUTAR = 'No'";
		$this->query=$a;
		$result=$this->QueryObtieneDatosN();
		$row= ibase_fetch_object($result);
		$total=$row->TOTFACT;
		return $total; 
	}

	function actimpcajas(){
		$a="UPDATE CAJAS SET IMP_COMP_REENRUTAR = 'Si' WHERE (IMP_COMP_REENRUTAR = 'No' and IMP_COMP_REENRUTAR = 'Nu')";
		$this->query=$a;
		$result=$this->EjecutaQuerySimple();
		return $result;
	}

	function VerInventarioEmpaque(){
		$a="SELECT p.status,
        p.id,
        fechasol,
        cotiza,
        par,
        prod,
        nomprod,
        UM,
        CANT_ORIG,
        REST,
        (cant_orig - recepcion) as Restante,
        RECEPCION,
        EMPACADO,
        (recepcion - empacado) as BODEGA,
        FACTURADO,
        REMISIONADO,
        FACTURAS,
        (p.costo * p.cant_orig) as ppto_compra,
        pe.tot_partida AS ppto_venta,
        f.fechaelab as ffac,
        trim(iif(REMISIONES is null, p.remision, remisiones)) as remisiones,
        r.fechaelab as frem ,
        c.status_log,
        ca.caja_pegaso,
        ca.fecha_liberacion,
        ca.consecutivo,
          iif( (select sum(tot_partida) from par_compo01 where id_preoc = p.id group by id_preoc) is null, (select sum(costo) from ftc_poc_detalle where idpreoc = p.id group by idpreoc) , (select sum(tot_partida) from par_compo01 where id_preoc = p.id group by id_preoc)) as costo_real,
          ((p.costo * p.cant_orig) - (select sum(tot_partida) from par_compo01 where id_preoc = p.id group by id_preoc))AS DIFERENCIA
            from CAJAS_ALMACEN ca
            left join preoc01 p on ca.pedido = p.cotiza
            left join cajas c on c.factura = p.factura
            left join par_factp01 pe on pe.id_preoc = p.id
            left join factf01 f on p.factura = f.cve_doc
            left join factr01 r on p.remision = r.cve_doc
            where
                --recepcion > 0 and 
                fechasol > '01.01.2017'
                --and (recepcion - empacado)> 0
                and facturas is null 
                and (p.factura is null or p.facturado > p.recepcion)
                and (p.remision is null or p.remisionado > p.recepcion)
                and remisiones is null 
                and ca.status = 1
                and upper(p.status) <> 'Z'
                and upper(p.status) <> 'E'
                and upper(p.status) <> 'F'
                and upper(p.status) <> 'S'
                and upper (p.status) <> 'X'
                order by ca.fecha_liberacion, cotiza, fechasol";
        $this->query=$a;
        $result=$this->QueryObtieneDatosN();
        while ($tsArray=ibase_fetch_object($result)){
        	$data[]=$tsArray;
        }
        return $data;
	}

	function verPedidosPendientes(){
		$a="SELECT * FROM PEDIDO ";
		$this->query=$a;
		$result=$this->QueryObtieneDatosN();
		while($tsArray=ibase_fetch_object($result)){
			$data[]=$tsArray;
		}
		return @$data;
	}

	function docfact($docfact, $idc){
		$this->query="UPDATE CAJAS SET DOCFACT = 'si' where id = $idc";
		$result = $this->EjecutaQuerySimple();
		return $result;
	}

	function listadoGastos(){
		$data = array();
        $this->query = "SELECT A.ID,
        A.STATUS,
        A.CVE_CATGASTOS,
        B.CONCEPTO,
        A.CVE_PROV,
        B.PROVEEDOR,
        A.MONTO_PAGO,
        A.TIPO_PAGO,
        B.PRESUPUESTO,
        A.FECHA_CREACION,
        A.CLASIFICACION,
        C.DESCRIPCION, 
        (SELECT NOMBRE FROM PROV01 WHERE CLAVE = A.CVE_PROV) AS PROV
        FROM GASTOS A
        left JOIN CAT_GASTOS B ON A.CVE_CATGASTOS = B.ID
        left JOIN CLA_GASTOS C ON C.ID = A.CLASIFICACION
        WHERE A.STATUS = 'E'
        and (AUTORIZACION ='' or AUTORIZACION = '1')";
        $result = $this->EjecutaQuerySimple();
        while ($tsArray = ibase_fetch_object($result)) {
            $data[] = $tsArray;
        }
        return @$data;
    }
    
	function PagosGastos($identificador) {
        $this->query = "SELECT a.ID, d.CONCEPTO, d.PROVEEDOR, a.MONTO_PAGO, a.FECHA_CREACION, a.SALDO, a.TIPO_PAGO, a.CLASIFICACION, c.DESCRIPCION, (SELECT NOMBRE FROM PROV01 WHERE CLAVE = a.CVE_PROV) AS PROV 
                        from GASTOS a 
                        left JOIN CLA_GASTOS c ON a.clasificacion = c.id
                        left JOIN CAT_GASTOS d ON a.CVE_CATGASTOS = d.ID 
                        where a.status <> 'C' and FECHA_CREACION > '03/14/2016' AND d.ACTIVO = 'S' AND AUTORIZACION = '1' 
                        AND a.ID = '$identificador'
                        ORDER BY a.FECHA_CREACION asc ";
        $result = $this->QueryObtieneDatosN();
        while ($tsArray = ibase_fetch_object($result)) {
            $data[] = $tsArray;
            return @$data;
        }
        return;
    }

   function traeFacturaxCancelar($docp){
    	$this->query="SELECT f.*, c.nombre, ca.id, ca.status_log, ca.aduana, ca.factura, ca.unidad, ca.fecha_secuencia, ca.fecha_creacion, ca.remision, r.importe as IMPREC ,  r.fechaelab as FECHAREC, ca.fecha_aduana as FECHAA, ca.cr , ca.cc
    				  from factf01 f
    				  left join clie01 c on f.cve_clpv = c.clave
    				  left join cajas ca on ca.factura = f.cve_doc
    				  left join factr01 r on ca.remision = r.cve_doc
    				  where f.cve_doc = '$docp'";
    	$resultado=$this->QueryObtieneDatosN();
    	while($tsArray = ibase_fetch_object($resultado)){
    		$data[] = $tsArray;
    	}
    	return @$data;
    }

    function CancelaF($docf, $idc){
    	$a="UPDATE CAJAS set status = 'cancelada' where factura = '$docf' and id = $idc";
    	$this->query=$a;
    	$result = $this->EjecutaQuerySimple();

    	$b="UPDATE PAQUETES set  status= 'cancelado' where idcaja = $idc";
    	$this->query=$b;
    	$result = $this->EjecutaQuerySimple();
    	return $result;
    }

    function UtilidadBaja(){
    	$a="SELECT co.cve_doc, coti.fechaelab, c.nombre, cl.num_part, iif(co.prec = 0, 1, co.prec) * co.cant as PrecioVenta, (iif((cl.camplib3 is null or cl.camplib3 = 0), 1, cl.camplib3) * co.cant) as Costo, (((iif(co.prec = 0, 1, co.prec) * co.cant)/(iif((cl.camplib3 is null or cl.camplib3 = 0), 1, cl.camplib3) * co.cant)-1)*100) as UtilidadCalculada, co.cant as cantidad, co.cve_art as clave_prod, i.descr as Producto
    			from par_factc_clib01 cl
    			left join par_factc01 co on cl.clave_doc = co.cve_doc and cl.num_part = co.num_par
    			left join factc01 coti on co.cve_doc = coti.cve_doc
    			left join clie01 c on c.clave = coti.cve_clpv
    			left join inve01 i on co.cve_art = i.cve_art 
    			WHERE (((iif(co.prec = 0, 1, co.prec) * co.cant)/(iif((cl.camplib3 is null or cl.camplib3 = 0), 1, cl.camplib3) * co.cant)-1)*100)<23 
    			and coti.fechaelab >= '01.08.2016'
    			and co.autoriza = 'No'
    			and coti.doc_sig is null
    			and SOLICITA_AUTORIZACION = 'No'";
    	$this->query=$a;
    	$result=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($result)){
    		$data[]=$tsArray;
    	}
    	return @$data;
    }

    function solAutoUB($docc, $par){
    	$user = $_SESSION['user']->USER_LOGIN;
    	$a="UPDATE PAR_FACTC01 SET SOLICITA_AUTORIZACION='Si', FECHA_SOLICITUD = current_timestamp, USUARIO_SOLICITUD = '$user' where cve_doc = '$docc' and num_par = $par";
    	$this->query=$a;
    	$result=$this->EjecutaQuerySimple();
    	return $result;
    }

    function verSolicitudesUB(){
    	$a="SELECT co.cve_doc, coti.fechaelab, c.nombre, cl.num_part, iif(co.prec = 0, 1, co.prec) * co.cant as PrecioVenta, (iif((cl.camplib3 is null or cl.camplib3 = 0), 1, cl.camplib3) * co.cant) as Costo, (((iif(co.prec = 0, 1, co.prec) * co.cant)/(iif((cl.camplib3 is null or cl.camplib3 = 0), 1, cl.camplib3) * co.cant)-1)*100) as UtilidadCalculada, co.cant as cantidad, co.cve_art as clave_prod, i.descr as Producto
    			from par_factc_clib01 cl
    			left join par_factc01 co on cl.clave_doc = co.cve_doc and cl.num_part = co.num_par
    			left join factc01 coti on co.cve_doc = coti.cve_doc
    			left join clie01 c on c.clave = coti.cve_clpv
    			left join inve01 i on co.cve_art = i.cve_art 
    			WHERE (((iif(co.prec = 0, 1, co.prec) * co.cant)/(iif((cl.camplib3 is null or cl.camplib3 = 0), 1, cl.camplib3) * co.cant)-1)*100)<23 
    			and coti.fechaelab >= '01.08.2016'
    			and co.autoriza = 'No'
    			and coti.doc_sig is null
    			and SOLICITA_AUTORIZACION = 'Si'";
    	$this->query=$a;
    	$result=$this->QueryObtieneDatosN();
    	while ($tsArray=ibase_fetch_object($result)){
    		$data[]=$tsArray;
    	}
    	return @$data;
    }

    function AutorizarUB($docc, $par){
    	$user = $_SESSION['user']->USER_LOGIN;
    	$a="UPDATE PAR_FACTC01 SET AUTORIZA = 'Si', fecha_autorizacion = current_timestamp, usuario_autoriza = '$user' where cve_doc = '$docc' and num_par = $par
    	 ";
    	 $this->query=$a;
    	 $result =$this->EjecutaQuerySimple();
    	 return $result;
    }

    function RechazoUB($docc, $par){
    	$user = $_SESSION['user']->USER_LOGIN;
    	$a="UPDATE PAR_FACTC01 SET AUTORIZA = 'Ne', fecha_autorizacion= current_timestamp, usuario_autoriza = '$user' where cve_doc = '$docc' and num_par = $par";
    	$this->query = $a;
    	$result=$this->EjecutaQuerySimple();
    	return $result;
    }


	function guardarNuevoGasto($concepto, $proveedor, $referencia, $autorizacion, $presupuesto, $tipopago, $monto, $movpar, $numpar, $usuario, $fechadoc, $fechaven, $exec, $clasificacion) {
    	foreach ($exec AS $impu) {
        	if ($impu->CAUSA_IVA == 'SI')
            	$ivacausado = 0.16;
        	else
           	$ivacausado = 0;
        	$iva_generado = $ivacausado * $monto;
        	$iva_retenido = ($impu->IVA / 100) * $monto;
        	$isr_retenido = ($impu->ISR / 100) * $monto;
        	$flete_retenido = ($impu->FLETE / 100) * $monto;
    	}
    	$total = $monto + $iva_generado + $iva_retenido + $isr_retenido + $flete_retenido;
    	//echo "monto = $monto, presupuesto = ($presupuesto+20)";
    	if($monto > ($presupuesto+20)){
        	$autorizacion = 'X';
        	$estatus = 'X';
    	} else {
        	$autorizacion = '1';
        	$estatus = 'P';
    	}
    	$this->query = "INSERT INTO GASTOS(STATUS, CVE_CATGASTOS, CVE_PROV, REFERENCIA, AUTORIZACION, PRESUPUESTO, TIPO_PAGO, MONTO_PAGO, MOV_PAR, NUM_PAR, USUARIO, IVA_GEN, IVA_RET, ISR_RET, FLETE_RET, FECHA_DOC, VENCIMIENTO,TOTAL,SALDO,CLASIFICACION)
                        	VALUES ('$estatus',$concepto,'$proveedor','$referencia','$autorizacion',$presupuesto,'$tipopago',$monto,'$movpar',$numpar,'$usuario',$iva_generado,$iva_retenido,$isr_retenido,$flete_retenido,'$fechadoc','$fechaven',$total,$monto,$clasificacion);";
    	$resultado = $this->EjecutaQuerySimple();
    	//echo $this->query;
    	return $resultado;
	}
 
	function GuardaPagoGastoCorrecto($cuentaBancaria, $documento, $tipopago, $monto, $proveedor, $claveProveedor, $fechadocumento) {
    	$HOY = date("Y-m-d"); 
    	$res = $this->guardarPagoGasto($documento, $cuentaBancaria, $monto, $fechadocumento,$tipopago);
    	if($res){
        	$this->query = "UPDATE GASTOS
                            	SET FECHA_APLICACION = '$HOY', STATUS = 'P', SALDO = (MONTO_PAGO - $monto)
                        	WHERE ID = '$documento'";
        	$rs = $this->EjecutaQuerySimple();
        	//$rs+= $this->ActPagoParOC($documento, $tipopago, $monto, $proveedor, $clavePago, $fechadocumento);
        	$rs += $this->GuardaCuentaBan($documento, $cuentaBancaria);
        	return $rs;
    	} else {
        	return -1;
    	}
	}

	function generaFolio($medioPago){
//    	$medioPago = "SELECT TIPO_PAGO FROM GASTOS WHERE ID = '$documento'";
    	$folio = "SELECT coalesce(MAX(IDSECUENCIA), 1) FROM PAGO_GASTO_FOLIOS WHERE MEDIO_PAGO = upper('$medioPago')";
    	$this->query = "UPDATE PAGO_GASTO_FOLIOS SET IDSECUENCIA = ($folio)+1 WHERE MEDIO_PAGO = upper('$medioPago');";
    	//echo $this->query;
    	$rs = $this->EjecutaQuerySimple();
    	$this->query = "SELECT 'G' || upper('$medioPago') || IDSECUENCIA AS FOLIO
        	FROM PAGO_GASTO_FOLIOS WHERE MEDIO_PAGO = upper('$medioPago');";
    	//echo $this->query;
    	$result = $this->QueryObtieneDatosN();
    	while ($tsArray = (ibase_fetch_object($result))) {
        	$data[] = $tsArray;
    	}
    	return $data;   	 
	}
    
	function guardarPagoGasto($documento, $cuentaBancaria, $monto, $fecha,$tipopago) {
    	$TIME = time();
    	$HOY = date("Y-m-d H:i:s", $TIME);
    	$folioPago = $this->generaFolio($tipopago);
    	$folio = '';
    	foreach ($folioPago as $data):
        	$folio = $data->FOLIO;
        	//echo "folioPago = $folio -- ";
    	endforeach;
    	if($folioPago!=null){
        	$AUTOINCREMENT = "SELECT coalesce(MAX(ID), 0) FROM PAGO_GASTO";
        	$this->query = "INSERT INTO PAGO_GASTO (ID, IDGASTO, CUENTA_BANCARIA,MONTO, FECHA_REGISTRO,USUARIO_REGISTRA,FECHA_PAGO,CONCILIADO, FOLIO_PAGO) "
                	. "VALUES (($AUTOINCREMENT)+1, '$documento','$cuentaBancaria',$monto,'$HOY','" . $_SESSION['user']->USER_LOGIN . "','$fecha','N','$folio')";
        	//echo $this->query;
        	$rs = $this->EjecutaQuerySimple();
        	//echo "rs = $rs";
    	} else {
        	echo "Fallo al obtener el folio de pago.";
        	return null;
    	}
    	return $rs;
	}

	function listadoXautorizar(){
    	$this->query = "SELECT 'ORDEN DE COMPRA' AS TIPO, CVE_DOC AS IDENTIFICADOR, FECHA_PAGO, CVE_CLPV AS CLAVE_PROVEEDOR, NOMBRE, PAGO_TES AS MONTO, (PAGO_TES - IMPORTE) AS DIFERENCIA  "
                     . "FROM COMPO01 A INNER JOIN  PROV01 B "
                     . "ON A.CVE_CLPV = B.CLAVE WHERE STATUS_PAGO = 'XP' AND TP_TES <> '' AND PAGO_TES > 0 ORDER BY FECHA_PAGO; ";
    		$result = $this->QueryObtieneDatosN();
           	$data = null;
            	 while ($tsArray = (ibase_fetch_object($result))) {
                	     $data[] = $tsArray;
             }
            // (SELECT FIRST 1 cuenta FROM pg_pagoBanco WHERE documento = IDGASTO) AS CUENTA,
        $this->query ="SELECT 'GASTO' AS TIPO, ID AS IDENTIFICADOR, FECHA_CREACION AS FECHA_PAGO, A.CVE_PROV AS CLAVE_PROVEEDOR, NOMBRE, MONTO_PAGO AS MONTO, (A.MONTO_PAGO-PRESUPUESTO) AS DIFERENCIA
                     FROM GASTOS A INNER JOIN PROV01 B ON A.CVE_PROV = B.CLAVE WHERE A.AUTORIZACION = 'X' ORDER BY FECHA_CREACION;";
 
        $result = $this->QueryObtieneDatosN();
             while ($tsArray = (ibase_fetch_object($result))) {
                     $data[] = $tsArray;
             }
             return $data;
    }
    
	function xAutorizar($tipo, $identificador){
    	$data = null;
    	if($tipo=="GASTO"){
        	// (SELECT FIRST 1 cuenta FROM pg_pagoBanco WHERE documento = IDGASTO) AS CUENTA,
        	$this->query = "SELECT 'GASTO' AS TIPO, ID AS IDENTIFICADOR, FECHA_CREACION AS FECHA_PAGO, A.CVE_PROV AS CLAVE_PROVEEDOR, NOMBRE, MONTO_PAGO AS MONTO, (A.MONTO_PAGO-PRESUPUESTO) AS DIFERENCIA
        	FROM GASTOS A INNER JOIN PROV01 B ON A.CVE_PROV = B.CLAVE WHERE A.AUTORIZACION = 'X' AND ID = '$identificador';";
       	 
        	$result = $this->QueryObtieneDatosN();
        	while ($tsArray = (ibase_fetch_object($result))) {
            	$data[] = $tsArray;
        	}
    	} else {
        	$this->query = "SELECT 'ORDEN DE COMPRA' AS TIPO, CVE_DOC AS IDENTIFICADOR, FECHA_PAGO, CVE_CLPV AS CLAVE_PROVEEDOR, NOMBRE, PAGO_TES AS MONTO "
                	. "FROM COMPO01 A INNER JOIN  PROV01 B "
                	. "ON A.CVE_CLPV = B.CLAVE WHERE STATUS_PAGO = 'XP' AND TP_TES <> '' AND PAGO_TES > 0 WHERE CVE_DOC = '$identificador'; ";

        	$result = $this->QueryObtieneDatosN();
        	while ($tsArray = (ibase_fetch_object($result))) {
            	$data[] = $tsArray;
        	}
    	}
    	return $data;
	}
    


function Pagos() {
		$data=array();
        $this->query = "SELECT a.cve_doc, b.nombre, a.importe, a.fechaelab, a.fecha_doc, doc_sig as Recepcion, a.enlazado, c.camplib1 as TipoPagoR, c.camplib3 as FER,c.camplib2 as TE, c.camplib4 as Confirmado, a.tp_tes as PagoTesoreria, a.pago_tes, pago_entregado, c.camplib6, a.cve_clpv, a.URGENTE, datediff(day, a.fechaelab, current_date ) as Dias, 
        				(select iif(sum(lp.cantidad * poc.cost )is null, 0 , sum(lp.cantidad * poc.cost)) FROM LIB_PARTIDAS lp left join par_compo01 poc on poc.cve_doc = lp.oc and poc.num_par = lp.partida_oc WHERE PROVEEDOR = b.clave group by Proveedor) as saldoprov,
        				b.BBVA_ALTA as BBVA 
                        from compo01 a
                        left join Prov01 b on a.cve_clpv = b.clave
                        LEFT JOIN compo_clib01 c on a.cve_doc = c.clave_doc
                        where a.status <> 'C' and TP_TES is null and fechaelab > '03/14/2016' order by a.fechaelab asc";
        ///echo $this->query;
        $result = $this->QueryObtieneDatosN();
        while ($tsArray = ibase_fetch_object($result)) {
            $data[] = $tsArray;
        }

        $this->query = "SELECT s.idsol as cve_doc, p.nombre, s.monto as importe, s.fecha as fechaelab, 'Ver Documentos' as Recepcion, 'NA' as enlazado, tipo as tipopagoR, 'NA' as fer, 'NA' as TE, usuario as CONFIRMADO, TIPO AS PagoTesoreria, 'NA' as pago_entregado, 'NA' as camplib6, s.proveedor as CVE_CLPV, 'NA' as urgente, 'NA' as Dias,
        	(select iif(sum(lp.cantidad * poc.cost )is null, 0 , sum(lp.cantidad * poc.cost)) FROM LIB_PARTIDAS lp left join par_compo01 poc on poc.cve_doc = lp.oc and poc.num_par = lp.partida_oc WHERE PROVEEDOR = p.clave group by Proveedor) as saldoprov, 
        	p.BBVA_ALTA as BBVA, s.usuario_pago, s.STATUSTR 
        		from SOLICITUD_PAGO s
        		inner join prov01 p on p.clave = s.proveedor
        		where s.status = '0' ";
        $rs = $this->QueryObtieneDatosN();
        while($tsArray = ibase_fetch_object($rs)){
        	$data[]=$tsArray;
        }

        $this->query="SELECT ftcpoc.OC AS CVE_DOC, p.nombre, ftcpoc.costo_total as importe, ftcpoc.fecha_oc as fechaelab, 'Ver Documentos' as Recepcion, 'NA' as enlazado, ftcpoc.tp_tes_req as tipopagoR, ftcpoc.fecha_entrega as fer, ftcpoc.tipo as TE, ftcpoc.usuario_oc as confirmado, 'Tipo' as PagoTesoreria, 'NA' as pago_entregado, 'NA' as camplib6, ftcpoc.cve_prov as cve_clpv, 'NA' as urgente, 'NA' as DIAS, 
        	(select iif(sum(lp.cantidad * poc.cost )is null, 0 , sum(lp.cantidad * poc.cost)) FROM LIB_PARTIDAS lp left join par_compo01 poc on poc.cve_doc = lp.oc and poc.num_par = lp.partida_oc WHERE PROVEEDOR = p.clave group by Proveedor) as saldoprov, 
        	p.BBVA_ALTA as BBVA, ftcpoc.usuario_pago, ftcpoc.statustr
        from FTC_POC ftcpoc 
        left join prov01 p on p.clave = ftcpoc.cve_prov
        where ftcpoc.status = 'ORDEN' and TP_TES is null ";
        $rs=$this->EjecutaQuerySimple();

        while ($tsArray = ibase_fetch_object($rs)){
        	$data[]=$tsArray;
        }

        return $data;
    	}


    function Cheques(){
    	$a="SELECT P.*, B.BANCO 
    		FROM P_CHEQUES P
    		LEFT JOIN PG_PAGOBANCO B ON B.folio_pegaso = P.cheque
      		WHERE FOLIO_REAL is null and p.id > 1842 ";
    	$this->query=$a;
    	$result=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($result)){
    		$data[]=$tsArray;
    	}
    	return @$data;
    }

    function folioReal(){
    	$a="SELECT max(folio_real) as FOLIO_REAL 
    			FROM P_CHEQUES";
		$this->query=$a;
		$rs=$this->QueryObtieneDatosN();
		$row=ibase_fetch_object($rs);
		$folio=$row->FOLIO_REAL;
		$folion=$folio+1;

		return $folion;		
    }

    function DatosCheque($cheque){
    	$a="SELECT * 
    		FROM P_CHEQUES 
    		WHERE CHEQUE='$cheque'";
    	$this->query=$a;
    	$rs=$this->QueryObtieneDatosN();
    	$row=ibase_fetch_object($rs);

    	return $row;
    }

    function impChBanamex($cheque, $fecha, $folio){
        $f=explode('-', $fecha);
        
    	$fech= $f[0].'.'.$f[1].'.'.$f[2];
    	
    	$this->query="UPDATE P_CHEQUES SET FOLIO_REAL = $folio, FECHA_APLI='$fech' WHERE CHEQUE='$cheque'";
    
    	$rs=$this->EjecutaQuerySimple();
    	return $rs;
    }


    function listadoPagosImpresion() {
    	$data = null;
    	$this->query="SELECT 'GASTO' AS TIPO, IDGASTO AS IDENTIFICADOR, FECHA_PAGO, B.CVE_PROV AS CLAVE_PROVEEDOR, NOMBRE, MONTO "
            	. "FROM PAGO_GASTO A INNER JOIN GASTOS B "
            	. "ON A.IDGASTO = B.ID INNER JOIN PROV01 C ON B.CVE_PROV = C.CLAVE "
            	. "WHERE B.STATUS = 'P' ORDER BY FECHA_PAGO;";
    	$result = $this->QueryObtieneDatosN();
    	while ($tsArray = (ibase_fetch_object($result))) {
        	$data[] = $tsArray;
    	}
    	return $data;
	}

	function DatosPago($identificador){
		$a="SELECT g.*, p.nombre, pg.*  
			from GASTOS g
			INNER JOIN PROV01 p ON p.clave = g.cve_prov
			INNER JOIN PAGO_GASTO pg on pg.idgasto = g.id  
			WHERE g.ID = $identificador";
		$this->query=$a;
		$result = $this->QueryObtieneDatosN();
		$row=ibase_fetch_object($result);
		return $row;
	}

	function cancelarPedidos(){
		$a="SELECT p.*, pr.nombre 
			from FACTP01 p
			left join prov01 pr on pr.clave = p.cve_clpv 
			WHERE ENLAZADO = 'T' AND FECHA_CANCELA IS NULL  AND DOC_SIG IS NULL";
		$this->query= $a;
		$rs = $this->QueryObtieneDatosN();
		while($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}
		return @$data;
	}

	function cancelaPedido($pedido, $motivo){
		$usuario = $_SESSION['user']->USER_LOGIN;
		$a="UPDATE FACTP01 SET ENLAZADO = 'O', MOTIVO_CANCELACION = ('$usuario'||' : '||'$motivo') WHERE CVE_DOC = '$pedido'";
		$this->query=$a;
		$rs = $this->EjecutaQuerySimple();

		$b="UPDATE PAR_FACTP01 SET PXS = CANT WHERE CVE_DOC = '$pedido'";
		$this->query=$b;
		$rs = $this->EjecutaQuerySimple();

		return $rs; 
	}

	function listaClientes(){
		$a="SELECT C.*, (select sum(SALDO) from carga_pagos CPA WHERE C.CLAVE = CPA.cliente group BY CPA.CLIENTE) AS saldoxa FROM CLIE01 C ;";
		$this->query=$a;
		$rs=$this->QueryObtieneDatosN();
		while($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}
		return $data;
	}

	function cargaPago($cliente){
		$a="SELECT cl.* 
			from clie01 cl
			where 	TRIM(clave) = TRIM('$cliente')";
		$this->query=$a;
		$rs=$this->QueryObtieneDatosN();
		while($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}
		return $data;
	}

       function listarCuentasBancarias(){
            $this->query = "SELECT ID, BANCO, NUM_CUENTA, B.DESCR FROM PG_BANCOS A INNER JOIN MONED01 B ON A.MONEDA = B.NUM_MONED";
            $result = $this->QueryObtieneDatosN();
            $data = array();
            while ($tsArray = (ibase_fetch_object($result))) {
                    $data[] = $tsArray;
            }
            //echo $this->query;
            return $data;            
        }
        
        function obtenerEdoCtaDetalle($identificador){
            $this->query = "SELECT FIRST 20 B.ID AS IDREGISTRO, A.ID AS IDENTIFICADOR, A.BANCO, A.NUM_CUENTA, B.FEREGISTRO, B.DSREGISTRO, B.DCREGISTRO 
                    FROM ESTADOCUENTA_REGISTRO B INNER JOIN PG_BANCOS A ON A.ID = B.IDCTABAN 
                    WHERE B.IDCTABAN = '$identificador' ORDER BY FEREGISTRO DESC;";
            $result = $this->QueryObtieneDatosN();
            $data = null;
            while ($tsArray = (ibase_fetch_object($result))) {
                    $data[] = $tsArray;
            }
            return $data;            
        }

        function estadoCuentaRegistrar($idcuenta, $fecha, $descripcion, $monto){
            $TIME = time();
            $HOY = date("Y-m-d H:i:s", $TIME);
            $USUARIO = $_SESSION['user']->USER_LOGIN;
            $AUTOINCREMENT = "SELECT coalesce(MAX(ID), 0) FROM ESTADOCUENTA_REGISTRO";
            $this->query = "INSERT INTO ESTADOCUENTA_REGISTRO VALUES (";
            $this->query.= "($AUTOINCREMENT)+1, $idcuenta, '$fecha', '$descripcion',$monto,'$HOY','$USUARIO');";
            //echo "query: ".$this->query;
            $result=$this->EjecutaQuerySimple();
            return $result;
        }
        
        function obtenerEdoCtaDetalleDia($identificador, $dia){
            //$TIME = time();
            //$HOY = date("Y-m-d H:i:s", $TIME);
            $this->query = "SELECT FIRST 20 B.ID AS IDREGISTRO, A.ID AS IDENTIFICADOR, A.BANCO, A.NUM_CUENTA, B.FEREGISTRO, B.DSREGISTRO, B.DCREGISTRO 
                    FROM ESTADOCUENTA_REGISTRO B INNER JOIN PG_BANCOS A ON A.ID = B.IDCTABAN 
                    WHERE B.IDCTABAN = '$identificador' AND B.FEREGISTRO = CAST('$dia' AS TIMESTAMP) ORDER BY FEREGISTRO DESC;";
            
            $result = $this->QueryObtieneDatosN();
            //$data[] = null;
            while ($tsArray = (ibase_fetch_object($result))) {
                    $data[] = $tsArray;
            }
            return @$data;            
        }

        function listadoXrecibir(){
           $this->query = "SELECT ('Gasto'||'-'||cat.gasto) AS TIPO, A.ID AS IDENTIFICADOR, FECHA_DOC AS FECHA_PAGO, A.CVE_PROV AS CLAVE_PROVEEDOR, NOMBRE, MONTO_PAGO AS MONTO, (A.MONTO_PAGO-A.PRESUPUESTO) AS DIFERENCIA, P.CUENTA_BANCARIA AS BANCO
                   FROM GASTOS A INNER JOIN PROV01 B ON A.CVE_PROV = B.CLAVE 
                   				INNER JOIN PAGO_GASTO P ON A.ID = P.IDGASTO  
                   				INNER JOIN CAT_GASTOS cat ON cat.id = A.CVE_CATGASTOS
                   				WHERE A.STATUS = 'I';";
           $result = $this->QueryObtieneDatosN();
           while ($tsArray = (ibase_fetch_object($result))) {
               $data[] = $tsArray;
           }
           $this->query = "SELECT 'ORDEN DE COMPRA' AS TIPO, CVE_DOC AS IDENTIFICADOR, FECHA_PAGO, CVE_CLPV AS CLAVE_PROVEEDOR, NOMBRE, PAGO_TES AS MONTO, A.BANCO AS BANCO "
                   . "FROM COMPO01 A INNER JOIN  PROV01 B "
                   . "ON A.CVE_CLPV = B.CLAVE WHERE STATUS_PAGO = 'I'";
           $result = $this->QueryObtieneDatosN();
           while ($tsArray = (ibase_fetch_object($result))) {
               $data[] = $tsArray;
           }                    
           return @$data;            
       }
       
       function marcarRecibido($tipo, $identificador, $fecha, $banco, $monto){
       	//	echo $tipo;
       		$tipo = strtoupper(substr($tipo, 0, 5));
       	//	echo $tipo;
       	//	break;
           if($tipo=="GASTO"){
               $this->query = "UPDATE GASTOS SET STATUS = 'V' WHERE ID = '$identificador';";
        //       echo $this->query;
        //       break;
           }else{
               $this->query = "UPDATE COMPO01 SET STATUS_PAGO = 'V' WHERE CVE_DOC = '$identificador';";
           }
           $result = $this->EjecutaQuerySimple();
           /// Actualizacion para el control del saldo del estado de cuenta desde PG_Bancos
           	$campo='MOVR'.substr($fecha, 5,2);
			$camposf='SALDOF'.substr($fecha, 5,2);
			//echo 'Asi llega el Banco'.$banco;
			if($banco !=''){
				$cuenta=explode('-',$banco);
			}
			$cuenta2=trim($cuenta[1]);

				/// Actualizamos los movimientos de cargo mensual segun el mes:
           		$this->query="UPDATE PG_BANCOS SET $campo= ($campo + $monto), $camposf=($camposf + $monto) where trim(NUM_CUENTA) = trim('$cuenta2')";
           		$rs=$this->EjecutaQuerySimple();
           		/// Actualizamos el saldo: de la cuenta:
           		$this->query="UPDATE PG_BANCOS SET SALDO= (SALDOF01 + SALDOF02 + SALDOF03 + SALDOF04 + SALDOF05 + SALDOF07 + SALDOF08 + SALDOF09 + SALDOF10 + SALDOF11 + SALDOF12 + SALDOI)";
           		$rs=$this->EjecutaQuerySimple();


           return $result;
       }
       
       function listadoXconciliar(){
           $this->query = "SELECT 'GASTO' AS TIPO, ID AS IDENTIFICADOR, FECHA_CREACION AS FECHA_PAGO, A.CVE_PROV AS CLAVE_PROVEEDOR, NOMBRE, MONTO_PAGO AS MONTO, (A.MONTO_PAGO-PRESUPUESTO) AS DIFERENCIA
                   FROM GASTOS A INNER JOIN PROV01 B ON A.CVE_PROV = B.CLAVE WHERE A.STATUS = 'V';";
           $result = $this->QueryObtieneDatosN();
           while ($tsArray = (ibase_fetch_object($result))) {
               $data[] = $tsArray;
           }
           $this->query = "SELECT 'ORDEN DE COMPRA' AS TIPO, CVE_DOC AS IDENTIFICADOR, FECHA_PAGO, CVE_CLPV AS CLAVE_PROVEEDOR, NOMBRE, PAGO_TES AS MONTO "
                   . "FROM COMPO01 A INNER JOIN  PROV01 B "
                   . "ON A.CVE_CLPV = B.CLAVE WHERE STATUS_PAGO = 'V'";
           $result = $this->QueryObtieneDatosN();
           while ($tsArray = (ibase_fetch_object($result))) {
               $data[] = $tsArray;
           }                    
           return @$data;            
       }
       
       function pagoAconciliar($tipo, $identificador){
           if($tipo=="GASTO"){
               $this->query = "SELECT 'GASTO' AS TIPO, ID AS IDENTIFICADOR, FECHA_CREACION AS FECHA_PAGO, A.CVE_PROV AS CLAVE_PROVEEDOR, NOMBRE, MONTO_PAGO AS MONTO, (A.MONTO_PAGO-PRESUPUESTO) AS DIFERENCIA
                       FROM GASTOS A INNER JOIN PROV01 B ON A.CVE_PROV = B.CLAVE WHERE A.STATUS = 'V' AND A.ID = '$identificador';";
               $result = $this->QueryObtieneDatosN();
               while ($tsArray = (ibase_fetch_object($result))) {
                   $data[] = $tsArray;
               }
           } else {
               $this->query = "SELECT 'ORDEN DE COMPRA' AS TIPO, CVE_DOC AS IDENTIFICADOR, FECHA_PAGO, CVE_CLPV AS CLAVE_PROVEEDOR, NOMBRE, PAGO_TES AS MONTO "
                       . "FROM COMPO01 A INNER JOIN  PROV01 B "
                       . "ON A.CVE_CLPV = B.CLAVE WHERE STATUS_PAGO = 'V' AND CVE_DOC = '$identificador';";
               $result = $this->QueryObtieneDatosN();
               while ($tsArray = (ibase_fetch_object($result))) {
                   $data[] = $tsArray;
               }       
           }
           return @$data;            
       }
       
       function pagoConciliar($tipo, $identificador, $fecha){
           $TIME = time();
           $HOY = date("Y-m-d H:i:s", $TIME);
           $rs = $this->xAutorizarDictamen($tipo, $identificador, "Z", "Pago conciliado: $HOY", $fecha);
           return $rs;
       }
       
 	function xAutorizarDictamen($tipo, $identificador, $dictamen, $comentarios){
           if($tipo == "GASTO") {       	 
                   $dictamen = $dictamen=='A'?'E':'R';
                  $this->query = "UPDATE GASTOS
                            SET STATUS = '$dictamen', Autorizacion = '1'
                        WHERE ID = '$identificador'";
                   $rs = $this->EjecutaQuerySimple();
           } else {
                   //$dictamen = $dictamen=='A'?'PP':'PR';
                   $this->query = "UPDATE compo01
                            SET STATUS_PAGO = '$dictamen'
                        WHERE CVE_DOC = '$identificador'";
                   $rs = $this->EjecutaQuerySimple();
           }
           $AUTOINCREMENT = "SELECT coalesce(MAX(ID), 0) FROM PAGO_AUTORIZACION";
           $this->query = "INSERT INTO PAGO_AUTORIZACION (ID, IDPAGO, TXCOMENTARIO, FECHA_DICTAMEN,USUARIO_REGISTRA) "
                   . "VALUES (($AUTOINCREMENT)+1, '$identificador','$comentarios',current_timestamp ,'" . $_SESSION['user']->USER_LOGIN . "')";
           $rs+=$this->EjecutaQuerySimple();
           return $rs;
  	}

  	function ActStatusImp($identificador){
  		$a="UPDATE GASTOS SET STATUS = 'I' WHERE ID = $identificador";
  		$this->query=$a;
  		$rs=$this->EjecutaQuerySimple();
  		return @$rs;
  	}  	

  	function guardaPago($cliente, $monto, $fechaA, $fechaR, $banco){
  		$usuario=$_SESSION['user']->USER_LOGIN;
  		$a="INSERT INTO CARGA_PAGOS (CLIENTE, FECHA, MONTO, SALDO, USUARIO, BANCO, Fecha_Apli, Fecha_Recep,  )
  					VALUES ('$cliente',current_timestamp, $monto, $monto, '$usuario', '$banco','$fechaA', '$fechaR')";
  		$this->query = $a;
  		$rs=$this->EjecutaQuerySimple();
  		return $rs; 
  	}

  	function regPagos($cliente){
  		$a="SELECT * from CARGA_PAGOS where TRIM(cliente) = TRIM('$cliente')";
  		$this->query=$a;
  		$rs=$this->QueryObtieneDatosN();
  		while ($tsArray=ibase_fetch_object($rs)){
  			$data[]=$tsArray;
  		}
  		return @$data;
  	}

  	function saldoXaplicar(){
  		$a="SELECT cliente, sum(SALDO) from carga_pagos group by cliente;";
  		$this->query=$a;
  		$rs=$this->QueryObtieneDatosN();
  		while($tsArray=ibase_fetch_object($rs)){
  			$data[]=$tsArray;
  		}
  		return @$data;
  	}

  	function aplicarPago($cliente){
    	$a="SELECT c.*,
     	(select SUM(s.SALDO) from carga_pagos s where trim(c.clave) = trim(s.cliente)) as sxa,
     	ca.*,
     	(SELECT SUM(IMPORTE) FROM FACTP01 WHERE DOC_ANT = '' AND TRIM(CVE_CLPV) = TRIM('$cliente')) as MONTO_PEDIDOS,
     	((SELECT SUM(IMPORTE) FROM factf01 WHERE TRIM(CVE_CLPV) = TRIM('$cliente')) -
     	(SELECT SUM(IMPORTE) FROM CUEN_DET01 WHERE TRIM(CVE_CLIE) = TRIM('$cliente') AND SIGNO = -1 )) AS MONTO_FACTURADO,
     	(SELECT SUM(IMPORTE) FROM FACTF01 WHERE FECHA_VEN > current_date AND TRIM(CVE_CLPV) = TRIM('$cliente')) AS VENCIDO,
     	ca.LINEA_CRED -(((SELECT SUM(IMPORTE) FROM FACTP01 WHERE DOC_ANT = '' AND TRIM(CVE_CLPV) = TRIM('$cliente'))+((SELECT SUM(IMPORTE) FROM factf01 WHERE TRIM(CVE_CLPV) = TRIM('$cliente')))) -
     	(SELECT SUM(IMPORTE) FROM CUEN_DET01 WHERE TRIM(CVE_CLIE) = TRIM('$cliente') AND SIGNO = -1 ))  AS DISPONIBLE
            FROM CLIE01 c
            left join cartera ca on trim(ca.idcliente) = trim(c.clave)
            WHERE TRIM(CLAVE)=TRIM('$cliente')";
    	$this->query = $a;
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return @$data;
    }

    function traeFacturas($cliente){
    	$a="SELECT FIRST 100 f.*, c.fecha_rec_cobranza, c.contrarecibo_cr, datediff(day, c.fecha_rec_cobranza,current_timestamp ) as dias
    		from FACTF01 f 
    		left join CAJAS c on f.cve_doc = c.factura
    		where trim(cve_clpv) = trim('$cliente')
    		order by f.fechaelab desc";
    	$this->query=$a;
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return @$data;
    }

    function CuentasBancarias($banco, $cuenta){
    	$this->query="SELECT b.*, 
        	(SELECT SUM(MONTO) FROM CARGA_PAGOS p
            where extract(month from fecha_recep) = extract(month from current_date)
            and (b.banco||' - '||b.num_cuenta) = p.banco
            GROUP BY BANCO) as ABONOS_ACTUAL,
            (SELECT SUM(MONTO) FROM CARGA_PAGOS p
            where extract(month from fecha_recep)-1 = extract(month from current_date)-1
            and (b.banco||' - '||b.num_cuenta) = p.banco
            GROUP BY BANCO) as ABONOS_ANTERIOR,
            (SELECT SUM(SALDO) FROM CARGA_PAGOS p
            where extract(month from fecha_recep)-1 = extract(month from current_date)-1
            and (b.banco||' - '||b.num_cuenta) = p.banco
            GROUP BY BANCO) as MOV_X_REL_AC,
            (SELECT SUM(SALDO) FROM CARGA_PAGOS p
            where extract(month from fecha_recep)-1 = extract(month from current_date)-1
            and (b.banco||' - '||b.num_cuenta) = p.banco
            GROUP BY BANCO) as MOV_X_REL_AN
            FROM PG_BANCOS b 
           	where b.banco = '$banco' and b.num_cuenta='$cuenta'";
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return @$data;
    }

    function pagosTotalMensual($banco, $cuenta){
    	$this->query="SELECT SUM(MONTO), BANCO FROM CARGA_PAGOS where extract(month from fecha_recep) = extraxt(month from current_date) GROUP BY BANCO";
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return @$data;
    }

    function traePagosActual($banco, $cuenta ){
    	$this->query="SELECT cp.*, (select nombre from maestros where cast(id as varchar(100)) = cp.cliente) as nombre 
    	FROM CARGA_PAGOS cp
    	WHERE extract(MONTH from FECHA_RECEP) >= extract(MONTH from CURRENT_DATE) -2
    	--and extract(day from fecha_recep) = extract(day from current_date)
    	and extract(year from fecha_recep) = extract(year from current_date)
    	and banco = ('$banco'||' - '||'$cuenta') AND STATUS <> 'C'
    	order by cp.fecha desc";
    	//echo $this->query;
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return @$data;
    }

    function traePagosAnterior($banco, $cuenta){
    	$this->query="SELECT * FROM CARGA_PAGOS WHERE extract(month from FECHA_RECEP)-1 = extract(month from current_date)-1";
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return @$data;
    } 

    function ingresarPago($banco, $monto, $fecha, $ref, $maestro, $tipo, $obs){
    	$usuario=$_SESSION['user']->USER_LOGIN;
    	$f_a = date("d-m-Y" );
		$fa7= date("d-m-Y",strtotime($f_a."-760 days"));
    	if(trim(substr($banco, 0,8))=='Banamex' or trim(substr($banco, 0,8))=='Bancomer'){
	    	$fa7= date("d-m-Y",strtotime($f_a."-760 days"));
	    }else{
			$fa7= date("d-m-Y",strtotime($f_a."-760 days"));
		}//exit($banco);
		$fminima = strtotime($fa7, time());   	
		$f_e = strtotime($fecha, time());
		if($f_e >= $fminima){ 
			$b=explode(' - ', $banco);
	    	$banco = $b[0];
	    	$cuenta = $b[1];
	    	$mes = substr($fecha, 3, 2);
	    	$anio = substr($fecha, 6,4);
	    	$val=$this->validaEdoCta($banco, $cuenta, $mes, $anio);
	    	if($val == 'ok'){
		    	$this->query="SELECT * FROM PG_BANCOS WHERE NUM_CUENTA = '$cuenta' and BANCO = '$banco'";
		    	$rs=$this->EjecutaQuerySimple();
				$row=ibase_fetch_object($rs);
				$sb=$row->SERIE;
				$sbl=0;
				$banco = $banco.' - '.$cuenta;
				if(!empty($sb)){
					$sbl=strlen($sb)+2;
				}
				$cuentaCompleta=$row->BANCO.' - '.$row->NUM_CUENTA;
				$this->query="SELECT coalesce( MAX(cast(substring(FOLIO_X_BANCO from $sbl) as int)), 0) as ULTIMO FROM CARGA_PAGOS	WHERE FOLIO_X_BANCO STARTING WITH '$sb'";
			    $rs=$this->	QueryObtieneDatosN();
			    $row=ibase_fetch_object($rs);
			    if($row){
			    	$folio=$sb.'-'.($row->ULTIMO+1);
			    }
		    	//if(trim(substr($banco, 0,8))=='Banamex'){
		    	//	$folio_1 = 'BNMX';
		    	//}elseif (trim(substr($banco, 0,8))=='BBVA BAN'){
		    	//	$folio_1='BBVA';
		    	//}elseif (trim(substr($banco, 0,8))=='Multiva'){
		    	//	$folio_1='MTVA';
		    	//}elseif (trim(substr($banco, 0,8))=='Inbursa'){
		    	//	$folio_1='INBU';
		    	//}elseif(trim(substr($banco, 0,8))=='Banco Az'){
		    	//	$folio_1='BAZT';
		    	//}
		    	//$this->query="SELECT MAX(cast(substring(FOLIO_X_BANCO from 6 for 6) as int)) as ULTIMO
		    	//		FROM CARGA_PAGOS
		    	//		WHERE FOLIO_X_BANCO STARTING WITH '$folio_1'";
		    	//$rs=$this->	QueryObtieneDatosN();
		    	//$row=ibase_fetch_object($rs);
		    	//if($row){
		    	//	$folio = $row->ULTIMO + 1;
		    	//}else{
		    	//	$folio = 1;
		    	//}

		    	$this->query="SELECT coalesce(SUM(SALDOFINAL),0) as SALDO, coalesce((select sum(saldo) from carga_pagos where cliente = '$maestro' and status <> 'C' and seleccionado > 0 and guardado > 0), 0) as acreedores FROM FACTURAS_PENDIENTES WHERE CLAVE_MAESTRO = (SELECT CLAVE FROM MAESTROS WHERE ID = $maestro)";
		    	$res =$this->EjecutaQuerySimple();
		    	$valsaldo=ibase_fetch_object($res);
			    $val = $valsaldo->SALDO;
			    $acreedores = $valsaldo->ACREEDORES;
			    $monto1 = $monto + $acreedores;
			    
			    $this->query="SELECT coalesce(SUM(SALDOFINAL),0) as SALDO FROM FACTURAS_PENDIENTES_FP WHERE CLAVE_MAESTRO = (SELECT CLAVE FROM MAESTROS WHERE ID = $maestro)";
		    	$res2 =$this->EjecutaQuerySimple();
		    	$valsaldo2=ibase_fetch_object($res2);
			    $val2 = $valsaldo2->SALDO;
			    $val = $val + $val2;
			    $campo = '';
			    $um='b';

			    if($tipo<>'9999'){
			    	$val=99999999;
			    	$campo = ' ,tipo_pago';
			    	$valor = ", '".$tipo."'";
			    	$um = 'a';
			    }else{
			    	$campo = ' ,cliente';
			    	$valor = ",'".$maestro."'";
			    }
			    if( ($val+10000000) >= $monto1 ){
			    	$this->query="INSERT INTO CARGA_PAGOS (FECHA, MONTO, SALDO, USUARIO, BANCO, FECHA_RECEP, FOLIO_X_BANCO $campo, OBS)
			    					VALUES (current_timestamp, $monto, $monto, '$usuario', '$banco', '$fecha', '$folio' $valor, '$obs')";
			    	$rs=$this->EjecutaQuerySimple();
				    	if($um == 'b'){
				    		$this->query="UPDATE MAESTROS SET ACREEDOR = ACREEDOR + $monto where id = $maestro";
				    		$res=$this->queryActualiza();
				    		if($res == 1){
								$mensaje= 'Se agrego correctamente el pago';
					    	}else{
					    		$mensaje = 'No se actualizo el saldo del cliente, favor de reportar a sistemas';
					    	}
				    	}else{
				    		$mensaje = 'Se agrego como tipo: '.$tipo;
				    	}
		    	}else{
		    		$mensaje = 'No se puede agregar ya que el Maestro no tiene documentos pendientes de pago o el saldo por aplicar: $ '.number_format($acreedores,3).' mas el monto del pago $ '.number_format($monto,3).' es mayor al monto deudor $ '.number_format($val,3);
		    	}
			}else{
	    		$mensaje= 'No se puede agregar ya que el estado de cuenta ha sido conciliado por contabliliad';
	    	}
		}else{
			$mensaje='La fecha de registro es menor al: '.$fa7.' y no se permiten ingresos de menos de 3 dias';
		}
		//exit($mensaje);
	  	return $mensaje;
    }

    function validaEdoCta($banco, $cuenta, $mes, $anio){
   		$this->query="SELECT ID from FTC_CTRL_BANCOS where BANCO = ('$banco') and cuenta = ('$cuenta') and periodo = $mes and anio = $anio";
    	$res=$this->EjecutaQuerySimple();
    	$row = ibase_fetch_object($res);
    	//echo $this->query;
    	if(empty($row)){
    		$val = 'ok';
    	}else{
    		$val = 'No';
    	}
    	return $val;
   	}

   	function cierreBanco($banco, $cuenta, $mes, $anio){
   		$data=array();
   		$this->query="SELECT * from FTC_CTRL_BANCOS where BANCO = ('$banco') and cuenta = ('$cuenta') and periodo = $mes and anio = $anio";
    	$res=$this->EjecutaQuerySimple();
    	while ($tsArray=ibase_fetch_object($res)){
    		$data[]=$tsArray;
    	}
    	return $data;
   	}

    function estado_de_cuenta($banco, $cuenta){
    	$data[]=null;
    	$this->query="SELECT 'Venta' AS TIPO, FOLIO_X_BANCO AS CONSECUTIVO, FECHA_RECEP AS FECHAMOV, MONTO AS MONTO, SALDO AS SALDO, BANCO AS BANCO, USUARIO AS USUARIO, tipo_pago as TP, ID as IDENTIFICADOR
    		   from carga_pagos where BANCO = ('$banco'||' - '||'$cuenta')";
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}

    	//$this->query="SELECT 'Gasto' AS TIPO, FOLIO_PAGO AS CONSECUTIVO, FECHA AS FECHAMOV, MONTO AS MONTO, 0 AS SALDO, TRIM(SUBSTRING(CUENTA_BANCARIA FROM 1 FOR 9)) AS BANCO, USUARIO_REGISTRA AS USUARIO 
    	//		FROM PAGO_GASTO WHERE CUENTA_BANCARIA = ('$banco'||' - '||'$cuenta') and status = 'V'";
    	//$rs=$this->QueryObtieneDatosN();
    	//while ($tsArray=ibase_fetch_object($rs)){
    	//	$data[]=$tsArray;
    	//}
    	$this->query="SELECT 'Compra' AS TIPO, CVE_DOC AS CONSECUTIVO, FECHAELAB AS FECHAMOV, IMPORTE AS MONTO, 0 AS SALDO, BANCO AS BANCO, '' AS USUARIO, 'tipoCompra' as TP, CVE_DOC as IDENTIFICADOR FROM COMPR01 WHERE BANCO = ('$banco'||' - '||'$cuenta')";
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray = ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return @$data;
    }

     function sinicial($banco, $cuenta, $mes, $anio){
    	if($mes==1){
    		$anio = $anio -1;
    		$mes = 12;
    	}else{
    		$mes = $mes-1;
    	}
    	$this->query="SELECT iif(MONTO_FINAL is null, 0, MONTO_FINAL) AS INICIAL FROM FTC_CTRL_BANCOS WHERE BANCO = '$banco' and Cuenta = '$cuenta' and periodo = $mes and anio = $anio";
    	$rs=$this->EjecutaQuerySimple();
    	//echo $this->query;
    	$row=ibase_fetch_object($rs);
    	if(empty($row)){
    		$inicial = 0;
    	}else{
    		$inicial =$row->INICIAL;
    	}
    	//exit($inicial);
    	return $inicial;

    }
 
	function estado_de_cuenta_mes($mes, $banco, $cuenta, $anio){
	   	 /// Pendientes edo de cuenta 
    	 /// Ordenar por fecha.
    	 /// cambiar el formato de los numero 
		$data = array();
		######### Ajustes de Manejo de dia de corte##########
		####
			$this->query="SELECT * FROM PG_BANCOS WHERE BANCO = '$banco' and num_cuenta='$cuenta'";
			$res=$this->EjecutaQuerySimple();
			$bn=ibase_fetch_object($res);
			$corte = $bn->DIA_CORTE;
			$fechaIni=$corte.'.'.$mes.'.'.$anio;
			if($corte == 1){
				$fechafin=($corte).'.'.($mes+1).'.'.$anio;
			}else{
				$fechafin=($corte-1).'.'.($mes+1).'.'.$anio;
			}
		#####################################################
		//echo 'Banco'.$banco.' Cuenta: '.$cuenta.'<p>'; 
    	$this->query="SELECT 1 as s, FECHA_RECEP AS sort, 'Venta' AS TIPO,  iif(FOLIO_X_BANCO = 'TR', (FOLIO_X_BANCO||id), FOLIO_X_BANCO) AS CONSECUTIVO, FECHA_RECEP AS FECHAMOV, MONTO AS ABONO, 0 AS CARGO, SALDO AS SALDO, BANCO AS BANCO, USUARIO AS USUARIO, tipo_pago as TP, id as identificador, registro as registro, folio_acreedor as FA , fecha_recep as fe, '' as comprobado, contabilizado, seleccionado, '' as tp_tes, obs 
    		   from carga_pagos 
    		   where BANCO = ('$banco'||' - '||'$cuenta') 
    		   		and fecha_recep between '$fechaIni' and '$fechafin'
    		   		and extract(year from fecha_recep) = $anio 
    		   		AND STATUS <> 'C' and (seleccionado = 1 or seleccionado = 0 or seleccionado is null)  
    		   		order by fecha_recep asc";
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	
    	$this->query="SELECT  4 as s, iif(fecha_EDO_CTA is null, fecha_doc, fecha_EDO_CTA) as sort, 'Gasto' AS TIPO, pg.IDGASTO AS CONSECUTIVO, iif(fecha_edo_cta is null, FECHA_DOC, fecha_edo_cta) AS FECHAMOV, 0 AS ABONO, g.MONTO_PAGO AS CARGO, SALDO, pg.CUENTA_BANCARIA AS BANCO, pg.USUARIO_REGISTRA AS USUARIO, pg.FOLIO_PAGO as TP, ('GTR'||g.id) as identificador, '' as registro, '' as FA, iif(g.fecha_edo_cta is null, iif(fecha_edo_cta is null, FECHA_DOC, fecha_edo_cta), g.fecha_edo_cta) as fe, FECHA_EDO_CTA_OK as comprobado, contabilizado , SELECCIONADO, TIPO_PAGO as tp_tes, REFERENCIA as obs
    			FROM GASTOS g
    			left join pago_gasto pg on pg.idgasto = g.id
    			WHERE pg.CUENTA_BANCARIA = ('$banco'||' - '||'$cuenta') 
    				and iif(fecha_edo_cta is null,extract(month from g.FECHA_DOC), extract(month from fecha_edo_cta)) = $mes and iif(fecha_edo_cta is null, extract(year from g.FECHA_DOC), extract(year from fecha_edo_cta)) = $anio and g.status = 'V'  and (seleccionado = 1 or seleccionado = 0 or seleccionado is null)  ";
    		//echo $this->query;
    	$rs=$this->QueryObtieneDatosN();
    		
    	while ($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}

    	$this->query="SELECT 2 as s, iif(edocta_fecha is null, fecha_doc, edocta_fecha) AS sort, 'Compra' AS TIPO, CVE_DOC AS CONSECUTIVO, iif(edocta_fecha is null, fecha_doc, edocta_fecha) AS FECHAMOV, 0 AS ABONO, IMPORTE AS CARGO, 0 AS SALDO, BANCO AS BANCO, '' AS USUARIO, 'Compra' as TP, cve_doc as identificador, registro as registro, 'FA' as FA, edocta_fecha as fe, fecha_edo_cta_ok as comprobado, contabilizado , SELECCIONADO, tp_tes, 'obs' as obs 
    			FROM COMPO01 
    			WHERE BANCO = ('$banco'||' - '||'$cuenta') and extract(month from edocta_fecha) = $mes and extract(year from edocta_fecha) = $anio  and (seleccionado = 1 or seleccionado = 0 or seleccionado is null) order by edocta_fecha asc";
    	$rs=$this->QueryObtieneDatosN();
    	//echo $this->query;
    	while($tsArray = ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}



    	$this->query="SELECT 8 as s, iif(edocta_fecha is null, fecha_oc, edocta_fecha) AS sort, 'Compra' AS TIPO, OC AS CONSECUTIVO, iif(edocta_fecha is null, fecha_oc, edocta_fecha) AS FECHAMOV, 0 AS ABONO, PAGO_TES AS CARGO, 0 AS SALDO, BANCO AS BANCO, usuario_conta AS USUARIO, 'Compra' as TP, oc as identificador, registro as registro, 'FA' as FA, edocta_fecha as fe, fecha_edo_cta_ok as comprobado, contabilizado , SELECCIONADO, tp_tes, '' as obs 
    			FROM FTC_POC 
    			WHERE BANCO = ('$banco'||' - '||'$cuenta') and extract(month from edocta_fecha) = $mes and extract(year from edocta_fecha) = $anio  and (seleccionado = 1 or seleccionado = 0 or seleccionado is null) order by edocta_fecha asc";
    	$rs=$this->QueryObtieneDatosN();
    	//echo $this->query;
    	while($tsArray = ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}

    	/*
			gastos     ---> tipo_pago
			compo01     ---> tp_tes
			cr_directo  ----> tp_tes sin folio.
			deudores    --->   tipo
			solicitud_pago ---> tp_tes_final
    	*/


    	$this->query="SELECT 3 as s, fecha_edo_cta as sort, 'Compra' as TIPO, (id||'-'||factura) as consecutivo, fecha_edo_cta as fechamov, 0 as abono, importe as CARGO, 0 as saldo,  ('$banco'||' - '||'$cuenta') as BANCO, usuario as usuario, 'Compra' as TP, ('CD-'||id) as identificador,registro as registro, 'FA' as FA , fecha_edo_cta as fe, FECHA_EDO_CTA_OK as comprobado, contabilizado, seleccionado, tp_tes, REFERENCIA as obs
    		FROM CR_DIRECTO
    		where BANCO = '$banco' and cuenta = '$cuenta' and extract(month from fecha_EDO_CTA) = $mes and extract(year from fecha_edo_cta) = $anio and tipo = 'compra' or tipo='Anticipo'  or tipo='otro' or tipo='otro'  and (seleccionado = 1 or seleccionado = 0 or seleccionado is null)  order by fecha_edo_cta asc ";
    	//echo 'Esta es de tipo compra(CR): '.$this->query;
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray = ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
       	$this->query="SELECT 5 as s, fecha_edo_cta as sort, 'Gasto Directo' as TIPO, (id||'-'||factura) as consecutivo, fecha_edo_cta as fechamov, 0 as abono, importe as CARGO, 0 as saldo,  ('$banco'||' - '||'$cuenta') as BANCO, usuario as usuario, 'Compra' as TP, ('CD-'||id) as identificador,registro as registro, 'FA' as FA, fecha_edo_cta as fe , FECHA_EDO_CTA_OK as comprobado, contabilizado, SELECCIONADO, tp_tes, REFERENCIA as obs
       		FROM CR_DIRECTO
    		where BANCO = '$banco' and cuenta = '$cuenta' and extract(month from fecha_EDO_CTA) = $mes and extract(year from fecha_EDO_CTA) = $anio and tipo = 'gasto'  and (seleccionado = 1 or seleccionado = 0 or seleccionado is null)  order by fecha_edo_cta asc ";
    	//echo 'Esta es de tipo Gasto Directo(CR): '.$this->query;
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray = ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	$this->query="SELECT 6 as s, fechaedo_cta as sort, 'Deudor' as TIPO, ('D'||iddeudor) as consecutivo, fechaedo_cta as fechamov, 0 as abono, importe as CARGO, 0 as saldo, ('$banco'||' - '||'$cuenta') as BANCO, usuario as usuario, 'Deudor' as TP, ('D'||iddeudor) as identificador, 'registro' as registro, 'FA' as FA, fechaedo_cta as fe, FECHA_EDO_CTA_OK as comprobado, contabilizado, SELECCIONADO, tipo as tp_tes, REFERENCIA as obs
    		from deudores 
    		where extract(month from fechaedo_cta) = $mes and extract(year from fechaedo_cta) = $anio and banco = ('$banco'||' - '||'$cuenta')  and (seleccionado = 1 or seleccionado = 0 or seleccionado is null)  order by fechaedo_cta asc";
    		//echo $this->query;

    	$rs= $this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
		$this->query="SELECT 7 as s, fecha_edo_cta as sort , 'Compra a Credito' as TIPO, ('SOL-'||idsol) as consecutivo, fecha_edo_cta as fechamov, 0 as abono, monto_final as cargo, 0 as saldo, '$banco' as BANCO, usuario_pago as usuario, 'Compra' as TP, ('SOL-'||idsol) as identificador, registro as registro, 'FA' as FA, fecha_edo_cta as fe, FECHA_EDO_CTA_OK as comprobado , contabilizado, SELECCIONADO, (tp_tes_final || folio) as tp_tes, '' as obs
			FROM SOLICITUD_PAGO
			WHERE iif(fecha_edo_cta is null, extract(month from fecha),  EXTRACT(month from fecha_edo_cta)) = $mes and iif(fecha_edo_cta is null, extract(year from fecha),  EXTRACT(year from fecha_edo_cta)) = $anio and banco_final=('$banco'||' - '||'$cuenta')  and (seleccionado = 1 or seleccionado = 0 or seleccionado is null) order by fecha_edo_cta asc";
    	//echo $this->query;
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray = ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}

    	$this->query="DELETE from CARGOS_MENSUALES";
    		$rs=$this->EjecutaQuerySimple();
    	/*
    	foreach ($data as $key) {

    		$this->query ="INSERT INTO CARGOS_MENSUALES(TIPO, CONSECUTIVO, FECHAMOV, ABONO, CARGO, SALDO, BANCO, USUARIO, TP, IDENTIFICADOR, REGISTRO, FA, FE, COMPROBADO, MES, ANIO)
    						VALUES('$key->TIPO', '$key->CONSECUTIVO', '$key->FECHAMOV', $key->ABONO, $key->CARGO,$key->SALDO, '$key->BANCO', '$key->USUARIO', '$key->TP', '$key->IDENTIFICADOR', '$key->REGISTRO', '$key->FA', '$key->FE', '$key->COMPROBADO', $mes,$anio)"; 
    		$rs=$this->EjecutaQuerySimple();	
    	}*/

    	sort($data);
    	return @$data;
    }

    function estado_de_cuenta_mes_docs($mes, $banco, $cuenta, $anio){
    	$data = array();
	   	 /// Pendientes edo de cuenta 
    	 /// Ordenar por fecha.
    	 /// cambiar el formato de los numero 
    	################  AJUSTE DE FECHAS ######################
    	$this->query="SELECT * FROM PG_BANCOS WHERE BANCO = '$banco' and num_cuenta='$cuenta'";
			$res=$this->EjecutaQuerySimple();
			$bn=ibase_fetch_object($res);
			$corte = $bn->DIA_CORTE;
			$fechaIni=$corte.'.'.$mes.'.'.$anio;
			if($corte == 1){
				$fechafin=($corte).'.'.($mes+1).'.'.$anio;
			}else{
				$fechafin=($corte-1).'.'.($mes+1).'.'.$anio;
			}
		###########################################################

		$this->query="SELECT 1 as s, FECHA_RECEP AS sort, 'Venta' AS TIPO,  iif(FOLIO_X_BANCO = 'TR', (FOLIO_X_BANCO||id), FOLIO_X_BANCO) AS CONSECUTIVO, FECHA_RECEP AS FECHAMOV, MONTO AS ABONO, 0 AS CARGO, SALDO AS SALDO, BANCO AS BANCO, USUARIO AS USUARIO, tipo_pago as TP, id as identificador, registro as registro, folio_acreedor as FA , fecha_recep as fe, '' as comprobado, contabilizado, seleccionado, '' as tp_tes, CEP, ARCHIVO_CEP, obs 
    		   from carga_pagos 
    		   where BANCO = ('$banco'||' - '||'$cuenta') 
    		   		and fecha_recep between '$fechaIni' and '$fechafin'
    		   		and extract(year from fecha_recep) = $anio 
    		   		AND STATUS <> 'C' and (seleccionado = 2)  
    		   		order by fecha_recep asc";
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}

/*
    	$this->query="SELECT 1 as s, FECHA_RECEP AS sort, 'Venta' AS TIPO,  iif(FOLIO_X_BANCO = 'TR', (FOLIO_X_BANCO||id), FOLIO_X_BANCO) AS CONSECUTIVO, FECHA_RECEP AS FECHAMOV, MONTO AS ABONO, 0 AS CARGO, SALDO AS SALDO, BANCO AS BANCO, USUARIO AS USUARIO, tipo_pago as TP, id as identificador, registro as registro, folio_acreedor as FA , fecha_recep as fe, '' as comprobado, contabilizado, seleccionado, '' as TP_TES, CEP, ARCHIVO_CEP
    		   from carga_pagos 
    		   where BANCO = ('$banco'||' - '||'$cuenta') and extract(month from fecha_recep) = $mes and extract(year from fecha_recep) = $anio AND STATUS <> 'C' and (seleccionado = 2 )  order by fecha_recep asc";
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
  */  	
    	$this->query="SELECT  4 as s, iif(fecha_EDO_CTA is null, fecha_doc, fecha_EDO_CTA) as sort, 'Gasto' AS TIPO, pg.ID AS CONSECUTIVO, iif(fecha_edo_cta is null, FECHA_DOC, fecha_edo_cta) AS FECHAMOV, 0 AS ABONO, g.MONTO_PAGO AS CARGO, 0 AS SALDO, pg.CUENTA_BANCARIA AS BANCO, pg.USUARIO_REGISTRA AS USUARIO, pg.FOLIO_PAGO as TP, ('GTR'||g.id) as identificador, '' as registro, '' as FA, iif(g.fecha_edo_cta is null, iif(fecha_edo_cta is null, FECHA_DOC, fecha_edo_cta), g.fecha_edo_cta) as fe, FECHA_EDO_CTA_OK as comprobado, contabilizado , SELECCIONADO, '' AS CEP, '' AS ARCHIVO_CEP, referencia as obs
    			FROM GASTOS g
    			left join pago_gasto pg on pg.idgasto = g.id
    			WHERE pg.CUENTA_BANCARIA = ('$banco'||' - '||'$cuenta') and iif(fecha_edo_cta is null,extract(month from g.FECHA_DOC), extract(month from fecha_edo_cta)) = $mes and iif(fecha_edo_cta is null, extract(year from g.FECHA_DOC), extract(year from fecha_edo_cta)) = $anio and g.status = 'V'  and (seleccionado = 2 ) ";
    		//echo $this->query;
    	$rs=$this->QueryObtieneDatosN();
    		
    	while ($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	$this->query="SELECT 2 as s, iif(edocta_fecha is null, fecha_doc, edocta_fecha) AS sort, 'Compra' AS TIPO, CVE_DOC AS CONSECUTIVO, iif(edocta_fecha is null, fecha_doc, edocta_fecha) AS FECHAMOV, 0 AS ABONO, IMPORTE AS CARGO, 0 AS SALDO, BANCO AS BANCO, '' AS USUARIO, 'Compra' as TP, cve_doc as identificador, registro as registro, 'FA' as FA, edocta_fecha as fe, fecha_edo_cta_ok as comprobado, contabilizado , SELECCIONADO, '' AS CEP, '' AS ARCHIVO_CEP , 'obs' as obs
    			FROM COMPO01 
    			WHERE BANCO = ('$banco'||' - '||'$cuenta') and extract(month from edocta_fecha) = $mes and extract(year from edocta_fecha) = $anio  and (seleccionado = 2 ) order by edocta_fecha asc";
    	$rs=$this->QueryObtieneDatosN();
    	///echo $this->query;
    	while($tsArray = ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}

		$this->query="SELECT 8 as s, iif(edocta_fecha is null, fecha_oc, edocta_fecha) AS sort, 'Compra' AS TIPO, OC AS CONSECUTIVO, iif(edocta_fecha is null, fecha_oc, edocta_fecha) AS FECHAMOV, 0 AS ABONO, PAGO_TES AS CARGO, 0 AS SALDO, BANCO AS BANCO, usuario_conta AS USUARIO, 'Compra' as TP, oc as identificador, registro as registro, 'FA' as FA, edocta_fecha as fe, fecha_edo_cta_ok as comprobado, contabilizado , SELECCIONADO, tp_tes, '' AS CEP, '' AS ARCHIVO_CEP , '' as obs
    			FROM FTC_POC 
    			WHERE BANCO = ('$banco'||' - '||'$cuenta') and extract(month from edocta_fecha) = $mes and extract(year from edocta_fecha) = $anio  and seleccionado = 2 order by edocta_fecha asc";
    	$rs=$this->QueryObtieneDatosN();
    	//echo $this->query;
    	while($tsArray = ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	$this->query="SELECT 3 as s, fecha_edo_cta as sort, 'Compra' as TIPO, (id||'-'||factura) as consecutivo, fecha_edo_cta as fechamov, 0 as abono, importe as CARGO, 0 as saldo,  ('$banco'||' - '||'$cuenta') as BANCO, usuario as usuario, 'Compra' as TP, ('CD-'||id) as identificador,registro as registro, 'FA' as FA , fecha_edo_cta as fe, FECHA_EDO_CTA_OK as comprobado, contabilizado, seleccionado, tp_tes, '' AS CEP, '' AS ARCHIVO_CEP,  referencia as obs
    		FROM CR_DIRECTO
    		where BANCO = '$banco' and cuenta = '$cuenta' and extract(month from fecha_EDO_CTA) = $mes and extract(year from fecha_edo_cta) = $anio and tipo = 'compra' or tipo='Anticipo'  or tipo='otro' and (seleccionado = 2 ) order by fecha_edo_cta asc ";
    	//echo 'Esta es de tipo compra(CR): '.$this->query;
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray = ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
       	$this->query="SELECT 5 as s, fecha_edo_cta as sort, 'Gasto Directo' as TIPO, factura as consecutivo, fecha_edo_cta as fechamov, 0 as abono, importe as CARGO, 0 as saldo,  ('$banco'||' - '||'$cuenta') as BANCO, usuario as usuario, 'Compra' as TP, ('CD-'||id) as identificador,registro as registro, 'FA' as FA, fecha_edo_cta as fe , FECHA_EDO_CTA_OK as comprobado, contabilizado, SELECCIONADO, tp_tes, '' AS CEP, '' AS ARCHIVO_CEP, referencia as obs
       		FROM CR_DIRECTO
    		where BANCO = '$banco' and cuenta = '$cuenta' and extract(month from fecha_EDO_CTA) = $mes and extract(year from fecha_EDO_CTA) = $anio and tipo = 'gasto'  and (seleccionado = 2 )  order by fecha_edo_cta asc ";
    	//echo 'Esta es de tipo Gasto Directo(CR): '.$this->query;
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray = ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	$this->query="SELECT 6 as s, fechaedo_cta as sort, 'Deudor' as TIPO, ('D'||iddeudor) as consecutivo, fechaedo_cta as fechamov, 0 as abono, importe as CARGO, 0 as saldo, ('$banco'||' - '||'$cuenta') as BANCO, usuario as usuario, 'Deudor' as TP, ('D'||iddeudor) as identificador, 'registro' as registro, 'FA' as FA, fechaedo_cta as fe, FECHA_EDO_CTA_OK as comprobado, contabilizado, SELECCIONADO, '' AS CEP, '' AS ARCHIVO_CEP, referencia as obs
    		from deudores 
    		where extract(month from fechaedo_cta) = $mes and extract(year from fechaedo_cta) = $anio and banco = ('$banco'||' - '||'$cuenta')  and (seleccionado = 2 )  order by fechaedo_cta asc";
    		//echo $this->query;

    	$rs= $this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
		$this->query="SELECT 7 as s, fecha_edo_cta as sort , 'Compra a Credito' as TIPO, ('SOL-'||idsol) as consecutivo, fecha_edo_cta as fechamov, 0 as abono, monto_final as cargo, 0 as saldo, '$banco' as BANCO, usuario_pago as usuario, 'Compra' as TP, ('SOL-'||idsol) as identificador, registro as registro, 'FA' as FA, fecha_edo_cta as fe, FECHA_EDO_CTA_OK as comprobado , contabilizado, SELECCIONADO, '' AS CEP, '' AS ARCHIVO_CEP, '' as obs
			FROM SOLICITUD_PAGO
			WHERE EXTRACT(month from fecha_edo_cta) = $mes and extract(year from fecha_edo_cta) = $anio and banco_final=('$banco'||' - '||'$cuenta')  and (seleccionado = 2 ) order by fecha_edo_cta asc";
    	//echo $this->query;
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray = ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}

    	$this->query="DELETE from CARGOS_MENSUALES";
    		$rs=$this->EjecutaQuerySimple();
    	
    	foreach ($data as $key) {

    		$this->query ="INSERT INTO CARGOS_MENSUALES(TIPO, CONSECUTIVO, FECHAMOV, ABONO, CARGO, SALDO, BANCO, USUARIO, TP, IDENTIFICADOR, REGISTRO, FA, FE, COMPROBADO, MES, ANIO)
    						VALUES('$key->TIPO', '$key->CONSECUTIVO', '$key->FECHAMOV', $key->ABONO, $key->CARGO,$key->SALDO, '$key->BANCO', '$key->USUARIO', '$key->TP', '$key->IDENTIFICADOR', '$key->REGISTRO', '$key->FA', '$key->FE', '$key->COMPROBADO', $mes,$anio)"; 
    		$rs=$this->EjecutaQuerySimple();	
    	}
    	sort($data);
    	return @$data;
    }

    
    function saldosBancos($mes, $banco , $cuenta, $anio){
    	//$this->query="SELECT * FROM PG_BANCOS WHERE BANCO = '$banco' and NUM_CUENTA = '$cuenta'";
    	$data = array();
    	if($mes == 1){
    		$mes = 12;
    		$anio = $anio -1;
    	}else{
    		$mes = $mes -1;
    	}
    	$this->query="SELECT * FROM FTC_CTRL_BANCOS WHERE BANCO = '$banco' and CUENTA= '$cuenta' and periodo =$mes and ANIO = $anio";
    	$rs=$this->EjecutaQuerySimple();

    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	//echo $this->query;
    	return $data;
    }

    function traeMeses(){
    	$this->query="SELECT NOMBRE, NUMERO, ANHIO FROM PERIODOS_2016 where anhio >= 2016 order by anhio, numero";
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return $data;
    }

    function traeNombreMes($mes){
    	$this->query="SELECT NOMBRE, NUMERO FROM PERIODOS_2016 where numero = $mes";
    	$rs=$this->QueryObtieneDatosN();
    	while ($tsArray = ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return $data;

    }

    function traeMes($mes, $anio){
    	$this->query="SELECT NOMBRE, FECHA_INI, FECHA_FIN, NUMERO, SIGUIENTE FROM PERIODOS_2016 WHERE NUMERO = $mes and anHio = $anio";
    	$rs=$this->QueryObtieneDatosN();
    	$row=ibase_fetch_object($rs);
    	return $row;

    }


    function traeFactura($docf){
    	$data=array();
    	$this->query="SELECT * 
    		FROM FACTUTAS f
    		left join cajas ca on ca.factura = f.cve_doc
    		WHERE f.STATUS <> 'C' and cve_doc CONTAINING('$docf')";
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	echo 'Consulta Facturas SAE: '.$this->query.'<br/>';
    	$this->query="SELECT * 
    		FROM FACTURAS_FP f
    		left join cajas ca on ca.factura = f.cve_doc
    		WHERE f.STATUS <> 'C' and cve_doc CONTAINING('$docf')";
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	echo 'Consulta Facturas Pegaso : '.$this->query.'<br/>';
    	exit();
    	return $data;
    }

    function cambiarFactura($docf1, $tipo){

    	$usuario=$_SESSION['user']->USER_LOGIN;
    	$this->query="SELECT COUNT(ID) AS CAJA FROM CAJAS WHERE FACTURA = '$docf1'";
    	$rs=$this->QueryObtieneDatosN();
    	$row=ibase_fetch_object($rs);
    	$caja = $row->CAJA;

    	if( $caja == 0 ){
    		$this->query="SELECT DOC_ANT, CVE_CLPV AS CLIENTE from factf01 where cve_doc = '$docf1'";
    		$rs=$this->QueryObtieneDatosN();
    		$row=ibase_fetch_object($rs);
    		if($row){
    			$docp = $row->DOC_ANT; 
    			$cvecli=$row->CLIENTE;
    		}else{
    			$this->query="SELECT DOC_ANT, CVE_CLPV AS CLIENTE from facturas_fp where cve_doc = '$docf1'";
    			$rs=$this->QueryObtieneDatosN();
    			$row2=ibase_fetch_object($rs);
 				if($row2){
    			$docp = $row2->DOC_ANT; 
    			$cvecli=$row2->CLIENTE;
    			}	
    		}

    			$this->query="SELECT CARTERA_COBRANZA AS CC, CARTERA_REVISION AS CR, DIAS_REVISION AS DR, DIAS_PAGO AS DP, REV_DOSPASOS AS RDP, ENVIO FROM CARTERA WHERE TRIM(IDCLIENTE) = TRIM('$cvecli')";
    			$rs=$this->EjecutaQuerySimple();
    			$row=ibase_fetch_object($rs);
    			if (empty($row)){
    					$carteraR= 's/i';
    					$carteraC= 's/i';
    					$dr = 's/i';
    					$dp = 's/i';
    					$envio='S/i';
    					$rev2='N';
    				}else{
    					$carteraR= $row->CR;
    					$carteraC= $row->CC;
    					$dr = $row->DR;
    					$dp = $row->DP;
    					$envio=$row->ENVIO;
    					$rev2=$row->RDP;
    				}
    				if(empty($docp) or substr($docp, 0,1)== 'C'){
    					$docp='directa';
    				}
    			
    		if(substr($docp, 0,1) == 'P'){
    			$this->query="INSERT INTO CAJAS (FECHA_CREACION, FECHA_CIERRE, STATUS, CVE_FACT, REMISION, FACTURA, NC, UNIDAD, STATUS_LOG, COMPLETA, RUTA, FECHA_SECUENCIA, IDU, PESO, SECUENCIA, HORAI, HORAF, DOCS, CIERRE_UNI, CIERRE_TOT, CAJAS, EMBALAJE, MOTIVO, STATUS_MER, CONTRARECIBO, VAL_ADUANA, CONTRARECIBO_CR, STATUSCR_CR, ENVIO, REV_DOSPASOS, GUIA_FLETERA, FLETERA, LOGISTICA, ADUANA, VUELTAS, USUARIO_LOG, USUARIO_CAJA, FECHA_DESLINDE_REVISION, SOL_DESLINDE, FECHA_SOL, CR, DIAS_REVISION, CC, DIAS_PAGO, USUARIO_ADUANA, FECHA_ADUANA, SOL_DES_ADUANA, FECHA_SOL_DESADU, USUARIO_DES_ADU, FECHA_GUIA, FECHA_ENTREGA, FECHA_U_LOGISTICA, FECHA_U_BODEGA, STATUS_CTRL_DOC_ENTREGA, IMP_COMP_REENRUTAR, FOLIO_DEV, FOLIO_RECMCIA, DOCFACT)
            		VALUES( current_timestamp, current_timestamp, 'cerrado','$docp','directa','$docf1','', '99', 'Entregado', '1', 'A', current_timestamp,99, 9.99,1,current_time, current_time, 'No','ok','ok', 1, 'Total', '','Total', 'Directo', null,null,  'N', '$envio' ,'$rev2',null,null, 'Total', 'Cobranza',0,'$usuario', '$usuario',null, null, null, iif('$carteraR' is null, 'n/C','$carteraR'), '$dr', '$carteraC', '$dp', '$usuario',current_timestamp, null, null, '$usuario', null, null, null, null, 'Nu', null, null, 'no','')";

            		$rs=$this->EjecutaQuerySimple();
    		}elseif($docp == 'directa'){
    		
    			 $this->query="INSERT INTO CAJAS (FECHA_CREACION, FECHA_CIERRE, STATUS, CVE_FACT, REMISION, FACTURA, NC, UNIDAD, STATUS_LOG, COMPLETA, RUTA, FECHA_SECUENCIA, IDU, PESO, SECUENCIA,HORAI, HORAF, DOCS, CIERRE_UNI, CIERRE_TOT, CAJAS, EMBALAJE, MOTIVO, STATUS_MER, CONTRARECIBO, VAL_ADUANA, CONTRARECIBO_CR, STATUSCR_CR, ENVIO, REV_DOSPASOS, GUIA_FLETERA, FLETERA, LOGISTICA, ADUANA, VUELTAS, USUARIO_LOG, USUARIO_CAJA, FECHA_DESLINDE_REVISION, SOL_DESLINDE, FECHA_SOL, CR, DIAS_REVISION, CC, DIAS_PAGO, USUARIO_ADUANA, FECHA_ADUANA, SOL_DES_ADUANA, FECHA_SOL_DESADU, USUARIO_DES_ADU, FECHA_GUIA, FECHA_ENTREGA, FECHA_U_LOGISTICA, FECHA_U_BODEGA, STATUS_CTRL_DOC_ENTREGA, IMP_COMP_REENRUTAR, FOLIO_DEV, FOLIO_RECMCIA, DOCFACT, status_recepcion, PAR_FACTURADAS )
            		 VALUES( current_timestamp, current_timestamp, 'cerrado','directa','directa','$docf1','', '99', 'entregado', '1', 'A', current_timestamp,99, 9.99,1,current_time, current_time,  'No',
                    'ok','ok', 1, 'TOTAL', '','Total', NULL, null,null,  'N', '$envio' ,'$rev2',null,null, 'TOtal', 'Cobranza',
                    0,'$usuario', '$usuario',null, null, null, '$carteraR', '$dr', '$carteraC', '$dp', '$usuario',current_timestamp, null, null, '$usuario',
                    null, null, null, null, 'Nu', null, null, 'no','',5, 1)";
                    $rs = $this->grabaBD();

                    $this->query="SELECT max(id) as ID from cajas";
                    $res=$this->EjecutaQuerySimple();
                    $caja=ibase_fetch_object($res);
                    return $caja->ID ;

    		}elseif(trim(substr($docp, 10,1)) ==  0){

    			$this->query="SELECT DOC_ANT from factr01 where cve_doc = '$docp'";

	    		$rs=$this->EjecutaQuerySimple();
    			$row=ibase_fetch_object($rs);
    			$docp = $row->DOC_ANT;

    			 $this->query="INSERT INTO CAJAS (FECHA_CREACION, FECHA_CIERRE, STATUS, CVE_FACT, REMISION, FACTURA, NC, UNIDAD, STATUS_LOG, COMPLETA, RUTA, FECHA_SECUENCIA, IDU, PESO, SECUENCIA,HORAI, HORAF, DOCS, CIERRE_UNI, CIERRE_TOT, CAJAS, EMBALAJE, MOTIVO, STATUS_MER, CONTRARECIBO, VAL_ADUANA, CONTRARECIBO_CR, STATUSCR_CR, ENVIO, REV_DOSPASOS, GUIA_FLETERA, FLETERA, LOGISTICA, ADUANA, VUELTAS, USUARIO_LOG, USUARIO_CAJA, FECHA_DESLINDE_REVISION, SOL_DESLINDE, FECHA_SOL, CR, DIAS_REVISION, CC, DIAS_PAGO, USUARIO_ADUANA, FECHA_ADUANA, SOL_DES_ADUANA, FECHA_SOL_DESADU, USUARIO_DES_ADU, FECHA_GUIA, FECHA_ENTREGA, FECHA_U_LOGISTICA, FECHA_U_BODEGA, STATUS_CTRL_DOC_ENTREGA, IMP_COMP_REENRUTAR, FOLIO_DEV, FOLIO_RECMCIA, DOCFACT )
            		 VALUES(current_timestamp, current_timestamp, 'cerrado','$docp','directa','$docf1','', '99', 'Entregado', '1', 'A', current_timestamp,99, 9.99,1,current_time, current_time,  'No','ok','ok', 1, 'Total', '','Total', 'Directo', null,null, 'N', '$envio' ,'$rev2',null,null, 'Total', 'Cobranza', 0,'$usuario', '$usuario',null, null, null, iif('$carteraR' is null, 'n/C','$carteraR'), '$dr', '$carteraC', '$dp', '$usuario',current_timestamp, null, null, '$usuario',null, null, null, null, 'Nu', null, null, 'no','')";

                    $rs=$this->EjecutaQuerySimple();

                }
    		
    	}else{
    		if($tipo == 'C'){
    			$this->query="UPDATE CAJAS SET ADUANA = 'Cobranza', fecha_rec_cobranza = current_timestamp where factura = '$docf1'";
    			$rs=$this->EjecutaQuerySimple();
    			return $rs;	
    		}elseif($tipo=='R') {
    			$this->query="UPDATE Cajas SET STATUS_LOG = 'Entregado', Aduana = null where factura = '$docf1'";
    			$rs=$this->EjecutaQuerySimple();
    			return $rs;
    		}	
    	}
    	return $rs;
	}

	function porFacturarEmbalar($docp){		//01072016

		$this->query="SELECT a.cotiza, sum(rec_faltante) as Faltante, MAX(NOM_CLI) AS NOM_CLI, MAX (CLIEN) AS CLIEN, max(c.codigo) as CODIGO, 
                MAX(b.doc_sig) as FACTURA, max (a.fechasol) as FECHASOL, max(b.importe) as IMPORTE, max(datediff(day,b.FECHAELAB,current_date)) as DIAS,
                MAX(b.CITA) as CITA, max(factura) as factura, max(fecha_fact) as fecha_factu, sum(a.recepcion) as recibido,  sum(a.empacado) as empacado, max(f.fechaelab) as fecha_fact,
                sum(a.facturado) as facturado, sum(a.remisionado) as remisionado, sum(pendiente_facturar) as penfact, sum(pendiente_remisionar) as penrem
                FROM preoc01 a
                LEFT JOIN FACTP01 b on a.cotiza = b.cve_doc
                LEFT JOIN CLIE01 c on b.cve_clpv = c.Clave
                left join factf01 f on f.cve_doc = a.factura 
                left join factr01 r on r.cve_doc = a.remision 
                group by cotiza
                HAVING cotiza = '$docp'";
               /* and (max(f.fechaelab) > '01.08.2016' or max(r.fechaelab) > '01.07.2016')"; /*PENDIENTE*/
		$result = $this->QueryObtieneDatosN();
		while ($tsArray = ibase_fetch_object($result)){
						$data[] = $tsArray;
				
		}
			return $data;
	}

	function regCompras($mes){
		$this->query="SELECT c.*, p.nombre 
					FROM COMPO01 c
					LEFT JOIN PROV01 p ON c.cve_clpv = p.clave 
					WHERE c.status != 'C'and edocta_fecha is null and extract(month from fechaelab) = $mes";
		$rs=$this->EjecutaQuerySimple();
		while($tsArray = ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}
		return @$data;
	}

	function regCompEdoCta($fecha, $docc, $mes, $pago, $banco,$tptes){
		$this->query="UPDATE COMPO01 SET EDOCTA_FECHA = '$fecha', edocta_reg = current_timestamp, edocta_status = 'I' where cve_doc='$docc'";
		$rs=$this->EjecutaQuerySimple();

		$campo='MOVR'.substr($fecha, 0,2);
		$campoA='MOVS'.substr($fecha, 0,2);
		$camposf='SALDOF'.substr($fecha, 0,2);
		if($banco !=''){
			$cuenta=explode('-',$banco);

		$this->query="UPDATE PG_BANCOS SET $campo = iif($campo is null,0,$campo) + iif($pago IS NULL,0,$pago) where NUM_CUENTA=trim('$cuenta[1]') ";
		$rs=$this->EjecutaQuerySimple();
		}

		$this->query="UPDATE PG_BANCOS SET $camposf= ($camposf - iif($pago IS NULL,0,$pago))
	    where num_cuenta = trim('$cuenta[1]')";
		$rs=$this->EjecutaQuerySimple();

		$this->query="UPDATE PG_BANCOS SET SALDO = (SALDOF01 + SALDOF02 + SALDOF03 + SALDOF04 + SALDOF05 + SALDOF07 + SALDOF08 + SALDOF09 + SALDOF10 + SALDOF11 + SALDOF12 + SALDOI)";
		$rs=$this->EjecutaQuerySimple();
		
		return $rs;

	}

	function listarPagosCredito(){
       //SELECT ID, BENEFICIARIO, MONTO, DOCUMENTO, FECHA_DOC, DIASCRED, VENCIMIENTO, PROMESA_PAGO FROM GASTOS_PAGOS_CREDITO;
       //SELECT ID, BENEFICIARIO, MONTO, DOCUMENTO, FECHA_DOC, DIASCRED, VENCIMIENTO, PROMESA_PAGO FROM OC_PAGOS_CREDITO;
       $this->query = "SELECT 'RECEPCION' AS TIPO, ID, BENEFICIARIO, MONTO, OC, RECEPCION, FECHA_DOC, DIASCRED, VENCIMIENTO, PROMESA_PAGO FROM OC_PAGOS_CREDITO where STATUS_CREDITO = 1 ";
       //$this->query.= " UNION ";
      // $this->query.= "SELECT 'GASTO' AS TIPO, ID, BENEFICIARIO, MONTO, DOCUMENTO, FECHA_DOC, DIASCRED, VENCIMIENTO, PROMESA_PAGO FROM GASTOS_PAGOS_CREDITO;";
       
       $result = $this->QueryObtieneDatosN();
       while ($tsArray = (ibase_fetch_object($result))) {
           $data[] = $tsArray;
       }

       $this->query="SELECT 'RECEPCION_PEGASO' AS TIPO, ID, BENEFICIARIO, MONTO, OC, RECEPCION, FECHA_DOC, DIASCRED, VENCIMIENTO, PROMESA_PAGO FROM OC_PAGOS_CREDITO_RECIBO where status_credito is null";

       $result = $this->QueryObtieneDatosN();
       while ($tsArray = (ibase_fetch_object($result))) {
           $data[] = $tsArray;
       }
       //echo 'Esta es la consulta';
 //        $this->query = "SELECT 'GASTO' AS TIPO, ID, BENEFICIARIO, MONTO, DOCUMENTO, FECHA_DOC, DIASCRED, VENCIMIENTO, PROMESA_PAGO FROM GASTOS_PAGOS_CREDITO ORDER BY PROMESA_PAGO;";
 //        $result = $this->QueryObtieneDatosN();
 //        while ($tsArray = (ibase_fetch_object($result))) {
 //            $data[] = $tsArray;
 //        }
       return @$data;     
   }


  function detallePagoCredito($tipo, $identificador){        
         if($tipo=="GASTO"){            
             $this->query = "SELECT 'GASTO' AS TIPO, ID, BENEFICIARIO, MONTO, MAIL, DOCUMENTO, FECHA_DOC, DIASCRED, VENCIMIENTO, PROMESA_PAGO FROM GASTOS_PAGOS_CREDITO WHERE ID = $identificador;";
         } elseif($tipo=="RECEPCION") {
             $this->query = "SELECT 'RECEPCION' AS TIPO, ID, BENEFICIARIO, MONTO, MAIL, OC, RECEPCION , FECHA_DOC, DIASCRED, VENCIMIENTO, PROMESA_PAGO, FACTURA, MONTOR, recepcion as documento  FROM OC_PAGOS_CREDITO WHERE ID = '$identificador';";
         } elseif ($tipo == "RECEPCION_PEGASO") {
         	$this->query="SELECT 'RECEPCION_PEGASO' AS TIPO, ID, BENEFICIARIO, MONTO, MAIL, OC, RECEPCION, FECHA_DOC, DIASCRED, VENCIMIENTO, 
         		PROMESA_PAGO, FACTURA, MONTOR, recepcion as documento from OC_PAGOS_CREDITO_RECIBO where id = '$identificador'";
         }       

         $result = $this->QueryObtieneDatosN();
         while ($tsArray = (ibase_fetch_object($result))){
             $data[] = $tsArray;
         }
         return @$data;              
   }

   
    function actualizarRecepcion($identificador){
    	
    	//echo 'identificador: '.$identificador.'<p>';
    	//break;
    	if(substr($identificador, 10,1 == 0)){
    		$this->query="UPDATE COMPR01 SET STATUS_CREDITO = 2 WHERE TRIM(CVE_DOC) = TRIM('$identificador')";
        }else{
        	$this->query="UPDATE FTC_DETALLE_RECEPCIONES SET STATUS_CREDITO = 2 WHERE TRIM(orden ) = TRIM('$identificador')";
        }
        $act=$this->EjecutaQuerySimple();
        //echo 'Actualiza Recepcion: '.$this->query.'<p>';
        return $act;
    }
 


   function actualizaPagoCreditoContrarecibo($tipo, $identificador){
        if($tipo == "GASTO"){
            $this->query = "UPDATE GASTOS SET STATUS = 'I' WHERE ID = $identificador;";
        }  elseif($tipo =="RECEPCION") {
            $this->query = "UPDATE P_CREDITO SET STATUS = 'I' WHERE ID = $identificador;";
        }elseif ($tipo =="RECEPCION_PEGASO") {
        	 $this->query = "UPDATE P_CREDITO SET STATUS = 'I' WHERE DOCUMENTO = '$identificador';";
        }
        //echo "Actualiza pago credito contraRecibo: ".$this->query.'<p>';
        $respuesta = $this->EjecutaQuerySimple();
        return $respuesta;     
    }

     function listarOCAduana($mes, $anio){
         //status_log debe de ser Total, Fallido o PNR. 
         $this->query = "SELECT CVE_DOC AS IDENTIFICADOR,FECHA_DOC AS FECHA_DOCUMENTO, IMPORTE AS MONTO, NOMBRE FROM COMPO01 A INNER JOIN PROV01 B ON A.CVE_CLPV = B.CLAVE WHERE STATUS_LOG IN ('Total','Fallido','PNR') AND CVE_DOC NOT IN (SELECT CVE_DOC FROM OC_ADUANA)";
         if($mes!='' && $anio!=''){
             $this->query.= " AND EXTRACT(MONTH FROM FECHA_DOC) = $mes AND EXTRACT(YEAR FROM FECHA_DOC) = $anio;"; 
         }
         //echo "query = ".$this->query;
         $result = $this->QueryObtieneDatosN();
         while ($tsArray = (ibase_fetch_object($result))) {
             $data[] = $tsArray;
         }
         return @$data;
     }

     function registrarOCAduana($identificador, $aduana){
         $TIME = time();
     	 $HOY = date("Y-m-d H:i:s", $TIME);
         $usuario = $_SESSION['user']->USER_LOGIN;
         $this->query = "INSERT INTO OC_ADUANA VALUES ('$identificador','A','$HOY','$usuario','$aduana')";
         $respuesta = $this->EjecutaQuerySimple();
         return $respuesta;
      }

      function traeTipoGasto(){
      	$this->query="SELECT * FROM CLA_GASTOS";
      	$rs=$this->QueryObtieneDatosN();
      	while($tsArray=ibase_fetch_object($rs)){
      		$data[]=$tsArray;
      	}
      	return $data;
       }

              function verFallidas(){
   	$this->query="SELECT a.*, b.NOMBRE, c.OPERADOR, d.cve_doc as Recepcion
   				  from compo01 a
   				  left join prov01 b on a.cve_clpv = b.clave
   				  left join unidades c on a.unidad = c.numero  
   				  left join compr01 d on a.doc_sig = d.cve_doc
   				  where (a.doc_sig is null or status_log = 'Fallido') AND a.FECHAELAB > '01.09.2016'";
   	$result=$this->QueryObtieneDatosN();
   	while ($tsArray=ibase_fetch_object($result)){
   		$data[]=$tsArray;
   	}
   	return $data;
   }

    function fallarOC($doco){
   		$usuario=$_SESSION['user']->USER_LOGIN;

   		$this->query="SELECT MAX(FOLIO_FALSO) as fs from COMPO01 WHERE DOC_SIG STARTING WITH ('F')";
   		$rs=$this->EjecutaQuerySimple();
   		$row=ibase_fetch_object($rs);
   		$f=$row->FS;
   		$folio= $f +1;

   		$this->query ="UPDATE COMPO01 SET DOC_SIG = ('F'||$folio), FOLIO_FALSO=$folio, usuario_recibe= '$usuario', status_log = 'fallido' where cve_doc = '$doco'";
   		$rs=$this->EjecutaQuerySimple();
   		
   		$this->query="UPDATE PAR_COMPO01 SET STATUS_LOG2 = 'R' WHERE CVE_DOC = '$doco' and status_log2 = 'Suministros'";
   		$rs=$this->EjecutaQuerySimple();

   		return $rs;
   }


   function impFallido($doco){
   	$this->query="SELECT c.*, p.nombre
   				from compo01 c
   				left join prov01 p on p.clave = c.cve_clpv
   				where cve_doc ='$doco'";
   		$rs=$this->EjecutaQuerySimple();
   	while($tsArray=ibase_fetch_object($rs)){
   		$data[]=$tsArray;
   	}
   	return $data;
   }

   function impFallidoPar($doco){
   	$this->query="SELECT c.*, i.descr
   				from par_compo01 c
   				left join inve01 i on c.cve_art = i.cve_art 
   				where cve_doc ='$doco'";
   		$rs=$this->EjecutaQuerySimple();
   	while($tsArray=ibase_fetch_object($rs)){
   		$data[]=$tsArray;
   	}
   	return $data;
   }

   function verSaldoFacturas($cveclie){
   	$this->query="SELECT f.*, c.*, cl.RFC
   				FROM factf01 f
   				left join clie01 cl on cl.clave =  f.cve_clpv
   				LEFT JOIN cajas c on f.cve_doc = c.factura 
   				where trim(f.cve_clpv)=trim('$cveclie') and f.saldo > 0 ";
   	$rs=$this->QueryObtieneDatosN();
   	while($tsArray=ibase_fetch_object($rs)){
   		$data[]=$tsArray;
   	}
   	return $data;
   }

   function verPagos2($clie, $docf, $rfc){
   	$this->query="SELECT * from carga_pagos where (cliente is null or trim(rfc)=trim('$rfc')) and saldo > 0";
   	//var_dump($this);
   	$rs=$this->QueryObtieneDatosN();
   	while($tsArray=ibase_fetch_object($rs)){
   		$data[]=$tsArray;
   	}
   	return $data;
   }

   function treaSaldoFacturas($docf, $clie){
   	$this->query="SELECT f.*, c.* , cl.nombre as cliente, cl.RFC as rfc
   				FROM factf01 f
   				LEFT JOIN cajas c on f.cve_doc = c.factura 
   				left join clie01 cl on cl.clave= f.cve_clpv
   				where trim(f.cve_clpv)=trim('$clie') and f.cve_doc='$docf'";
   	$rs=$this->QueryObtieneDatosN();
   	while($tsArray=ibase_fetch_object($rs)){
   		$data[]=$tsArray;
   	}
   	return $data;
   }

   function aplicarPagoxFactura($docf, $idpago, $monto, $saldof, $clie, $rfc){
   		$usuario=$_SESSION['user']->USER_LOGIN;
   		if($monto > $saldof){
   			$saldodoc = 0;
   			$pago = $saldof;
   			$saldopago=$monto - $saldof;
   		}else{
   			$saldodoc = $saldof - $monto;
   			$pago = $monto;
   			$saldopago=0;
   		}
   		$this->query="UPDATE FACTF01 SET SALDO=$saldodoc, pagos=(pagos+$pago) where CVE_DOC ='$docf'";
   		$rs=$this->EjecutaQuerySimple();
   		
   		$this->query="UPDATE CARGA_PAGOS SET SALDO=$saldopago, cliente = $clie where ID=$idpago";
   		$rs=$this->EjecutaQuerySimple();
   	
   		$this->query="INSERT INTO APLICACIONES (FECHA, IDPAGO, DOCUMENTO, MONTO_APLICADO, SALDO_DOC, SALDO_PAGO, USUARIO, RFC)
   					  VALUES (current_timestamp, $idpago, '$docf', $pago, $saldodoc, $saldopago, '$usuario', '$rfc')";
   		$rs=$this->EjecutaQuerySimple();

   		$this->query="SELECT SALDO FROM FACTF01 WHERE CVE_DOC ='$docf'";
   		$rs=$this->QueryObtieneDatosN();
   		$row=ibase_fetch_object($rs);
   		$data=$row->SALDO;
 
   		return $data;
   }

   function verFacturas2($clie,$id){
   	$this->query="SELECT * FROM FACTF01 WHERE SALDO > 0 AND trim(CVE_CLPV)=trim('$clie') and status != 'C'";
   	//var_dump($this);
   	$rs=$this->QueryObtieneDatosN();
   	while($tsArray=ibase_fetch_object($rs)){
   		$data[]=$tsArray;
   	}
   	return $data;
   }

   function verPagoaAplicar($clie,$id){
   	$this->query="SELECT * FROM CARGA_PAGOS WHERE ID = $id";
   	//var_dump($this);
   	$rs=$this->QueryObtieneDatosN();
   	while($tsArray=ibase_fetch_object($rs)){
   		$data[]=$tsArray;
   	}
   	return $data;
   }

  function aplicaPagoFactura($clie, $id, $docf, $monto, $saldof, $rfc, $tipo){
   	$usuario=$_SESSION['user']->USER_LOGIN;
   	// calculo de aplicacion.
	   	if($monto >= $saldof){
	   		//echo 'El monto: '.$monto.' es mayor al saldo del documento: '.$saldof;
	   		$saldoD = 0; // Saldo Documento
	   		$saldoP = $monto - $saldof;
	   		$aplicar = $saldof;
	   	}elseif($saldof > $monto){
	   		//echo 'El monto: '.$monto.' es menor al saldo del documento: '.$saldof;
	   		$saldoP = 0;
	   		$saldoD = $saldof - $monto;
	   		$aplicar = $monto;
	   	}
	   		if($monto == 0){
		   		echo 'Ya no hay saldo para aplicar a esta factura... Favor de revisar los datos.';
		   		return $monto;
			}

	   		$this->query="SELECT extract(month from fechaelab) as mes, extract(year from fechaelab) as anio, cve_maestro as maestro from factf01 where cve_doc = '$docf'";
	   		$result=$this->QueryObtieneDatosN();
	   		$row=ibase_fetch_object($result);
	   		$mes =$row->MES;
	   		$anio = $row->ANIO;
	   		$maestro = $row->MAESTRO;
	   		$campo='SALDO_'.$anio;

				   	if(substr($id, 0,1) == 'N'){
				   		$this->query="INSERT INTO APLICACIONES (FECHA, FORMA_PAGO, DOCUMENTO, MONTO_APLICADO, SALDO_DOC, SALDO_PAGO, USUARIO, RFC)
				   						VALUES (current_timestamp, '$id', '$docf', $aplicar, $saldoD, $saldoP, '$usuario', '$rfc')";
				    	$rs=$this->EjecutaQuerySimple();

				   	}elseif (substr($id, 0,1) == 'A') {
				   		$idac = substr($id, 2,6);
				   		$this->query = "SELECT ID FROM CARGA_PAGOS WHERE FOLIO_ACREEDOR = $idac";
				   		$rs=$this->QueryObtieneDatosN();
				   		$row=ibase_fetch_object($rs);
				   		$idpag= $row->ID;
				   		$this->query="INSERT INTO APLICACIONES (FECHA, IDPAGO, FORMA_PAGO, DOCUMENTO, MONTO_APLICADO, SALDO_DOC, SALDO_PAGO, USUARIO, RFC)
				   						VALUES (current_timestamp, $idpag, '$id', '$docf', $aplicar, $saldoD, $saldoP, '$usuario', '$rfc')";
				    	$rs=$this->EjecutaQuerySimple();

		   			}else{
				   		$this->query="INSERT INTO APLICACIONES (FECHA, IDPAGO, DOCUMENTO, MONTO_APLICADO, SALDO_DOC, SALDO_PAGO, USUARIO, RFC, FORMA_PAGO)
				   						VALUES (current_timestamp, $id, '$docf', $aplicar, $saldoD, $saldoP, '$usuario', '$rfc', '$tipo')";
				    	$rs=$this->EjecutaQuerySimple();   		
		   			}
		    		//echo $tipo;
		    $this->query ="SELECT max(id) as ida from aplicaciones";
		    $rs=$this->QueryObtieneDatosN();
		    $row=ibase_fetch_object($rs);
		    $ida = $row->IDA;

		    $this->query = "SELECT idpago from aplicaciones where id = $ida";
		    $rs = $this->QueryObtieneDatosN();
		    $row=ibase_fetch_object($rs);
		    $idp =$row->IDPAGO;
		    
				    if($rs and substr($id, 0,1) == 'N'){    	
				    	echo 'Actualizando Saldos ';
				    	$this->query="UPDATE FACTF01 SET SALDOFINAL = $saldoD, PAGOS = (PAGOS + $aplicar) WHERE CVE_DOC = '$docf'";
				   		$rs=$this->EjecutaQuerySimple();

				   		$this->query="UPDATE FACTD01 SET SALDO = $saldoP where CVE_DOC = '$id'";
				   		$rs=$this->EjecutaQuerySimple();
				   		
				   		$this->query="SELECT SALDO FROM FACTD01 WHERE CVE_DOC = '$id'";
				  		$rs=$this->EjecutaQuerySimple();
				  		
				  		$row=ibase_fetch_object($rs);
				  		$rs=$row->SALDO;

					}elseif ($rs and substr($id, 0, 1) == 'A' ){
							echo 'Actualizando Saldos ';
							$idac = substr($id, 2,5);

					    	$this->query="UPDATE FACTF01 SET SALDOFINAL = $saldoD, PAGOS = (PAGOS + $aplicar), aplicado = (aplicado + $aplicar), id_aplicaciones = iif(id_aplicaciones='', $ida,(id_aplicaciones ||' , ' ||$ida)), id_pagos= iif(id_pagos = '', $idp, (id_pagos ||' , '||$idp) )  WHERE CVE_DOC = '$docf'";
					   		$rs=$this->EjecutaQuerySimple();
					   		echo $this->query;
					   		$this->query="UPDATE ACREEDORES SET SALDO = $saldoP where id = CAST(SUBSTRING('$id' FROM 3 FOR 6) AS iNT)";
					   		$rs=$this->EjecutaQuerySimple();

					  		$this->query="UPDATE MAESTROS SET ACREEDOR = ACREEDOR - $aplicar where clave = '$maestro'";
					  		$res=$this->EjecutaQuerySimple();


					   		$this->query="SELECT SALDO FROM ACREEDORES WHERE ID = CAST(SUBSTRING('$id' FROM 3 FOR 6) AS iNT)";
					  		$rs=$this->EjecutaQuerySimple();
					  		$row=ibase_fetch_object($rs);
					  		$rs=$row->SALDO;

				    }elseif($rs){


					   		$this->query="UPDATE FACTF01 SET SALDOFINAL = $saldoD, PAGOS = (PAGOS + $aplicar), aplicado =(aplicado + $aplicar), id_aplicaciones = iif(id_aplicaciones is null, $ida,(id_aplicaciones ||' , ' ||$ida)), id_pagos= iif(id_pagos is null, $idp, (id_pagos ||' , '||$idp) ) WHERE CVE_DOC = '$docf'";
					   		$rs=$this->EjecutaQuerySimple();

						   		if($rs){
						   			$this->query="UPDATE APLICACIONES SET PROCESADO = PROCESADO + 1 WHERE ID = $ida";
						   			$rs=$this->EjecutaQuerySimple();
			   					}

							$this->query="UPDATE CARGA_PAGOS SET SALDO = $saldoP, aplicaciones = iif(aplicaciones is null, 0, aplicaciones) + $aplicar  where ID = $id";
					   		$rs=$this->EjecutaQuerySimple();

					   		$this->query="SELECT SALDO FROM CARGA_PAGOS WHERE ID = $id";
					  		$rs=$this->EjecutaQuerySimple();
					  		$row=ibase_fetch_object($rs);
					  		$rs=$row->SALDO;
				  	}

			$this->query = "UPDATE MAESTROS SET $campo = $campo - $aplicar where clave = '$maestro'";
	   		$rs=$this->EjecutaQuerySimple();
		    //echo $this->query;

	   		$this->query="SELECT MAX(FOLIO) AS FOLIO FROM PAR_RUTA_COBRANZA WHERE DOCUMENTO = '$docf'";
	   		$result=$this->QueryObtieneDatosN();
	   		$row=ibase_fetch_object($result);
	   		
			   		if(isset($row)){
		   			$folioR= $row->FOLIO;
		   			$this->query="UPDATE FOLIOS_RUTA_COBRANZA SET VALOR_CUMPLIDO = VALOR_CUMPLIDO + $aplicar where FOLIO = $folioR";
		   			$rs=$this->EjecutaQuerySimple();
		   			echo $this->query;
		   			}


		/// Analizamos la situacion del cliente
		   	$this->query="SELECT * FROM CLIE01 WHERE trim(CLAVE) = trim('$clie')";
			echo 'Traemos al cliente'.$this->query.'<p>';

 			$res4=$this->EjecutaQuerySimple();
			$row4 = ibase_fetch_object($res4);
		
		if(!empty($row4->STATUS_COBRANZA)){
		    echo 'El cliente esta suspendido'.'<p>';
			$this->query="SELECT min(datediff(day from current_date to fecha_vencimiento)) as dias, COUNT(CVE_DOC) AS DOCS 
								from factf01
							    where trim(cve_clpv) = trim('$row4->CLAVE')
						        and status_fact = 'Cobranza'
						        and extract(year from fecha_doc) >= 2016
						        and saldofinal >= 5 ";
				$rs5 = $this->EjecutaQuerySimple();
				$row5 = ibase_fetch_object($rs5);

			echo 'Traemos los documentos : '.$this->query.'<p>';

			if ($row5->DIAS > -7 or $row5->DOCS == 0){
				echo 'Ya no tiene documentos';
			$this->query="UPDATE CLIE01 SET STATUS_COBRANZA = NULL, inicio_corte = null, finaliza_corte= null, monto_cobranza= 0 , saldo_monto_cobranza = 0 where trim(clave) =trim('$row4->CLAVE')";
			$rs6=$this->EjecutaQuerySimple();
			echo 'Libera el Cliente'.$this->query.'<p>';
			}
		}

 	return $rs;
   }


   function crImpreso($tipo, $identificador){
   	$this->query="UPDATE P_CREDITO SET STATUS = 'A', fecha_aceptacion = current_timestamp WHERE ID = $identificador";
   	$rs=$this->EjecutaQuerySimple();
   	return $rs;
   }

   function traeProv(){
   	$data= array();
   	$this->query="SELECT * FROM PROV01";
   	$rs=$this->QueryObtieneDatosN();
   	while($tsArray=ibase_fetch_object($rs)){
   		$data[]=$tsArray;
   	}
   	$this->query="SELECT * FROM XML_CLIENTES WHERE TIPO = 'Proveedor'";
   	$rs=$this->QueryObtieneDatosN();
   	while($tsArray=ibase_fetch_object($rs)){
   		$data[]=$tsArray;
   	}
   	return $data;
   }

   function guardaCompra($fact, $prov, $monto, $ref, $tipopago, $fechadoc, $fechaedocta, $banco, $tipo, $idg){
   		if($banco !=''){
				$cuenta=explode('-',$banco);
			}
		$bank=trim($cuenta[0]);
		$cuenta=trim($cuenta[1]);
		$usuario = $_SESSION['user']->NOMBRE;
		$val = $this->validaEdoCta($banco=$bank, $cuenta, $mes = substr($fechaedocta ,5,2), $anio = substr($fechaedocta,0,4));		
		if($val == 'ok'){
			$this->query="INSERT INTO CR_DIRECTO( FACTURA, FECHA_FACTURA, FECHA_MOV, PROVEEDOR, IMPORTE, FECHA_EDO_CTA, TP_TES, REFERENCIA, BANCO, CUENTA, TIPO, idgasto, usuario)
   							VALUES ('$fact', '$fechadoc', current_timestamp, '$prov', $monto, '$fechaedocta', '$tipopago', '$ref', '$bank', '$cuenta', '$tipo', $idg, '$usuario')";
	  		$rs=$this->EjecutaQuerySimple();
			$mensaje = "Se ha insertado el gasto";
		}else{
			$mensaje = "El estado de cuenta se encuentra cerrado, no se pueden insetar gastos";
		}
   		return $mensaje;
   }

   function verAplicaciones(){

   		$this->query="SELECT a.*,f.cve_clpv as clave,  c.nombre as cliente, f.importe
   						FROM APLICACIONES a
   						left join factf01 f on a.documento = f.cve_doc
   						left join clie01 c on f.cve_clpv = c.clave
   						where a.status = 'E'";
   		$rs=$this->QueryObtieneDatosN();
   		while ($tsArray=ibase_fetch_object($rs)){
   			$data[]=$tsArray;
   		}

   		return @$data;
   }

   function impAplicacion($ida){
    $this->query="UPDATE APLICACIONES SET STATUS = 'I' WHERE ID = $ida";
    $rs=$this->EjecutaQuerySimple();


   	$this->query="SELECT a.*,f.cve_clpv as clave,  c.nombre as cliente, f.importe
   						FROM APLICACIONES a
   						left join factf01 f on a.documento = f.cve_doc
   						left join clie01 c on f.cve_clpv = c.clave
   						where  ID = $ida";
   	$rs=$this->QueryObtieneDatosN();
   	while ($tsArray=ibase_fetch_object($rs)){
   		$data[]=$tsArray;
   	}
   	return @$data;
   }

 	function verPagosActivos($monto){
 	$this->query="SELECT * FROM CARGA_PAGOS c WHERE  monto containing('$monto') and tipo_pago is null and status <> 'C'";
   	$rs=$this->QueryObtieneDatosN();
   	while($tsArray=ibase_fetch_object($rs)){
   		$data[]=$tsArray;
   	}

	$this->query="SELECT ('A-'||id) as id, 
   		(SELECT cp.FOLIO_X_BANCO FROM CARGA_PAGOS cp WHERE a.id_pago = cp.ID) as FOLIO_X_BANCO, 
   		'N/A' as CLIENTE,
   		(SELECT cp.FECHA_RECEP FROM CARGA_PAGOS cp WHERE a.id_pago = cp.ID) as FECHA_RECEP, 
   		MONTO,
   		SALDO,
   		'' AS RFC,
   		(SELECT cp.BANCO FROM CARGA_PAGOS cp WHERE a.id_pago = cp.ID) as BANCO 
   		FROM ACREEDORES a WHERE monto containing('$monto') and status = 0";
   	$rs=$this->QueryObtieneDatosN();
   	while($tsArray=ibase_fetch_object($rs)){
   		$data[]=$tsArray;
   	}

   	return @$data;
   }


    function verPagoActivo($idp, $tipo){
    
    	if(substr($tipo, 0,1)=='A'){
    		$idp = $tipo;
    	}

    if(substr($idp, 0,2) == 'NR'){
   		$this->query="SELECT cve_doc as ID, CVE_CLPV as cliente, fechaelab as FECHA_RECEP, importe as Monto, 'N/A' as BANCO, RFC as RFC, saldo FROM FACTD01 WHERE SALDO > 0 AND cve_doc = '$idp'";
   		$rs=$this->QueryObtieneDatosN();
   	while($tsArray=ibase_fetch_object($rs)){
   		$data[]=$tsArray;
   		}
   	}elseif(substr($idp, 0,1)== 'A'){
   		$idp = substr($idp, 2,5);
   		$this->query="SELECT ('A-'||id) as id, 
   		(SELECT cp.FOLIO_X_BANCO FROM CARGA_PAGOS cp WHERE cp.id = $idp) as FOLIO_X_BANCO, 
   		'N/A' as CLIENTE,
   		(SELECT cp.FECHA_RECEP FROM CARGA_PAGOS cp WHERE cp.id = $idp) as FECHA_RECEP, 
   		MONTO,
   		SALDO,
   		'' AS RFC,
   		(SELECT cp.BANCO FROM CARGA_PAGOS cp WHERE cp.id = $idp) as BANCO 
   		FROM ACREEDORES a WHERE id = $idp";
   		
   		$rs=$this->QueryObtieneDatosN();
   		while($tsArray=ibase_fetch_object($rs)){
   			$data[]=$tsArray;
   		}
   	}else{
   		$this->query="SELECT * FROM CARGA_PAGOS WHERE ID=$idp";
   		$rs=$this->QueryObtieneDatosN();
   		while($tsArray=ibase_fetch_object($rs)){
   			$data[]=$tsArray;
   		}
   	}
   		return $data;
   }

   function listaFacturas(){
   		$this->query="SELECT f.*--, c.NOMBRE 
   					FROM FACTF01 f
   					--inner join clie01 c on f.cve_clpv=c.clave  
   					WHERE f.SALDO > 2
   					and f.status != 'C'
   					and f.fechaelab > '10.10.2015' 
   					and f.fechaelab <= '01.02.2016'
   					";
   		$rs=$this->QueryObtieneDatosN();
   		while($tsArray=ibase_fetch_object($rs)){
   			$data[]=$tsArray;
   		}
   		return @$data;
   	}

   	function IdvsComp(){
   		$this->query="SELECT p.id, p.cotiza,pe.cve_pedi, p.prod, p.nomprod, pr.nombre, pr.clave, poc.cost, p.cant_orig, oc.fecha_doc, pv.prec
 ,(((iif(pv.prec=0,1,pv.prec)/iif(poc.cost=0, 1, poc.cost))-1)*100) as utilidad
        from preoc01 p
        inner join par_compo01 poc on p.id = poc.id_preoc
        inner join compo01 oc on oc.cve_doc = poc.cve_doc
        inner join prov01 pr on pr.clave = oc.cve_clpv
        inner join par_factp01 pv on pv.id_preoc = p.id
        inner join factp01 pe on pe.cve_doc = pv.cve_doc
        where p.NOM_CLI containing ('LIVERPOOL')
        ORDER BY P.PROD ASC";
   		$rs=$this->QueryObtieneDatosN();
   		while($tsArray=ibase_fetch_object($rs)){
   			$data[]=$tsArray;
   		}

   		return $data;
   	}

   	function listaFacturasOK($docf){
   		$this->query="SELECT f.*, c.NOMBRE 
   					FROM FACTF01 f
   					left join clie01 c on f.cve_clpv=c.clave  
   					WHERE f.SALDOFINAL > 2
   					and cve_doc = '$docf'";
   		$rs=$this->QueryObtieneDatosN();
   		while($tsArray=ibase_fetch_object($rs)){
   			$data[]=$tsArray;
   		}
   		return @$data;
   	}

   	function traeValidacion($doco){
   		$this->query="SELECT * FROM VALIDA_RECEPCION WHERE DOCUMENTO ='$doco'";
   		$rs=$this->QueryObtieneDatosN($doco);
   		while ($tsArray=ibase_fetch_object($rs)){
   			$data[]=$tsArray;
   		}

   		return $data;
   	}

   	function verAplivsFact(){
   		$this->query="SELECT * FROM carga_pagos WHERE saldo <> monto and (status is null or status = '')";
   		$rs=$this->QueryObtieneDatosN();
   		while($tsArray=ibase_fetch_object($rs)){
   			$data[]=$tsArray;
   		}
   		return @$data;
   	}

    function infoPago($idp){
  		$data=array();
  		$this->query="SELECT (c.monto + c.monto_cf) as monto, C.*, M.NOMBRE AS MAESTRO, M.CLAVE AS CLAVE_MAESTRO FROM carga_pagos C LEFT JOIN MAESTROS M ON cast(M.ID as varchar(20)) = C.CLIENTE where C.id = $idp";
  		//echo $this->query;
  		$rs = $this->QueryObtieneDatosN();
  		while($tsArray=ibase_fetch_object($rs)){
  			$data[]=$tsArray;
  		}
  		return @$data;
	}  	


	function movimientosPago($idp){
		$this->query="SELECT a.*, 
							--f.*,
							coalesce(f.importe, fp.importe) as importe,
							 c.* 
					from aplicaciones a
					left join factf01 f on f.cve_doc = a.documento
					left join facturas_fp fp on fp.cve_doc = a.documento
					inner join clie01 c on c.clave = f.cve_clpv or c.clave_trim = fp.cve_clpv
					where a.idpago = $idp and cancelado = 0";
		$rs=$this->QueryObtieneDatosN();
		while($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}

		$this->query="UPDATE CARGA_PAGOS SET STATUS = 'I' WHERE ID = $idp";
		$result=$this->EjecutaQuerySimple();


		return @$data;

	}

	function almacenarFolioContrarecibo($tipo, $identificador, $montor, $facturap, $recepcion){
        $TIME = time();
        $HOY = date("Y-m-d H:i:s", $TIME);
        $usuario = $_SESSION['user']->USER_LOGIN;
        $AUTOINCREMENT = "SELECT coalesce(MAX(FOLIO), 0) AS FOLIO FROM OC_CREDITO_CONTRARECIBO";
        $this->query = $AUTOINCREMENT;
        $rs = $this->QueryObtieneDatosN();
      	while($tsArray=ibase_fetch_object($rs)){
      		$data[]=$tsArray;
      	}
        $folio = 1;
      	foreach($data as $row):
            $folio = $row->FOLIO+1;
        endforeach;

        if($tipo=="GASTO"){
            $id = $identificador;
        } elseif($tipo=="RECEPCION") {
            $id = "(SELECT RECEPCION FROM OC_PAGOS_CREDITO WHERE ID = '$identificador')";
        }elseif($tipo=='RECEPCION_PEGASO'){
       		$id = "(SELECT RECEPCION FROM OC_PAGOS_CREDITO_RECIBO WHERE ID = '$identificador')";  	
        }

        $this->query = "INSERT INTO OC_CREDITO_CONTRARECIBO VALUES ($folio,'$HOY','$tipo',$recepcion,'$usuario','PD');";        
        $respuesta = $this->EjecutaQuerySimple();
        //echo 'Valor de respuesta:'.$respuesta.'<p>';
        
        if($tipo =='RECEPCION'){
        	$this->query= "UPDATE COMPR01 SET MONTO_REAL = $montor, FACT_PROV = '$facturap' where TRIM(CVE_DOC) = TRIM('$identificador')";	
        }elseif($tipo =='RECEPCION_PEGASO'){
        	$this->query= "UPDATE  ftc_detalle_recepciones SET MONTO_REAL = $montor, FACT_PROV = '$facturap' where TRIM(orden) = TRIM('$identificador') and id_recepcion = $recepcion";
        }

        //echo $this->query;
        //break;

        $rs=$this->EjecutaQuerySimple();
        return $respuesta>=1?$folio:-1;
    }


    function actualizarFolioContrarecibo($folio){
        $this->query = "UPDATE OC_CREDITO_CONTRARECIBO SET STATUS = 'IM' WHERE FOLIO = $folio";
        $respuesta = $this->EjecutaQuerySimple();
        return $respuesta;
    }
 
    function listarOCContrarecibos(){
        $data = array();
        $this->query = "SELECT A.FOLIO, A.FECHA_IMPRESION, B.PROMESA_PAGO, A.TIPO, A.IDENTIFICADOR, A.USUARIO, B.RECEPCION, B.OC, B.FACTURA, B.MONTOR, B.BENEFICIARIO 
                          FROM OC_CREDITO_CONTRARECIBO A 
                          INNER JOIN OC_PAGOS_CREDITO B ON TRIM(A.IDENTIFICADOR) = TRIM(B.RECEPCION)
                          INNER JOIN COMPR01 C ON A.IDENTIFICADOR = C.CVE_DOC
                         WHERE A.STATUS = 'IM' AND (C.STATUS_PAGO <> 'PP' or C.STATUS_PAGO IS NULL)
                         and FECHA_IMPRESION > '01.06.2017'
                         ORDER BY B.BENEFICIARIO ASC";
        $rs = $this->QueryObtieneDatosN();
      	while($tsArray=ibase_fetch_object($rs)){
      		$data[]=$tsArray;
      	}

      	$this->query="SELECT A.FOLIO, A.FECHA_IMPRESION, B.PROMESA_PAGO, A.TIPO, A.IDENTIFICADOR, A.USUARIO, B.RECEPCION, B.OC, B.FACTURA, B.MONTOR, B.BENEFICIARIO 
                          FROM OC_CREDITO_CONTRARECIBO A 
                          INNER JOIN OC_PAGOS_CREDITO_RECIBO B ON A.IDENTIFICADOR = cast(B.RECEPCION as varchar(10))
                          where A.STATUS = 'IM' AND 
                          B.STATUS_PAGO is null
                          and FECHA_IMPRESION > '01.06.2017'
                          ORDER BY B.BENEFICIARIO ASC";
                          //echo 'Lista de OC Contrarecibos: '.$this->query;
 		$rs = $this->QueryObtieneDatosN();
      	while($tsArray=ibase_fetch_object($rs)){
      		$data[]=$tsArray;
      	}

        return $data;
    }

     function pagarOCContrarecibos($folios){
		$data = array();
        
        $this->query = "SELECT A.FOLIO, A.FECHA_IMPRESION, B.PROMESA_PAGO, A.TIPO, B.RECEPCION, B.OC, B.FACTURA , B.MONTOR, B.BENEFICIARIO 
                          FROM OC_CREDITO_CONTRARECIBO A INNER JOIN OC_PAGOS_CREDITO B ON A.IDENTIFICADOR = B.RECEPCION 
                         WHERE STATUS = 'IM' AND A.FOLIO IN ($folios)
                         ORDER BY B.PROMESA_PAGO;";
        $rs = $this->QueryObtieneDatosN();
      	while($tsArray=ibase_fetch_object($rs)){
      		$data[]=$tsArray;
      	}


        $this->query = "SELECT A.FOLIO, A.FECHA_IMPRESION, B.PROMESA_PAGO, A.TIPO, B.RECEPCION, B.OC, B.FACTURA , B.MONTOR, B.BENEFICIARIO 
                          FROM OC_CREDITO_CONTRARECIBO A INNER JOIN OC_PAGOS_CREDITO_RECIBO B ON A.IDENTIFICADOR = B.RECEPCION 
                         WHERE STATUS = 'IM' AND A.FOLIO IN ($folios)
                         ORDER BY B.PROMESA_PAGO;";
        $rs = $this->QueryObtieneDatosN();
      	while($tsArray=ibase_fetch_object($rs)){
      		$data[]=$tsArray;
      	}

        return $data;
    }
    
    
    function encontrarInformacionFolioOCC($folio){
        $this->query = "SELECT A.FOLIO, A.IDENTIFICADOR, B.FECHA_DOC, B.RECEPCION , B.BENEFICIARIO, B.MONTO
    					FROM OC_CREDITO_CONTRARECIBO A
    					INNER JOIN OC_PAGOS_CREDITO B ON A.IDENTIFICADOR = B.RECEPCION
    					WHERE A.FOLIO = $folio";
                        //echo $this->query;
        $rs = $this->QueryObtieneDatosN();
        $data = array();
      	while($tsArray=ibase_fetch_object($rs)){
      		$data[]=$tsArray;
      	}
        return $data;        
    }
    
 	function registrarPagoCreditoOC($monto, $cuentaBanco, $medio){
        $AUTOINCREMENT = "SELECT coalesce(MAX(IDENTIFICADOR), 0) AS IDENTIFICADOR FROM PAGO_CREDITOS_OC;";
        $this->query = $AUTOINCREMENT;
        $rs = $this->QueryObtieneDatosN();
      	while($tsArray=ibase_fetch_object($rs)){
      		$data[]=$tsArray;
      	}
        $identificador = 1;
      	foreach($data as $row):
            $identificador = $row->IDENTIFICADOR+1;
        endforeach;
        //echo "El identificador dado es: $identificador";
        $TIME = time();
        $HOY = date("Y-m-d H:i:s", $TIME);
        $usuario = $_SESSION['user']->USER_LOGIN;
        $this->query = "INSERT INTO PAGO_CREDITOS_OC (IDENTIFICADOR,FECHA_PAGO,CUENTA_BANCO,MEDIO_PAGO,MONTO_PAGO,USUARIO,STATUS)";
        $this->query.= "VALUES";
        $this->query.= "($identificador, '$HOY', '$cuentaBanco', '$medio', $monto, '$usuario', 'PD')";
        //echo $this->query;
        //echo "SQL PAGO_CREDITO_OC: ".$this->query;
        $respuesta = $this->EjecutaQuerySimple();
        if($respuesta>0){
            return $identificador;
        } else {
            return $respuesta;
        }
    }
    
    function actualizarPagoCreditoOCAplicado($identificador){
        $this->query = "UPDATE PAGO_CREDITOS_OC SET STATUS = 'AP' WHERE IDENTIFICADOR = $identificador";
        $respuesta = $this->EjecutaQuerySimple();
        return $respuesta>0;
    }
    
    function pagarOCContrarecibosAplicar($identificador, $folio, $cuentaBancaria, $documento, $medio, $monto, $proveedor, $claveProveedor, $fechaDocumento){        
        //echo "por ir a GuardaPagoCorrecto";
        $respuesta = $this->GuardaPagoCorrecto($cuentaBancaria, $documento, $medio, $monto, $proveedor, $claveProveedor, $fechaDocumento);
        //echo "respuesta al registro de pago: $respuesta";
        if($respuesta >0){
            $this->query = "INSERT INTO PAGO_CREDITOS_OC_DETALLE (IDENTIFICADOR, FOLIO, DOCUMENTO, MONTO_PAGO, FECHA_DOCUMENTO, CLV_PROV)";
            $this->query.= "VALUES";
            $this->query.= "($identificador, $folio, '$documento',$monto,'$fechaDocumento','$claveProveedor');";
            //echo "sql: ".$this->query;
            $respuesta = $this->EjecutaQuerySimple();            
            return $respuesta;
        }
        return 0;
    }

    


   function asignar($idp, $asignado, $idingreso){
    	$usuario = $_SESSION['user']->NOMBRE;
    	$doa = new idpegaso;
		$val = $doa->revisaDuplicado($idp);
		
		if(substr($idingreso,0,3) =='PGS' ){
    		$this->query="SELECT ID, RESTANTE FROM INGRESOBODEGA WHERE PRODUCTO = '$idingreso' and restante > 0 ";
    		$result=$this->EjecutaQuerySimple();
    		while ($tsArray=ibase_fetch_object($result)) {
    			$lineas[]=$tsArray;
    		}
    		// Revisamos cuantas lineas tiene el resultado:
    		if(count($lineas)==1){  /// Si solo hay una linea obtenemos ese restante.
    			foreach ($lineas as $key) {
	    			$res = $key->RESTANTE;
	    			$idingreso = $key->ID; 
    			}
    		}else{ /// En caso se que haya 2 o mas lineas.
    			foreach ($lineas as $key){
    				$this->query="SELECT RESTANTE FROM INGRESOBODEGA WHERE ID = $key->ID";
    				$rs=$this->EjecutaQuerySimple();
    				$row=ibase_fetch_object($rs);
    				$res = $row->RESTANTE;

	    				if (($res-$asignado)< 0){   /// SI REQUERIMOS MAS DE LO QUE HAY EN LA LINEA 1 ENTONCES OBTENEMOS LO QUE TIENE LA LINEA 1 Y LA DEJAMOS EN 0.
	    					$this->query="UPDATE INGRESOBODEGA SET restante= 0, asignado = iif(asignado is null,0 + $res, asignado + $res) where id =$key->ID";
				    		$this->grabaBD();
				    		$this->query="INSERT INTO ASIGNACION_BODEGA_PREOC (ID, IDINGRESO, INICIAL, ASIGNADO, FINAL, FECHA_MOV, USUARIO_MOV, PREOC, COTIZA, status )
				    			values(NULL, $key->ID, $res, $res, 0, current_timestamp, '$usuario', $idp, (SELECT COTIZA FROM PREOC01 WHERE ID = $idp), 0)";
				    		$this->grabaBD();

				    		$this->query="UPDATE PREOC01 SET ORDENADO = iif(ORDENADO is null, 0 + $res, ordenado + $res), rest = (rest - $asignado), canti = canti - $res where id = $idp";
				    		$this->grabaBD();

				    		$response = array("status"=>"ok","tipo"=>"multiple","res"=>$res,"asignado"=>$res);
				    		$asignado = $asignado - $res; 
				    	}else{
				    		$this->query="UPDATE INGRESOBODEGA SET restante= $res-$asignado, asignado = iif(asignado is null,0 + $asignado, asignado + $asignado) where id =$key->ID";
				    		$this->grabaBD();

				    		$this->query="INSERT INTO ASIGNACION_BODEGA_PREOC (ID, IDINGRESO, INICIAL, ASIGNADO, FINAL, FECHA_MOV, USUARIO_MOV, PREOC, COTIZA, status )
				    			values(NULL, $key->ID, $res, $asignado, $res-$asignado, current_timestamp, '$usuario', $idp, (SELECT COTIZA FROM PREOC01 WHERE ID = $idp), 0)";
				    		$this->grabaBD();
				    		

				    		$this->query="UPDATE PREOC01 SET ORDENADO = iif(ORDENADO is null, 0 + $asignado, ordenado + $asignado), rest = (rest - $asignado), canti = canti - $res   where id = $idp";
				    		$this->grabaBD();

				    		$response=array("status"=>"ok", "tipo"=>"Ingreso");
				    	} 
    			}

				return $response;
    		}

    	}else{

    		$this->query="SELECT RESTANTE FROM INGRESOBODEGA WHERE ID = $idingreso";
    		$rs=$this->EjecutaQuerySimple();
    		$row=ibase_fetch_object($rs);
    		$res = $row->RESTANTE;	
    	}
    	

    	if (($res-$asignado)< 0){
    		$response = array("status"=>"error","tipo"=>"diferencia","res"=>$res,"asignado"=>$asignado);
    		return $response;
    	}else{
    		$this->query="UPDATE INGRESOBODEGA SET restante= $res-$asignado, asignado = iif(asignado is null,0 + $asignado, asignado + $asignado) where id =$idingreso";
    		$this->grabaBD();

    		$this->query="INSERT INTO ASIGNACION_BODEGA_PREOC (ID, IDINGRESO, INICIAL, ASIGNADO, FINAL, FECHA_MOV, USUARIO_MOV, PREOC, COTIZA, status )
    			values(NULL, $idingreso, $res, $asignado, $res-$asignado, current_timestamp, '$usuario', $idp, (SELECT COTIZA FROM PREOC01 WHERE ID = $idp), 0)";
    		$this->grabaBD();

    		$this->query="UPDATE PREOC01 SET ORDENADO = iif(ORDENADO is null, 0 + $asignado, ordenado + $asignado), rest = (rest - $asignado), canti = canti - $asignado  where id = $idp";
    		$this->grabaBD();

    		$response=array("status"=>"ok", "tipo"=>"Ingreso");
    		return $response;
    	}
    }

    function asignacionBodega(){
    	$data = array();
    	$this->query="SELECT A.*, I.*, A.asignado as Asig FROM ASIGNACION_BODEGA_PREOC A LEFT JOIN INGRESOBODEGA I ON I.ID = A.IDINGRESO where A.status = 7";
    	$rs=$this->EjecutaQuerySimple();
	    	while ($tsArray=ibase_fetch_object($rs)){
	    		$data[]=$tsArray;
	    	}
    	return $data;
    }

   	function verSolBodega(){
   		$data=array();
		$usuario = $_SESSION['user']->NOMBRE;
		$rol = $_SESSION['user']->USER_ROL;
		if($rol != 'bodega' and $rol != 'administracion'){
				$this->query="SELECT ab.*, p.prod, p.NOMPROD, ib.descripcion as descr, ib.producto as produ  FROM ASIGNACION_BODEGA_PREOC ab left join preoc01 p on p.id = ab.preoc 
					left join ingresobodega ib on ib.id = ab.idingreso 
					WHERE FECHA_MOV >= '01.01.2018' AND USUARIO_MOV= '$usuario' AND VERSUM IS NULL and ab.status <> 99";
				$rs =$this->EjecutaQuerySimple();
		}else{
				$this->query="SELECT ab.*, p.prod, p.NOMPROD, ib.descripcion as descr, ib.producto as produ  FROM ASIGNACION_BODEGA_PREOC ab left join preoc01 p on p.id = ab.preoc 
				left join ingresobodega ib on ib.id = ab.idingreso 
				WHERE FECHA_MOV >= '01.01.2018' AND (VERSUM IS NULL OR VERSUM = 0) and ab.status <> 99";
				$rs=$this->EjecutaQuerySimple();
		}
		//echo $this->query;
		while ($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}
		return $data;
	}

    function revisarNuevoIngreso($desc){
    	$data= array();
    	$prod = $desc;
    	$this->query="SELECT * FROM PREOC01 WHERE PROD = '$prod' and rest >= 1 and STATUS = 'N' and rec_faltante >= 1";
    	$rs=$this->EjecutaQuerySimple();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	//exit($this->query);
    	return $data;
    }

    function editIngresoBodega($idi, $costo, $proveedor, $cant, $unidad){
    	$this->query="UPDATE INGRESOBODEGA SET PROVEEDOR = '$proveedor', costo = $costo, cant = $cant, unidad = '$unidad' where id = $idi";
    	$rs=$this->EjecutaQuerySimple();
    	return $rs;
    }
    
    function verIngresoBodega(){
    	$this->query="SELECT producto, sum(restante) as cant,
    					max(costo) as costo, max(descripcion) as descripcion, max(unidad) as unidad, max(fecha) as fecha, max(proveedor) as proveedor 
    					FROM INGRESOBODEGA 
    					where restante > 0 
    					group by producto ";
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}

    	return $data;
    }

    function salidaAlmacen ($producto, $cantidad){
    	$this->query="SELECT sum(restante) as cant, producto , max(descripcion) as descripcion, max(costo ) as costo 
    	FROM INGRESOBODEGA WHERE producto = '$producto' group by producto";
    	$rs=$this->EjecutaQuerySimple();
    	//echo $this->query;
    	while ($tsArray=ibase_fetch_object($rs)) {
    		$data[]=$tsArray;
    	}

    	return $data;
    }


    function pendientePorRecibir($producto){
    	$data=array();
    	$this->query="SELECT * FROM PREOC01 WHERE PROD = '$producto' and rec_faltante  >= 1 and ordenado < cant_orig and (status = 'N' or status = 'B') and fechasol >= '01.12.2017' ";
    	$rs=$this->EjecutaQuerySimple();
    	//echo $this->query;
    	while ($tsArray=ibase_fetch_object($rs)) {
    	 	$data[]=$tsArray;
    	 } 

    	 return $data;
    }


    function asignarProductoAlmacen($producto, $cotizacion, $cantidad, $cantidadAlmacen, $id){

    	$usuario = $_SESSION['user']->NOMBRE;

    	$this->query="UPDATE PREOC01 SET status= iif(rest - $cantidad <= 0, 'B', 'N'),  rest = rest - $cantidad,  RECEPCION = RECEPCION + $cantidad, REC_FALTANTE = REC_FALTANTE - $cantidad where cotiza = '$cotizacion' and prod ='$producto' ";
    	$this->EjecutaQuerySimple();
    	
    	$this->query="UPDATE INGRESOBODEGA SET CANT = CANT - $cantidad where id = $id";
    	$this->EjecutaQuerySimple();
    	
    	$this->query="INSERT INTO SALIDASBODEGA (ID, IDINGRESO, COTIZACION, CANTIDAD, FECHA , USUARIO, TIPO) VALUES (NULL, $id, '$cotizacion', $cantidad, current_timestamp, '$usuario', 'Salida') ";
    	$this->EjecutaQuerySimple();
    	
    	//break;
    	return;

    }


     function emitirCierreCR($cr){
     	switch (date('w')){
                case '0':
                    $dia = 'D';
                    break;
                case '1':
                    $dia = 'L';
                    break;
                case '2':
                    $dia = 'MA';
                    break;
                case '3':
                    $dia = 'MI';
                    break;
                case '4':
                    $dia = 'J';
                    break;
                case '5':
                    $dia = 'V';
                    break;
                case '6':
                    $dia = 'S';
                    break;
                default:
                    break;                  
            }
    	$this->query="SELECT MAX(FOLIO_CIERRE) AS FC FROM CAJAS WHERE  upper(cr) = upper('$cr')";
    	$rs = $this->QueryObtieneDatosN();
    	$row=ibase_fetch_object($rs);
    	$fn=$row->FC;
    	$fn=$fn + 1;
 
        $this->query="SELECT a.id, a.aduana , a.cve_fact,a.status_log, a.Remision,
    			c.importe as ImpRem,  a.FACTURA, d.importe as ImpFac,
    			c.fechaelab as FECHAREM, d.FECHAELAB as FECHAFAC, a.cr,
    			datediff(day,a.fecha_secuencia,current_date) AS dias,
    			a.CONTRARECIBO_CR , cl.nombre as CLIENTE, a.cr as CARTERA_REV
    			FROM CAJAS a
    			left join FACTR01 c on c.cve_doc = a.remision
    			left join FACTF01 d on d.cve_doc = a.factura
    			left join factp01 p on p.cve_doc = a.cve_fact
    			left join clie01 cl on p.cve_clpv = cl.clave
    			WHERE
        			a.aduana = 'Cobranza'
    			and a.CR = '$cr'
    			and a.contrarecibo_cr is not null
    			and a.imp_cierre = 0";

    	/*"SELECT * FROM CAJAS 	
    			where upper(cr) = upper('$cr') 
    			and (fecha_rev between CAST('TODAY' AS DATE) AND CAST('TOMORROW' AS DATE))
    			and  contraRecibo_cr is not null";*/
    	$rs=$this->QueryObtieneDatosN();

    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	foreach ($data as $key) {
    		$caja = $key->ID;
    		$this->query="UPDATE cajas set imp_cierre = 1, folio_cierre = $fn  
    			where id = $caja";
    		//echo $this->query;
    	$rs = $this->EjecutaQuerySimple();
    	}

    	//$this->query="UPDATE CAJAS SET IMP_CIERRE = 1 WHERE upper(cr) = upper('$cr') and fecha_ultimo_motivo = cast('now' as date)";
   		//echo $this->query;
    	//$rs = $this->EjecutaQuerySimple();
    	return $rs;
    }

    function nomames(){
    	return;
    }

      function docCobRecibidos(){
      	$this->query="SELECT COUNT(ID) as ID FROM CAJAS WHERE docs_cobranza = 'S' and fecha_rec_cobranza >= 'Today'";
      	$rs=$this->QueryObtieneDatosN();
      	$row=ibase_fetch_object($rs);
      	$valida = $row->ID;
      	return $valida;
      }

      function impRecCobranza(){
		############### Obtenemos el folio siguiente #################
    	$this->query = "SELECT max(folio_rec_cobranza) as FM from cajas";
    	$rs=$this->QueryObtieneDatosN();
    	$row=ibase_fetch_object($rs);
    	$fn = $row->FM + 1;    	

      	############# Primero validamos que todos los datos vengan limpios  ##############
      	$this->query="SELECT ID, factura FROM CAJAS WHERE docs_cobranza = 'S'";
      	$rs=$this->QueryObtieneDatosN();

      		while ($tsArray=ibase_fetch_object($rs)){
      			$data[]=$tsArray;
      		}
      		$i=0;
      		//var_dump($data);
      		//break;
      		foreach ($data as $key) {
      			
      			$id = $key->ID;
      			$this->query="SELECT * FROM CAJAS WHERE ID = $id";
      			$res=$this->QueryObtieneDatosN();
      			$row=ibase_fetch_object($res);
      			$docf = $row->FACTURA;

		      		if(isset($docf)){ // Con esto solo actualizamos las cajas y facturas que existan.
		      				//// OBTENEMOS LOS DATOS DEL CLIENTE (PLAZO Y CREDITO ACTUAL) Y LOS DATOS DE LA FACTURA (CLAVE CLIENTE).
		      			$this->query = "SELECT ct.plazo as plazo, ct.idCliente as cliente FROM FACTF01 f left join cartera ct on trim(ct.idCliente) = trim(f.cve_clpv) WHERE CVE_DOC = '$docf'";
		      			$result=$this->QueryObtieneDatosN();
		      			$rowct=ibase_fetch_object($result);
		      			$plazo = $rowct->PLAZO;
		      			$cliente = $rowct->CLIENTE;
		      			if(isset($plazo)){ /// Con esto solo actualizamos lo que tenga un plazo. 
		      				$this->query="UPDATE FACTF01 SET fecha_vencimiento = DATEADD(DAY, $plazo, current_date) where cve_doc = '$docf'";
		      				$resultado=$this->EjecutaQuerySimple();
		      				//echo 'Consulta Actualiza Vencimiento: '.$this->query.'<p>';
		      				/// actualiza la caja para la impresion.
		      				$this->query="UPDATE CAJAS SET docs_cobranza = 'Si', folio_rec_cobranza = $fn, imp_rec_cobranza = 1 where id = $id";
		    				$rs=$this->EjecutaQuerySimple();	
		      			}else{
		      				$this->query="UPDATE CAJAS SET OBSERVACIONES=iif(observaciones is null or observaciones = '',', Cliente Sin Plazo', (observaciones ||', Cliente Sin Plazo') where id = $id";
		      				$rs=$this->EjecutaQuerySimple();
      					}
		      		}
		      	$info[]=array($i,$id, $docf,$cliente,$plazo);		
		      	$i=$i+1;	
      		}

    	/*
    	$this->query="UPDATE CAJAS SET docs_cobranza = 'Si', folio_rec_cobranza = $fn, imp_rec_cobranza = 1 where docs_cobranza = 'S'";
    	$rs=$this->EjecutaQuerySimple();
    	echo $this->query;
		*/
		//break;
    	return $fn;
    }

    function recepcionCobranza($folio){
    	$this->query="SELECT c.*, cl.nombre, f.fechaelab, f.importe   
    				  FROM CAJAS c 
    				  left join factf01 f on f.cve_doc = c.factura
    				  left join CLIE01 cl on cl.clave = f.cve_clpv
    				  where docs_cobranza = 'Si'
    				  and imp_rec_cobranza = 1 
    				  and folio_rec_cobranza = $folio 
    				  ";
    	$rs=$this->QueryObtieneDatosN();
    	while ($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}

    	return @$data;
    }

    function impresionCierre(){
    	$this->query="SELECT iif(COUNT(ID) is null, 0, COUNT(ID)) as VAL FROM CAJAS WHERE docs_cobranza = 'S' and imp_rec_cobranza = 0";
    	$rs=$this->QueryObtieneDatosN();
    	$row=ibase_fetch_object($rs);
    	$result = $row->VAL;
    	return $result;

    }

        function habilitaImpresionCierreEnt($idr){
    	$this->query="SELECT COUNT(ID) FROM CAJAS WHERE DOCS = ";

    }

    function imprimeCierreEnt($idr){
    	$this->query="SELECT iif(Max(FOLIO_CIERRE_LOGISTICA) is null, 0, max(FOLIO_CIERRE_LOGISTICA)) as FA from cajas";
    	$rs=$this->QueryObtieneDatosN();
    	$row=ibase_fetch_object($rs);
    	$fn = $row->FA + 1 ;

    	$this->query="UPDATE CAJAS SET FOLIO_CIERRE_LOGISTICA = $fn, cierre_uni='impreso' where cierre_uni = 'ok' and FOLIO_CIERRE_LOGISTICA=0 and idu = $idr";
    	$rs=$this->EjecutaQuerySimple();
    	return $fn; 

    }

    function cierre_uni_ent($folio){
    	$this->query="SELECT c.*, cl.nombre, 
    				  iif(c.factura is null or c.factura = '', c.remision, c.factura) as Documento, 
    				  iif(c.factura is null or c.factura = '', r.importe, f.importe) as importe,
    				  iif(c.factura is null or c.factura = '', r.fechaelab, f.fechaelab) as fechaelab  
    				  From cajas c
    				  left join factp01 p on c.cve_fact = p.cve_doc
    				  left join factf01 f on c.factura = f.cve_doc
    				  left join factr01 r on c.remision = r.cve_doc
    				  left join clie01 cl on cl.clave = p.cve_clpv
    				  where FOLIO_CIERRE_LOGISTICA = $folio";
    	$rs=$this->QueryObtieneDatosN();
    	while ($tsArray=ibase_fetch_object($rs)){
    		$data[]= $tsArray;
    	}
    	return @$data;
    }


        function verCierreVal(){
    	$this->query="SELECT first 100 c.*, p.nombre , o.cve_doc as OC, o.fechaelab as OC_FECHAELAB, o.importe as OC_IMPORTE, o.STATUS_REC as OC_STATUS_VAL,  o.usuario_recibe AS OC_USUARIO_VAL
    			from compr01 c 
    			left join prov01 p on c.cve_clpv = p.clave
    			left join compo01 o on o.cve_doc = c.doc_ant
    			where (c.status_rec = 'Ok' 
    			or c.status_rec = 'par') 
    			and c.Rec_Contabilidad = 'No' 
    			and c.imp_cierre = 'No'
    			and c.fechaelab >= '01.08.2016'";
    	$rs = $this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return @$data;
    }

    function guardaFacturaProv($docr, $factura){
    	$this->query="UPDATE COMPR01 SET FACTURA_PROV = '$factura' where cve_doc  = '$docr' ";
    	$rs=$this->EjecutaQuerySimple();
    	return $rs;
    }

    function impCierreVal(){
    	$this->query="SELECT max(FOLIO_IMP_CIERRE_VAL) as FA from compr01";
    	$rs=$this->QueryObtieneDatosN();
    	$row=ibase_fetch_object($rs);
    	$fn = $row->FA + 1 ;

    	echo "Este es el folio '$fn'";

    	$this->query="UPDATE COMPR01 SET FOLIO_IMP_CIERRE_VAL = $fn, IMP_CIERRE = 'Si' where imp_cierre = 'No' and factura_prov != 'Pendiente'";
    	$rs=$this->EjecutaQuerySimple();

    	$this->query="SELECT c.*, p.nombre , o.cve_doc as OC, o.fechaelab as OC_FECHAELAB, o.importe as OC_IMPORTE, o.STATUS_REC as OC_STATUS_VAL,  o.usuario_recibe AS OC_USUARIO_VAL
    			from compr01 c 
    			left join prov01 p on c.cve_clpv = p.clave
    			left join compo01 o on o.cve_doc = c.doc_ant
    			where FOLIO_IMP_CIERRE_VAL = $fn";

    	$rs = $this->QueryObtieneDatosN();
    	while($tsArray = ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}

    	return @$data;
   	}

   	function guardaCargoFinanciero($monto, $fecha, $banco){
   		$this->query="SELECT BANCO, NUM_CUENTA FROM PG_BANCOS WHERE ID = $banco";
   		$rs=$this->QueryObtieneDatosN();
   		$row=ibase_fetch_object($rs);
   		$cuenta = $row->NUM_CUENTA;
   		$banco = $row->BANCO;
   		$mes = substr($fecha,3,2);
   		$anio = substr($fecha,6,4);
   		$val = $this->validaEdoCta($banco, $cuenta, $mes, $anio);
   		$usuario=$_SESSION['user']->NOMBRE;
   		if($val == 'ok'){
   			$this->query="INSERT INTO CARGO_FINANCIERO (FECHA_RECEP, MONTO, BANCO, CUENTA, SALDO, USUARIO, FECHA) VALUES ('$fecha', $monto, '$banco','$cuenta',$monto, '$usuario', current_timestamp )";
   			$rs=$this->EjecutaQuerySimple();	
   			$mensaje = 'Se ha relizado el Cargo Fiannciero Correctamente';
   		}else{
   			$mensaje ='El estado de cuenta esta cerrado y conciliado, Se guardo el cargo, favor de revisar.';
   			$this->query="INSERT INTO CARGO_FINANCIERO (FECHA_RECEP, MONTO, BANCO, CUENTA, SALDO, USUARIO, FECHA) VALUES ('$fecha', $monto, '$banco','$cuenta',$monto,'$usuario', current_timestamp )";
   			$rs=$this->EjecutaQuerySimple();
   		}
   		return $mensaje;
   	}

   	function asociaCF(){
   		$data = array();
   		$this->query="SELECT cf.*, (select max(nombre) from clie01 c where c.rfc = cf.rfc) as cliente 
   						from CARGO_FINANCIERO cf 
   						where cf.saldo > 0";
   		$rs=$this->QueryObtieneDatosN();

   		while($tsArray=ibase_fetch_object($rs)){
   			$data[]=$tsArray;
   		}

   		return @$data;
   	}

   	function traeCF($idcf){
   		$this->query="SELECT cf.*, (select max(nombre) from clie01 c where c.rfc = cf.rfc) as cliente , cp.folio_x_banco, cp.fecha_recep, cp.monto AS MONTO_PAGO, cp.SALDO AS SALDO_PAGO, 
   						(SELECT NOMBRE FROM MAESTROS M WHERE CAST(M.ID AS VARCHAR (20)) = cp.cliente) as maestro, cp.fecha_recep as fechaedo
   						FROM CARGO_FINANCIERO cf
   						LEFT JOIN CARGA_PAGOS cp on cp.id = cf.id_pago
   						where cf.ID = $idcf";
   		$rs=$this->QueryObtieneDatosN();
   		while($tsArray=ibase_fetch_object($rs)){
   			$data[]=$tsArray;
   		}
   		return @$data;
   	}

   	function traePagos($monto){
   		$this->query ="SELECT * FROM CARGA_PAGOS WHERE MONTO CONTAINING('$monto') and status <> 'C' and guardado > 0 and seleccionado > 0 and tipo_pago is null";
   		$rs=$this->EjecutaQuerySimple();
   		while($tsArray=ibase_fetch_object($rs)){
   			$data[]=$tsArray;
   		}
   		return @$data;
   	}

    function cargaCF($idcf, $idp, $monto){
    	$usuario=$_SESSION['user']->NOMBRE;
    	$rs=array();
    	$this->query="SELECT * FROM CARGO_FINANCIERO WHERE ID = $idcf";
    	$res=$this->EjecutaQuerySimple();
    	$row=ibase_fetch_object($res);
    	if($row->SALDO > 0){
    		$this->query="UPDATE CARGA_PAGOS SET CF= (iif(CF is null, '$idcf', CF||'-'||'$idcf')), saldo = saldo + $monto, monto_cf=monto_cf + $monto where id = $idp";
	    	$rs=$this->queryActualiza();

	    	$this->query="UPDATE CARGO_FINANCIERO SET SALDO = 0, ID_PAGO=$idp, USUARIO_ASIGNA='$usuario' , FECHA_ASIGNA = current_timestamp WHERE ID = $idcf";
	    	$rs=$this->queryActualiza();		
    	}
    	return $rs;
    }

    function verPagosConSaldo(){
    $this->query="SELECT * FROM CARGA_PAGOS WHERE SALDO > 0 and status <> 'C' and guardado > 0 and seleccionado > 0 and tipo_pago is null";
   	$rs=$this->QueryObtieneDatosN();
   	while($tsArray=ibase_fetch_object($rs)){
   		$data[]=$tsArray;
   	}
   	return @$data;
   }

   function enviaAcreedor($idp, $saldo, $rfc){
   	if($rfc=='XXX-AAA-XXX'){
   		$cliente = 'XXX-AAA-XXX';
   	}else{
   		$this->query="SELECT iif(MAX(CLAVE) is null, 0, max(clave)) AS CLAVE FROM CLIE01 WHERE upper(RFC) = upper('$rfc')";
   		$rs=$this->QueryObtieneDatosN();
   		$row= ibase_fetch_object($rs);
   		$cliente = $row->CLAVE;	
   	}
   
   	if($cliente != 0 or $cliente == 'XXX-AAA-XXX' ){
   		$usuario=$_SESSION['user']->USER_LOGIN;
   		$this->query="INSERT INTO ACREEDORES (ID_PAGO, MONTO, CLIENTE, FECHA, FECHA_TS, usuario_in, saldo, aplicado) VALUES ($idp, $saldo, '$cliente', current_date, current_timestamp, '$usuario',$saldo,  0)";
   		$rs=$this->EjecutaQuerySimple();
   		$this->query="SELECT MAX(ID) AS FOLIO FROM ACREEDORES";
   		$rs=$this->QueryObtieneDatosN();
   		$row=ibase_fetch_object($rs);
   		$folioA = $row->FOLIO;
   		$this->query="UPDATE CARGA_PAGOS SET FOLIO_ACREEDOR = $folioA, saldo = 0 where id = $idp";
   		$rs=$this->EjecutaQuerySimple();
   		return 0;
   	}else{

   		echo 'No se econtro el cliente';
   		return 1;
   	}


   }

   function traeClientes(){
   	$this->query="SELECT RFC, max(NOMBRE) AS NOMBRE FROM CLIE01 WHERE UPPER(STATUS) != UPPER('S') GROUP BY RFC ";
   	$rs=$this->QueryObtieneDatosN();
   	while($tsArray=ibase_fetch_object($rs)){
   		$data[]=$tsArray;
   	}
   	return $data;
   }

   function verAcreedores(){
   	$this->query="SELECT ac.*, (c.nombre ||' ( '|| c.clave||' )') as CL, cp.banco as BANCO, cp.fecha_recep, cp.id as Pago, cp.FOLIO_X_BANCO 
   				from Acreedores ac
   				left join clie01 c on c.clave = ac.cliente
   				left join carga_pagos cp on cp.id = ac.id_pago
   				where ac.contabilizado = 0";

   	$rs=$this->QueryObtieneDatosN();
   	while($tsArray=ibase_fetch_object($rs)){
   		$data[]=$tsArray;
   	}
   	return @$data;
   }


   function verAcreedorActivo($idp){
   	$idp = substr($idp, 2, 5);
   	//echo 'Este es el id del pago: '.$idp;
   	$this->query= "SELECT * FROM ACREEDORES WHERE ID = $idp";
   	$rs=$this->QueryObtieneDatosN();
   	$row = ibase_fetch_object($rs);

   	return $row;

   }

   function contabilizarAcreedor($ida){
   	$this->query="UPDATE ACREEDORES SET contabilizado = 1 where id= $ida";
   	$rs = $this->EjecutaQuerySimple();
   	return $rs;

   }

    function facturasxaplicar($idp){
    	if(substr($idp, 0,1)=='A'){
    		$idp = substr($idp, 2,5);
    		$this->query ="SELECT a.id 
    				from CARGA_PAGOS a
    				where a.folio_acreedor = $idp";
    		//echo $this->query;
    		$rs = $this->QueryObtieneDatosN();
    		$row=ibase_fetch_object($rs);
    		$idp = $row->ID;
    		}

    	$this->query ="SELECT a.*, cl.nombre as cliente, f.fechaelab, f.importe  
    				from APLICACIONES a
    				left join factf01 f on f.cve_doc = a.documento  
    				left join clie01 cl on f.cve_clpv = cl.clave
    				where idpago = $idp and a.cancelado = 0";
    	
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}

    	return @$data;
    }

   function cancelaAplicacion($idp, $docf, $idap, $montoap, $tipo){
   		$usuario=$_SESSION['user']->USER_LOGIN;

   		###### Meter Validacion Contable #############

   		$this->query="UPDATE APLICACIONES SET CANCELADO = 1 WHERE id=$idap";
   		$rs=$this->EjecutaQuerySimple();

   		if(substr($tipo, 0,1) == 'A'){
   		
   			$this->query="UPDATE ACREEDORES SET SALDO = SALDO + $montoap where id = substring('$tipo' from 3 for 10)";
   			$rs=$this->EjecutaQuerySimple();
   		}else{
   			$this->query="UPDATE CARGA_PAGOS SET SALDO = SALDO + $montoap where id = $idp";
   			$rs=$this->EjecutaQuerySimple();
   		}
   		
   		$this->query="UPDATE factf01 set saldofinal = saldofinal + $montoap, pagos = pagos - $montoap, aplicado = aplicado - $montoap where cve_doc = '$docf'";
   		$rs=$this->EjecutaQuerySimple();

   		$this->query="SELECT extract(month from fechaelab) as mes, extract(year from fechaelab) as anio, cve_maestro as maestro from factf01 where cve_doc = '$docf'";
   		$result=$this->QueryObtieneDatosN();
   		$row=ibase_fetch_object($result);
   		$mes =$row->MES;
   		$anio = $row->ANIO;
   		$maestro = $row->MAESTRO;
   		$campo='SALDO_'.$anio;

   		$this->query = "UPDATE MAESTROS SET $campo = $campo + $montoap where clave = '$maestro'";
   		$rs=$this->EjecutaQuerySimple();

   		if(substr($tipo,0,1) == 'A'){
   			$campo = 'Acreedor';
   			$this->query = "UPDATE MAESTROS SET $campo = $campo + $montoap where clave = '$maestro'";
   			$rs=$this->EjecutaQuerySimple();
   		}
   		return $rs;
   }

      function procesarPago($idp, $tipo){

   		$this->query="UPDATE CARGA_PAGOS SET TIPO_PAGO ='$tipo' where id = $idp";
   		$rs=$this->EjecutaQuerySimple();

   		return $rs;
   }

      function regEdoCta($idtrans, $monto, $tipo, $cargo,$anio, $nvaFechComp, $nf, $valor ){
   		$usuario=$_SESSION['user']->USER_LOGIN;
   		$nombre= $_SESSION['user']->NOMBRE;
   		echo $idtrans;
   		echo $tipo;

    	if($tipo == 'Venta'){
    		$this->query ="INSERT INTO REG_EDOCTA (TRANSACCION, MONTO, SIGNO, FECHAELAB, FECHA_TRANSACCION, FECHA_APLICACION, USUARIO)
    					VALUES ('$idtrans', $monto, 1, current_timestamp, current_date, current_date, '$nombre')";
    		$rs=$this->EjecutaQuerySimple();
    		
    		$this->query ="UPDATE CARGA_PAGOS SET REGISTRO = 1 WHERE ID = $idtrans";
    		$rs=$this->EjecutaQuerySimple();
    		return $rs;
    	}elseif(substr($idtrans, 0, 1) =='O'){
    		$this->query ="INSERT INTO REG_EDOCTA (TRANSACCION, MONTO, SIGNO, FECHAELAB, FECHA_TRANSACCION, FECHA_APLICACION, USUARIO)
    					VALUES ('$idtrans', $cargo, -1, current_timestamp, current_date, current_date, '$nombre')";
    		$rs=$this->EjecutaQuerySimple();	
    		if($nf == '1' and $valor == '1'){
    			$this->query="UPDATE COMPO01 SET edocta_fecha = '$nvaFechComp', fecha_edo_cta_ok = $valor WHERE CVE_DOC = '$idtrans'";
    			$rs=$this->EjecutaQuerySimple();
    			echo $this->query;
    			//break;
    			return $rs;    		 	
    		}elseif($nf == '1' and $valor == '0'){
    			$this->query="UPDATE COMPO01 SET fecha_edo_cta_ok = $valor WHERE CVE_DOC = '$idtrans'";
    			$rs=$this->EjecutaQuerySimple();
    			return $rs;
    		}else{
    			$this->query="UPDATE COMPO01 SET REGISTRO = 1 WHERE CVE_DOC = '$idtrans'";
    			$rs=$this->EjecutaQuerySimple();
    			return $rs;
    		}	
    	}elseif(substr($idtrans, 0 , 3)=='CD-'){
    		$this->query ="INSERT INTO REG_EDOCTA (TRANSACCION, MONTO, SIGNO, FECHAELAB, FECHA_TRANSACCION, FECHA_APLICACION, USUARIO)
    					VALUES ('$idtrans', $cargo, -1, current_timestamp, current_date, current_date, '$nombre')";
    		$rs=$this->EjecutaQuerySimple();

    		if($nf=='1' and $valor == '1'){
    			$this->query="UPDATE CR_DIRECTO SET fecha_edo_cta = '$nvaFechComp', fecha_edo_cta_ok = $valor WHERE id = substring('$idtrans' from 4 for 6) ";
	    		$rs=$this->EjecutaQuerySimple();

    		}elseif($nf == '1' and $valor == '0'){
    			$this->query="UPDATE CR_DIRECTO SET  fecha_edo_cta_ok = $valor WHERE id = substring('$idtrans' from 4 for 6) ";
	    		$rs=$this->EjecutaQuerySimple();
    		}else{
    			$this->query="UPDATE CR_DIRECTO SET REGISTRO = 1 WHERE id = substring('$idtrans' from 4 for 6) ";
    			$rs=$this->EjecutaQuerySimple();
    		}
    	}elseif (substr($idtrans,0,3)=='SOL'){
    		$this->query="INSERT INTO REG_EDOCTA (TRANSACCION, MONTO, SIGNO, FECHAELAB, FECHA_TRANSACCION, FECHA_APLICACION, USUARIO)
    					VALUES ('$idtrans', $cargo, -1, current_timestamp, current_date, current_date, '$nombre')";
    		$rs=$this->EjecutaQuerySimple();
    		if($nf=='1' and $valor == '1'){
    			$this->query="UPDATE SOLICITUD_PAGO SET fecha_edo_cta = '$nvaFechComp', fecha_edo_cta_ok = $valor WHERE id = substring('$idtrans' from 4 for 6) ";

    			$rs=$this->EjecutaQuerySimple();
    		
    		}elseif($nf == '1' and $valor == '0'){
    			$this->query="UPDATE SOLICITUD_PAGO SET  fecha_edo_cta_ok = $valor WHERE id = substring('$idtrans' from 4 for 6) ";
    			$rs=$this->EjecutaQuerySimple();
    		}else{
    			$this->query="UPDATE SOLICITUD_PAGO SET registro=1 WHERE id = substring('$idtrans' from 4 for 6) ";
    			$rs=$this->EjecutaQuerySimple();
    		}
    	}elseif (substr($idtrans,0,3)=='GTR'){
    		$this->query="INSERT INTO REG_EDOCTA (TRANSACCION, MONTO, SIGNO, FECHAELAB, FECHA_TRANSACCION, FECHA_APLICACION, USUARIO)
    					VALUES ('$idtrans', $cargo, -1, current_timestamp, current_date, current_date, '$nombre')";
    		$rs=$this->EjecutaQuerySimple();
    		if($nf=='1' and $valor == '1'){
    			$this->query="UPDATE GASTOS SET fecha_edo_cta = '$nvaFechComp', fecha_edo_cta_ok = $valor WHERE id = substring('$idtrans' from 4 for 6)";
    			$rs=$this->EjecutaQuerySimple();
    		
    		}elseif($nf=='1' and $valor =='0'){
    			$this->query="UPDATE GASTOS SET fecha_edo_cta_ok = $valor WHERE id = substring('$idtrans' from 4 for 6)";
    			$rs=$this->EjecutaQuerySimple();
    		}else{
    			$this->query="UPDATE GASTOS SET registro=1 WHERE id = substring('$idtrans' from 4 for 6)";
    			$rs=$this->EjecutaQuerySimple();
    		}
    	}elseif(substr($idtrans, 0,1) == 'D'){
    		$this->query="INSERT INTO REG_EDOCTA (TRANSACCION, MONTO, SIGNO, FECHAELAB, FECHA_TRANSACCION, FECHA_APLICACION, USUARIO)
    					VALUES ('$idtrans', $cargo, -1, current_timestamp, current_date, current_date, '$nombre')";
    		$rs=$this->EjecutaQuerySimple();
    		if($nf=='1' and $valor == '1'){
    			$this->query="UPDATE DEUDORES SET fechaedo_cta = '$nvaFechComp', fecha_edo_cta_ok = $valor WHERE iddeudor = substring('$idtrans' from 2 for 6) ";
    			$rs=$this->EjecutaQuerySimple();
    		}elseif($nf == '1' and $valor == '0'){
    			$this->query="UPDATE DEUDORES SET  fecha_edo_cta_ok = $valor WHERE iddeudor = substring('$idtrans' from 2 for 6) ";
    			$rs=$this->EjecutaQuerySimple();
    		}else{
    			$this->query="UPDATE DEUDORES SET registro=1 WHERE iddeudor = substring('$idtrans' from 2 for 6) ";
    			$rs=$this->EjecutaQuerySimple();
    		}
    	}

    	return $rs;
    }
  function NewSolicitudPago($cuentaBancaria, $medio, $importe, $misFolios){
    	$usuario=$_SESSION['user']->NOMBRE;
    	$folios=implode(",",$misFolios);
    	$this->query= "SELECT CVE_CLPV as CLAVE
    				   FROM COMPR01 
    					WHERE TRIM(CVE_DOC) IN (SELECT TRIM(IDENTIFICADOR) FROM OC_CREDITO_CONTRARECIBO WHERE FOLIO IN ($folios)) group by cve_clpv";
    	$rs=$this->QueryObtieneDatosN();

    	while($tsArray = ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}

    	$this->query="SELECT cve_prov as clave 
    							FROM OC_PAGOS_CREDITO_RECIBO ocp
    							where ocp.recepcion in (SELECT identificador FROM OC_CREDITO_CONTRARECIBO WHERE folio IN ($folios)) group by cve_prov";
    							//echo $this->query;
    			$result = $this->EjecutaQuerySimple();
    			while ($tsArray = ibase_fetch_object($result)){
    				$data[]=$tsArray;
    			}

    	$prov = count($data);
    		
    	echo 'Proveedores: '.$prov.'<p>';
    	//break;
    	if(count($data)>1){
    		$rs=2;
    		return $rs;
       	}else{
    	$cveclpv=$data[0]->CLAVE;
    	$this->query="INSERT INTO SOLICITUD_PAGO(MONTO, FECHA, USUARIO, TIPO, FECHAELAB, BANCO, PROVEEDOR)
    				  VALUES ($importe, current_date, '$usuario', '$medio', current_timestamp, '$cuentaBancaria', '$cveclpv')";
    	$rs=$this->EjecutaQuerySimple();

    	$this->query="SELECT MAX(IDSOL) as id FROM SOLICITUD_PAGO";
    	$rs=$this->QueryObtieneDatosN();
    	$row=ibase_fetch_object($rs);
    	$folio=$row->ID;
    	return $folio;	
    	}
    	
    }

    function asignaFolioDocumento($folio, $creaSP){

    	$this->query="SELECT IDENTIFICADOR as DOCU FROM OC_CREDITO_CONTRARECIBO WHERE folio = $folio";
    	$rs=$this->QueryObtieneDatosN();
    	$row=ibase_fetch_object($rs);
    	$docu=$row->DOCU;

    	$this->query="UPDATE compr01 set id_solicitud = $creaSP, STATUS_PAGO = 'PP' where trim(cve_doc) = trim('$docu')";
    	$rs=$this->EjecutaQuerySimple();


    	$this->query = "UPDATE FTC_DETALLE_RECEPCIONES set id_solicitud = $creaSP, STATUS_PAGO = 'PP'  WHERE trim(ID_RECEPCION) = trim($docu)";
    	$rs=$this->EjecutaQuerySimple();
    	//echo 'Folio: '.$folio.'<p>';
    	//echo 'CreaSP'.$creaSP.'<p>';
    	//echo 'asignaFolio Documento'.$this->query.'<p>';
    	//echo $this->query;
  		return $rs;

    }


    function FolioValidaRecepcion($docr, $doco){
    	$usuario = $_SESSION['user']->NOMBRE;
    	$this->query="SELECT IMPORTE FROM COMPO01 WHERE Trim(CVE_DOC) = trim('$doco')";
    	$rs=$this->QueryObtieneDatosN();
    	$row=ibase_fetch_object($rs);
    	$importeoc = $row->IMPORTE;

    	if(substr(trim($docr),0,1) == 'F'){
    			$importer = 0;
    		
    	}else{
    			$this->query="SELECT IMPORTE FROM COMPR01 WHERE TRIM(CVE_DOC) = TRIM('$docr')";
    			$rs=$this->QueryObtieneDatosN();
    			$row=ibase_fetch_object($rs);
    			$importer=$row->IMPORTE;
    	}
    	$this->query="INSERT INTO VALIDACIONES (OC, RECEPCION, IMPORTE_OC, IMPORTE_RECEP, FECHA_VALIDACION, USUARIO)
    					VALUES ('$doco', '$docr', $importeoc, $importer, current_timestamp, '$usuario')";
    	$rs=$this->EjecutaQuerySimple();
    	$this->query="SELECT MAX(IDVAL) AS FOLIO FROM VALIDACIONES";
    	$rs=$this->QueryObtieneDatosN();
    	$row=ibase_fetch_object($rs);
    	$folio=$row->FOLIO;

    	return $folio;
    }

    function verValidaciones($doco){
    	$this->query="SELECT v.*, p.nombre as proveedor, r.importe as importe_val,'NA' as RESULTADO
    				FROM VALIDACIONES v
    				left join compr01 r on r.cve_doc = v.recepcion 
    				left join prov01 p on p.clave = r.cve_clpv
    				WHERE IMPRESO = 0 and (upper(oc) = upper('$doco') or upper(oc) containing upper('$doco'))";
    				//echo $this->query;
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}

    	return @$data;
    }

    function datosValidacion($idval){
    	$this->query="SELECT v.*, p.nombre as Proveedor, 'NA' AS RESULTADO
    					FROM VALIDACIONES v
    					left join compo01 oc on oc.cve_doc = v.oc
    					left join prov01 p on oc.cve_clpv = p.clave 
    					WHERE IDVAL = $idval";
    		//			echo $this->query;
    	$rs=$this->QueryObtieneDatosN();


    	while ($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}

    	return @$data;
    }

    function ValidacionPartidad($idval){
    	$this->query="SELECT v.idval as FOLIO_VALIDACION, poc.*, oc.DOC_SIG,  i.descr, i.UNI_ALT
    					FROM PAR_COMPO01 poc
    					left join validaciones v on v.oc = poc.cve_doc
    					left join compo01 oc on oc.cve_doc = poc.cve_doc
    					LEFT JOIN PROV01 p ON p.clave = oc.cve_clpv
    					left join compr01 r on oc.doc_sig = r.cve_doc
    					left join inve01 i on poc.cve_art = i.cve_art
    					where v.idval = $idval";
    		//echo $this->query;
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	
    	return @$data;
    }

    function verSolicitudes(){
    	$this->query="SELECT s.*, p.nombre as NOM_PROV FROM 
    				SOLICITUD_PAGO s 
    				left join prov01 p on s.proveedor = p.clave
    				WHERE IMPRESO = 0 AND  FECHAELAB >= '01.07.2017'";
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return @$data;
    }

    function datosSolicitud($idsol){
    	$this->query="SELECT s.*, p.nombre as NOM_PROV FROM 
    				SOLICITUD_PAGO s 
    				left join prov01 p on s.proveedor = p.clave
    				WHERE IDSOL = $idsol ";
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	} 
    	return $data;
        }

    function crSolicitud($idsol){
    	$this->query="SELECT r.*, iif(r.monto_real = 0, r.importe, r.monto_real) as importe_REAL , p.NOMBRE AS NOM_PROV, o.cve_doc as CVE_DOC_OC, o.importe as IMPORTE_OC, o.fechaelab as FECHAELAB_OC 
    					FROM COMPR01 r 
    					left join prov01 p on r.cve_clpv = p.clave 
    					LEFT JOIN COMPO01 o on o.cve_doc = r.doc_ant
    				    WHERE id_solicitud = $idsol";
    	$rs=$this->QueryObtieneDatosN();

    	while($tsArray = ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}

    	$this->query="SELECT ocpr.*, recepcion as cve_doc, current_date as fechaelab, ocpr.monto_real as importe_real, ocpr.beneficiario as nom_prov, ocpr.id as cve_doc_oc, fecha_doc as fechaelab_oc,
    					(select importe from compo01 where cve_doc = ocpr.OC) as importe_oc
    					FROM OC_PAGOS_CREDITO_RECIBO ocpr WHERE id_solicitud = '$idsol' ";
    	$rs=$this->QueryObtieneDatosN();

    	while($tsArray = ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	
    	return $data;
    }

    function ctrlImpresiones($idsol){
    	$this->query ="UPDATE SOLICITUD_PAGO SET IMPRESO = IMPRESO + 1 WHERE IDSOL = $idsol";
    	$rs=$this->EjecutaQuerySimple();
    	$this->query = "SELECT IMPRESO FROM SOLICITUD_PAGO WHERE IDSOL = $idsol";
    	$res = $this->QueryObtieneDatosN();
    	$row = ibase_fetch_object($res);
    	$num_impresiones = $row->IMPRESO;
    	return $num_impresiones;
    }

    function Solicitudes($doc){
    	$this->query ="SELECT r.*, p.nombre, datediff(day, fechaelab, current_date) as DIAS, current_date as HOY
    					from COMPR01 r
    					left join prov01 p on r.cve_clpv = p.clave  
    					where id_solicitud = $doc";
    	$rs=$this->QueryObtieneDatosN();

    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return @$data;
    }

    function verSol($doc){
    	$this->query = "SELECT s.*, p.nombre 
    					from SOLICITUD_PAGO s 
    					left join prov01 p on p.clave = s.proveedor
    					where s.idsol = $doc";
    	$rs= $this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return @$data;
    }

    function verPagoSolicitudes(){
    	$data=array();
    	$this->query = "SELECT s.*, p.nombre as nom_prov 
    				FROM SOLICITUD_PAGO s
    				left join prov01 p on p.clave = s.proveedor
    				WHERE s.STATUS = 'Pagado'";
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return @$data;
    }

    function verCompras(){
    	$this->query="SELECT BENEFICIARIO, MONTO, DOCUMENTO, STATUS, FECHAELAB, BANCO, USUARIO_PAGO, CHEQUE AS FOLIO FROM p_cheques p where fecha >= '01.11.2016' and STATUS_CONTABILIDAD = 0";
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray = ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}

    	$this->query="SELECT BENEFICIARIO, MONTO, DOCUMENTO, STATUS, FECHAELAB, BANCO, USUARIO_PAGO, TRANS AS FOLIO FROM p_TRANS p where fecha >='01.11.2016' and STATUS_CONTABILIDAD = 0";
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray = ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}

    	$this->query="SELECT BENEFICIARIO, MONTO, DOCUMENTO, STATUS, FECHAELAB, BANCO, USUARIO_PAGO, EFECTIVO AS FOLIO FROM P_EFECTIVO p where fecha >='01.11.2016' and STATUS_CONTABILIDAD = 0";
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray = ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}

    	$this->query="SELECT p.nombre as BENEFICIARIO, s.MONTO_FINAL AS MONTO, ('SOL'||'-'||s.IDSOL) AS DOCUMENTO, s.STATUS, s.fecha_reg_pago_final AS FECHAELAB, s.BANCO_FINAL, s.USUARIO_PAGO, ('CR'||'-'||UPPER(s.TP_TES_FINAL)||'-'||s.FOLIO) AS FOLIO, s.banco_final as BANCO 
    				 FROM SOLICITUD_PAGO s
    				 left join prov01 p on p.clave = s.proveedor
    				 WHERE s.STATUS = 'Pagado'";
    	$rs = $this->QueryObtieneDatosN();
    	//echo $this->query;
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return @$data;
    }

    function recConta($folio){
    	$usuario = $_SESSION['user']->NOMBRE;
    	//echo $folio;
    	//break;

    	if(substr($folio, 0,2) == 'ch'){
    		$tabla = 'P_CHEQUES';
    		$campo = 'CHEQUE';
    	}elseif (substr($folio,0,2) == 'tr' ){
    		$tabla = 'P_TRANS';
    		$campo = 'TRANS';
    	}elseif (substr($folio, 0,1) == 'e'){
    		$tabla = 'P_EFECTIVO';
    		$campo = 'EFECTIVO';
      	}elseif (substr($folio, 0,3) == 'CR-'){
    		$tabla = 'SOLICITUD_PAGO';
    		$campo = 'IDSOL';
    		//$vttf = substr($folio,3,2);
    		//$vf = substr($folio,6,6);
    		$doc = explode('-', $folio);
    		$tipo = $doc[0];
    		$vttf = $doc[1];
    		$vf = $doc[2];
    	$this->query = "UPDATE $tabla set status = 'Recibido', fecha_rec_conta = current_timestamp, usuario_recibe = '$usuario' where upper(TP_TES_FINAL) = upper('$vttf') and folio = $vf";
    	$rs = $this->EjecutaQuerySimple();
    	echo $this->query;
    	return;
    	}

    	$this->query="SELECT DOCUMENTO, BANCO FROM $tabla where $campo = '$folio'";
		$res=$this->EjecutaQuerySimple();
		$row = ibase_fetch_object($res);
		$doc = $row->DOCUMENTO;
		$banco = $row->BANCO;

		echo 'Obtener el documento: '.$this->query.'<p>';
    	$this->query="UPDATE FTC_POC SET edocta_fecha = CURRENT_TIMESTAMP, USUARIO_CONTA = '$usuario', banco = '$banco', TP_TES = '$folio' where oc = upper('$doc')";
    	$rs = $this->EjecutaQuerySimple();
		echo 'Actualiza el documento: '.$this->query.'<p>';
    	$this->query="UPDATE $tabla SET STATUS_CONTABILIDAD = 1, fecha_rec_conta = current_timestamp, usuario_recibe = '$usuario' where $campo = '$folio'";
    	$rs= $this->EjecutaQuerySimple();
		echo 'Actualiza el pago: '.$this->query.'<p>';

    	//break;
    	return $rs;
    }

    function verComprasRecibidas(){
    	$this->query="SELECT BENEFICIARIO, MONTO, DOCUMENTO, STATUS, FECHA_REC_CONTA, BANCO, USUARIO_RECIBE, CHEQUE AS FOLIO FROM p_cheques p where fecha >= '01.01.2017' and STATUS_CONTABILIDAD = 1";
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray = ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}

    	$this->query="SELECT BENEFICIARIO, MONTO, DOCUMENTO, STATUS, FECHA_REC_CONTA, BANCO, USUARIO_RECIBE, TRANS AS FOLIO FROM p_TRANS p where fecha >='01.01.2017' and STATUS_CONTABILIDAD = 1";
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray = ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}

    	$this->query="SELECT BENEFICIARIO, MONTO, DOCUMENTO, STATUS, FECHA_REC_CONTA, BANCO, USUARIO_RECIBE, EFECTIVO AS FOLIO FROM P_EFECTIVO p where fecha >='01.01.2017' and STATUS_CONTABILIDAD = 1";
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray = ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}

    	$this->query="SELECT p.nombre as BENEFICIARIO, s.MONTO_FINAL AS MONTO, ('SOL'||'-'||s.IDSOL) AS DOCUMENTO, s.STATUS, s.FECHA_REC_CONTA, s.BANCO_FINAL, s.USUARIO_RECIBE, ('CR'||'-'||UPPER(s.TP_TES_FINAL)||'-'||s.FOLIO) AS FOLIO, s.BANCO 
    				 FROM SOLICITUD_PAGO s
    				 left join prov01 p on p.clave = s.proveedor
    				 WHERE s.STATUS = 'Recibido'";
    	$rs = $this->QueryObtieneDatosN();
    	//echo $this->query;
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return @$data;
    }

    function regCompraEdoCta($folio, $doc, $fecha){
    	$usuario =$_SESSION['user']->NOMBRE;

    	if(substr($doc,0,3)=='SOL'){
    		$this->query="UPDATE SOLICITUD_PAGO SET FECHA_EDO_CTA = '$fecha', usuario_edo_cta = '$usuario', status = 'Registrado'
    				where idsol = (substring('$doc' from 5 for 6))";
    		$rs= $this->EjecutaQuerySimple();
    		return $rs;
    	}elseif(substr($folio, 0,2) == 'ch'){
    		$tabla = 'P_CHEQUES';
    		$campo  = 'CHEQUE';
    	}elseif (substr($folio,0,2) == 'tr' ){
    		$tabla = 'P_TRANS';
    		$campo = 'TRANS';
    	}elseif (substr($folio, 0,1) == 'e'){
    		$tabla = 'P_EFECTIVO';
    		$campo = 'EFECTIVO';
    	}
    	$this->query = "UPDATE $tabla set FECHA_EDO_CTA = '$fecha', usuario_edo_cta = '$usuario', status_contabilidad = 2 where $campo = '$folio'";
    	$rs=$this->EjecutaQuerySimple();

    	
    	$this->query = "SELECT BANCO FROM $tabla where $campo = '$folio '";
    	$rs=$this->QueryObtieneDatosN();
    	$row = ibase_fetch_object($rs);
    	$banco = $row->BANCO;
    	if (empty($banco)){
    		$banco = 'Sin Banco';
    	}

    	$this->query = "UPDATE COMPO01 SET EDOCTA_FECHA= '$fecha', edocta_reg = current_timestamp, usuario_recibe='$usuario', fecha_edo_cta_ok = '1', banco = '$banco' 
    	where cve_doc ='$doc' ";
    	$rs=$this->EjecutaQuerySimple();

    	//echo $this->query;

    	return $rs;    	
    }

    function buscarPagos($campo){

    	$this->query="SELECT ID , 'NA' AS DOCUMENTO, BANCO, monto, saldo, FOLIO_X_BANCO, USUARIO, FOLIO_ACREEDOR, fecha_recep from CARGA_PAGOS WHERE (MONTO CONTAINING('$campo') OR upper(FOLIO_X_BANCO) CONTAINING (upper('$campo'))) AND STATUS = ''";
    	$rs=$this->QueryObtieneDatosN();

    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}

    	/*if(!empty($data)){
    		$this->query="SELECT cp.ID, DOCUMENTO, cp.BANCO, cp.FOLIO_X_BANCO, cp.folio_acreedor, cp.monto, cp.saldo , a.USUARIO 
    				FROM APLICACIONES a
    				left join CARGA_PAGOS cp on cp.id = a.idpago
    				WHERE UPPER(DOCUMENTO) = UPPER('$campo') AND CANCELADO = 0";
    		$rs=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[] = $tsArray;
    		}
    	}*/
    	return @$data; 
    }

    function cancelarPago($idp){
    	$this->query ="UPDATE CARGA_PAGOS SET STATUS = 'C' WHERE ID = $idp";
    	$rs = $this->EjecutaQuerySimple();
    	return $rs;
    	
    }

    function enviarConta($creaSP){

    	$this->query="UPDATE SOLICITUD_PAGO set MONTO_FINAL = MONTO, BANCO_FINAL = BANCO, fecha_reg_pago_final = FECHA, FECHA_PAGO = FECHAELAB, STATUS = 'Pagado', usuario_pago=(USUARIO||'- Directo'), TP_TES_FINAL =tipo WHERE IDSOL = $creaSP";
    	$rs = $this->EjecutaQuerySimple();

    	$this->query="SELECT TP_TES_FINAL AS TIPO FROM SOLICITUD_PAGO WHERE IDSOL = $creaSP";
    	$rs=$this->QueryObtieneDatosN();
    	$row=ibase_fetch_object($rs);
    	$tipop =$row->TIPO; 

    	$this->query="SELECT MAX(FOLIO) as FOLIO FROM SOLICITUD_PAGO WHERE TP_TES_FINAL ='$tipop'";
			$res=$this->QueryObtieneDatosN();
			$row = ibase_fetch_object($res);
			$folioNuevo = $row->FOLIO + 1;
			$this->query = "UPDATE SOLICITUD_PAGO SET FOLIO = $folioNuevo where idsol = $creaSP";
			$result = $this->EjecutaQuerySimple();

    	echo 'El pago se ha enviado a contabilidad, no se encontrara en la Area de Pagos...';
    	return $rs; 
    }

    function totalMensual($mes, $banco, $cuenta, $anio){
    	################  AJUSTE DE FECHAS ######################
    	$this->query="SELECT * FROM PG_BANCOS WHERE BANCO = '$banco' and num_cuenta='$cuenta'";
			$res=$this->EjecutaQuerySimple();
			$bn=ibase_fetch_object($res);
			$corte = $bn->DIA_CORTE;
			$fechaIni=$corte.'.'.$mes.'.'.$anio;
			if($corte == 1){
				$fechafin=($corte).'.'.($mes+1).'.'.$anio;
			}else{
				$fechafin=($corte-1).'.'.($mes+1).'.'.$anio;
			}
		###########################################################
    	$this->query="SELECT SUM(MONTO) AS MONTO FROM CARGA_PAGOS 
    				WHERE Banco = (trim('$banco')||' - '||trim('$cuenta')) and status <> 'C' 
    				and fecha_recep between '$fechaIni' and '$fechafin'
    		   		and extract(year from fecha_recep) = $anio ";
    	$rs=$this->QueryObtieneDatosN();
    	//echo $this->query;
    	$row=ibase_fetch_object($rs);
    	$data = $row->MONTO;
    	return @$data;
    }

    function ventasMensual($mes, $banco, $cuenta, $anio){
    	$this->query="SELECT iif(SUM(MONTO) is null, 0, sum(monto)) AS MONTO FROM CARGA_PAGOS WHERE EXTRACT(MONTH FROM FECHA_RECEP) = $mes and extract(year from fecha_recep) = $anio and Banco = (trim('$banco')||' - '||trim('$cuenta')) and status <> 'C' and tipo_pago is null and (seleccionado >= 1 or seleccionado = 2) and guardado = 1" ;
    	$rs=$this->QueryObtieneDatosN();
    	$row=ibase_fetch_object($rs);
    	$data=$row->MONTO;
    	return @$data; 
    }

    function transfer($mes, $banco, $cuenta, $anio){
    	$this->query="SELECT iif(SUM(MONTO) is null, 0, SUM(MONTO)) AS MONTO FROM CARGA_PAGOS WHERE extract(year from fecha_recep)=$anio and EXTRACT(MONTH FROM FECHA_RECEP) = $mes and Banco =(trim('$banco')||' - '||trim('$cuenta')) and status <> 'C' and tipo_pago = 'oTEC' and (seleccionado >= 1 or seleccionado = 2) and guardado = 1";
    	$rs=$this->QueryObtieneDatosN();
    	$row=ibase_fetch_object($rs);
    	$data=$row->MONTO;
    	return @$data;
    }

    function devCompra($mes, $banco, $cuenta, $anio){
    	$this->query="SELECT iif(SUM(MONTO) is null, 0, SUM(MONTO)) AS MONTO FROM CARGA_PAGOS 
    	WHERE extract(year from fecha_recep)=$anio and  EXTRACT(MONTH FROM FECHA_RECEP) = $mes and Banco =(trim('$banco')||' - '||trim('$cuenta')) and status <> 'C' and tipo_pago = 'DC' and (seleccionado >= 1 or seleccionado = 2) and guardado = 1 ";
    	$rs=$this->QueryObtieneDatosN();
    	$row=ibase_fetch_object($rs);
    	$data=$row->MONTO;
    	return @$data;
    }

    function devGasto($mes, $banco, $cuenta, $anio){
    	$this->query="SELECT iif(SUM(MONTO) is null, 0, SUM(MONTO)) AS MONTO FROM CARGA_PAGOS 
    	WHERE extract(year from fecha_recep)=$anio and EXTRACT(MONTH FROM FECHA_RECEP) = $mes and Banco =(trim('$banco')||' - '||trim('$cuenta')) and status <> 'C' and tipo_pago = 'DG' and (seleccionado >= 1 or seleccionado = 2) and guardado = 1 ";
    	$rs=$this->QueryObtieneDatosN();
    	$row=ibase_fetch_object($rs);
    	$data=$row->MONTO;
    	return @$data;
    }

    function pcc($mes, $banco, $cuenta, $anio){
    	$this->query = "SELECT iif(SUM(MONTO) is null, 0, SUM(MONTO)) AS MONTO FROM CARGA_PAGOS WHERE extract(year from fecha_recep) = $anio and  EXTRACT(MONTH FROM FECHA_RECEP) = $mes and Banco =(trim('$banco')||' - '||trim('$cuenta')) and status <> 'C' and (tipo_pago = 'oPCC' or tipo_pago = 'PP') and (seleccionado >= 1 or seleccionado = 2) and guardado = 1 ";
    	$rs=$this->QueryObtieneDatosN();
    	$row=ibase_fetch_object($rs);
    	$data=$row->MONTO;
    	return @$data;
    }

    function pagosAplicados($mes,$banco,$anio,$cuenta){

    	$this->query="SELECT sum(monto) as Total, sum(saldo) as Faltante 
    				from carga_pagos 
    				WHERE extract(month from fecha_recep) = $mes
    				and extract(year from fecha_recep) = $anio 
    				and banco  = '$banco'||' - '||'$cuenta'
    				and status <>'C'
    				and (tipo_pago is null or tipo_pago = '')
    				and seleccionado = 2
    				";
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return @$data;
    }

	function pagosAcreedores($mes,$banco,$anio,$cuenta){
    	$this->query="SELECT sum(a.monto) as ACREEDORES, sum(cp.saldo) as Faltante 
    				from acreedores a
    				left join carga_pagos cp on cp.id = a.id_pago
    				WHERE extract(month from cp.fecha_recep) = $mes
    				and extract(year from cp.fecha_recep) = $anio
    				and cp.banco  = '$banco'||' - '||'$cuenta'
    				and cp.status <>'C'
    				and (cp.tipo_pago is null or tipo_pago = '')
    				and a.status <> 99
    				and seleccionado = 2
    				";
    	//echo $this->query;
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return @$data;
    }

    function infoPagos($idp){
    	$this->query="SELECT * FROM CARGA_PAGOS WHERE ID = $idp";
    	$rs=$this->QueryObtieneDatosN();
    	while ($tsArray=ibase_fetch_object($rs)){
    			$data[]=$tsArray;
    	}
    	return $data;
    }

    function pagoFacturas($idp){
    	$data=array();
    	$this->query="SELECT a.*, coalesce(c.nombre, (select cl.nombre from clie01 cl where cl.clave_trim = fp.cve_clpv)) AS CLIENTE, 
    						coalesce(c.clave,fp.cve_clpv) as clave , coalesce(f.importe, fp.importe) as importe , f.uso_cfdi, f.METODODEPAGO, f.FORMADEPAGOSAT
    					FROM APLICACIONES a
    					left join factf01 f on a.documento = f.cve_doc
    					left join facturas_fp fp on a.documento = fp.cve_doc
    					left join clie01 c on c.clave = f.cve_clpv
    					WHERE IDPAGO = $idp 
    					and cancelado = 0
    					order by SALDO_PAGO DESC ";
    	$rs= $this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($rs)){
    			$data[]=$tsArray;
    	}
    	return $data;
    }

    function montoAplicado($idp){
    	$this->query="SELECT coalesce(SUM(MONTO_APLICADO), 0) as MONTO FROM APLICACIONES WHERE IDPAGO = $idp and cancelado = 0";
    	$rs=$this->QueryObtieneDatosN();
    	$row = ibase_fetch_object($rs);
    	$totalAplicado = $row->MONTO;
    	return $totalAplicado;
    }

    function totalCompras($mes, $banco, $anio, $cuenta){
    	$this->query = "SELECT iif(SUM(iif(monto_final = 0, importe, monto_final)) is null, 0, SUM(iif(monto_final = 0, importe, monto_final))) as totCompras from compo01 
    		where 
    		extract(month from edocta_fecha) = $mes 
    		and extract(year from edocta_fecha) = $anio
    		and banco = ('$banco'||' - ' ||'$cuenta')
    		and (seleccionado = 1 or seleccionado = 2) ";
    	$rs=$this->QueryObtieneDatosN();
    	$row=ibase_fetch_object($rs);
   		$totc=$row->TOTCOMPRAS;
   		$this->query = "SELECT sum(pago_tes) as totCompras from ftc_poc 
    		where 
    		extract(month from edocta_fecha) = $mes 
    		and extract(year from edocta_fecha) = $anio
    		and banco = ('$banco'||' - ' ||'$cuenta')
    		and (seleccionado = 1 or seleccionado = 2) ";
    	$rs=$this->QueryObtieneDatosN();
    	$row2=ibase_fetch_object($rs);
   		$totcn=$row2->TOTCOMPRAS;
   		$totc = $totc + $totcn;
   		return $totc;
    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
    function totalGasto($mes, $banco, $anio, $cuenta){
    	$this->query = "SELECT SUM(g.monto_pago) AS TOTGASTO 
    					FROM GASTOS g 
    					left join PAGO_GASTO pg on pg.idgasto = g.id and pg.cuenta_bancaria =('$banco'||' - '||'$cuenta')
    					where 
    					pg.CUENTA_BANCARIA = ('$banco'||' - '||'$cuenta') and iif(fecha_edo_cta is null,extract(month from g.FECHA_DOC), extract(month from fecha_edo_cta)) = $mes and iif(fecha_edo_cta is null, extract(year from g.FECHA_DOC), extract(year from fecha_edo_cta)) = $anio and g.status = 'V'  and (seleccionado = 1 or seleccionado = 2) and guardado = 1";
    	$rs=$this->QueryObtieneDatosN();
    	$row=ibase_fetch_object($rs);
    	$totg=$row->TOTGASTO;
    	$this->query="SELECT iif(SUM(IMPORTE) IS NULL, 0 , SUM(IMPORTE)) as GastoDirecto
    				  FROM CR_DIRECTO 
    				  WHERE extract(month from fecha_edo_cta) = $mes
    				  and extract(year from fecha_edo_cta) = $anio
    				  and banco = '$banco'
    				  and cuenta = '$cuenta' 
    				  and (seleccionado = 1 or seleccionado = 2) and guardado = 1";
		$rs= $this->QueryObtieneDatosN();
		//echo $this->query;
		$row=ibase_fetch_object($rs);
		$totgd = $row->GASTODIRECTO;
		$totg =$totg + $totgd; 
    	return $totg;
    }

    function totalDeudores($mes, $banco, $anio, $cuenta){
    	$this->query="SELECT iif(SUM(importe)is null, 0, Sum(importe)) as TOTALDEUDORES 
    			FROM DEUDORES 
    			WHERE extract(month from FECHAEDO_CTA)= $mes and extract(year from fechaedo_cta)= $anio 
    			and banco = ('$banco'||' - '||'$cuenta')
    			and (seleccionado = 1 or seleccionado = 2)  and guardado = 1";
    	$rs=$this->QueryObtieneDatosN();
    	$row = ibase_fetch_object($rs);
    	$totg= $row->TOTALDEUDORES;
    	return $totg;
    }

    function totalCredito($mes, $banco, $anio, $cuenta){
    	$this->query="SELECT iif(sum(monto_final) is null,0, sum(monto_final)) as totalcredito from SOLICITUD_PAGO 
    				where extract(month from fecha_edo_cta) = $mes 
    				and extract(year from fecha_edo_cta) = $anio
    				and banco_final = ('$banco'||' - '||'$cuenta')
    				and (seleccionado = 1 or seleccionado = 2) and guardado = 1";
    	$rs=$this->QueryObtieneDatosN();
    	$row = ibase_fetch_object($rs);
    	$totCr = $row->TOTALCREDITO;
    	return $totCr; 
    }

    function buscarContrarecibos($campo){
    	$this->query="SELECT cr.*, r.fechaelab, p.nombre , r.monto_real
    				FROM OC_CREDITO_CONTRARECIBO cr
    				left join compr01 r on r.cve_doc = cr.identificador 
    				left join prov01 p on r.cve_clpv = p.clave 
    				where trim(identificador) containing (trim($campo))";
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return @$data;
    }

    function obtenerFolio($identificador){
    	$this->query="SELECT folio AS FOLIO FROM OC_CREDITO_CONTRARECIBO WHERE IDENTIFICADOR ='$identificador'";
    	$rs=$this->QueryObtieneDatosN();
    	$row=ibase_fetch_object($rs);
    	$folio = $row->FOLIO;
    	return $folio;
    }

    function traeGasto(){
    	$this->query="SELECT ID AS IDG, CONCEPTO AS NOMBRE FROM CAT_GASTOS WHERE ACTIVO = 'S'";
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray = ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return $data;
    }

    function procesoAplicaciones(){
    	$this->query="SELECT ID AS IDA, IDPAGO AS IDP, documento as Documento, monto_aplicado as monto FROM APLICACIONES where cancelado = 0 and id >= 1 and id < 5000";
    	$rs=$this->QueryObtieneDatosN();

    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	//var_dump($data);
    	//break;
    	$i = 0;
    	foreach ($data as $key ){
    		$i = $i+1;
    		$ida=$key->IDA;
    		$idp=$key->IDP;
    		$documento=$key->DOCUMENTO;
    		$monto = $key->MONTO;
    		$this->query = "UPDATE FACTF01 set Aplicado = (Aplicado + $monto), saldoFinal = Importe - (Aplicado + $monto) where trim(cve_doc) = trim('$documento')";
    		$rs=$this->EjecutaQuerySimple();
    		//echo 'Actualiza Factura'.$this->query;
    		$this->query ="UPDATE APLICACIONES SET PROCESADO = 1 WHERE ID = $ida";
    		$rs=$this->EjecutaQuerySimple();
    		
    		//echo 'Actualiza Aplicaciones'.$this->query;
    		//echo $i;
    	}
    	echo 'Proceso Terminado, se procesaron : '.$i.' registros.';
    	//break;
    }

#################### TOTALES DE FACTURACION 


    // COLOCAR PAGOS // 
    function dirVerFacturas($mes, $vend, $anio){
    	if($anio == 99){
    		$this->query="SELECT f.CVE_DOC, f.CVE_CLPV, f.importe, f.fechaelab, f.can_tot, f.imp_tot4, f.saldo, f.doc_sig, f.cve_vend, d.importe, f.importe - d.importe as SALDONC, d.importe as importenc, d.fechaelab as fechaelabnc, c.nombre, f.aplicado , f.saldofinal, f.status, f.id_pagos, f.id_aplicaciones 
	    					FROM FACTF01 f 
	    					left join factd01 d on d.cve_doc = f.doc_sig and d.status <> 'C'
	    					left join clie01 c on f.cve_clpv = c.clave
	    					WHERE 
	    					deuda2015 = 1
	    					UNION 
	    					SELECT 'TOTAL' as CVE_DOC, '' as CVE_CLPV, sum(f.importe), '' as fechaelab, sum(f.can_tot), sum(f.imp_tot4), sum(f.saldo), '' as doc_sig, '' as cve_vend, sum(d.importe), sum(f.importe - d.importe) as SALDONC, sum(d.importe) as importenc, '' as fechaelabnc, '' as nombre, sum(f.aplicado) as aplicado, sum(saldofinal) as saldofinal, '' as  status, '' as id_pagos, '' as id_aplicaciones  
	    					FROM FACTF01 f 
	    					left join factd01 d on d.cve_doc = f.doc_sig and d.status <> 'C'
	    					left join clie01 c on f.cve_clpv = c.clave
	    					WHERE 
	    				    deuda2015 = 1";
	    					//echo $this->query;
	    	$rs = $this->QueryObtieneDatosN();
	    	while($tsArray=ibase_fetch_object($rs)){
	    		$data[]=$tsArray;
	    	}

	    	$this->query="SELECT f.CVE_DOC, f.CVE_CLPV, f.importe, f.fechaelab, f.can_tot, f.imp_tot4, f.saldo, f.doc_sig, f.cve_vend, d.importe, f.importe - d.importe as SALDONC, d.importe as importenc, d.fechaelab as fechaelabnc, c.nombre, f.aplicado , f.saldofinal, f.status, f.id_pagos, f.id_aplicaciones  
	    					FROM FACTF01 f 
	    					left join factd01 d on d.cve_doc = f.doc_sig and d.status <> 'C'
	    					left join clie01 c on f.cve_clpv = c.clave
	    					WHERE 
	    					f.serie = 'G'  and deuda2015 = 1
	    					UNION 
	    					SELECT 'TOTAL' as CVE_DOC, '' as CVE_CLPV, sum(f.importe), '' as fechaelab, sum(f.can_tot), sum(f.imp_tot4), sum(f.saldo), '' as doc_sig, '' as cve_vend, sum(d.importe), sum(f.importe - d.importe) as SALDONC, sum(d.importe) as importenc, '' as fechaelabnc, '' as nombre, sum(f.aplicado) as aplicado, sum(saldofinal) as saldofinal, '' as status, '' as id_pagos, '' as id_aplicaciones  
	    					FROM FACTF01 f 
	    					left join factd01 d on d.cve_doc = f.doc_sig and d.status <> 'C'
	    					left join clie01 c on f.cve_clpv = c.clave
	    					WHERE 
	    					f.serie = 'G'  and deuda2015 = 1";
	    					//echo $this->query;

	    	$rs = $this->QueryObtieneDatosN();
	    	while($tsArray=ibase_fetch_object($rs)){
	    		$data[]=$tsArray;
	    	}

	    	$this->query="SELECT f.CVE_DOC, f.CVE_CLPV, f.importe, f.fechaelab, f.can_tot, f.imp_tot4, f.saldo, f.doc_sig, f.cve_vend, d.importe, f.importe - d.importe as SALDONC, d.importe as importenc, d.fechaelab as fechaelabnc, c.nombre, f.aplicado , f.saldofinal, f.status, f.id_pagos, f.id_aplicaciones  
	    					FROM FACTF01 f 
	    					left join factd01 d on d.cve_doc = f.doc_sig and d.status <> 'C'
	    					left join clie01 c on f.cve_clpv = c.clave
	    					WHERE 
	    					f.serie = 'E'  and deuda2015 = 1
	    					UNION 
	    					SELECT 'TOTAL' as CVE_DOC, '' as CVE_CLPV, sum(f.importe), '' as fechaelab, sum(f.can_tot), sum(f.imp_tot4), sum(f.saldo), '' as doc_sig, '' as cve_vend, sum(d.importe), sum(f.importe - d.importe) as SALDONC, sum(d.importe) as importenc, '' as fechaelabnc, '' as nombre, sum(f.aplicado) as aplicado, sum(saldofinal) as saldofinal, '' as status, '' as id_pagos, '' as id_aplicaciones  
	    					FROM FACTF01 f 
	    					left join factd01 d on d.cve_doc = f.doc_sig and d.status <> 'C'
	    					left join clie01 c on f.cve_clpv = c.clave
	    					WHERE  
	    				    f.serie = 'E'  and deuda2015 = 1";
	    	$rs = $this->QueryObtieneDatosN();
 		   	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    		}
    	}else{
	    	$this->query="SELECT f.CVE_DOC, f.CVE_CLPV, f.importe, f.fechaelab, f.can_tot, f.imp_tot4, f.saldo, f.doc_sig, f.cve_vend, d.importe, f.importe - d.importe as SALDONC, d.importe as importenc, d.fechaelab as fechaelabnc, c.nombre, f.aplicado , f.saldofinal, f.id_pagos, f.id_aplicaciones, f.status
	    					FROM FACTF01 f 
	    					left join factd01 d on d.cve_doc = f.doc_sig and d.status <> 'C'
	    					left join clie01 c on f.cve_clpv = c.clave
	    					WHERE 
	    					extract(month from f.fechaelab)= $mes and extract(year from f.fechaelab) = $anio and f.serie = 'FAA'
	    					UNION 
	    					SELECT 'TOTAL' as CVE_DOC, '' as CVE_CLPV, sum(f.importe), '' as fechaelab, sum(f.can_tot), sum(f.imp_tot4), sum(f.saldo), '' as doc_sig, '' as cve_vend, sum(d.importe), sum(f.importe - d.importe) as SALDONC, sum(d.importe) as importenc, '' as fechaelabnc, '' as nombre, sum(f.aplicado) as aplicado, sum(saldofinal) as saldofinal , '' as id_pagos, '' as id_aplicaciones, '' as status
	    					FROM FACTF01 f 
	    					left join factd01 d on d.cve_doc = f.doc_sig and d.status <> 'C'
	    					left join clie01 c on f.cve_clpv = c.clave
	    					WHERE 
	    					extract(month from f.fechaelab)= $mes and extract(year from f.fechaelab) = $anio and f.serie = 'FAA'";
	    					//echo $this->query;
	    	$rs = $this->QueryObtieneDatosN();
	    	while($tsArray=ibase_fetch_object($rs)){
	    		$data[]=$tsArray;
	    	}

	    	$this->query="SELECT f.CVE_DOC, f.CVE_CLPV, f.importe, f.fechaelab, f.can_tot, f.imp_tot4, f.saldo, f.doc_sig, f.cve_vend, d.importe, f.importe - d.importe as SALDONC, d.importe as importenc, d.fechaelab as fechaelabnc, c.nombre, f.aplicado , f.saldofinal, id_pagos , f.id_aplicaciones, f.status 
	    					FROM FACTF01 f 
	    					left join factd01 d on d.cve_doc = f.doc_sig and d.status <> 'C'
	    					left join clie01 c on f.cve_clpv = c.clave
	    					WHERE
	    					extract(month from f.fechaelab)= $mes and extract(year from f.fechaelab) = $anio and  f.serie = 'G'
	    					UNION 
	    					SELECT 'TOTAL' as CVE_DOC, '' as CVE_CLPV, sum(f.importe), '' as fechaelab, sum(f.can_tot), sum(f.imp_tot4), sum(f.saldo), '' as doc_sig, '' as cve_vend, sum(d.importe), sum(f.importe - d.importe) as SALDONC, sum(d.importe) as importenc, '' as fechaelabnc, '' as nombre, sum(f.aplicado) as aplicado, sum(saldofinal) as saldofinal , '' as id_pagos, '' as id_aplicaciones, '' as status 
	    					FROM FACTF01 f 
	    					left join factd01 d on d.cve_doc = f.doc_sig and d.status <> 'C'
	    					left join clie01 c on f.cve_clpv = c.clave
	    					WHERE  
	    					extract(month from f.fechaelab)= $mes and extract(year from f.fechaelab) = $anio and f.serie = 'G'";
	    					//echo $this->query;

	    	$rs = $this->QueryObtieneDatosN();
	    	while($tsArray=ibase_fetch_object($rs)){
	    		$data[]=$tsArray;
	    	}

	    	$this->query="SELECT f.CVE_DOC, f.CVE_CLPV, f.importe, f.fechaelab, f.can_tot, f.imp_tot4, f.saldo, f.doc_sig, f.cve_vend, d.importe, f.importe - d.importe as SALDONC, d.importe as importenc, d.fechaelab as fechaelabnc, c.nombre, f.aplicado , f.saldofinal, id_pagos , id_aplicaciones, f.status 
	    					FROM FACTF01 f 
	    					left join factd01 d on d.cve_doc = f.doc_sig and d.status <> 'C'
	    					left join clie01 c on f.cve_clpv = c.clave
	    					WHERE 
	    					extract(month from f.fechaelab)= $mes and extract(year from f.fechaelab) = $anio and f.serie = 'E'
	    					UNION 
	    					SELECT 'TOTAL' as CVE_DOC, '' as CVE_CLPV, sum(f.importe), '' as fechaelab, sum(f.can_tot), sum(f.imp_tot4), sum(f.saldo), '' as doc_sig, '' as cve_vend, sum(d.importe), sum(f.importe - d.importe) as SALDONC, sum(d.importe) as importenc, '' as fechaelabnc, '' as nombre, sum(f.aplicado) as aplicado, sum(saldofinal) as saldofinal, '' as id_pagos, '' as id_aplicaciones, '' as status
	    					FROM FACTF01 f 
	    					left join factd01 d on d.cve_doc = f.doc_sig and d.status <> 'C'
	    					left join clie01 c on f.cve_clpv = c.clave
	    					WHERE 
	    					extract(month from f.fechaelab)= $mes and extract(year from f.fechaelab) = $anio and  f.serie = 'E'";
    	
    		$rs = $this->QueryObtieneDatosN();
    		while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    		}
				//echo $this->query;
	    }
	    	
    	
    	return $data;
    }

    function ventasMes($mes, $vend, $anio){

    	if($anio == 99){
    		//echo 'entro al 2015';
    		$this->query="SELECT SUM(IMPORTE) as TOTAL, sum(CAN_TOT) AS SUBTOTAL, SUM(IMP_TOT4) AS IVA 
    				  FROM FACTF01 
    				  WHERE deuda2015 = 1 and status <>'C'";
    	//echo $this->query;
    		$rs=$this->QueryObtieneDatosN();
    		while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	}else{
    		$this->query="SELECT SUM(IMPORTE) as TOTAL, sum(CAN_TOT) AS SUBTOTAL, SUM(IMP_TOT4) AS IVA 
    				  FROM FACTF01 
    				  WHERE extract(month from fechaelab) = $mes and extract(year from fechaelab) = $anio and status <>'C'";
    	//echo $this->query;
    		$rs=$this->QueryObtieneDatosN();
    		while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	//var_dump($data);	
    	}
    	return $data;
    }

    function saldoFacturas($mes, $vend, $anio){
    	if($anio == 99){
    			$this->query="SELECT SUM(SALDOFINAL) as total, (SUM(SALDOFINAL) / 1.16) as subtotal , (sum(SALDOFINAL)*.16) as iva 
    				  FROM FACTF01 
    				  WHERE deuda2015 =1 and status <>'C'";
    	//echo $this->query;
		    	$rs=$this->QueryObtieneDatosN();
		    	while($tsArray=ibase_fetch_object($rs)){
		    		$data[]=$tsArray;
		    	}
    	}else{
    			$this->query="SELECT SUM(SALDOFINAL) as total, (SUM(SALDOFINAL) / 1.16) as subtotal , (sum(SALDOFINAL)*.16) as iva 
    				  FROM FACTF01 
    				  WHERE extract(month from fechaelab) = $mes and extract(year from fechaelab) = $anio and status <>'C'";
    	//echo $this->query;
		    	$rs=$this->QueryObtieneDatosN();
		    	while($tsArray=ibase_fetch_object($rs)){
		    		$data[]=$tsArray;
		    	}	
    	}
    	return $data;
    }

    function NotasCreditoMes($mes, $vend, $anio){

    	if($anio == 99){
    		$this->query="SELECT iif(SUM(IMPORTE) is null or sum(IMPORTE) = 0,0,0) as total, iif(SUM(CAN_TOT) is null or SUM(CAN_TOT) =0, 0,0) AS SUBTOTAL, iif(SUM(IMP_TOT4) is null or sum(IMP_TOT4) = 0, 0,0) AS IVA
    				  FROM FACTD01 
    				  WHERE extract(year from fechaelab) = 2000 and status <>'C'";
    	//echo $this->query;
		    	$rs=$this->QueryObtieneDatosN();
		    	while($tsArray = ibase_fetch_object($rs)){
		    		$data[]=$tsArray;
		    	}	
    	}else{
    		$this->query="SELECT SUM(IMPORTE) as total, SUM(CAN_TOT) AS SUBTOTAL, SUM(IMP_TOT4) AS IVA
    				  FROM FACTD01 
    				  WHERE extract(month from fechaelab) = $mes and extract(year from fechaelab) = $anio and status <>'C'";
    	//echo $this->query;
		    	$rs=$this->QueryObtieneDatosN();
		    	while($tsArray = ibase_fetch_object($rs)){
		    		$data[]=$tsArray;
		    	}	
    	}
    	//var_dump($data);
    	return $data;
    }

    function NCaplicadas($mes, $vend, $anio){
    	if($anio ==99){
    				$this->query="SELECT sum(importe_nc) as Importe_NC 
    					FROM FACTF01 f 
    					WHERE
    				 	deuda2015 = 1 and f.status <>'C' and f.serie = 'FAA'";
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	}else{
    			$this->query="SELECT sum(importe_nc) as Importe_NC 
    					FROM FACTF01 f 
    					WHERE
    				 	extract(month from f.fechaelab)= $mes and extract(year from f.fechaelab) = $anio and f.status <>'C' and f.serie = 'FAA'";
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}	
    	}
    	
    	return $data;
    }


    function facturasPagadasMes($mes, $vend, $anio){

    	if ($anio ==99){
	    			$this->query="SELECT SUM(APLICADO) AS TOTAL, SUM(APLICADO) / 1.16 AS SUBTOTAL, SUM(APLICADO) *.16 AS IVA
    					FROM FACTF01 
    					WHERE  deuda2015 = 1 and status <>'C'";
       	//echo $this->query;
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}

    	}else{
    			$this->query="SELECT SUM(APLICADO) AS TOTAL, SUM(APLICADO) / 1.16 AS SUBTOTAL, SUM(APLICADO) *.16 AS IVA
    					FROM FACTF01 
    					WHERE  extract(month from fechaelab) = $mes and extract(year from fechaelab) = $anio and status <>'C'";
       	//echo $this->query;
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
		
    	}
    
    	return $data;
    }

    function ventaTotalMes($mes, $vend, $anio){

    	if($anio == 99 ){
    			$this->query="SELECT SUM(IMPORTE) as TOTAL, sum(CAN_TOT) AS SUBTOTAL, SUM(IMP_TOT4) AS IVA 
    				  FROM FACTF01 
    				  WHERE deuda2015 = 1 and status <>'C'";
    	$rs = $this->QueryObtieneDatosN();
    	$row = ibase_fetch_object($rs);
    	$ftotal = $row->TOTAL;
    	$fsubTotal= $row->SUBTOTAL;
    	$fiva = $row->IVA;

    	$ventaTotal= $ftotal;
    	}else{
    		$this->query="SELECT SUM(IMPORTE) as TOTAL, sum(CAN_TOT) AS SUBTOTAL, SUM(IMP_TOT4) AS IVA 
    				  FROM FACTF01 
    				  WHERE extract(month from fechaelab) = $mes and extract(year from fechaelab) = $anio and status <>'C'";
    	$rs = $this->QueryObtieneDatosN();
    	$row = ibase_fetch_object($rs);
    	$ftotal = $row->TOTAL;
    	$fsubTotal= $row->SUBTOTAL;
    	$fiva = $row->IVA;

    	$this->query="SELECT SUM(IMPORTE) as total, SUM(CAN_TOT) AS SUBTOTAL, SUM(IMP_TOT4) AS IVA
    				  FROM FACTD01 
    				  WHERE extract(month from fechaelab) = $mes and extract(year from fechaelab) = $anio and status <>'C'";
    	$rs=$this->QueryObtieneDatosN();
    	$row=ibase_fetch_object($rs);
    	$nctotal = $row->TOTAL;
    	$ncsubtotal = $row->SUBTOTAL;
    	$nciva=$row->IVA;

    	$ventaTotal= $ftotal - $nctotal;	
    	}
    	
    	//echo '---'.number_format($ftotal,2);
    	//echo '---'.number_format($nctotal,2);
    	//echo '---'.number_format($ventaTotal,2);
    	//break;
    	return $ventaTotal;
    }

    function serieFAA($mes, $vend, $anio){

    	if($anio == 99){
    		$this->query = "SELECT sum(CAN_TOT) AS SUBTOTAL, sum(IMP_TOT4) AS  iva , sum(IMPORTE) AS TOTAL FROM FACTF01 WHERE deuda2015 = 1 and status <>'C' and serie = 'A'";
	    	$rs=$this->QueryObtieneDatosN();
	    	while($tsArray= ibase_fetch_object($rs)){
	    		$data[]=$tsArray;
	    	}
    	}else{
	    	$this->query = "SELECT sum(CAN_TOT) AS SUBTOTAL, sum(IMP_TOT4) AS  iva , sum(IMPORTE) AS TOTAL FROM FACTF01 WHERE EXTRACT(MONTH FROM FECHAELAB) = $mes  and extract(year from fechaelab) = $anio and status <>'C' and serie = 'FAA'";
	    	$rs=$this->QueryObtieneDatosN();
	    	while($tsArray= ibase_fetch_object($rs)){
	    		$data[]=$tsArray;
	    	}	
    	}
    	
    	return @$data;
    }

	function serieG($mes, $vend, $anio){

		if($anio == 99){
				$this->query = "SELECT sum(CAN_TOT) AS SUBTOTAL, sum(IMP_TOT4) AS  iva , sum(IMPORTE) AS TOTAL FROM FACTF01 WHERE deuda2015=1 and status <>'C' and serie = 'G'";
	    	$rs=$this->QueryObtieneDatosN();
	    	while($tsArray= ibase_fetch_object($rs)){
	    		$data[]=$tsArray;
	    	}
		}else{
				$this->query = "SELECT sum(CAN_TOT) AS SUBTOTAL, sum(IMP_TOT4) AS  iva , sum(IMPORTE) AS TOTAL FROM FACTF01 WHERE EXTRACT(MONTH FROM FECHAELAB) = $mes  and extract(year from fechaelab) = $anio and status <>'C' and serie = 'G'";
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray= ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}	
		}
    	
    	return @$data;
    }

	function serieE($mes, $vend, $anio){

		if($anio == 99){
			$this->query = "SELECT sum(CAN_TOT) AS SUBTOTAL, sum(IMP_TOT4) AS  iva , sum(IMPORTE) AS TOTAL FROM FACTF01 WHERE deuda2015 = 1 and status <>'C' and serie = 'E'";
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray= ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
		}else{
			$this->query = "SELECT sum(CAN_TOT) AS SUBTOTAL, sum(IMP_TOT4) AS  iva , sum(IMPORTE) AS TOTAL FROM FACTF01 WHERE EXTRACT(MONTH FROM FECHAELAB) = $mes  and extract(year from fechaelab) = $anio and status <>'C' and serie = 'E'";
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray= ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}	
		}
    	
    	return @$data;
    }

    function traeVendedores(){
    	$this->query ="SELECT * FROM vend01";
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}

    	return $data;
    }

    function traeOC($campo){
    	$this->query ="SELECT oc.*, p.nombre 
    					FROM COMPO01 oc
    					left join prov01 p on oc.cve_clpv = p.clave
    					WHERE upper(oc.CVE_DOC) CONTAINING upper('$campo')";
    	//echo $this->query ;
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray = ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}

    	return $data;
    }

    function procesarOC($doco, $idb, $fechaedo, $montof, $factura, $tpf){

    	$usuario = $_SESSION['user']->NOMBRE;

    	$this->query="UPDATE COMPO01 SET 
    		BANCO = '$idb', 
    		edocta_fecha = '$fechaedo', 
    		edocta_reg = current_timestamp, 
    		usuario_recibe = '$usuario', 
    		edocta_status = 'I',
    		monto_final = $montof,
    		factura_proveedor = '$factura'
    		where CVE_DOC = '$doco'";

    		echo $this->query;
       	$rs = $this->EjecutaQuerySimple();
    	return $rs;  
    }

    function deudores(){
    	$this->query = "SELECT D.*, iif(P.NOMBRE is null, 'NO IDENTIFICDO', P.NOMBRE) AS NOMBRE 
    						FROM DEUDORES D
    						LEFT JOIN PROV01 P ON P.CLAVE = D.PROVEEDOR 
    						WHERE APLICADO = 0";
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return @$data;
    }

     function verProveedores(){
    	$data = array();
    	$this->query="SELECT p.*, b.banco as bancosat FROM PROV01 p left join bancos_sat b on b.clave = p.banco where STATUS = 'A'";
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return @$data;
    }


    function LayOutCargaProv(){
    	$data=array();
    	$this->query="SELECT * FROM PROV01 where STATUS = 'A'";
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	$i=0;
    	$e=0;
    	$b=0;
    	foreach ($data as $key) {
    		if(empty($key->BBVA_ALTA) or $key->BBVA_ALTA == 0){
	    		$cuenta=$key->CUENTA_BANCO;
	    		$banco = $key->BANCO;
	    		$clabe = $key->CLABE;
	    		$cuentaOK = 0;
	    		$cve_prov =$key->CLAVE;
	    		$correo = $key->PAG_WEB;
	    		if(empty($correo)){
	    			$correo='ferreterapegaso@hotmail.com';
	    		}
	    		if($banco == 12 and strlen($cuenta) == 10 ){
	    			$cuentaOK=$cuenta;
	    		}elseif($banco<>12 and strlen($clabe) > 10 ){
	    			$cuentaOK=$clabe;
	    		}

	    		if(strlen($cuentaOK) > 12){
	    			$i++;
	    			$nombre=str_pad(substr($key->NOMBRE,0,30),30," ");
	    			$ctabbva = str_pad($cuentaOK, 18, 0, STR_PAD_LEFT);
	    			$alias = str_pad(substr(trim($cve_prov).'_'.$nombre,0,30),30," ");
	    			$correo = str_pad(trim($correo),80," ");
	    			$file = fopen("app/LayoutBBVA/Alta/archivo_clabe.txt", "a");
					fwrite($file, substr($ctabbva,0,3).$ctabbva."MXP"."0000004999999.00".$nombre.$alias.'40'.$correo.PHP_EOL);
					fclose($file);
					$this->query="UPDATE PROV01 SET BBVA_ALTA = 1 WHERE CLAVE = $cve_prov";
					$this->EjecutaQuerySimple();
	    		}elseif(strlen($cuentaOK) == 10 ){
	    			$b++;
	    			$nombre=str_pad(substr($key->NOMBRE,0,30),30," ");
	    			$ctabbva = str_pad($cuentaOK, 18, 0, STR_PAD_LEFT);
	    			$alias = str_pad(substr(trim($cve_prov).'_'.$nombre,0,30),30," ");
	    			$correo = str_pad(trim($correo),80," ");
	    			$file = fopen("app/LayoutBBVA/Alta/archivo_bbva.txt", "a");
					fwrite($file, $ctabbva."MXP"."0000004999999.00".$nombre.$alias.$correo.PHP_EOL);
					fclose($file);
					$this->query="UPDATE PROV01 SET BBVA_ALTA = 1 WHERE CLAVE = $cve_prov";
					$this->EjecutaQuerySimple();
	    		}else{
	    			$e++;
					$this->query="UPDATE PROV01 SET BBVA_ALTA = 0 WHERE CLAVE = $cve_prov";
					$this->EjecutaQuerySimple();
	    		}
    		}
    	}

    	echo 'Se creo un nuevo Archivo para alta de proveedores, cuenta BBVA con '.$b.' proveedores y con Clabe Interbancaria '.$i.' proveedores, hay '.$e.' Proveedores con error en las cuentas.';
    	return $layout = array('BBVA'=>$b, 'Clabe'=>$i, 'Faltante'=>$e);
    }

    function guardaDeudor($fechaedo, $monto,$proveedor, $banco, $tpf, $referencia, $destino){

    	$usuario=$_SESSION['user']->NOMBRE;
    	$this->query="INSERT INTO DEUDORES (PROVEEDOR, FECHAEDO_CTA, FECHAELAB, IMPORTE, BANCO, TIPO, REFERENCIA, CUENTA_DESTINO, USUARIO)
    				VALUES ('$proveedor', '$fechaedo', current_timestamp, $monto, '$banco', '$tpf', '$referencia', '$destino','$usuario')";
    	$rs=$this->EjecutaQuerySimple();
    	return $rs;
    }

    function transferyprestamo($fechaedo, $bancoO){
    	$this->query = "SELECT * FROM DEUDORES WHERE tipo_deudor = 'Transferencia' or tipo_deudor = 'Prestamo'";
    	$rs=$this->QueryObtieneDatosN();
    	//echo $this->query;
    	while($tsArray = ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return @$data;
    }

    function guardaTransPago($fechaedo, $monto, $bancoO, $bancoD, $tpf, $TT, $referencia){
    	$usuario = $_SESSION['user']->NOMBRE;

    	$this->query="SELECT * FROM FTC_CTRL_BANCOS WHERE banco = '$bancoO' and ";
    	$this->query = "INSERT INTO DEUDORES (FECHAEDO_CTA, FECHAELAB, IMPORTE, BANCO, TIPO, REFERENCIA, CUENTA_DESTINO, USUARIO, TIPO_DEUDOR)
    					VALUES('$fechaedo', current_timestamp, $monto, '$bancoO', '$tpf', '$referencia', '$bancoD', '$usuario', '$TT')";
    	//echo $this->query;
    	$rs=$this->EjecutaQuerySimple();

    	$user = $_SESSION['user']->NOMBRE;


    	$this->query = "INSERT INTO CARGA_PAGOS (ID, CLIENTE, FECHA, MONTO, SALDO, USUARIO, BANCO, FECHA_APLI,FECHA_RECEP, FOLIO_X_BANCO, STATUS, CF, FOLIO_ACREEDOR, TIPO_PAGO, REGISTRO, poliza_ingreso, APLICACIONES)values(null, 'N/A', current_timestamp, $monto, 0, '$user', '$bancoD', current_timestamp, '$fechaedo', 'TR', '','',0, 'oTEC',0,'',0)";

    	//echo $this->query;
    	//break;

   		$rs= $this->EjecutaQuerySimple();


    	return $rs;
    }

    function facturapagomaestro($maestro){
    	$this->query="SELECT f.cve_doc, cl.nombre, f.fechaelab, f.importe, f.aplicado, f.saldofinal as saldo, f.id_pagos, f.id_aplicaciones, f.importe_nc, f.nc_aplicadas , f.FECHA_VENCIMIENTO, datediff(day, f.FECHA_VENCIMIENTO, current_date) as dias
    			from factf01 f 
    			left join clie01 cl on cl.clave = f.cve_clpv 
    			where f.cve_maestro = '$maestro' 
    			and (deuda2015 <> 99 or deuda2015 is null)
    			and saldofinal > 3
    			order by datediff(day, f.FECHA_VENCIMIENTO, current_date) desc";
    	//echo $this->query;
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return $data;
    }

    function factura($docf){
    	$this->query="SELECT f.*, cl.nombre, cl.rfc 
    				FROM FACTF01 f 
    				left join clie01 cl on f.cve_clpv = cl.clave 
    				WHERE CVE_DOC = '$docf'";
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return $data;
    }

    function traePagoMaestro($maestro){
    	$this->query="SELECT ID, FOLIO_X_BANCO, monto, saldo, fecha_recep, banco, usuario, fecha  FROM CARGA_PAGOS WHERE SALDO > 3 and Status <> 'C' and tipo_pago is null";
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return $data;
    }

    function traeMaestros(){
    	$this->query="SELECT * FROM MAESTROS where status = 'A' order by nombre";
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return $data;
    }


    function calendarioCxC($cartera){
    	 
    	 switch (date('w')){
                case '0':
                    $dia = 'D';
                    break;
                case '1':
                    $dia = 'L';
                    break;
                case '2':
                    $dia = 'MA';
                    break;
                case '3':
                    $dia = 'MI';
                    break;
                case '4':
                    $dia = 'J';
                    break;
                case '5':
                    $dia = 'V';
                    break;
                case '6':
                    $dia = 'S';
                    break;
                default:
                    break;                  
            }
    	$this->query="SELECT c.id, c.cc, f.cve_doc, f.saldofinal, f.fecha_vencimiento, c.contrarecibo, c.contrarecibo_cr, c.factura, f.fecha_vencimiento, cl.nombre as cliente, f.importe
		        from cajas c
		        left join factf01 f on f.cve_doc = c.factura
		        left join clie01 cl on cl.clave = f.cve_clpv
		        where cc= 'CCA'
		            and c.factura is not null
		            and factura != ''
		            and c.contrarecibo_cr is not null
		            and f.saldofinal > 5
		            and c.dias_pago containing('$dia')";
		$rs=$this->QueryObtieneDatosN();

    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}	
    	return $data;
    }

    function totalSemanaCalendar($cartera){
    	$this->query="SELECT sum(f.saldofinal) as totalsemana
                        from cajas c
                        left join factf01 f on f.cve_doc = c.factura  
                        where c.cc = '$cartera'
                        and f.saldofinal > 5
                        and f.fecha_vencimiento >= current_date
                        and (c.docs_cobranza = 'Si')";
        $rs=$this->QueryObtieneDatosN();
        $row=ibase_fetch_object($rs);
        $totsemana = $row->TOTALSEMANA;
        return $totsemana;
    }

    function totalesCanlendar($cartera){
    	$this->query="SELECT sum(f.saldofinal) as total
                        from cajas c
                        left join factf01 f on f.cve_doc = c.factura  
                        where c.cc = '$cartera'
                        and f.saldofinal > 5
                        and c.docs_cobranza = 'Si'";
        $rs=$this->QueryObtieneDatosN();
        $row=ibase_fetch_object($rs);
        $totcartera = $row->TOTAL;

        return $totcartera;
    }



    function obtieneMaestro($docf){
    	$this->query="SELECT CVE_MAESTRO FROM FACTF01 WHERE CVE_DOC = '$docf'";
    	$rs=$this->QueryObtieneDatosN();
    	$row=ibase_fetch_object($rs);
    	$maestro =$row->CVE_MAESTRO;

    	return $maestro;
    }

    function saldoVCD(){
    	$this->query="SELECT ca.CC,ca.dias_pago, iif(SUM(f.SALDOFINAL) is null, 0, sum(f.saldofinal)) as total
    				FROM CAJAS ca
    				LEFT JOIN FACTF01 f ON ca.factura = f.cve_doc
    				where f.fecha_vencimiento >= current_date
    				GROUP BY ca.CC, ca.dias_pago";
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return $data;
    }

    function saldoCD(){
    	$this->query="SELECT ca.CC,ca.dias_pago, iif(SUM(f.SALDOFINAL) is null, 0, sum(f.saldoFinal)) as total
    				FROM CAJAS ca
    				LEFT JOIN FACTF01 f ON ca.factura = f.cve_doc
    				where f.saldofinal > 5 and f.fecha_vencimiento is not null
    				GROUP BY ca.CC, ca.dias_pago";
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return $data;
    }

    function saldoVCDMultiple(){
    	$this->query="SELECT ca.cc, sum(saldofinal) as sm from cajas ca left join factf01 f on ca.factura = f.cve_doc 
    		where f.saldofinal > 5 and char_length(dias_pago) > 3 and f.fecha_vencimiento >= current_date group by ca.cc";
    	$rs=$this->QueryObtieneDatosN();

    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return @$data;
    }

    function saldoCDMultiple(){
    	$this->query="SELECT ca.cc, sum(saldofinal) as sm from cajas ca left join factf01 f on ca.factura = f.cve_doc 
    		where f.saldofinal > 5 and char_length(dias_pago) > 3 and f.fecha_vencimiento is not null group by ca.cc";
    	$rs=$this->QueryObtieneDatosN();

    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return @$data;	
    }

    function actStatusVencimiento(){
    	$this->query="SELECT CVE_DOC, datediff(DAY, FECHA_VENCIMIENTO, CURRENT_DATE) as dias_vencido FROM FACTF01 WHERE SALDOFINAL > 5 AND DATEDIFF(DAY, FECHA_VENCIMIENTO, CURRENT_DATE) >=1 AND ACT_DIA is null";
    	$rs=$this->QueryObtieneDatosN();

    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	if(isset($data)){
    		foreach ($data as $key) {
    		$docf = $key->CVE_DOC;
    		$dv = $key->DIAS_VENCIDO;
    		if($dv >= 1 and $dv <= 7){
    			$valor = 1;
    		}elseif ($dv >=8 and $dv <= 14){
    			$valor = 2;
    		}elseif ($dv >=15 and $dv <= 21){
    			$valor = 3;
    		}elseif ($dv >=22 and $dv <= 28){
    			$valor = 4;
    		}elseif ($dv >=29 and $dv <= 35){
    			$valor = 5;
    		}elseif ($dv >=36 and $dv <= 42){
    			$valor = 6;
    		}elseif ($dv >=43 and $dv <= 49){
    			$valor = 7;
    		}elseif ($dv >=50 and $dv <= 56){
    			$valor = 8;
    		}elseif ($dv >=57 and $dv <= 63){
    			$valor = 9;
    		}else{
    			$valor = 10;
    		}
    		$this->query="UPDATE factf01 set act_dia = 1, STATUS_VENCIMIENTO = $valor where cve_doc = '$docf'";
    		$rs=$this->EjecutaQuerySimple();
    		}	
    	}
    }

    function verMaestros($cartera){
    	$data=array();
    	$this->query="SELECT * FROM MAESTROS where status is null or status= 'A'";
    	$rs=$this->EjecutaQuerySimple();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return $data;
    }

    function editarMaestro($idm){
    	$this->query="SELECT * FROM MAESTROS WHERE ID = $idm";
    	$rs=$this->QueryObtieneDatosN();
    	$data[]=ibase_fetch_object($rs);
    	//var_dump($data);
    	return $data;
    }

    function editaCarterasMaestro($maestro, $revision, $cobranza){
    	$this->query = "UPDATE MAESTROS SET CARTERA='$cobranza', cartera_revision='$revision' where id  = $maestro";
    	$this->EjecutaQuerySimple();
    	return;
    }

    function traeCCC($idm){
    	$this->query="SELECT * FROM MAESTROS_CCC WHERE ID_MAESTRO = $idm";
    	$rs=$this->EjecutaQuerySimple();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return @$data;
    }

    function editaMaestro($idm, $cr, $cc){
    	if(count($cr)){
    		$cr = implode(",", $cr);	
    	}
    	if(count($cc)){
    		$cc = implode(",",$cc);	
    	}
    	$this->query="UPDATE MAESTROS SET CARTERA ='$cr', CARTERA_REVISION = '$cc' where id=$idm";
    	$rs=$this->EjecutaQuerySimple();
    	return $rs;
    }

    function altaMaestro($nombre){
    	/*if(count($cr)){
    		$cr = implode(",", $cr);	
    	}
    	if(count($cc)){
    		$cc = implode(",",$cc);	
    	}*/
    	$this->query ="SELECT max(CLAVE) as CLAVE FROM MAESTROS WHERE upper(SUBSTRING(CLAVE FROM 1 FOR 3)) = upper(SUBSTRING('$nombre' from 1 for 3))";
    	//echo $this->query;
    	$rs=$this->QueryObtieneDatosN();
    	$row= ibase_fetch_object($rs);

    	if(empty($row->CLAVE)){
    		$clave=substr($nombre, 0,3);
    		$clave= $clave.'1';
    	}else{	
    		$consecutivo=substr($row->CLAVE, 3,5);
    		$clave=substr($nombre, 0,3);
    		$consecutivo = $consecutivo + 1;
    		$clave = $clave.'-'.$consecutivo;
    	}

    	$this->query="INSERT INTO MAESTROS (clave,nombre,status) VALUES (UPPER('$clave'),'$nombre', 'A')";
    	$rs=$this->EjecutaQuerySimple();
    	return $rs;	
    } 


    function rastreadorFacturas($docf){
    	$data=array();
    	$this->query="SELECT f.cve_doc, cl.nombre, f.fechaelab, f.importe, f.saldofinal, f.status, iif(c.fecha_secuencia is null, 'Sin Fecha',c.fecha_secuencia) as fecha_secuencia, iif(c.fecha_rev is null, 'Sin Fecha', c.fecha_rev) as fecha_rev, iif(c.fecha_rec_cobranza is null, 'Sin Fecha', c.fecha_rec_cobranza) as fecha_rec_cobranza, c.id as caja
    				  from factf01 f
    				  left join cajas c on c.factura = f.cve_doc
    				  left join clie01 cl on cl.clave = f.cve_clpv
    				  where f.cve_doc = upper('$docf') ";
    	$rs=$this->EjecutaQuerySimple();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}

    	$this->query="SELECT f.cve_doc, cl.nombre, f.fechaelab, f.importe, f.saldofinal, f.status, iif(c.fecha_secuencia is null, 'Sin Fecha',c.fecha_secuencia) as fecha_secuencia, iif(c.fecha_rev is null, 'Sin Fecha', c.fecha_rev) as fecha_rev, iif(c.fecha_rec_cobranza is null, 'Sin Fecha', c.fecha_rec_cobranza) as fecha_rec_cobranza, c.id as caja
    				  from facTuras_fp f
    				  left join cajas c on c.factura = f.cve_doc
    				  left join clie01 cl on cl.clave_trim = f.cve_clpv
    				  where f.cve_doc =upper('$docf') ";
    	$rs=$this->EjecutaQuerySimple();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return $data;
    } 


    function verCierreCob(){
    	$this->query="SELECT a.documento, a.idpago, a.monto_aplicado, a.fecha, f.importe, round(f.saldofinal,2) as saldoFinal, f.fechaelab, cp.banco, cp.fecha_recep, cp.FOLIO_X_BANCO, cl.nombre, a.id 
    				 from aplicaciones a 
    				 left join factf01 f on f.cve_doc = a.documento
    				 left join clie01 cl on cl.clave = f.cve_clpv
    				 left join carga_pagos cp on cp.id = a.idpago 
    				 where a.folio_rec_conta = 0 and cierre_cc != 0";
    	$rs=$this->QueryObtieneDatosN();
    	//echo $this->query;
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}

    	return @$data;
    }

    function recDocCierreCob($idp, $fecha){
    	$usuario = $_SESSION['user']->NOMBRE;

    	/*$this->query="SELECT max(folio_rec_conta) as FOLIO from aplicaciones";
    	$result=$this->QueryObtieneDatosN();
    	$row=ibase_fetch_object($result);
    	$folio = $row->FOLIO + 1;
    	//echo $folio;

    	$this->query = "UPDATE APLICACIONES SET usuario_rec_conta = '$usuario', fecha_rec_conta = current_timestamp, folio_rec_conta = $folio, cierre_cc = 1 where id =$ida";
    	$rs=$this->EjecutaQuerySimple();
    	//echo $this->query;
    	*/

    	$this->query="UPDATE CARGA_PAGOS SET CIERRE_CONTA = 2, fecha_conta = current_timestamp, fecha_recep = '$fecha', usuario_conta = '$usuario', MONTO_ACREEDOR = saldo, saldo = 0 WHERE ID = $idp";
    	$rs=$this->EjecutaQuerySimple();
    	return $rs;
    }

    function saldoCartera(){
    	$this->query="SELECT min(c.factura), sum(f.saldofinal) as valor , min(f.cve_maestro), m.cartera_revision
		    from cajas c
		    left join factf01 f on f.cve_doc = c.factura
		    left join maestros m on m.clave = f.cve_maestro
		    where c.fecha_rev is null
		    and factura is not null
		    and factura != ''
		    and f.saldofinal > 2
		    group by m.cartera_revision";

    $rs=$this->QueryObtieneDatosN();

	    while($tsArray=ibase_fetch_object($rs)){
	    	$data[]=$tsArray;
	    }

    return @$data;
    
    }


    function revisaNegativos(){
    	$this->query="SELECT cve_doc as docf from factf01 where saldofinal < -1";
    	$rs=$this->QueryObtieneDatosN();

    	while($tsArray = ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}

    	foreach ($data as $key) {
    		$this->query="SELECT SUM(MONTO_APLICADO) as monto FROM APLICACIONES WHERE DOCUMENTO = '$key->DOCF' and cancelado = 0 ";
    		$rs=$this->QueryObtieneDatosN();
    		$row=ibase_fetch_object($rs);
    		$aplicado = $row->MONTO;

    		$this->query = "UPDATE FACTF01 SET APLICADO = $aplicado where cve_doc = '$key->DOCF'";
    		$rs=$this->EjecutaQuerySimple();

    	echo 'Se acutlizo el monto aplicado de la factura: ,'.$key->DOCF." ,con un importe de : ,".$aplicado.", ;";
    	}

    	return "ok";
    }
    
    function aplicaNC(){
    	$this->query="SELECT cve_doc AS docf, nc_aplicadas as docd from factf01 where saldofinal < -1 and importe_nc > 0";
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray = ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}

    	foreach ($data as $key){
    		$this->query="SELECT importe as monto from factd01 where cve_doc  = '$key->DOCD' and status <> 'C'";
    		$rs=$this->QueryObtieneDatosN();
    		$row=ibase_fetch_object($rs);
    		$ncaplicado = $row->MONTO;
    		//echo $ncaplicado;
    		//echo $this->query;
    		$this->query="UPDATE factf01 set importe_nc = $ncaplicado where cve_doc = '$key->DOCF'";
    		$rs=$this->EjecutaQuerySimple();
    		//echo $this->query;
    		echo "--- Se Actualizo el monto de la factuta: ".$key->DOCF." , El nuevo importe de la NC es de: , ".$ncaplicado.", ;";
    		//break;
    	}
    }

    function cancelarAplicacion(){
    	$this->query = "SELECT ID_APLICACIONES AS IDA, cve_doc as docf, nc_aplicadas as NC FROM FACTF01 WHERE SALDOFINAL < -1 AND IMPORTE_NC > 0 
    	and not id_aplicaciones containing (',')
    	and id_aplicaciones != ''";
    	$rs = $this->QueryObtieneDatosN();
    	while ($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    		# code...
    	}

    	foreach ($data as $key) {    		
    		$this->query="UPDATE aplicaciones set cancelado = 1, observaciones = 'Cancelado por NC: '||'$key->NC' where id = $key->IDA";
    		$r=$this->EjecutaQuerySimple();
    		if($rs){
    			/// Desaplicamos el pago de la factura
    			$this->query="UPDATE FACTF01 SET ID_APLICACIONES='', APLICADO = 0, saldofinal = importe - importe_nc WHERE CVE_DOC = '$key->DOCF'";
    			$res = $this->EjecutaQuerySimple();
    			if($res){
    				echo '-> Se cancelo la aplicacion: '.$key->IDA.' por la Nota de Credito : '.$key->NC.' de la factura: '.$key->DOCF; 
    			}else{
    				echo '<--> Problema al desaplicar la aplicacion: '.$key->IDA.' por la Nota de Credito : '.$key->NC.' de la factura: '.$key->DOCF;
    			}	

    		}
    	}
    }

  function liberarPedido($docd){
    	$this->query="SELECT TRIM(DOC_ANT) as doc_ant, PEDIDO_LIBERADO FROM FACTD01 WHERE CVE_DOC = '$docd' and liberada is null";
    	$rs=$this->QueryObtieneDatosN();
    	$val = ibase_fetch_object($rs);
    	$p = 'A';
    	//break;
    	if(!empty($val)){
    		//echo 'entro a cambiar la variable';
    		$p = $val->PEDIDO_LIBERADO;
    	}
	
		if(!empty($val) and substr($p,0,1) == 'P'){
    		return 'Ya liberado desde la facturacion';
    	}elseif(!empty($val) and substr($p, 0,1) == 0){
			$docant = $val->DOC_ANT;    		
    		$this->query="SELECT DOC_ANT as pedido, DOC_SIG as factura FROM FACTR01 WHERE CVE_DOC = '$val->PEDIDO_LIBERADO'";
    		$rs=$this->QueryObtieneDatosN();
    		$row=ibase_fetch_object($rs);
    		$docp = $row->PEDIDO;
    		$docf = $row->FACTURA;
    	}else{
    		//echo '<label> La Nota de Credito: '.$docd.', Ya fue liberada con Anterioridad o no Existe, favor de revisar la informacion.</label>';
    		return '<label style="color: red; font-weight: bold; font-size:30px;"> La Nota de Credito: '.$docd.', Ya fue liberada con Anterioridad o no Existe, favor de revisar la informacion.</label>';
    	}

    		if(substr($docant, 0, 3) == 'FAA'){
    			$this->query="SELECT trim(DOC_ANT) as pedido FROM FACTF01 WHERE CVE_DOC ='$docant'";
    			$rs=$this->QueryObtieneDatosN(); 
    			$row=ibase_fetch_object($rs);

    			if($row == true){
    				$docp = $row->PEDIDO;
    				
    				if(substr($docp, 0,1) =='P'){
	    				$this->query="UPDATE FACTP01 SET doc_sig = null, tip_doc_sig = null, tip_doc_e = null, enlazado = null, nc_aplicada = iif(nc_aplicada is null, '$docd', (nc_aplicada||'$docd')) where cve_doc = '$docp'";
	    				$rs=$this->EjecutaQuerySimple();	

	    				$this->query = "SELECT CANT, NUM_PAR, CVE_ART FROM PAR_FACTD01 WHERE CVE_DOC ='$docd'";
	    				$rs = $this->QueryObtieneDatosN();

	    				$this->query = "UPDATE PAR_FACTP01 SET PARTIDA_NC=NULL WHERE CVE_DOC = '$docp' ";
	    				$result = $this->EjecutaQuerySimple();

		    				while($tsArray=ibase_fetch_object($rs)){
		    					$data[]=$tsArray;
		    				}
		    				foreach ($data as $key) {
		    					$this->query="UPDATE par_factp01 set pxs = pxs + $key->CANT, partida_nc= $key->NUM_PAR where cve_doc = '$docp'
		                    		and cve_art = '$key->CVE_ART'
		                    		and partida_nc is null";
		                    	$rs=$this->EjecutaQuerySimple();
		    					}
		    				$this->query="UPDATE FACTD01 SET PEDIDO_LIBERADO = '$docp', LIBERADA = 'Si' where cve_doc = '$docd' ";
		    				$rs=$this->EjecutaQuerySimple();

    				}elseif(substr($docp, 0,1) == 0){  /// AQUI ENTRA SI ES UNA REMISION.

    					$this->query="SELECT DOC_ANT as pedido, DOC_SIG AS FACT FROM FACTR01 WHERE trim(CVE_DOC) ='$docp'";
    				    $rs=$this->QueryObtieneDatosN();
    				    $rowp=ibase_fetch_object($rs);
		    		//echo 'Esto es una remision'.'<p>';	 
    				//echo $this->query;
		    				if($rowp == true){
			    				$docpo = $rowp->PEDIDO;
			    				$docant = $rowp->FACT;
			    				//echo $docp;
			    				//break;
			    				$this->query="UPDATE FACTP01 SET doc_sig = null, tip_doc_sig = null, tip_doc_e = null, enlazado = null, nc_aplicada = iif(nc_aplicada is null, '$docd', (nc_aplicada||','||'$docd')) where cve_doc = '$docpo'";
			    				$rs=$this->EjecutaQuerySimple();	
			    				//echo $this->query;
			    				$this->query = "SELECT CANT, NUM_PAR, CVE_ART FROM PAR_FACTD01 WHERE CVE_DOC ='$docd'";
			    				$rs = $this->QueryObtieneDatosN();

			    				//echo $this->query;
				    				while($tsArray=ibase_fetch_object($rs)){
				    					$data[]=$tsArray;
				    					}

				    				foreach ($data as $key) {
				    					$this->query="UPDATE par_factp01 set pxs = pxs + $key->CANT, partida_nc= $key->NUM_PAR where cve_doc = '$docpo'
				                    		and cve_art = '$key->CVE_ART'";
				                    		//echo $this->query;
				                    	$rs=$this->EjecutaQuerySimple();
		    							}
		    				$this->query="UPDATE FACTD01 SET PEDIDO_LIBERADO = iif(pedido_liberado is null or pedido_liberado = '', '$docpo', (pedido_liberado ||', '||'$docpo')), LIBERADA = 'Si' where cve_doc = '$docd' ";
		    				$rs=$this->EjecutaQuerySimple();

		    				$this->query="UPDATE CAJAS SET OBSERVACIONES = iif(observaciones is null or observaciones = '', '$docant', observaciones||', '||'$docant'), factura = '', cve_fact = '$docpo', remision='$docp' where factura = '$docant' or (cve_fact = '$docpo' and trim(remision) = '$docp')";
		    				$rs =$this->EjecutaQuerySimple();

		    				//echo 'ACTUALIZA PARA EVITAR DOBLE DESBLOQUE:'.'<p>';
		    				//echo $this->query;

    						}
    				}
		    	}
		    }
		    return	'<label style="color: blue; font-weight: bold; font-size:30px;"> La Nota de Credito: '.$docd.', Ha liberado al pedido '.$docpo.' y la factura '.$docant.'</label>';
    	//return 'hecho --'.$docd.' --- '.$docp.' --- '.$docant;
    }


    function actualizaCanti($cantn, $idpreoc){
    	$this->query="UPDATE PREOC01 SET CANTI = $cantn, obs = '$idpreoc' where id = $idpreoc";
    	$rs=$this->EjecutaQuerySimple();
    	return $data=array('status'=>"ok");
    }

    function colocarUrgencia($docp){
    	$usuario = $_SESSION['user']->NOMBRE;
    	$this->query="UPDATE preoc01 SET urgente = 'U' where cotiza = '$docp'";
    	$rs=$this->EjecutaQuerySimple();

    	$this->query ="UPDATE FACTP01 SET URGENCIA = 'U' WHERE CVE_DOC = '$docp'";
    	$res= $this->EjecutaQuerySimple();
    	if($rs and $res){
    		$this->query="INSERT INTO LOG_PEDIDOS_URGENTES (USUARIO, FECHA, PEDIDO, PROCESADO) VALUES ('$usuario', current_timestamp, '$docp', 'ok')";
    		$result=$this->EjecutaQuerySimple();	
    	}
    	return 'Se coloco como urgencia el pedido: '.$docp.'.'; 
    }

    function reEnrutarCaja($docp, $docf){
    	$usuario = $_SESSION['user']->NOMBRE ;
    	$this->query=" UPDATE CAJAS SET aduana = null, ruta = 'N', status='cerrado', vueltas = vueltas + 1, logistica = iif(logistica is null, 'Utilerias',(logistica||'-'||'Utilerias'				)), unidad = null, fecha_secuencia = null, idu = null, DOCS = 'N', cierre_uni = null, cierre_tot = null, fletera = null, guia_fletera = null, status_log = 'nuevo', secuencia = null, fecha_aduana = current_timestamp, usuario_aduana ='$usuario', reenvio = 'Si', IMP_COMP_REENRUTAR = 'No' 
                        where
                        cve_fact = ('$docp')
                        AND FACTURA = ('$docf')";
        $rs=$this->EjecutaQuerySimple();

        $this->query = "SELECT VUELTAS FROM CAJAS WHERE CVE_FACT ='$docp' and factura='$docf'";
        $result=$this->QueryObtieneDatosN();
        $row=ibase_fetch_object($result);
        $vueltas = $row->VUELTAS;


        if($rs){
        	$this->query = "INSERT into LOG_REENRUTAR_FACTURAS (USUARIO, FECHA, PEDIDO, FACTURA, VUELTAS, PROCESADO) VALUES ('$usuario', current_timestamp, '$docp', '$docf', $vueltas, 'ok')";
        	$res = $this->EjecutaQuerySimple();
        } 

        if($rs and $res){
        	return 'Se ha re-enrutado el pedido '.$docp.' con el numero de factura '.$docf.', con un numero total de vueltas de '.$vueltas.' Favor de Verificar los datos con Logistica.';
        }else{
        	return 'No se ha podido re-enrutar el pedido '.$docp.' con el numero de factura '.$docf.', favor de revisar los datos y volver a intentar';	
        }   
        	
    }

    function datosPreoc($docp,$docf){
    	$cveart = $docf;

    	$this->query = "SELECT first 1 id, prod, nomprod, cotiza  FROM PREOC01 WHERE COTIZA = '$docp' and  prod = '$cveart'";
    	$rs=$this->QueryObtieneDatosN();

    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}

    	return $data;
    }
    function datosInv($docp, $docf){
    	$cveart = $docf;
    	$this->query="SELECT CAMPLIB7 FROM INVE_CLIB01 WHERE CVE_PROD = '$cveart'";
    	$rs = $this->QueryObtieneDatosN();
    	while ($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}

    	
    	return @$data;
    }


    function rfcCliente($idp, $ida, $docf){
    	$this->query="SELECT f.*, cl.nombre, cl.rfc, extract(month from fecha_doc) as mes, extract(year from fecha_doc) as anio FROM FACTF01 f left join clie01 cl on cl.clave = f.cve_clpv WHERE CVE_DOC = '$docf'";
    	$rs=$this->QueryObtieneDatosN();
    	$row=ibase_fetch_object($rs);  	
    	return $row;

    }

    function actSAEVenta($idp, $ida, $docf){

    	$this->query= "UPDATE APLICACIONES SET CONTABILIZADO = 'OK' WHERE ID = $ida";
    	$rs = $this->EjecutaQuerySimple();

    	$this->query="UPDATE FACTF01 set contabilizado = 'OK' where cve_doc = '$docf'";
    	$rs=$this->EjecutaQuerySimple();

    	$this->query="SELECT COUNT(id) as contabilizados FROM APLICACIONES where contabilizado = 'OK' and idpago =$idp and  cancelado = 0  and procesado = 1 ";
    	$rs=$this->QueryObtieneDatosN();
    	$row=ibase_fetch_object($rs);
    	$contabilizados = $row->CONTABILIZADOS;

    	$this->query="SELECT COUNT(id) as porContabilizar from aplicaciones where idpago = $idp and cancelado = 0 and procesado = 1 " ;
    	$rs=$this->QueryObtieneDatosN();
    	$row=ibase_fetch_object($rs);
    	$porContabilizar = $row->PORCONTABILIZAR;

    	/// Actualizamos carga pagos:
    	if($contabilizados == $porContabilizar){
    		$this->query="UPDATE CARGA_PAGOS SET CONTABILIZADO = 'Total' WHERE ID = $idp";
    		$rs=$this->EjecutaQuerySimple();

    	}elseif ($contabilizados > 0 ){
    		$this->query="UPDATE CARGA_PAGOS SET CONTABILIZADO = 'Parcial' where id = $idp";
    		$rs = $this->EjecutaQuerySimple(); 
    	}
    	//break;
    	return $rs;
    }


    function datosBancos($idp){
    	$this->query="SELECT * FROM CARGA_PAGOS WHERE ID = $idp";
    	$rs=$this->QueryObtieneDatosN();
    	$row=ibase_fetch_object($rs);

    	return $row;
    }

    function datosCuentas($datosBanco){
    	$dbanco = $datosBanco->BANCO;
    	$banco = explode(' - ', $dbanco);
    	
    	echo 'Este es el banco: '.$banco[0];
    	echo 'Esta es la cuenta: '.$banco[1];

    	$this->query="SELECT CTA_CONTAB FROM PG_BANCOS WHERE BANCO = '$banco[0]' and num_cuenta =$banco[1]";
    	$rs=$this->QueryObtieneDatosN();
    	$row=ibase_fetch_object($rs);

    	return $row;	
    }

    function datos_SAE_Polizas(){
    	$this->query="SELECT first 2500 ca.*, iif(p.rfc is null, 'rfcgenerico', p.rfc) as rfc,
            iif(p.nombre is null, 'ProveedorGenerico', p.nombre) as nombre ,
            iif(p.cta_cont is null, 'CUENTAPROVGENERICO', p.cta_cont) as cta_cont
                        FROM CARGO_ANUAL_17 ca 
                        left join prov01 p on p.clave = ca.proveedor 
                        WHERE CONTABILIZADO = 0 ";
    	$res=$this->QueryObtieneDatosN();

    	while($tsArray=ibase_fetch_object($res)){
    		$data[]=$tsArray;
    	}
    	return @$data;
    }

    function datos_SAE_Proveedores(){
    	$this->query="SELECT first 500 p.rfc, max(p.nombre) as nombre 
    					FROM CARGO_ANUAL_17 ca 
    					left join prov01 p on p.clave = ca.proveedor 
    					WHERE CONTABILIZADO = 0
    					group by p.rfc";
    	$res=$this->QueryObtieneDatosN();

    	while($tsArray=ibase_fetch_object($res)){
    		$data[]=$tsArray;
    	}
    	return $data;	
    }

    function actContabilidad($insertaPoliza){
    //echo 'Longitud del arreglo'.count($polizas);
    	if(count($insertaPoliza)>=1){
    		foreach ($insertaPoliza as $data){
    		$polEg = $data[2];
    		$polDr = $data[3];
    		$id = $data[1];
    		$this->query="UPDATE CARGO_ANUAL_17 SET CONTABILIZADO = 1, NUMERO_POLIZA='$polEg', NUMERO_POLIZA_DR = '$polDr' where id = $id";
    		$rs=$this->EjecutaQuerySimple();
    		}	
    	}
    	//var_dump($insertaPoliza);
    	echo 'polizas insertadas: '.count($insertaPoliza);
    	//break;
    	return;
    }


    function datos_SAE_Polizas_Dr_Venta(){
    	$data=array();
    	$this->query="SELECT first 500 A.*, C.NOMBRE, C.CLAVE, iif(EXTRACT(MONTH FROM CP.FECHA_RECEP) is null, 1,EXTRACT(MONTH FROM CP.FECHA_RECEP)) AS MES,
				        iif(EXTRACT(YEAR FROM CP.FECHA_RECEP) is null, 2015, EXTRACT(YEAR FROM CP.FECHA_RECEP))  AS ANIO,
				        F.FECHAELAB,
				        F.CVE_CLPV, F.IMPORTE, A.monto_aplicado,
				        F.IMP_TOT4,
				        F.fecha_doc
                      FROM APLICACIONES A
                      LEFT JOIN FACTF01 F ON F.CVE_DOC = A.DOCUMENTO
                      LEFT JOIN CLIE01 C ON F.CVE_CLPV = C.CLAVE
                      left join carga_pagos CP on A.idpago = CP.ID
                      WHERE A.CONTABILIZADO IS NULL
                      AND A.CANCELADO = 0
                      AND A.PROCESADO = 1";
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return $data;
    }

    function actCont_Aplicaciones($insertaPoliza){
    	foreach ($insertaPoliza as $data){
    		$poliza = 'Dr'.$data[1];
    		$id = $data[0];
    		$this->query = "UPDATE APLICACIONES SET CONTABILIZADO = 'OK', POLIZA_DIARIO ='$poliza' where id = $id ";
    		$rs=$this->EjecutaQuerySimple();
    		//echo $this->query;
    	}
    	return;
    }

    function datos_SAE_Polizas_Ig_Venta(){
    	$data=array();
    	$this->query="SELECT cp.*,b.CTA_CONTAB, extract(month from fecha_recep) as mes, extract(year from fecha_recep) as anio 
    	from carga_pagos cp 
    	left join pg_bancos b on b.banco containing (trim(substring(cp.banco from 1 for 8)))
    	where contabilizado is null and status <> 'C' and tipo_pago is null AND EXTRACT(YEAR FROM FECHA_RECEP) = 2018 and extract(month from fecha_recep) = 8";
    	$rs=$this->EjecutaQuerySimple();

    	while($tsArray=ibase_fetch_object($rs)){
    			$data[]=$tsArray;
    	}
    	return $data;
    }

   	function sae_partidas_CargaPagos($pagos){
 		$data=array();
   		foreach ($pagos as $key) {
   			$this->query="SELECT * from aplicaciones where cancelado = 0 and contabilizado is null and idpago = $key->ID";
		   	$rs=$this->QueryObtieneDatosN();
		   		while($tsArray = ibase_fetch_object($rs)){
		   			$data[]=$tsArray;
		   		}
   		}
   		return $data;
   	}

   	function act_Contabilidad_Carga_Pagos_Aplicaciones($insertaPoliza){	
   		foreach($insertaPoliza as $data){
   			$idp = $data[0];
   			$ida = $data[1];
   			$poliza = $data[2];
   			if($idp != 0){
   				$this->query="UPDATE carga_pagos set contabilizado = '1', poliza_ingreso='$poliza' where id = $idp";
   				$rs=$this->EjecutaQuerySimple();
   			}else{
   				$this->query="UPDATE aplicaciones set poliza_ingreso = '$poliza', contabilizado='1' where id = $ida";
   				$rs=$this->EjecutaQuerySimple();
   			}
   		}
   		return;
	}


	function contabiliza_ventas(){
		$this->query="SELECT CVE_DOC, IMPORTE, CVE_PEDI, fechaelab, IMP_TOT4, DES_TOT,replace(trim(f.RFC), ' ','') as rfc , DOC_ANT , cl.nombre, extract(month from fecha_doc) as mes, f.cve_clpv, extract(year from fecha_doc) as anio, iif(cta_cont = '', 0,cta_cont) as cta_cont, fecha_doc
                    FROM FACTF01  f
                    left join clie01 cl on f.cve_clpv = cl.clave
                    WHERE f.STATUS <> 'C' AND EXTRACT(YEAR FROM FECHA_DOC) = 2018 AND 
                    EXTRACT(MONTH FROM FECHA_DOC) = 9	AND 
                    f.CONTABILIZADO IS NULL order by fecha_doc";
		$rs=$this->QueryObtieneDatosN();
		while($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}

		$this->query="SELECT CVE_DOC, IMPORTE, CVE_PEDI, f.fechaelab, IMP_TOT4, DES_TOT,replace(trim(f.RFC), ' ','') as rfc , DOC_ANT , cl.nombre, extract(month from f.fechaelab) as mes, f.cve_clpv, extract(year from f.fechaelab) as anio, iif(cta_cont = '', 0,cta_cont) as cta_cont, f.fechaelab
                    FROM FACTURAS_FP  f
                    left join clie01 cl on f.cve_clpv = cl.clave_trim
                    WHERE f.STATUS <> 8 AND EXTRACT(YEAR FROM f.fechaelab) = 2018 AND 
                    EXTRACT(MONTH FROM f.fechaelab) = 9	AND 
                    f.CONTABILIZADO IS NULL order by f.fechaelab";
		$rs=$this->QueryObtieneDatosN();

		while($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}


		return $data;
	}
	function act_ventas($insertaPoliza){
		foreach ($insertaPoliza as $key){
			$poliza = 'Dr'.$key[0];
			$docf = $key[1];

			$this->query="UPDATE FACTF01 SET CONTABILIZADO = '1', POLIZA = '$poliza' WHERE cve_doc = '$docf'";
			$rs=$this->EjecutaQuerySimple();
		    $this->query="UPDATE FTC_FACTURAS SET CONTABILIZADO = '1', POLIZA = '$poliza' WHERE DOCUMENTO = '$docf'";
			$rs=$this->EjecutaQuerySimple();
		}
		return;
	}


	function contabiliza_NC(){
		$this->query="SELECT first 5000 CVE_DOC, IMPORTE, CVE_PEDI, fechaelab, IMP_TOT4, DES_TOT, f.RFC, DOC_ANT , cl.nombre, extract(month from fecha_doc) as mes, f.cve_clpv, extract(year from fecha_doc) as anio, iif(cta_cont = '', 0,cta_cont) as cta_cont, fecha_doc
                    FROM FACTD01 f
                    left join clie01 cl on f.cve_clpv = cl.clave
                    WHERE f.STATUS <> 'C' AND EXTRACT(YEAR FROM FECHA_DOC) = 2018 AND EXTRACT(MONTH FROM FECHA_DOC) = 9 AND f.CONTABILIZADO IS NULL";
		$rs=$this->QueryObtieneDatosN();

		while($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}

		$this->query="SELECT first 5000 CVE_DOC, IMPORTE, CVE_PEDI, fechaelab, IMP_TOT4, DES_TOT, f.RFC, DOC_ANT , cl.nombre, extract(month from fecha_doc) as mes, f.cve_clpv, extract(year from fecha_doc) as anio, iif(cta_cont = '', 0,cta_cont) as cta_cont, fecha_doc
                    FROM NOTAS_FP f
                    left join clie01 cl on f.cve_clpv = cl.clave
                    WHERE f.STATUS <> 8 AND EXTRACT(YEAR FROM FECHA_DOC) = 2018 AND EXTRACT(MONTH FROM FECHA_DOC) = 9 AND f.CONTABILIZADO IS NULL";
		$rs=$this->QueryObtieneDatosN();

		while($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}

		return $data;	
	}

	function act_NC($insertaPoliza){
		foreach ($insertaPoliza as $key){
			$poliza = 'Dr'.$key[0];
			$docf = $key[1];
			$this->query="UPDATE FACTD01 SET CONTABILIZADO = '1', POLIZA = '$poliza' WHERE cve_doc = '$docf'";
			$rs=$this->EjecutaQuerySimple();
		}
		return;
	}

	function crea_cuenta_clientes(){
		$this->query="SELECT rfc, max(nombre) as nombre, 0 as cta_cont from clie01 where (cta_cont = '' or cta_cont is null or cta_cont = '00100000000003') and rfc is not null group by RFC";
		$rs=$this->QueryObtieneDatosN();

		while($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}
	    return $data;	
	}

	function act_cuenta($crea_cuenta){
		foreach ($crea_cuenta as $key){
			$rfc = $key[0];
			$cuenta = $key[1];
			$this->query = "UPDATE CLIE01 SET CTA_CONT = '$cuenta' where RFC = '$rfc'";
			$rs=$this->EjecutaQuerySimple();
			echo 'Se actualizo el RFC: '.$rfc.' Con la cuenta: '.$cuenta.'.<p>';
		}
		return;
	}

	function crea_cuentas_proveedores(){
		$this->query="SELECT RFC, max(nombre) as nombre, '0' as cta_cont FROM PROV01 WHERE (RFC IS NOT NULL OR RFC <> '') AND (CTA_CONT = '' or cta_cont = '0') GROUP BY RFC ";
		$rs=$this->QueryObtieneDatosN();

		while($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}
		return $data;
	}

	function act_cuenta_proveedor($crea_cuenta){
		foreach ($crea_cuenta as $key){
			$rfc = $key[0];
			$cuenta = $key[1];
			$this->query = "UPDATE PROV01 SET CTA_CONT = '$cuenta' where RFC = '$rfc'";
			$rs=$this->EjecutaQuerySimple();
			echo 'Se actualizo el RFC: '.$rfc.' Con la cuenta: '.$cuenta.'.<p>';
		}

		return;
	}

	function vencSemanal(){
		$this->query="SELECT F.CVE_MAESTRO, SUM(F.SALDOFINAL) AS SALDO, MAX(M.NOMBRE) as NOMBRE_MAESTRO, MAX(M.CARTERA) AS CARTERA
		 FROM FACTF01 F
		 LEFT JOIN MAESTROS M ON M.CLAVE = F.CVE_MAESTRO 
		 WHERE STATUS_VENCIMIENTO = 1 GROUP BY CVE_MAESTRO";
		$rs=$this->QueryObtieneDatosN();

		while($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}
		return @$data;
	}

	function vencRestriccion(){
		$this->query="SELECT F.CVE_MAESTRO, SUM(F.SALDOFINAL) AS SALDO, MAX(M.NOMBRE) as NOMBRE_MAESTRO, MAX(M.CARTERA) AS CARTERA
		 FROM FACTF01 F
		 LEFT JOIN MAESTROS M ON M.CLAVE = F.CVE_MAESTRO 
		 WHERE STATUS_VENCIMIENTO >= 2 and status_vencimiento <= 3 
		 GROUP BY CVE_MAESTRO";
		$rs=$this->QueryObtieneDatosN();

		while($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}
		return @$data;	
	}

	function vencExtrajudicial(){
		$this->query="SELECT F.CVE_MAESTRO, SUM(F.SALDOFINAL) AS SALDO, MAX(M.NOMBRE) as NOMBRE_MAESTRO, MAX(M.CARTERA) AS CARTERA
		 FROM FACTF01 F
		 LEFT JOIN MAESTROS M ON M.CLAVE = F.CVE_MAESTRO 
		 WHERE STATUS_VENCIMIENTO >= 4 and status_vencimiento <= 8 
		 GROUP BY CVE_MAESTRO";
		$rs=$this->QueryObtieneDatosN();

		while($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}
		return @$data;	
	}	

	function vencJudicial(){
		$this->query="SELECT F.CVE_MAESTRO, SUM(F.SALDOFINAL) AS SALDO, MAX(M.NOMBRE) as NOMBRE_MAESTRO, MAX(M.CARTERA) AS CARTERA
		 FROM FACTF01 F
		 LEFT JOIN MAESTROS M ON M.CLAVE = F.CVE_MAESTRO 
		 WHERE STATUS_VENCIMIENTO >= 9
		 GROUP BY CVE_MAESTRO";
		$rs=$this->QueryObtieneDatosN();

		while($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}
		return @$data;	
	}	

	function verInd($maestro, $status){

		if($status == 4){
			$this->query="SELECT f.CVE_CLPV, sum(f.saldofinal) as saldo, max(cl.nombre) as nombre, max(ct.cartera_cobranza) as cartera  
					  FROM FACTF01 f
					  left join cartera ct on trim(ct.idcliente) = trim(f.cve_clpv) 
					  left join clie01 cl on cl.clave = f.cve_clpv
					  WHERE f.CVE_MAESTRO = '$maestro' and f.status_vencimiento >= 4 and status_vencimiento <= 8 
					  group by f.CVE_CLPV";
			
		}elseif ($status == 5) {
			$this->query="SELECT f.CVE_CLPV, sum(f.saldofinal) as saldo, max(cl.nombre) as nombre, max(ct.cartera_cobranza) as cartera  
					  FROM FACTF01 f
					  left join cartera ct on trim(ct.idcliente) = trim(f.cve_clpv) 
					  left join clie01 cl on cl.clave = f.cve_clpv
					  WHERE f.CVE_MAESTRO = '$maestro' and f.status_vencimiento >= 9
					  group by f.CVE_CLPV";
		
		}elseif($status == 2){
			$this->query="SELECT f.CVE_CLPV, sum(f.saldofinal) as saldo, max(cl.nombre) as nombre, max(ct.cartera_cobranza) as cartera  
					  FROM FACTF01 f
					  left join cartera ct on trim(ct.idcliente) = trim(f.cve_clpv) 
					  left join clie01 cl on cl.clave = f.cve_clpv
					  WHERE f.CVE_MAESTRO = '$maestro' and f.status_vencimiento >= 2 and status_vencimiento <= 3
					  group by f.CVE_CLPV";
		}else{
			$this->query="SELECT f.CVE_CLPV, sum(f.saldofinal) as saldo, max(cl.nombre) as nombre, max(ct.cartera_cobranza) as cartera  
					  FROM FACTF01 f
					  left join cartera ct on trim(ct.idcliente) = trim(f.cve_clpv) 
					  left join clie01 cl on cl.clave = f.cve_clpv
					  WHERE f.CVE_MAESTRO = '$maestro' and f.status_vencimiento = $status
					  group by f.CVE_CLPV";	
		}

		$rs=$this->QueryObtieneDatosN();

		//echo $this->query;

		while ($tsArray=ibase_fetch_object($rs)){
				$data[]=$tsArray;
			}	

		return $data;
	}


	function verRecibidosCobranza($cc){
		$this->query="SELECT * FROM VIEW_CAJAS where cc ='$cc'";
		$rs=$this->QueryObtieneDatosN();

		while($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}
		
		return @$data;
	}

	function guardaSecuencia($idc, $secuencia){
		$this->query="UPDATE CAJAS SET SECUENCIA_RUTA = $secuencia where id = $idc";
		$rs=$this->EjecutaQuerySimple();
		return;
	}

	function creaFolioRutaCobranza($cc){
		$usuario=$_SESSION['user']->NOMBRE;
		$this->query="SELECT iif(MAX(FOLIO) is null, 0, max(folio)) as folio FROM FOLIOS_RUTA_COBRANZA";
		$res=$this->QueryObtieneDatosN();
		$row=ibase_fetch_object($res);
		$folioN = $row->FOLIO + 1;
		$this->query="SELECT * FROM VIEW_CAJAS where cc='$cc'";
		$rs=$this->QueryObtieneDatosN();
		while($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}
			$i=0;
			$total=0;
			foreach ($data as $dato){

				$this->query="SELECT iif(max(SECUENCIA_RUTA) is null, 0, max(secuencia_ruta)) as sec FROM CAJAS WHERE FACTURA = '$dato->FACTURA'";
				$rs=$this->EjecutaQuerySimple();
				$row=ibase_fetch_object($rs);
				$sec=$row->SEC;

				$this->query="UPDATE FACTF01 SET FOLIO_RUTA_COBRANZA = $folioN where cve_doc = '$dato->FACTURA'";
				$rs=$this->EjecutaQuerySimple();

				$this->query="INSERT INTO PAR_RUTA_COBRANZA VALUES(NULL, '$dato->FACTURA', $dato->SALDOFINAL,$folioN, $sec)";
				$rs=$this->EjecutaQuerySimple();
				$i=$i+1;
				$total = $total +$dato->SALDOFINAL;
			}

		$this->query="INSERT INTO FOLIOS_RUTA_COBRANZA VALUES (NULL, $folioN, current_timestamp, DATEADD(day, 7, current_timestamp), $total, 0, null,'$usuario', $i, '$cc' )";
		$this->EjecutaQuerySimple();
		return $folioN;
	}


	function datosRutaC($folio){
		$this->query="SELECT * FROM FOLIOS_RUTA_COBRANZA WHERE FOLIO = $folio";
		$rs=$this->QueryObtieneDatosN();

		while($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}
		return $data;
	}

	function datosRutaP($folio){
		$this->query="SELECT pr.*, cl.nombre, f.fechaelab, iif(f.prorroga is null, 0, f.prorroga) as prorroga, c.secuencia_ruta, f.saldofinal   
						FROM PAR_RUTA_COBRANZA pr
						left join factf01 f on f.cve_doc = pr.documento
						left join clie01 cl on cl.clave = f.cve_clpv
						left join cajas c on c.factura = f.cve_doc
						WHERE pr.FOLIO = $folio";
		$rs=$this->QueryObtieneDatosN();

		while($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}
		return $data;
	}

	function verRutasVigentes(){
		$this->query="SELECT * FROM FOLIOS_RUTA_COBRANZA WHERE FECHA_FIN > CURRENT_DATE AND FECHA_CIERRE IS NULL";
		$rs= $this->QueryObtieneDatosN();

		while($tsArray = ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}
		return $data;
	}

	    function verPartidasRuta($idf){
    	$this->query="SELECT pr.*, cl.nombre, f.fechaelab, iif(f.prorroga is null, 0, f.prorroga) as prorroga, pr.secuencia,
    					f.saldofinal, f.aplicado, f.contrarecibo_cr, f.CVE_MAESTRO AS MAESTRO
                        FROM PAR_RUTA_COBRANZA pr
                        left join factf01 f on f.cve_doc = pr.documento
                        left join clie01 cl on cl.clave = f.cve_clpv
                        WHERE pr.FOLIO = $idf 
                        and f.saldofinal >= 10	
                        order by f.cve_maestro asc, cl.nombre asc";
        $rs=$this->QueryObtieneDatosN();
        while ($tsArray=ibase_fetch_object($rs)){
        	$data[]=$tsArray;
        }
        return $data;
    }

    function verPartidasPagadas($idf){
    	$this->query="SELECT pr.*, cl.nombre, f.fechaelab, iif(f.prorroga is null, 0, f.prorroga) as prorroga, pr.secuencia,
    					f.saldofinal, f.aplicado, f.contrarecibo_cr, f.CVE_MAESTRO AS MAESTRO
                        FROM PAR_RUTA_COBRANZA pr
                        left join factf01 f on f.cve_doc = pr.documento
                        left join clie01 cl on cl.clave = f.cve_clpv
                        WHERE pr.FOLIO = $idf 
                        and f.saldofinal <= 10	
                        order by f.cve_maestro asc, cl.nombre asc";
        $rs=$this->QueryObtieneDatosN();
        while ($tsArray=ibase_fetch_object($rs)){
        	$data[]=$tsArray;
        }
        return $data;
    }


    function obtieneFolio($docf){
    	$this->query="SELECT MAX(FOLIO) AS FOLIO FROM PAR_RUTA_COBRANZA WHERE DOCUMENTO = '$docf'";
    	$rs=$this->QueryObtieneDatosN();
    	$row=ibase_fetch_object($rs);
    	$folio = $row->FOLIO;

    	return $folio;
    }	

    function verRutasFinalizadas(){
    	$this->query="SELECT * FROM FOLIOS_RUTA_COBRANZA WHERE FECHA_FIN < CURRENT_DATE and FECHA_CIERRE IS NOT NULL";
    	$rs=$this->QueryObtieneDatosN();

    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}

    	return $data;
    }

    function cerrarRuta($idr){
    	$this->query="UPDATE FOLIOS_RUTA_COBRANZA SET FECHA_CIERRE = CURRENT_DATE WHERE FOLIO = $idr";
    	$rs=$this->EjecutaQuerySimple();
    }


      function verSolProdVentas(){
      	$data = array();
    	$user=$_SESSION['user']->NOMBRE;
    	$aux =$_SESSION['user']->AUX_COMP;
    	//echo 'Valida si es auxiliar o no: '.$aux;
    	if($aux == 'Si'){
			$this->query="SELECT * FROM FTC_Articulos ftcart
						    left join CATEGORIAS ctg on ctg.NOMBRE_CATEGORIA = ftcart.Categoria
						    left join marcas m on m.clave_marca = ftcart.marca
						    left join MARCAS_X_CATEGORIA mxc on mxc.idcat = ctg.id  and m.id = mxc.idmarca
						    WHERE ftcart.STATUS = 'P'
						    and mxc.auxiliar= '$user'";
    	}elseif($aux == 'No' and $user != 'Gerencia de Compras'){
			$this->query="SELECT * FROM FTC_Articulos ftcart
						    left join CATEGORIAS ctg on ctg.NOMBRE_CATEGORIA = ftcart.Categoria
						    left join marcas m on m.clave_marca = ftcart.marca
						    left join MARCAS_X_CATEGORIA mxc on mxc.idcat = ctg.id  and m.id = mxc.idmarca
						    WHERE ftcart.STATUS = 'P'
						    and ctg.responsable = '$user'";    		
    	}else{
			$this->query="SELECT * FROM FTC_Articulos ftcart
						    left join CATEGORIAS ctg on ctg.NOMBRE_CATEGORIA = ftcart.Categoria
						    left join marcas m on m.clave_marca = ftcart.marca
						    left join MARCAS_X_CATEGORIA mxc on mxc.idcat = ctg.id  and m.id = mxc.idmarca
						    WHERE ftcart.STATUS = 'P'";
    	}
    	$rs=$this->QueryObtieneDatosN();
    	//echo $this->query;
    	//break;
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return @$data;
    }

    function verProducto($ids){
    	$this->query="SELECT first 100 * FROM FTC_Articulos WHERE ID = $ids";
    	$rs = $this->QueryObtieneDatosN();

    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}

    	return @$data;
    }

    function guardaFTCART($ids, $clave, $categoria, $linea, $descripcion, $marca, $generico, $sinonimos, $calificativo, $medidas, $unidadmedida, $empaque, $prov1, $codigo_prov1, $sku, $costo_prov1, $iva, $desc1, $desc2, $desc3, $desc4, $desc5, $impuesto, $costo_total, $cotizacion, $cliente, $costo_t, $costo_oc, $tipo, $doco, $par){

    	$usuario = $_SESSION['user']->NOMBRE;

    	$this->query="SELECT ftca.*, ftcp.nombre, ftcp.clave as cveart FROM FTC_Articulos ftca left join PRODUCTO_FTC ftcp on ftcp.clave_ftc = ftca.id  WHERE ftca.ID = $ids";
    	$rs=$this->EjecutaQuerySimple();
    	$row=ibase_fetch_object($rs);
    	$nomprod = $row->NOMBRE;
    	$cveart = $row->CVEART;
    	
    	$this->query="INSERT INTO REG_COSTOS (ID, CLAVE_PROV, NOMBRE_PROV, CLAVE_PROD, NOMBRE_PROD, COSTO_O, COSTO_N, DIF, TIPO, FECHA, USUARIO, CLAVE_PROV_NUEVO, NOMBRE_PROV_NUEVO )
    					VALUES (NULL, substring('$row->CLAVE_DISTRIBUIDOR' from 1 for 10) , substring('$row->CLAVE_DISTRIBUIDOR' from 13 for 80), '$cveart', '$nomprod', $row->COSTO_T, $costo_t , ($row->COSTO_T - $costo_prov1), '$tipo', current_timestamp, '$usuario',substring('$prov1' from 1 for 10) , substring('$prov1' from 13 for 80))";
    	$this->EjecutaQuerySimple();
    	
    	if($descripcion == $generico or $generico == ''){
    		$desc = $descripcion;
    	}else{
    		$desc = $descripcion.' - '.$generico;
    	}
    	if(empty($costo_total)){
    		$costo_total = 0;
    	}
    	if(empty($costo_prov1)){
    		$costo_prov1 = 0;
    	}
    	if(empty($desc1)){
    		$desc1 = 0;
    	}
    	if(empty($desc2)){
    		$desc2 = 0;
    	}
    	if(empty($desc3)){
    		$desc3 = 0;
    	}
    	if(empty($desc4)){
    		$desc4 = 0;
    	}
    	if(empty($desc5)){
    		$desc5 = 0;
    	}
    	if(empty($costo_t)){
    		$costo_t = 0;
    	}
    	if(empty($costo_oc)){
    		$costo_oc=0;
    	}
       	$this->query="UPDATE FTC_ARTICULOS SET
    			CLAVE_PROD = '$clave',
    			CATEGORIA = '$categoria',
    			LINEA = '$linea',
    			GENERICO = '$generico',
    			SINONIMO = '$sinonimos',
    			CALIFICATIVO = '$calificativo',
    			MEDIDAS = '$medidas',
    			MARCA = '$marca',
    			UM = '$unidadmedida',
    			EMPAQUE = '$empaque',
    			CLAVE_DISTRIBUIDOR = '$prov1',
    			CLAVE_FABRICANTE = '$codigo_prov1',
    			SKU_CLIENTE = '',
    			SKU = '$sku',
    			COSTO = $costo_total,
    			PRECIO = $costo_prov1,
    			UTILIDAD_MININA = 0,
    			impuesto = $impuesto,
    			costo_t = $costo_t,
    			costo_oc = $costo_oc,
    			desc1 = $desc1,
    			desc2 = $desc2,
    			desc3 = $desc3,
    			desc4 = $desc4,
    			descf = $desc5
    			where id = $ids
    			";
    	//echo $this->query;
    	//break;
    	$rs=$this->EjecutaQuerySimple();
    	return $tipo;
    }



    function produccionFTCART($ids){
    	$this->query="UPDATE FTC_Articulos SET STATUS = 'A', fecha_alta = current_timestamp WHERE ID = $ids";
    	$rs=$this->EjecutaQuerySimple();

    	// Inserta en Inventario

    	$this->query = "INSERT into inve01 (CVE_ART, DESCR, UNI_MED, UNI_ALT,CON_SERIE, TIP_COSTEO, NUM_MON, CON_LOTE, CON_PEDIMENTO, CVE_ESQIMPU, STATUS, MAN_IEPS, APL_MAN_IEPS, TIPO_ELE, fac_conv) 
    						values ('PGS$ids',
    		(SELECT substring( 
            (GENERICO
            ||iif(SINONIMO = '' or SINONIMO is null,'',(', '||SINONIMO))
            ||iif(CALIFICATIVO = '' OR CALIFICATIVO IS NULL, '',(', '||CALIFICATIVO))
            ||iif(MEDIDAS = '' OR MEDIDAS IS NULL,'',(', '||MEDIDAS))
            ||iif(CLAVE_PROD = '' OR CLAVE_PROD IS NULL, '', (', '||CLAVE_PROD))
            ||iif(MARCA = '' OR MARCA IS NULL, '', (', '||MARCA))
            ||iif(UM = '' OR UM IS NULL,'',(', '||UM))
            )
            from 1 for 40) FROM FTC_Articulos WHERE ID = $ids),
    		(SELECT iif(UM is null or UM = '', 'pza', UM ) from FTC_Articulos WHERE ID = $ids),
    		(SELECT iif(UM is null or UM = '', 'pza', UM) from FTC_Articulos where id = $ids),
    		'N', 'P', 1, 'N', 'N','1', 'A', 'N', 1, 'P', 1)";
    	$rs=$this->EjecutaQuerySimple();

    	//echo 'Inserta en el Inventario: '.$this->query.'<br/>';
    	//break;
    	/// Inserta en los campos libres

    	$this->query="INSERT INTO INVE_CLIB01 (CVE_PROD, CAMPLIB7) VALUES ( 'PGS$ids', 
    	(SELECT substring(
            (GENERICO
            ||iif(SINONIMO = '' OR SINONIMO IS NULL ,'',(', '||SINONIMO))
            ||iif(CALIFICATIVO = '' OR CALIFICATIVO IS NULL , '',(', '||CALIFICATIVO))
            ||iif(MEDIDAS = '' OR MEDIDAS IS NULL,'',(', '||MEDIDAS))
            ||iif(CLAVE_PROD = '' OR CLAVE_PROD IS NULL , '', (', '||CLAVE_PROD))
            ||iif(MARCA = '' OR MARCA IS NULL , '', (', '||MARCA))
            ||iif(UM = '' OR UM IS NULL,'',(', '||UM))
            )
            from 1 for 255) FROM FTC_Articulos WHERE ID = '$ids')
    	)";
    	$rs=$this->EjecutaQuerySimple();

		//echo 'Inserta en los campos libres'.$this->query.'<br/>';

    	/// inserta en multialmacenes;

    	$this->query="INSERT INTO MULT01 VALUES('PGS$ids', 95, 'A','', 0, 0, 0, 0 , null, null)";
    	$rs=$this->EjecutaQuerySimple();

    	$this->query="INSERT INTO MULT01 VALUES('PGS$ids', 1, 'A','', 0, 0, 0, 0 , null, null)";
    	$rs=$this->EjecutaQuerySimple();
    	//echo 'Inserta Campos libres: '.$this->query;
    	/// Inserta en los precios
    	
    	$this->query="SELECT MAX(CVE_PRECIO) as precios FROM PRECIOS01";
    	$rs=$this->QueryObtieneDatosN();
    	$row=ibase_fetch_object($rs);
    	$p = $row->PRECIOS;

    	for ($i=1; $i <= $p; $i++) { 
   		
   			$this->query="INSERT INTO PRECIO_X_PROD01 (CVE_ART, CVE_PRECIO, PRECIO) VALUES ('PGS$ids', $i,
    		(SELECT COALESCE(COSTO, 1)* 1.2 
    		FROM FTC_Articulos WHERE ID = $ids));";
    		$rs=$this->EjecutaQuerySimple();

    		//echo 'Inserta en la lista de precios: '.$this->query.'<p>';
   		}

   		 /// fija el minimo en 0 pesos....
   		$this->query="UPDATE PRECIO_X_PROD01 SET PRECIO = 0 WHERE CVE_ART = 'PGS$ids' and cve_precio = 2";
   		$rs=$this->EjecutaQuerySimple();

   		/// Lo ingresamos a la cotizacion que pertenece

   			/// obtenemos los datos del producto y de la cotizacion para poder obtener los datos.
	   		$this->query="SELECT * from FTC_Articulos WHERE ID = $ids";
	   		$rs=$this->QueryObtieneDatosN();
	   		$row=ibase_fetch_object($rs);
	   		$folio = $row->COTIZACION;

	   		$precSug= ($row->COSTO * .23) + $row->COSTO; 
	   		if($row->COTIZACION != '0'){
				$this->query="INSERT INTO FTC_COTIZACION_DETALLE (CDFOLIO, CVE_ART, FLCANTID, DBIMPPRE,DBIMPCOS, DBIMPDES ) VALUES($row->COTIZACION, $row->ID, $row->CANTSOL, $precSug, $row->COSTO_T, 0)";
	   			$res=$this->EjecutaQuerySimple();
	   		}
	   		//// echo $this->query;
    	return $folio;
    }
    
    function catalogoProductosFTC($descripcion){
    	$data = array();
    	if(!empty($descripcion)){
    		$id= strpos($descripcion,':');
    		if($id === false){
    				$this->query="SELECT fart.*, ct.id as idc, (select cve_prodserv from inve01 where cve_art = fart.clave_pegaso) as cve_prodserv, (select cve_unidad from inve01 where cve_art = fart.clave_pegaso ) as cve_unidad, (SELECT id FROM FTC_Articulos_N ftn WHERE fart.id = ftn.referencia) as artn
    				FROM FTC_Articulos fart
    				left join producto_ftc pftc on pftc.clave_ftc = fart.id
    				left join CATEGORIAS ct ON  ct.nombre_categoria = fart.categoria
    				where  pftc.nombre containing('$descripcion') or clave_pegaso containing ('$descripcion') ";
    			//echo $this->query;	
    		}else{
    			$a= explode(':',$descripcion);    
                            $descripcion = $a[0];
                          	$this->query="SELECT fart.*, ct.id as idc, (select cve_prodserv from inve01 where cve_art = fart.clave_pegaso) as cve_prodserv, (select cve_unidad from inve01 where cve_art = fart.clave_pegaso ) as cve_unidad, (SELECT id FROM FTC_Articulos_N ftn WHERE fart.id = ftn.referencia) as artn 
    						FROM FTC_Articulos fart
    						left join producto_ftc pftc on pftc.clave_ftc = fart.id
    						left join CATEGORIAS ct ON  ct.nombre_categoria = fart.categoria
    						where   upper(pftc.clave)= upper('$descripcion')";
    						///echo $this->query;
    		}
    	}else{
    			$this->query="SELECT first 100 fart.*, ct.id as idc , (select cve_prodserv from inve01 where cve_art = fart.clave_pegaso) as cve_prodserv, (select cve_unidad from inve01 where cve_art = fart.clave_pegaso ) as cve_unidad, (SELECT id FROM FTC_Articulos_N ftn WHERE fart.id = ftn.referencia) as artn
    			FROM FTC_Articulos fart
    			left join CATEGORIAS ct ON  ct.nombre_categoria = fart.categoria
    			where fart.status = 'A' or fart.status= 'B' or fart.status = 'M' ";
		}    		
    	
    		$rs=$this->QueryObtieneDatosN();
    	//echo $this->query;
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return @$data;
    }

    function creaProductoFTC($categoria, $linea, $descripcion, $marca, $generico, $sinonimos, $calificativo, $medidas, $unidadmedida, $empaque, $prov1, $codigo_prov1, $sku, $costo_prov1, $iva, $desc1, $desc2, $desc3, $desc4, $desc5, $impuesto, $costo_total, $clave, $costo_t, $costo_oc){
    	$this->query="INSERT INTO FTC_ARTICULOS VALUES(
    			NULL,'$linea','$categoria','$generico','$sinonimos','$calificativo','$medidas','$clave','$marca','$unidadmedida',$empaque,'$prov1','$codigo_prov1','','$sku',$costo_total,$costo_prov1,0,'A','DIRECTO COMPRAS',0, $desc1,$desc2,$desc3,$desc4,$desc5,'$descripcion','$iva',current_date,$impuesto,$costo_t,$costo_oc,0,NULL, NULL,'')";
    	$rs=$this->EjecutaQuerySimple();
    	$this->query="SELECT MAX(ID) AS ID FROM FTC_Articulos";
    	$res=$this->QueryObtieneDatosN();
    	$row=ibase_fetch_object($res);
    	$ids = $row->ID;
    	$res+=$this->produccionFTCART($ids);
    	return;
    	/// enviamos a produccion:
    }
    function cancelarCargaPago($idtrans){
    	$this->query = "UPDATE CARGA_PAGOS SET STATUS = 'C' WHERE ID = $idtrans";
    	echo $this->query;
    	//break;
    	$rs=$this->EjecutaQuerySimple();
    	return;
    }

    function verCajasAlmacen(){
    	$usuario = $_SESSION['user']->NOMBRE;
    	$data=array();
    	$this->query = "SELECT * FROM PG_USERS WHERE NOMBRE = '$usuario'";
    	$rs=$this->EjecutaQuerySimple();
    	$row=ibase_fetch_object($rs);
    	if($letra = $_SESSION['user']->LETRA == 'G'){
    		$this->query="SELECT ca.*, ftcc.urgente, ftcc.cve_cliente, iif(cl.status_cobranza is null, 0 , cl.status_cobranza) as status_cobranza, 	ftcc.dbimptot, cl.saldo_monto_cobranza, cl.nombre as cliente, ftcc.idpedido as oc, ftcc.cdfolio from cajas_almacen ca left join FTC_COTIZACION ftcc on ftcc.CDfolio = ca.cotizacion 
    				left join clie01 cl on trim(cl.clave) = trim(ftcc.cve_cliente) where (ca.status  = 0 or datediff(day from fecha_ventas to current_timestamp) < 15) order by ca.fecha_ventas desc";
    	}else{
    		$this->query="SELECT ca.*, ftcc.urgente, ftcc.cve_cliente, iif(cl.status_cobranza is null, 0 , cl.status_cobranza) as status_cobranza, 	ftcc.dbimptot, cl.saldo_monto_cobranza, cl.nombre as cliente, ftcc.idpedido as oc, ftcc.cdfolio from cajas_almacen ca left join FTC_COTIZACION ftcc on ftcc.CDfolio = ca.cotizacion 
    				left join clie01 cl on trim(cl.clave) = trim(ftcc.cve_cliente) where PEDIDO Starting with('$row->LETRA_NUEVA') AND (ca.status  = 0 or datediff(day from fecha_ventas to current_timestamp) < 15) order by ca.fecha_ventas desc";
    	}
    	$rs=$this->EjecutaQuerySimple();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return $data;
    }

    function datosCotizacionFTC($folio){
    	$this->query="SELECT * from ftc_cotizacion ftcc
        left join cartera ct on trim(ct.idcliente) = trim(ftcc.cve_cliente)
        left join clie01 cl on trim(cl.clave) = trim(ftcc.cve_cliente)
        where cdfolio = $folio";
        $rs=$this->QueryObtieneDatosN();

        while($tsArray=ibase_fetch_object($rs)){
        	$data[]=$tsArray;
        }
        return $data;
    }

    function detalleCotizacionFTC( $folio){
    	$this->query="SELECT *
        FROM  FTC_COTIZACION_DETALLE ftcd
        left join ftc_articulos ftca on ftca.id = ftcd.cve_art
        left join producto_ftc pftc on pftc.clave_ftc = ftca.id
        where cdfolio = $folio";
        $rs=$this->QueryObtieneDatosN();

      	while($tsArray=ibase_fetch_object($rs)){
      		$data[]=$tsArray;
      	}
      	return $data;
    }

 function libPedidoFTC($folio, $idp, $idca, $urgente){
    	$mensaje = '';
    	$TIME = time();
		$HOY = date("Y-m-d H:i:s", $TIME);
    	if($urgente == 'Si'){
    		$u = 'U';
    	}else{
    		$u = '';
    	}
    	$usuario=$_SESSION['user']->NOMBRE;
    
    	$this->query="SELECT p.CVE_CLPV, limcred, diascred, iif(status_cobranza is null, 0, status_cobranza) as status_cobranza,
 						iif(finaliza_corte is null, current_timestamp, finaliza_corte) as finaliza_corte,
                    	iif(saldo_monto_cobranza is null, 0, saldo_monto_cobranza) as saldo_monto_cobranza, 
                    	p.importe
                        FROM FACTP01 p 
                        left join clie01 cl on cl.clave = p.cve_clpv 
                        WHERE CVE_DOC = '$idp'";

    	$rs=$this->EjecutaQuerySimple();
    	$row=ibase_fetch_object($rs);
    	$cveclie = $row->CVE_CLPV;
    	$limite = $row->LIMCRED;
    	$plazo = $row->DIASCRED;
    	$status = $row->STATUS_COBRANZA;
    	$finalizaCorte = $row->FINALIZA_CORTE;
    	$saldoCobranza =$row->SALDO_MONTO_COBRANZA;
    	$importe = $row->IMPORTE;
    	/// traemos el saldo de facturas pendientes de pago del cliente
    	$this->query="SELECT iif(SUM(SALDOFINAL) is null, 0 , sum(saldofinal)) as SF FROM FACTURAS WHERE CVE_CLPV = '$cveclie'";
    	$rs=$this->EjecutaQuerySimple();
    	$row2=ibase_fetch_object($rs);
    	$saldofact=$row2->SF;
    	//// traemos el saldo de las remisiones pendientes de facturar del cliente.
    	$this->query="SELECT iif(SUM(IMPORTE) is null,0,sum(importe)) AS SR FROM factr01 WHERE CVE_CLPV ='$cveclie' AND STATUS <> 'C' AND (DOC_SIG = '' OR DOC_SIG IS NULL)";
    	$rs=$this->EjecutaQuerySimple();
    	$row=ibase_fetch_object($rs);
    	$saldorem= $row->SR;
    
    	if($finalizaCorte >= $HOY){
    		$saldoCobranza = 0;
    	}
    	$saldotot = $saldorem + $saldofact + $importe - $saldoCobranza;
    	echo 'El Cliente: '.$cveclie.' tiene un saldo deudor de $ '.number_format($saldotot,2).', y su Limite es de  $ '.number_format($limite,2).'<p>';
    	// Si la suma de los documentos + el pedido a liberar es mayor a la linea de credito establecida, manda error, de lo contrario deja generar el pedido. 
    	if($saldotot > $limite){
    		echo 'Entra al sobregiro con el status del cliente'.$status.' favor de revisar con Cuentas x Cobrar'.'<p>';
				if($status == 0){
					$this->query = "UPDATE CLIE01 SET STATUS_COBRANZA = 1 where clave = '$cveclie'";
					$rs=$this->queryActualiza();
					$mensaje = 'El cliente esta suspendido por que supera su linea de credito, favor de solicitar desbloqueo con Cuentas x Cobrar';
				}else{

					echo 'define el mensaje';
					$mensaje = 'El cliente ya supero su limite de credito o no se ha establecido su limite de credito, favor de solicitar aumento de linea de credito con Cobranza';
				}	

    	}else{
			    	$this->query="UPDATE PREOC01 SET STATUS = 'N', urgente = '$u' WHERE COTIZA = '$idp'";
			    	$rs=$this->queryActualiza();
    				$this->query="UPDATE cajas_almacen SET STATUS = 1, FECHA_ALMACEN=current_timestamp, fecha_liberacion = current_timestamp, usuario_libera = '$usuario', CONSECUTIVO = (SELECT COALESCE(MAX(CONSECUTIVO),0) FROM CAJAS_ALMACEN) + 1 WHERE IDCA = $idca";
    				$rs= $this->queryActualiza();
    				$serie_pegaso = substr($idp,0,1);
    				$this->query="SELECT iif(MAX(CP_FOLIO) is null, 0, max(CP_FOLIO)) AS FOLIO FROM CAJAS_ALMACEN WHERE CP_SERIE = '$serie_pegaso'";
		            $rs=$this->EjecutaQuerySimple();
		            $row=ibase_fetch_object($rs);
		            $folio_cp_folio= $row->FOLIO + 1; 
		            $caja_pegaso = 'L'.$serie_pegaso.$folio_cp_folio;
		            $this->query="UPDATE CAJAS_ALMACEN SET caja_pegaso = '$caja_pegaso' , cp_folio = $folio_cp_folio , cp_serie= '$serie_pegaso' where idca =$idca";
		            $this->queryActualiza();
    				$mensaje = 'ok';
    	}
   		return $mensaje;
    }

    function verCatergoriasXMarcas(){
    	$data=array();
    	$usuario = $_SESSION['user']->NOMBRE;
    	$this->query="SELECT mxc.*, m.*, c.*,
		            (SELECT COUNT(id) FROM FTC_Articulos WHERE CATEGORIA = c.nombre_categoria AND MARCA = m.clave_marca) as prodxmarca
		            FROM MARCAS_X_CATEGORIA mxc left join marcas m on m.id = mxc.idmarca left join categorias c on c.id = mxc.idcat
		            --WHERE c.responsable = '$usuario'
		            order by  c.NOMBRE_CATEGORIA";
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}

    	//echo 'Consulta: '.$this->query;
    	return $data;
    }

    function traeMXC($idcxm){
    	$this->query="SELECT mxc.*, m.*, c.*,
		            (SELECT COUNT(id) FROM FTC_Articulos WHERE CATEGORIA = c.nombre_categoria AND MARCA = m.clave_marca) as prodxmarca
		            FROM MARCAS_X_CATEGORIA mxc 
		            left join marcas m on m.id = mxc.idmarca 
		            left join categorias c on c.id = mxc.idcat
		            WHERE mxc.id = $idcxm";
		        $rs=$this->QueryObtieneDatosN();

		        while($tsArray=ibase_fetch_object($rs)){
		        	$data[]=$tsArray;
		        }
		    return $data;
    }

    function usuariosAuxiliarCompras(){
    	$user=$_SESSION['user']->NOMBRE;
    	echo 'Nombre: '.$user;
    	$this->query="SELECT * FROM PG_USERS WHERE AUX_COMP = 'Si' and COORDINADOR_COMP = '$user'";
    	$rs=$this->QueryObtieneDatosN();

	    	while($tsArray=ibase_fetch_object($rs )){
	    		$data[]=$tsArray;
	    	}
    	return @$data;
    }

    function editaMXC($idmxc, $auxiliar){
    	$this->query="UPDATE MARCAS_X_CATEGORIA SET AUXILIAR ='$auxiliar' where id = $idmxc";
    	$rs=$this->EjecutaQuerySimple();

    	return;
    }

    function verCotPenLib(){
    	$this->query="SELECT ftcc.*, cl.nombre, cl.saldo_corriente, cl.saldo_vencido,
    					(select sum(DBIMPCOS) from FTC_COTIZACION_DETALLE ftccd WHERE ftcc.cdfolio = ftccd.cdfolio) as costo 
    				  FROM FTC_COTIZACION ftcc 
    				  left join clie01 cl on trim(ftcc.cve_cliente) = trim(cl.clave)
    				  where ftcc.INSTATUS = 'LIBERACION'";
    	$rs=$this->EjecutaQuerySimple();
    	//echo $this->query;
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}

    	return @$data;
    }

    function desLib($folio, $respuesta){
    	$this->query="UPDATE FTC_COTIZACION SET INSTATUS='$respuesta' where cdfolio = $folio";
    	$rs=$this->EjecutaQuerySimple();
    	return;	
    }


    function verOrdCompCesta(){

    	$user=$_SESSION['user']->NOMBRE;
    	$this->query="SELECT *
		            FROM PREOC01 p
		            left join ftc_articulos ftca on ftca.id = substring(p.prod from 4 for 10) and p.prod starting with ('PGS')
		            left join prov01 pv on pv.clave = substring(ftca.clave_distribuidor from 1 for 10) and p.prod starting with ('PGS')
		            WHERE p.rest > 0  and p.id > 80000
		            and pv.resp_compra = '$user'";
    	echo $this->query;
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray = ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return $data;
    }

    function editaProveedor($idprov){
    	$this->query="SELECT * FROM PROV01 WHERE CLAVE = '$idprov'";
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return $data;
    }

    function traeResponsablesProve(){
    	$this->query="SELECT * FROM PG_USERS WHERE USER_ROL = 'suministros' or USER_ROL ='administracion'";
    	$rs=$this->QueryObtieneDatosN();

    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}

    	return $data;
    }

    function editarProveedor($idprov, $urgencia, $envio, $recoleccion, $tp_efe, $tp_ch, $tp_cr, $tp_tr, $certificado, $banco, $cuenta, $beneficiario, $responsable, $plazo, $email1, $email2, $email3, $serv){
    	$user=$_SESSION['user']->NOMBRE;
    	$this->query="SELECT * FROM PROV01 WHERE trim(CLAVE) = TRIM('$idprov')";
    	$rs=$this->QueryObtieneDatosN();
    	$row=ibase_fetch_object($rs);
    	$cer = $row->CERTIFICADO;
    	if($cer == 'Si' and $certificado == 'Si'){
    		$this->query="UPDATE PROV01 SET urgencia ='$urgencia', envio= '$envio', recoleccion='$recoleccion', tp_efectivo = '$tp_efe', tp_credito = '$tp_cr', tp_transferencia= '$tp_tr', tp_cheque='$tp_ch', certificado = '$certificado', nom_banco='$banco', cuenta='$cuenta', beneficiario = '$beneficiario', resp_compra='$responsable', diascred = $plazo, emailpred = '$email1', email2 = '$email2', email3 = '$email3', fax= '$serv' WHERE CLAVE = '$idprov'";
	    	$rs=$this->EjecutaQuerySimple();
    	}elseif (empty($cer) or $cer == 'No'  ){
    		$this->query="UPDATE PROV01 SET urgencia ='$urgencia', envio= '$envio', recoleccion='$recoleccion', tp_efectivo = '$tp_efe', tp_credito = '$tp_cr', tp_transferencia= '$tp_tr', tp_cheque='$tp_ch', certificado = '$certificado', nom_banco='$banco', cuenta='$cuenta', beneficiario = '$beneficiario', resp_compra='$responsable', fecha_cert = current_timestamp, usr_cert = '$user', num_cert= iif(num_cert is null, 1, num_cert + 1), diascred = $plazo , emailpred = '$email1', email2 = '$email2', email3 = '$email3', fax= '$serv' WHERE CLAVE = '$idprov'";
	    	$rs=$this->EjecutaQuerySimple();
    	}
    	return;
    }

	function CreaSubMenu($tipo){
		$data = array();
		if($tipo == 'total'){
			$this->query="SELECT f.idu, count(f.id) as documentos, max(U.NUMERO) as numero , MAX(U.MARCA) as marca, MAX(U.PLACAS) as placas, MAX(U.OPERADOR) as operador, max(U.modelo) as modelo, max(U.coordinador) as coordinador 
					FROM FTC_POC f
					left join unidades u on u.idu = f.idu 
					WHERE OC in (SELECT ORDEN FROM FTC_DETALLE_RECEPCIONES WHERE STATUS = 0 AND FECHA >= '01.11.2018' AND ORDEN CONTAINING('OP') GROUP BY ORDEN, CAST(FECHA  AS DATE))
					group by f.idu";
			$rs=$this->EjecutaQuerySimple();

			while ($tsArray=ibase_fetch_object($rs)) {
				$data[]=$tsArray;
			}
		}else{
			$this->query="SELECT F.idu, count(F.id) as documentos, max(U.NUMERO) as numero , MAX(U.MARCA) as marca, MAX(U.PLACAS) as placas, MAX(U.OPERADOR) as operador, max(U.modelo) as modelo, max(U.coordinador) as coordinador 
			FROM FTC_POC F
			LEFT JOIN UNIDADES U ON U.IDu = F.IDU
			WHERE (F.STATUS = 'PAGADA' OR F.STATUS = 'LOGISTICA') 
			AND STATUS_LOG='$tipo' group by F.idu";
			//echo $this->query;	
			$result=$this->EjecutaQuerySimple();
     		while ($tsArray = ibase_fetch_object($result)){
     		$data[] = $tsArray;
			}
     	}
     	return $data;  
	}

    function CreaSubMenuProv(){
    	$user=$_SESSION['user']->NOMBRE;
    	$data=array();
    	$gerencia = $_SESSION['user']->LETRA;
    	echo 'Usuario: '.$user.$gerencia;
    	if($user =='Gerencia de Compras' or $gerencia == 'G'){
    		$this->query="SELECT pv.clave, pv.nombre, count(p.id) as productos, 
    				(SELECT resp_compra FROM PROV01 WHERE clave = pv.clave) as responsable
		            FROM PREOC01 p
		            left join ftc_articulos ftca on ftca.id = substring(p.prod from 4 for 10) and p.prod starting with ('PGS')
		            left join prov01 pv on trim(pv.clave) = iif(p.prov_alt is null, trim(substring(ftca.clave_distribuidor from 1 for 10)), trim(p.prov_alt)) and p.prod starting with ('PGS')
		            WHERE p.status = 'N'
		            and p.Rec_faltante > 0
		            group by pv.nombre, pv.clave";
		
    	}else{
    		$this->query="SELECT pv.clave, pv.nombre, count(p.id) as productos, '' as responsable
		            FROM PREOC01 p
		            left join ftc_articulos ftca on ftca.id = substring(p.prod from 4 for 10) and p.prod starting with ('PGS')
		            left join prov01 pv on trim(pv.clave) = iif(p.prov_alt is null, trim(substring(ftca.clave_distribuidor from 1 for 10)), trim(p.prov_alt)) and p.prod starting with ('PGS')
		            WHERE (pv.resp_compra = '$user') 
		            and p.status = 'N'
		            and p.Rec_faltante > 0
		            group by pv.nombre, pv.clave";
    	}
		            //echo $this->query;
     	$result = $this->QueryObtieneDatosN();
     	while ($tsArray = ibase_fetch_object($result)){
     		$data[] = $tsArray;
     	}
     	return $data;  
	}

	function verCanasta($idprov, $gerencia){
		$user=$_SESSION['user']->NOMBRE;
		if($user=='Gerencia de Compras' or $gerencia == 'Si'){
				if(empty($idprov)){
						//echo 'Sin Proveedor';
							$this->query="SELECT p.*, ftca.precio as costo_art,
							  ((ftca.desc1/100)) as desc1a , 
							  ((ftca.desc2/100)) as desc2a, 
							  ((ftca.desc3/100)) as desc3a, 
							  ((ftca.desc4/100)) as desc4a,
							ftca.costo_t as costo_t,ftca.costo_oc, ftca.impuesto, pv.nombre, '' as responsable
				            FROM PREOC01 p
				            left join ftc_articulos ftca on ftca.id = substring(p.prod from 4 for 10) and p.prod starting with ('PGS')
				            left join prov01 pv on trim(pv.clave) = iif(p.prov_alt is null, trim(substring(ftca.clave_distribuidor from 1 for 10)), trim(p.prov_alt)) and p.prod starting with ('PGS')
				            WHERE  p.status='N'
				            and p.rec_faltante > 0
				            and pv.clave is null";
				}else{
						//echo 'Con proveedor';
						$this->query="SELECT p.*, ftca.precio as costo_art, 
							((ftca.desc1/100)) as desc1a, 
							((ftca.desc2/100)) as desc2a, 
							((ftca.desc3/100)) as desc3a, 
							((ftca.desc4/100)) as desc4a,
						ftca.costo_t as costo_t,ftca.costo_oc, ftca.impuesto, pv.nombre,
							(select resp_compra from prov01 where trim(clave) = trim('$idprov')) as responsable
				        FROM PREOC01 p
				        left join ftc_articulos ftca on ftca.id = substring(p.prod from 4 for 10) and p.prod starting with ('PGS')
				        left join prov01 pv on trim(pv.clave) = iif(p.prov_alt is null, trim(substring(ftca.clave_distribuidor from 1 for 10)), trim(p.prov_alt)) and p.prod starting with ('PGS')
				        WHERE trim(pv.clave) = trim('$idprov')
				        and p.status = 'N'
				        and p.rec_faltante > 0";
				}
		}else{
				if(empty($idprov)){
							$this->query="SELECT p.*, ftca.
							 as costo_art,  
							 	( (ftca.desc1/100)) as desc1a, 
							 	( (ftca.desc2/100)) as desc2a, 
							 	( (ftca.desc3/100)) as desc3a, 
							 	((ftca.desc4/100)) as desc4a,
							ftca.costo_t as costo_t,ftca.costo_oc, ftca.impuesto, pv.nombre
				            FROM PREOC01 p
				            left join ftc_articulos ftca on ftca.id = substring(p.prod from 4 for 10) and p.prod starting with ('PGS')
				            left join prov01 pv on trim(pv.clave) = iif(p.prov_alt is null, trim(substring(ftca.clave_distribuidor from 1 for 10)), trim(p.prov_alt)) and p.prod starting with ('PGS')
				            WHERE p.rest > 0 and p.id >100000
				            and (pv.resp_compra = '$user' or pv.resp_compra = '' or pv.resp_compra is null )
				            and p.status='N'
				            and p.rec_faltante > 0
				            and pv.clave is null";
				}else{
						$this->query="SELECT p.*, ftca.precio as costo_art, 
								( (ftca.desc1/100)) as desc1a,
								( (ftca.desc2/100)) as desc2a, 
								( (ftca.desc3/100)) as desc3a, 
								((ftca.desc4/100)) as desc4a,
						ftca.costo_t as costo_t,ftca.costo_oc, ftca.impuesto, pv.nombre
				        FROM PREOC01 p
				        left join ftc_articulos ftca on ftca.id = substring(p.prod from 4 for 10) and p.prod starting with ('PGS')
				        left join prov01 pv on trim(pv.clave) = iif(p.prov_alt is null, trim(substring(ftca.clave_distribuidor from 1 for 10)), trim(p.prov_alt)) and p.prod starting with ('PGS')
				        WHERE p.rest > 0 and p.id >0
				        and (pv.resp_compra = '$user' or pv.resp_compra = '' or pv.resp_compra is null ) 
				        AND trim(pv.clave) = trim('$idprov')
				        and p.status = 'N'
				        and p.rec_faltante > 0";
				}
		}
		//echo 'Consulta: '.$this->query;
		//echo 'Trae todos los datos de la preorden'.$this->query.'<p>';
		$rs=$this->QueryObtieneDatosN();
    	while($tsArray = ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return $data;
	}


	function subTotalCanasta($idprov){
		$user=$_SESSION['user']->NOMBRE;

		if(empty($idprov)){
					$this->query="SELECT SUM(TOTAL) AS TOTAL
		            FROM PREOC01 p
		            left join ftc_articulos ftca on ftca.id = substring(p.prod from 4 for 10) and p.prod starting with ('PGS')
		            left join prov01 pv on pv.clave = substring(ftca.clave_distribuidor from 1 for 10) and p.prod starting with ('PGS')
		            WHERE p.rest > 0 and p.id >100000
		            and (pv.resp_compra = '$user' or pv.resp_compra = '' or pv.resp_compra is null )";
		}else{
				$this->query="SELECT sum(TOTAL) AS TOTAL
		        FROM PREOC01 p
		        left join ftc_articulos ftca on ftca.id = substring(p.prod from 4 for 10) and p.prod starting with ('PGS')
		        left join prov01 pv on pv.clave = substring(ftca.clave_distribuidor from 1 for 10) and p.prod starting with ('PGS')
		        WHERE p.rest > 0 and p.id >100000
		        and (pv.resp_compra = '$user' or pv.resp_compra = '' or pv.resp_compra is null )
		        AND trim(pv.clave) = trim('$idprov')";
		}

		$rs=$this->QueryObtieneDatosN();
		while ($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}
		//echo 'Este es el subtotal de la Orden:'.$this->query;
		return $data;
	}

	function bajaFTCArticualo($ids){
		$usuario=$_SESSION['user']->NOMBRE;
		$this->query="UPDATE FTC_Articulos SET STATUS = 'B', FECHA_BAJA = current_timestamp, USUARIO_BAJA = '$usuario' WHERE ID = $ids";
		$rs=$this->EjecutaQuerySimple();
		return;
	}

	function rechazaSol($ids, $motivo, $vendedor){
		$user = $_SESSION['user']->NOMBRE;
		$this->query="SELECT * FROM FTC_Articulos WHERE ID = $ids";
		$rs=$this->EjecutaQuerySimple();
		$row=ibase_fetch_object($rs);
		if($row->STATUS == 'P'){
			$this->query="UPDATE FTC_Articulos SET STATUS = 'R' WHERE ID = $ids";
			$rs=$this->EjecutaQuerySimple();
			$this->query="INSERT INTO FTC_Articulos_RECHAZADOS (ID, IDA, VENDEDOR, MOTIVO, FECHA, USUARIO) values (Null, $ids, '$vendedor', '$motivo', current_timestamp, '$user')";
			$rs=$this->EjecutaQuerySimple();
		}
		return;
	}

	function traeFTCArt($ids){
		$data = array();
		$this->query="SELECT * FROM FTC_Articulos WHERE ID =$ids";
		$rs=$this->QueryObtieneDatosN();
		while($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}
		return $data;
	}

	function verRechazo(){
		$user=$_SESSION['user']->NOMBRE;
		$this->query="SELECT COUNT(ID) AS ID FROM  FTC_Articulos_RECHAZADOS where vendedor = '$user' and status = 0";
		$rs=$this->QueryObtieneDatosN();
		$row = ibase_fetch_object($rs);

		if(empty($row)){
			$rechazo = 0;
		}else{
			$rechazo = $row->ID;
		}

		//echo $rechazo;
		//break;
		return $rechazo;
	}

	function traeRechazos(){
		$user = $_SESSION['user']->NOMBRE;
		$this->query="SELECT * FROM VER_RECHAZADOS where vendedor = '$user' and status = 0";
		$rs=$this->QueryObtieneDatosN();
		while($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}
		return $data;
	}

	function enterado($idr){
		$this->query="UPDATE FTC_Articulos_RECHAZADOS SET STATUS = 1 where id = $idr";
		$rs=$this->EjecutaQuerySimple();

		return;
	}



	function preOrdenDeCompra($partidas){
			//echo 'Asi inician <br/><br/>';
			//var_dump($partidas);
			echo'<br/><br/>';
			$usuario = $_SESSION['user']->NOMBRE;
			$tipoUsuario= $_SESSION['user']->LETRA; 

			if($_SESSION['user']->POLIZA_TIPO == 'G'){
				echo '<p>Se crea como gerente.</p>';
			}elseif ($tipoUsuario != 'a' and $_SESSION['user']->USER_ROL != 'suministros') {
				return $usuario;
			}
			//var_dump($partidas);
			foreach ($partidas as $key){
				$data=null;
				$idpreoc = $key[1];
				$ftcart = $key[2];
				$cantidad = $key[4];
				$cotizacion = $key[6];

				if($cantidad > 0 ){
					$this->query = "SELECT * FROM PREOC01 WHERE ID = $idpreoc";
							$rs = $this->EjecutaQuerySimple();
							$row = ibase_fetch_object($rs);
							$canto = $row->CANT_ORIG;
							$cantr = $row->REST;
							$cantord = $row->ORDENADO;
							$rec = $row->RECEPCION;

							$doa = new idpegaso;
						    $val = $doa->revisaDuplicado($idpreoc);
						    $ordenado = $val['ordenado'];
						    $recibido =$val['recibido'];
						    $pendiente = $val['pendiente'];
						    $status = $val['status'];
					    	//echo 'ordenado'.$ordenado.',  recibido '.$recibido.', pendiente '.$pendiente.' status : '.$status;

							$pp = $pendiente;

							if($cantidad > $pp){
								$cantidad  =  $pp;
							}
							echo 'PP: '.$pp.' Pendiente: '.$pendiente.' Cantidad: '.$cantidad.'<br/>';

					if( $cantidad > $pp or $pp == 0 ){
								//echo 'La cantidad es mayor  a la solicitada: '.$pendientesOC + $pendientesFTC + $canval.' cantidad maxima '.$canto.'<p>';
								//echo 'El pedido necesita: '.$canto.' y hay '.$pendientesOC + $pendientesFTC.' pendientes, por lo que no es posible pedir mas.'.'<p>';
								$this->query="INSERT INTO  BODEGA_DUPLICADOS (ID, PROD, CANT, ORIGINAL, RECIBIDO_VALIDADO, COTIZACION, FECHA_COTIZACION, FECHA_VALIDACION, status)
													 VALUES (NULL, '$row->PROD', $canto - $recibido, $row->CANT_ORIG, $recibido, '$row->COTIZA', '$row->FECHASOL', current_timestamp, 0)";
								$rs=$this->EjecutaQuerySimple();
								$this->query="UPDATE PREOC01 SET RECEPCION = $recibido, REC_FALTANTE = $canto - $recibido, status='B' where id = $idpreoc";
								$rs=$this->EjecutaQuerySimple();
					}else{
					/// Inicia el analisis de Bodega.		SELECT * from INGRESOBODEGA WHERE PRODUCTO = 'PGS430' and restante > 0 and ((status = 1 and origen = 'Orden Intera') or (Origen != 'Orden Interna' and status=0))
								$this->query="SELECT count(id) as lineas, sum(restante) as restante FROM INGRESOBODEGA WHERE PRODUCTO = '$ftcart' and restante > 0 and ((status = 1 and origen = 'Orden Intera') or (Origen != 'Orden Interna' and status=0)) ";
								$rs=$this->EjecutaQuerySimple();
								$row = ibase_fetch_object($rs);
								$lineas = 0;
								if($row->LINEAS > 0 ){
										//echo $this->query.'<br/>';
										//echo 'El Producto se encuentra en: '.$row->LINEAS.' asignacione(s)  con '.$row->RESTANTE.' restantes y la preorden pide: '.$cantidad.'.<br/> '; 
										//// el producto existe en la bodega y tenemos el restante.
									$this->query = "SELECT * from INGRESOBODEGA WHERE PRODUCTO = '$ftcart' and restante > 0 and ((status = 1 and origen = 'Orden Intera') or (Origen != 'Orden Interna' and status=0))";
									$res = $this->EjecutaQuerySimple();
									while ($tsArray=ibase_fetch_object($res)) {
										$data[]=$tsArray;
									}
										$cantPOC = $cantidad;

										echo 'Ingresos en Bodega con restante: '.count($data).'<br/>';
										echo 'Cantidad: '.$cantidad.'<br/>';
											foreach ($data as $key2) {
												$lineas = $lineas + 1;
												$cantIB= $key2->RESTANTE;
												$prodIB = $key2->PRODUCTO;
												$idIB = $key2->ID;
												$val  = $cantPOC - $cantIB; /// revisamos como se va a afectar, tenemos 3 casos, se solicita lo que hay y el resultado es 0, se solicita menos el resultado es positivo, se solicita mas de lo que hay el resultado es positivo; 
													//400 - 13 = 387
													//8 - 10= -2
												echo 'Valor de val: '.$val.'<br/>';
												if($val <= 0 ){
													/// hay mas en la bodega.
													////  Se Asignan.
													/// Se elimina la partida para la Preorden.
													$this->query="INSERT INTO ASIGNACION_BODEGA_PREOC (ID, IDINGRESO, INICIAL, ASIGNADO, FINAL, FECHA_MOV, USUARIO_MOV, PREOC, COTIZA, STATUS, RECIBIDO) VALUES (null, $idIB, $key2->RESTANTE, $cantPOC, $key2->RESTANTE - $cantPOC, current_timestamp,'$usuario', $idpreoc, '$key[6]', 7, 0) ";
													$this->grabaBD();
													$this->query="UPDATE PREOC01 SET ASIGNADO = asignado + $cantPOC, REST= REST - $cantPOC, ordenado = ordenado + $cantPOC, status = iif(REST - $cantPOC =0, 'B','N'), canti = canti - $cantPOC where id = $idpreoc";
													$this->grabaBD();
													$this->query="UPDATE INGRESOBODEGA SET ASIGNADO = ASIGNADO + $cantPOC, restante = restante - $cantPOC where id = $idIB";
													$this->grabaBD();
													echo 'Lineas: '.$lineas.' y valor en $row->Lineas:'.$row->LINEAS.' se analiza el id.'.$idpreoc.' asignado: '.$cantPOC.'<br/>';
													break;
												}elseif($val > 0){
													$this->query="INSERT INTO ASIGNACION_BODEGA_PREOC (ID, IDINGRESO, INICIAL, ASIGNADO, FINAL, FECHA_MOV, USUARIO_MOV, PREOC, COTIZA, STATUS, RECIBIDO) VALUES (null, $idIB, $key2->RESTANTE, $cantIB, $key2->RESTANTE - $cantIB, current_timestamp,'$usuario', $idpreoc, '$key[6]', 7, 0) ";
													$this->grabaBD();
													$this->query="UPDATE PREOC01 SET ASIGNADO = asignado + $cantIB, REST= REST - $cantIB, ordenado = ordenado + $cantIB, status = iif(REST- $cantPOC =0, 'B','N'), canti = canti - $cantIB where id = $idpreoc";
													$this->grabaBD();
													$this->query="UPDATE INGRESOBODEGA SET ASIGNADO = ASIGNADO + $cantIB, restante = restante - $cantIB where id = $idIB";
													$this->grabaBD();
													$cantPOC = $cantPOC - $cantIB;
													echo '-->Lineas: '.$lineas.' y valor en $row->Lineas:'.$row->LINEAS.' se analiza el id.'.$idpreoc.' asignado: '.$cantIB.'<br/>';
													if($lineas == $row->LINEAS AND $cantPOC > 0){
														$partidasNuevas = array($key[0],$key[1],$key[2],$key[3],$cantPOC, $cantPOC, $key[6],$key[7]);
														$pn[] = $partidasNuevas;
														unset($partidasNuevas);
													}
												}
											}
								}else{
										$partidasNuevas = array($key[0],$key[1],$key[2],$key[3],$key[4],$key[5],$key[6],$key[7]); 
										$pn[] = $partidasNuevas;
										unset($partidasNuevas);
								}
								/// se obtienen todas las partidas que tienen el producto.
						}
				}
			}

			//echo 'Asi Terminan <br/><br/>';
			//var_dump($pn);
			//break;
			if(count($pn) > 0){
				$this->query="SELECT max(ult_cve) as folio FROM TBLCONTROL01 where ID_TABLA = 80";
				$rs=$this->QueryObtieneDatosN();
				$row = ibase_fetch_object($rs);
				$folioo = $row->FOLIO; /// obtengo el folio Original.
				$folio = $folioo + 1;
				$this->query="UPDATE TBLCONTROL01 SET ULT_CVE = $folio where ID_TABLA = 80";
				$this->grabaBD();
				$rs=$this->crtOrdenDeCompra($pn, $folio);
			}
			
			return;
	}


	function crtOrdenDeCompra($partidas, $folio){
		$user = $_SESSION['user']->NOMBRE;
		$i = 1;
			$subCostoTotal= 0;
			$subPrecioTotal =0;
			$ivatot=0;
			$desctot=0;
			$this->query="INSERT INTO FTC_POC (CVE_DOC, CVE_PROV, FECHA_DOC, FECHA_PAGO, TP_TES, USUARIO, USUARIO_PAGO, COSTO, PRECIO, IVA, STATUS, Total_IVA, costo_total, fecha_elab, descuento)
		     				values('POC'||$folio, '', current_timestamp, null, NULL,'$user', null, 0, 0, 16, 'Nueva', 0, 0 , current_timestamp, 0)";
							$rs=$this->grabaBD();
		foreach ($partidas as $key){
			$prove = $key[0];
			$idpreoc = $key[1];
			$ftcart = $key[2];
			$costo = $key[3];
			$rest = $key[1];
			$cantidad = $key[4];
			$cotizacion = $key[6];
			$descuento = $key[7];
				echo 'Asi llega la cantidad'.$cantidad.'<p>';
			/// ANALISIS DE LA SITUACION DEL PRODUCTO:
						$this->query = "SELECT * FROM PREOC01 WHERE ID = $idpreoc";
						$rs = $this->EjecutaQuerySimple();
						$row = ibase_fetch_object($rs);
						$canto = $row->CANT_ORIG;
						$cantr = $row->REST;
						$cantord = $row->ORDENADO;
						$rec = $row->RECEPCION;
						$doa = new idpegaso;
					    $val = $doa->revisaDuplicado($idpreoc);
					    $ordenado = $val['ordenado'];
					    $recibido =$val['recibido'];
					    $pendiente = $val['pendiente'];
					    $status = $val['status'];
				    	//echo 'ordenado'.$ordenado.',  recibido '.$recibido.', pendiente '.$pendiente.' status : '.$status;
						$pp = $pendiente;
						if($cantidad > $pp){
							$cantidad  =  $pp;
						}
						
						$costoTotal = $cantidad * $costo;
						if( $cantidad > $pp or $pp == 0){
							echo 'La cantidad es mayor  a la solicitada: '.$pendientesOC + $pendientesFTC + $canval.' cantidad maxima '.$canto.'<p>';
							echo 'El pedido necesita: '.$canto.' y hay '.$pendientesOC + $pendientesFTC.' pendientes, por lo que no es posible pedir mas.'.'<p>';
							$this->query="INSERT INTO BODEGA_DUPLICADOS (ID, PROD, CANT, ORIGINAL, RECIBIDO_VALIDADO, COTIZACION, FECHA_COTIZACION, FECHA_VALIDACION, status)
												 VALUES (NULL, '$row->PROD', $canto - $canval, $row->CANT_ORIG, $canval, '$row->COTIZA', '$row->FECHASOL', current_timestamp, 0)";
							$rs=$this->EjecutaQuerySimple();
							$this->query="UPDATE PREOC01 SET RECEPCION = $canval, REC_FALTANTE = $canto - $canval, status='B' where id = $idpreoc";
							$rs=$this->EjecutaQuerySimple();
						}else{
							$this->query="SELECT CDFOLIO FROM FTC_COTIZACION WHERE SUBSTRING('$cotizacion' from 1 for 1) = SERIE and folio = substring('$cotizacion' from 2 for 6)";
							$rs=$this->QueryObtieneDatosN();
							$row=ibase_fetch_object($rs);
							$cotfolio = $row->CDFOLIO;
							$this->query="SELECT DBIMPPRE FROM FTC_COTIZACION_DETALLE WHERE CDFOLIO = $cotfolio and cve_art = substring('$ftcart' from 4 for 6)";
							$rs=$this->QueryObtieneDatosN();
							$row= ibase_fetch_object($rs);
							$precio = $row->DBIMPPRE;
							$precioTotal = $cantidad * $precio;
							$this->query="SELECT UM, clave_prod FROM FTC_ARTICULOS WHERE ID = substring('$ftcart' from 4 for 6)";
							$rs=$this->QueryObtieneDatosN();
							$row= ibase_fetch_object($rs);
							$um = $row->UM;
							$cve_prod =$row->CLAVE_PROD;
							$tot_iva = ($costoTotal) * .16;
							/// Creamos Partidas ///
							if(($cantidad - $cantr) == 0){
								$nstat = 'X';
							}else{
								$nstat = 'N';
							}
							$this->query= "UPDATE PREOC01 SET ORDENADO = ORDENADO + $cantidad, REST = REST - $cantidad, CANTI = CANT_ORIG - (ORDENADO + $cantidad), status = '$nstat' WHERE ID = $idpreoc ";
							$rs=$this->EjecutaQuerySimple();
							if($rs){
								echo 'Rs es verdadero';
								$this->query="INSERT INTO FTC_POC_DETALLE(CVE_DOC, PARTIDA, ART, CANTIDAD, COSTO, PRECIO, COTIZACION, USUARIO, FECHA_ELAB, FECHA_DOC, SERIE, FOLIO, UM, FACCONV, cve_prod, COSTO_TOTAL, PRECIO_TOTAL, idpreoc, tot_iva, PXR, DESCUENTO)
												VALUES('POC'||$folio, $i, '$ftcart', $cantidad, $costo, $precio, '$cotizacion', '$user', current_timestamp, current_date, 'POC', $folio, '$um', 1, '$cve_prod',$cantidad*$costo, $precioTotal, $idpreoc, $tot_iva, $cantidad, $descuento)";
									$rs =$this->EjecutaQuerySimple();
									$i= $i+1;
									$subCostoTotal = $subCostoTotal + $costoTotal;
									$subPrecioTotal =$subPrecioTotal + $precioTotal;
									$ivatot = $ivatot + $tot_iva;
									$desctot += $descuento;
										//echo 'Actualizamos Preorden de Compra: '.$this->query.'<p>';
									//// Afectamos a la tabla de Preorcompra.
							}else{
								echo 'rs es falso';
							}
						}
		}
			if($i > 1){
				$this->query="UPDATE FTC_POC set CVE_PROV = '$prove' , COSTO = $subCostoTotal + $desctot, PRECIO =  $subPrecioTotal, IVA = 16 , Total_IVA =  $ivatot, costo_total = $subCostoTotal + $ivatot, descuento = $desctot where CVE_DOC = 'POC'||$folio";
				$rs=$this->EjecutaQuerySimple();
			//	echo $this->query;
			}

			//break; 
		return;
	}







	function quitarSum($ida){
		$rol = $_SESSION['user']->USER_ROL;
		if($rol == 'bodega2'){
			$this->query="UPDATE ASIGNACION_BODEGA_PREOC SET versum = 1 where id = $ida";
			$this->EjecutaQuerySimple();
		}else{
			$this->query="UPDATE ASIGNACION_BODEGA_PREOC SET versum = 0 where id = $ida";
			$this->EjecutaQuerySimple();
		}
		return ;
	}

	function procesarAsigAuto($ida, $tipo){
		if($tipo == 'a'){
			$this->query="UPDATE ASIGNACION_BODEGA_PREOC SET STATUS = 0 WHERE ID = $ida";
			$this->EjecutaQuerySimple();
		}else{
			$this->query="UPDATE ASIGNACION_BODEGA_PREOC SET STATUS = 4 WHERE ID = $ida";
			$this->EjecutaQuerySimple();

			$this->query="SELECT * FROM ASIGNACION_BODEGA_PREOC WHERE ID = $ida";
			$rs=$this->EjecutaQuerySimple();
			$row = ibase_fetch_object($rs);

			$this->query="UPDATE PREOC01 SET STATUS = 'N', REST = REST + $row->ASIGNADO, ORDENADO = ORDENADO - $row->ASIGNADO, CANTI = CANTI + $row->ASIGNADO, asignado = asignado - $row->ASIGNADO WHERE ID = $row->PREOC";
			$this->EjecutaQuerySimple();
		}
			$a= array("status"=>'ok');
		
		return $a;
	}



	function datosFTCPOC($idpoc){
		$this->query="SELECT *  FROM CABECERA_POC WHERE CVE_DOC = '$idpoc'";
		$rs=$this->EjecutaQuerySimple();

		while($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}
		
		$this->query="SELECT * FROM CABECERA_POC WHERE OC= '$idpoc'";
		$rs=$this->EjecutaQuerySimple();

		while($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}

		
		return  @$data;
	}

	function detalleFTCPOC($idpoc){
		$this->query="SELECT d.*, current_date as hoy FROM DETALLE_POC d WHERE CVE_DOC = ('$idpoc') and status = 0";
		$rs = $this->EjecutaQuerySimple();
		///echo $this->query;
		//break;
		while ($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}

		$this->query="SELECT d.*, current_timestamp as hoy from DETALLE_POC D where oc = ('$idpoc') and status = 2";
		@$rs = $this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}

		return @$data;
	}

	function verPreOC(){
		$user=$_SESSION['user']->NOMBRE;
		$this->query="SELECT ftc.*, p.nombre, p.emailpred as correo
							FROM FTC_POC ftc
							left join Prov01 p on p.clave = ftc.cve_prov
							WHERE (ftc.STATUS = 'Nueva' or ftc.STATUS = 'En Uso')
							and usuario = '$user'";
		$rs=$this->EjecutaQuerySimple();

		while($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}

		return @$data;
	}


	function editaPreoc($idd){
		$this->query="SELECT * FROM DETALLE_POC WHERE ID = $idd";
		$rs=$this->EjecutaQuerySimple();
		while($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}
		return $data;
	}


	function eliminaPreOC($poc){
		$this->query="SELECT id FROM FTC_POC_DETALLE WHERE CVE_DOC = '$poc'";
		$rs=$this->EjecutaQuerySimple();
		while($tsArray = ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}

		foreach ($data as $key) {
			$this->eliminaPartidaPreoc($key->ID);
		}
		$this->query="UPDATE FTC_POC SET STATUS = 'RECHAZADA' WHERE CVE_DOC = '$poc'";
		$rs=$this->EjecutaQuerySimple();
		return;
	}

	function eliminaPartidaPreoc($idd){
		$this->query="SELECT IDPREOC FROM FTC_POC_DETALLE WHERE ID = $idd";
		$res=$this->EjecutaQuerySimple();
		$row=ibase_fetch_object($res);
		$idpreoc = $row->IDPREOC;
		//$doa = new idpegaso;
		//$val = $doa->revisaDuplicado($idpreoc);
		$this->query="UPDATE FTC_POC_DETALLE SET STATUS = 3 WHERE ID = $idd";
		$rs=$this->EjecutaQuerySimple();
			//// aqui va el codigo para regresarle las partidas canceladas a la tabla de Preoc01 	
			$newCant  = 0;
			$newCost = 0;
			$res+=$this->editaPartidaPreOC($idd, $newCant, $newCost);
		return;
	}

	function editaPartidaPreOC($idd, $newCant, $newCost){
		echo 'Entro a editar Partida del idd'.$idd.' nueva Cantidad = '.$newCant.' nuevo Costo '.$newCost.'<p>';
		//break;
		$this->query="SELECT STATUS, CANTIDAD, IDPREOC, CVE_DOC, DESCUENTO FROM FTC_POC_DETALLE WHERE ID = $idd ";
		$rs=$this->EjecutaQuerySimple();
		$row=ibase_fetch_object($rs);
		$cantActual = $row->CANTIDAD;
		$cvedoc = $row->CVE_DOC;
		$descUnitario = $row->DESCUENTO / $cantActual;
					if($row->STATUS == 1){
						$mensaje = 'La Partida se ha cancelado';
						return $mensaje;
					}elseif ($row->STATUS == 2) {
						$mensaje = 'La Pre Orden ya ha sido confirmada, no se pudo cambiar la cantidad';
						return $mensaje; 
					}elseif ($row->STATUS == 0 or $row->STATUS == 3){
						$this->query="SELECT CANT_ORIG, REST, recepcion FROM PREOC01 WHERE ID = $row->IDPREOC";
						$rs=$this->EjecutaQuerySimple();
						$row2=ibase_fetch_object($rs);
						$original = $row2->CANT_ORIG;
						$recepcion = $row2->RECEPCION;
						$rest=$original - $recepcion;
						echo 'Rest = '.$rest;
						if($rest == 0){
							$mensaje= 'Ya se ha recibido el total solicitado, para evitar duplicidad, se cancelara la partida.';
							$this->query="UPDATE FTC_POC_DETALLE SET STATUS = 1 WHERE ID = $idd";
							$rs=$this->EjecutaQuerySimple();
							$this->query="UPDATE PREOC01 SET STATUS = 'B', REST = 0 where id = $key->IDPREOC";
							$rs=$this->EjecutaQuerySimple();
							echo $mensaje;
							//break;
							return $mensaje;
						}elseif ($rest < 0) {
							$mensaje= 'Ya se ha recibido mas del total solicitado, para evitar duplicidad, se cancelara la partida.';
							$this->query="UPDATE FTC_POC_DETALLE SET STATUS = 1 WHERE ID = $idd";
							$rs=$this->EjecutaQuerySimple();
							$this->query="UPDATE PREOC01 SET STATUS = 'B', REST = 0 where id = $key->IDPREOC";
							$rs=$this->EjecutaQuerySimple();
							echo $mensaje;
							//break;
							return $mensaje;
						}else{
							$this->query="SELECT iif(SUM(CANTIDAD)is null, 0 , sum(cantidad)) as PENDIENTES FROM FTC_POC_DETALLE WHERE IDPREOC = $row->IDPREOC AND STATUS = 0 and id <> $idd";
							$rs=$this->EjecutaQuerySimple();
							$row1 = ibase_fetch_object($rs);
							$pendientes = $row1->PENDIENTES;
							$total = $pendientes + $newCant;
							echo $this->query.'<p>';
							echo 'Total'.$total.'<p>';
							if($total > $rest){
								$mensaje ="Se intenta solicitar mas de lo requerido, favor de revisar, faltante: ".$rest." , solicitado: ".$total.' incluyendo esta Pre Orden';
								echo $mensaje.'<p>';

									$this->query="SELECT CVE_DOC, CANTIDAD, PARTIDA FROM FTC_POC_DETALLE WHERE STATUS = 0 AND IDPREOC = $row->IDPREOC";
									$rs=$this->EjecutaQuerySimple();

									while($tsArray = ibase_fetch_object($rs)){
										$dataA[]=$tsArray;
									}
									foreach ($dataA as $key) {
										echo 'Este producto se encuenta en la Pre Orden: '.$key->CVE_DOC. ', Cantidad: '.$key->CANTIDAD.' partida'.$key->PARTIDA.'<p>';
									}
									echo 'Favor de Cancelar la que mas convenga.';
								//break;
								return $mensaje;
							}elseif($total <= $rest){
								echo 'Total: '.$total.' Restante'.$rest.'<p>';

								$this->query="UPDATE FTC_POC_DETALLE SET CANTIDAD = $newCant, PXR = $newCant, costo = $newCost, COSTO_TOTAL = $newCant * $newCost, tot_iva = (($newCost*$newCant)*.16), descuento = $descUnitario * $newCant where id=$idd";
								$rs=$this->EjecutaQuerySimple();
								echo $this->query.'<p>';
								//break;
								$this->query="UPDATE FTC_POC SET 
													COSTO = (SELECT SUM(COSTO_TOTAL) FROM FTC_POC_DETALLE WHERE CVE_DOC = '$cvedoc'),
													TOTAL_IVA = (SELECT SUM(TOT_IVA) FROM FTC_POC_DETALLE WHERE CVE_DOC = '$cvedoc'),
													DESCUENTO = (SELECT SUM(DESCUENTO) FROM FTC_POC_DETALLE WHERE CVE_DOC = '$cvedoc'), 
													COSTO_TOTAL = ((SELECT SUM(COSTO_TOTAL) FROM FTC_POC_DETALLE WHERE CVE_DOC = '$cvedoc') + (SELECT SUM(TOT_IVA) FROM FTC_POC_DETALLE WHERE CVE_DOC = '$cvedoc')) 
													WHERE CVE_DOC = '$cvedoc'";
								$rs=$this->EjecutaQuerySimple();
								echo 'Actualiza los Totales '.$this->query.'<p>';
								$mensaje = "Se ha actualizado la partida";
								$nuevo_rest=$rest - $total;

								echo '$nuevo_rest'.$nuevo_rest.'<p>';
								
								if ($nuevo_rest > 0 ) {
									$this->query="UPDATE PREOC01 SET REST = $nuevo_rest, status = 'N', CANTI = $nuevo_rest, ordenado = ordenado - $nuevo_rest where id= $row->IDPREOC";
									$rs=$this->EjecutaQuerySimple();

									echo 'Entro a modificar la cantidad a solicitar: '.$this->query;
									if($row->STATUS == 3){
										$this->query="UPDATE FTC_POC_DETALLE SET STATUS = 1 WHERE ID = $idd";
										$rs=$this->EjecutaQuerySimple();	
									}	
								}
							return $mensaje;
							}
						}
					}			
			}

	function ConfirmaPreOrden($doco, $te, $tptes, $tipo, $conf){
		$usuario= $_SESSION['user']->NOMBRE;
		$mysql= new databasemysql;
		$this->query="SELECT * FROM FTC_POC WHERE CVE_DOC = '$doco'";
		$res=$this->EjecutaQuerySimple();
		$row=ibase_fetch_object($res);
		// B1030<----
		if($row->STATUS == 'Nueva'){
			$this->query="SELECT * FROM FTC_POC_DETALLE WHERE CVE_DOC = '$doco' and status = 0";
			$rs= $this->EjecutaQuerySimple();			
			while($tsArray=ibase_fetch_object($rs)){
				$data[]=$tsArray;
			}
			$subtotal= 0;
			$this->query="SELECT MAX(ULT_CVE) AS FOLIO FROM TBLCONTROL01 where id_tabla =82";
			$rs=$this->EjecutaQuerySimple();
			$row = ibase_fetch_object($rs);
			$fn = $row->FOLIO + 1;
			$folio = 'OP'.$fn;
			$this->query="UPDATE TBLCONTROL01 SET ULT_CVE = $fn where id_TABLA = 82";
			$res = $this->queryActualiza();
			if($res == 1){
				foreach ($data as $key) {
				$this->query="SELECT REST FROM PREOC01 WHERE ID = $key->IDPREOC";
				$rs=$this->EjecutaQuerySimple();
				$row = ibase_fetch_object($rs);
				$rest=$row->REST;
				$status = '1';
					if($rest > 0 ){
						$status = 'N';				
					}else{
						$status = 'B';
					}
						$this->query="UPDATE PREOC01 SET ORDENADO = ordenado + $key->CANTIDAD, STATUS = '$status' WHERE ID = $key->IDPREOC";
						$result=$this->queryActualiza();
						if($result == 1 ){
							$this->query="UPDATE FTC_POC_DETALLE SET STATUS = 2, OC = '$folio' WHERE ID = $key->ID";
							$resul=$this->queryActualiza();
							$subtotal = $subtotal + $key->COSTO_TOTAL;
							if($resul == 1 ){
								$this->query="UPDATE FTC_POC SET STATUS = 'ORDEN', OC = '$folio', COSTO = $subtotal, TOTAL_IVA = $subtotal *.16, COSTO_TOTAL = $subtotal *1.16, fecha_oc = current_timestamp, usuario_oc='$usuario', tp_tes_req = '$tptes', tipo = '$tipo', fecha_entrega = '$te', confirmado = '$conf', status_log = 'Nuevo', Docs = 'N', vueltas = 0, folio_oc = $fn where cve_doc = '$doco'";
								$rs=$this->queryActualiza();
								
							}else{
								echo 'No se actualizo las partidas y no se considera ';
							}
						}else{
							echo 'No se actualizo lo Ordenado, favor de reintentar';
						}
				}
			}else{
				$folio = 'No se pudo crear el nuevo folio';
			}
			
		}else{
			$folio = 'Procesada con anterioridad';
		}
		return $folio; 
	}



	function traeMaestro($idm, $cvem){
		$this->query="SELECT M.*, 
					(SELECT COUNT(ID) FROM MAESTROS_CCC WHERE CVE_MAESTRO = '$cvem') as CCs,
					(SELECT SUM(PRESUPUESTO_mensual) FROM MAESTROS_CCC WHERE CVE_MAESTRO = '$cvem') as totccs
					 FROM MAESTROS M WHERE CLAVE = '$cvem'";
		$rs=$this->QueryObtieneDatosN();

		//echo $this->query;
		while($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}
		return $data;
	}


	function verCCC($idm, $cvem){
		$this->query="SELECT MCC.*, CL.NOMBRE AS CLIENTE FROM MAESTROS_CCC MCC
					  LEFT JOIN CLIE01 CL ON CL.CLAVE = MCC.INDIVIDUAL
					  WHERE MCC.CVE_MAESTRO = '$cvem'";
		$rs=$this->QueryObtieneDatosN();

		while($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}
		return @$data;
	}


	function traeIndividuales($cvem){
		$this->query="SELECT * FROM CLIE01 WHERE CVE_MAESTRO = '$cvem'";
		$rs=$this->QueryObtieneDatosN();

		while($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}

		return @$data;
	}

	function creaCC($cvem, $nombre, $contacto, $telefono, $presup, $idm){
		$user=$_SESSION['user']->NOMBRE;

		$this->query="INSERT INTO MAESTROS_CCC(ID, CVE_MAESTRO, PRESUPUESTO_mensual, NOMBRE, COMPRADOR, telefono, USUARIO , FECHA_ALTA, id_maestro) 
							VALUES(null, '$cvem', $presup,'$nombre', '$contacto', '$telefono', '$user', current_timestamp, '$idm' )";
		$rs=$this->EjecutaQuerySimple();

		//echo $this->query;
		//break;
		return;
	}

	function treaeClientesSinCC(){
		$this->query="SELECT CLAVE, NOMBRE, RFC, CALLE, NUMEXT, CAMPLIB7 
					  FROM CLIE01 
					  LEFT JOIN CLIE_CLIB01 ON CLAVE = CVE_CLIE 
					  WHERE (C_COMPRAS IS NULL) and status ='A'";
		$rs=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}
		return $data;
	}

	function verAsociados($cc){
		$this->query="SELECT cl.clave, cl.RFC, cl.nombre, cl.calle, cl.numext, m.nombre as maestro, cc.nombre as ccompra, clib.camplib7, cl.c_compras 
					 FROM CLIE01 cl
					 inner join maestros m on m.clave = cl.cve_maestro
					 inner join maestros_ccc cc on cc.id = cl.c_compras
					 inner join CLIE_CLIB01 clib on clib.cve_clie =cl.clave
					  WHERE C_COMPRAS = $cc";
		$rs = $this->EjecutaQuerySimple();
		while($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}
		return @$data;
	}

	function asociaCC($cc, $cliente, $cvem){
		$this->query="UPDATE CLIE01 SET C_COMPRAS = $cc, cve_maestro = '$cvem' where CLAVE = '$cliente'";
		$rs=$this->EjecutaQuerySimple();
		return;
	}

	function cancelaAsociacion($cc, $clie){
		$this->query="UPDATE CLIE01 SET C_COMPRAS = null, cve_maestro = '' where CLAVE = '$clie'";
		$rs=$this->EjecutaQuerySimple();
		echo $this->query;
		return;
	}

	function rechazarFTC($idca, $idp, $folio, $urgente){
		$this->query="UPDATE cajas_almacen SET STATUS = 2 WHERE IDca = $idca";
		$rs=$this->EjecutaQuerySimple();

		$this->query="UPDATE FTC_COTIZACION SET INSTATUS = 'RECHAZO BODEGA' WHERE CDFOLIO = $folio";
		$rs=$this->EjecutaQuerySimple();

		$this->query="UPDATE PREOC01 SET STATUS = 'R', PAR = 100 + PAR WHERE COTIZA = '$idp' and status = 'P'";
		$rs=$this->EjecutaQuerySimple();
		// echo $this->query;
		return;
	}

	function aplicacionesAfacturas($fechaIni, $fechaFin){

		$this->query="SELECT * FROM APLICACIONES WHERE FECHA BETWEEN '$fechaIni' and '$fechaFin' and procesado = 0 and cancelado = 0";
		$rs=$this->QueryObtieneDatosN();

		$this->query="UPDATE FACTF01 SET SALDOFINAL = -6  WHERE CVE_DOC = 'A150426'";
		$rs=$this->EjecutaQuerySimple();
		echo 'Este es el resultado'.$rs.'<p>';  
		if($rs){
			echo 'Es verdaero??? existe ';
		}else{
			echo 'Es Verdadero, no existe';
		}
		//break;
		while($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}
		$i=1;
		foreach ($data as $key){
			
			$this->query="UPDATE FACTF01 SET APLICADO = aplicado + $key->MONTO_APLICADO, 
						 ID_APLICACIONES = iif(id_aplicaciones = '', '$key->ID', id_aplicaciones||', '||'$key->ID'),
						 ID_PAGOS= iif(id_pagos = '', '$key->IDPAGO', id_pagos||', '||'$key->IDPAGO'),
						 PAGOS = PAGOS + $key->MONTO_APLICADO
						 WHERE CVE_DOC = '$key->DOCUMENTO'";
			$rs=$this->EjecutaQuerySimple();

			//echo $this->query.'<p>';
			$i += $i;	

			if($rs == False){
				echo 'AD, Error al aplicar el Documento, '.$key->DOCUMENTO.', de la aplicacion:, '.$key->ID.'<p>';
			}else{
				$this->query="UPDATE APLICACIONES SET PROCESADO = 1 WHERE ID = $key->ID";
				$ra=$this->EjecutaQuerySimple();
				if($ra == False){
					echo 'EAP, No se marco como procesado el pago, '.$key->ID;
				}

				/// actualizacion Carga_Pagos

				$this->query="UPDATE CARGA_PAGOS SET SALDO = MONTO - $key->MONTO_APLICADO, APLICACIONES = APLICACIONES + $key->MONTO_APLICADO WHERE ID= $key->IDPAGO";
				$r=$this->EjecutaQuerySimple();
				if($r == False){
					echo 'Error en el ajuste del saldo al cargo de la aplicacion, '.$key->ID.', del Pago ,'.$key->IDPAGO;
				}
			}
			/// Actualizacion de saldos de facturas.
			$this->query="UPDATE FACTF01 SET SALDOFINAL = IMPORTE - APLICADO WHERE CVE_DOC = '$key->DOCUMENTO'";
			$res=$this->EjecutaQuerySimple();
			if($res == False){
				echo 'No se calculo el saldo correctamente de la factura, '.$key->DOCUMENTO;
			}

			if(substr($key->FORMA_PAGO, 0, 1) == 'A'){
				$this->query="UPDATE ACREEDORES SET APLICADO = iif(aplicado is null, $key->MONTO_APLICADO, APLICADO + $key->MONTO_APLICADO) where id= substring('$key->FORMA_PAGO' FROM 3 FOR 6)";
				$rest=$this->EjecutaQuerySimple();
				if($rest  == False){
					echo "No actualizo: ".$this->query.'<p>';
				}
			}

		}   //// finalizan las actualizaciones en base a las aplicaciones. 
		
		$this->query="SELECT * FROM FACTD01 WHERE FECHAELAB BETWEEN '$fechaIni' and '$fechaFin' and status <> 'C' and aplicado = 0 and serie starting with 'NRB'";
		$rs=$this->QueryObtieneDatosN();

		while($tsArray = ibase_fetch_object($rs)){
			$data2[]=$tsArray;
		}

		foreach ($data2 as $nc) {
			$this->query="UPDATE FACTF01 SET nc_aplicadas = iif(nc_aplicadas = '', '$nc->CVE_DOC', nc_aplicadas||', '||'$nc->CVE_DOC') ,
				importe_nc = importe_nc + $nc->IMPORTE
				where cve_doc = '$nc->DOC_ANT'";
			$result=$this->EjecutaQuerySimple();

			if($result == False){
				echo 'Actualiza factura'.$this->query.'<p>';	
			}
			
			$this->query="UPDATE FACTD01 SET saldo = IMPORTE - $nc->IMPORTE, APLICADO = 1 WHERE CVE_DOC ='$nc->CVE_DOC'";
			$resd=$this->EjecutaQuerySimple();

			if($resd==False){
				echo 'Actualiza NC '.$this->query.'<p>';
			}
			$this->query="UPDATE FACTF01 SET SALDOFINAL = importe - aplicado - $nc->IMPORTE WHERE CVE_DOC = '$nc->DOC_ANT'";
			$res=$this->EjecutaQuerySimple();
		
			if($res == False){
				echo 'Actualiza Saldo'.$this->query.'<p>';	
			}	
		}

		//// actualiza Carga_Pagos
			$this->query="SELECT * FROM ACREEDORES WHERE STATUS = 0 and procesado = 0 ";
			$rs=$this->QueryObtieneDatosN();

			while($tsArray=ibase_fetch_object($rs)){
				$data3[]=$tsArray;
			}

			//var_dump($data3);

			foreach ($data3 as $key){
				$this->query="UPDATE CARGA_PAGOS SET MONTO_ACREEDOR = iif(MONTO_ACREEDOR is null, $key->SALDO, MONTO_ACREEDOR + $key->SALDO) where id= $key->ID_PAGO";
				$result=$this->EjecutaQuerySimple();

				if($result == False){
					echo 'Errror en la actualizacion '.$this->query.'<p>';
				}else{
					$this->query="UPDATE ACREEDORES SET PROCESADO = 1 WHERE ID = $key->ID";
					$rest=$this->EjecutaQuerySimple();
				}
				//echo 'Actualiza Acreedores'.$this->query.'<p>';
			}

			$this->query="UPDATE CARGA_PAGOS SET SALDO = MONTO - APLICACIONES - MONTO_ACREEDOR";
			$res=$this->EjecutaQuerySimple();

		//// cuadre de Carga Pagos
		return;
	}

	function actualizaSaldoM($maestro){

		if($maestro = 'todos'){

			$this->query="UPDATE MAESTROS SET SALDO_2015 = 0, SALDO_2016 = 0, SALDO_2017 = 0, ACREEDOR = 0";
			$res=$this->EjecutaQuerySimple();

			$this->query="SELECT extract(year from fecha_doc) AS ANIO,CVE_MAESTRO ,sum(saldofinal) as SF
			from factf01
			where (deuda2015 is null or (DEUDA2015 = 0))
			group by  extract(year from fecha_doc ), CVE_MAESTRO";	
		}else{


			$this->query="UPDATE MAESTROS SET SALDO_2015 = 0, SALDO_2016 = 0, SALDO_2017 = 0, ACREEDOR = 0, where clave ='$maestro'";
			$res=$this->EjecutaQuerySimple();

			$this->query="SELECT extract(year from fecha_doc) AS ANIO,CVE_MAESTRO ,sum(saldofinal) AS SF
			from factf01
			where (deuda2015 is null or (DEUDA2015 = 0)) AND STATUS <> 'C' AND CVE_MAESTRO ='$maestro'
			group by  extract(year from fecha_doc ), CVE_MAESTRO";
		}
		//echo $this->query;
		$rs=$this->QueryObtieneDatosN();

		while($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}

		foreach ($data as $key){
			if($key->ANIO == 2016){
				$this->query="UPDATE MAESTROS SET SALDO_2016 = $key->SF where clave ='$key->CVE_MAESTRO'";
				$res=$this->EjecutaQuerySimple();
				//echo $this->query.'<p>';	
			}elseif ($key->ANIO == 2017){
				$this->query="UPDATE MAESTROS SET SALDO_2017 = $key->SF where clave ='$key->CVE_MAESTRO'";
				$res=$this->EjecutaQuerySimple();
				//echo $this->query.'<p>';
			}
		}

		//// Obtenemos el saldo de los acreedores.
		$this->query="SELECT SUM(a.saldo) as saldo, cl.cve_maestro 
			from carga_pagos a 
			left join clie01 cl on trim(cl.clave) = trim(a.cliente) 
			where a.status <> 'C' and tipo_pago is null 
			group by cl.cve_maestro";

		$res=$this->QueryObtieneDatosN();
		while($tsArray=ibase_fetch_object($res)){
			$data2[]=$tsArray;
		}
		foreach ($data2 as $key){
			$this->query="UPDATE MAESTROS SET ACREEDOR= $key->SALDO where clave = '$key->CVE_MAESTRO'";
			$result =$this->EjecutaQuerySimple();
			if($result == False ){
				echo 'No se actualizo el Maestro: '.$this->query.'<p>';
			}
		}
	}


	

	function Cuentas(){
		$this->query="SELECT * from pg_bancos";
		$rs=$this->QueryObtieneDatosN();

		while($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}
		return $data;
	}

	function traeDepositos($banco){
		$this->query="SELECT EXTRACT(MONTH FROM CP1.FECHA_RECEP) AS MES ,EXTRACT(YEAR FROM CP1.FECHA_RECEP) AS ANIO, SUM(CP1.MONTO),
					(SELECT SUM(CP.MONTO) FROM CARGA_PAGOS CP WHERE CP.BANCO CONTAINING '$banco' AND EXTRACT(MONTH FROM CP.FECHA_RECEP) =  EXTRACT(MONTH FROM CP1.FECHA_RECEP) AND EXTRACT(YEAR FROM CP.FECHA_RECEP) = EXTRACT(YEAR FROM CP1.FECHA_RECEP) AND TIPO_PAGO IS NULL and CP.status <>'C') AS IPV,
					(SELECT iif(SUM(CP2.MONTO)is null,0,SUM(CP2.MONTO))  FROM CARGA_PAGOS CP2 WHERE CP2.BANCO CONTAINING '$banco' AND EXTRACT(MONTH FROM CP2.FECHA_RECEP) =  EXTRACT(MONTH FROM CP1.FECHA_RECEP) AND EXTRACT(YEAR FROM CP2.FECHA_RECEP) = EXTRACT(YEAR FROM CP1.FECHA_RECEP) AND CP2.TIPO_PAGO = 'oTEC' and CP2.status <> 'C') AS Tec,
					(SELECT iif(SUM(CP3.MONTO)is null,0,SUM(CP3.MONTO))  FROM CARGA_PAGOS CP3 WHERE CP3.BANCO CONTAINING '$banco' AND EXTRACT(MONTH FROM CP3.FECHA_RECEP) =  EXTRACT(MONTH FROM CP1.FECHA_RECEP) AND EXTRACT(YEAR FROM CP3.FECHA_RECEP) = EXTRACT(YEAR FROM CP1.FECHA_RECEP) AND CP3.TIPO_PAGO = 'DC' AND CP3.STATUS <> 'C') AS dCom,
					(SELECT iif(SUM(CP4.MONTO)is null,0,SUM(CP4.MONTO))  FROM CARGA_PAGOS CP4 WHERE CP4.BANCO CONTAINING '$banco' AND EXTRACT(MONTH FROM CP4.FECHA_RECEP) =  EXTRACT(MONTH FROM CP1.FECHA_RECEP) AND EXTRACT(YEAR FROM CP4.FECHA_RECEP) = EXTRACT(YEAR FROM CP1.FECHA_RECEP) AND CP4.TIPO_PAGO = 'DG' AND CP4.STATUS <> 'C') AS dVen,
					(SELECT iif(SUM(CP4.MONTO)is null,0,SUM(CP4.MONTO))  FROM CARGA_PAGOS CP4 WHERE CP4.BANCO CONTAINING '$banco' AND EXTRACT(MONTH FROM CP4.FECHA_RECEP) =  EXTRACT(MONTH FROM CP1.FECHA_RECEP) AND EXTRACT(YEAR FROM CP4.FECHA_RECEP) = EXTRACT(YEAR FROM CP1.FECHA_RECEP) AND CP4.TIPO_PAGO = 'oPCC' AND CP4.STATUS <> 'C') AS oPCC
					 FROM CARGA_PAGOS CP1
					 WHERE CP1.BANCO CONTAINING '$banco' and CP1.status <> 'C'
					 group by EXTRACT(MONTH FROM FECHA_RECEP), EXTRACT(YEAR FROM FECHA_RECEP) order by  EXTRACT(YEAR FROM FECHA_RECEP), EXTRACT(MONTH FROM FECHA_RECEP)";
		$rs=$this->QueryObtieneDatosN();

		while($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}
		return $data;
	}

	function traeBanco($banco){
		$this->query="SELECT * FROM PG_BANCOS WHERE NUM_CUENTA = '$banco'";
		$rs=$this->QueryObtieneDatosN();
		while($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}
		return $data;
	}

	function detalleDepositos($banco, $mes, $anio, $tipo){


		if($tipo == 'IPV'){
			$this->query="SELECT ID, CF FROM CARGA_PAGOS WHERE EXTRACT(MONTH FROM FECHA_RECEP ) = $mes AND EXTRACT(YEAR FROM FECHA_RECEP ) = $anio and CF is not null";
			$res=$this->QueryObtieneDatosN();
			while($tsArray=ibase_fetch_object($res)){
				$dataCF[]=$tsArray;
			}
				foreach ($dataCF as $key){
					$idp=$key->ID;
					$cf = $key->CF;
					$cfs = explode(',', $cf);
					$montocf = 0;
					for ($i=0; $i < count($cfs) ; $i++) {
							$this->query="SELECT MONTO FROM CARGO_FINANCIERO WHERE ID = $cfs[$i]";
							$result=$this->QueryObtieneDatosN();
							$row=ibase_fetch_object($result);
							
							if(!empty($row)){
								$monto = $row->MONTO;
								$montocf = $montocf + $monto;
							}
					}
					$this->query="UPDATE CARGA_PAGOS SET MONTO_CF = $montocf where id = $idp";
					$this->EjecutaQuerySimple();
				}

			$this->query="SELECT cp.* 
				FROM CARGA_PAGOS cp 
				WHERE cp.BANCO CONTAINING '$banco' and EXTRACT(MONTH FROM cp.FECHA_RECEP) = $mes and EXTRACT(YEAR FROM cp.FECHA_RECEP) = $anio AND tipo_pago is null and status<> 'C' order by cp.fecha_recep asc";
		}elseif($tipo =='Total'){
			$this->query="SELECT cp.* 
				FROM CARGA_PAGOS cp 
				WHERE cp.BANCO CONTAINING '$banco' and EXTRACT(MONTH FROM cp.FECHA_RECEP) = $mes and EXTRACT(YEAR FROM cp.FECHA_RECEP) = $anio and status<> 'C' order by cp.fecha_recep asc";
		}else{
			$this->query="SELECT cp.*
				FROM CARGA_PAGOS cp 
				WHERE cp.BANCO CONTAINING '$banco' and EXTRACT(MONTH FROM cp.FECHA_RECEP) = $mes and EXTRACT(YEAR FROM cp.FECHA_RECEP) = $anio and status<> 'C'  AND tipo_pago = '$tipo' order by cp.fecha_recep asc";
		}
	
		$rs=$this->QueryObtieneDatosN();
		while($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}
		return @$data;
	}

	  function traeMesesVenta(){
    	$this->query="SELECT NOMBRE, NUMERO, ANHIO, 
    				(SELECT SUM(IMPORTE) FROM FACTF01 WHERE FECHA_DOC BETWEEN FECHA_INI AND FECHA_FIN) AS FACTURADO,
    				(SELECT SUM(IMPORTE) FROM FACTF01 WHERE FECHA_DOC BETWEEN FECHA_INI AND FECHA_FIN AND STATUS = 'C') AS CANCELADO,
    				(SELECT SUM(IMPORTE_NC) FROM FACTF01 WHERE FECHA_DOC BETWEEN FECHA_INI AND FECHA_FIN) AS DEVUELTO,
    				(SELECT SUM(SALDOFINAL) FROM FACTF01 WHERE FECHA_DOC BETWEEN FECHA_INI AND FECHA_FIN) AS PENDIENTE
    				FROM PERIODOS_2016 
    				order by anhio, numero";
    	$rs=$this->QueryObtieneDatosN();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return $data;
    }

    function traeDetalle($mes, $anio, $tipo){

    	$this->query="SELECT FECHA_INI, FECHA_FIN FROM PERIODOS_2016 WHERE NUMERO = $mes and anhio = $anio";
    	$rs=$this->QueryObtieneDatosN();
    	$row=ibase_fetch_object($rs);
    	$fi = $row->FECHA_INI;
    	$ff = $row->FECHA_FIN;

    	//echo $tipo;

    	if($tipo == 'venta'){
				$this->query="SELECT f.*, cl.nombre, 
					(select folio_x_banco from carga_pagos where cast(id as varchar(10)) in (id_pagos)) as Banco  
					FROM FACTF01 f
					left join clie01 cl on cl.clave = cve_clpv
					WHERE FECHA_DOC BETWEEN '$fi' and '$ff' order by cve_doc";
    			
    	}elseif ($tipo == 'canceladas') {
    			$this->query="SELECT f.*, cl.nombre, 
					(select folio_x_banco from carga_pagos where cast(id as varchar(10)) in (id_pagos)) as Banco  
					FROM FACTF01 f
					left join clie01 cl on cl.clave = cve_clpv
					WHERE FECHA_DOC BETWEEN '$fi' and '$ff' and f.status = 'C' order by cve_doc ";	
    	}elseif ($tipo == 'devueltas') {
    			$this->query="SELECT f.*, cl.nombre, 
					(select folio_x_banco from carga_pagos where cast(id as varchar(10)) in (id_pagos)) as Banco  
					FROM FACTF01 f
					left join clie01 cl on cl.clave = cve_clpv
					WHERE FECHA_DOC BETWEEN '$fi' and '$ff' and importe_nc <> 0 order by cve_doc ";
    	}elseif ($tipo=='ventaReal') {
    			$this->query="SELECT f.*, cl.nombre, 
					(select folio_x_banco from carga_pagos where cast(id as varchar(10)) in (id_pagos)) as Banco  
					FROM FACTF01 f
					left join clie01 cl on cl.clave = cve_clpv
					WHERE FECHA_DOC BETWEEN '$fi' and '$ff' order by cve_doc";
    	}elseif ($tipo =='detalleAnual') {
    			$this->query="SELECT f.*, cl.nombre, 
					(select folio_x_banco from carga_pagos where cast(id as varchar(10)) in (id_pagos)) as Banco  
					FROM FACTF01 f
					left join clie01 cl on cl.clave = cve_clpv
					WHERE extract(year from fecha_doc) = $anio order by cve_doc";
    	}elseif ($tipo == 'pendientes'){
			$this->query="SELECT f.*, cl.nombre
					 FROM FACTF01 f
					 left join clie01 cl on cl.clave = f.cve_clpv
					  WHERE SALDOFINAL > 10 AND EXTRACT(MONTH FROM FECHA_DOC) = $mes and extract(year from fecha_doc) = $anio";
		}
    	
    	$rs = $this->QueryObtieneDatosN();
    	while ($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	//var_dump($data);
    	//break;
    	return $data;
    }

    function verAcreedores2(){

    	/*
    	$this->query="SELECT cp.fecha_recep as indice,('A-'||a.id) as ID, id_pago, cp.folio_x_banco, cp.MONTO as monto_original, cl.nombre, cp.FECHA_RECEP, a.monto, a.aplicado, a.saldo, a.status , a.cliente
    				FROM ACREEDORES a
    				left join CARGA_PAGOS cp on cp.id  = a.id_pago
    				left join CLIE01 cl on cl.clave = a.cliente
    				 WHERE a.SALDO > 5
    				 order by cp.fecha_recep";
    	$rts=$this->QueryObtieneDatosN();

    	while ($tsArray=ibase_fetch_object($rts)) {
    		$data[]=$tsArray;
    	}*/

    	$this->query="SELECT cp.ID, id AS id_pago, cp.folio_x_banco, cp.monto as monto_original, cl.nombre, cp.fecha_recep, cp.monto, cp.aplicaciones as aplicado, cp.saldo, cp.status, cliente 
    				  FROM CARGA_PAGOS cp
    				  left join clie01 cl on cl.clave = cp.cliente
    				  WHERE cp.saldo > 5
    				  AND cp.TIPO_pago is null
    				  AND cp.STATUS <> 'C' 
    				  order by cp.fecha_recep";
    	$rs=$this->EjecutaQuerySimple();

    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}


    	//var_dump($data);
    	//sort($data);

    	return $data;
    }

    function reasignaAcreedor($nclie, $ida, $oldclie, $saldo){

    	$nclie=explode(':', $nclie);
    	$clave =$nclie[0]; 

    	$this->query="SELECT CVE_MAESTRO FROM CLIE01 WHERE CLAVE = '$clave'";
    	$rs=$this->EjecutaQuerySimple();
    	$row=ibase_fetch_object($rs);
    	$cvem = $row->CVE_MAESTRO;

    	echo 'Saldo a sumar en el Maestro: '.$saldo.'<p>';

    	$this->query="SELECT SUM(SALDOFINAL) AS SALDOF FROM FACTURAS WHERE CLAVE_MAESTRO ='$cvem'";
    	$res=$this->EjecutaQuerySimple();
    	$row=ibase_fetch_object($res);
    	$saldoActual = $row->SALDOF;

    	$this->query="SELECT ACREEDOR FROM MAESTROS WHERE CLAVE = '$cvem'";
    	$res=$this->EjecutaQuerySimple();
    	$row=ibase_fetch_object($res);
    	$acreedorActual=$row->ACREEDOR;

    	$total = $saldoActual - ($saldo + $acreedorActual);

    	if ($total > 0 ){
    		$this->query="UPDATE carga_pagos SET cve_maestro = (select cve_maestro from clie01 where clave = '$clave'), cliente = '$clave' where id = $ida";
	    	$rs = $this->EjecutaQuerySimple();

    		$this->query="SELECT sum(SALDO) as Saldom, CVE_MAESTRO FROM CARGA_PAGOS WHERE STATUS <> 'C' AND TIPO_PAGO IS NULL group by CVE_MAESTRO";
    		$res = $this->EjecutaQuerySimple();

    		while($tsArray=ibase_fetch_object($res)){
    			$data[]=$tsArray;
    		} 

    		foreach($data as $key){
    			$claveM = $key->CVE_MAESTRO;
    			$monto = $key->SALDOM;

    			if($monto < 0 and $monto > -10){
    			$monto = 0;
    			}

    			$this->query="UPDATE MAESTROS SET ACREEDOR = $monto where clave ='$claveM'";
    			$result =$this->EjecutaQuerySimple();
    		}
    	}else{
    		echo '<label>'.'EL SALDO ($ '.number_format($saldoActual,2).') DEL MAESTRO ES MENOR A LA SUMA DE LOS ACREEDORES ($ '.number_format(($saldo + $acreedorActual),2).') NO SE PUEDE GENERAR SALDOS NEGATIVOS EN MAESTROS.'.'<br/>'.' REVISE LA INFORMACION'.'</label>';
    	}	
    	return;
    }


    function verFolio2015(){
    	$this->query="SELECT * 
    				FROM FACTF01 
    				left join clie01 cl on cl.clave = cve_clpv
    				left join carga_pagos cp on cast(cp.id as varchar(10)) = id_pagos and  id_pagos not containing(',')
    				WHERE APLICADO > 1 AND EXTRACT(YEAR FROM FECHA_DOC) = 2015 order by cve_doc";
    	$rs=$this->EjecutaQuerySimple();

    	//echo $this->query;
    	while($tsArray= ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}

    	return $data;
    }

    function verAplicaciones2($anio, $tipo){

    	if($tipo == 'factura' and $anio != 'todo'){
			$this->query="SELECT * 
    				FROM FACTF01 
    				left join clie01 cl on cl.clave = cve_clpv
    				left join carga_pagos cp on cast(cp.id as varchar(10)) = id_pagos and  id_pagos not containing(',')
    				WHERE APLICADO > 1 AND EXTRACT(YEAR FROM FECHA_DOC) = $anio order by cve_doc";
    	}elseif ($tipo == 'aplicacion' and $anio != 'todo') {
    		$this->query="SELECT * 
    				FROM FACTF01 
    				left join clie01 cl on cl.clave = cve_clpv
    				left join carga_pagos cp on cast(cp.id as varchar(10)) = id_pagos and  id_pagos not containing(',')
    				WHERE APLICADO > 1 AND EXTRACT(YEAR FROM FECHA_DOC) = $anio order by cve_doc";
    	}elseif ($tipo == 'pagos' and $anio != 'todo'){
    		$this->query="SELECT * 
    				FROM FACTF01 
    				left join clie01 cl on cl.clave = cve_clpv
    				left join carga_pagos cp on cast(cp.id as varchar(10)) = id_pagos and  id_pagos not containing(',')
    				WHERE APLICADO > 1 AND EXTRACT(YEAR FROM FECHA_DOC) = $anio order by cve_doc";
    	}elseif ($tipo == 'factura' and $anio == 'todo') {
    		$this->query="SELECT * 
    				FROM FACTF01 
    				left join clie01 cl on cl.clave = cve_clpv
    				left join carga_pagos cp on cast(cp.id as varchar(10)) = id_pagos and  id_pagos not containing(',')
    				WHERE APLICADO > 1 AND EXTRACT(YEAR FROM FECHA_DOC) = $anio order by cve_doc";
    	}elseif ($tipo == 'aplicacion' and $anio == 'todo') {
    		$this->query="SELECT * 
    				FROM FACTF01 
    				left join clie01 cl on cl.clave = cve_clpv
    				left join carga_pagos cp on cast(cp.id as varchar(10)) = id_pagos and  id_pagos not containing(',')
    				WHERE APLICADO > 1 AND EXTRACT(YEAR FROM FECHA_DOC) = $anio order by cve_doc";
    	}elseif ($tipo == 'pagos' and $anio == 'todo') {
    		$this->query="SELECT * 
    				FROM CARGA_PAGOS cp
    				left join factf01 f on f.id_pagos containing (cp.id)
    				left join clie01 cl on cl.clave = f.cve_clpv
    				WHERE cp.status <> 'C' and tipo_pago is null 
    				order by cp.id";
    	}
    			
    	

    	$rs = $this->EjecutaQuerySimple();
    	
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return $data;
    }


    function asignaAcreedor(){
    	/*$this->query="SELECT * FROM CARGA_PAGOS WHERE (CLIENTE IS NULL or cliente = '') and saldo <> monto and saldo > 1";
    	$rs=$this->EjecutaQuerySimple();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	foreach ($data as $key){
    		$this->query="SELECT FIRST 1  CVE_CLPV FROM FACTF01 WHERE ID_PAGO CONTAINING ('$key->ID')";
    		$rs=$this->EjecutaQuerySimple();
    		$row=ibase_fetch_object($rs);
    		$cliente = $row->CVE_CLPV;
    		$this->query="UPDATE CARGA_PAGOS SET CLIENTE = '$cliente' where id = $key->ID";
    		$rs=$this->EjecutaQuerySimple();
    	echo 'Se actualizo: ,'.$key->ID.', con el cliente, '.$cliente.'<p>';
    	}
		*/

    	$this->query="UPDATE CARGA_PAGOS SET APLICACIONES = 0";
    	$rs=$this->EjecutaQuerySimple();

    	$this->query = "SELECT * FROM APLICACIONES WHERE CANCELADO = 0";
    	$rs = $this->EjecutaQuerySimple();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data2[]=$tsArray;
    	}

    	foreach ($data2 as $key) {
    		$idp = $key->IDPAGO;
    		$this->query = "UPDATE CARGA_PAGOS SET SALDO = MONTO - (APLICACIONES + $key->MONTO_APLICADO) + MONTO_CF - MONTO_ACREEDOR, APLICACIONES = aplicaciones + $key->MONTO_APLICADO WHERE ID = $idp";
    		$rs1=$this->EjecutaQuerySimple();
    		echo 'Proceso el pago '.$idp.'<p>';
    	}

    	return;
    }

    function detallePagoFactura($docf){
    	$this->query="SELECT a.id as idaplicacion, cp.id as idpago, cl.nombre as cliente, f.importe , a.documento, cp.folio_x_banco as banco , cp.fecha_recep, a.monto_aplicado
    				FROM APLICACIONES a
    				left join factf01 f on f.cve_doc = a.documento
    				left join clie01 cl on f.cve_clpv = cl.clave
    				left join carga_pagos cp on cp.id = a.idpago
    				WHERE a.DOCUMENTO = '$docf' and cancelado = 0 ORDER BY a.FECHA ";

    				//echo $this->query;
    	$rs=$this->EjecutaQuerySimple();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}

    	return @$data;
    }

    function detallePago2($ida){
    	$this->query="SELECT cp.folio_x_banco, cp.id AS IDPAGO, cp.fecha_recep, cp.banco, cp.monto, cp.saldo, a.id as idaplicacion, a.monto_aplicado, a.fecha, a.CANCELADO AS STATUS, a.documento, cl.nombre as cliente from carga_pagos cp 
    				left join aplicaciones a on a.idpago = cp.id
    				left join factf01 f on f.cve_doc = a.documento
    				left join clie01 cl on cl.clave = f.cve_clpv
    				where cp.id = $ida";

    		$rs=$this->EjecutaQuerySimple();
    		while($tsArray=ibase_fetch_object($rs)){
    			$data[]=$tsArray;
    		}
    		return @$data;
    }

    function verCPNoIdentificados(){
    	$this->query="SELECT cp.ID, id AS id_pago, cp.folio_x_banco, cp.monto as monto_original, cl.nombre, cp.fecha_recep, cp.monto, cp.aplicaciones as aplicado, cp.saldo, cp.status, cliente 
    				  FROM CARGA_PAGOS cp
    				  left join clie01 cl on cl.clave = cp.cliente
    				  WHERE cp.saldo > 5
    				  AND cp.TIPO_pago is null
    				  AND cp.STATUS <> 'C' 
    				  AND cp.CVE_MAESTRO IS NULL
    				  order by cp.fecha_recep";
    	$rs=$this->EjecutaQuerySimple();

    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}


    	//var_dump($data);
    	//sort($data);

    	return $data;
    }

    function liberarFactura($docf){
    	$this->query="SELECT * FROM APLICACIONES WHERE DOCUMENTO = '$docf' and cancelado = 0";
    	$rs =$this->EjecutaQuerySimple();

    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}

    	foreach ($data as $key) {
    		$doc=$key->DOCUMENTO;
    		$ida=$key->ID;
    		$idp=$key->IDPAGO;
    		

    		$this->query="UPDATE APLICACIONES SET CANCELADO = 1 WHERE ID = $key->ID";
    		$res=$this->EjecutaQuerySimple();

    		$this->query="UPDATE CARGA_PAGOS SET APLICACIONES = APLICACIONES - $key->MONTO_APLICADO WHERE ID = $key->IDPAGO";
    		$res=$this->EjecutaQuerySimple();

    		$this->query="UPDATE FACTF01 SET PAGOS = PAGOS - $key->MONTO_APLICADO, aplicado = aplicado - $key->MONTO_APLICADO WHERE CVE_DOC = '$key->DOCUMENTO'";
    		$res=$this->EjecutaQuerySimple();

    		$this->query="UPDATE CARGA_PAGOS SET SALDO = MONTO - APLICACIONES + iif(MONTO_CF is null, 0, MONTO_CF) where id = $key->IDPAGO";
    		$result=$this->EjecutaQuerySimple();

    		$this->query="UPDATE FACTF01 SET SALDOFINAL = IMPORTE - APLICADO - IMPORTE_NC WHERE CVE_DOC ='$key->DOCUMENTO'";
    		$result=$this->EjecutaQuerySimple();
    	}

    		$this->query = "SELECT * FROM CARGA_PAGOS WHERE ID=$idp";
    		$rs=$this->EjecutaQuerySimple();
    		$row =ibase_fetch_object($rs);
    		$saldoCP = $row->SALDO;
    		$folioCP =$row->FOLIO_X_BANCO;
    		$fechaCP =$row->FECHA_RECEP;
    		$bancoCP =$row->BANCO;
    		$this->query= "SELECT * FROM FACTF01 WHERE CVE_DOC ='$doc'";
    		$rs=$this->EjecutaQuerySimple();
    		$row=ibase_fetch_object($rs);
    		$saldoFact=$row->SALDOFINAL;
    		echo 'Se han cancelado las aplicaciones de la factura: '.$doc.' los pago(s) afectado(s) son '.$idp;
    	return;
    }

    function liberarNCCancelada($docf){
    	$this->query="SELECT * FROM FACTD01 WHERE CVE_DOC = '$docf' and status = 'C' and aplicado <> 2";
    	$rs=$this->EjecutaQuerySimple();
    	$row=ibase_fetch_object($rs);
    	if($row == True){
    	$docANT =$row->DOC_ANT;
    	$importe = $row->IMPORTE;
    	}

    	if(!empty($docANT)){
    		$this->query="UPDATE FACTF01 SET IMPORTE_NC = IMPORTE_NC - $importe, saldofinal = saldofinal + $importe, nc_aplicadas = '' where cve_doc = '$docANT'";
    		$rs=$this->EjecutaQuerySimple();

    		echo $this->query;

    		$this->query="UPDATE FACTD01 SET APLICADO = 2 WHERE CVE_DOC = '$docf'";
    		$rs=$this->EjecutaQuerySimple();
    		echo $this->query;

    		$this->query="SELECT * FROM FACTD01 WHERE DOC_ANT = '$docANT' AND STATUS <> 'C'";
    		$rs=$this->EjecutaQuerySimple();

    		while($tsArray=ibase_fetch_object($rs)){
    			$data[]=$tsArray;
    		}

    		if(!empty($data)){
    			foreach ($data as $key) {
    				$this->query="UPDATE FACTF01 SET NC_APLICADAS = iif(nc_aplicadas = '' or nc_aplicadas is null, '$key->CVE_DOC', NC_APLICADAS||', '||'$key->CVE_DOC') WHERE CVE_DOC = $key->DOC_ANT";
    				$rs=$this->EjecutaQuerySimple();
    			}
    		}
    	}

    	return;
    }


    function infoMaestro($idm){
    	$this->query="SELECT * FROM MAESTROS WHERE ID = $idm";
    	$rs=$this->EjecutaQuerySimple();

    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}

    	return $data;
    }

    function infoSucursales($cvem){
    	/*
    	$this->query="SELECT  f.cve_clpv, sum(f.saldofinal) as total, 
        (select max(nombre) from clie01 where clave = f.cve_clpv) as nombre,
        (select max(diascred) from clie01 where clave = f.cve_clpv) as plazo,
        (select max(limcred) from clie01 where clave = f.cve_clpv) as linea_cred,
        (select sum(saldofinal) from factf01 where extract(year from fecha_doc) = 2017 and f.cve_clpv = cve_clpv) as s17,
        (select sum(saldofinal) from factf01 where extract(year from fecha_doc) = 2016 and f.cve_clpv = cve_clpv) as s16,
        (select sum(saldofinal) from factf01 where status_fact = 'Cobranza' and cve_clpv = f.cve_clpv and extract(year from fecha_doc) >= 2016) as cobranza,
        (select sum(saldofinal) from factf01 where status_fact = 'Revision' and cve_clpv = f.cve_clpv and extract(year from fecha_doc) >= 2016) as revision,
        (select sum(saldofinal) from factf01 where status_fact = 'Logistica' and cve_clpv = f.cve_clpv and extract(year from fecha_doc) >= 2016) as logistica
        from factf01 f
        where cve_maestro = '$cvem'
        AND extract(year from fecha_doc) >=2016
        group by cve_clpv
		";
		*/

		$this->query="SELECT cl.clave as cve_clpv,
			         sum(f.saldofinal) as total,
			         max(cl.nombre) as nombre,
			         max(cl.diascred) as plazo,
			         max(cl.limcred) as linea_cred ,
			         (select sum(saldofinal) from factf01 where extract(year from fecha_doc) = 2017 and cl.clave = cve_clpv) as s17,
			         (select sum(saldofinal) from factf01 where extract(year from fecha_doc) = 2016 and cl.clave = cve_clpv) as s16,
			         (select sum(saldofinal) from factf01 where status_fact = 'Cobranza' and cve_clpv = cl.clave and extract(year from fecha_doc) >= 2016) as cobranza,
			         (select sum(saldofinal) from factf01 where status_fact = 'Revision' and cve_clpv = cl.clave and extract(year from fecha_doc) >= 2016) as revision,
			         (select sum(saldofinal) from factf01 where status_fact = 'Logistica' and cve_clpv = cl.clave and extract(year from fecha_doc) >= 2016) as logistica
			         FROM CLIE01 cl
			         left join facturas f on cl.clave = f.cve_clpv
			         WHERE CVE_MAESTRO = '$cvem' and cl.status <> 'S' and cl.status <> 'B'
			         group by cl.clave";

		//echo $this->query;


    	$rs=$this->EjecutaQuerySimple();

    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return @$data;
    }

    function docsMaestro($cvem){
    	$this->query="SELECT * FROM FACTURAS WHERE CLAVE_MAESTRO = '$cvem'";
    	$rs=$this->EjecutaQuerySimple();

    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return @$data;
    }

    function docsSucursal($cvecl){
    	$this->query="SELECT * FROM FACTURAS WHERE CVE_CLPV='$cvecl'";
    	$rs=$this->EjecutaQuerySimple();

    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return @$data;
    }


    function infoDocumentos($items){
    	$doc=explode(',', $items);
    	for ($i=0; $i < count($doc); $i++) { 
    		$docf = $doc[$i];
    		$this->query="SELECT f.*, nombre from factf01 f left join clie01 on clave = cve_clpv where cve_doc = '$doc[$i]'";
    		//echo $this->query;
    		$rs=$this->EjecutaQuerySimple();
    		while($tsArray=ibase_fetch_object($rs)){
    			$data[]=$tsArray;
    		}
    	}
    	return @$data;
    }

    function verPagos3($pagos, $mes, $anio){
    	$data = array();
    	if($mes != ''){
	    	$this->query="SELECT * FROM CARGA_PAGOS WHERE UPPER(BANCO) CONTAINING UPPER('$pagos') and extract(month from fecha_recep ) = $mes and extract(year from fecha_recep) = $anio and tipo_pago is null and status<>'C' and seleccionado > 0 and guardado > 0";
			$rs=$this->EjecutaQuerySimple();
	    	while ($tsArray=ibase_fetch_object($rs)) {
	    		$data[]=$tsArray;
	    	}
	    }else{
	    	$this->query="SELECT * FROM CARGA_PAGOS WHERE MONTO CONTAINING ('$pagos') and status<>'C' and seleccionado > 0 and guardado > 0";
	    	$rs=$this->EjecutaQuerySimple();
	    	while ($tsArray=ibase_fetch_object($rs)) {
	    		$data[]=$tsArray;
	    	}
	    	$this->query="SELECT * FROM CARGA_PAGOS WHERE UPPER(FOLIO_X_BANCO) CONTAINING UPPER('$pagos') and status<>'C' and seleccionado > 0 and guardado > 0";
	    	$rs=$this->EjecutaQuerySimple();
	    	while ($tsArray=ibase_fetch_object($rs)) {
	    		$data[]=$tsArray;
	    	}
    	}	
    	return $data;    	
    }

    function verPagoParaComprobante($idp){
    	$this->query="SELECT * FROM CARGA_PAGOS WHERE ID =$idp";
    	$rs=$this->EjecutaQuerySimple();
    	while ($tsArray=ibase_fetch_object($rs)) {
    		$data[]=$tsArray;
    	}
    	return $data;
    }

    function aplicarPago2($idp, $saldop, $items, $total, $retorno){
    	$resultado = $saldop - $total;
    	$user = $_SESSION['user']->NOMBRE;
    		/// Saldo 10,000.00 Facturas 8,000.00 resultaod 2,000.00
    	$saldoPago = $saldop; 
    	if($resultado >= -3 ){
    		$docf= explode(',', $items);
    		for($i=0;$i<count($docf); $i++){
    			$montoAplicar = 0;
    				$documento = $docf[$i];
    				if(substr($documento, 0,3) == 'FAA' or (substr($documento, 0,2) == 'RF' and substr($documento, 0,3) != 'RFP')){
    					$tabla = 'FACTF01';
    					$tablaUpd= 'FACTF01';
    					$campo = 'CVE_DOC';
    					$campoUpd = 'CVE_DOC';
    				}else{
    					$tabla = 'FACTURAS_FP';
    					$campo = 'CVE_DOC';
    					$campoUpd = 'documento';
    					$tablaUpd= 'FTC_FACTURAS';
    				}

    					$this->query = "SELECT * FROM $tabla WHERE trim($campo) = trim('$docf[$i]')";
	    				$rs=$this->EjecutaQuerySimple();
	    				$row = ibase_fetch_object($rs);
	    				//exit($this->query);
    			/// insertamos la nueva aplicacion.
	    			if($row->SALDOFINAL > 0){
	    				$montoAplicar=$row->SALDOFINAL;
	    				$saldoPago = $saldoPago -$row->SALDOFINAL; 
	    			$this->query="INSERT INTO APLICACIONES (ID, FECHA, IDPAGO, DOCUMENTO, MONTO_APLICADO, SALDO_DOC, SALDO_PAGO, USUARIO, STATUS, RFC, FORMA_PAGO, CANCELADO, PROCESADO, CIERRE_CC, REC_CONTA) 
	    									VALUES (NULL, current_timestamp, $idp, '$docf[$i]', $row->SALDOFINAL, 0, $saldoPago, '$user','E' ,'$row->RFC', '$idp', 0,  0, 0, 0)";
	    			$res=$this->EjecutaQuerySimple();
	    			/// Calculamos los nuevos saldo y totales.
	    			// Saldo del Pago
	    			$this->query="UPDATE CARGA_PAGOS SET APLICACIONES = APLICACIONES + $row->SALDOFINAL, SALDO = saldo - $row->SALDOFINAL WHERE ID = $idp";
	    			$rs = $this->EjecutaQuerySimple();

	    			$this->query="SELECT * FROM CARGA_PAGOS WHERE ID = $idp";
	    			$res=$this->EjecutaQuerySimple();
	    			$info=ibase_fetch_object($res);
	    			if($info->CLIENTE){
	    				$this->query="UPDATE MAESTROS SET ACREEDOR = ACREEDOR-$row->SALDOFINAL WHERE ID = $info->CLIENTE";
	    				$this->queryActualiza();
	    			}

	    			/// Saldo del Documento
	    			if($tablaUpd =='FTC_FACTURAS'){
						$this->query="UPDATE FTC_FACTURAS SET monto_aplicaciones = monto_aplicaciones + $row->SALDOFINAL, monto_pagos = monto_pagos + $row->SALDOFINAL, SALDO_FINAL = TOTAL - $row->SALDOFINAL - $row->IMPORTE_NC - MONTO_APLICACIONES
	    							WHERE DOCUMENTO = '$row->CVE_DOC'";
		    			$res=$this->EjecutaQuerySimple();		
	    			}else{
	    				$this->query="UPDATE $tablaUpd SET aplicado = aplicado + $row->SALDOFINAL, pagos = pagos + $row->SALDOFINAL, SALDOFINAL = IMPORTE - $row->SALDOFINAL - $row->IMPORTE_NC - APLICADO
	    							WHERE $campoUpd = '$row->CVE_DOC'";
		    			$res=$this->EjecutaQuerySimple();		
	    			}
	    			
	    			$this->query="SELECT MAX(ID) as ID  FROM APLICACIONES WHERE DOCUMENTO = '$row->CVE_DOC' and PROCESADO = 0";
	    			$res=$this->EjecutaQuerySimple();
	    			$row2=ibase_fetch_object($res);
	    			//echo $this->query.'<p>';

	    			$this->query="UPDATE APLICACIONES SET PROCESADO = 1 WHERE ID = $row2->ID";
	    			$result=$this->EjecutaQuerySimple();

	    			$this->query="UPDATE FTC_REGISTRO_COBRANZA SET APLICACION = '$row2->ID', MONTO_APLICACION= (SELECT MONTO_APLICADO FROM APLICACIONES WHERE ID = $row2->ID ) WHERE DOCUMENTO = '$docf[$i]' and MARCA = 'A'";
	    			$this->EjecutaQuerySimple();

	    			// Actualizamos la factura con sus pagos;
	    			if($tablaUpd == 'FTC_FACTURAS'){
	    				$this->query="UPDATE FTC_FACTURAS SET ID_APLICACIONES = IIF(id_aplicaciones is null or id_aplicaciones= '', '$row2->ID', id_aplicaciones||', '||'$row2->ID'),
	    			 		id_pagos= iif(id_pagos is null or id_pagos='', '$idp', id_pagos||', '||'$idp')
	    			 		where DOCUMENTO = '$row->CVE_DOC'";
	    			}else{
	    				$this->query="UPDATE $tablaUpd SET ID_APLICACIONES = IIF(id_aplicaciones is null or id_aplicaciones= '', '$row2->ID', id_aplicaciones||', '||'$row2->ID'),
	    			 		id_pagos= iif(id_pagos is null or id_pagos='', '$idp', id_pagos||', '||'$idp')
	    			 		where $campoUpd = '$row->CVE_DOC'";
	    			}
	    			$rs=$this->EjecutaQuerySimple();

	    			//echo $this->query.'<p>';
	    			/// final
	    			/// Analizamos la situacion del cliente
		    			$this->query="SELECT * FROM CLIE01 WHERE CLAVE = '$row->CVE_CLPV'";
		    			//echo 'Traemos al cliente'.$this->query.'<p>';
		    			$res4=$this->EjecutaQuerySimple();
		    			$row4 = ibase_fetch_object($res4);
		    			if(!empty($row4->STATUS_COBRANZA)){
		    					//echo 'El cliente esta suspendido'.'<p>';
								$this->query="SELECT min(datediff(day from current_date to fecha_vencimiento)) as dias, COUNT(CVE_DOC) AS DOCS 
												from $tabla
											    where cve_clpv = '$row4->CLAVE'
											        and status_fact = 'Cobranza'
											        and extract(year from fecha_doc) >= 2016
											        and saldofinal >= 5 ";
								$rs5 = $this->EjecutaQuerySimple();
								$row5 = ibase_fetch_object($rs5);
								//echo 'Traemos los documentos : '.$this->query.'<p>';
								if ($row5->DIAS > -7){
								//	echo 'Ya no tiene documentos';
									$this->query="UPDATE CLIE01 SET STATUS_COBRANZA = NULL, inicio_corte = null, finaliza_corte= null, monto_cobranza= 0 , saldo_monto_cobranza = 0 where clave ='$row4->CLAVE'";
									$rs=$this->EjecutaQuerySimple();
								//	echo 'Libera el Cliente'.$this->query.'<p>';
								}
		    			}
	    			}else {

		    			if($retorno == 'cobranza'){
		    				return $row->CVE_MAESTRO;
		    			}else{
		    				return $row->CVE_CLPV;	
		    			}
	    			}
    		}
    	}else{
    		echo 'El pago es parcial';
    	}
	    	if($retorno == 'cobranza'){
	    		return $row->CVE_MAESTRO;
	    	}else{
	   		 	return $row->CVE_CLPV;		
	    	}
	    exit('Revisar');
    }



    function aplicacionesSinReciboConta(){
    	$this->query="SELECT idpago 
    					FROM APLICACIONES 
    					WHERE usuario_rec_conta is null and status <> 'C' and cancelado = 0 and extract(month from fecha) > 1 and extract(year from fecha) >= 2017
    					group by idpago";
    	$rs=$this->EjecutaQuerySimple();

    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}

    	foreach ($data as $key) {
    		$idp= $key->IDPAGO;

    		$this->query="SELECT * FROM CARGA_PAGOS WHERE ID = $idp";
    		$res=$this->EjecutaQuerySimple();

    		while($tsArray=ibase_fetch_object($res)){
    			$data2[]=$tsArray;
    		}
    	}

    	return @$data2;
    }


    function liberaPedidovsNC($docp, $docd){

    	$docp=strtoupper($docp);
    	$docd= strtoupper($docd);


    	//NRB3 1831
    	///PY126
    	echo $docp;
    	echo $docd;

    	$this->query="SELECT * FROM PAR_FACTD01 WHERE CVE_DOC = '$docd' ";
    	$rs=$this->EjecutaQuerySimple();

    	while($tsArray=ibase_fetch_object($rs)){
    			$data[]=$tsArray;
    		}

    	foreach ($data as $key) {
    		$this->query="SELECT * FROM PAR_FACTP01 WHERE CVE_DOC = '$docp' and CVE_ART = '$key->CVE_ART'";
    		$res=$this->EjecutaQuerySimple();
    		$row = ibase_fetch_object($res);
    		$cantp = $row->CANT;

    		$this->query="UPDATE FACTP01 SET DOC_SIG = NULL, ENLAZADO = 'O' WHERE CVE_DOC = '$docp'";
    		$this->EjecutaQuerySimple();

    		if($key->CANT > $cantp){
    			$this->query="UPDATE PAR_FACTP01 SET pxs = cant where CVE_ART = '$key->CVE_ART' and cve_doc = '$docp'";
	    		$rs=$this->EjecutaQuerySimple();

    		}else{
    			$this->query="UPDATE PAR_FACTP01 SET pxs = pxs + $key->CANT where CVE_ART = '$key->CVE_ART' and cve_doc = '$docp'";
	    		$rs=$this->EjecutaQuerySimple();
    		}
    	}

    	return;
    }

    function verCargaPagosCXC(){
    	$this->query="SELECT * FROM CARGA_PAGOS WHERE CIERRE_CONTA IS NULL and status <> 'C'";
    	$rs=$this->EjecutaQuerySimple();

    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}

    	return  @$data; 
    }


    function verCargaPagosCXCCerrados(){
    	$this->query="SELECT * FROM CARGA_PAGOS WHERE CIERRE_CONTA = 1 and status <> 'C'";
    	$rs=$this->EjecutaQuerySimple();

    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return  @$data; 
    }

    function verCargaPagosCXCAcreedores(){
    	$this->query="SELECT * FROM CARGA_PAGOS WHERE CIERRE_CONTA = 4 and status <> 'C'";
    	$rs=$this->EjecutaQuerySimple();

    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return  @$data; 	
    }

    function cerrarPago($idp){
    	$this->query="UPDATE carga_pagos set cierre_conta = 1 where id = $idp";
    	$rs=$this->EjecutaQuerySimple();

    	return;
    }

    function solAcreedor($idp, $saldo){
    	$this->query="UPDATE CARGA_PAGOS SET cierre_conta = 4 where id= $idp";
    	$rs=$this->EjecutaQuerySimple();
    	return;
    }

    function recCierreCob(){
    	$this->query="SELECT * FROM CARGA_PAGOS WHERE (CIERRE_CONTA = 1 or cierre_conta = 4)  and status <> 'C'";
    	$rs=$this->EjecutaQuerySimple();

    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return  @$data; 
    }

    function traeSolicitudesR($cliente){
    	$this->query="SELECT COUNT(CVE_CLPV) FROM SOL_CLIENTES WHERE STATUS = 1 and cve_clpv = '$cliente'";
    	$rs=$this->EjecutaQuerySimple();
    	$row=ibase_fetch_object($rs);
    	$sol=$row->COUNT;
    	return $sol;
    }

    function traeSolicitudesC($cliente){
    	$this->query="SELECT COUNT(CVE_CLPV) FROM SOL_CLIENTES WHERE STATUS = 2 and cve_clpv = '$cliente' ";
    	$rs=$this->EjecutaQuerySimple();
    	$row=ibase_fetch_object($rs);
    	$sol=$row->COUNT;
    	return $sol;	
    }

    function verSolClientes(){
    	$this->query="SELECT sc.id, sc.CVE_CLPV, cl.NOMBRE, sc.fecha_sol, sc.usuario_sol, sc.status, m.NOMBRE AS MAESTRO, cl.cve_maestro, cl.limcred, cl.diascred,
    	(select sum(saldofinal) from facturas where cve_clpv = sc.cve_clpv and status_fact = 'Cobranza') as saldoCobranza ,
    	(select sum(fp.importe) from factp01 fp where fp.cve_clpv = sc.cve_clpv and fp.status <> 'C' and (tip_doc_sig is null or tip_doc_sig = '')) as montoPedidos,
    	(select sum(fr.importe) from factr01 fr where fr.cve_clpv = sc.cve_clpv and fr.status <> 'C' and (tip_doc_sig is null or tip_doc_sig = '')) as montoRemisiones, 
    	(select sum(ft.dbimptot) from FTC_COTIZACION ft where ft.cve_cliente = sc.cve_clpv and ft.instatus = 'PENDIENTE') as cotizaciones,
    	(select sum(saldofinal) from facturas where cve_clpv = sc.cve_clpv and status_fact <> 'Cobranza') as facturado
    	from sol_clientes sc 
    	inner join clie01 cl on cl.clave = sc.cve_clpv 
    	inner join maestros m on m.clave = cl.cve_maestro
    	where (sc.status =  1 or sc.status = 2)";
    	$rs=$this->EjecutaQuerySimple();

    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return @$data;
    }

     function verClientesCorte(){
    	$this->query="SELECT CL.*, M.NOMBRE AS MAESTRO,
    					(select sum(saldofinal) from facturas where cve_clpv = CL.CLAVE and status_fact = 'Cobranza') as saldoCobranza ,
    					(select sum(fp.importe) from factp01 fp where fp.cve_clpv = CL.CLAVE and fp.status <> 'C' and (tip_doc_sig is null or tip_doc_sig = '')) as montoPedidos,
    					(select sum(fr.importe) from factr01 fr where fr.cve_clpv = CL.CLAVE and fr.status <> 'C' and (tip_doc_sig is null or tip_doc_sig = '')) as montoRemisiones,
    					(select sum(ft.dbimptot) from FTC_COTIZACION ft where ft.cve_cliente = CL.CLAVE and ft.instatus = 'PENDIENTE') as cotizaciones,
    					(select sum(saldofinal) from facturas where cve_clpv = CL.CLAVE and status_fact <> 'Cobranza') as facturado
    	 			FROM CLIE01 CL
    	 			LEFT JOIN MAESTROS M ON M.CLAVE = CL.CVE_MAESTRO 
    	 			WHERE CL.STATUS_COBRANZA= 1 ";
    	$rs=$this->EjecutaQuerySimple();

    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return @$data;
    }


    function cortarCredito($cveclie, $idsolc, $fecha, $monto){
    	$this->query="UPDATE CLIE01 SET STATUS_COBRANZA  = 2, inicio_corte=current_timestamp ,finaliza_corte=dateadd(day, $fecha, current_timestamp), monto_cobranza = $monto, saldo_monto_cobranza = $monto  WHERE TRIM(CLAVE) = TRIM('$cveclie')";
    	$rs=$this->EjecutaQuerySimple();

    	$this->query="UPDATE SOL_CLIENTES SET STATUS = 3 where id = $idsolc";
    	$rs=$this->EjecutaQuerySimple();

    	return;
    }

    function traeStatusClie($cliente){
    	$this->query="SELECT cl.*, m.id as idm
    					FROM CLIE01  cl
    					inner join maestros  m  on m.clave = cl.cve_maestro
    					WHERE trim(cl.CLAVE) = trim('$cliente')";
    	$rs=$this->EjecutaQuerySimple();

    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return @$data;
    }

    function liberarDeCorte($cveclie, $monto, $dias){
    	    	$this->query="UPDATE CLIE01 SET STATUS_COBRANZA  = 2, inicio_corte=current_timestamp ,finaliza_corte=dateadd(day, $dias, current_timestamp), monto_cobranza = $monto, saldo_monto_cobranza = $monto  WHERE TRIM(CLAVE) = TRIM('$cveclie')";
    	$rs=$this->EjecutaQuerySimple();

    	return;
    }


    function analisis($idpreoc, $fechaIni, $fechaFin){
    		//// Seleccionamos la cantidad validada.
    	$this->query="SELECT ID FROM PREOC01 WHERE FECHASOL >= '$fechaIni' and FECHASOL <= '$fechaFin' and (fact_ant <> 'P' or fact_ant is null)";
    	$rs=$this->EjecutaQuerySimple();

	    	while($tsArray = ibase_fetch_object($rs)){
	    		$dat[] = $tsArray;
	    	}

    	echo 'Consulta: '.$this->query.'<p>';
    	//break;

    	$ids = 0;
    	foreach($dat as $key){
    		$idpreoc = $key->ID;

    		$this->query = "SELECT iif(max(cant_validada) is null, 0, max(cant_validada)) as validado  from valida_recepcion where id_preoc = $idpreoc";
    		$rs=$this->EjecutaQuerySimple();
    		$row = ibase_fetch_object($rs);
    		$validado =$row->VALIDADO;
    		
    		$this->query="UPDATE PREOC01 SET FACT_ANT = 'P' WHERE ID =$idpreoc";
    		$this->EjecutaQuerySimple();

    		//// Seleccionamos lo recibido  (que debe de ser igual a lo validado) y la cantidad Original y la cotizacion.
    		$this->query="SELECT * FROM PREOC01 WHERE ID = $idpreoc";
    		$rs=$this->EjecutaQuerySimple();
    		$preoc = ibase_fetch_object($rs);
    		$valPreoc = $preoc->RECEPCION;
    		$cotizacion = $preoc->COTIZA;
    		$original = $preoc->CANT_ORIG;
    		$fechasol =$preoc->FECHASOL;
    		/// Vemos que lo validado sea igual a lo recibido.

    		if($validado <> $valPreoc){
    			echo 'Diferencia de Validacion con Recepcion'.$idpreoc.', validado = '. $validado.', recepcionado  = '.$valPreoc.'<p>';
    			$this->query ="UPDATE PREOC01 SET RECIBIDO = $validado WHERE ID = $idpreoc";
    			//$rs=$this->EjecutaQuerySimple(); 
    		}
    		//// Si lo validado es mayor a la cantidad original, se envia el mensaje a la consola;
    		
    		if($validado > $original){
    			echo 'Se valido mas de lo solicitado '.$idpreoc.', validado = '.$validado.' original, '.$original.'<p>';
    		}
    			/// Seleccionamos los pendientes en Orden de Compra.
		    	$data2 = array();
		    	$this->query="SELECT iif(PXR is null, 0, PXR) as pxr, NUM_PAR, CVE_DOC FROM PAR_COMPO01 WHERE ID_PREOC = $idpreoc and pxr > 0";
		    	$rs=$this->EjecutaQuerySimple();

		    	while($tsArray=ibase_fetch_object($rs)){
		    		$data2[]=$tsArray;
		    	}
		    	/// Si existen pendientes, entonces sumamos la pendientes + lo validado y lo comparamos con los solicitado.
		    	$pendientes= 0;
		    	if(count($data2)> 0){
		    		foreach ($data2 as $pendiente) {
		    		$this->query="SELECT PXR FROM PAR_COMPO01 WHERE ID_PREOC = $idpreoc and pxr > 0";
		    		$rs=$this->EjecutaQuerySimple();
		    		$row3=ibase_fetch_object($rs);
		    		$pendientes = $pendientes + $row3->PXR;
		    		}
		    	}
		    	
		    	$ordenado = $pendientes;
		    	$pendientes = $pendientes + $validado;
		    		
		    		/// Si es mayor lo pendiente y validado con lo solicitado creeamos una anomalia.

		    	if($pendientes > $original){
		    		echo 'Se ha solicitado mas de lo que requiere el pedido: '.$original.', validado: '.$validado.', pendientes, '.$pendientes.'<p>';
		    		$anomalia = $original - $pendientes;
		    		$this->query="INSERT INTO ANOMALIAS (ID, ID_PREOC, COTIZACION, CANT_ORIG, CANT_VALIDADA, CANT_PENDIENTE, ANOMALIA, FECHA, FECHA_SOL )
		    				VALUES (NULL, $idpreoc, '$cotizacion', $original, $validado, $ordenado, $anomalia, current_timestamp, '$fechasol')";
		    		$rs=$this->EjecutaQuerySimple();
		    	}
		    	$ids = $ids + 1;
		}
		    	$fin='Se procesaron '.$ids.'<p>';
		   return $fin;
    }


    function verFacturasCres(){
    	$this->query="SELECT FIRST 1000 X.*, (SELECT FIRST 1 NOMBRE FROM CLIE01 WHERE RFC = CLIENTE) AS NOMBRE
		FROM XML_DATA X";
    	$rs=$this->EjecutaQuerySimple();

    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return @$data;
    }

    function verDeudores(){
    	$data=array();
    	$this->query="SELECT poc.id_Preoc, poc.cve_doc, poc.cve_art,
    					poc.cant, poc.pxr,
    					(select nombre from producto_ftc pftc where poc.cve_art = pftc.clave) as CAMPLIB7,
    					oc.fechaelab,
    					(SELECT NOMBRE FROM PROV01 P WHERE P.CLAVE = oc.cve_clpv) as nombre,
    					datediff(day, oc.fechaelab, current_timestamp) as dias
    					, poc.fecha_doc_recep
    					, poc.doc_recep
    					, poc.doc_recep_status
    					, poc.vuelta
    					, poc.num_par
    		 			FROM PAR_COMPO01 poc 
    		 			LEFT JOIN COMPO01 oc on oc.cve_doc = poc.cve_doc 
    		 			where poc.status_log2 ='Tesoreria' 
    		 			and poc.pxr > 0 
    		 			and extract(year from oc.fechaelab) >= 2017  
    		 			order by poc.cve_doc asc";
    	$rs=$this->EjecutaQuerySimple();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}

    	$this->query="SELECT poc.IDPREOC AS id_preoc, poc.oc as cve_doc,  poc.art as cve_art, 
                             poc.cantidad as cant , poc.pxr,
                             (select nombre from producto_ftc pftc where pftc.clave_ftc = substring(poc.art from 4 for 10) )as camplib7,
                              oc.fecha_oc as fechaelab,
                            (select nombre from prov01 p where p.clave = oc.cve_prov) as nombre,
                            datediff(day, oc.fecha_oc, current_timestamp) as dias
                            , '' as fecha_doc_recep
                            , '' as doc_recep
                            , '' as doc_recep_status
                            , poc.vuelta
                            , poc.partida as num_par
                            from FTC_POC_DETALLE poc 
                            left join FTC_POC oc on oc.cve_doc = poc.cve_doc
                            --left join producto_ftc pftc on pftc.clave_ftc = substring(poc.art from 4 for 10) 
                            WHERE poc.STATUS_LOG2 = 'Tesoreria' and poc.pxr >0";
    	$rs=$this->EjecutaQuerySimple();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}

    	return @$data;
    }


    function recepcionOC(){
    	$this->query="SELECT 
	    	oc.cve_doc
	    	,max(doc_sig) as ultima_Remision 
	    	,max(importe) as importeOC
	        ,(select max(nombre) from prov01 p where p.clave = max(oc.cve_clpv)) as nombre
	        ,sum(poc.pxr) as PendientesXRecibir
	        ,max(fechaelab) as fechaOC
	        ,max(oc.cve_clpv) as cve_clpv
	        ,max(poc.usuario_php) as usuario
	        ,max(poc.cost) as costo
	        ,max(poc.pxr) as pxr
	        ,max(oc.urgente) as urgencia
	        ,max(poc.vuelta) as vuelta
	        ,sum(poc.cant) as cantidad
	        ,max(oc.status_recepcion) as status_recepcion
	        , max(oc.UNIDAD) AS unidad
	        ,max(oc.vueltas) as vueltas 
	        , (select max(OPERADOR) FROM UNIDADES WHERE NUMERO = MAX(oc.unidad)) as operador
	                         FROM COMPO01 oc 
	                         left join par_compo01 poc on poc.cve_doc = oc.cve_doc
	                         WHERE (STATUS_LOG = 'Total' or STATUS_LOG = 'secuencia' or status_log = 'admon' or status_log = 'Tiempo' or ruta = 'A') 
	                         and (status_recepcion is null or status_recepcion = 9)
	                         and extract(year from oc.fechaelab )>= 2017
	                         group by oc.cve_doc 
	                         having sum(poc.pxr) > 0";
    	$rs=$this->EjecutaQuerySimple();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	} 
    	$this->query="SELECT 
                            ftc.oc as cve_doc
                            ,'' as doc_sig
                            ,max(ftc.COSTO_TOTAL) as importeOC
                            , max(p.nombre) as nombre
                            ,sum(ftcpoc.pxr) AS PendientesXRecibir
                            , max(fecha_oc) as fechaoc
                            , max(p.clave) as cve_clpv
                            , max(ftc.usuario_oc) as usuario
                            , max(ftc.costo_total) as costo
                            , sum(ftcpoc.pxr) as pxr
                            , '' as urgencia
                            , max(ftc.vueltas) as vuelta
                            , sum(FTCPOC.cantidad) as cantidad
                            , max(ftc.status_recepcion) as status_recepcion
                            , max(ftc.unidad) as unidad
                            , max(ftc.vueltas) as vueltas
                            , (select max(operador) from unidades where numero = max(ftc.unidad) ) as operador
                            , max(ftc.FECHA_ENTREGA) AS FECHA_ENTREGA
                            , max(ftc.status_log) as status_log
                            from ftc_poc ftc
                            left join FTC_POC_DETALLE ftcpoc on ftcpoc.cve_doc = ftc.cve_doc
                            left join prov01 p on p.clave = ftc.cve_prov
                            left join FTC_DOC_RECOLECCION fr on fr.doc = ftc.id
                            where
                            (ftc.status_log = 'Total' or ftc.status_log='Nuevo' or ftc.status_log='secuencia' or ftc.status_log = 'admon')
                            and (status_recepcion is null or status_recepcion =9) 
                            and ftc.fecha_pago is not null 
                            group by ftc.oc
                            having sum(ftcpoc.pxr) > 0 ";
        $rs=$this->EjecutaQuerySimple();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	} 
    	return @$data;
    }

     function cierreRecep($doco){
    	$this->query="SELECT COUNT(NUM_PAR) AS PARTIDAS FROM PAR_COMPO01 WHERE CANT_RECIBIDA IS NOT NULL AND CVE_DOC = '$doco'";
    	$rs=$this->EjecutaQuerySimple();
    	$row = ibase_fetch_object($rs);
    	$partida=$row->PARTIDAS;

    	$this->query="SELECT MAX(NUM_PAR) AS TOT_PAR FROM PAR_COMPO01 WHERE CVE_DOC = '$doco' ";
    	$rs=$this->EjecutaQuerySimple();
    	$row2=ibase_fetch_object($rs);
    	$tot_partida = $row2->TOT_PAR;

    	$val = $tot_partida - $partida;
    	return $val;
    }

    function recibeParOC($cantidad, $idp, $doco, $partida){
    	$usuario=$_SESSION['user']->NOMBRE;
    	$a='';
    	if(substr($doco, 0, 2) == 'OP'){
    		$this->query="SELECT STATUS_RECEPCION, USUARIO_RECIBE FROM FTC_POC WHERE OC = '$doco'";
		    	$rs=$this->EjecutaQuerySimple();
		    	$row = ibase_fetch_object($rs);
		    	$nombre = $row->USUARIO_RECIBE;
		    	$status = $row->STATUS_RECEPCION;
    	}else{
    		$this->query="SELECT STATUS_RECEPCION, USUARIO_RECIBE FROM compo01 WHERE cve_doc = '$doco'";
		    	$rs=$this->EjecutaQuerySimple();
		    	$row = ibase_fetch_object($rs);
		    	$nombre = $row->USUARIO_RECIBE;
		    	$status = $row->STATUS_RECEPCION;
    	}
    	if($nombre == $usuario ){
    		$this->query="SELECT * FROM FTC_POC_DETALLE WHERE IDPREOC = $idp and OC = '$doco' and partida = $partida";
    		$res=$this->EjecutaQuerySimple();
    		$row=ibase_fetch_object($res);
    		$pxr = $row->PXR;
    			if($cantidad > $pxr or $cantidad < 0){
    				$this->query="UPDATE PAR_COMPO01 SET CANT_RECIBIDA = 0, usuario_recibe = '$usuario', STATUS_VAL = 9 where cve_doc = '$doco' and num_par = $partida and id_preoc =$idp";
		    		$rs =$this->queryActualiza();
	    			$this->query="UPDATE FTC_POC_DETALLE set CANT_RECIBIDA = 0, usuario_recibe = '$usuario', status_val = 9 where oc = '$doco' and partida = $partida and idpreoc = $idp";
	    			$res=$this->EjecutaQuerySimple();
    				$response=array("status"=>'cant',"mensaje"=>'Se intenta colocar mas de lo requirido');
    			}else{
		    		$this->query="UPDATE PAR_COMPO01 SET CANT_RECIBIDA = $cantidad, usuario_recibe = '$usuario', STATUS_VAL = 9 where cve_doc = '$doco' and num_par = $partida and id_preoc =$idp";
		    		$rs =$this->queryActualiza();
	    			$this->query="UPDATE FTC_POC_DETALLE set CANT_RECIBIDA = $cantidad, usuario_recibe = '$usuario', status_val = 9 where oc = '$doco' and partida = $partida and idpreoc = $idp";
	    			$res=$this->EjecutaQuerySimple();
			    	if($res==1){
		    			$response = array("status"=>"ok","mensaje"=>"Se a pre-regsitrado el ingreso");
			    	}else{
			    		$response = array("status"=>"ok","mensaje"=>"Algo no salio como se esperaba, favor de volver a intentar");
			    	}
		    	}	
    	}else{
    		$reponse = array("status"=>'no',"mensaje"=>'Esta siendo modificada por otro usuario');
    	}
    	return  $response;
    }

    function validaOC($doco){
    	if(substr($doco, 0, 2) == 'OP'){
    		$this->query="SELECT iif(status_recepcion is null, 'A', 'B'||' - Por el Usuario: '||USUARIO_RECIBE) as resultado from ftc_poc where oc = '$doco'";

    	}else{
    		$this->query="SELECT IIF(STATUS_RECEPCION is null, 'A', 'B'||' - Por el Usuario: '||USUARIO_RECIBE) as resultado FROM COMPO01 WHERE CVE_DOC ='$doco'";	
    	}
    	$rs=$this->EjecutaQuerySimple();
    	$row =ibase_fetch_object($rs);
    	$val=$row->RESULTADO;
    	return $val;
    }




function cerrarRecepcion($doco){
    	$data=array();
    	$usuario = $_SESSION['user']->NOMBRE;
    	$rol = $_SESSION['user']->USER_ROL;
    	$poc = '';
    	echo 'Doco:'.$doco.'<br/>';
    	if(substr($doco, 0, 2) == 'OP'){
    		$this->query="SELECT STATUS_RECEPCION, USUARIO_RECIBE, cve_doc FROM FTC_POC WHERE OC = '$doco'";
		    	$rs=$this->EjecutaQuerySimple();
		    	$row = ibase_fetch_object($rs);
		    	$nombre = $row->USUARIO_RECIBE;
		    	$status = $row->STATUS_RECEPCION;
		    	$poc = $row->CVE_DOC;
    	}else{
    		$this->query="SELECT STATUS_RECEPCION, USUARIO_RECIBE FROM compo01 WHERE cve_doc = '$doco'";
		    	$rs=$this->EjecutaQuerySimple();
		    	$row = ibase_fetch_object($rs);
		    	$nombre = $row->USUARIO_RECIBE;
		    	$status = $row->STATUS_RECEPCION;
    	}
    	
    	if($nombre == $usuario and $status == 9 ){
		    	if(substr($doco, 0,2) == 'OP'){
		    		$this->query="UPDATE FTC_POC SET STATUS_RECEPCION = 2, STATUS_LOG = 'Validada', STATUS='RECEPCIONADA' where oc = '$doco'";
		    		$this->queryActualiza(); /// Actualiza la Orden para cerrar la recepcion.
		   			$this->query="SELECT MAX(ID_RECEPCION) AS FOLIO FROM FTC_DETALLE_RECEPCIONES"; // Seleciona el Folio.
			    	$rs=$this->EjecutaQuerySimple();
			    	$row =ibase_fetch_object($rs);
			    	$foln = $row->FOLIO + 1;
			    	$this->query="SELECT PARTIDA, CANTIDAD, iif(status_val is null, 0, CANT_RECIBIDA) as Cant_Recibida, IDPREOC, PXR, ART, COSTO, UM from FTC_POC_DETALLE WHERE OC = '$doco'";
			    	$rs=$this->EjecutaQuerySimple();  /// Obtiene la informacion capturada durante la recepcion.
			    	while($tsArray=ibase_fetch_object($rs)){
			    		$data[]=$tsArray;
			    	}
			    	foreach ($data as $key) {
			    		$cant_rec = $key->CANT_RECIBIDA;
			    		//echo '<br/>Cant_Rec: '.$cant_rec.'<br/>';
			    		$this->query="UPDATE FTC_POC_DETALLE SET PXR = PXR - $key->CANT_RECIBIDA, status_val = null, status_real = 'Recibido' where OC = '$doco' and partida = $key->PARTIDA";
			    		$RA=$this->queryActualiza();
			    		///// Revisar y validar la actualizacion ... 
				    		if($rol == 'bodega2'){ ///INGRESO A BODEGA.
				    			//echo 'Ingreso a bodega';
				    			$equipo=gethostname();
			    						$this->query="INSERT INTO INGRESOBODEGA (ID, DESCRIPCION, CANT, FECHA, MARCA, PROVEEDOR, COSTO, UNIDAD, PRODUCTO, RESTANTE, ASIGNADO, USUARIO, RECIBIDO, ORIGEN, documento)
			    						  VALUES (NULL, (SELECT NOMBRE FROM PRODUCTO_FTC WHERE CLAVE = '$key->ART'), $key->CANT_RECIBIDA, CURRENT_TIMESTAMP, (SELECT MARCA FROM PRODUCTO_FTC WHERE CLAVE = '$key->ART'), (SELECT CVE_PROV FROM FTC_POC WHERE OC = '$doco'), $key->COSTO,  '$key->UM','$key->ART', 0,0, (substring('$usuario' from 1 for 49)||' ('||substring('$equipo' from 1 for 18)||')'), 0, 'Orden Interna', '$doco')";
			    						$this->grabaBD();
			    						//echo $this->query;
			    						//// No se carga en FTC_DETALLE_RECEPCIONES POR QUE SE CREARIA UNA DOBLE ENTRADA AL INVENTARIO.
						    			//$this->query="INSERT INTO FTC_DETALLE_RECEPCIONES (ID, ORDEN, IDPREOC, CANTIDAD_OC, CANTIDAD_REC, PARTIDA, status, fecha, usuario, ID_RECEPCION, poc) VALUES (NULL, '$doco', $key->IDPREOC, $key->CANTIDAD, $key->CANT_RECIBIDA, $key->PARTIDA, 0, current_timestamp, '$usuario', $foln, '$poc') ";
						    			//$this->EjecutaQuerySimple();			
			    						if($key->CANT_RECIBIDA <> $key->PXR){  // Si la cantidad es diferente a la Pendiente por recibir.
						    			/// aqui se genera el Deudor.....
							    			//echo 'Es diferente lo recibido';
							    			$this->query="UPDATE FTC_POC_DETALLE SET CANT_RECIBIDA = 0, status_log2 = 'Tesoreria', status_real = 'Tesoreria' where OC = '$doco' and partida = $key->PARTIDA";
							    			$this->EjecutaQuerySimple();	

							    			$this->query="UPDATE FTC_POC SET STATUS_LOG = 'Tesoreria', STATUS='TESORERIA' WHERE OC = '$doco' ";
						    				$this->EjecutaQuerySimple();
						    			}
			    			}
			    			echo 'Lineas Afectadas: '.$RA.'<br/>';
			    		if($RA == 1){
			    				echo 'Entra a para mover a tesoreria, creacion del deudor. <br/> Ajusta Preoc01';
			    				$this->query="UPDATE PREOC01 SET RECEPCION = RECEPCION + $key->CANT_RECIBIDA, REC_FALTANTE = REC_FALTANTE - $key->CANT_RECIBIDA WHERE id = $key->IDPREOC";
					    		$ra=$this->queryActualiza();
					    		echo 'Lineas Afectadas de la preoc: '.$RA.'<br/>';
					    		if($ra == 1){
					    			echo 'Entra para colocar las partidas en el deudor <br/>';
					    			$this->query="INSERT INTO FTC_DETALLE_RECEPCIONES (ID, ORDEN, IDPREOC, CANTIDAD_OC, CANTIDAD_REC, PARTIDA, status, fecha, usuario, ID_RECEPCION, poc) VALUES (NULL, '$doco', $key->IDPREOC, $key->CANTIDAD, $key->CANT_RECIBIDA, $key->PARTIDA, 0, current_timestamp, '$usuario', $foln, '$poc') ";
					    			$this->grabaBD();

					    			$this->query="SELECT SUM(CANTIDAD_REC) AS RECIBIDO FROM FTC_DETALLE_RECEPCIONES WHERE IDPREOC=$key->IDPREOC AND ORDEN = '$doco' and partida = $key->PARTIDA";
					    			$result=$this->EjecutaQuerySimple();
					    			$row5 = ibase_fetch_object($result);
					    			$recibido = $row5->RECIBIDO;
					    			$cantidad = $key->CANTIDAD; 

					    			if ($recibido > $cantidad){
					    				/// metodo para enviar incidencia por correo.

					    			}elseif($recibido < $cantidad){
					    				//// entonces lo mandamos a la pantalla de proveedores que no cumplen con la orden.
					    				$this->query="UPDATE FTC_POC_DETALLE SET STATUS = 8, cant_recibida = 0, status_log2='Retorno a Suministros', vuelta= vuelta + 1, STATUS_REAL='Retorno a Suministros'  WHERE OC = '$doco' and partida = $key->PARTIDA";
					    				$res5=$this->queryActualiza();
					    		
					    				if($res5 == 1){
					    					$this->query="UPDATE FTC_POC SET STATUS_LOG = 'Retorno a Suministros', STATUS='Retorno a Suministros'  WHERE OC = '$doco'";
					    					//echo $this->query.'<br/>';
					    					$this->queryActualiza();
					    				}
					    			}

					    			//if($key->CANT_RECIBIDA <> $key->PXR){  // Si la cantidad es diferente a la Pendiente por recibir.
					    			/// aqui se genera el Deudor.....
					    			//	echo 'entra a generar el deudor <br/>';
						    		//	$this->query="UPDATE FTC_POC_DETALLE SET CANT_RECIBIDA = 0, status_log2 = 'Tesoreria', status_real = 'Tesoreria' where OC = '$doco' and partida = $key->PARTIDA";
						    		//	$this->EjecutaQuerySimple();	
						    		//	echo 'Consulta Actualiza Cabecera: '.$this->query.'<br/>';
						    		//	$this->query="UPDATE FTC_POC SET STATUS_LOG = 'Tesoreria', STATUS='TESORERIA' WHERE OC = '$doco' ";
					    			//	$this->EjecutaQuerySimple();

						    		//	echo 'Consulta Actualiza Detalle: '.$this->query.'<br/>';
					    			//}	
					    		}
			    		}			    	}
		    	}else{

			    	$this->query="UPDATE COMPO01 SET STATUS_RECEPCION = 2, STATUS_LOG = 'Validada' WHERE CVE_DOC = '$doco' ";
			    	$this->EjecutaQuerySimple();

			    	$this->query="SELECT MAX(ID_RECEPCION) AS FOLIO FROM FTC_DETALLE_RECEPCIONES";
			    	$rs=$this->EjecutaQuerySimple();
			    	$row =ibase_fetch_object($rs);
			    	$foln = $row->FOLIO + 1;

			    	$this->query="SELECT NUM_PAR, CANT, iif(status_val is null, 0, CANT_RECIBIDA) as Cant_Recibida, ID_PREOC, PXR from par_compo01 WHERE CVE_DOC = '$doco'";
			    	$rs=$this->EjecutaQuerySimple();
			    	while($tsArray=ibase_fetch_object($rs)){
			    		$data[]=$tsArray;
			    	}

			    	foreach ($data as $key) {
			    		$this->query="UPDATE PAR_COMPO01 SET PXR = PXR - $key->CANT_RECIBIDA, status_val = null where cve_doc = '$doco' and num_par = $key->NUM_PAR";
			    		$this->EjecutaQuerySimple();

			    		$this->query="UPDATE PREOC01 SET RECEPCION = RECEPCION + $key->CANT_RECIBIDA, REC_FALTANTE = REC_FALTANTE - $key->CANT_RECIBIDA WHERE id = $key->ID_PREOC";
			    		$this->EjecutaQuerySimple();

			    		$this->query="INSERT INTO FTC_DETALLE_RECEPCIONES (ID, ORDEN, IDPREOC, CANTIDAD_OC, CANTIDAD_REC, PARTIDA, status, fecha, usuario, ID_RECEPCION, poc) VALUES (NULL, '$doco', $key->ID_PREOC, $key->CANT, $key->CANT_RECIBIDA, $key->NUM_PAR, 0, current_timestamp, '$usuario', $foln, '$poc') ";
			    		$this->EjecutaQuerySimple();

			    		if($key->CANT_RECIBIDA <> $key->PXR){
			    			/// aqui se genera el Deudor.....
			    			$this->query="UPDATE PAR_COMPO01 SET CANT_RECIBIDA = NULL, status_log2 = 'Tesoreria' where cve_doc = '$doco' and num_par = $key->NUM_PAR";
			    			$this->EjecutaQuerySimple();	

			    			$this->query="UPDATE COMPO01 SET STATUS_LOG = 'Tesoreria' WHERE CVE_DOC = '$doco' ";
			    				$this->EjecutaQuerySimple();
			    		}
			    	}

    			}
    	}
    	//exit('revisar resultado');
    	return;
    }


    function controlOC($doco){
    	$usuario = $_SESSION['user']->NOMBRE;
    	$this->query="UPDATE COMPO01 SET STATUS_RECEPCION = 9, USUARIO_RECIBE = '$usuario' WHERE CVE_DOC = '$doco'";
    	$this->EjecutaQuerySimple();
    	$this->query="UPDATE FTC_POC SET STATUS_RECEPCION = 9, USUARIO_RECIBE = '$usuario' where oc = '$doco'";
    	$this->EjecutaQuerySimple();

    	return;
    }

    function rechazarOC($doco, $tipo){
      	$data=array();
      	if(substr($doco,0,2) == 'OP'){
      		$usuario = $_SESSION['user']->NOMBRE;
		    	$this->query="UPDATE FTC_POC SET STATUS_RECEPCION = 8, STATUS_LOG = 'Rechazada' where OC = '$doco'";
		    	$this->EjecutaQuerySimple();

		    	$this->query="SELECT iif(MAX(ID_rechazo)is null, 0,max(id_rechazo)) AS FOLIO FROM FTC_DETALLE_RECEPCIONES";
		    	$rs=$this->EjecutaQuerySimple();
		    	$row =ibase_fetch_object($rs);
		    	$folr = $row->FOLIO + 1;

		    	$this->query="SELECT PARTIDA, CANTIDAD, CANT_RECIBIDA, IDPREOC, PXR from FTC_POC_DETALLE WHERE OC = '$doco'";
		    	$rs=$this->EjecutaQuerySimple();
		    	while($tsArray=ibase_fetch_object($rs)){
		    		$data[]=$tsArray;
		    	}
		    	foreach ($data as $key) {	
		    		$this->query="INSERT INTO FTC_DETALLE_RECEPCIONES (ID, ORDEN, IDPREOC, CANTIDAD_OC, CANTIDAD_REC, PARTIDA, status, fecha, usuario, ID_RECEPCION, ID_Rechazo) VALUES (NULL, '$doco', $key->IDPREOC, $key->CANTIDAD, 0, $key->PARTIDA, 0, current_timestamp, '$usuario', 0, $folr) ";
		    		$this->EjecutaQuerySimple();
		    		if($key->PXR > 0 ){
		    			$this->query="UPDATE FTC_POC_DETALLE SET CANT_RECIBIDA = 0, status_log2 = 'Tesoreria' where OC = '$doco' and PARTIDA = $key->PARTIDA";
		    			$this->EjecutaQuerySimple();
		    			$this->query="UPDATE FTC_POC SET STATUS_LOG = 'Tesoreria' WHERE OC = '$doco' ";
		    			$this->EjecutaQuerySimple();
		    		}
		    	}
    	
      	}else{
      		$usuario = $_SESSION['user']->NOMBRE;
	    	$this->query="UPDATE COMPO01 SET STATUS_RECEPCION = 8, STATUS_LOG = 'Rechazada' where cve_doc = '$doco'";
	    	$this->EjecutaQuerySimple();
	    	$this->query="SELECT iif(MAX(ID_rechazo)is null, 0,max(id_rechazo)) AS FOLIO FROM FTC_DETALLE_RECEPCIONES";
	    	$rs=$this->EjecutaQuerySimple();
	    	$row =ibase_fetch_object($rs);
	    	$folr = $row->FOLIO + 1;
	    	$this->query="SELECT NUM_PAR, CANT, CANT_RECIBIDA, ID_PREOC, PXR from par_compo01 WHERE CVE_DOC = '$doco'";
	    	$rs=$this->EjecutaQuerySimple();
	    	while($tsArray=ibase_fetch_object($rs)){
	    		$data[]=$tsArray;
	    	}
	    	foreach ($data as $key) {	
	    		$this->query="INSERT INTO FTC_DETALLE_RECEPCIONES (ID, ORDEN, IDPREOC, CANTIDAD_OC, CANTIDAD_REC, PARTIDA, status, fecha, usuario, ID_RECEPCION, ID_Rechazo) VALUES (NULL, '$doco', $key->ID_PREOC, $key->CANT, 0, $key->NUM_PAR, 0, current_timestamp, '$usuario', 0, $folr) ";
	    		$this->EjecutaQuerySimple();
	    		//echo 'Insercion en FTC_DETALLE_RECEPCIONES: '.$this->query.'<p>';
	    		if($key->PXR > 0 ){
	    			/// aqui se genera el Deudor.....
	    			$this->query="UPDATE PAR_COMPO01 SET CANT_RECIBIDA = NULL, status_log2 = 'Tesoreria' where cve_doc = '$doco' and num_par = $key->NUM_PAR";
	    			$this->EjecutaQuerySimple();
	    			//echo 'Consualta para meter a deudores: '.$this->query.'<p>';	
	    			$this->query="UPDATE COMPO01 SET STATUS_LOG = 'Tesoreria' WHERE CVE_DOC = '$doco' ";
	    			$this->EjecutaQuerySimple();
	    			//echo 'Consulta para enviar el documento a Tesoreria'.$this->query.'<p>';
	    		}
	    	}
    		
      	}
    	//break;
    	return;

    }

     


    function impresionOCI($doco){
    	$this->query="SELECT * FROM FTC_POC ftcpoc left join ftc_poc_detalle ftcpocd on ftcpocd.oc = ftcpoc.oc  WHERE ftcpoc.OC = '$doco'";
    	$rs=$this->EjecutaQuerySimple();

    	//echo $this->query;
    	//break;
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return $data;
    }


    function formulario(){
    	$this->query="UPDATE PG_USERS SET NOMBRE = 'A' WHERE ID = 1";
    	$this->EjecutaQuerySimple();
    	return;
    }

    function cancelaRecepcion($doco){
    	$data=array();
    	$usuario = $_SESSION['user']->NOMBRE;
    	$this->query="UPDATE COMPO01 SET STATUS_RECEPCION = NULL WHERE CVE_DOC = '$doco'";
    	$this->EjecutaQuerySimple();
    	$this->query="UPDATE FTC_POC SET STATUS_RECEPCION = NULL WHERE OC = '$doco'";
    	$this->EjecutaQuerySimple();


    	$this->query="SELECT NUM_PAR, CANT, CANT_RECIBIDA, ID_PREOC from par_compo01 WHERE CVE_DOC = '$doco'";
    	$rs=$this->EjecutaQuerySimple();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}

    	foreach ($data as $key) {
    		$this->query="UPDATE PAR_COMPO01 SET CANT_RECIBIDA = NULL where cve_doc = '$doco' and num_par = $key->NUM_PAR";
    		$this->EjecutaQuerySimple();
    	}

    	return;
    }


    function impresionRecepcion($doco){
    	$data=array();
    	$data2 = array();
    	$doco = strtoupper($doco);
    	$this->query="SELECT IIF(max(orden) IS NULL, 'A', max(orden)) as Orden FROM FTC_DETALLE_RECEPCIONES WHERE cast(ID_RECEPCION as varchar(20)) = '$doco'";
	    $rs=$this->EjecutaQuerySimple();
	    $row=ibase_fetch_object($rs);
	    $orden = $row->ORDEN;
    	if($orden <>'A'){
    		$doco = $orden;
    	}

    	if(substr($doco,0,2) == 'OP' ){

    		if(substr($doco, 0,3)=='OPI'){
    			$this->query = "SELECT p.nombre , ftc.oc as cve_doc, ftc.fecha_doc, ftc.costo_total as importe, ftc.tp_tes, ftc.pago_tes, ftc.usuario_recibe , ftc.status_recepcion, ftc.status_log, 0 as impresion, 9999 as id_recepcion
    							from ingresobodega ib
    							left join FTC_POC ftc on ftc.oc = ib.documento
    							left join PROV01 p on p.clave = ftc.cve_prov
    							where documento = '$doco'";
    			$rs=$this->EjecutaQuerySimple();
    			while ($tsArray=ibase_fetch_object($rs)){
    				$data[]=$tsArray;
    			}
    		}
    		$this->query="SELECT ID_RECEPCION FROM FTC_DETALLE_RECEPCIONES WHERE ORDEN = '$doco' group by id_recepcion";
	    	$rs2=$this->EjecutaQuerySimple();
	    	while ($tsArray=ibase_fetch_object($rs2)) {
	    		$data2[]=$tsArray;
	    	}

	    	foreach ($data2 as $key) {
	  			$id = $key->ID_RECEPCION;
	  			
	  			if(substr($doco, 0,2) <> 'OP'){
	  					$this->query="SELECT oc.*, p.nombre, $id as id_recepcion, (SELECT max(impresion) from FTC_DETALLE_RECEPCIONES where cve_doc = '$doco' and id_recepcion = $id) as impresion  FROM COMPO01 oc left join prov01 p on oc.cve_clpv = p.clave WHERE CVE_DOC = '$doco'";
    			$rs=$this->EjecutaQuerySimple();
		    		while($tsArray=ibase_fetch_object($rs)){
		    			$data[]=$tsArray;
		    		}

	  			}else{
	  				$this->query="SELECT poc.oc as cve_doc, poc.fecha_oc as fecha_doc, poc.tp_tes, poc.status_recepcion,poc.status_log, poc.pago_tes, poc.usuario_recibe, $id as id_recepcion, p.nombre, poc.costo_total as importe,(SELECT max(impresion) from FTC_DETALLE_RECEPCIONES where cve_doc = '$doco' and id_recepcion = $id) as impresion   FROM FTC_POC poc left join prov01 p on p.clave = poc.cve_prov WHERE OC = '$doco' ";
	  				$rs=$this->EjecutaQuerySimple();
	  				//echo $this->query;
	  				while($tsArray=ibase_fetch_object($rs)){
	  					$data[]=$tsArray;
	  				}
	  			}
	    	}	
    	}elseif(substr($doco,0,1)=='I'){
    		$this->query="SELECT a.id as cve_doc, a.fecha_mov as fecha_doc, 'N/A' as tp_tes, a.status as status_recepcion, 'n/a' as status_log, 'n/a' as pago_tes, ftcd.usuario as usuario_recibe, ftcd.id_recepcion, 'Pegaso (Bodega Interna)' as nombre, 0 as importe, ftcd.impresion FROM ftc_detalle_recepciones ftcd left join ASIGNACION_BODEGA_PREOC a  on ftcd.orden = a.id WHERE ftcd.FOLIO_IMP_BODEGA = '$doco'";
    		$rs=$this->EjecutaQuerySimple();
    		//echo $this->query;
    		while ($tsArray=ibase_fetch_object($rs)){
    			$data[]=$tsArray;
    		}
    	}else{
    		$this->query="SELECT a.id as cve_doc, a.fecha_mov as fecha_doc, 'N/A' as tp_tes, a.status as status_recepcion, 'n/a' as status_log, 'n/a' as pago_tes, ftcd.usuario as usuario_recibe, ftcd.id_recepcion, 'Pegaso (Bodega Interna)' as nombre, 0 as importe, ftcd.impresion FROM ASIGNACION_BODEGA_PREOC a left join ftc_detalle_recepciones ftcd on ftcd.orden = '$doco' WHERE a.ID = $doco";
    		$rs=$this->EjecutaQuerySimple();
    		while ($tsArray=ibase_fetch_object($rs)){
    			$data[]=$tsArray;
    		}
    	}
    	return $data;
    }

    function datosFTCRecep($doco){
    	if(substr($doco, 0,2) == 'OP'){
    		$this->query="SELECT oc.*, oc.fecha_oc as fechaelab, p.clave as cve_clpv, p.nombre, p.rfc, p.CALLE, p.numext, p.colonia, p.estado, p.cve_pais, p.tp_efectivo, p.tp_transferencia, p.tp_credito, p.tp_cheque, p.diascred, p.cuenta FROM ftc_poc oc LEFT JOIN PROV01 p ON p.CLAVE = oc.cve_prov WHERE oc = '$doco'";
    	}elseif(gettype($doco) == 'varchar'){
    		$this->query="SELECT oc.*, p.nombre, p.rfc, p.CALLE, p.numext, p.colonia, p.estado, p.cve_pais, p.tp_efectivo, p.tp_transferencia, p.tp_credito, p.tp_cheque, p.diascred, p.cuenta FROM COMPO01 oc LEFT JOIN PROV01 p ON p.CLAVE = oc.cve_clpv WHERE cve_doc = '$doco'";	
    	}
    	$rs=$this->EjecutaQuerySimple();
    	while ($tsArray=ibase_fetch_object($rs)) {
    		$data[]=$tsArray;
    	}
    	return @$data;
    }

    function detalleFTCRecep($doco, $docr){
    	if(substr($doco,0,2)== 'OP'){
    		if(substr($doco, 0,3)== 'OPI'){
    			$this->query="SELECT ftc.*, ib.*, ftc.cant_recibida as cantidad_rec, ftc.art as prod, (select nombre from producto_ftc where clave = ftc.art) as nomprod, 0 as impresion, 9999 as id_recepcion, ftc.costo as cost
    						  from ingresobodega ib
    						  left join FTC_POC_DETALLE ftc on ftc.oc = ib.documento
    						  where documento ='$doco' ";
    			$rs=$this->EjecutaQuerySimple();
    			while ($tsArray=ibase_fetch_object($rs)){
    				$data[]=$tsArray;
    			}
    		}

    		if($docr > 0){	
    			$this->query="SELECT ftc.*, poc.*, pc.*, pc.costo as cost   FROM  FTC_DETALLE_RECEPCIONES ftc left join preoc01 poc on poc.id = ftc.idpreoc left join FTC_POC_DETALLE pc on pc.oc = ftc.orden and pc.partida = ftc.partida  WHERE ORDEN = '$doco' and id_recepcion= $docr";	
    		}else{
    			$this->query="SELECT * FROM  FTC_DETALLE_RECEPCIONES ftc left join preoc01 poc on poc.id = ftc.idpreoc left join par_compo01 pc on pc.cve_doc = ftc.orden and pc.num_par = ftc.partida  WHERE ORDEN = '$doco'";	
    		}	
    	}else{
    		if($docr > 0){	
    			$this->query="SELECT * FROM  FTC_DETALLE_RECEPCIONES ftc left join preoc01 poc on poc.id = ftc.idpreoc left join par_compo01 pc on pc.cve_doc = ftc.orden and pc.num_par = ftc.partida  WHERE ORDEN = '$doco' and id_recepcion= $docr";	
    		}else{
    			$this->query="SELECT * FROM  FTC_DETALLE_RECEPCIONES ftc left join preoc01 poc on poc.id = ftc.idpreoc left join par_compo01 pc on pc.cve_doc = ftc.orden and pc.num_par = ftc.partida  WHERE ORDEN = '$doco'";	
    		}
    	}
    	$rd=$this->EjecutaQuerySimple();
    	while ($tsArray=ibase_fetch_object($rd)) {
    		$data[]=$tsArray;
    	}
    	//echo 'Consulta'.$this->query;
    	return $data;
    }

    function ctrlimprecepciones($doco, $docr){
    	$this->query="SELECT MAX(IMPRESION) AS impresion FROM FTC_DETALLE_RECEPCIONES WHERE orden = '$doco' and id_recepcion = $docr";
    	$rs=$this->EjecutaQuerySimple();
    	$row=ibase_fetch_object($rs);
    	$impresion = $row->IMPRESION;

    	$this->query="UPDATE FTC_DETALLE_RECEPCIONES SET IMPRESION = IMPRESION + 1  WHERE orden = '$doco' and id_recepcion = $docr";
    	$this->EjecutaQuerySimple();
    	return $impresion;
    }

    function verRecepcionDeOrdenes(){
    	$this->query="SELECT ftc.ORDEN, SUM(ftc.CANTIDAD_OC) AS ORIGINAL, SUM(ftc.CANTIDAD_REC) AS RECIBIDA, iif(SUM(ftc.CANTIDAD_OC) - SUM(ftc.CANTIDAD_REC) = 0, 'Completa', 'Parcial') as status,
    					max(p.nombre) as nombre , iif(max(oc.fechaelab) is null, max(ftcpoc.fecha_elab), max(oc.fechaelab)) as fechaelab, 
    					iif(max(oc.cve_clpv) is null, max(ftcpoc.cve_prov), max(oc.cve_clpv)) as cve_prov, max(p.rfc) as rfc, max(status_validacion) as status_validacion, max(ftc.status) as sta, min(fecha_costo) as fecha_costo
    					from FTC_DETALLE_RECEPCIONES ftc
    					LEFT JOIN COMPO01 oc on oc.cve_doc  = ftc.orden
    					LEFT JOIN FTC_POC ftcpoc on ftcpoc.oc = ftc.orden
    					left join prov01 p on oc.cve_clpv = p.clave or ftcpoc.cve_prov = p.clave
    					where orden starting with ('OP')
    					AND FECHa_oc >= '01.09.2018'
    					GROUP BY ORDEN HAVING (avg(ftc.status) = 0 or max(ftc.status) = 7 or avg(ftc.status) = 1) and SUM(ftc.CANTIDAD_REC) > 0";
    	$rs=$this->EjecutaQuerySimple();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return $data;
    }

    function cierreValRecep($doco){
    	$this->query="SELECT iif(max(val_part) is null, 0, Max(val_part)) AS VALIDACIONES FROM FTC_DETALLE_RECEPCIONES WHERE ORDEN = '$doco' GROUP BY ORDEN, PARTIDA";
    	$rs=$this->EjecutaQuerySimple(); 	
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	$tot_val = 0;
    	foreach ($data as $key) {
    		$tot_val = $tot_val + $key->VALIDACIONES;
    	}
    	$this->query="SELECT first 1 count(partida) AS PARTIDAS FROM FTC_DETALLE_RECEPCIONES WHERE ORDEN='$doco' and id_recepcion > 0 group by id_recepcion";
    	$rs=$this->EjecutaQuerySimple();
    	$row=ibase_fetch_object($rs);
    	$tot_partida = $row->PARTIDAS;
       	if($tot_val == $tot_partida){
    		$cierre = 0;
    	}else{
    		$cierre = 1;
    	}
    	return $cierre;
    }

    function validaStatusValidacion($doco){
    	$this->query="SELECT IIF(MAX(STATUS_VALIDACION) IS NULL, 'A', MAX(STATUS_VALIDACION)) AS VALIDACION FROM FTC_DETALLE_RECEPCIONES WHERE ORDEN = '$doco' ";
    	$rs=$this->EjecutaQuerySimple();
    	$row = ibase_fetch_object($rs);
    	$val = $row->VALIDACION; 
    	return $val;
    }

    function valRecepcion($doco){
    	$this->query="UPDATE FTC_DETALLE_RECEPCIONES SET STATUS_VALIDACION = 9 WHERE ORDEN = '$doco'";
    	$this->EjecutaQuerySimple();

    	$this->query="SELECT ftc.ORDEN, 
    						ftc.partida, 
    						ftc.idpreoc,
    						max(ftcpoc.costo) as costo,
    						max(ftcpoc.pxr) as pxr,
    						(select max(prod) from preoc01 where id = ftc.idpreoc) as art, 
    						(select max(nombre) from producto_ftc where clave = (select max(prod) from preoc01 where id = ftc.idpreoc)) as descripcion,
    						(select max(pxr) from par_compo01 where cve_doc = '$doco' and num_par = ftc.partida) as pxr1,
    						(select max(cost) from par_compo01 where cve_doc = '$doco' and num_par= ftc.partida)  as costo1,
    						(select max(um) from producto_ftc where clave = (select max(prod) from preoc01 where id = ftc.idpreoc)) as UM,
    						(select max(CVE_PROD) from producto_ftc where clave = (select max(prod) from preoc01 where id = ftc.idpreoc)) as CVE_PROD,
    						(select max(NOM_CLI) FROM preoc01 where id= ftc.idpreoc) as CLIENTE,
    						(select max(cotiza) from preoc01 where id= ftc.idpreoc) as COTIZACION, 
    						(select max(fechasol) from preoc01 where id = ftc.idpreoc) as fechasol,
    						(select max(cant_orig) from preoc01 where id = ftc.idpreoc) as cant_orig,
    						max(ftc.desc1) as desc1,
    						max(ftc.desc2) as desc2,
    						max(ftc.desc3) as desc3,
    						max(ftc.descf) as descf,
     						max(ftc.cantidad_oc) as Cantidad, 
     						max(ftc.desc1_m) as desc1_m,
     						max(ftc.desc2_m) as desc2_m,
     						max(ftc.desc3_m) as desc3_m,
     						max(ftc.descf_m) as descf_m,
     						max(ftc.precio_Lista) as precio_Lista,
    						SUM(ftc.cantidad_rec) as Cant_Recibida,
    						max(ftc.total_costo_unitario) as total_costo_unitario,
    						max(ftc.total_costo_partida) as total_costo_partida,
    						(select max(desc1) from ftc_articulos ftca where ('PGS'||ftca.id) = (select max(prod) from preoc01 where id = ftc.idpreoc)) as DESCO1,
    						(select max(desc2) from ftc_articulos ftca where ('PGS'||ftca.id) = (select max(prod) from preoc01 where id = ftc.idpreoc)) as DESCO2,
    						(select max(desc3) from ftc_articulos ftca where ('PGS'||ftca.id) = (select max(prod) from preoc01 where id = ftc.idpreoc)) as DESCO3,
    						(select max(desc4) from ftc_articulos ftca where ('PGS'||ftca.id) = (select max(prod) from preoc01 where id = ftc.idpreoc)) as DESCOF,
    						(select max(PRECIO) from ftc_articulos ftca where ('PGS'||ftca.id) = (select max(prod) from preoc01 where id = ftc.idpreoc)) as PRECIOO,
    						(select max(COSTO) from ftc_articulos ftca where ('PGS'||ftca.id) = (select max(prod) from preoc01 where id = ftc.idpreoc)) as COSTOO,
    						max(val_part) as Val_PART
    						FROM FTC_DETALLE_RECEPCIONES ftc
    						left join ftc_poc_detalle ftcpoc on ftcpoc.oc = ftc.orden and ftcpoc.partida = ftc.partida
    						where orden = '$doco' 
    						GROUP BY ORDEN, idpreoc, PARTIDA 
    						ORDER BY ORDEN ASC, partida asc";

    	$rs=$this->EjecutaQuerySimple();

    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}

    	foreach ($data as $key) {
    		$recibido = $key->CANT_RECIBIDA;
    		$orden = $key->ORDEN;
    		$partida = $key->PARTIDA;
    		$idpre = $key->IDPREOC;
    		if($recibido == 0 ){
    			$this->query="UPDATE FTC_DETALLE_RECEPCIONES SET desc1 = 0, desc2 = 0 , desc3 = 0, descf = 0, desc1_m = 0, desc2_m = 0, desc3_m = 0, descf_m = 0, precio_Lista = 0, total_costo_unitario = 0, total_costo_partida = 0, val_part = 1 WHERE orden = '$orden' and partida = $partida and idPreoc = $idpre";
    			$this->EjecutaQuerySimple();
    		}
    	}

    	return $data;
    }

    function cerrarValidacion($doco){

    	$this->query="SELECT iif(MAX(FOL_VALidacion) is null, 0 , max(FOL_VALidacion)) as folio FROM FTC_DETALLE_RECEPCIONES";
    	$rs=$this->EjecutaQuerySimple();
    	$row = ibase_fetch_object($rs);
    	$foln = $row->FOLIO + 1;
    	$usuario= $_SESSION['user']->NOMBRE;

    	$this->query="UPDATE FTC_DETALLE_RECEPCIONES SET status_validacion = 2, status = 2, FOL_VALIDACION = $foln, usuario_cierre_val = '$usuario', fecha_cierre_val = current_timestamp WHERE ORDEN = '$doco'";
    	$this->EjecutaQuerySimple();
    	return $foln;  
    }

    function cancelaValidacionRecepcion($doco){
    	$this->query="UPDATE FTC_DETALLE_RECEPCIONES SET STATUS_VALIDACION = NULL WHERE ORDEN = '$doco'";
    	$this->EjecutaQuerySimple();
    	return;
    }

    function infoRecepcion($doco){
    	$this->query="SELECT first 1 ftc.ORDEN, p.nombre as nombre , iif(oc.fechaelab is null, ftcpoc.fecha_elab, oc.fechaelab) as fechaelab, iif(oc.cve_clpv is null, ftcpoc.cve_prov, oc.cve_clpv) as cve_prov, p.rfc as rfc
    					from FTC_DETALLE_RECEPCIONES ftc
    					LEFT JOIN COMPO01 oc on oc.cve_doc  = ftc.orden
    					left join ftc_poc ftcpoc on ftcpoc.oc = ftc.orden 
    					left join prov01 p on oc.cve_clpv = p.clave or ftcpoc.cve_prov = p.clave
    					left join preoc01 poc on poc.id = ftc.idpreoc  
    					left join ftc_articulos ftca on poc.prod = ('PGS'||ftca.id)  
    					where orden = '$doco'";

    	$rs=$this->EjecutaQuerySimple();

    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return $data;
    }

    function recibirParOC($idp, $cantidad, $doco, $partida, $desc1, $desc2, $desc3, $descf, $desc1M, $desc2M, $desc3M, $descfM, $precioLista, $totalCosto, $totalPartida){
    	$this->query="SELECT IIF(MAX(VALIDA_COSTO) IS NULL, 0 , MAX(VALIDA_COSTO)) AS VALIDA_COSTO FROM FTC_DETALLE_RECEPCIONES";
    	$rs=$this->EjecutaQuerySimple();
    	$row=ibase_fetch_object($rs);
    	$foln = $row->VALIDA_COSTO + 1;
    	$usuario = $_SESSION['user']->NOMBRE;
    	$this->query="UPDATE FTC_DETALLE_RECEPCIONES SET VALIDA_COSTO = $foln, USUARIO_COSTO = '$usuario', CANT_VAL = $cantidad, desc1 = $desc1, desc2 = $desc2, desc3 = $desc3, descf = $descf, precio_Lista = $precioLista, total_costo_unitario = $totalCosto, total_costo_partida = $totalPartida, desc1_m= $desc1M, desc2_m=$desc2M, desc3_m=$desc3M, descf_m=$descf, val_part = 1 where orden = '$doco' and partida = $partida";
    	$res=$this->queryActualiza();
    	if($res >= 1){
    			$this->query="SELECT iif(max(val_part) is null, 0, Max(val_part)) AS VALIDACIONES FROM FTC_DETALLE_RECEPCIONES WHERE ORDEN = '$doco' GROUP BY ORDEN, PARTIDA";
		    	$rs=$this->EjecutaQuerySimple(); 	
		    	while($tsArray=ibase_fetch_object($rs)){
		    		$data[]=$tsArray;
		    	}
		    	$tot_val = 0;
		    	foreach ($data as $key) {
		    		$tot_val = $tot_val + $key->VALIDACIONES;
		    	}
		    	$this->query="SELECT first 1 count(partida) AS PARTIDAS FROM FTC_DETALLE_RECEPCIONES WHERE ORDEN='$doco' and id_recepcion > 0 group by id_recepcion";
		    	$rs=$this->EjecutaQuerySimple();
		    	$row=ibase_fetch_object($rs);
		    	$tot_partida = $row->PARTIDAS;
		       	if($tot_val == $tot_partida){
		    		$cierre = 0;
		    	}else{
		    		$cierre = 1;
		    	}
    		return $mensaje=array("status"=>'ok', "cierre"=>$cierre);
    	}else{
    		return $mensaje=array("status"=>'no', "cierre"=>1);
    	}
    }


    function solAutCostos($idp, $cantidad, $doco, $partida, $desc1, $desc2, $desc3, $descf, $desc1M, $desc2M, $desc3M, $descfM, $precioLista, $totalCosto, $totalPartida){
		$this->query="SELECT IIF(MAX(VALIDA_COSTO) IS NULL, 0 , MAX(VALIDA_COSTO)) AS VALIDA_COSTO FROM FTC_DETALLE_RECEPCIONES";
    	$rs=$this->EjecutaQuerySimple();
    	$row=ibase_fetch_object($rs);
    	$foln = $row->VALIDA_COSTO + 1;

    	$usuario = $_SESSION['user']->NOMBRE;
    	$this->query="UPDATE FTC_DETALLE_RECEPCIONES SET VALIDA_COSTO = $foln, USUARIO_COSTO = '$usuario', CANT_VAL = $cantidad, desc1 = $desc1, desc2 = $desc2, desc3 = $desc3, descf = $descf, precio_Lista = $precioLista, total_costo_unitario = $totalCosto, total_costo_partida = $totalPartida, desc1_m= $desc1M, desc2_m=$desc2M, desc3_m=$desc3M, descf_m=$descf, val_part = 0, status = 7, fecha_costo = current_timestamp where orden = '$doco' and partida = $partida";
    	$this->EjecutaQuerySimple();
    	return;	
    }


    function solicitudesCosto(){
    	$this->query="SELECT COUNT(ID) as id FROM FTC_DETALLE_RECEPCIONES WHERE precio_Lista > 0 AND VAL_PART = 0 ";
    	$rs=$this->EjecutaQuerySimple();
    	$row=ibase_fetch_object($rs);
    	$sol  = $row->ID;

    	return $sol;
    }

    function verSolCostos(){
    	$this->query="SELECT ftcr.idpreoc, ftcr.partida, ftcr.orden, ftcr.precio_Lista, ftcr.desc1, ftcr.desc1_M,ftcr.desc2, ftcr.desc2_M, ftcr.desc3, ftcr.desc3_M,ftcr.descf, ftcr.descf_M, pftc.NOMBRE, pftc.clave, oc.fechaelab, oc.cve_clpv, p.nombre as prov, oc.importe , oc.tp_tes, oc.pago_tes, pftc.costo_t, (ftcr.total_costo_unitario * 1.16) AS total_costo_val, pftc.impuesto,
    				pftc.costo_suministros as costo, ftcr.total_costo_unitario, pftc.desc1 as descc1, pftc.desc2 as descc2, pftc.desc3 as descc3, pftc.desc4 as descc4, pftc.descf as desccf, pftc.clave_ftc as ida,
    				(select sum(cantidad_rec) from FTC_DETALLE_RECEPCIONES ftc2 where ftc2.orden = ftcr.orden and ftc2.partida = ftcr.partida ) as cantidad
    			from FTC_DETALLE_RECEPCIONES ftcr 
    			left join preoc01 poc on poc.id = ftcr.idpreoc
    			left join producto_ftc pftc on pftc.clave = poc.prod
    			left join compo01 oc on oc.cve_doc = ftcr.orden
    			left join prov01 p on p.clave = oc.cve_clpv
    			where ftcr.val_part = 0";
    	$rs=$this->EjecutaQuerySimple();

    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return $data;
    }


    function aceptarCosto($doco, $par, $costo_o, $costo_n){
    	$usuario =$_SESSION['user']->NOMBRE;
    	$this->query="UPDATE FTC_DETALLE_RECEPCIONES SET VAL_PART  = 1 WHERE ORDEN = '$doco' and PARTIDA = $par";
    	$this->EjecutaQuerySimple();

    	$this->query="INSERT INTO reg_autoriza_costo (id, orden, partida, usuario, fecha, costo_o, costo_n, dif)
    										values (null, '$doco', $par, '$usuario', current_timestamp, $costo_o, $costo_n, ($costo_o - $costo_n)) ";
    	$this->EjecutaQuerySimple();
    	return;
    }



    function recValConta(){
    	$this->query="SELECT ftc.ORDEN, SUM(ftc.CANTIDAD_OC) AS ORIGINAL, SUM(ftc.CANTIDAD_REC) AS RECIBIDA, iif(SUM(ftc.CANTIDAD_OC) - SUM(ftc.CANTIDAD_REC) = 0, 'Completa', 'Parcial') as status,
    					max(p.nombre) as nombre , max(oc.fechaelab) as fechaelab, max(oc.cve_clpv) as cve_prov, max(p.rfc) as rfc, max(status_validacion) as status_validacion, max(ftc.status) as sta, min(fecha_costo) as fecha_costo, MAX(fol_validacion) as folio
    					from FTC_DETALLE_RECEPCIONES ftc
    					LEFT JOIN COMPO01 oc on oc.cve_doc  = ftc.orden
    					left join prov01 p on oc.cve_clpv = p.clave
    					GROUP BY ORDEN HAVING max(fol_validacion) is not null and MAX(usuario_conta) is null";
    	$rs=$this->EjecutaQuerySimple();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}

    	return $data;
    }

    function recibirValidacion($doco, $folio){
    	$usuario=$_SESSION['user']->NOMBRE;
    	$this->query="UPDATE FTC_DETALLE_RECEPCIONES SET usuario_conta = '$usuario', fecha_contabilidad = current_timestamp where orden = '$doco' and fol_validacion=$folio";
    	$this->EjecutaQuerySimple();
    	
    	return;
    }

    function verHistorialSaldo($prov){
    	$data=array();
    	$this->query="SELECT * FROM LIB_PARTIDAS lp left join par_compo01 poc on poc.cve_doc = lp.oc and poc.num_par = lp.partida_oc WHERE trim(PROVEEDOR) = trim('$prov')";
    	$rs=$this->EjecutaQuerySimple();
    	while ($tsArray=ibase_fetch_object($rs)) {
    		$data[]=$tsArray;
    	}
    	return $data;
    }

    function verOrdenesCompra(){
    	$usuario=$_SESSION['user']->NOMBRE;
    	$data = array();
    	$this->query="SELECT ftc.fecha_oc, ftc.*, p.nombre FROM FTC_POC ftc left join prov01 p on p.clave = ftc.cve_prov 
    	WHERE OC is not null 
    	and ftc.status <> 'Nueva' 
    	and usuario_oc = '$usuario' 
    	order by ftc.fecha_oc desc";
    	$rs=$this->EjecutaQuerySimple();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return $data;
    }

    function cambiarProv($ida, $cant, $tipo){
    	$usuario = $_SESSION['user']->NOMBRE;

    	$this->query="SELECT STATUS FROM PREOC01 WHERE ID = $ida";
    	$rs=$this->EjecutaQuerySimple();
    	$row = ibase_fetch_object($rs);
    	$status = $row->STATUS;

    	if($status == 'F' or $tipo == ''){
	    	if($tipo == 'suministros'){
	    		$this->query="UPDATE PREOC01 SET STATUS = 'N' WHERE ID = $ida";
	    		$this->EjecutaQuerySimple();
	    	}else{
			   	$this->query="SELECT iif(prov_alt is null, prove, prov_alt) as cve_prov, 
							(select nombre from prov01 where trim(clave) = trim(iif(prov_alt is null or prov_alt = '999999999', prove, prov_alt))) as nombre_prov,
							nomprod, prod
			    			FROM PREOC01 WHERE ID = $ida";
			    $rs=$this->EjecutaQuerySimple();
			    $row = ibase_fetch_object($rs);

			    $this->query="INSERT INTO FTC_SOLICITUD_PROV (id, cantidad, cve_prod,cve_prov_orig, nombre_prov_orig, idpreoc, descripcion, usuario_solicita, fecha_solicita, usuario_cambia, fecha_cambia, cve_nuevo_prov, nombre_nuevo_prov) 
			    			values(null,$cant,'$row->PROD', '$row->CVE_PROV', '$row->NOMBRE_PROV', $ida, '$row->NOMPROD', '$usuario', current_timestamp, null, null, null, null)";
			    $this->EjecutaQuerySimple();
			    
			    $this->query="UPDATE PREOC01 SET prov_alt = '999999999', status='J' where id = $ida";
			    $this->EjecutaQuerySimple();   
			    $a = 'Se realizo la peticion.';		
	    	}
    	}else{
    		$a='La partida ya se habia procesado con Anterioridad, no se proceso la solicitud';	
    		echo $a;
    	}
    	return;
    }

    function verSolProveedor(){
    	$data= array();
    	$this->query="SELECT s.*, a.precio, 
    				(a.precio * (a.desc1/100)) as desc1, 
    				(a.precio * (a.desc2/100)) as desc2,
    				(a.precio * (a.desc3/100)) as desc3,
    				(a.precio * (a.desc4/100)) as desc4,
    				(select cotiza from preoc01 where id = s.idpreoc) as cotizacion,
    				(select first 1 d.fecha_doc from ftc_poc_detalle d where d.idpreoc = s.idpreoc) as fecha_ini,
    				(select TP_TES from ftc_poc o where o.oc = s.oc) as pago
    				FROM FTC_SOLICITUD_PROV s LEFT JOIN ftc_articulos a on s.cve_prod = ('PGS'||a.id) 
    				WHERE cve_nuevo_prov is null";
    	$rs=$this->EjecutaQuerySimple();
    	while ($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return $data;
    }

    function proveedores(){
    	$this->query="SELECT * FROM PROV01 WHERE STATUS = 'A'";
    	$rs=$this->EjecutaQuerySimple();
    	while ($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return $data;
    }

 function cambioProveedor($prov1, $id, $idpreoc){
    	$usuario = $_SESSION['user']->NOMBRE;
    	$tipo = strpos( $prov1,':');
    	if($tipo===false){
    		return $mensaje=array("status"=>'No', "razon"=>'El proveedor '.$prov1. ' no se encontro o no existe');
    	}else{
    		$prov = explode(':',$prov1);
    		$proveedor = $prov[0];
    		$this->query="SELECT * FROM PROV01 WHERE TRIM(CLAVE) = TRIM('$proveedor')";
	    	$rs=$this->EjecutaQuerySimple();
	    	$row = ibase_fetch_object($rs);

	    	if(!empty($row)){
	    			$this->query="UPDATE preoc01 set prov_alt = '$row->CLAVE', status ='N' where id = $idpreoc";
		    		$res=$this->queryActualiza();
	    		if($res==1){
			    	$this->query="UPDATE FTC_SOLICITUD_PROV set cve_nuevo_prov = '$row->CLAVE', nombre_nuevo_prov = '$row->NOMBRE', usuario_cambia ='$usuario', fecha_cambia= current_timestamp where id = $id";
			    	$result=$this->queryActualiza();
		    		return $mensaje=array("status"=>'OK', "razon"=>'Se Ha cambiado a el proveedor'.$row->NOMBRE) ;
		    	}else{
		    		return $mensaje=array("status"=>'No', "razon"=>'El proveedor '.$prov1. ' no se encontro o no existe');
		    	}	
	    	}else{
	    		return $mensaje=array("status"=>'No', "razon"=>'El proveedor '.$prov1. ' no se encontro o no existe');
	    	}
    	}
    }

    function historialCambios($exec){
    	//var_dump($exec);
    	$data=array();
    	if(!empty($exec)){
	    	foreach ($exec as $key) {
	    		$data=array();
	    		$this->query="SELECT * FROM FTC_SOLICITUD_PROV WHERE IDPREOC = $key->ID order by fecha_solicita, idpreoc";
	    		$rs=$this->EjecutaQuerySimple();
	    		while ($tsArray=ibase_fetch_object($rs)) {
	    			$data[]=$tsArray;
	    		}
	    	}
    	}
    	
    	return $data;
    }

    function verProductosLiberados(){
    	$this->query="SELECT p.id, p.fechasol, p.fecha_auto, p.cotiza, p.par, p.status, 
    							p.prod, 
    							p.nomprod,
    							p.canti, p.cant_orig, p.costo, 
    							iif(p.prov_alt is null,  p.prove, p.prov_alt) as prove,
    							(SELECT NOMBRE FROM prov01 where trim(clave) = trim(iif(p.prov_alt is null, p.prove, p.prov_alt))) AS  nom_prov,
    							 p.total, p.rest, p.docorigen, p.urgente, p.um, datediff(day, p.fechasol,current_date) as DIAS, 
    							p.costo_maximo, iif(fecharec is null, current_date, fecharec) as fecharec,
							  (select count(id) from LIB_PARTIDAS where idpreoc = p.id) as Liberaciones,
							  (select resp_compra from prov01 where trim(clave) = trim(iif(p.prov_alt is null, p.prove, p.prov_alt))) as responsable
							  from preoc01 p
							  WHERE status='F' 
							  and rest > 0 
							  and rec_faltante > 0 
							  and (select count(id) from LIB_PARTIDAS where idpreoc = p.id) >= 1
							  ORDER BY  nom_prov  ASC ";
		$result = $this->QueryObtieneDatosN();
			while ( $tsArray = $this->FetchAs($result) ) 
					$data[] = $tsArray;			
		
			return $data;
    }

    function actFecha($tipo, $docu, $fecha){


    	
   
    	$a= array("status"=>"NO","response"=>"No se pudo Actualizar", "fecha"=>$fecha);
    		 switch ($tipo){
                case 1:
                    $tabla = 'carga_pagos';
                    $campo1 = 'fecha_recep';
                    $campo2 = 'folio_x_banco';

                    if(substr($docu,0,2)== 'TR'){
                    	$campo2= 'ID';
                    	$a= explode( '-',$docu);
                    	$docu=substr($docu, 2,10);
                    }

                    break;
                case '2':
                    $tabla = 'compo01';
                    $campo1 = 'fecha_edo_cta';
                    $campo2 = 'cve_doc';
                    break;
                case '3':
                    $tabla = 'CR_DIRECTO';
                    $campo1 = 'fecha_edo_cta';
                    $campo2 = 'id';
                    $a = explode('-', $docu);
                    $docu = $a[0];
                    break;
                case '4':
                    $tabla = 'gastos';
                    $campo1 = 'fecha_edo_cta';
                    $campo2 ='id';
                    break;
                case '5':
                    $tabla = 'CR_DIRECTO';
                    $campo1 = 'fecha_edo_cta';
                    $campo2 ='id';
                    $a = explode('-', $docu);
                    $docu = $a[0];
                    break;
                case '6':
                    $tabla = 'deudores';
                    $campo1 = 'fechaedo_cta';
                    $campo2 = 'iddeudor';
                    break;
                case '7':
                    $tabla = 'Solicitud_pago';
                    $campo1 = 'fecha_edo_cta';
                    $campo2 = 'idsol';

                    substr($docu,4, 10 );
                    substr($docu,2,10);
                    break;
                case '8':
                	$tabla = 'FTC_POC';
                	$campo1 = 'edocta_fecha';
                	$campo2 = 'oc';
                default:
                    break;                  
            }

            if(substr($docu, 0 , 3 ) == 'SOL'){
            	$docu = substr($docu,4,10);
            }elseif(substr($docu, 0,1) == 'D'){
            	$docu = substr($docu, 1,10);
            }

    	if($fecha == 'bbb' ){
    		$this->query="UPDATE $tabla set seleccionado = 0 where $campo2 = '$docu'";
    			$rs=$this->EjecutaQuerySimple();
    	
    	}elseif($fecha == 'aaa'){
    			$this->query="UPDATE $tabla set seleccionado = 1 where $campo2 = '$docu'";
    			$rs=$this->EjecutaQuerySimple();
    			
    	}else{
				$this->query="UPDATE $tabla SET $campo1 = '$fecha', seleccionado = 1 where  $campo2 = '$docu'";
    			$rs = $this->EjecutaQuerySimple();
    	}
      //echo $this->query;
    	if($rs){
    		$consulta = $this->EjecutaQuerySimple();
    		$a = array("status"=>"OK","reponse"=>$docu,"fecha"=>$fecha);
    	}
    	return $a;
    }

    function guardaEdoCta($pagos, $compras, $gastos){	
    	$pagos = explode(',', $pagos);
    	foreach ($pagos as $p){
    		$tipo = substr($p,0,1);
    		$iden = substr($p,2,10);
    		$this->query = "UPDATE carga_pagos set seleccionado = 2, guardado = 1 where ID = $iden and seleccionado = 1";
    		$this->EjecutaQuerySimple();
    	}
    	$compras = explode(',', $compras);
    	var_dump($compras);
    	foreach ($compras as $c){
    		$tipo = substr($c, 0,1);
    		$iden = substr($c, 2, 10);

    		if($tipo == 2){
    			$this->query="UPDATE compo01 set seleccionado = 2, guardado = 1  where cve_doc = '$iden' and seleccionado  = 1";
    			$this->EjecutaQuerySimple();	
    		}elseif($tipo == 3 or $tipo == 5){
    			$iden = substr($iden,3,10);
    			$this->query="UPDATE CR_DIRECTO SET seleccionado = 2, guardado = 1  where ID = $iden and seleccionado = 1";
    			$this->EjecutaQuerySimple();
    			//echo 'consulra cr_directo'.$this->query.'<p>';
    		}elseif ($tipo == 4){
    			$iden = substr($iden,3, 10);
    			$this->query="UPDATE GASTOS SET seleccionado = 2, guardado = 1  where ID = $iden and seleccionado = 1";
    			$this->EjecutaQuerySimple();
    		}elseif ($tipo == 6) {
    			$iden = substr($iden, 1,10);
    			$this->query="UPDATE DEUDORES SET seleccionado = 2, guardado = 1  where iddeudor =$iden and seleccionado = 1 ";
    			$this->EjecutaQuerySimple();
    			echo $this->query;

    		}elseif ($tipo  == 7) {
    			$iden = substr($iden, 4, 10);
    			$this->query="UPDATE SOLICITUD_PAGO set seleccionado = 2, guardado = 1  where idsol = $iden and seleccionado =1";
    			$this->EjecutaQuerySimple();
    		}elseif($tipo == 8){
    			$this->query="UPDATE FTC_POC set seleccionado = 2, guardado = 1  where OC = '$iden' and seleccionado =1";
    			$this->EjecutaQuerySimple();
    		}
    		echo $this->EjecutaQuerySimple();
    	}
    	echo $tipo.'<p>  identificador: '.$iden.'<p>';
    //break;
    }


   
    function cerrarEdoCtaMes($mes, $anio, $abonos,$cargos, $inicial, $final, $cuenta, $banco){
    	$usuario = $_SESSION['user']->NOMBRE;
    	$nuevoMes = $mes + 1;
    	//echo 'Nuevo mes:'.$nuevoMes.'  nuevo año: '.$anio;
    	$mensaje = 'ok';
    	$nuevaFecha = '01.'.$nuevoMes.'.'.$anio;
    	$this->query="SELECT iif(max(periodo) is null, 0, max(periodo)) as UMC FROM FTC_CTRL_BANCOS WHERE BANCO = '$banco' and CUENTA = '$cuenta' and anio = $anio";
    	$rs=$this->EjecutaQuerySimple();
    	$row=ibase_fetch_object($rs);
    	$umc = $row->UMC;
    	if($umc == 0 or $mes == ($umc + 1)){
    		//// carga_Pagos
		    	$this->query="UPDATE CARGA_PAGOS SET FECHA_RECEP = '$nuevaFecha' WHERE extract(month from fecha_recep) = $mes and extract(year from fecha_recep) = $anio and (seleccionado = 0 or seleccionado is null) and BANCO = ('$banco'||' - '||'$cuenta') ";
		    	$this->queryActualiza();
		    	/// compo01 
		    	$this->query="UPDATE COMPO01 SET edocta_fecha = '$nuevaFecha' where extract(month from edocta_fecha) = $mes and extract(year from edocta_fecha) = $anio and (seleccionado = 0 or seleccionado is null) and BANCO = ('$banco'||' - '||'$cuenta')";
		    	$this->queryActualiza();
		    	/// ftc_poc
		    	$this->query="UPDATE FTC_POC SET EDOCTA_FECHA = '$nuevaFecha' where extract(month from EDOCTA_FECHA) = $mes and extract(year from EDOCTA_FECHA) = $anio and (seleccionado = 0 or seleccionado is null) and BANCO = ('$banco'||' - '||'$cuenta')";
		    	$this->queryActualiza();
		    	/// Gastos 
				$this->query="UPDATE GASTOS SET FECHA_EDO_CTA = '$nuevaFecha' where coalesce(extract(month from fecha_edo_cta), extract(month from fecha_doc)) = $mes and coalesce(extract(year from fecha_edo_cta), extract(year from fecha_doc)) = $anio	and (seleccionado = 0 or seleccionado is null) and status = 'V'";
		    	$this->queryActualiza();
		    		//iif(extract(month from fecha_edo_cta) is null, extract(month from fecha_doc), extract(month from fecha_edo_cta)) = $mes 
					//iif(extract(year from fecha_edo_cta) is null, extract(year from fecha_doc), extract(year from fecha_edo_cta))  = $anio 
		    	/// CR_DIRECTO
		    	$this->query="UPDATE CR_DIRECTO SET FECHA_EDO_CTA = '$nuevaFecha' where extract(month from fecha_edo_cta) = $mes and extract(year from fecha_edo_cta) = $anio and (seleccionado = 0 or seleccionado is null) and BANCO = '$banco' and cuenta = '$cuenta'";
		    	$this->queryActualiza();
				//// Deudores
		    	$this->query="UPDATE DEUDORES SET FECHAEDO_CTA = '$nuevaFecha' where extract(month from fechaedo_cta) = $mes and extract(year from fechaedo_cta) = $anio and (seleccionado = 0 or seleccionado is null) and banco=('$banco'||' - '||'$cuenta') ";
		    	$this->queryActualiza();
				//// SOLICITUD_PAGO
		    	$this->query="UPDATE SOLICITUD_PAGO SET FECHA_EDO_CTA = '$nuevaFecha' 
		    		where iif(fecha_edo_cta is null, extract(month from fecha_reg_pago_final), extract(month from FECHA_EDO_CTA)) = $mes
		    		 and iif(fecha_edo_cta is null, extract(year from fecha_reg_pago_final), extract(year from FECHA_EDO_CTA)) = $anio
		    		 and (seleccionado = 0 or seleccionado is null) 
		    		 and banco_final=('$banco'||' - '||'$cuenta')  ";
		    	$this->queryActualiza();

			    $inicial = str_replace(',', '', $inicial);
			    $abonos = str_replace(',', '',$abonos);
			    $cargos = str_replace(',', '',$cargos);
			    $final = str_replace(',', '',$final);
			    /*
		    	$this->query = "INSERT INTO CIERRE_MENSUAL (MES, ANIO, CUENTA, BANCO, INICIAL, ABONOS, CARGOS, FINAL, fecha_cierre, usuario_cierre, tipo )
		    							VALUES( '$mes', '$anio', '$cuenta', '$banco', $inicial, $abonos, $cargos, $final, current_timestamp, '$usuario', 'banco') ";
		    	$this->EjecutaQuerySimple();
		    	*/
		    	empty($inicial)?$inicial=0:'';
		    	empty($cargos)?$cargos=0:'';
		    	empty($abonos)?$abonos=0:'';
		    	empty($final)?$final=0:'';
		    	$this->query = "INSERT INTO FTC_CTRL_BANCOS (ID, IDBANCO, BANCO, CUENTA, PERIODO, ANIO, TIPO, STATUS, MONTO_INICIAL, MONTO_FINAL, CARGOS, ABONOS, USUARIO, FECHA) 
		    								VALUES (null, (select id from pg_bancos where banco='$banco' and num_cuenta = '$cuenta'), '$banco', '$cuenta', $mes, $anio, 'cierre','A',$inicial, $final, $cargos, $abonos, '$usuario', current_timestamp)";
		    	$this->grabaBD();
		    	//exit($this->query);
		    	/*$mes = $mes+ 1; 
		    	if(strlen($mes) == 1){
		    		$mesr = '0'.$mes;
		    	}
		    	$campo = 'SALDOI'.$mesr;
		    	$this->query="UPDATE PG_BANCOS SET $campo = $final where num_cuenta = '$cuenta' and Banco = '$banco'";
		    	$this->EjecutaQuerySimple();
				*/
		    	//echo $this->query;
    	}else{

    		$mensaje = 'Solo se pueden cerrar meses consecutivos, favor de revisare la informacion. Gracias';
    	}
    	return $mensaje;
    }

  
  
  function reporteRecibo(){
  	
  	$data=array();
  	$this->query="SELECT ftcdr.orden as orden, ftcdr.id_rechazo as rechazo, ftcdr.id_recepcion, sum(ftcdr.cantidad_rec) as cantidad_rec, max(ftcdr.partida) as partida, max(ftcdr.usuario) as usuario, max(ftcdr.fecha) as fecha, max(ftcdr.impresion) as impresion, max(p.nombre) as nombre
          FROM FTC_DETALLE_RECEPCIONES ftcdr
          left join ftc_poc ftcpoc on ftcpoc.oc = ftcdr.orden
          left join prov01 p on trim(p.clave) = trim(ftcpoc.cve_prov)
           WHERE RECIBO_CONTA IS NULL AND FECHA >= '15.10.2018' group by orden, id_recepcion, id_rechazo";
  	$rs=$this->EjecutaQuerySimple();

  	while($tsArray=ibase_fetch_object($rs)){
  		$data[]=$tsArray;
  	}

  	return $data;
  } 


  function recibeRec($id, $tipo2){
  	
  	$usuario = $_SESSION['user']->NOMBRE; 
  	$id = explode('-', $id);
  	$orden = $id[0];
  	$tipo = $id[1];
  	$id = $id[2];
  	//echo 'Tipo:'.$tipo2; 
  	if($tipo2 == 'Seleccion'){
  			  	if(trim($tipo) == 'Recibo'){
				  	$this->query="SELECT iif(USUARIO_RECIBO_CONTA is null, 'No', USUARIO_RECIBO_CONTA ) AS NOMBRE FROM FTC_DETALLE_RECEPCIONES  WHERE id_recepcion = $id and orden = '$orden' group by USUARIO_RECIBO_CONTA";
				  		$rs  = $this->EjecutaQuerySimple();
				  		//echo 'Obtener Nombre'.$this->query;
				  	}elseif (trim($tipo) == 'Rechazo'){
				  		$this->query="SELECT iif(USUARIO_RECIBO_CONTA is null, 'No', USUARIO_RECIBO_CONTA ) AS NOMBRE FROM FTC_DETALLE_RECEPCIONES  WHERE id_rechazo = $id and orden = '$orden' group by USUARIO_RECIBO_CONTA";
				  		$rs  = $this->EjecutaQuerySimple();
				  	}
			  	$row = ibase_fetch_object($rs);
			  	$nombre = $row->NOMBRE;
			  	//echo 'Nombre : '.$nombre;
			  	if($nombre== 'No'){

			  		if(trim($tipo) == 'Recibo'){
			  			$this->query="UPDATE FTC_DETALLE_RECEPCIONES SET USUARIO_RECIBO_CONTA = '$usuario', recibo_conta = 1, fecha_recibo_conta= current_timestamp where id_recepcion = $id and orden = '$orden'";
			  			$this->EjecutaQuerySimple();
			  				//echo 'Consulta de actualizacion: '.$this->query;
			  		}elseif(trim($tipo) == 'Rechazo'){
			  			$this->query="UPDATE FTC_DETALLE_RECEPCIONES SET USUARIO_RECIBO_CONTA = '$usuario', recibo_conta = 1, fecha_recibo_conta= current_timestamp where id_rechazo = $id and orden = '$orden'";
			  			$this->EjecutaQuerySimple();				
			  		}
			  		$response= array("status"=>"ok","response"=>$usuario);
			  	}else{
			  		$response= array("status"=>"no","response"=>$nombre);
			  	}
  	}elseif($tipo2 == 'NoSeleccionado'){
  			if(trim($tipo) == 'Recibo'){
				  	$this->query="SELECT iif(USUARIO_RECIBO_CONTA is null, 'No', USUARIO_RECIBO_CONTA ) AS NOMBRE FROM FTC_DETALLE_RECEPCIONES  WHERE id_recepcion = $id and orden = '$orden' group by USUARIO_RECIBO_CONTA";
				  		$rs  = $this->EjecutaQuerySimple();
				  	}elseif (trim($tipo) == 'Rechazo'){
				  		$this->query="SELECT iif(USUARIO_RECIBO_CONTA is null, 'No', USUARIO_RECIBO_CONTA ) AS NOMBRE FROM FTC_DETALLE_RECEPCIONES  WHERE id_rechazo = $id and orden = '$orden' group by USUARIO_RECIBO_CONTA";
				  		$rs  = $this->EjecutaQuerySimple();
				  	}
			  	$row = ibase_fetch_object($rs);
			  	$nombre = $row->NOMBRE;

			  	if($nombre== 'No'){

			  		if(trim($tipo) == 'Recibido'){
			  			$this->query="UPDATE FTC_DETALLE_RECEPCIONES SET USUARIO_RECIBO_CONTA = '$usuario', recibo_conta = 0, fecha_recibo_conta= current_timestamp where id_recepcion = $id and orden = '$orden'";
			  			$this->EjecutaQuerySimple();	
			  		}elseif(trim($tipo) == 'Rechazo'){
			  			$this->query="UPDATE FTC_DETALLE_RECEPCIONES SET USUARIO_RECIBO_CONTA = '$usuario', recibo_conta = 0, fecha_recibo_conta= current_timestamp where id_rechazo = $id and orden = '$orden'";
			  			$this->EjecutaQuerySimple();				
			  		}
			  		$response= array("status"=>"ok","response"=>$usuario);
			  	}else{
			  		$response= array("status"=>"no","response"=>$nombre);
			  	}

  	}
  	
  	return $response;
  }


   function layoutBBVA($docs){
  	$usuario = $_SESSION['user']->NOMBRE;
  	$TIME = time();
	$HOY = date("Y-m-d THi");
  	$this->query="SELECT iif(MAX(NUMERO) is null, 0, max(numero)) AS NUMERO FROM LAYOUT_BBVA";
  	$rs=$this->EjecutaQuerySimple();
  	$row1 = ibase_fetch_object($rs);
  	$numero  = $row1->NUMERO + 1;
  	$total = 0;	
  	for($i=0; $i< count($docs); $i++){
  	if( substr($docs[$i],0,1) == 'O') {
  		$this->query="SELECT COSTO_TOTAL FROM FTC_POC WHERE OC = '$docs[$i]'";
  		$result = $this->EjecutaQuerySimple();
  		$row4=ibase_fetch_object($result);
  		$ct = $row4->COSTO_TOTAL;
  	}else{
  		$this->query="SELECT MONTO FROM SOLICITUD_PAGO WHERE IDsol = $docs[$i]";
  		$res = $this->EjecutaQuerySimple();
  		$row4 = ibase_fetch_object($res);
  		$ct = $row4->MONTO;
  	}
  		$total = $total + $ct;
  	}
  	for ($i=0; $i < count($docs); $i++){ 
  		echo 'Documento '.$i.' : '.$docs[$i].'<p>';
  		if(substr($docs[$i], 0,1) == 'O'){
		  		$this->query="SELECT * FROM FTC_POC F LEFT JOIN PROV01 P ON P.CLAVE = F.CVE_PROV WHERE OC= '$docs[$i]'";
		  		$res = $this->EjecutaQuerySimple();
		  		$row = ibase_fetch_object($res);
		  		$CTT = $row->COSTO_TOTAL;
		  		$this->query="INSERT INTO LAYOUT_BBVA (ID, NUMERO, CLAVE, NOMBRE, DOCUMENTO, IMPORTE, FECHA, USUARIO, CUENTA, status) VALUES (NULL, $numero ,'$row->CLAVE', '$row->NOMBRE', '$docs[$i]', $row->COSTO_TOTAL, CURRENT_TIMESTAMP, '$usuario', '$row->CUENTA', 0)";
		  		$this->EjecutaQuerySimple();
		  	}else{
		  		$this->query="SELECT * FROM SOLICITUD_PAGO S LEFT JOIN PROV01 P ON P.CLAVE = S.PROVEEDOR WHERE IDSOL= $docs[$i]";
		  		$res = $this->EjecutaQuerySimple();
		  		$row = ibase_fetch_object($res);
		  		$CTT = $row->MONTO;

		  		$this->query="INSERT INTO LAYOUT_BBVA (ID, NUMERO, CLAVE, NOMBRE, DOCUMENTO, IMPORTE, FECHA, USUARIO, CUENTA, status) VALUES (NULL, $numero ,'$row->CLAVE', '$row->NOMBRE', '$docs[$i]', $row->MONTO, CURRENT_TIMESTAMP, '$usuario', '$row->CUENTA', 0)";
		  		$this->EjecutaQuerySimple();
		  	}
  		$file = fopen("app\LayoutBBVA\LayOut_BBVA_".$numero."_".$HOY."_".round($total).".txt","a");
  		if(substr($row->CUENTA,0,3) == '012' or substr($row->CUENTA,0,3) == '000'){
  			if(substr($row->CUENTA,0,3) == '012'){
  				$cuentaProveedor = '00000000'.substr($row->CUENTA,7,10);	
  			}elseif (substr($row->CUENTA,0,3) == '000'){
  				$cuentaProveedor = '00000000'.substr($row->CUENTA,8,10);	
  			}
  			$tipo = 'PTC';
  			$banco = substr($row->CUENTA, 0,3);
  			$importe= str_pad(number_format($CTT, 2, '.',''),16,"0",STR_PAD_LEFT);
  			$motivo = str_pad($docs[$i].$numero, 30, " ");
  			//$refnumerica = str_pad($numero,7,"0",STR_PAD_LEFT);
  			$nombreProveedor = str_pad(substr($row->NOMBRE,0,30),30," ");
  			fwrite($file,$tipo.$cuentaProveedor.'000000000156324495'.'MXP'.$importe.$motivo.PHP_EOL);
  		}else{
  			$tipo = 'PSC';
  			$importe= str_pad(number_format($CTT, 2, '.',''),16,"0",STR_PAD_LEFT);
  			$motivo = str_pad($docs[$i], 30, " ");
  			$refnumerica = str_pad($numero,7,"0",STR_PAD_LEFT);
  			$nombreProveedor = str_pad(substr($row->NOMBRE,0,30),30," ");
  			$cuentaProveedor = $row->CUENTA;
  			$banco = substr($row->CUENTA,0,3);
  			fwrite($file,$tipo.$cuentaProveedor.'000000000156324495'.'MXP'.$importe.$nombreProveedor.'40'.$banco.$motivo.$refnumerica.'H'.PHP_EOL);
  		}


  		fclose($file);

  		if(substr($docs[$i], 0,1) == 'O'){
  			$this->query="UPDATE FTC_POC SET USUARIO_PAGO = '$usuario' where oc = '$docs[$i]'";
  			$this->EjecutaQuerySimple();
  		}else{
  			$this->query="UPDATE SOLICITUD_PAGO SET USUARIO_PAGO = '$usuario' where idsol = $docs[$i]";
  			$this->EjecutaQuerySimple();

  		}
  	}
  	return;
  }


  function verLayOut(){
  		$this->query="SELECT NUMERO, SUM(IMPORTE) as importe , MAX(FECHA) as fecha, MAX(USUARIO) as usuario, MAX(STATUS) as status FROM LAYOUT_BBVA GROUP BY NUMERO";
  		$rs=$this->EjecutaQuerySimple();

  		while($tsArray=ibase_fetch_object($rs)){
  			$data[]=$tsArray;
  		}
  		return $data;
  }


  function generaComprobantes($datos){
  	$usuario = $_SESSION['user']->NOMBRE;
  	foreach ($datos as $key) {
  		//echo 'OC: '.$key['OC'].' Importe: '.$key['IMPORTE'].' STATUS: '.$key['STATUS'].'<p>';
  		$oc = $key['OC'];
  		$importe = $key['IMPORTE'];
  		$status = $key['STATUS'];
  		$proveedor = $key['PROVEEDOR'];
  		$numero = $key['NUMERO'];
  		$status1 = $key['STATUS1'];  		
  		if(substr($oc, 0,1)== 'O'){
  			
  			$this->query="UPDATE LAYOUT_BBVA SET STATUS = $status1 where status =0 and documento = '$oc' and importe = $importe and numero = $numero";
	  		@$this->EjecutaQuerySimple();	
  		}else{
  			$oc = substr($oc, 0,4);
  			$this->query="UPDATE LAYOUT_BBVA SET STATUS = $status1 where status =0 and documento = '$oc' and importe = $importe";
	  		@$this->EjecutaQuerySimple();
  		}
  		echo 'Documento:'.$oc.' status = '.$status1.'<p>';
  		if($status1 == 6){
  		$st = 'Operado';
  		$this->query="INSERT INTO P_TRANS (TIPO, FECHA, MONTO, BENEFICIARIO, IVA, DOCUMENTO, FECHAELAB, CVE_PROV,STATUS,FECHA_DOC, FECHA_APLI, TRANS, USUARIO_PAGO, BANCO) VALUES ( 'tr', current_timestamp ,$importe, '$proveedor', $importe / 1.16, '$oc', current_timestamp, (SELECT CVE_PROV FROM FTC_POC WHERE OC = trim('$oc')) , 'N',(select FECHA_OC FROM FTC_POC WHERE OC  = trim('$oc')), current_timestamp, '0', '$usuario', 'Bancomer - 0156324495')";
  		@$this->EjecutaQuerySimple();
		  		if(substr($oc, 0,1)== 'O'){
		  		echo 'Inserta Pago: <p>'.$this->query.'<p>';
		  		$this->query="UPDATE ftc_poc SET TP_TES = 'Tr', PAGO_TES = $importe, FECHA_PAGO = current_timestamp, STATUS = 'PAGADA' WHERE Trim(OC) = trim('$oc')";
		  		$this->EjecutaQuerySimple();
		  		echo 'Consulta para Ordenes de compra: '.$this->query.'<p>';
		  		}else{
		  		$this->query="UPDATE SOLICITUD_PAGO SET TP_TES_FINAL = 'Tr',MONTO_FINAL = $importe, BANCO_FINAL = 'Bancomer - 0156324495', fecha_reg_pago_final= CURRENT_DATE, FECHA_PAGO = CURRENT_TIMESTAMP, STATUS = 'Pagado' where idsol = $oc";
		  		$this->EjecutaQuerySimple();
				//echo 'Consulta para solicitudes: '-$this->query.'<p>';
				}
  		echo 'Actualia ftc_poc : <p> '.$this->query.'<p>';
  		}else{

  			if($status1 == 5){
  				$st = 'Rechazado en la operación';
  				
  				if(substr($oc, 0,1)== 'O'){
		  		$this->query="UPDATE FTC_POC SET usuario_pago = null where trim(OC) = trim('$oc')";
  				$this->EjecutaQuerySimple();
				}else{
		  		$this->query="UPDATE SOLICITUD_PAGO SET  usuario_pago = null where idsol = $oc";
		  		$this->EjecutaQuerySimple();
				//echo 'Consulta para solicitudes: '-$this->query.'<p>';
				}


  			}elseif($status1 == 8){
  				$st = 'Rechazado en validación';
  				if(substr($oc, 0,1)== 'O'){
		  		$this->query="UPDATE FTC_POC SET usuario_pago = null where trim(OC) = trim('$oc')";
  				$this->EjecutaQuerySimple();
				}else{
		  		$this->query="UPDATE SOLICITUD_PAGO SET  usuario_pago = null where idsol = $oc";
		  		$this->EjecutaQuerySimple();
				//echo 'Consulta para solicitudes: '-$this->query.'<p>';
				}

  			}else{
  				$st = 'No Identificado';
  			}
  				if(substr($oc, 0,1)== 'O'){
		  			$this->query="UPDATE ftc_poc SET STATUStr = '$st' WHERE Trim(OC) = trim('$oc')";
		  			$this->EjecutaQuerySimple();
		  		}else{

		  		$this->query="UPDATE SOLICITUD_PAGO SET statustr = '$st' where idsol = $oc";
		  		$this->EjecutaQuerySimple();
				//echo 'Consulta para solicitudes: '-$this->query.'<p>';
				}

  		}
  	}
  	//break;
  	return;
  }


  function guardaPedido($target_file, $cotizacion){
  	$this->query="UPDATE CAJAS_ALMACEN SET NOMBRE_ARCHIVO = '$target_file' where pedido = '$cotizacion'";
  	$this->EjecutaQuerySimple();
   	return;
  }

  function actualizaProveedorBBVA($datos){

  		foreach ($datos as $key ){
  			$clave = $key['CVE_PROV'];
  			$res = trim($key['Resultado']);
  			$cuenta = ($key['Cuenta']);
  			$banco =$key['Banco'];
  			/// ALTA EXITOSA
  			/// REGISTRO YA EXISTE 
  			/// CUENTA INEXISTENTE
  			/// CUENTA NO VALIDA
  			if($res=='ALTA EXITOSA' or $res == 'REGISTRO YA EXISTE'){
  				$status = 2;
  			}elseif ($res=='CUENTA INEXISTENTE' OR $res =='CUENTA NO VALIDA'){
  				$status = 8;
  			}else{
  				$status = 9;
  			}
  			if($banco == '000'){
  				$banco = '012';
  			}
  			$this->query="UPDATE PROV01 SET BBVA_ALTA = $status, Ultimo_status = '$res', CUENTA = '$cuenta', banco = '$banco' WHERE trim(clave) = trim('$clave')";
  			$this->EjecutaQuerySimple();
  			//echo $this->query.'<p>';
  		}
  		return;		
  }

    function calculoComisiones($anio , $mes, $vendedor){
  	$a = '';
  	$this->query="UPDATE factd01 set vendedor_real = (select vendedor from ftc_cotizacion where pedido_liberado= cve_cotizacion) where vendedor_real is null";
  	$this->grabaBD();
  	if($vendedor != 'all'){
  		$a = " and vendedor_real  ='".$vendedor."'"; 
  	}
	  	$this->query="SELECT 'f' as tipo, CVE_CLPV, NOMBRE, CVE_DOC, NC_APLICADAS, FECHAELAB, IMPORTE, PAGOS, IMPORTE_NC, SALDOFINAL, PEDIDO, VENDEDOR_REAL
	  	  	FROM FACTURAS f  
	  	  	WHERE EXTRACT(YEAR FROM FECHA_DOC) = $anio 
	  	  		AND EXTRACT(MONTH FROM FECHA_DOC) = $mes $a";
	  	$rs= $this->EjecutaQuerySimple();
	  	while($tsArray=ibase_fetch_object($rs)){
	  		$data[]=$tsArray;
	  	}
	if($vendedor != 'all'){
  		$a = " and nc.vendedor_real  ='".$vendedor."'"; 
  	}
	  	$this->query="SELECT 'nc' as tipo, nc.CVE_CLPV, NOMBRE, nc.CVE_DOC, 0 AS NC_APLICADAS, nc.FECHAELAB, (nc.IMPORTE / 1.16) as importe, 0 AS PAGOS, 0 AS IMPORTE_NC, nc.IMPORTE AS SALDOFINAL, pedido, (select vendedor from ftc_cotizacion where (serie||folio) = pedido) as vendedor_real FROM FACTD01 NC LEFT JOIN FACTURAS F ON NC.DOC_ANT = F.CVE_DOC WHERE nc.status <> 'C' and extract(year from nc.fecha_doc) = $anio and extract(month from nc.fecha_doc) = $mes $a";
	  	$rs=$this->EjecutaQuerySimple();
	  	while ($tsArray = ibase_fetch_object($rs)){
	  		$data[]=$tsArray;
	  	}
  	return @$data;
  }

  function vendedores(){
  	$this->query="SELECT * FROM PG_USERS WHERE USER_ROL='ventasp' and user_status = 'alta'";
  	$rs=$this->EjecutaQuerySimple();

  	while($tsArray=ibase_fetch_object($rs)){
  		$data[] = $tsArray;
  	}
  	return $data;
  }


  function verRemisionesPendientes($grabar){
  	$usuario  = $_SESSION['user']->NOMBRE;
  	$fa = 1;
  	$f = date('j');
  	$m = date('n');
  	$a = date('Y');
  	$dia = date('N'); /// dia 1 para el Lunes 7 para domingo.
  	if($dia == 6 ){
  		$f = $f - 1;
  	}elseif($dia == 7){
  		$f = $f - 2;
  	}  
  	$this->query="SELECT pf.CVE_DOC FROM PAR_FACTR01 pf left join factr01 f on f.cve_doc = pf.cve_doc WHERE PXS > 0 and f.fechaelab >= '01.01.2017' and f.status <> 'C' GROUP BY pf.CVE_DOC";
  	$rs=$this->EjecutaQuerySimple();
  	while ($tsArray=ibase_fetch_object($rs)) {
  		$remisiones[]= $tsArray;
  	}
  	foreach ($remisiones as $key) {
  		$remision = $key->CVE_DOC;
  		$this->query="UPDATE PAR_FACTR01 SET MTO_CUOTA = ((PXS*PREC) - ((PXS * PREC) * (DESC1/100)))  WHERE CVE_DOC = '$remision'";
  		$rs=$this->queryActualiza();

  	}
  	$this->query="SELECT  max(doc_sig) as factura, max(doc_ant) as pedidoPegaso, max(importe) as importe,  max(cl.nombre) as nombre , R.CVE_DOC, SUM(PXS) as pendientes, MAX(FECHAELAB) as fechaelab, max(cve_pedi) as pedido, sum(MTO_CUOTA) as subtotal FROM PAR_FACTR01 PR LEFT JOIN FACTR01 R ON R.CVE_DOC = PR.CVE_DOC left join clie01 cl on cl.clave = R.cve_clpv  WHERE R.FECHAELAB >= '01.01.2017' and r.status !='C' GROUP BY R.CVE_DOC HAVING SUM(PXS) > 0";
  	$rs=$this->EjecutaQuerySimple();

  	while ($tsArray=ibase_fetch_object($rs)){
  		$data[]=$tsArray;
  	}

  	if($grabar == 1 and $f != $fa){	
  		$f = 1;
  		if($f != 1){
  		$mensaje = "<script>alert('Solo se permite cerrar el primer dia del mes.') </script>";
  			return $mensaje;
  		}
  		$this->query="SELECT max(mes) as mes  FROM CIERRE_MENSUAL WHERE TIPO ='Remisiones' and anio = $a";
  		$rs=$this->EjecutaQuerySimple();
  		$row2 = ibase_fetch_object($rs);
  	
  		if($row2->MES >= $m and !empty($row2->MES)){
  			$mensaje = "<script>alert('Ya se Realizo el Cierre de este periodo.') </script>";
  			return $mensaje;
  		}else{
  			//$m = $row2->MES + 1;
  			$this->query="EXECUTE PROCEDURE INVENTARIO_REMISIONES($a, $m,'$usuario' )";
	  		$res = $this->EjecutaQuerySimple();
	  		$row = ibase_fetch_object($res);
	  		$mensaje = "<script>alert('Se ha Guardado: ' + $row->PARTIDAS + 'partidas pendientes de las remisiones' );</script>";
	  		$this->query="INSERT INTO  CIERRE_MENSUAL (TIPO, MES, ANIO, FECHA_CIERRE, USUARIO_CIERRE, FINAL) VALUES ('Remisiones', $m,  $a,  current_timestamp, '$usuario', 
	  		(SELECT SUM(COSTO_TOTAL) FROM INVENTARIO_MENSUAL WHERE ORIGEN = 'Remisiones' and mes = $m and anio = $a))";
	  		$this->EjecutaQuerySimple();

	  		$this->query="UPDATE INVENTARIO_MENSUAL SET STATUS = 1 WHERE  ORIGEN = 'Remisiones' and mes = $m and anio = $a and status is null";
	  		$this->queryActualiza();
			return $mensaje; 
  		}
   	}
  	return $data;
  }

  function crearSubMenuMeses($tipo){
  	$this->query="SELECT cm.*, extract(month from fecha_cierre) as mes, extract(year from fecha_cierre) as anio from cierre_mensual cm where tipo = 'Remisiones'";
  	$RS=$this->EjecutaQuerySimple();
  	while ($tsArray=ibase_fetch_object($RS)){
  		$data[]=$tsArray;
  	}
  	return $data;
  }


  function verInventarios($mes, $anio, $tipo){
  		
  		if($tipo == 'Remisiones'){
  			$this->query="SELECT IM.*, R.*, C.*, (SELECT FIRST 1 PREC FROM PAR_FACTR01 WHERE CVE_DOC = R.CVE_DOC AND CVE_ART = IM.PRODUCTO ) AS PRECIO  FROM INVENTARIO_MENSUAL IM 
  		LEFT JOIN FACTR01 R ON R.CVE_DOC = IM.CAJA 
  		LEFT JOIN CLIE01 C ON C.CLAVE = R.CVE_CLPV 
  		WHERE IM.STATUS = 1 
  			AND mes = $mes 
  			AND anio = $anio 
  			and origen = '$tipo'";
  			
  		}elseif($tipo == 'Bodega'){
  			$this->query="SELECT IM.*, im.costos as costo, im.cantidad as restante,pftc.um as unidad,  PFTC.MARCA, PFTC.CATEGORIA, PFTC.UM, PFTC.COSTO_VENTAS, PFTC.PROVEEDOR
  			FROM INVENTARIO_MENSUAL IM 
  			LEFT JOIN PRODUCTO_FTC PFTC ON PFTC.CLAVE = IM.PRODUCTO
  			WHERE mes = $mes 
  			AND anio = $anio 
  			AND im.status is null 
  			and origen = '$tipo'";
  		}elseif($tipo == 'Empaque' ){
  			$this->query="SELECT '' as id, IM.Producto as prod, im.descripcion as nomprod, caja as cotiza, cantidad as enbodega, 0 as empacado , 0 as recepcion,  im.costos as costo, im.cantidad as restante,pftc.um as unidad,  PFTC.MARCA, PFTC.CATEGORIA, PFTC.UM, PFTC.COSTO_VENTAS, PFTC.PROVEEDOR as nom_prov, '' as procesado
  			FROM INVENTARIO_MENSUAL IM 
  			LEFT JOIN PRODUCTO_FTC PFTC ON PFTC.CLAVE = IM.PRODUCTO
  			WHERE mes = $mes 
  			AND anio = $anio 
  			AND im.status is null 
  			and origen = '$tipo'";
  		}
  		//echo $this->query;
  		$rs = $this->EjecutaQuerySimple();		
  		while($tsArray=ibase_fetch_object($rs)){
  			$data[]=$tsArray;
  		}

  		return $data;
  }

  function detalleRemision($docf){
  	$this->query="SELECT pf.*, iif((select descr from inve01 i where pf.cve_art = i.cve_art) is null, (select NOMBRE from producto_ftc where clave = pf.cve_art), (select descr from inve01 i where pf.cve_art = i.cve_art)) as descripcion FROM PAR_FACTR01 pf WHERE CVE_DOC = '$docf'";
  	$rs=$this->EjecutaQuerySimple();
  	while ($tsArray=ibase_fetch_object($rs)) {
  		$data[]=$tsArray;
  	}
  	return $data;
  }

  function abrirCajaBodega(){
  	$this->query="SELECT ca.* FROM CAJAS_ALMACEN ca WHERE STATUS = 1 AND FECHA_ALMACEN >= '01.12.2017' order by FECHA_ALMACEN asc";
  	$rs=$this->EjecutaQuerySimple();
  	while ($tsArray=ibase_fetch_object($rs)){
  		$data[]=$tsArray;
  	}
  	return $data;
  }

  function verCajaAlmacen($pedido){
  	$this->query="SELECT * FROM PREOC01 WHERE COTIZA  = '$pedido'";
  	$rs=$this->EjecutaQuerySimple();

  	while ($tsArray=ibase_fetch_object($rs)) {
  		$data[]=$tsArray;
  	}

  	return $data;
  }


  function buscaFacturaRefac($opcion, $docf){
  		$data = array();
	  	$this->query="SELECT * FROM facturas where upper(cve_doc) = trim(upper('$docf'))";
	  	$rs=$this->EjecutaQuerySimple();
	  	while($tsArray = ibase_fetch_object($rs)){
	  		$data[]=$tsArray;
	  	}
	  	if(empty($data)){
	  		$this->query="SELECT * FROM facturas_fp where upper(cve_doc) = trim(upper('$docf'))";
	  		$rs=$this->EjecutaQuerySimple();
	  		while($tsArray = ibase_fetch_object($rs)){
	  		$data[]=$tsArray;
	  		}
	  	}
  	return @$data;
  }

  function nclog($docf, $tipo){
  	$usuario = $_SESSION['user']->NOMBRE;
  	$tipoUsuario = $_SESSION['user']->LETRA;
  	$this->query="SELECT * FROM facturas where cve_doc = '$docf'";
  	$rs=$this->EjecutaQuerySimple();
  	$row=ibase_fetch_object($rs);
  	if(strpos(strtoupper($row->NOMBRE_MAESTRO) ,'SUBURBIA') !== false and $tipoUsuario == 'G'){
  		$this->query="SELECT * FROM FACTF01 WHERE CVE_DOC = '$docf'";
  		$rs=$this->EjecutaQuerySimple();
  		$row=ibase_fetch_object($rs);
  		if($row->VALIDACION == '' OR empty($row->VALIDACION)){
  			$this->query="UPDATE FACTF01 SET VALIDACION = iif((SELECT MAX(cast(substring(validacion from 4 for 9) as int)) FROM FACTF01 WHERE VALIDACION CONTAINING ('SUB')) is null, 'SUB0', 'SUB'||(cast((SELECT MAX(cast(substring(validacion from 4 for 9) as int)) FROM FACTF01 WHERE VALIDACION CONTAINING ('SUB')) as int)  + 1)) WHERE CVE_DOC = '$docf'";
  			//echo $this->query;
  			$res=$this->queryActualiza();
  			if($res == 1){
  				return $mensaje=array("status"=>'ok');
  			}else{
  				return $mensaje=array("status"=>'no');
  			}
  		}else{
  			return $mensaje=array("status"=>'no');
  		}

  	}
  }

  function historicoRefac($facturas){
  	foreach ($facturas as $key) {
  		$this->query="SELECT * FROM REFACTURACION WHERE FACT_ORIGINAL = UPPER(TRIM('$key->CVE_DOC'))";
  		$rs=$this->EjecutaQuerySimple();
  	
  		while ($tsArray=ibase_fetch_object($rs)) {
  			$data[]=$tsArray;
  		}
  	}

  	return @$data;
  }

    function traeClientes3($factura){
        //var_dump($factura);
        foreach ($factura as $key ) {
        @$maestro = $key->CLAVE_MAESTRO;
        $cliente = $key->CVE_CLPV;
        }
        if(empty($maestro)){
        	$this->query="SELECT CVE_MAESTRO FROM CLIE01 WHERE CLAVE = '$cliente'";
        	$res=$this->EjecutaQuerySimple();
        	$row=ibase_fetch_object($res);
        	$maestro = $row->CVE_MAESTRO;
        }
    	$this->query="SELECT * FROM CLIE01 WHERE STATUS = 'A' and cve_maestro = '$maestro'";
    	$rs=$this->EjecutaQuerySimple();
    	while ($tsArray=ibase_fetch_object($rs)) {
    		$data[]=$tsArray;
    	}

    	return $data;
    }


    function traeDetalleFactura($facturas){
    	//echo 'Este es el tipo de variable: '.gettype($facturas);
	    	$data=array();
	    	if(gettype($facturas) == 'array'){
	    		foreach($facturas as $key) {
	    			$this->query="SELECT * FROM PAR_FACTF01 pf left join producto_ftc ftca on ftca.clave = pf.cve_art WHERE CVE_DOC= '$key->CVE_DOC'";
	    			$rs=$this->EjecutaQuerySimple();
	    		    //echo $this->query;
	    			while($tsArray=ibase_fetch_object($rs)){
	    				$data[]=$tsArray;
	    			}
	    		}
	    		if(empty($data)){
	    			foreach($facturas as $key){
		    			$this->query="SELECT * FROM DETALLE_FACTURAS_FP  WHERE CVE_DOC = '$key->CVE_DOC'";
		    			$rs=$this->EjecutaQuerySimple();
			    			while ($tsArray=ibase_fetch_object($rs)) {
			    				$data[]=$tsArray;
			    			}
	    			}
	    		}	
	    	}else{
	    		$this->query="SELECT * FROM PAR_FACTF01 pf left join producto_ftc ftca on ftca.clave = pf.cve_art WHERE CVE_DOC= '$facturas'";
	    		$rs=$this->EjecutaQuerySimple();
	    			while ($tsArray=ibase_fetch_object($rs)) {
	    				$data[]=$tsArray;
	    			}
	    		if(empty($data)){
	    			$this->query="SELECT * FROM DETALLE_FACTURAS_FP fd WHERE CVE_DOC = '$facturas'";
	    			$rs=$this->EjecutaQuerySimple();
		    			while ($tsArray=ibase_fetch_object($rs)) {
		    				$data[]=$tsArray;
		    			}
	    		}
	    	}
  		return @$data;
    }

  	function facturaProcesoCambioFecha($docf){
	  	$usuario = $_SESSION['user']->NOMBRE;
	  	$this->query="SELECT CTRL_FACT, ID_REFACT from FACTF01 WHERE CVE_DOC = '$docf'";
	  	$rs=$this->EjecutaQuerySimple();
	  	$row = ibase_fetch_object($rs);
		  	if($row->CTRL_FACT == 'EN PROCESO'){
		  		$status = 'status: enProceso';
		  	}elseif($row->CTRL_FACT == 'Refacturado'){
		  		$statsu = 'status: refacturado';
		  	}else{
			  	$this->query="UPDATE FACTF01 SET CTRL_FACT = 'EN PROCESO', USUARIO_SOLICITUD= '$usuario' WHERE CVE_DOC = '$docf'";
			  	$this->EjecutaQuerySimple();
			  	$statsu = 'status: ok';
		  	}
	}
	
	function refacturarFecha($docf, $nf, $obs, $opcion){
			$usuario =$_SESSION['user']->NOMBRE;
			$docf = trim($docf);
			$docf = strtoupper($docf);

			$this->query="SELECT * FROM FACTF01 WHERE CVE_DOC = upper(trim('$docf'))";
		  	$rs=$this->EjecutaQuerySimple();
		  	$row =ibase_fetch_object($rs);
		  	if(empty($row)){
			  	$this->query="SELECT * FROM FACTR01 WHERE CVE_DOC = upper(trim('$docf'))";
			  	$rs=$this->EjecutaQuerySimple();
			  	$row =ibase_fetch_object($rs);
		  	}

			if(empty($row)){
			  	$this->query="SELECT * FROM FACTURAS_FP WHERE CVE_DOC = upper(trim('$docf'))";
			  	$rs=$this->EjecutaQuerySimple();
			  	$row =ibase_fetch_object($rs);
		  	}
		  	//// obtenemos los datos fiscales actuales:
		  		$satcfdi= '';
		  		$satmp ='';
		  		$satfp = '';
		  		//if(substr($row->CVE_DOC,0,2)  == 'FA' ){
		  		//	$satcfdi = $row->USO_CFDI; 
		  		//	$satmp = $row->METODODEPAGO;
		  		//	$satfp = $row->FORMADEPAGOSAT;
		  		//}elseif(substr($row->CVE_DOC,0,2)=='FP'){
		  			$satcfdi = $row->SAT_USO; 
		  			$satmp = $row->SAT_MP;
		  			$satfp = $row->SAT_FP;
		  		//}
		  	$this->query="SELECT MIN(STATUS_SOLICITUD) AS VALIDACION FROM REFACTURACION WHERE FACT_ORIGINAL = '$docf'";
		  	$res=$this->EjecutaQuerySimple();
		  	$row2=ibase_fetch_object($res);

			  	if($row->STATUS != 'C' and @$row2->VALIDACION != 1){
			  		if($opcion == 1 ){
				  		$this->query="INSERT INTO REFACTURACION (ID, FACT_ORIGINAL, USUARIO_SOLICITUD, FECHA_SOLICITUD, STATUS_SOLICITUD, TIPO_SOLICITUD, NUEVA_FECHA, observaciones, CAJA ) VALUES (NULL, '$docf', '$usuario', current_timestamp, 0, 'CAMBIO FECHA','$nf', '$obs', (SELECT first 1 ID FROM CAJAS WHERE FACTURA CONTAINING ('$docf') order by id desc))";
				  		$this->grabaBD();

				  		$this->query="INSERT INTO REFACTURACION_DETALLE (ID_REFAC, NUEVA_FECHA, OBSERVACIONES, SAT_USO_ACTUAL, SAT_FP_ACTUAL, SAT_MP_ACTUAL, CLIENTE_ACTUAL, RFC_ACTUAL) 
				  						VALUES ( (SELECT MAX(ID) FROM REFACTURACION), '$nf', '$obs', '$satcfdi', '$satmp', '$satfp', TRIM('$row->CVE_CLPV'),TRIM('$row->RFC'))";
				  		$this->grabaBD();

			  		}elseif($opcion == 2){
				  		$this->query="INSERT INTO REFACTURACION (ID, FACT_ORIGINAL, USUARIO_SOLICITUD, FECHA_SOLICITUD, STATUS_SOLICITUD, TIPO_SOLICITUD, NUEVO_CLIENTE, observaciones, NUEVA_FECHA , CAJA) VALUES (NULL, '$docf', '$usuario', current_timestamp, 0, 'CAMBIO CLIENTE',TRIM('$nf'), '$obs', current_date, (SELECT ID FROM CAJAS WHERE FACTURA CONTAINING ('$docf')) )";
				  		$this->grabaBD();
				  		
				  		$this->query="INSERT INTO REFACTURACION_DETALLE (ID_REFAC, NUEVO_CLIENTE, OBSERVACIONES, NUEVA_FECHA, SAT_USO_ACTUAL, SAT_MP_ACTUAL, SAT_FP_ACTUAL, CLIENTE_ACTUAL, RFC_ACTUAL, RFC_NUEVO) 
				  			VALUES ( (SELECT MAX(ID) FROM REFACTURACION), '$nf', '$obs', CURRENT_DATE, '$satcfdi', '$satmp','$satfp',TRIM('$row->CVE_CLPV'),TRIM('$row->RFC'), (SELECT RFC FROM CLIE01 WHERE CLAVE_TRIM = TRIM('$nf')))";
				  		$this->grabaBD();
			  		}elseif ($opcion == 6){
			  			$this->query="INSERT INTO REFACTURACION (ID, FACT_ORIGINAL, USUARIO_SOLICITUD, FECHA_SOLICITUD, STATUS_SOLICITUD, TIPO_SOLICITUD, NUEVO_CLIENTE, observaciones, NUEVA_FECHA , CAJA) VALUES (NULL, '$docf', '$usuario', current_timestamp, 0, 'Cancela y Sustituye',null, '$obs', current_date, (SELECT first 1 ID FROM CAJAS WHERE FACTURA CONTAINING ('$docf')) )";
				  		$this->grabaBD();
				  		
				  		$this->query="INSERT INTO REFACTURACION_DETALLE (ID_REFAC,  OBSERVACIONES, NUEVA_FECHA, SAT_USO_ACTUAL, SAT_MP_ACTUAL, SAT_FP_ACTUAL, CLIENTE_ACTUAL, RFC_ACTUAL, RFC_NUEVO) 
				  			VALUES ( (SELECT MAX(ID) FROM REFACTURACION), '$obs', CURRENT_DATE, '$satcfdi', '$satmp','$satfp',TRIM('$row->CVE_CLPV'),TRIM('$row->RFC'), (SELECT RFC FROM CLIE01 WHERE CLAVE = '$row->CVE_CLPV'))";
				  		$this->grabaBD();
			  		}elseif ($opcion==3) {
			  			$this->query="INSERT INTO REFACTURACION (ID, FACT_ORIGINAL, USUARIO_SOLICITUD, FECHA_SOLICITUD, STATUS_SOLICITUD, TIPO_SOLICITUD, NUEVO_CLIENTE, observaciones, NUEVA_FECHA , CAJA) 
			  				VALUES (NULL, '$docf', '$usuario', current_timestamp, 0, 'MIGRACION FACTURA',null, '$obs', current_date, (SELECT first 1 ID FROM CAJAS WHERE FACTURA CONTAINING ('$docf')))";
				  		$this->grabaBD();
				  		$this->query="INSERT INTO REFACTURACION_DETALLE (ID_REFAC,  OBSERVACIONES, NUEVA_FECHA, SAT_USO_ACTUAL, SAT_MP_ACTUAL, SAT_FP_ACTUAL, CLIENTE_ACTUAL, RFC_ACTUAL, RFC_NUEVO) 
				  			VALUES ( (SELECT MAX(ID) FROM REFACTURACION), '$obs', CURRENT_DATE, '$satcfdi', '$satmp','$satfp',TRIM('$row->CVE_CLPV'),TRIM('$row->RFC'), (SELECT RFC FROM CLIE01 WHERE CLAVE = '$row->CVE_CLPV'))";
				  		$this->grabaBD();

				  		$res=$this->crearFoliosRefact();

				  		$folioRFP=$res["folioRFP"];
				  		$serieF=$res["serieF"];
				  		$folioF=$res["folioF"]; 
						$folioNCRP= $res["folioNCRP"];
						$serieN = $res["serieN"];
						$folioNC = $res["folioNC"];
						$cliente = trim($row->CVE_CLPV);

						$this->query="EXECUTE PROCEDURE SP_MIGRAR_FP ('$docf','$folioNCRP', '$cliente', '$folioF', '$serieF','$folioRFP', '$usuario')";
				  		$res=$this->EjecutaQuerySimple();
				  		//echo $this->query.'<br/>';
				  		while ($tsArray = ibase_fetch_object($res)) {
				  			$data[]=$tsArray;
				  		}
				  		//var_dump($data);
						$this->query="SELECT * FROM PAR_FACTF01 WHERE CVE_DOC = '$docf'";
						$rs = $this->EjecutaQuerySimple();
						while ($tsArray=ibase_fetch_object($rs)) {
							$data2[] = $tsArray;
						}
				  		$partida=0;
						foreach ($data2 as $key) {
							$partida ++;
							$parto = $key->NUM_PAR;
							$facto = $docf;
							$factn = $folioF;
							$this->query="EXECUTE PROCEDURE SP_MIGRAR_FP_DETALLE($parto, '$facto', '$factn', $partida, '$usuario', '$factn')";
				  			$this->EjecutaQuerySimple();
						}
				  		
						$this->query="UPDATE Refacturacion SET FACTURA_NUEVA = '$factn' WHERE ID = (SELECT MAX(ID_REFAC) FROM REFACTURACION_DETALLE) ";
						$this->EjecutaQuerySimple();
			  		}	
		  		}	
  		return; 
    }

    function refacturarSAT($docf, $satUso, $satFP, $satMP, $obs, $opcion){
    	$usuario = $_SESSION['user']->NOMBRE;
    		$docf=strtoupper($docf);
    		$this->query="SELECT * FROM FACTF01 WHERE CVE_DOC = upper(trim('$docf'))";
		  	$rs=$this->EjecutaQuerySimple();
		  	$row =ibase_fetch_object($rs);
		  	if(empty($row)){
			  	$this->query="SELECT * FROM FACTR01 WHERE CVE_DOC = upper(trim('$docf'))";
			  	$rs=$this->EjecutaQuerySimple();
			  	$row =ibase_fetch_object($rs);
		  	}
		  	if(empty($row)){
			  	$this->query="SELECT * FROM FACTURAS_FP WHERE CVE_DOC = upper(trim('$docf'))";
			  	$rs=$this->EjecutaQuerySimple();
			  	$row =ibase_fetch_object($rs);
		  	}
			$this->query="SELECT MIN(STATUS_SOLICITUD) AS VALIDACION FROM REFACTURACION WHERE FACT_ORIGINAL = '$docf'";
		  	$res=$this->EjecutaQuerySimple();
		  	$row2=ibase_fetch_object($res);
		  		if( ($row->STATUS != 'C' or $row->STATUS != 9) and @$row2->VALIDACION != 1){
			  		if($opcion == 3 ){
				  		$this->query="INSERT INTO REFACTURACION (ID, FACT_ORIGINAL, USUARIO_SOLICITUD, FECHA_SOLICITUD, STATUS_SOLICITUD, TIPO_SOLICITUD, NUEVA_FECHA, observaciones, CAJA ) VALUES (NULL, '$docf', '$usuario', current_timestamp, 1, 'CAMBIO SAT',current_timestamp, '$obs', (SELECT first 1 ID FROM CAJAS WHERE FACTURA CONTAINING ('$docf') order by id desc))";
				  		$this->grabaBD();
				  	  	if(substr($row->CVE_DOC,0,2) == 'FP' or substr($row->CVE_DOC,0,3) == 'RFP'){
				  			$this->query="INSERT INTO REFACTURACION_DETALLE (ID_REFAC, SAT_USO_ACTUAL, SAT_FP_ACTUAL, SAT_MP_ACTUAL, SAT_USO_NUEVO, SAT_FP_NUEVO, SAT_MP_NUEVO, OBSERVACIONES, CLIENTE_ACTUAL, RFC_ACTUAL) 
				  				VALUES ( (SELECT MAX(ID) FROM REFACTURACION), 
					  			(select SAT_USO FROM FACTURAS_FP WHERE CVE_DOC = '$docf'),
					  			(select SAT_FP FROM FACTURAS_FP WHERE CVE_DOC = '$docf'),
					  			(select SAT_MP FROM FACTURAS_FP WHERE CVE_DOC = '$docf'), 
					  			'$satUso',
					  			'$satFP',
					  			'$satMP',
					  			'$obs', 
					  			TRIM('$row->CVE_CLPV'),
					  			TRIM('$row->RFC') )";
					  		$this->grabaBD();	
				  		}elseif(substr($row->CVE_DOC,0,3) == 'FAA' or substr($row->CVE_DOC,0,2) == 'RF'){
				  			$this->query="INSERT INTO REFACTURACION_DETALLE (ID_REFAC, SAT_USO_ACTUAL, SAT_FP_ACTUAL, SAT_MP_ACTUAL,  SAT_USO_NUEVO, SAT_FP_NUEVO, SAT_MP_NUEVO, OBSERVACIONES, CLIENTE_ACTUAL, RFC_ACTUAL) 
				  				VALUES ( (SELECT MAX(ID) FROM REFACTURACION), 
					  			(select SAT_USO FROM FACTURAS WHERE CVE_DOC = '$docf'),
					  			(select substring(SAT_FP from 1 for 3) FROM FACTURAS WHERE CVE_DOC = '$docf'),
					  			(select SAT_MP FROM FACTURAS WHERE CVE_DOC = '$docf'), 
					  			'$satUso',
					  			'$satFP',
					  			'$satMP',
					  			'$obs',
					  			TRIM('$row->CVE_CLPV'),
					  			TRIM('$row->RFC') )";
					  		$this->grabaBD();
				  		}
					}
		  		}	
		return;

    }

    function refacturarDireccion($docf, $calle, $num_ext, $num_int, $colonia, $municipio, $ciudad, $referencia, $obs, $opcion, $cp){
		$usuario =$_SESSION['user']->NOMBRE;
		$docf = trim($docf);
		$docf = strtoupper($docf);
	
		$this->query="SELECT * FROM FACTF01 WHERE CVE_DOC = '$docf'";
	  	$rs=$this->EjecutaQuerySimple();
	  	$row =ibase_fetch_object($rs);

	  	$this->query="SELECT MIN(STATUS_SOLICITUD) AS VALIDACION FROM REFACTURACION WHERE FACT_ORIGINAL = '$docf'";
	  	$res=$this->EjecutaQuerySimple();
	  	$row2=ibase_fetch_object($res);

		    if($row->STATUS != 'C' and $row2->VALIDACION != 1){
			  	/*
			  	$this->query ="UPDATE CLIE01 SET CALLE_ENVIO = '$calle', numext_envio = '$num_ext', numint_envio= '$num_int', colonia_envio = '$colonia', municipio_envio='$municipio', estado_envio= '$ciudad', codigo_envio = '$cp' where clave = '$row->CVE_CLPV'";
			  	$this->EjecutaQuerySimple();
	 	    	echo 'Actualiza Cliente: '.$this->query;
	 	    	*/
	 	    	$this->query="INSERT INTO REFACTURACION (ID, FACT_ORIGINAL, USUARIO_SOLICITUD, FECHA_SOLICITUD, STATUS_SOLICITUD, TIPO_SOLICITUD, observaciones ) VALUES (NULL, '$docf', '$usuario', current_timestamp, 1, 'CAMBIO DOMICILIO','$obs' )";
		  		$this->grabaBD();
		  		//echo 'Ingresa Refacturacion : '.$this->query;

		  		$this->query="INSERT INTO REFACTURACION_DETALLE VALUES (NULL, (SELECT MAX(ID) FROM REFACTURACION), NULL, '$row->CVE_CLPV', '$obs', '$calle', '$num_ext', '$num_int', '$colonia', '$municipio', '$ciudad', '$cp', '$referencia')";
		  		$this->grabaBD();
		  		//echo 'Ingreso a Refacturacion detalle: '.$this->query;
	 	    }
	 	    //break;
	 	return;
	}

    function guardaPartida($docf, $par, $precio, $ncant){
    	$this->query= "SELECT MIN(STATUS_SOLICITUD) AS VALIDACION  FROM REFACTURACION WHERE FACT_ORIGINAL = '$docf'";
    	$rs =$this->EjecutaQuerySimple();
    	$row=ibase_fetch_object($rs);
    	$response = array("status"=>"no", "response"=>'no');
	    	if($row->VALIDACION == 1 or $row->VALIDACION == 0){
	    		$this->query="UPDATE FACTF01 SET CTRL_FACT = 'EN ESPERA' WHERE CVE_DOC = '$docf'";
		    	@$this->grabaBD();
		    	$this->query="UPDATE PAR_FACTF01 SET NUEVO_PRECIO = $precio, NUEVA_CANTIDAD = $ncant, CAMBIO = 'S' where cve_doc = '$docf' and num_par = $par";
		    	@$this->grabaBD();
		    	$this->query="UPDATE FTC_FACTURAS_DETALLE SET NUEVO_PRECIO = $precio, NUEVA_CANTIDAD = $ncant, CAMBIO = 'S' where documento='$docf' and partida=$par";
		    	@$this->grabaBD();
		    	$response= array("status"=>"ok","response"=>'ok');	
	    	}
    	return $response;
    }

    function solicitudPrecio($docf, $clie, $suso, $smp, $sfp, $obs){
    	$usuario=$_SESSION['user']->NOMBRE;

    	$this->query="SELECT coalesce(max(id), 0) as mf, coalesce(FACT_ORIGINAL, '') AS docf  FROM REFACTURACION WHERE FACTURA_NUEVA = '$docf' and TIPO_SOLICITUD = 'MIGRACION FACTURA' group by id, FACT_ORIGINAL";
    	$rs=$this->EjecutaQuerySimple();
    	$rowVal = ibase_fetch_object($rs);
    	$valini =$rowVal->MF;
    	if($valini > 0 ){
    		//$docf=$rowVal->DOCF; 
    		$this->query="UPDATE FTC_FACTURAS SET FORMADEPAGOSAT = '$sfp', METODO_PAGO = '$smp', USO_CFDI = '$suso' where documento = '$docf'";
    		$this->EjecutaQuerySimple();
    		$this->query="UPDATE Refacturacion SET STATUS = 5 WHERE ID = $valini";
    		$this->EjecutaQuerySimple();
    	}

    	$this->query= "SELECT MIN(STATUS_SOLICITUD) AS VALIDACION  FROM REFACTURACION WHERE FACT_ORIGINAL = '$docf'";
    	$rs =$this->EjecutaQuerySimple();
    	$row=ibase_fetch_object($rs);
    	if($row->VALIDACION != 1){
    		$this->query="INSERT INTO REFACTURACION (ID, FACT_ORIGINAL, USUARIO_SOLICITUD, FECHA_SOLICITUD, STATUS_SOLICITUD, TIPO_SOLICITUD ) VALUES (NULL, '$docf', '$usuario', current_timestamp, 1, 'CAMBIO PRECIO')";
	    	$this->grabaBD();
	    	$this->query = "INSERT INTO REFACTURACION_DETALLE (ID, ID_REFAC, NUEVA_FECHA, NUEVO_CLIENTE, OBSERVACIONES, SAT_USO_NUEVO, SAT_MP_NUEVO, SAT_FP_NUEVO, CLIENTE_ACTUAL, RFC_ACTUAL, RFC_NUEVO) 
	    	VALUES (NULL, (SELECT MAX(ID) FROM REFACTURACION), CURRENT_TIMESTAMP, trim('$clie'), '$obs', '$suso', '$smp', '$sfp',
	    			trim('$clie'), 
	    			(SELECT TRIM(RFC) FROM CLIE01 WHERE CLAVE_TRIM = COALESCE((SELECT TRIM(CVE_CLPV) FROM FACTF01 WHERE CVE_DOC = '$docf'), (SELECT TRIM(CLIENTE) FROM FTC_FACTURAS WHERE DOCUMENTO = '$docf'))),
	    			(SELECT TRIM(RFC) FROM CLIE01 WHERE CLAVE_TRIM = COALESCE((SELECT TRIM(CVE_CLPV) FROM FACTF01 WHERE CVE_DOC = '$docf'), (SELECT TRIM(CLIENTE) FROM FTC_FACTURAS WHERE DOCUMENTO = '$docf')))
	    			) 
	    			 ";
	    		    }
	    	$this->grabaBD();
	    return;
    }

    function solNC(){
    	$data=array();
    	$this->query="SELECT R.*, (SELECT COUNT(CVE_DOC) AS PENDIENTE FROM PAR_FACTV01 WHERE CVE_DOC = FACTURA_NUEVA and (pxs>0 or (cant_val is not null and cant_val > 0)))  FROM REFACTURACION R WHERE R.fecha_solicitud >= dateadd (-180 day to current_date) order by id desc";
    	$rs=$this->EjecutaQuerySimple();
    	while ($tsArray=ibase_fetch_object($rs)) {
    		$data[]=$tsArray;
    	}
    	//var_dump($data);
    	return $data;
    }

    function verSolRefacturacion(){
    	$this->query="SELECT * FROM CAJAS C LEFT JOIN FACTP01 P ON P.CVE_DOC = C.CVE_FACT LEFT JOIN CLIE01 CL ON CL.CLAVE = P.CVE_CLPV WHERE C.STATUS_RECEPCION = 5 AND STATUS_LOG = 'Refacturar'";
    	$rs=$this->EjecutaQuerySimple();
    	while ($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return @$data;
    }

    function verSolNC($id){
    	$this->query="SELECT * FROM REFACTURACION rf left join factf01 f on f.cve_doc = rf.FACT_ORIGINAL left join clie01 cl on cl.clave = f.cve_clpv  where id=$id";
    	$rs=$this->EjecutaQuerySimple();

    	while ($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return $data;
    }

    function verDetSolNC($id, $tipo){

    	$this->query="SELECT * FROM REFACTURACION_DETALLE rf left join clie01 cl on cl.clave = rf.NUEVO_CLIENTE WHERE ID_REFAC = $id";
    	$rs=$this->EjecutaQuerySimple();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}

    	return @$data;
    }

	function verMovInventario($producto){
		$data=array();
		$this->query="SELECT FECHA AS FECHA, 'Entrada (Ingreso Bodega)' AS tipo, ID AS IDENTIFICADOR, CANT AS CANTIDAD,  COSTO AS COSTO, UNIDAD AS UNIDAD, PRODUCTO AS PRODUCTO, 0 AS EXISTENCIA, descripcion as descripcion, 'Ing'||id as DOCUMENTO  FROM INGRESOBODEGA where producto = '$producto'";
		$rs=$this->EjecutaQuerySimple();

		while($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}

		$this->query="SELECT FECHA_MOV AS FECHA, 'Salida (Asignacion Bodega)' AS tipo, A.ID AS IDENTIFICADOR, A.ASIGNADO AS CANTIDAD,  0 AS COSTO, P.UM AS UNIDAD, P.PROD AS PRODUCTO, 0 AS EXISTENCIA,  (select nombre from producto_ftc where clave = p.prod) AS DESCRIPCION, facturas as documento
			 FROM ASIGNACION_BODEGA_PREOC A LEFT JOIN PREOC01 P ON  P.ID = A.PREOC WHERE P.PROD = '$producto'";
		$rs=$this->EjecutaQuerySimple();
		//echo $this->query;
		while($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}

		sort($data); 
		return $data;
	}

   function recepcionOCBdg(){ 
    	$this->query="SELECT 
                            ftc.oc as cve_doc
                            ,'' as doc_sig
                            ,max(ftc.COSTO_TOTAL) as importeOC
                            , max(p.nombre) as nombre
                            ,sum(ftcpoc.pxr) AS PendientesXRecibir
                            , max(fecha_oc) as fechaoc
                            , max(p.clave) as cve_clpv
                            , max(ftc.usuario_oc) as usuario
                            , max(ftc.costo_total) as costo
                            , sum(ftcpoc.pxr) as pxr
                            , '' as urgencia
                            , max(ftc.vueltas) as vuelta
                            , sum(FTCPOC.cantidad) as cantidad
                            , max(ftc.status_recepcion) as status_recepcion
                            , max(ftc.unidad) as unidad
                            , max(ftc.vueltas) as vueltas
                            , (select max(operador) from unidades where numero = max(ftc.unidad) ) as operador
                            , max(ftc.FECHA_ENTREGA) AS FECHA_ENTREGA
                            from ftc_poc ftc
                            left join FTC_POC_DETALLE ftcpoc on ftcpoc.cve_doc = ftc.cve_doc
                            left join prov01 p on p.clave = ftc.cve_prov
                            where ((ftc.status_log = 'Total' or ftc.status_log = 'secuencia' or ftc.status_log='Tiempo' or ftc.status_log = 'admon' or ftc.status_log='Total' or ruta= 'A') or (ftc.fecha_entrega >= current_date and  ftc.fecha_pago is not null) )
                            and (status_recepcion is null or status_recepcion =9)
                            and ftc.OC starting with 'OPI' 
                            group by ftc.oc
                            having sum(ftcpoc.pxr) > 0 ";
        $rs=$this->EjecutaQuerySimple();
    	while($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	} 
    	return @$data;
    }

function ejecutarRecepcion($ida, $cantRec, $cantOr ){
		$usuario=$_SESSION['user']->NOMBRE;
		$this->query="SELECT * from ASIGNACION_BODEGA_PREOC where id = $ida";
		$rs=$this->EjecutaQuerySimple();
		$row=ibase_fetch_object($rs);
		$doa = new idpegaso;
		$val = $doa->revisaDuplicado($row->PREOC);
		if($row->STATUS == 7){
			if($cantRec == $cantOr){
			$this->query="INSERT INTO FTC_DETALLE_RECEPCIONES (ID, ORDEN, IDPREOC, CANTIDAD_OC, CANTIDAD_REC, PARTIDA, USUARIO, FECHA, STATUS, ID_RECEPCION, IMPRESION, FOLIO_IMP_BODEGA) VALUES(NULL, '$ida',$row->PREOC, $row->ASIGNADO, $row->ASIGNADO, 1, '$usuario', current_timestamp, 0, (select max(id_recepcion) from ftc_detalle_recepciones)+1, 0, ('I-'||$row->FOLIO_IMP))";
			$res= $this->grabaBD();
			$ra=ibase_affected_rows();
			if($ra == 1 ){
				$this->query="SELECT MAX(ID_RECEPCION) AS IDR FROM FTC_DETALLE_RECEPCIONES";
				$res=$this->EjecutaQuerySimple();
				$row2=ibase_fetch_object($res);
				$this->query="UPDATE INGRESOBODEGA SET recibido = recibido + $cantRec where ID = $row->IDINGRESO";
				$this->EjecutaQuerySimple();
				$this->query="UPDATE ASIGNACION_BODEGA_PREOC SET STATUS = 2, recibido = $cantRec WHERE ID = $ida";
				$this->grabaBD();

				$this->query="UPDATE PREOC01 SET  recepcion = recepcion + $cantRec, rec_faltante = rec_faltante - $cantRec, asignado = iif(asignado is null, $cantRec, asignado + $cantRec) where id = $row->PREOC";
					$this->EjecutaQuerySimple();
					//echo $this->query;
				return array("status"=>"ok", "recepcion"=>$row2->IDR);
			}else{
				return array("status"=>"error", "recepcion"=>"no se genero");
			}
		}elseif($cantRec == 0){				
				$this->query="UPDATE INGRESOBODEGA SET recibido = recibido + $cantRec where ID = $row->IDINGRESO";
				$this->EjecutaQuerySimple();

				$this->query="UPDATE ASIGNACION_BODEGA_PREOC SET STATUS = 4, recibido = $cantRec WHERE ID = $ida";
				$this->grabaBD();

				$this->query="UPDATE PREOC01 SET STATUS = 'N', ORDENADO = ORDENADO - $cantOr, asignado = iif(asignado is null, 0, asignado - $cantOr), rest = rest + $cantOr, canti = canti + $cantOr  where id = $row->PREOC";
				$this->EjecutaQuerySimple();

				return array("status"=>"ok", "recepcion"=>'rechazado');
		}elseif($cantRec < $cantOr){

				$dif = $cantOr-$cantRec;
				$this->query="INSERT INTO FTC_DETALLE_RECEPCIONES (ID, ORDEN, IDPREOC, CANTIDAD_OC, CANTIDAD_REC, PARTIDA, USUARIO, FECHA, STATUS, ID_RECEPCION, IMPRESION) VALUES(NULL, '$ida',$row->PREOC, $cantRec, $cantRec, 1, '$usuario', current_timestamp, 0, (select max(id_recepcion) from ftc_detalle_recepciones)+1, 0)";
				$res= $this->grabaBD();
				$ra=ibase_affected_rows();
				if($ra == 1 ){
					$this->query="SELECT MAX(ID_RECEPCION) AS IDR FROM FTC_DETALLE_RECEPCIONES";
					$res=$this->EjecutaQuerySimple();
					$row2=ibase_fetch_object($res);
					$this->query="UPDATE INGRESOBODEGA SET recibido = recibido + $cantRec where ID = $row->IDINGRESO";
					$this->EjecutaQuerySimple();
					$this->query="UPDATE ASIGNACION_BODEGA_PREOC SET STATUS = 4, recibido = $cantRec WHERE ID = $ida";
					$this->grabaBD();
					//echo $this->query;
					//// 8 - 2 = 6
					$this->query="UPDATE PREOC01 SET STATUS = 'N', ORDENADO = ORDENADO - $dif, recepcion = recepcion + $cantRec, rec_faltante = rec_faltante - $cantRec, rest = rest + $dif, canti = canti + $dif , asignado = iif(asignado is null, $cantRec, asignado +$cantRec) where id = $row->PREOC";
					$this->EjecutaQuerySimple();
					//echo $this->query;

				return array("status"=>"ok", "recepcion"=>$row2->IDR);
				}else{
					return array("status"=>"error", "recepcion"=>"no se genero");
				}				
			}
		}else{

			return array("status"=>"error", "recepcion"=>"La solicitud ya ha sido procesada con anterioridad");
		}			
	}

	function verValesBodega(){
		$data=array();
		$this->query="SELECT ab.*, p.*, ib.descripcion as descr, ib.Producto as produ--,(select avg(costo) from FTC_POC_DETALLE where idpreoc = ab.preoc) as costo  
			FROM ASIGNACION_BODEGA_PREOC ab left join preoc01 p on p.id = ab.preoc  left join ingresobodega ib on ib.id = ab.idingreso WHERE ab.STATUS = 4";
		$rs=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($rs)) {
			$data[]=$tsArray;
		}
		return $data;
	}

	function verInventarioBodega(){
		$data=array();
		$this->query="SELECT sum(restante) as restante, max(descripcion) as descripcion, ib.producto, avg(costo) as costo, unidad, max(fecha) as fecha,
				 (select marca from producto_ftc where clave = ib.producto) as marca,
				 (select proveedor from producto_ftc where clave = ib.producto) as proveedor,
				 (select categoria from producto_ftc where clave = ib.producto) as categoria, 
				 iif((select nueva from FTC_INVFISBOD ifi where ifi.status = 0 and ifi.producto = ib.producto and ifi.UM = ib.unidad) is null, 9999999,(select nueva from FTC_INVFISBOD ifi where ifi.status = 0 and ifi.producto = ib.producto and ifi.UM = ib.unidad)) as nueva
				 FROM INGRESOBODEGA ib WHERE ib.RESTANTE > 0 group by ib.producto, ib.unidad ";
		$rs=$this->EjecutaQuerySimple();
		while($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}
		return $data;
	}


	function cierreInvBodega($datos){
			$datos= explode(',', $datos);
			$usuario = $_SESSION['user']->NOMBRE;
			//echo 'array('.var_dump($datos).')<br/>';
			//echo 'Numero de registros que llegan son: '.count($datos).'<br/>';
			foreach ($datos as $key) {
				$dato = explode(':',$key);
				$canto = $dato[0];
				$cantf = $dato[1];
				$producto = $dato[3];
				$tipo = $dato[4];
				$um = $dato[5];
				//echo '<br/>'.$canto.' cantidad final: '.$cantf.' producto '.$producto.' tipo '.$tipo.' um '.$um.'<br/>';
				$this->query="UPDATE FTC_INVFISBOD SET STATUS = 8, usr_cierre = '$usuario', fecha_cierre = current_timestamp WHERE STATUS = 0 AND PRODUCTO = '$producto' and um ='$um'";
				$this->queryActualiza();
				
				if($tipo == 'v'){
					$data = array();
					$dif = $canto - $cantf;
					//echo 'esta es la diferencia: '.$dif.'<br/>';
					$this->query="SELECT count(id) as lineas FROM INGRESOBODEGA WHERE PRODUCTO = '$producto' and unidad = '$um' and RESTANTE = $dif";
					$rs=$this->EjecutaQuerySimple();
					$row=ibase_fetch_object($rs);
					//echo 'Consulta'.$this->query.'  Lineas '.$row->LINEAS.'<br/>';
						if($row->LINEAS > 0){
							$this->query="SELECT MIN(ID) as ID FROM INGRESOBODEGA WHERE PRODUCTO = '$producto' and unidad = '$um' and RESTANTE = $dif";
							$res=$this->EjecutaQuerySimple();
							$row2=ibase_fetch_object($res);
							$idi = $row2->ID;
								$this->query="SELECT * FROM INGRESOBODEGA WHERE ID = $idi";
								$result=$this->EjecutaQuerySimple();
								$row3=ibase_fetch_object($result);
								
								$this->query="INSERT INTO ASIGNACION_BODEGA_PREOC  (ID, IDINGRESO, INICIAL, ASIGNADO, FINAL, FECHA_MOV, USUARIO_MOV, STATUS, VERSUM) VALUES (NULL, $row3->ID, $row3->RESTANTE, $dif, $row3->RESTANTE - $dif, current_timestamp,'$usuario', 4,0)";
								$this->grabaBD();

								$this->query="UPDATE INGRESOBODEGA SET ASIGNADO = $dif, restante= restante - $dif where id = $idi";
								$this->grabaBD();
						}else{
							//echo 'No hay concidencia exacta, inicia la busqueda: <br/>';
							$this->query="SELECT * from INGRESOBODEGA WHERE PRODUCTO = '$producto' and unidad = '$um' and RESTANTE > 0 ORDER BY ID ASC";
							$rs=$this->EjecutaQuerySimple();
							while ($tsArray=ibase_fetch_object($rs)) {
								$data[]=$tsArray;
							}
							//echo 'Selecciona el numero de lineas con productos restantes: '.$this->query.' <br/> numero de lineas <br/>';
							if(count($data) > 0 ){
								$cantRes = $dif; ////
								$a= 0;
								foreach ($data as $key) {		
									$cantRes = $cantRes - $key->RESTANTE; ////  26-17=9  --> 9-2=7 --->  7-4=3-->  3-6 = -3  
									if($cantRes > 0 ){
										$this->query="UPDATE INGRESOBODEGA SET RESTANTE = RESTANTE - $key->RESTANTE, ASIGNADO= ASIGNADO + $key->RESTANTE where id = $key->ID";
										$this->EjecutaQuerySimple();
										//echo 'Actualiza el ingreso con el restante: '.$this->query.'<br/>';
										$this->query="INSERT INTO ASIGNACION_BODEGA_PREOC (ID, IDINGRESO, INICIAL, ASIGNADO, FINAL, FECHA_MOV, USUARIO_MOV, STATUS, VERSUM) 
														VALUES (NULL, $key->ID, $key->RESTANTE, $key->RESTANTE, $key->RESTANTE - $key->RESTANTE, current_timestamp,'$usuario', 4,0)";
										$this->EjecutaQuerySimple();
										$a = $a + $key->RESTANTE;  //// 29
									}elseif($cantRes <= 0){
									 	$b = $dif - $a; ////  17 + 2 + 4+6 = 26-29 = -3 
									 	if($b<0){
									 		unset($data);
									 		break;
									 	}else{
									 	//echo 'valor de b: '.$b. ' valor de $a: '.$a.'<br/>';
									 		$this->query="UPDATE INGRESOBODEGA SET RESTANTE = RESTANTE - $b, ASIGNADO= ASIGNADO + $b where id = $key->ID";
											$this->EjecutaQuerySimple();
											
											$this->query="INSERT INTO ASIGNACION_BODEGA_PREOC (ID, IDINGRESO, INICIAL, ASIGNADO, FINAL, FECHA_MOV, USUARIO_MOV, STATUS, VERSUM) 
														VALUES (NULL, $key->ID, $key->RESTANTE, $b, $key->RESTANTE - $b, current_timestamp,'$usuario', 4,0)";
											$this->EjecutaQuerySimple();
										//echo 'valor de $cantRes: '.$cantRes.'  si es 0 o menos deberia de salir no hacer la insercion.<br/>';
									 unset($data);
									 break;	
									 	} 
									}else{
										$this->query="UPDATE INGRESOBODEGA SET RESTANTE = RESTANTE - $dif, ASIGNADO= Asignado + $dif WHERE ID = $key->ID";
										$this->grabaBD();
										$this->query="INSERT INTO ASIGNACION_BODEGA_PREOC (ID, IDINGRESO, INICIAL, ASIGNADO, FINAL, FECHA_MOV, USUARIO_MOV, STATUS, VERSUM) 
														VALUES (NULL, $key->ID, $key->RESTANTE, $dif, $key->RESTANTE - $dif, current_timestamp,'$usuario', 4,0)";
										$this->grabaBD();
									}
								}


							}else{
								echo 'error garrafal'; 
							}
						}
				}else{
					$usuario = $_SESSION['user']->NOMBRE;
					$equipo = gethostname();
					$usuario = $usuario.' ('.$equipo.')';
					$this->query="SELECT * FROM PRODUCTO_FTC WHERE CLAVE = '$producto'";
					$res=$this->EjecutaQuerySimple();
					$row3 = ibase_fetch_object($res);
					$prov = explode(":", $row3->PROVEEDOR);
					$proveedor = $prov[0];

					$this->query="INSERT INTO INGRESOBODEGA (id, descripcion, cant, fecha, marca, proveedor, costo, unidad, producto, restante, asignado, usuario, recibido, origen ) 
						VALUES (null, '$row3->NOMBRE', $cantf - $canto, current_timestamp, '$row3->MARCA', '$proveedor', $row3->COSTO_T,'$row3->UM', '$producto', $cantf - $canto, 0, substring('$usuario' from 1 for 80), 0, 'Inventario Fisico')";
					$this->grabaBD();
				}
				unset($data);
			}
			/*
			$this->query="INSERT INTO CIERRE_MENSUAL (ID, inicial, MES, ANIO, FECHA_CIERRE, USUARIO_CIERRE, tipo) 
				VALUES (NULL, iif(
								(select max(inicial) from CIERRE_MENSUAL where tipo = 'BF') is null,
								 1, 
								 (select max(inicial) from CIERRE_MENSUAL where tipo = 'BF')) + 1,
								  extract(MONTH FROM CURRENT_DATE),
								   extract(YEAR FROM CURRENT_DATE), CURRENT_TIMESTAMP, 
								   '$usuario', 
								   'BF')";
			$this->grabaBD();
			*/
			//break;
			return;
	}



	function invPatio(){
		$data=array();
		$this->query="SELECT (select sum(cant_orig) from preoc01 where cotiza in (p.cotiza) ) as total, p.cotiza, sum(recepcion) as recepcion, sum(cant_orig) as original, 
                        (select count(f.id) from FTC_CTRL_INV_PATIO f WHERE f.caja = p.cotiza and f.status = 0) as procesado,
                        (select count(cotiza) from preoc01 where cotiza = p.cotiza and (recepcion - empacado) < 0 ) as negativo
                        FROM PREOC01 p
                        WHERE recepcion >= 0 
                        and ID >= 100000 
                        AND fechasol > '01.10.2017' 
                        and (recepcion - empacado <> 0 or empacado = 0) 
                        and fechadev is null 
                        and status <> 'R' 
                        and status <> 'E'
                        and status <> 'P'
                        GROUP BY p.cotiza";
		$rs=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($rs)) {
			$data[]=$tsArray;
		}
		return $data;
	}

	function invPatioDetalle($caja){
		$data=array();
		$this->query="SELECT  p.*, (select count(id) from FTC_CTRL_INV_PATIO WHERE PREOC = p.id) as procesado,
						cast((SELECT list(F.oc||'->'||F.TP_TES) FROM FTC_POC F 
							 LEFT JOIN FTC_POC_DETALLE FD ON FD.CVE_DOC = F.CVE_DOC 
							 WHERE FD.IDPREOC = P.id 
							 and FD.PXR > 0
							 ) as varchar(100)) as oc 
						FROM PREOC01 p
						WHERE recepcion >= 0 and ID >= 100000 
						and p.cotiza = '$caja'
						AND fechasol > '01.10.2017' 
						and (recepcion - empacado <> 0 or empacado = 0) 
						order by cotiza asc, fechasol asc";
		$rs=$this->EjecutaQuerySimple();
		//echo $this->query;
		while ($tsArray=ibase_fetch_object($rs)) {
			$data[]=$tsArray;
		}
		/*
		foreach($data as $t){
			$ocs = $t->OC;
			if($ocs > 0){
				$this->query="SELECT * FROM FTC_POC_DETALLE WHERE IDPREOC = $t->ID and "
			}
		}
		*/
		return $data;
	}


	function cierreInvPatio($datos){
		$usuario = $_SESSION['user']->NOMBRE;
		//exit(print_r($datos));

		$data=array();
				$this->query="SELECT * FROM FTC_CTRL_INV_PATIO WHERE STATUS = 0";
				$rs=$this->EjecutaQuerySimple();
				while ($tsArray=ibase_fetch_object($rs)) {
					//$datos[]=$tsArray;
					$data[]=$tsArray;
				}
			//exit($datos);

			if($datos != 0){

			foreach (@$data as $key2) {
				$canto = $key2->CANTO;
				$cantf = $key2->CANTR;
				$producto = $key2->PRODUCTO;
				$status = $key2->STATUS;
				$idpreoc = $key2->PREOC;
				$cotiza = $key2->CAJA;
				$folio = $key2->ID;


				$this->query = "UPDATE FTC_CTRL_INV_PATIO SET STATUS = 1 WHERE ID = $key2->ID";
				$rs = $this->EjecutaQuerySimple();

				$dif = $canto - $cantf;
				if($dif > 0 ){
					$this->query="INSERT INTO FTC_VALES (id, tipo, usuario, fecha, idpreoc, cant_orig, cant_fis, costo, cotizacion, status, folio) 
									VALUES (NULL, 'patio', '$usuario', current_timestamp, $idpreoc, $canto,$cantf, (SELECT costo FROM PREOC01 WHERE ID = $idpreoc), '$cotiza', 'Nuevo', $folio )";
					$this->grabaBD();
					/// liberamos la caja para ser solicitada nuevamente:
					$this->query="UPDATE PREOC01 SET ORDENADO = ORDENADO - $dif, REST = REST + $dif, RECEPCION = RECEPCION - $dif, CANTI = $dif, STATUS = 'N', REC_FALTANTE= REC_FALTANTE + $dif, obs_com_canc=('IFP:'||$key2->ID||':'||$dif||':'||(select max(id) from FTC_VALES)) WHERE ID = $idpreoc ";
					$rs=$this->queryActualiza();					
					if($rs != 1){
						echo 'Error en el id'.$key2->ID.'<br/>';
					}
					//echo $this->query;
				}
			}
			/*
			$this->query="INSERT INTO CIERRE_MENSUAL (ID, inicial, MES, ANIO, FECHA_CIERRE, USUARIO_CIERRE, tipo) 
				VALUES (NULL, iif(
								(select max(inicial) from CIERRE_MENSUAL where tipo = 'BF') is null,
								 1, 
								 (select max(inicial) from CIERRE_MENSUAL where tipo = 'BF')) + 1,
								  extract(MONTH FROM CURRENT_DATE),
								   extract(YEAR FROM CURRENT_DATE), CURRENT_TIMESTAMP, 
								   '$usuario', 
								   'BF')";
			$this->grabaBD();
			*/
	}
			//break;
		return;
	}

	function verValesPatio(){
		$this->query="SELECT * FROM FTC_VALES v left join preoc01 p on p.id = v.idpreoc WHERE v.STATUS = 'Nuevo'";
		$rs=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($rs)) {
			$data[]=$tsArray;
		}
		return @$data;
	}

	function totalValesPatio(){
		$this->query="SELECT COUNT(ID) as vales, SUM(COSTO) as monto FROM FTC_VALES WHERE STATUS = 'Nuevo'";
		$r = $this->EjecutaQuerySimple();
		$row=ibase_fetch_object($r);
		return $row;
	}

	function totalCajas(){
		$data = array();
		$this->query="SELECT count(cotiza) FROM PREOC01 WHERE recepcion >= 0 and ID >= 100000 AND fechasol > '01.10.2017' and recepcion - empacado <> 0  group by cotiza";
		$rs=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($rs)) {
			$data[]=$tsArray;
		}
		return $data;
	}

	function traeProveedoresOCI(){
		$this->query="SELECT * FROM PROV01";
		$rs=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($rs)) {
			$data[]=$tsArray;
		}
		return $data;
	}

	function traeProductosOCI(){
		$this->query="SELECT * FROM PRODUCTO_FTC";
		$rs=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($rs)) {
			$data[]=$tsArray;
		}
		return $data;
	}

	function temporal(){
		$this->query="SELECT coalesce(MAX(TEMP), 0) + 1 AS TEMP FROM FTC_OCI";
		$rs=$this->EjecutaQuerySimple();
		$row=ibase_fetch_object($rs);
		return $row;
	}

	function addOCI($prod, $cant, $prov, $temp ){
		$prod = explode(":", $prod);
		$cveprod = $prod[0];
		$usuario =$_SESSION['user']->NOMBRE;
		$equipo = gethostname();
		//echo 'Clave producto: '.$cveprod;
		//echo 'Cantidad Producto: '.$cant;
		$this->query="SELECT * FROM PRODUCTO_FTC WHERE CLAVE = '$cveprod'";
		$rs=$this->EjecutaQuerySimple();
		$row3 = ibase_fetch_object($rs);
		$costo=$row3->COSTO_VENTAS;

		$this->query="INSERT INTO FTC_OCI (id, producto, cantidad, proveedor, fecha_oci, usuario_oci, equipo_oci, status, temp, COSTO, COSTO_PARTIDA) 
								VALUES (null,'$cveprod', $cant, '$prov', current_timestamp, '$usuario', '$equipo', 0, $temp, $costo, $cant * $costo)";
		$this->grabaBD();
		$this->query="SELECT MAX(ID) AS LINEA FROM FTC_OCI";
		$rs=$this->EjecutaQuerySimple();
		$row=ibase_fetch_object($rs);
		$total = $cant * $costo;
		$this->query="SELECT COUNT(ID) AS PROD FROM FTC_OCI WHERE TEMP = $temp";
		$rs=$this->EjecutaQuerySimple();
		$row2=ibase_fetch_object($rs);
		$prod = $row3->CLAVE.' --> '.$row3->NOMBRE.'--> COSTO: '.$row3->COSTO_VENTAS;
		return array("status"=>'ok', "producto"=>$prod, "total"=>number_format($total,2),"linea"=>$row->LINEA,"val"=>$row2->PROD,"costo"=>$costo, "prod"=>$prod);
	}


	function delOCI($linea, $temp){
		$this->query="UPDATE FTC_OCI SET temp = 0 where id = $linea";
		$this->grabaBD();

		$this->query="SELECT COUNT(ID) AS PROD FROM FTC_OCI WHERE TEMP = $temp";
		$rs=$this->EjecutaQuerySimple();
		$row2=ibase_fetch_object($rs);

		//echo $row2->PROD;
		return array("status"=>'ok', "val"=>$row2->PROD);
	}

	function ejecutaOCI($idoci){
		$this->query="UPDATE FTC_OCI SET STATUS = '$tipo' where id = $idoci";
		$this->grabaBD();

		if($tipo == 'A'){
			$this->query="INSERT INTO FTC_POC SET () VALUES ()";
			$this->grabaBD();

		}elseif($tipo == 'C'){
			echo 'SE HA CANCELADO LA ORDEN DE COMPRA INTERNA';
		}

		return; 
	}

	function provOI($clave){
		$this->query="SELECT * FROM PROV01 WHERE trim(CLAVE) =trim('$clave')";
		$rs=$this->EjecutaQuerySimple();
		$row = ibase_fetch_object($rs);
		$nombre = $row->NOMBRE;
		return array("nombre"=>$row->NOMBRE, "calle"=>$row->CALLE,"numInt"=>$row->NUMINT,"numExt"=>$row->NUMEXT, "colonia"=>$row->COLONIA, "cp"=>$row->CODIGO, "ciudad"=>$row->ESTADO, "tel"=>$row->TELEFONO);
	}

	function cerrarOCI($temp){
		$this->query="SELECT iif(MAX(OCI) is null, 1, max(OCI)+1) as folio FROM FTC_OCI";
		$rs=$this->EjecutaQuerySimple();
		$row=ibase_fetch_object($rs);
		$folio = $row->FOLIO;
		$this->query = "UPDATE FTC_OCI SET OCI = $folio where temp = $temp and OCI is null";
		$this->grabaBD();

		$this->query="SELECT * FROM FTC_OCI WHERE TEMP = $temp and oci = $folio and partida is null ";
		$rs=$this->EjecutaQuerySimple();

		while ($tsArray=ibase_fetch_object($rs)) {
			$data[]=$tsArray;
		}
		$par = 0;
		if(isset($data)){
			foreach ($data as $key) {
			$par = $par + 1;
			$this->query="UPDATE FTC_OCI SET PARTIDA = $par where temp = $temp and oci = $folio and id = $key->ID";
			$this->grabaBD();
		}	
		}
		
		return;
	}


	function OCI($idoci){
		
		if(substr($idoci, 0,3)=='OPI'){
			$this->query="SELECT * FROM FTC_POC WHERE OC = '$idoci'";
			$rs=$this->EjecutaQuerySimple();
			$row=ibase_fetch_object($rs);
			$idoci = explode('-', $row->CVE_DOC);
			$idoci = $idoci[1];
			$this->query="SELECT oci.*, p.*, (select nombre from producto_ftc where clave = oci.producto) as descripcion from FTC_OCI oci left join prov01 p on p.clave = oci.proveedor WHERE oci = $idoci";
		$rs=$this->EjecutaQuerySimple();
		
		}else{
			$this->query="SELECT oci.*, p.*, (select nombre from producto_ftc where clave = oci.producto) as descripcion from FTC_OCI oci left join prov01 p on p.clave = oci.proveedor WHERE oci = $idoci";
		$rs=$this->EjecutaQuerySimple();
			
		}
		//echo $this->query;
			while ($tsArray=ibase_fetch_object($rs)) {
				$data[]=$tsArray;
			}
		return $data;
	}

	function recepOCI($oc){
		$this->query="SELECT * FROM INGRESOBODEGA WHERE DOCUMENTO = '$oc'";
		$rs=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}
		if(count($data)>0){
			$this->query="UPDATE INGRESOBODEGA SET STATUS =0 WHERE DOCUMENTO = '$oc'";
			$this->grabaBD();
		}
		return $data;
	}

	function verOCI(){
		//$data=false;
		$this->query="SELECT OCI, MAX(NOMBRE) AS NOMBRE, MAX(PROVEEDOR) AS PROVEEDOR, MAX(FECHA_OCI) AS FECHA_OCI, SUM(COSTO_PARTIDA) AS COSTO, MAX(USUARIO_OCI) USUARIO_OCI, count(id) as PARTIDAS
					 FROM FTC_OCI OCI 
					 	LEFT JOIN PROV01 P ON P.CLAVE = OCI.PROVEEDOR
					 	WHERE OCI IS NOT NULL AND oci.STATUS =0 
					 	GROUP BY OCI";
		$rs=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($rs)) {
			$data[]=$tsArray;
		}
		return @$data;
	}

	function execOCI($idoci, $tipo){
		$usuario = $_SESSION['user']->NOMBRE;
		$equipo = gethostname();

		$this->query="SELECT MIN(STATUS) as status FROM FTC_OCI WHERE OCI= $idoci";
		$r=$this->EjecutaQuerySimple();
		$row=ibase_fetch_object($r);

		if($row->STATUS == 0){
			if($tipo == 'r'){

			$this->query="UPDATE FTC_OCI SET STATUS = 3, usuario_exec='$usuario', equipo_exec='$equipo', fecha_exec= current_timestamp WHERE OCI= $idoci";
			$this->grabaBD();
			return array("status"=>'ok',"tipo"=>'Rechazo');
			
			}else{
			//echo 'Algoritmo para dar de alta en FTC_POC'
					$this->query="SELECT OCI, MAX(NOMBRE) AS NOMBRE, MAX(PROVEEDOR) AS PROVEEDOR, MAX(FECHA_OCI) AS FECHA_OCI, SUM(COSTO_PARTIDA) AS COSTO, MAX(USUARIO_OCI) USUARIO_OCI, count(id) as PARTIDAS
					 FROM FTC_OCI OCI 
					 	LEFT JOIN PROV01 P ON P.CLAVE = OCI.PROVEEDOR
					 	WHERE OCI IS NOT NULL AND oci.STATUS =0 AND OCI = $idoci 
					 	GROUP BY OCI ";
					$rs=$this->EjecutaQuerySimple();
					$row=ibase_fetch_object($rs);

					///// 

					$this->query="SELECT ULT_CVE FROM TBLCONTROL01 WHERE ID_TABLA = 81";
					$rs=$this->EjecutaQuerySimple();
					$row2=ibase_fetch_object($rs);
					$folioOC = $row2->ULT_CVE + 1; 

					$this->query = "UPDATE TBLCONTROL01 SET ULT_CVE  = $folioOC where id_TABLA = 81";
					$this->grabaBD();

				$this->query="INSERT INTO FTC_POC (ID, CVE_DOC, CVE_PROV, FECHA_DOC, TP_TES, USUARIO, COSTO, DESCUENTO, PRECIO, IVA, STATUS, TOTAL_IVA, COSTO_TOTAL, URGENCIA, FECHA_ELAB, OC, FECHA_OC, USUARIO_OC, TP_TES_REQ, FECHA_ENTREGA, CONFIRMADO) 
				VALUES (NULL, ('OCI-'||$idoci), '$row->PROVEEDOR', '$row->FECHA_OCI', NULL, '$usuario', $row->COSTO, 0, 0, 0, 'ORDEN', 0, $row->COSTO * 1.16, 0, current_timestamp, ('OPI'||$folioOC), current_timestamp, '$usuario', 'Cr', current_date, 'Directo Bodega')";
				$this->grabaBD();

				$this->query="SELECT * FROM FTC_OCI WHERE OCI = $idoci";
				$res=$this->EjecutaQuerySimple();
				while ($tsArray=ibase_fetch_object($res)){
					$data[]=$tsArray;
				}

				foreach ($data as $key) {
					$partida = $key->PARTIDA;

					$this->query="INSERT INTO FTC_POC_DETALLE (id, CVE_DOC, PARTIDA, ART, CANTIDAD, COSTO, DESCUENTO, PRECIO, COTIZACION, USUARIO, FECHA_ELAB, FECHA_DOC, SERIE, FOLIO, UM, FACCONV, CVE_PROD, COSTO_TOTAL, PRECIO_TOTAL, IDPREOC, STATUS, TOT_IVA, PXR, OC ) 
					VALUES (NULL, ('OCI-'||$idoci), $partida, trim('$key->PRODUCTO'), $key->CANTIDAD, $key->COSTO, 0, 0, 'Directa', '$usuario', current_timestamp, CURRENT_TIMESTAMP, 'OCI', $folioOC, (SELECT UM FROM PRODUCTO_FTC WHERE trim(CLAVE) = trim('$key->PRODUCTO')), (SELECT FAC_CONV FROM INVE01 WHERE trim(CVE_ART) = trim('$key->PRODUCTO')), (SELECT CVE_PROD FROM PRODUCTO_FTC WHERE trim(CLAVE) = trim('$key->PRODUCTO')), $key->COSTO_PARTIDA, 0,0,0,0,$key->CANTIDAD, ('OPI'||$folioOC))";
					$this->grabaBD();
				}
				$this->query="UPDATE FTC_OCI SET STATUS = 2 WHERE OCI = $idoci";
				$this->EjecutaQuerySimple();

			return array("status"=>'ok',"tipo"=>'CreacionOC');
			}	
		}else{
			return array("status"=>'Ya Procesada',"tipo"=>'Procesada');
		}	
	}

	function ctrlInvPatio($idpreoc, $canto, $cantr, $prod){

		$this->query="SELECT count(id) as contador  from FTC_CTRL_INV_PATIO WHERE preoc = $idpreoc and status = 0 ";
		$res=$this->EjecutaQuerySimple();
		$row=ibase_fetch_object($res);
		//echo $this->query;

		if($row->CONTADOR == 0){
			$this->query="INSERT INTO FTC_CTRL_INV_PATIO (ID, PREOC, PRODUCTO, CANTO, EMPACADO, CANTR, STATUS, FECHA_IF, FECHA_MOV, caja) 
							VALUES (NULL, $idpreoc,'$prod', $canto, (select empacado from preoc01 where id = $idpreoc) ,$cantr, 0, current_date, current_timestamp, (select cotiza from preoc01 where id = $idpreoc))";
			$this->grabaBD();
		}else{
			$this->query="UPDATE FTC_CTRL_INV_PATIO SET preoc = $idpreoc, producto = '$prod', canto = $canto, cantr= $cantr, fecha_if=current_date, fecha_mov = current_timestamp where status = 0 and id = $idpreoc";
			$this->grabaBD();
		}
		return array("status"=>'ok');
	}


	function invPatioGral($opcion){
		$usuario = $_SESSION['user']->NOMBRE;
		$fa = 1;
	  	$f = date('j');
	  	$m = date('n');
	  	$a = date('Y');
	  	$dia = date('N'); /// dia 1 para el Lunes 7 para domingo.
	  	if($dia == 6 ){
	  		$f = $f - 1;
	  	}elseif($dia == 7){
	  		$f = $f - 2;
	  	}  
		if($opcion == 5 ){////  and $f == $fa guardar patio.
			$this->query="SELECT iif(max(mes) is null, 0 , max(mes)) AS MES  FROM CIERRE_MENSUAL WHERE tipo = 'BF' and anio = $a";
			$rs=$this->EjecutaQuerySimple();
			$row=ibase_fetch_object($rs);
			if($row->MES >= $m){
				$mensaje = "<script>alert('Ya ha sido cerrado el periodo actual.') </script>";
  				return $mensaje;
			}else{
				$m = $row->MES + 1;
			}
			$this->query="SELECT sum(restante) as restante, max(descripcion) as descripcion, producto, avg(costo) as costo, unidad, max(fecha) as fecha,
				 (select marca from producto_ftc where clave = producto) as marca,
				 (select proveedor from producto_ftc where clave = producto) as proveedor,
				 (select categoria from producto_ftc where clave = producto) as categoria
				 FROM INGRESOBODEGA WHERE RESTANTE > 0 group by producto, unidad ";
				$rs=$this->EjecutaQuerySimple();
				while($tsArray=ibase_fetch_object($rs)){
					$data[]=$tsArray;
				}
					$subtotal=0;
					foreach ($data as $key){
							$producto = $key->PRODUCTO;
							$cantidad = $key->RESTANTE;
							$costo = $key->COSTO;
							$subtotal += ($cantidad * $costo);
							$this->query="INSERT INTO INVENTARIO_MENSUAL (ID, IDINVENTARIO, CAJA, PRODUCTO, IDPREOC, CANTIDAD, COSTOS, COSTO_TOTAL, DESCRIPCION, FECHA, USUARIO, ORIGEN, Mes, anio) 
										VALUES (NULL, (SELECT iif(MAX(IDINVENTARIO)  is null, 1, MAX(IDINVENTARIO) +1) FROM INVENTARIO_MENSUAL where origen = 'Bodega'), 'N/A', '$producto', null, $cantidad, $costo, $cantidad*$costo, '$key->DESCRIPCION', current_timestamp, '$usuario', 'Bodega', $m, $a)";
							$this->grabaBD();
					}
					$this->query="INSERT INTO CIERRE_MENSUAL (ID, MES, ANIO, FINAL, FECHA_CIERRE, USUARIO_CIERRE, TIPO)	VALUES (NULL, $m, $a, $subtotal, current_timestamp, '$usuario' , 'BF')";
					$this->grabaBD();

		}else{
					$this->query="SELECT  p.*, (select count(id) from FTC_CTRL_INV_PATIO WHERE PREOC = p.id) as procesado 
						FROM PREOC01 p
						WHERE recepcion >= 0 and ID >= 100000 
						AND fechasol > '01.10.2017' 
						and recepcion - empacado <> 0 
						order by cotiza asc, fechasol asc";
					$rs=$this->EjecutaQuerySimple();
					
					while ($tsArray=ibase_fetch_object($rs)) {
						$data[]=$tsArray;
					}
					if($opcion == 'guardar'){
						$this->query="SELECT iif(max(mes) is null, 0 , max(mes)) AS MES  FROM CIERRE_MENSUAL WHERE tipo = 'PF' and anio = $a";
						$rs=$this->EjecutaQuerySimple();
						$row=ibase_fetch_object($rs);
						if($row->MES >= $m){
							$mensaje = "<script>alert('Ya ha sido cerrado el periodo actual.') </script>";
			  				return $mensaje;
						}else{
							$m = $row->MES + 1;
						}
						$subtotal= 0;
						foreach ($data as $key){
							$producto = $key->PROD;
							$cantidad = $key->RECEPCION - $key->EMPACADO;
							$costo = $key->COSTO;
							$subtotal += ($costo * $cantidad);
							$this->query="INSERT INTO INVENTARIO_MENSUAL (ID, IDINVENTARIO, CAJA, PRODUCTO, IDPREOC, CANTIDAD, COSTOS, COSTO_TOTAL, DESCRIPCION, FECHA, USUARIO,  ORIGEN, MES, ANIO) 
										VALUES (NULL, (SELECT iif(MAX(IDINVENTARIO)  is null, 1, MAX(IDINVENTARIO) +1) FROM INVENTARIO_MENSUAL where origen = 'Empaque'), '$key->COTIZA', '$key->PROD', $key->ID, $cantidad, $costo, $cantidad*$costo, (SELECT NOMBRE FROM PRODUCTO_FTC WHERE CLAVE = '$producto'), current_timestamp, '$usuario', 'Empaque', $m, $a)";
							$this->grabaBD();

						}
						
						$this->query="INSERT INTO CIERRE_MENSUAL (ID, MES, ANIO, FINAL, FECHA_CIERRE, USUARIO_CIERRE, TIPO) VALUES (NULL, $m, $a, $subtotal, current_timestamp, '$usuario' , 'PF')";
						$this->grabaBD();
					}
		}
		return $data;
	}





function invAunaFecha($fecha, $tipo){
		$ff = $fecha;
		$this->query="SELECT first 1000 f.id, p.prod
                ,f.cantidad_rec
                ,f.fecha
        	from ftc_detalle_recepciones f 
        	left join preoc01 p on p.id = f.idpreoc
       		where 
        	f.cantidad_rec <> 0 and MOV_INVE is null";
        	$rs=$this->EjecutaQuerySimple();
        	while ($tsArray=ibase_fetch_object($rs)) {
        	$data[]=$tsArray;
        	}
        foreach ($data as $prod) {
        	$producto = $prod->PROD;
        	$entradas = $prod->CANTIDAD_REC;
        	$fecha = $prod->FECHA;
        	$status = 0;
        	$this->query="UPDATE FTC_DETALLE_RECEPCIONES SET MOV_INVE = 1 WHERE ID = $prod->ID and fecha>= '01.11.2017'";
        	$this->grabaBD();

        	$this->query="INSERT INTO INVENTARIO (IDINV,PRODUCTO, ENTRADAS, SALIDAS, INVEMPAQUE, STATUS, FECHA, TIPO, signo, movimiento) 
        				VALUES (NULL, '$producto', $entradas, 0, 0, $status, '$fecha', 'E', 1, $prod->ID)";
        	$this->grabaBD();
        }

        	$this->query="SELECT ARTICULO, CANTIDAD, ID, FECHA_PAQUETE  FROM PAQUETES WHERE CANTIDAD > 0 and fecha_paquete >= '01.11.2017' and mov_inve is null ";
        	$rs=$this->EjecutaQuerySimple();
        	while ($tsArray=ibase_fetch_object($rs)){
        		$data3[]=$tsArray;
        	}
        foreach ($data3 as $key3) {
        		$producto=$key3->ARTICULO;
        		$salidas = $key3->CANTIDAD;
        		$fecha =$key3->FECHA_PAQUETE;
        		$status = 0;
        		$id = $key3->ID;
        		$this->query="UPDATE PAQUETES SET MOV_INVE = 1 WHERE ID = $id";
        		$this->grabaBD();
        		$this->query="INSERT INTO INVENTARIO (IDINV,PRODUCTO, ENTRADAS, SALIDAS, INVEMPAQUE, STATUS, FECHA, TIPO, signo, movimiento) 
        				VALUES (NULL, '$producto', 0, $salidas, 0, $status, '$fecha', 'S', -1, $id)";
        		$this->grabaBD();
        	}

        $this->query="SELECT PRODUCTO, SUM(ENTRADAS) as entradas , SUM(SALIDAS) as salidas, MIN(pftc.costo_ventas) as costo 
        			  FROM INVENTARIO i 
        			  left join producto_ftc pftc on pftc.clave = i.producto 
        			  WHERE fecha >= '01.01.2017' and FECHA < '$fecha' 
        			  GROUP BY PRODUCTO 
        			  having producto starting with('PGS')";
        $rs=$this->EjecutaQuerySimple();

        while($tsArray=ibase_fetch_object($rs)){
        	$datos[]=$tsArray;
        }

        return $datos;
    }


    function actCanti($idpreoc){

    	$doa = new idpegaso;
    	$val = $doa->revisaDuplicado($idpreoc);
    	$ordenado = $val['ordenado'];
    	$recibido =$val['recibido'];
    	$pendiente = $val['pendiente'];
    	$status = $val['status'];

    	echo 'ordenado'.$ordenado.',  recibido '.$recibido.', pendiente '.$pendiente.' status : '.$status;

    	$a=$this->query="UPDATE PREOC01 SET CANTI = cant_orig - $ordenado, recepcion = $recibido, rest = $pendiente, status = '$status', rec_faltante = cant_orig - $recibido, ordenado = $ordenado  WHERE ID = $idpreoc";
    	$rs=$this->queryActualiza();

    	//echo $a;

    	return array('status' => "ok","resultado"=>$rs);
       }

    function impFoliosAsignacion($folios){

    	$this->query="SELECT MAX(FOLIO_IMP) AS FOLIO FROM ASIGNACION_BODEGA_PREOC";
    	$rs=$this->EjecutaQuerySimple();
    	$row = ibase_fetch_object($rs);
    	$folion = $row->FOLIO + 1;

    	$this->query="UPDATE ASIGNACION_BODEGA_PREOC SET FOLIO_IMP = $folion WHERE ID in ($folios)";
    	$res=$this->EjecutaQuerySimple();
    	
    	$this->query="SELECT * from asignacion_bodega_preoc ab
            left join ingresobodega ib on ib.id = ab.idingreso
            where ab.id in($folios)";
         $rs=$this->EjecutaQuerySimple();
         while ($tsArray=ibase_fetch_object($rs)) {
            	$data[]=$tsArray;
            }   
            return $data;
    }

    function impFolioReciboBodega($doco){
    	$doco = explode("-", $doco);
    	$this->query="SELECT * FROM ASIGNACION_BODEGA_PREOC ab left join ingresobodega ib on ab.idingreso = ib.id WHERE ab.folio_imp = $doco[1] ";
    	$rs=$this->EjecutaQuerySimple();
    	echo $this->query;
    	while ($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	return $data;
    }

    function verMermas(){
    	$data=array();
    	$this->query="SELECT * FROM PAQUETES WHERE STATUS = 'merma'";
    	$rs=$this->EjecutaQuerySimple();
    	while ($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	$this->query="SELECT * FROM FTC_POC_DETALLE WHERE ";
    	return $data;
    }


   
    function verDevProv(){
    	$data = array();
    	$this->query="SELECT p.id, p.DOCUMENTO, PRE.NOM_PROV, p.CANTIDAD, p.DEVUELTO, p.ARTICULO, p.DESCRIPCION, P.fecha_ultima_dev, P.FOLIO_DEV, P.MOTIVO, 'CAJA' AS ORI FROM PAQUETES P LEFT JOIN PREOC01 PRE ON PRE.ID = P.ID_PREOC  WHERE p.STATUS = 'devProv' ";
		$rs=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($rs)) {
			$data[]=$tsArray;
		}
		$this->query="SELECT id as id ,ib.DOCUMENTO, P.NOMBRE AS NOM_PROV, ib.CANT AS CANTIDAD, ib.CANT AS DEVUELTO, ib.PRODUCTO AS ARTICULO, (SELECT NOMBRE FROM PRODUCTO_FTC WHERE CLAVE = ib.producto) as descripcion, ib.fecha as fecha_ultima_dev, 'N/A' as folio_dev, 'Orden Interna' as Motivo, 'INGBOD' AS ORI FROM INGRESOBODEGA ib left join prov01 p on p.clave = ib.proveedor where ib.origen = 'Orden Interna' and ib.status = 3";
		//echo $this->query;
		$res=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($res)) {
			$data[]=$tsArray;
		}
		return $data;
    }


 	function verMerma(){
    	$this->query="SELECT p.id, p.DOCUMENTO, PRE.NOM_PROV, p.CANTIDAD, p.DEVUELTO, p.ARTICULO, p.DESCRIPCION, P.fecha_ultima_dev, P.FOLIO_DEV, P.MOTIVO, 'CAJA' AS ORI FROM PAQUETES P LEFT JOIN PREOC01 PRE ON PRE.ID = P.ID_PREOC  WHERE p.STATUS = 'merma' ";
		$rs=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($rs)) {
			$data[]=$tsArray;
		}
		$this->query="SELECT id as id ,ib.DOCUMENTO, P.NOMBRE AS NOM_PROV, ib.CANT AS CANTIDAD, ib.CANT AS DEVUELTO, ib.PRODUCTO AS ARTICULO, (SELECT NOMBRE FROM PRODUCTO_FTC WHERE CLAVE = ib.producto) as descripcion, ib.fecha as fecha_ultima_dev, 'N/A' as folio_dev, 'Orden Interna' as Motivo, 'INGBOD' AS ORI FROM INGRESOBODEGA ib left join prov01 p on p.clave = ib.proveedor where ib.origen = 'Orden Interna' and ib.status = 4";
		//echo $this->query;
		$res=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($res)) {
			$data[]=$tsArray;
		}

		return $data;
    }

    function ids(){
    	$this->query="SELECT * FROM PREOC01 WHERE fechasol >= '01.11.2017' and status_verif is null -- and id= 165856";
    	$rs = $this->EjecutaQuerySimple();
    	while ($tsArray=ibase_fetch_object($rs)) {
    		$data[]=$tsArray;
    	}
    	$this->query="SELECT * FROM VERIFICACION WHERE STATUS = 'Revisar'";
		$rs=$this->EjecutaQuerySimple();
		while($tsArray2=ibase_fetch_object($rs)) {
			$data2[]=$tsArray2;
		}
		$actualizados = 0;
		$recorridos = 0;
    	return $data;
    }

    function ejecutaCyS($opcion, $idsol){
    	$fact = new factura;
    	/// Obtenemos los datos de la factura Original para la cancelacion.
    	$mensaje = 'La solucitu ya ha sido ejecutada';
    	$this->query="SELECT * FROM REFACTURACION where id =$idsol";
    	$rs=$this->EjecutaQuerySimple();
    	$row=ibase_fetch_object($rs);
    	$val = $row->STATUS_SOLICITUD; 
    	if($val == 0 or $val == 1){
    		/// Mandamos a cancelarla;
    		$cancela = $fact->cancelaFactura($row->FACT_ORIGINAL);
    		$nuevoFolio=$fact->crearFoliosFactura();
    		$copiaFactura=$fact->copiaFactura($idsol,$nuevoFolio, $row->FACT_ORIGINAL);
    		$timbraFactura=$fact->timbraFact($nuevoFolio, $cancela);
    		$moverFact = $fact->moverNCSUB($nuevoFolio, $timbraFactura);
    		return $mensaje= array("status"=>'ok', "factura"=>$nuevoFolio, "nc"=>'N/A');
    	}else{
    		return $mensaje;
    	}
    }

    function ejecutaRefac($opcion, $idsol){
    	$fact= new factura;
    	$usuario = $_SESSION['user']->NOMBRE; 
    	$idc = 000000;
       	$this->query="SELECT * FROM REFACTURACION rf left join factf01 f on f.cve_doc = rf.FACT_ORIGINAL WHERE ID = $idsol";
    	$rs=$this->EjecutaQuerySimple();
    	$row=ibase_fetch_object($rs);
    	$val = $row->STATUS_SOLICITUD;
    	$cliente = $row->NUEVO_CLIENTE;
    	$facto = $row->FACT_ORIGINAL;
    	$idc = empty($row->CAJA)? 0:$row->CAJA;
    	if(empty($cliente)){
    			$cliente = $row->CVE_CLPV;		
    	}
    	$migra = 0;
    	$this->query="SELECT COALESCE(ID, 0) AS ID FROM Refacturacion WHERE FACTURA_NUEVA = '$facto' and TIPO_SOLICITUD='MIGRACION FACTURA' AND STATUS_SOLICITUD = 5";
    	$res =$this->EjecutaQuerySimple();
    	//echo $this->query;
    	$migracion = ibase_fetch_object($res);
    	//if(isset($migracion)){
    	//	$migra =$migracion->ID;
    	//}
    
    	if($migra > 0){
    		$timbra = $fact->timbraFact($facto, $idc);
    		return;
    	}
    	if(($val == 0 or $val == 1) and $opcion == 1){/// la opcion 1 es el cambio de fecha:
    		$this->query="UPDATE REFACTURACION SET STATUS_SOLICITUD = 2 WHERE ID = $idsol";
    		$res=$this->queryActualiza();	
    		if($res == 1 ){
  						$row2=$this->crearFoliosRefact($usuario);
    	  				$folioF=$row2['folioF'];
    	  				$folioN=$row2['folioNC'];				
	    				$docs=$this->creaDocumentosRefact($idsol, $folioF,
	    					$serieF=$row2['serieF'], 
	    					$folioRFP=$row2['folioRFP'], 
	    					$usuario, 
	    					$folioNC=$row2['folioNC'], 
	    					$serieN=$row2['serieN'], 
	    					$folioNCRP=$row2['folioNCRP']);
	    				$timbradoF = $fact->timbraFact($docf=$folioF, $idc);
    					$timbradoNC = $fact->timbraNc($docf=$folioNC, $idc);
	    				$mF = $this->moverFactura($folioF,$rfc=$timbradoF );
	    				$mNC = $this->moverNC($folioNC, $rfc=$timbradoNC);
    		}
       		$NC= $row2['folioNC'];
       		$facturan=$row2['folioF'];
       		/// este codigo se corre al finalizar por lo que debemos de enviar las variables;
       		$this->query="UPDATE REFACTURACION SET usuario_autoriza = '$usuario', fecha_autoriza = current_timestamp, usuario_ejecuta = '$usuario', fecha_ejecuta= current_timestamp, resultado = 'ejecutado', NC = '$NC', FACTURA_NUEVA = '$facturan', PEDIDO_REMISION_ASOCIADO = (SELECT CVE_FACT FROM CAJAS WHERE ID = $idc) WHERE ID = $idsol";
       		$this->grabaBD();
       		//echo 'Actauliza REFACTURACION: '.$this->query.'<br/>';
       		//// opcion 2 es la opcion para el cambio de cliente.
    	}elseif(($val == 0 or $val == 1) and $opcion == 2){/// Opcion 2 es cambio de CLIENTE.
            $this->query="UPDATE REFACTURACION SET STATUS_SOLICITUD = 2 WHERE ID = $idsol";
    		$res=$this->queryActualiza();
    		if($res == 1 ){
                 if(substr(trim($row->FACT_ORIGINAL),0,1) == '0'){
    				echo 'Es remsion'.$row->FACT_ORIGINAL.'<br/>';
    			}else{
	            	$row=$this->crearFoliosRefact($usuario);
    				$docs=$this->creaDocumentosRefact($idsol, $folioF=$row['folioF'],
    					$serieF=$row['serieF'], 
    					$folioRFP=$row['folioRFP'], 
    					$usuario, 
    					$folioNC=$row['folioNC'], 
    					$serieN=$row['serieN'], 
    					$folioNCRP=$row['folioNCRP']);
    				$actDocs=$this->actualizaFiscales($folioF, $folioNC,$idsol);
    				$timbradoF = $fact->timbraFact($docf=$row['folioF'], $idc);
    				$timbradoNC = $fact->timbraNc($docf=$row['folioNC'], $idc);
    				$mF = $this->moverFactura($folioF,$rfc=$timbradoF );
    				$mNC = $this->moverNC($folioNC, $rfc=$timbradoNC);
    				$NC= $row['folioNC'];
       				$facturan=$row['folioF'];
	            }
       		}
       			$this->query="UPDATE REFACTURACION SET usuario_autoriza = '$usuario', fecha_autoriza = current_timestamp, usuario_ejecuta = '$usuario', fecha_ejecuta= current_timestamp, resultado = 'ejecutado', NC = '$NC', FACTURA_NUEVA = '$facturan', PEDIDO_REMISION_ASOCIADO = (SELECT CVE_FACT FROM CAJAS WHERE ID = $idc) WHERE ID = $idsol";
       			$this->grabaBD();
    	}elseif($val == 1 and $opcion == 5){ //// Cambio de datos fiscales;
    		$this->query="UPDATE REFACTURACION SET STATUS_SOLICITUD = 2 WHERE ID = $idsol";
    		$res = 1;
    		if($res == 1){
	    		    	//exit($row->FACT_ORIGINAL);
		    			//// Creamos el nuevo folio;
		    			$this->query="SELECT FOLIO, SERIE FROM FTC_CTRL_FACTURAS WHERE IDFF = 2";
		    			$rs=$this->EjecutaQuerySimple();
		    			$row1=ibase_fetch_object($rs);
		    			$folioRFP = $row1->FOLIO + 1;
		    			$serieF =$row1->SERIE; 
		    			$this->query="UPDATE FTC_CTRL_FACTURAS SET FOLIO = $folioRFP where idff = 2";
		    			$this->grabaBD();
		    			$folioF = $row1->SERIE.$folioRFP;
		    			$this->query="SELECT FOLIO, SERIE FROM FTC_CTRL_FACTURAS WHERE IDFF = 3";
		    			$rs=$this->EjecutaQuerySimple();
		    			$row1=ibase_fetch_object($rs);
		    			$folioNCRP = $row1->FOLIO + 1; 
		    			$serieN =$row1->SERIE; 
		    			$this->query="UPDATE FTC_CTRL_FACTURAS SET FOLIO = $folioRFP where idff = 3";
		    			$this->grabaBD();
		    			$folioNC = $row1->SERIE.$folioRFP;
		    			//// Finaliza la creacion de los folios:
		    			/// invocamos el copiado de la facura,
		    			/// insertamos en la tabla de cabecera FTC_FACTURA 
		    			//$usoCFDI = $row->
		    			$this->query="EXECUTE PROCEDURE SP_COPIA_FACTURA_PEGASO($idsol, '$folioF', '$serieF', $folioRFP, '$usuario')";
		    			$res=$this->EjecutaQuerySimple();
		    			$nfact = ibase_fetch_object($res);
		    			$this->query="EXECUTE PROCEDURE SP_COPIA_DET_FACTURA_PEGASO($idsol, '$folioF', '$usuario')";
		    			$res=$this->EjecutaQuerySimple();
		    			/// YA TENEMOS LA NUEVA FACTURA CON SUS PARTIDAS.
		    			//// CREAMOS LAS PARTIDAS DE LAS NC Y SUS PARTIDAS.
		    			$this->query="EXECUTE PROCEDURE SP_GENERA_NC_PEGASO($idsol, '$folioNC', '$serieN', $folioNCRP, '$usuario')";
		    			$res=$this->EjecutaQuerySimple();
		    			$this->query="EXECUTE PROCEDURE SP_GENERA_DET_NC_PEGASO($idsol, '$folioNC', '$usuario')";
		    			$res=$this->EjecutaQuerySimple();
		    			/// Obtenemos el Json orginal
		    			//$nf = '156';
		    			$actDocs=$this->actualizaFiscales($folioF, $folioNC, $idsol);
		    			$timbradoF = $fact->timbraFact($docf=$folioF, $idc);
    					$timbradoNC = $fact->timbraNc($docf=$folioNC, $idc);
						$mF = $this->moverFactura($folioF,$rfc=$timbradoF);
    					$mNC = $this->moverNC($folioNC, $rfc=$timbradoNC);
						//// Obtenemos el XML de la nueva factura para cargarla:
						///// Finaliza la Carga de Facturas;
	    			
	    			//return $documentos = array("status"=>'ok',"factura"=>$folioF, "nc"=>$folioNC,"rfc"=>$rfc=$timbradoNC); 
	    	
	    }elseif($val == 1 and $opcion == 4){ /// Cambios de precios.

	    	$this->query="UPDATE REFACTURACION SET STATUS_SOLICITUD = 2 WHERE ID = $idsol";
    		//$res=$this->queryActualiza();
    		$res = 1;
    		if($res == 1 ){
                if(substr(trim($row->FACT_ORIGINAL),0,1) == '0' ){
    				echo 'Es remsion'.$row->FACT_ORIGINAL.'<br/>';
    			}elseif(substr(trim($row->FACT_ORIGINAL),0,3) == 'FAA' OR (substr(trim($row->FACT_ORIGINAL),0,2)=='RF' and substr(trim($row->FACT_ORIGINAL),0,3)<> 'RFP')){
	    			$this->query="EXECUTE PROCEDURE SP_GENERA_NV('$row->NUEVA_FECHA','$row->FACT_ORIGINAL','$row->NC', '$cliente')";
	    			$result=$this->EjecutaQuerySimple();
	    			$respuesta = ibase_fetch_object($result);
	    			$valPar = $respuesta->VAL;
	                //$this->query="alter trigger factf01_ai0 active";
	                //$this->grabaBD();
	                echo 'Validacion de la creacion de la factuar'.$valPar;
	                if($valPar==1){
	                $this->query="SELECT MAX(NUM_PAR) AS PARTIDAS FROM PAR_FACTF01 WHERE CVE_DOC='$row->FACT_ORIGINAL'";
	    			$r=$this->EjecutaQuerySimple();
	    			$row2=ibase_fetch_object($r);
	    			$partidas = $row2->PARTIDAS;
	                //echo $partidas;
	                $facturan = $respuesta->FACTURA_NUEVA;
	   			        for ($i=1; $i<=$partidas ; $i++) {
	   			        	echo 'parametros:'.$i.', Fact Or: '.$row->FACT_ORIGINAL.', NC: '.$row->NC.', Cliente '.$row->FACT_ORIGINAL.'<br/>';
	   			            $this->query="EXECUTE PROCEDURE SP_COPIA_NV_PARTIDAS($i,'$row->FACT_ORIGINAL','$facturan',$i,'$row->NC')";
	   			            $res=$this->EjecutaQuerySimple();
	   			            $resPartida = ibase_fetch_object($res);
	   			        }
	                }
	            }elseif(substr(trim($row->FACT_ORIGINAL),0,2) == 'FP' or substr(trim($row->FACT_ORIGINAL),0,3) == 'RFP'){
	            	$factura = new factura;
	            	$facto =$row->FACT_ORIGINAL;
	            	$row=$this->crearFoliosRefact($usuario);
    				$docs=$this->creaDocumentosRefact($idsol, $folioF=$row['folioF'],
    					$serieF=$row['serieF'], 
    					$folioRFP=$row['folioRFP'], 
    					$usuario, 
    					$folioNC=$row['folioNC'], 
    					$serieN=$row['serieN'], 
    					$folioNCRP=$row['folioNCRP']);

    				/// despues de copiar el documento como el original, vamos a modificar los totales.
    				$this->query="SELECT * FROM FTC_FACTURAS_DETALLE WHERE documento = '$folioF'";
    				$RS=$this->EjecutaQuerySimple();
	    				while($tsArray=ibase_fetch_object($RS)){
	    					$dataFact[]=$tsArray;	
	    				}
	    				$subtotal=0;
	    				$iva = 0;
	    				$descuentos = 0;
	    				foreach ($dataFact as $partidas) {
	    					$this->query="UPDATE FTC_FACTURAS_DETALLE SET ";
	    					$subtotal=$subtotal + $partidas->SUBTOTAL;
	    					$descuentos=$descuentos + $partidas->DESC1;
	    					$total = ($subtotal - $descuentos) * 1.16;
	    				}

	    				$this->query="UPDATE FTC_FACTURAS SET SUBTOTAL=$subtotal, IVA=($subtotal - $descuentos) *.16, desc1=$descuentos, Total = $total, saldo_final = $total where documento='$folioF'";
	    				$this->EjecutaQuerySimple();
	    				/// SE ACTUALIZO EL DOCUMENTO CORRECTAMENTE;
	    				$timbradoF = $factura->timbraFact($row['folioF'], $idc);
	    				$timbradoNC=$factura->timbraNC($row['folioNC'], $idc);
    			
    				$mF = $this->moverFactura($folioF,$rfc=$timbradoF );
    				$mNC = $this->moverNC($folioNC, $rfc=$timbradoNC);
	            }
       		}
       			$NC= $row['folioNC'];
       			$facturan=$row['folioF'];
       			$this->query="UPDATE REFACTURACION SET usuario_autoriza = '$usuario', fecha_autoriza = current_timestamp, usuario_ejecuta = '$usuario', fecha_ejecuta= current_timestamp, resultado = 'ejecutado', NC = '$NC', FACTURA_NUEVA = '$facturan', PEDIDO_REMISION_ASOCIADO = (SELECT CVE_FACT FROM CAJAS WHERE ID = $idc) WHERE ID = $idsol";
       			$this->grabaBD();
       		//exit('Entro a la parte de refacturacion cambio de cantidad y cambio de precio');
	    }

	    echo '<b>Se refactura la :'.$facto.', nueva Factura: '.$folioF .'.</b><br/>';
		echo '<b>Con la Nota de credito:'.$folioNC.'</b><br/>';
		echo '<a href="#" onclick="javascritp:window.self.close();" class="btn btn-info">Cerrar ventana</a>';				
	   	return $documentos = array("status"=>'ok',"factura"=>$folioF, "nc"=>$folioNC,"rfc"=>$timbradoF);
    	}
	}


    function crearFoliosRefact(){
    	$this->query="SELECT FOLIO, SERIE FROM FTC_CTRL_FACTURAS WHERE IDFF = 2";
		$rs=$this->EjecutaQuerySimple();
		$row1=ibase_fetch_object($rs);
		$folioRFP = $row1->FOLIO + 1;
		$serieF =$row1->SERIE; 
		$this->query="UPDATE FTC_CTRL_FACTURAS SET FOLIO = $folioRFP where idff = 2";
		$this->grabaBD();
		$folioF = $row1->SERIE.$folioRFP;
		$this->query="SELECT FOLIO, SERIE FROM FTC_CTRL_FACTURAS WHERE IDFF = 3";
		$rs=$this->EjecutaQuerySimple();
		$row1=ibase_fetch_object($rs);
		$folioNCRP = $row1->FOLIO + 1; 
		$serieN =$row1->SERIE; 
		$this->query="UPDATE FTC_CTRL_FACTURAS SET FOLIO = $folioRFP where idff = 3";
		$this->grabaBD();
		$folioNC = $row1->SERIE.$folioRFP;
		return array("folioRFP"=> $folioRFP,"serieF"=>$serieF, "folioF" => $folioF, "folioNCRP"=>$folioNCRP,"serieN"=>$serieN, "folioNC"=>$folioNC);
    }

    function creaDocumentosRefact($idsol, $folioF,$serieF, $folioRFP, $usuario, $folioNC, $serieN, $folioNCRP){
    	$this->query="EXECUTE PROCEDURE SP_COPIA_FACTURA_PEGASO($idsol, '$folioF', '$serieF', $folioRFP, '$usuario')";
		$res=$this->EjecutaQuerySimple();		
		$nfact = ibase_fetch_object($res);
		$this->query="EXECUTE PROCEDURE SP_COPIA_DET_FACTURA_PEGASO($idsol, '$folioF', '$usuario')";
		$res=$this->EjecutaQuerySimple();
		/// YA TENEMOS LA NUEVA FACTURA CON SUS PARTIDAS.
		//// CREAMOS LAS PARTIDAS DE LAS NC Y SUS PARTIDAS.
		$this->query="EXECUTE PROCEDURE SP_GENERA_NC_PEGASO($idsol, '$folioNC', '$serieN', $folioNCRP, '$usuario')";
		$res=$this->EjecutaQuerySimple();
		$this->query="EXECUTE PROCEDURE SP_GENERA_DET_NC_PEGASO($idsol, '$folioNC', '$usuario')";
		$res=$this->EjecutaQuerySimple();
		return $nfact;
    }

    function actualizaFiscales($folioF, $folioNC, $idsol){
    	$this->query="UPDATE FTC_FACTURAS SET 
							FORMADEPAGOSAT= iif(FORMADEPAGOSAT IS NULL,(SELECT coalesce(SAT_FP_NUEVO, SAT_FP_ACTUAL) FROM REFACTURACION_DETALLE WHERE ID_REFAC=$idsol), FORMADEPAGOSAT),
							METODO_PAGO=iif(metodo_pago is null,(SELECT COALESCE(SAT_MP_NUEVO, SAT_MP_ACTUAL) FROM REFACTURACION_DETALLE WHERE ID_REFAC=$idsol),metodo_pago),
							USO_CFDI= iif(uso_cfdi is null, (SELECT COALESCE(SAT_USO_NUEVO, SAT_USO_NUEVO) FROM REFACTURACION_DETALLE WHERE ID_REFAC=$idsol),uso_cfdi),
							CLIENTE = TRIM(CLIENTE)
							WHERE DOCUMENTO='$folioF'";
		$this->queryActualiza();
		$this->query="UPDATE FTC_NC SET 
							FORMADEPAGOSAT= iif(FORMADEPAGOSAT IS NULL,(SELECT coalesce(SAT_FP_NUEVO, SAT_FP_ACTUAL) FROM REFACTURACION_DETALLE WHERE ID_REFAC=$idsol), FORMADEPAGOSAT),
							METODO_PAGO=iif(metodo_pago is null,(SELECT COALESCE(SAT_MP_NUEVO, SAT_MP_ACTUAL) FROM REFACTURACION_DETALLE WHERE ID_REFAC=$idsol),metodo_pago),
							USO_CFDI= iif(uso_cfdi is null, (SELECT COALESCE(SAT_USO_NUEVO, SAT_USO_NUEVO) FROM REFACTURACION_DETALLE WHERE ID_REFAC=$idsol),uso_cfdi),
							CLIENTE = TRIM(CLIENTE)
							WHERE DOCUMENTO='$folioNC'";
		$this->queryActualiza();
		return;
    }

    function timbrarDocumentos($facto, $nfact,$idsol, $folioF,$serieF, $folioRFP, $usuario, $folioNC, $serieN, $folioNCRP ){
    		$nf=substr($facto,0,2).'-'.substr($facto,2,10);
    		/// obtenemos los datos del cliente,
    		
    		$this->query="SELECT * FROM CLIE01 WHERE CLAVE_TRIM=TRIM('$nfact->NCLIENTE')";
    		$rs=$this->EjecutaQuerySimple();
    		$rowc=ibase_fetch_object($rs);
    		$cliente = $rowc->CLAVE_TRIM;
    		$nombre = $rowc->NOMBRE;
    		$rfc =  $rowc->RFC;
    	 	$this->query="SELECT * FROM XML_DATA WHERE SERIE||FOLIO ='$facto'";
                   $a=$this->EjecutaQuerySimple();
                   $rxml=ibase_fetch_object($a);
                   $uuidr=$rxml->UUID;
		    /// Nota de Credito Json.
		    $fh = "C:\\xampp\\htdocs\\Facturas\\originales\\".$nf.".json";
		    $data = file_get_contents($fh);
			$json = json_decode($data, true);
			$conceptos = $json['conceptos'];
			$imp = $json['datos_factura']['Impuestos'];
			$cfdiRelacionado = array("UUID"=>$uuidr);
			$cfdiRelacionados=array("TipoRelacion"=>"01",
									"CfdiRelacionado"=>$cfdiRelacionado
									);
			$datos_factura = array("FormaPago"=>"$nfact->FP",
									"Version"=>"3.3",
									"Folio"=>"$folioNCRP",
									"Serie"=>"$serieN",
									"TipoCambio"=>"1.0",
									"MetodoPago"=> "$nfact->MP",
				  						"RegimenFiscal"=> "601",
								    "LugarExpedicion"=> "54080",
								    "Moneda"=> "MXN",
								    "TipoDeComprobante"=> "E",
								    "condicionesDePago"=> "$nfact->FP",
								    "SubTotal"=> $json['datos_factura']['SubTotal'],
								    "CfdiRelacionados"=>$cfdiRelacionados,
								    "Impuestos"=>$imp
									);
			$json_cliente=array("id"=>"$cliente",
								"UsoCFDI"=>"G02",
								"nombre"=>"$nombre",
								"rfc"=>"$rfc",
								"correo"=>"ofarias@ftcenlinea.com"
								);
			$df =array( "conceptos"=>$conceptos,
						"datos_factura"=>$datos_factura,
						"method"=>'nueva_factura', 
						"cliente"=>$json_cliente
						);
			
			$factura = json_encode($df,JSON_UNESCAPED_UNICODE);
			$fnc = fopen("C:\\xampp\\htdocs\\Facturas\\EntradaJson\\".$folioNC.".json", 'w');
			fwrite($fnc, $factura);
			fclose($fnc);
			/// obtenemos los nodos del Json original que no cambian (conceptos, impuetos) 
			//// Elaboramos la nueva factura: 
		    $jsonActual = "C:\\xampp\\htdocs\\Facturas\\originales\\".$nf.".json";
		    $dataN = file_get_contents($jsonActual);
			$jsonFA = json_decode($dataN, true);
			$conceptosF = $jsonFA['conceptos'];
			$impFA = $jsonFA['datos_factura']['Impuestos'];
			$datos_factura = array("FormaPago"=>"$nfact->FP",
									"Version"=>"3.3",
									"Folio"=>"$folioRFP",
									"Serie"=>"$serieF",
									"TipoCambio"=>"1.0",
									"MetodoPago"=> "$nfact->MP",
				  						"RegimenFiscal"=> "601",
								    "LugarExpedicion"=> "54080",
								    "Moneda"=> "MXN",
								    "TipoDeComprobante"=> "E",
								    "condicionesDePago"=> "$nfact->FP",
								    "SubTotal"=> $jsonFA['datos_factura']['SubTotal'],
								    "Impuestos"=>$imp
									);
			$json_cliente=array("id"=>"$cliente",
								"UsoCFDI"=>"$nfact->USO",
								"nombre"=>"$nombre",
								"rfc"=>"$rfc",
								"correo"=>"ofarias@ftcenlinea.com"
								);
			$df =array( "conceptos"=>$conceptos,
						"datos_factura"=>$datos_factura,
						"method"=>'nueva_factura', 
						"cliente"=>$json_cliente
						);
			$factura = json_encode($df,JSON_UNESCAPED_UNICODE);
			$fnc = fopen("C:\\xampp\\htdocs\\Facturas\\EntradaJson\\".$folioF.".json", 'w');
			fwrite($fnc, $factura);
			fclose($fnc);
    	return $rfc;
    }

    function moverFactura($factura, $rfc){
			$espera= 3;
			sleep(3);
			$fecha = date('d-m-Y');
			while ( $espera <= 15){	
				if(file_exists("C:\\xampp\\htdocs\\Facturas\\originales\\".$factura.".json")){
					sleep(3);
					$a=copy("C:\\xampp\\htdocs\\Facturas\\FacturasJson\\".str_replace(" ","",trim($rfc))."(".$factura.")".$fecha.".xml", "C:\\xampp\\htdocs\\Facturas\\facturaPegaso\\".$factura.".xml");
					$espera = 15;
					$factura = "C:\\xampp\\htdocs\\Facturas\\FacturasJson\\".str_replace(" ","",trim($rfc))."(".$factura.")".$fecha.".xml";
					$exe = $this->insertarArchivoXMLCargado($archivo=$factura, $tipo='F');
					$mensaje= 'Todo bien';
				}elseif(file_exists("C:\\xampp\\htdocs\\Facturas\\ErroresJson\\".$factura.".json")){
					$factura = 'error';
					$mensaje = 'Error la factura no se timbro';
					$espera = 15; 
				}
				sleep(2);
				$espera = $espera+3;
			}
			$mensaje;
		return $mensaje;
    }

    function moverNC($nc, $rfc){
				$espera= 3;
				sleep(3);
				$fecha = date('d-m-Y');
				while ( $espera <= 15){	
					if(file_exists("C:\\xampp\\htdocs\\Facturas\\originales\\".$nc.".json")){
						$ncval = 'ok';
						sleep(2);
						copy("C:\\xampp\\htdocs\\Facturas\\FacturasJson\\".str_replace(" ","",trim($rfc))."(".$nc.")".$fecha.".xml", "C:\\xampp\\htdocs\\Facturas\\facturaPegaso\\".$nc.".xml");
						$nc= "C:\\xampp\\htdocs\\Facturas\\FacturasJson\\".str_replace(" ","",trim($rfc))."(".$nc.")".$fecha.".xml";
						$exe = $this->insertarArchivoXMLCargado($archivo=$nc, $tipo='F');
						$espera = 15;
					}elseif(file_exists("C:\\xampp\\htdocs\\Facturas\\ErroresJson\\".$nc.".json")){
						$factura = 'error';
						$mensaje = 'Error la factura no se timbro';
						$espera = 15; 
					}
					sleep(2);
					$espera = $espera+3;
				}
				$mensaje ='';
		return $mensaje; 
    }

    function timbraFact($docf){
    		$this->query="SELECT * FROM CLIE01 WHERE CLAVE_TRIM= (SELECT TRIM(CLIENTE) FROM FTC_FACTURAS WHERE DOCUMENTO='$docf')";
    		$rs=$this->EjecutaQuerySimple();
    		$rowc=ibase_fetch_object($rs);
    		$cliente = $rowc->CLAVE_TRIM;
    		$nombre = $rowc->NOMBRE;
    		$rfc =  $rowc->RFC;
	    	//exit('hasta aqui llega:'.$nombre.', rfc: '.$rfc.' Cliente: '.$cliente);
	    	$this->query ="SELECT * from FTC_FACTURAS_DETALLE WHERE DOCUMENTO = '$docf'";
			$rs=$this->EjecutaQuerySimple();
			while ($tsArray = ibase_fetch_object($rs)){
				$data[]=$tsArray;
			}
		$stimpuestosat = 0;
		$stimportesat=0;
		foreach($data as $keyp ){
			$dec=2;
			$SubTotal = number_format($keyp->SUBTOTAL,2,'.','');
			$impimp = explode('.',($SubTotal*0.16));
			@$impimpdec=substr($impimp[1],0,$dec);
			$impimpdec=(strlen($impimpdec) == 1)? substr($impimp[1],0,$dec).'0':$impimpdec;
			$impimpdec=(strlen($impimpdec) <= 0)? '00':$impimpdec;
			$impimp = $impimp[0].'.'.$impimpdec;
			$base = explode('.',$SubTotal);
			@$basedec = substr($base[1],0,$dec);
			$base = $base[0].'.'.$basedec; 
			$base=(strlen($base) == 1)? substr($base[1],0,$dec).'0':$base;
			$base=(strlen($base) <= 0)? '00':$base;
			$impConcepto=array(
								"Base"=>"$base",
					            "Impuesto"=>"002",
					            "TipoFactor"=>"Tasa",
					            "TasaOCuota"=>"0.160000",
					            "Importe"=>"$impimp"
								);
			$trasConceptos[]=$impConcepto;
			$trasConcepto=array("Traslados"=>$trasConceptos);
			unset($trasConceptos);
			$concepto = array(
							  "ClaveProdServ"=> trim("$keyp->CLAVE_SAT"),
						      "ClaveUnidad"=> "$keyp->MEDIDA_SAT",
						      "noIdentificacion"=> "$keyp->ARTICULO",
						      "unidad"=> "$keyp->UM",
						      "Cantidad"=>"$keyp->CANTIDAD",
						      "descripcion"=> "$keyp->DESCRIPCION",
						      "ValorUnitario"=> "$keyp->PRECIO",
						      "Importe"=> "$base",
						      "Impuestos"=>$trasConcepto
								);
			$conceptos[]=$concepto;
			$stimpuestosat =$stimpuestosat + $impimp;
			$stimportesat = $stimportesat + $base;
		}
		$SubTotalSat= $stimpuestosat+$stimportesat;
		/// FIN DEL NODO CONCEPTOS.
		/// ARMADO DE LA CABECERA EN JSON:
		$this->query="SELECT * FROM FTC_FACTURAS WHERE DOCUMENTO = '$docf'";
		$res=$this->EjecutaQuerySimple();
		//echo $this->query;

		$factura=ibase_fetch_object($res);
		
		$nf=substr($docf,3,10);

		$IVA = number_format($factura->IVA,2,'.','');
		$subTotalDoc = number_format($factura->SUBTOTAL,2,'.','');
		//$ST= number_format($ST,2,'.','');
		$impuesto1 = array(	"Impuesto"=> "002",
						    "TipoFactor"=> "Tasa",
						    "TasaOCuota"=>"0.160000",
						    //"Importe"=> "$IVA"
						    "Importe"=>"$stimpuestosat"
							);
		$Traslados=array($impuesto1);
		$imptrs="TotalImpuestosTrasladados:".$stimpuestosat;//$IVA; 
		$imp = array(
				     "TotalImpuestosTrasladados"=>"$stimpuestosat", //"$IVA",
				 	 "Traslados"=>$Traslados);
		$impuestos = array("Impuestos"=>$imp,);
		$datos_factura = array("FormaPago"=>"$factura->METODO_PAGO",
								"Version"=>"3.3",
								"Folio"=>"$nf",
								"Serie"=>"RFP",
								"TipoCambio"=>"1.0",
								"MetodoPago"=> "$factura->FORMADEPAGOSAT",
			  						"RegimenFiscal"=> "601",
							    "LugarExpedicion"=> "54080",
							    "Moneda"=> "MXN",
							    "TipoDeComprobante"=> "I",
							    "condicionesDePago"=> "$factura->METODO_PAGO",
							    "SubTotal"=>"$stimportesat" ,//"$subTotalDoc",
							    "Impuestos"=>$imp
						);

		$json_cliente=array("id"=>"$cliente",
							"UsoCFDI"=>"$factura->USO_CFDI",
							"nombre"=>"$nombre",
							"rfc"=>"$rfc",
							"correo"=>"ofarias@ftcenlinea.com"
							);
		$df =array( "conceptos"=>$conceptos,
					"datos_factura"=>$datos_factura,
					"method"=>'nueva_factura', 
					"cliente"=>$json_cliente
					);


		$factura = json_encode($df,JSON_UNESCAPED_UNICODE);
		$fh = fopen("C:\\xampp\\htdocs\\Facturas\\EntradaJson\\".'RFP'.$nf.".json", 'w');
		fwrite($fh, $factura);
		fclose($fh);
		$espera= 3;
		sleep(3);
		$fecha = date('d-m-Y');
		return $rfc;
    }

    function timbrarFacturaRef($facto, $nfact,$idsol, $folioF,$serieF, $folioRFP, $usuario, $folioNC, $serieN, $folioNCRP){
    	//// Armamos el Json Nueva y completamente Nuevo;
    	$docu=$nfact['folioF'];
    	$this->query="SELECT * FROM CLIE01 WHERE CLAVE_TRIM= (SELECT TRIM(CLIENTE) FROM FTC_FACTURAS WHERE DOCUMENTO='$docu')";
    		$rs=$this->EjecutaQuerySimple();
    		$rowc=ibase_fetch_object($rs);
    		$cliente = $rowc->CLAVE_TRIM;
    		$nombre = $rowc->NOMBRE;
    		$rfc =  $rowc->RFC;
    	//exit('hasta aqui llega:'.$nombre.', rfc: '.$rfc.' Cliente: '.$cliente);
    	/*
    	$this->query ="SELECT * from FTC_FACTURAS_DETALLE WHERE DOCUMENTO = '$docu'";
		$rs=$this->EjecutaQuerySimple();
		while ($tsArray = ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}
		/// CREACION DE NODOS CONCEPTOS:
		$stimpuestosat = 0;
		$stimportesat=0;
		foreach($data as $keyp ){
			$dec=2;
			$SubTotal = number_format($keyp->SUBTOTAL,2,'.','');
			$impimp = explode('.',($SubTotal*0.16));
			@$impimpdec=substr($impimp[1],0,$dec);
			$impimpdec=(strlen($impimpdec) == 1)? substr($impimp[1],0,$dec).'0':$impimpdec;
			$impimpdec=(strlen($impimpdec) <= 0)? '00':$impimpdec;
			$impimp = $impimp[0].'.'.$impimpdec;
			$base = explode('.',$SubTotal);
			@$basedec = substr($base[1],0,$dec);
			$base = $base[0].'.'.$basedec; 
			$base=(strlen($base) == 1)? substr($base[1],0,$dec).'0':$base;
			$base=(strlen($base) <= 0)? '00':$base;
			$impConcepto=array(
								"Base"=>"$base",
					            "Impuesto"=>"002",
					            "TipoFactor"=>"Tasa",
					            "TasaOCuota"=>"0.160000",
					            "Importe"=>"$impimp"
								);
			$trasConceptos[]=$impConcepto;
			$trasConcepto=array("Traslados"=>$trasConceptos);
			unset($trasConceptos);
			$concepto = array(
							  "ClaveProdServ"=> trim("$keyp->CLAVE_SAT"),
						      "ClaveUnidad"=> "$keyp->MEDIDA_SAT",
						      "noIdentificacion"=> "$keyp->ARTICULO",
						      "unidad"=> "$keyp->UM",
						      "Cantidad"=>"$keyp->CANTIDAD",
						      "descripcion"=> "$keyp->DESCRIPCION",
						      "ValorUnitario"=> "$keyp->PRECIO",
						      "Importe"=> "$base",
						      "Impuestos"=>$trasConcepto
								);
			$conceptos[]=$concepto;
			$stimpuestosat =$stimpuestosat + $impimp;
			$stimportesat = $stimportesat + $base;
		}
		$SubTotalSat= $stimpuestosat+$stimportesat;
		/// FIN DEL NODO CONCEPTOS.
		/// ARMADO DE LA CABECERA EN JSON:
		$this->query="SELECT * FROM FTC_FACTURAS WHERE DOCUMENTO = '$docu'";
		$res=$this->EjecutaQuerySimple();
		$factura=ibase_fetch_object($res);
		$nf=$nfact['folioRFP'];
		$IVA = number_format($factura->IVA,2,'.','');

		$subTotalDoc = number_format($factura->SUBTOTAL,2,'.','');
		//$ST= number_format($ST,2,'.','');
		$impuesto1 = array(	"Impuesto"=> "002",
						    "TipoFactor"=> "Tasa",
						    "TasaOCuota"=>"0.160000",
						    //"Importe"=> "$IVA"
						    "Importe"=>"$stimpuestosat"
							);
		$Traslados=array($impuesto1);
		$imptrs="TotalImpuestosTrasladados:".$stimpuestosat;//$IVA; 
		$imp = array(
				     "TotalImpuestosTrasladados"=>"$stimpuestosat", //"$IVA",
				 	 "Traslados"=>$Traslados);
		$impuestos = array("Impuestos"=>$imp,);
		$datos_factura = array("FormaPago"=>"$factura->FORMADEPAGOSAT",
								"Version"=>"3.3",
								"Folio"=>"$nf",
								"Serie"=>"RFP",
								"TipoCambio"=>"1.0",
								"MetodoPago"=> "$factura->METODO_PAGO",
			  						"RegimenFiscal"=> "601",
							    "LugarExpedicion"=> "54080",
							    "Moneda"=> "MXN",
							    "TipoDeComprobante"=> "I",
							    "condicionesDePago"=> "$factura->FORMADEPAGOSAT",
							    "SubTotal"=>"$stimportesat" ,//"$subTotalDoc",
							    "Impuestos"=>$imp
						);

		$json_cliente=array("id"=>"$cliente",
							"UsoCFDI"=>"$factura->USO_CFDI",
							"nombre"=>"$nombre",
							"rfc"=>"$rfc",
							"correo"=>"ofarias@ftcenlinea.com"
							);
		$df =array( "conceptos"=>$conceptos,
					"datos_factura"=>$datos_factura,
					"method"=>'nueva_factura', 
					"cliente"=>$json_cliente
					);
		$factura = json_encode($df,JSON_UNESCAPED_UNICODE);
		$fh = fopen("C:\\xampp\\htdocs\\Facturas\\EntradaJson\\".'RFP'.$nf.".json", 'w');
		fwrite($fh, $factura);
		fclose($fh);
		$espera= 3;
		sleep(3);
		$fecha = date('d-m-Y');+

	*/
	return $rfc;
    }

    function timbrarNCRef($facto, $nfact,$idsol, $folioF,$serieF, $folioRFP, $usuario, $folioNC, $serieN, $folioNCRP){
    	//// Armamos el Json Nueva y completamente Nuevo;
    	
    	############### Traemos los datos Fiscales para la factura.##############
    	$docu=$nfact['folioNC'];
    	$this->query="SELECT * FROM FTC_EMPRESAS WHERE ID = 1";
    	$r=$this->EjecutaQuerySimple();
    	$rowDF=ibase_fetch_object($r);
		#########################################################################

    	$this->query="SELECT * FROM CLIE01 WHERE CLAVE_TRIM= (SELECT TRIM(CLIENTE) FROM FTC_NC WHERE DOCUMENTO='$docu')";
    		$rs=$this->EjecutaQuerySimple();
    		$rowc=ibase_fetch_object($rs);
    		$cliente = $rowc->CLAVE_TRIM;
    		$nombre = $rowc->NOMBRE;
    		$rfc =  $rowc->RFC;
    	//exit('hasta aqui llega:'.$nombre.', rfc: '.$rfc.' Cliente: '.$cliente);
    	$this->query ="SELECT * from FTC_NC_DETALLE WHERE DOCUMENTO = '$docu'";
		$rs=$this->EjecutaQuerySimple();
		while ($tsArray = ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}
		/// CREACION DE NODOS CONCEPTOS:
		$stimpuestosat = 0;
		$stimportesat=0;
		foreach ($data as $keyp ) {
			$dec=2;
			$SubTotal = number_format($keyp->SUBTOTAL,2,'.','');
			$impimp = explode('.',($SubTotal*0.16));
			@$impimpdec=substr($impimp[1],0,$dec);
			$impimpdec=(strlen($impimpdec) == 1)? substr($impimp[1],0,$dec).'0':$impimpdec;
			$impimpdec=(strlen($impimpdec) <= 0)? '00':$impimpdec;
			$impimp = $impimp[0].'.'.$impimpdec;
			$base = explode('.',$SubTotal);
			@$basedec = substr($base[1],0,$dec);
			$base = $base[0].'.'.$basedec; 
			$base=(strlen($base) == 1)? substr($base[1],0,$dec).'0':$base;
			$base=(strlen($base) <= 0)? '00':$base;
			$impConcepto=array(
								"Base"=>"$base",
					            "Impuesto"=>"002",
					            "TipoFactor"=>"Tasa",
					            "TasaOCuota"=>"0.160000",
					            "Importe"=>"$impimp"
								);
			$trasConceptos[]=$impConcepto;
			$trasConcepto=array("Traslados"=>$trasConceptos);
			unset($trasConceptos);
			$concepto = array(
							  "ClaveProdServ"=> trim("$keyp->CLAVE_SAT"),
						      "ClaveUnidad"=> "$keyp->MEDIDA_SAT",
						      "noIdentificacion"=> "$keyp->ARTICULO",
						      "unidad"=> "$keyp->UM",
						      "Cantidad"=>"$keyp->CANTIDAD",
						      "descripcion"=> "$keyp->DESCRIPCION",
						      "ValorUnitario"=> "$keyp->PRECIO",
						      "Importe"=> "$base",
						      "Impuestos"=>$trasConcepto
								);
			$conceptos[]=$concepto;
			$stimpuestosat =$stimpuestosat + $impimp;
			$stimportesat = $stimportesat + $base;
		}
		$SubTotalSat= $stimpuestosat+$stimportesat;
		/// FIN DEL NODO CONCEPTOS.
		/// ARMADO DE LA CABECERA EN JSON:
		$this->query="SELECT * FROM FTC_NC WHERE DOCUMENTO = '$docu'";
		$res=$this->EjecutaQuerySimple();
		$factura=ibase_fetch_object($res);
		$nf=$nfact['folioNCRP'];
		$IVA = round($factura->IVA,2);
		$subTotalDoc = number_format($factura->SUBTOTAL,2,'.','');
		//$ST= number_format($ST,2,'.','');
		$impuesto1 = array(	"Impuesto"=> "002",
						    "TipoFactor"=> "Tasa",
						    "TasaOCuota"=>"0.160000",
						    //"Importe"=> "$IVA"
						    "Importe"=>"$stimpuestosat"
							);
		$Traslados=array($impuesto1);
		$imptrs="TotalImpuestosTrasladados:".$stimpuestosat;//$IVA;
		$imp = array(
				     "TotalImpuestosTrasladados"=>"$stimpuestosat", //"$IVA",
				 	 "Traslados"=>$Traslados);
		$impuestos = array("Impuestos"=>$imp,);
		$datos_factura = array("FormaPago"=>"99",
								"Version"=>"3.3",
								"Folio"=>"$nf",
								"Serie"=>"NCR",
								"TipoCambio"=>"1.0",
								"MetodoPago"=> "PUE",
			  					"RegimenFiscal"=> "$rowDF->REGIMEN_FISCAL",
							    "LugarExpedicion"=> "$rowDF->EXPEDICION",
							    "Moneda"=> "MXN",
							    "TipoDeComprobante"=> "E",
							    "condicionesDePago"=> "99",
							    "SubTotal"=>"$stimportesat" ,//"$subTotalDoc",
							    "Impuestos"=>$imp
						);

		$json_cliente=array("id"=>"$cliente",
							"UsoCFDI"=>"G02",
							"nombre"=>"$nombre",
							"rfc"=>"$rfc",
							"correo"=>"ofarias@ftcenlinea.com"
							);
		$df =array( "conceptos"=>$conceptos,
					"datos_factura"=>$datos_factura,
					"method"=>'nueva_factura', 
					"cliente"=>$json_cliente
					);
		$factura = json_encode($df,JSON_UNESCAPED_UNICODE);
		$fh = fopen("C:\\xampp\\htdocs\\Facturas\\EntradaJson\\".'NCR'.$nf.".json", 'w');
		fwrite($fh, $factura);
		fclose($fh);
		$espera= 3;
		sleep(3);
		$fecha = date('d-m-Y');
	return $rfc;
    }

     function facturaPegaso($factura){
		$data=array();
		if(substr($factura,0,3)=='NCR' or substr($factura,0,3)=='NCS' or substr($factura, 0,3) == 'NCD' or substr($factura, 0,3) == 'NCB'){
			$this->query="SELECT * FROM NC_PEGASO WHERE DOCUMENTO = '$factura'";
			$res=$this->EjecutaQuerySimple();
		}elseif(substr($factura,0,3)=='NCI'){
			$this->query="SELECT * FROM NCI_PEGASO WHERE DOCUMENTO = '$factura'";
			$res=$this->EjecutaQuerySimple();
		}else{
			$this->query="SELECT F.*, 
			(SELECT refer_Edo FROM CLIE01 WHERE CLAVE_TRIM = F.clave) AS CTA_EMISORA, 
			(SELECT banco_origen FROM CLIE01 WHERE CLAVE_TRIM = F.clave) AS BANCO_EMISOR,
			(SELECT BANCO_DEPOSITO FROM CLIE01 WHERE CLAVE_TRIM = F.clave) as Banco_Pegaso 
			FROM FACTURA_PEGASO F WHERE DOCUMENTO = '$factura'";
			$res=$this->EjecutaQuerySimple();
		}
		while ($tsArray = ibase_fetch_object($res)) {
			$data[]=$tsArray;
		}
		return $data;
	}


    function solRefac($idsol, $tipo){
    	$this->query="SELECT * FROM REFACTURACION WHERE ID = $idsol";
    	$rs=$this->EjecutaQuerySimple();
    	$row=ibase_fetch_object($rs);
    	//echo 'Solicitud'.$idsol;
    	if($row->TIPO_SOLICITUD== 'CAMBIO CLIENTE' AND empty($row->NUEVO_CLIENTE)){
    		return $respuesta=array("status"=>"Falta el cliente nuevo, favor de revisarlo con revision.");
    	}
    	if($row->STATUS_SOLICITUD == 0 and ($row->TIPO_SOLICITUD == 'CAMBIO CLIENTE' OR $row->TIPO_SOLICITUD == 'CAMBIO FECHA')){
    		if($tipo == 'a'){
    			$this->query="UPDATE REFACTURACION SET STATUS_SOLICITUD = 1 WHERE ID = $idsol";
    			$res=$this->queryActualiza();
    			if($res == 1 ){
    				$respuesta = array("status"=>'Autorizada');
    				$this->query="UPDATE FACTF01 SET VALIDACION  = $idsol where cve_doc = '$row->FACT_ORIGINAL'";
    				$this->queryActualiza();
    				$this->query="UPDATE PAR_FACTF01 SET VALIDACION = $idsol where cve_doc = '$row->FACT_ORIGINAL'";
    				$this->queryActualiza();
    				$this->query="UPDATE FACTR01 SET VALIDACION  = $idsol where cve_doc = '$row->FACT_ORIGINAL'";
    				$this->queryActualiza();
    				$this->query="UPDATE PAR_FACTR01 SET VALIDACION = $idsol where cve_doc = '$row->FACT_ORIGINAL'";
    				$this->queryActualiza();
    				//$nc=$this->creaNC($idc, $uso, $tpago, $mpago, $cp);
    				//$ref = $this->creaREF($idc, $uso, $tpago, $mpago , $cp);
    				//$refactura = $this->creaFactura($idc, $uso, $tpago, $mpago, $cp);
    			}else{
    				$respuesta = array("status"=>'Error al actualizar, intente de nuevo, si no, reporte a sistemas');	
    			}
    		}else{
    			$this->query = "UPDATE REFACTURACION SET STATUS_SOLICITUD = 3 WHERE ID = $idsol";
    			$res=$this->queryActualiza();
    			if($res == 1 ){
    				$respuesta = array("status"=>'Recahzado');
    			}else{
    				$respuesta = array("status"=>'Error al actualizar, intente de nuevo, si no, reporte a sistemas');	
    			}
    		}
    	}else{
    		$respuesta = array("status"=>'Ya Procesada');	
		}
		return $respuesta;
    }


    function verRefacNueva($docref){
    	$this->query = "SELECT * FROM PAR_FACTV01 PV LEFT JOIN PRODUCTO_FTC PFTC ON PFTC.CLAVE = PV.CVE_ART WHERE CVE_DOC = '$docref'";
    	$rs=$this->EjecutaQuerySimple();
    	while ($tsArray=ibase_fetch_object($rs)) {
    		$data[]=$tsArray;
    	}
    	return($data);
    }


    function quitarPartidaRef($docref, $partida){
    	$this->query="SELECT PXS, iif(cant_val is null, 999999, cant_val) as cant_val FROM PAR_FACTV01 WHERE CVE_DOC = '$docref' and num_par = $partida";
    	$rs=$this->EjecutaQuerySimple();
    	$row=ibase_fetch_object($rs);
    	$pendiente = $row->PXS;
    	$omitido = $row->CANT_VAL;

    	if ($omitido == 999999 or $omitido == 0){
    		$this->query="UPDATE PAR_FACTV01 SET CANT_VAL = PXS, PXS = 0 WHERE CVE_DOC = '$docref' and num_par = $partida";
    		$res=$this->queryActualiza();
    		if($res == 1 ){
    			return array("status"=>0,"mensaje"=>'Se quito la partida y se marca como pendiente');
    		}else{
    			return array("status"=>9,"mensaje"=>'No se pudo actualizar, revise la informacion' );
    		}
    	}elseif($omitido > 0 ){
    		$this->query="UPDATE PAR_FACTV01 SET CANT_VAL = 0, PXS = CANT_VAL WHERE CVE_DOC = '$docref' and num_par = $partida";
    		$res=$this->queryActualiza();
    		if($res == 1 ){
    			$this->query="UPDATE FACTV01 SET ENLAZADO = iif(enlazado = 'O', 'O', 'P') WHERE CVE_DOC = '$docref'";
    			$this->EjecutaQuerySimple();
    			return array("status"=>0,"mensaje"=>'Se agrego la partida y se puede facturar');
    		}else{
    			return array("status"=>9,"mensaje"=>'No se pudo actualizar, revise la informacion' );
    		}
    	}
    }


     function quitarCaja($caja){
    	$usuario = $_SESSION['user']->NOMBRE;
    	$this->query="UPDATE PREOC01 SET FECHADEV = CURRENT_TIMESTAMP, MOTIVOS_NOSUMINISTRABLE = '$usuario' WHERE COTIZA =  '$caja'";
    	$this->queryActualiza();
    	return;
    }

    function verCtrlCajasAbiertas(){
    	$usuario = $_SESSION['user']->NOMBRE;
    	$this->query="SELECT C.*, CL.NOMBRE, CL.CODIGO, P.FECHAELAB, P.IMPORTE, P.CITA, P.DOC_SIG, U.NOMBRE AS USUARIO 
    		FROM CAJAS C LEFT JOIN FACTP01 P ON P.CVE_DOC = C.CVE_FACT LEFT JOIN CLIE01 CL ON CL.CLAVE = P.CVE_CLPV LEFT JOIN PG_USERS U ON U.USER_LOGIN = C.USUARIO_CAJA WHERE C.STATUS = 'abierto' and fecha_creacion > dateadd(day,-8, current_date) order by fecha_creacion";
    	$rs=$this->EjecutaQuerySimple();
    	while ($tsArray=ibase_fetch_object($rs)) {
    		$data[]=$tsArray;
    	}
    	return $data;
    }


    function verFaltantesFacturar(){
    	$usuario = $_SESSION['user']->NOMBRE;
    	$this->query="SELECT c.*, cast(fecha as date), (select nombre from clie01 cl left join factp01 p on p.cve_clpv = cl.clave where p.cve_doc = c.cotizacion), 
    		(SELECT NOMBRE FROM PRODUCTO_FTC WHERE CLAVE = c.producto) as descripcion from control_fact_rem c where fecha>= dateadd(day, -15, CURRENT_DATE) AND STATUS = 'Nuevo' order by fecha";
    	$rs=$this->EjecutaQuerySimple();
    	while ($tsArray=ibase_fetch_object($rs)) {
    		$data[]=$tsArray;
    	}
    	return $data;
    }


    function cajasAbiertas(){
    	$data = array();
    	$this->query="SELECT count(id), cast(fecha_creacion as date) from cajas where status = 'abierto' and fecha_creacion >= dateadd(day, -1, current_date)  group by cast(fecha_creacion as date)";
    	$rs=$this->EjecutaQuerySimple(); 
    	while ($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	$cajas = count($data);
    	//echo 'Cajas: '.$cajas.'<br/>';
    	return $cajas;
    }
			
	function paquetesSinFact(){
		$data = array();
    	$this->query="SELECT c.*, cast(fecha as date) from control_fact_rem c where fecha>= dateadd(day, -15, CURRENT_DATE) AND STATUS = 'Nuevo' order by fecha";
    	$rs=$this->EjecutaQuerySimple(); 
    	while ($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	$paquetes = count($data);
    	//echo 'Paquetes: '.$paquetes.'<br/>';
    	return $paquetes;	
	}


	function recibeDocRep($idcaja){
		$usuario = $_SESSION['user']->NOMBRE;
		//exit($usuario);
		$this->query="SELECT  docs, usuario_log FROM CAJAS WHERE ID = $idcaja";
		$rs=$this->EjecutaQuerySimple();
		$row = ibase_fetch_object($rs);
		//exit($this->query);
		if($row->DOCS =='No' or ($row->DOCS == 'Si' or $row->DOCS =='S')){
			$this->query="UPDATE CAJAS SET DOCS='Si', RUTA = 'N', U_LOGISTICA = '$usuario', FECHA_U_LOGISTICA = CURRENT_TIMESTAMP  WHERE ID = $idcaja";
			$rs =$this->queryActualiza();
			if($rs  == 1 ){
				$this->query="UPDATE factf01 set status_fact = 'Logistica' where cve_doc = (select factura from cajas where id = $idcaja) and status_fact is null";
				$this->EjecutaQuerySimple();
				$this->query="UPDATE factr01 set status_rem = 'Logistica' where cve_doc = (select remision from cajas where id = $idcaja) and status_rem is null";
				$this->EjecutaQuerySimple();
				return array("status"=>'ok', "usuario"=> $usuario, "fecha"=>date('d-m-Y H:i:s'));
			}else{
				return array("status"=>'no', "usuario"=>$usuario,  "fecha"=>date('d-m-Y H:i:s'));
			}
		}else{
			$u = $row->USUARIO_LOG;
			return array("status"=>'okok', "usuario"=>$u);
		}
	}

	function aRutaRep($idcaja, $unidad){
		$mysql = new pegaso_rep;
		$usuario=$_SESSION['user']->NOMBRE;
		$this->query="SELECT * FROM CAJAS WHERE ID = $idcaja";
		$rs=$this->EjecutaQuerySimple();
		$row = ibase_fetch_object($rs);
		//echo 'Docs: '.$row->DOCS;
		if(strtoupper($row->DOCS) == 'SI' or strtoupper($row->DOCS) =='S'){
			if(empty($row->UNIDAD) and $row->STATUS_RECEPCION == 0 ){
				$this->query="INSERT INTO FTC_HISTORIA_CAJA VALUES(NULL,(SELECT STATUS_RECEPCION FROM CAJAS WHERE ID = $idcaja), 0, CURRENT_TIMESTAMP, '$usuario', $idcaja, (SELECT iif(factura = '', remision , factura) from cajas where id = $idcaja))";
    			$this->grabaBD();

				$this->query="UPDATE CAJAS SET unidad = '$unidad', idu=(select idu from unidades where numero  = '$unidad'  and status = 'A') , U_LOGISTICA = '$usuario', FECHA_U_LOGISTICA = current_timestamp, STATUS_RECEPCION = 0 WHERE ID =$idcaja";
				$this->queryActualiza();
				
				$datos = array($unidad, $idcaja);
				$sql = $mysql->asignaUnidad($datos);				

				return array("status"=>'ok1', "mensaje"=>'Se asigno a la unidad');
			}elseif($usuario == $row->U_LOGISTICA){
				$this->query="INSERT INTO FTC_HISTORIA_CAJA VALUES(NULL,(SELECT STATUS_RECEPCION FROM CAJAS WHERE ID = $idcaja), 0, CURRENT_TIMESTAMP, '$usuario', $idcaja, (SELECT iif(factura = '', remision , factura) from cajas where id = $idcaja))";
    			$this->grabaBD();
				$this->query="UPDATE CAJAS SET unidad = '$unidad', idu = (select idu from unidades where numero = '$unidad'  and status = 'A'),U_LOGISTICA = '$usuario', FECHA_U_LOGISTICA = current_timestamp, STATUS_RECEPCION = 0 WHERE ID =$idcaja";
				$rs=$this->queryActualiza();
				$datos = array($unidad, $idcaja);
				$sql = $mysql->asignaUnidad($datos);
				if($rs==1){
					return array("status"=>'ok2', "mensaje"=>'Se ha cambiado la unidad');
				}else{
					return array("status"=>'error', "mensaje"=>'No se ha podido cambiar');
				}
			}else{
				return array("status"=>'na',"mensaje"=>"Solo el usuario original: ".$row->U_LOGISTICA." puede cambiar la unidad");
			}
		}else{
			return array("status"=>'sinDocs', "mensaje"=>"Primero debe marcar el documento como recibido...");
		}
		
	}

	function RutaEntregaSecuencia($idcaja, $docf,  $estado, $unidad){
   		$user =$_SESSION['user']->NOMBRE;
		$this->query="SELECT * FROM CAJAS WHERE (STATUS_RECEPCION = 0 or STATUS_RECEPCION IS NULL) and u_logistica = '$user' and ruta = 'N' and unidad <> '' and unidad is not null";
		$rs=$this->EjecutaQuerySimple();
		while($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}

		foreach ($data as $key) {
			$this->query="UPDATE cajas
					  SET RUTA = 'A', fecha_secuencia = current_timestamp, STATUS_LOG = 'secuencia', STATUS_MER = '', DOCS = 'No', STATUS_RECEPCION = 1
					  WHERE id = '$key->ID'";
			$rs = $this->queryActualiza();			
		}
		return $rs;
	}

	function traeUnidadActual($idcaja){
		$this->query="SELECT * FROM CAJAS WHERE ID = $idcaja";
		$rs=$this->EjecutaQuerySimple();
		$row=ibase_fetch_object($rs);
		return array("caja"=>$row->UNIDAD);
	}

	function CreaSubMenuEntrega($tipo){
		$data=array();
		$this->query="SELECT c.unidad,max(c.idu) as idu,
						    count(c.id) as documentos, 
							max(u.placas) as placas, 
							max(u.operador) as operador, 
							max(u.coordinador) as coordinador,
							max(u.marca) as marca, 
							max(u.modelo) as modelo, 
							max(u.numero) as numero  FROM CAJAS c left join unidades u on u.idu = c.idu 
							WHERE STATUS_RECEPCION = $tipo 
							group by c.unidad";
		$res=$this->EjecutaQuerySimple();
		//echo $this->query;
		while ($tsArray= ibase_fetch_object($res)) {
			$data[]=$tsArray;
		}
     	return $data;  
	}

	function unidadeslog(){
		$data=array();
		$this->query="SELECT coalesce(STATUS_RECEPCION,9999) as status_recepcion, COUNT(ID) AS CAJA FROM CAJAS WHERE STATUS_RECEPCION = 0 OR STATUS_RECEPCION = 1 OR STATUS_RECEPCION = 2 OR STATUS_RECEPCION = 3 or status_recepcion is null GROUP BY STATUS_RECEPCION";
		$rs=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($rs)) {
			$data[]=$tsArray;
		}
		return $data;
	}
	

	function finRutaLog($idcaja, $fin, $tipo){
		$usuario = $_SESSION['user']->NOMBRE;
		$this->query="SELECT * FROM CAJAS WHERE ID = $idcaja";
		$res=$this->EjecutaQuerySimple();
		$row = ibase_fetch_object($res);
		$status = $row->STATUS_RECEPCION;
		$val=$this->traeStatus($idcaja);
		if($status == 2 or $status == 3){
			if($tipo == 1){
			$this->query="INSERT INTO FTC_HISTORIA_CAJA VALUES(NULL,(SELECT STATUS_RECEPCION FROM CAJAS WHERE ID = $idcaja), 2, CURRENT_TIMESTAMP, '$usuario', $idcaja, (SELECT iif(factura = '', remision , factura) from cajas where id = $idcaja))";
			$this->grabaBD();

			$this->query="UPDATE CAJAS SET STATUS_RECEPCION = 2, status_log = '$fin' WHERE ID = $idcaja";
			$rs=$this->queryActualiza();
			if($rs == 1 ){
				return array("status"=>'ok', "mensaje"=>'Se cambio el status.');
			}else{
				return array("status"=>'error', "mensaje"=>'Ocurrio un error.');
			}
			}elseif($tipo == 3 and ($status == 3 or $status ==4)){

				$this->query="INSERT INTO CAMBIOS_LOG_BOD (id, caja, original, nuevo, usuario, fecha) VALUES (NULL, $idcaja, (SELECT STATUS_LOG FROM CAJAS WHERE ID = $idcaja), '$fin', '$usuario', current_timestamp)";
				$this->EjecutaQuerySimple();

				$this->query="INSERT INTO FTC_HISTORIA_CAJA VALUES(NULL,(SELECT STATUS_RECEPCION FROM CAJAS WHERE ID = $idcaja), 4, CURRENT_TIMESTAMP, '$usuario', $idcaja, (SELECT iif(factura = '', remision , factura) from cajas where id = $idcaja))";
				$this->grabaBD();

				$this->query="UPDATE CAJAS SET STATUS_LOG = '$fin', STATUS_RECEPCION = 4 where id = $idcaja";
				$res=$this->queryActualiza();
				if($res == 1){
					return array("status"=>'ok',"mensaje"=>'Se ha cambiado el Status');
				}else{
					return array("status"=>'error',"mensaje"=>'se pudo cambiar el status');
				}
			}else{
				return array('status'=>"error" ,"mensaje"=>'No se ha cerrado la ruta de logistica, solo se puede cambiar rutas cerradas');
			}	
		}else{
			return array('status'=>"error" ,"mensaje"=>'Ya se ha cerrado la ruta');
		}
	}

	function recibirLogistica($ruta){
		if($ruta == 'a'){
			$this->query="SELECT idu, count(ID) as documentos, max(unidad) as unidad, 
						(SELECT MAX(OPERADOR) FROM UNIDADES WHERE IDU = a.idu) as operador, (SELECT MAX(PLACAS) FROM UNIDADES WHERE IDU = a.idu) as placas
		    			FROM CAJAS a
		    			where STATUS_RECEPCION >= 1 AND STATUS_RECEPCION < 5 
		    			group by a.idu";			
		}else{
			$this->query="SELECT a.*, c.nombre, c.estado, c.codigo, b.fechaelab, (datediff(day,b.fechaelab,current_date)) as dias, 
			a.remision||'/'||a.factura  as DOCUMENTO,
			iif(a.factura is null or a.factura = '', r.importe, b.importe) as importe,
			(SELECT FIRST 1 ORIGINAL FROM CAMBIOS_LOG_BOD WHERE CAJA = a.id) as ORIGINAL
		    FROM CAJAS a
		    LEFT JOIN FACTP01 d ON a.cve_fact = d.cve_doc
		    LEFT JOIN FACTF01 b on b.cve_doc = a.factura 
		    left join factr01 r on a.remision = r.cve_doc
		    LEFT JOIN CLIE01 c on d.cve_clpv = c.clave
		    where STATUS_RECEPCION >= 1 AND STATUS_RECEPCION < 5 and unidad = '$ruta'
		    order by unidad ";	
		}
		$rs=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($rs)) {
			$data[]=$tsArray;
		}
		return $data;
	}

	function verVueltas($idcaja){
		$data=array();
		$this->query="SELECT * FROM FTC_REG_VUELTAS WHERE CAJA = $idcaja";
		$rs=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($rs)) {
			$data[]=$tsArray;
		}
	return $data;
	}


	function meses(){
		$data = array();
		$datos = array();
		$this->query="SELECT * FROM PERIODOS_2016 WHERE ANHIO >= 2018 order by id";
		$rs=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($rs)) {
			$data[]=$tsArray;
		}
		$cajasxmes = 0;
		$asignacion= 0;
		$secuencia = 0;
		$administracion = 0;
		$bodega = 0;
		$procesadas= 0;
		$faltantes = 0;

		foreach ($data as $mes) {
			$this->query="SELECT count(id) as cajas FROM CAJAS WHERE EXTRACT(MONTH FROM FECHA_creacioN) = $mes->NUMERO and EXTRACT(YEAR FROM FECHA_creacion) = $mes->ANHIO ";
			$rs=$this->EjecutaQuerySimple();
			$row=ibase_fetch_object($rs);	
			if(!empty($row)){
				$cajasxmes = $row->CAJAS; 	
			}
			$this->query="SELECT count(id) as cajas FROM CAJAS WHERE EXTRACT(MONTH FROM FECHA_creacioN) = $mes->NUMERO and EXTRACT(YEAR FROM FECHA_creacion) = $mes->ANHIO
				and (status_recepcion = 0 or status_recepcion is null)";
			$rs=$this->EjecutaQuerySimple();
			$row=ibase_fetch_object($rs);
			if(!empty($row)){
			$asignacion = $row->CAJAS; 	
			}

			$this->query="SELECT count(id) as cajas FROM CAJAS WHERE EXTRACT(MONTH FROM FECHA_creacioN) = $mes->NUMERO and EXTRACT(YEAR FROM FECHA_creacion) = $mes->ANHIO
				and status_recepcion = 2";
			$rs=$this->EjecutaQuerySimple();
			$row=ibase_fetch_object($rs);
			if(!empty($row)){
				$secuencia = $row->CAJAS; 
			}

			$this->query="SELECT count(id) as cajas FROM CAJAS WHERE EXTRACT(MONTH FROM FECHA_creacioN) = $mes->NUMERO and EXTRACT(YEAR FROM FECHA_creacion) = $mes->ANHIO
				and status_recepcion = 3
				 ";
			$rs=$this->EjecutaQuerySimple();
			$row=ibase_fetch_object($rs);
			if(!empty($row)){
				$administracion = $row->CAJAS; 
			}

			$this->query="SELECT count(id) as cajas FROM CAJAS WHERE EXTRACT(MONTH FROM FECHA_creacioN) = $mes->NUMERO and EXTRACT(YEAR FROM FECHA_creacion) = $mes->ANHIO
				and status_recepcion = 4
				";
			$rs=$this->EjecutaQuerySimple();
			$row=ibase_fetch_object($rs);
			if(!empty($row)){
				$bodega = $row->CAJAS; 
			}
			$this->query="SELECT count(id) as cajas FROM CAJAS WHERE EXTRACT(MONTH FROM FECHA_creacioN) = $mes->NUMERO  and EXTRACT(YEAR FROM FECHA_creacion) = $mes->ANHIO
				and status_recepcion = 5
				 ";
			$rs=$this->EjecutaQuerySimple();
			$row=ibase_fetch_object($rs);
			if(!empty($row)){
				$procesadas = $row->CAJAS; 
			}
			$faltantes = ($cajasxmes - $procesadas);
			if($cajasxmes > 0 or $asignacion > 0 or $administracion > 0 or $bodega > 0 or $procesadas > 0 or $faltantes > 0 ){
				$datos[] = array(	"mes"=>$mes->NUMERO,
					"anio"=>$mes->ANHIO,
					"nombre"=>$mes->NOMBRE,
					"cajas"=>$cajasxmes,
					"asignacion"=>$asignacion, 
					"secuencia"=>$secuencia, 
					"administracion"=>$administracion, 
					"bodega"=>$bodega,
					"procesada"=>$procesadas,
					"faltantes"=>$faltantes
				);	
			}
			
		}
		return $datos;
	}

	function seguimientoCajasDia($mes, $anio){	
		$this->query="SELECT cast(FECHA_CREACION as date) fecha, EXTRACT(DAY FROM min(FECHA_CREACION)) AS DIA,  count(id) as cajas, (SELECT max(NOMBRE) FROM PERIODOS_2016 where numero = $mes) as nombre FROM CAJAS WHERE extract(month from FECHA_creacion)= $mes and extract(year from fecha_creacion) = $anio GROUP BY cast(FECHA_CREACION as date)";
		$rs=$this->EjecutaQuerySimple();
		
		while ($tsArray=ibase_fetch_object($rs)) {
			$data[]=$tsArray;
		}
		$cajasxmes = 0;
		$asignacion= 0;
		$secuencia = 0;
		$administracion = 0;
		$bodega = 0;
		$procesadas= 0;
		$faltantes = 0;
		foreach ($data as $key) {
			$dia = $key->DIA;
			$nombre = $key->NOMBRE;
			$this->query="SELECT count(id) as cajas FROM CAJAS WHERE EXTRACT(MONTH FROM FECHA_creacioN) = $mes and EXTRACT(YEAR FROM FECHA_creacion) = $anio AND EXTRACT(DAY FROM FECHA_CREACION) = $key->DIA GROUP BY cast(FECHA_CREACION as date)";
			$rs=$this->EjecutaQuerySimple();
			$row=ibase_fetch_object($rs);	
			if(!empty($row)){
				$cajasxdia = $row->CAJAS; 	
			}
			
			$this->query="SELECT count(id) as cajas FROM CAJAS WHERE EXTRACT(MONTH FROM FECHA_creacioN) = $mes and EXTRACT(YEAR FROM FECHA_creacion) = $anio AND EXTRACT(DAY FROM FECHA_CREACION) = $key->DIA
				and (status_recepcion = 0 or status_recepcion is null)
				 GROUP BY cast(FECHA_CREACION as date)";
			$rs=$this->EjecutaQuerySimple();
			$row=ibase_fetch_object($rs);
			if(!empty($row)){
			$asignacion = $row->CAJAS; 	
			}

			$this->query="SELECT count(id) as cajas FROM CAJAS WHERE EXTRACT(MONTH FROM FECHA_creacioN) = $mes and EXTRACT(YEAR FROM FECHA_creacion) = $anio AND EXTRACT(DAY FROM FECHA_CREACION) = $key->DIA
				and status_recepcion = 2
				 GROUP BY cast(FECHA_CREACION as date)";
			$rs=$this->EjecutaQuerySimple();
			$row=ibase_fetch_object($rs);
			if(!empty($row)){
				$secuencia = $row->CAJAS; 
			}

			$this->query="SELECT count(id) as cajas FROM CAJAS WHERE EXTRACT(MONTH FROM FECHA_creacioN) = $mes and EXTRACT(YEAR FROM FECHA_creacion) = $anio AND EXTRACT(DAY FROM FECHA_CREACION) = $key->DIA
				and status_recepcion = 3
				 GROUP BY cast(FECHA_CREACION as date)";
			$rs=$this->EjecutaQuerySimple();
			$row=ibase_fetch_object($rs);
			if(!empty($row)){
				$administracion = $row->CAJAS; 
			}

			$this->query="SELECT count(id) as cajas FROM CAJAS WHERE EXTRACT(MONTH FROM FECHA_creacioN) = $mes and EXTRACT(YEAR FROM FECHA_creacion) = $anio AND EXTRACT(DAY FROM FECHA_CREACION) = $key->DIA
				and status_recepcion = 4
				 GROUP BY cast(FECHA_CREACION as date)";
			$rs=$this->EjecutaQuerySimple();
			$row=ibase_fetch_object($rs);
			if(!empty($row)){
				$bodega = $row->CAJAS; 
			}
			$this->query="SELECT count(id) as cajas FROM CAJAS WHERE EXTRACT(MONTH FROM FECHA_creacioN) = $mes and EXTRACT(YEAR FROM FECHA_creacion) = $anio AND EXTRACT(DAY FROM FECHA_CREACION) = $key->DIA
				and status_recepcion >= 5
				 GROUP BY cast(FECHA_CREACION as date)";
			$rs=$this->EjecutaQuerySimple();
			$row=ibase_fetch_object($rs);
			if(!empty($row)){
				$procesadas = $row->CAJAS; 
			}

			$datos[] = array(	"mes"=>$mes,
								"anio"=>$anio,
								"nombre"=>$nombre,
								"dia"=>$dia,
								"cajas"=>$cajasxdia,
								"asignacion"=>$asignacion, 
								"secuencia"=>$secuencia, 
								"administracion"=>$administracion, 
								"bodega"=>$bodega,
								"procesada"=>$procesadas,
								"faltantes"=>$faltantes
						);
		}
		return $datos;
	}

	function seguimientoCajasDetalle(){
		$this->query="SELECT cast(FECHA_CREACION as date), status_recepcion, count(id) FROM CAJAS WHERE FECHA_creacion >= '01.03.2018' GROUP BY cast(FECHA_CREACION as date), status_recepcion";
		$rs=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}
		return $data;
	}

	function seguimientoCajasDiaDetalle($mes, $anio, $dia){
		$this->query="SELECT c.*, cl.* , iif(factura != '', c.factura, c.remision) as documento,
						fp.saldofinal as saldofinal,
						(select sum((cantidad * precio) - ((cantidad * precio) * descuento / 100)) * 1.16 from detalle_caja dcj where dcj.idcaja = c.ID) as imppf,
						fp.nc_aplicadas as nc,
						cast((select list(coalesce(FACTURA_NUEVA,''),coalesce(R_F, '')) FROM REFACTURACION RF WHERE RF.caja = c.id) as varchar(100)) as refacturas ,
						DATEDIFF(day from c.fecha_creacion to current_date) as dias,
						(select count(id) from FTC_COMPROBANTES_RECIBO where idcaja = c.id) as archivos,
						iif(c.remision <> '', (select doc_sig from factr01 r where r.cve_doc = c.remision), '' ) as facturas,
						iif(observaciones <> '', observaciones, '') as factnc,
						iif(observaciones <> '', (select doc_sig from factf01 where cve_doc = observaciones),'') as factnc2,
						(select max(ca.FACTURAS) FROM CONTROL_FACT_REM ca WHERE  ca.CAJA = c.ID) AS historial,
						iif( (select f.saldofinal from factf01 f where f.cve_doc = substring(c.FACTURA FROM 1 FOR 10)) is null, 
							(select r.importe from factr01 r where r.cve_doc = c.remision),
							(select f.saldofinal from factf01 f where f.cve_doc = substring(c.FACTURA FROM 1 FOR 10))
							) AS SALDO_DOC
						FROM CAJAS c 
						left join factp01 p on p.cve_doc = c.cve_fact 
						left join clie01 cl on cl.clave= p.cve_clpv 
						left join facturas_fp fp on fp.cve_doc = c.factura
						WHERE EXTRACT(DAY FROM FECHA_CREACION) = $dia 
						and extract(month from fecha_creacion) = $mes 
						and extract(year from fecha_creacion )= $anio 
						order by factura";
						//echo $this->query;
		$rs=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}
		return $data;
	}


	function guardaComprobante($target_file, $cotizacion, $tipo){
		$usuario = $_SESSION['user']->NOMBRE;
		$this->query="UPDATE CAJAS set USUARIO_REV = '$usuario', fecha_rev = CURRENT_TIMESTAMP, historial_facturas = '$target_file', status_log = 'ConArchivo' where id = $cotizacion";
		$rs=$this->queryActualiza();

		if($tipo == 'ok'){
			$status = 0;
		}else{
			$status = 9;
		}
		$this->query="INSERT INTO FTC_COMPROBANTES_RECIBO (ID, IDCAJA, FACTURA, USUARIO, FECHA, ARCHIVO, Longitud, LATITUD, STATUS) 
								VALUES (NULL, 
										$cotizacion, 
										iif((select factura from cajas where id = $cotizacion) ='', (select remision from cajas where id = $cotizacion),(select factura from cajas where id = $cotizacion)),
										'$usuario',
										CURRENT_TIMESTAMP,
										substring('$target_file' from 36 for 250),
										0,
										0,
										$status)";
		$this->grabaBD();
		$this->query="INSERT INTO FTC_HISTORIA_CAJA VALUES(NULL,(SELECT STATUS_RECEPCION FROM CAJAS WHERE ID = $cotizacion), 6, CURRENT_TIMESTAMP, '$usuario', $cotizacion, (SELECT iif(factura = '', remision , factura) from cajas where id = $cotizacion))";
		$this->grabaBD();
		$this->query="UPDATE CAJAS SET STATUS_RECEPCION = 6, fecha_rev = iif(STATUS_RECEPCION = 6, fecha_rev, CURRENT_TIMESTAMP) where id = $cotizacion";
		$this->queryActualiza();
		return $rs;
	}



	function impPreFactCabecera($idc){
		$this->query="SELECT * FROM CABECERA_CAJA WHERE ID = $idc ";
		$rs = $this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($rs)) {
			$data[]=$tsArray;
		}
		return $data;
	}

	function impPreFactDetalle($idc, $cajas){
		$val=$idc;
		if(gettype($cajas == 'array') and !empty($cajas)){
			$idca = explode(",",substr($cajas,1,1000));
			$val=$cajas = substr($cajas,1,1000);
		}
		//var_dump($idca);
		$this->query="SELECT * FROM DETALLE_CAJA WHERE IDCAJA in ($val)";
		$rs=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($rs)) {
			$data[]=$tsArray;
		}

		return $data;
	}

	function verComprobantesRecibo($idc){
		$this->query="SELECT * FROM FTC_COMPROBANTES_RECIBO WHERE IDCAJA = $idc";
		$rs=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($rs)) {
			$data[]=$tsArray;
		}
		return $data;
	}

function creaFactura($idc, $uso, $tpago, $mpago, $cp){
		$usuario = $_SESSION['user']->NOMBRE;
		$dec=6;
		$dect=2;
		$mysql = new pegaso_rep;
		$this->query="SELECT * FROM CAJAS WHERE ID = $idc";
		$res = $this->EjecutaQuerySimple();
		$valRefacturacion=ibase_fetch_object($res);
		$validacion = $valRefacturacion->PAR_FACTURADAS; 
		$statusOriginal=$valRefacturacion->STATUS;
		if($validacion ==  0 and $valRefacturacion->STATUS !='CFDI' and $valRefacturacion->STATUS != 'PENDIENTE'){
			$this->query="UPDATE CAJAS SET STATUS = 'PENDIENTE' WHERE ID = $idc";
			$this->queryActualiza();
			if($idc < 9999999){
			$this->query ="SELECT P.*,
						(SELECT DBIMPPRE FROM FTC_COTIZACION_DETALLE
		                WHERE cdfolio = (SELECT cdfolio FROM FTC_COTIZACION WHERE SERIE||FOLIO = DOCUMENTO)
		                AND ('PGS'||CVE_ART) = ARTICULO
		                ) AS PRECIO,
		                (SELECT DBIMPDES FROM FTC_COTIZACION_DETALLE
		                WHERE cdfolio = (SELECT cdfolio FROM FTC_COTIZACION WHERE SERIE||FOLIO= DOCUMENTO)
		                AND ('PGS'||CVE_ART) = ARTICULO
		                ) AS DESCUENTO,
		                (SELECT CVE_CLIENTE FROM FTC_COTIZACION WHERE SERIE||FOLIO = DOCUMENTO) AS CLIENTE 
		                FROM PAQUETES P WHERE IDCAJA = $idc";
		}else{
				$this->query="SELECT trim(f.CVE_CLPV) AS CLIENTE, 
							p.cant as cantidad, 
							p.prec as precio, 
							p.desc1 as descuento, 
							(select nombre from producto_ftc where clave = p.cve_art )as descripcion,
							p.cve_art as articulo, 
							p.id_Preoc, 
							99 as idcaja, 
							9 as id
							FROM PAR_FACTV01 p 
							left join factv01 f on f.cve_doc = p.cve_doc 
							WHERE f.CVE_DOC = '$cp'";
		}
				$rs=$this->EjecutaQuerySimple();
				while ($tsArray = ibase_fetch_object($rs)){
					$data[]=$tsArray;
				}
				$SubTotal= 0;
				$IVA = 0;
				$IEPS = 0;
				$desc1=0;
				$desc2=0;
				$descf=0;
				$ST = 0;
				
				foreach ($data as $key) {  /// Calcula los totales pata pegarlos en la cabecera
					$precio = number_format($key->PRECIO,$dec,".","");
					$precio = explode('.', $precio);
					$decimales = substr($precio[1],0,$dect);
					$precio = $precio[0].'.'.$decimales;
					$cliente = $key->CLIENTE;
					$caja = $key->IDCAJA;
					$SubTotal += (($key->CANTIDAD-$key->DEVUELTO) * $precio);
					$ST  +=( ($key->CANTIDAD-$key->DEVUELTO) * round($key->PRECIO,$dect));
					if($key->DESCUENTO > 0){
						$desc1 += (($key->CANTIDAD-$key->DEVUELTO) * $precio * ($key->DESCUENTO/100));			
					}else{
						$desc1 +=0;
					}
				}
				//$IVA = number_format(($SubTotal -$desc1) *.16,$dec,".","");
				$IVA =$this->truncarNumero( ($SubTotal-$desc1)*.16, $dect); 
				//$total = number_format(($SubTotal-$desc1) * 1.16,$dec,".","");
				$total = $this->truncarNumero( ($Subtotal-$desc1)*1.16, $dect);

				$this->query="SELECT * FROM CAJAS WHERE ID = $idc";
				$res =$this->EjecutaQuerySimple();
				$row = ibase_fetch_object($res);
				$cotizacion = $row->CVE_FACT;
				//exit($this->query);//// Obtenemos los datos de la caja....
				$this->query="SELECT iif(MAX(FOLIO) is null, 0, max(folio)) AS FOLIO FROM FTC_CTRL_FACTURAS WHERE SERIE = 'FP'";
				$res=$this->EjecutaQuerySimple();
				$folio = ibase_fetch_object($res);
				$nf = $folio->FOLIO + 1;
				$this->query="UPDATE FTC_CTRL_FACTURAS SET FOLIO = $nf where SERIE  ='FP'";
				$rs = $this->queryActualiza();
				if($rs ==1 ){
					$this->query="SELECT * FROM CLIE01 WHERE TRIM(CLAVE)='$cliente'";
					$res=$this->EjecutaQuerySimple();
					$cl=ibase_fetch_object($res);
					$this->query="INSERT INTO FTC_FACTURAS (IDF, DOCUMENTO, SERIE, FOLIO, FORMADEPAGOSAT, VERSION, TIPO_CAMBIO, METODO_PAGO, REGIMEN_FISCAL, LUGAR_EXPEDICION, MONEDA, TIPO_COMPROBANTE, CONDICIONES_PAGO, SUBTOTAL, IVA, IEPS, DESC1, DESC2, DESCF, TOTAL, SALDO_FINAL, ID_PAGOS, ID_APLICACIONES, NOTAS_CREDITO, MONTO_NC, MONTO_PAGOS, MONTO_APLICACIONES, CLIENTE, USO_CFDI, STATUS, USUARIO, FECHA_DOC, FECHAELAB, IDCAJA) 
					VALUES (NULL, ('FP'||$nf), 'FP', $nf, '$tpago', '3.3', 1, '$mpago', '601', '05440', 'MXN', 'I', '$cp', $SubTotal, $IVA, $IEPS, $desc1, $desc2, $descf, $total, $total, '','', '', 0,0,0,'$cliente', '$uso', 0, '$usuario ', current_timestamp, current_timestamp, $caja)";
					$this->grabaBD();
					//exit($this->query);//// Insertamos la cabecera de la factura.	
					$datos = array($cliente,$row->UNIDAD, $cl->NOMBRE,$cl->CALLE.', '.$cl->NUMEXT,$cl->COLONIA, $cl->ESTADO,$cl->TELEFONO, $cl->EMAILPRED,$cl->REFERENCIA_ENVIO, $caja,$total,'FP'.$nf);  
					$idviaje = $mysql->ingresaLogReparto($datos); /// Creamos el registro en la BD MySQL para el Rastreador.
					$partida = 0;
					$conceptos=array();
					$subTotalDoc=0;
					$stimpuestosat=0;
					$stimportesat=0;
					$totalDescp=0;
					$totalImpdesc=0;
					foreach ($data as $keyp ) {
						$partida += 1;
						$preciop = number_format($keyp->PRECIO,$dec,".","");
						$preciop = explode('.', $preciop);
						$decimales = substr($preciop[1],0,$dect);
						$preciop = $preciop[0].'.'.$decimales;
						
						$descp = number_format( (($keyp->CANTIDAD-$key->DEVUELTO) * $keyp->PRECIO * ($keyp->DESCUENTO/100)),$dec,".","");
						$descp=explode(".", $descp);
						$descpd=substr($descp[1],0,$dect);
						$descp = $descp[0].'.'.$descpd;
					
						$SubTotal = number_format( ($keyp->CANTIDAD-$keyp->DEVUELTO) * $preciop,$dec,'.','');
						$SubTotal = $this->truncarNumero($SubTotal,$dect);
						$subTotalDoc+=$SubTotal;
						$total = $this->truncarNumero($numero=$SubTotal * 1.16,$dect);
						$this->query="INSERT INTO FTC_FACTURAS_DETALLE (IDFP, IDF, DOCUMENTO, PARTIDA, CANTIDAD, ARTICULO, UM, DESCRIPCION, IMP1, IMP2, IMP3, IMP4, DESC1, DESC2, DESC3, DESCF, SUBTOTAL, TOTAL, CLAVE_SAT, MEDIDA_SAT, PEDIMENTOSAT, LOTE, USUARIO, FECHA, IDPREOC, IDPAQUETE, IDCAJA, PRECIO )
						VALUES(NULL, (SELECT IDF FROM FTC_FACTURAS WHERE DOCUMENTO = ('FP'||$nf)), 
									 ('FP'||$nf), 
									 $partida, ($keyp->CANTIDAD-$keyp->DEVUELTO), '$keyp->ARTICULO', (SELECT UM FROM PREOC01 WHERE ID = $keyp->ID_PREOC), '$keyp->DESCRIPCION', 16, 0, 0, 0, $descp, 0,0,0, $SubTotal, $total, (SELECT CVE_PRODSERV FROM INVE01 WHERE CVE_ART = '$keyp->ARTICULO'), (SELECT CVE_UNIDAD FROM INVE01 WHERE CVE_ART = '$keyp->ARTICULO'), '', '', '$usuario', current_timestamp, $keyp->ID_PREOC, $keyp->ID, $keyp->IDCAJA, $preciop)";	
						$this->grabaBD();
						
						$this->query="SELECT * FROM INVE01 WHERE CVE_ART='$keyp->ARTICULO'";
						$resultado=$this->EjecutaQuerySimple();
						$infoprod=ibase_fetch_object($resultado);
						$datosp = array($idviaje,'FP'.$nf, $partida, ($keyp->CANTIDAD - $keyp->DEVUELTO), $keyp->DESCRIPCION, $keyp->PRECIO, $SubTotal);
						
						// formato del numero;
						$impimp=$this->truncarNumero($numero=$SubTotal*0.16,$dect);
						$base = $this->truncarNumero($SubTotal,$dect);
						$descpimpf =$this->truncarNumero($numero = $descp*.16, $dect);
						$impimpdesc =$this->truncarNumero($numero=$impimp-$descpimpf, $dect);
						$base2 = $this->truncarNumero($numero =number_format($base-$descp,$dec,".",""), $dect);
						//$descpimp = number_format($descp*.16,$dec,".","");// 34
						//	$descpimpf = explode(".",$descpimp);
						//	$descpimpfde=substr($descpimpf[1],0,$dec);
						//	$descpimpfde=(strlen($descpimpfde) == 1)? substr($descpimpfde[1],0,$dec).'0':$descpimpfde;
						//	$descpimpfde=(strlen($descpimpfde) <=0)? '00':$descpimpfde;
						//	$descpimpf =$descpimpf[0].'.'.$descpimpfde; 

						//$impimpdesc = number_format($impimp-($descpimpf),$dec,".","");
						//	@$basedec = substr($base[1],0,$dec);
						//	$base = $base[0].'.'.$basedec; 
						//	$base=(strlen($base) == 1)? substr($base[1],0,$dec).'0':$base;
						//	$base=(strlen($base) <= 0)? '00':$base;

						//$base2 = number_format($base-$descp,$dec,".","");						
							//// Manejo de descuentos.
							$desc1=$this->truncarNumero($desc1,$dect);
							
							$descp=$this->truncarNumero($descp,$dect);
							$totalDescp = $totalDescp + $descp;
							$totalDescp = $this->truncarNumero($totalDescp,$dect);
							$impimpdesc = $this->truncarNumero($numero=($base2 * .16),$dect);
							$totalImpdesc=$this->truncarNumero($numero=$totalImpdesc + $impimpdesc,$dect);
						//echo 'Descuento Partida'.$descp.', Iva del descuento: '.$descpimpf.', Base del impuesto: '.$base2.' Impuesto sin descuento:'.$impimp.'<br/>';
						$impConcepto=array(
											"Base"=>"$base2",
								            "Impuesto"=>"002",
								            "TipoFactor"=>"Tasa",
								            "TasaOCuota"=>"0.160000",
								            "Importe"=>"$impimpdesc"
											);
						$trasConceptos[]=$impConcepto;
						$trasConcepto=array("Traslados"=>$trasConceptos);
						unset($trasConceptos);
						if(($keyp->CANTIDAD-$key->DEVUELTO)>0){
							if($descp>0){
										$concepto = array(
											  "ClaveProdServ"=> trim("$infoprod->CVE_PRODSERV"),
										      "ClaveUnidad"=> "$infoprod->CVE_UNIDAD",
										      "noIdentificacion"=> "$keyp->ARTICULO",
										      "unidad"=> "$infoprod->UNI_MED",
										      "Cantidad"=>"$keyp->CANTIDAD",
										      "descripcion"=> "$keyp->DESCRIPCION",
										      "ValorUnitario"=> "$preciop",
										      "Importe"=> "$base",
										      "Descuento"=>"$descp",
										      "Impuestos"=>$trasConcepto
												);
							}else{
										$concepto = array(
											  "ClaveProdServ"=> trim("$infoprod->CVE_PRODSERV"),
										      "ClaveUnidad"=> "$infoprod->CVE_UNIDAD",
										      "noIdentificacion"=> "$keyp->ARTICULO",
										      "unidad"=> "$infoprod->UNI_MED",
										      "Cantidad"=>"$keyp->CANTIDAD",
										      "descripcion"=> "$keyp->DESCRIPCION",
										      "ValorUnitario"=> "$preciop",
										      "Importe"=> "$base",
										      "Impuestos"=>$trasConcepto
												);
							}
						}
						$stimpuestosat=$stimpuestosat + $impimp;
						$stimportesat=$stimportesat + $base;
						$conceptos[]=$concepto;
						$partidas = $mysql->ingresaLogRepartoDetalle($datosp);/// ingresamos las partidas al rastreador.
					}
					$nodoDescT='';

					$IVA = round($IVA,2);
					$subTotalDoc = number_format($subTotalDoc,2,'.','');
					$ST= number_format($ST,2,'.','');
					$impuesto1 = array(	"Impuesto"=> "002",
									    "TipoFactor"=> "Tasa",
									    "TasaOCuota"=>"0.160000",
									    //"Importe"=> "$IVA"
										"Importe"=>"$totalImpdesc"
										);
					
					$Traslados=array($impuesto1);
					$imptrs="TotalImpuestosTrasladados:".$stimpuestosat;//.$IVA; 
					$imp = array(
							     "TotalImpuestosTrasladados"=>"$totalImpdesc",//"$IVA",
							 	 "Traslados"=>$Traslados);
					$impuestos = array("Impuestos"=>$imp,);
					
					if($totalDescp >0){
						$datos_factura = array( 
											"FormaPago"=>"$mpago",
											"Version"=>"3.3",
											"Folio"=>"$nf",
											"Serie"=>"FP",
											"TipoCambio"=>"1.0",
											"MetodoPago"=> "$tpago",
		    								"RegimenFiscal"=> "601",
										    "LugarExpedicion"=> "54080",
										    "Moneda"=> "MXN",
										    "TipoDeComprobante"=> "I",
										    "condicionesDePago"=> "$mpago",
										    "SubTotal"=>"$stimportesat",//"$ST",
										    "Descuento"=>"$totalDescp",
										    $nodoDescT,
										    "Impuestos"=>$imp
										);
					}else{
						$datos_factura = array( 
											"FormaPago"=>"$mpago",
											"Version"=>"3.3",
											"Folio"=>"$nf",
											"Serie"=>"FP",
											"TipoCambio"=>"1.0",
											"MetodoPago"=> "$tpago",
		    								"RegimenFiscal"=> "601",
										    "LugarExpedicion"=> "54080",
										    "Moneda"=> "MXN",
										    "TipoDeComprobante"=> "I",
										    "condicionesDePago"=> "$mpago",
										    "SubTotal"=>"$stimportesat",//"$ST",
										    "Impuestos"=>$imp
										);					
					}
					$nombre=utf8_encode($cl->NOMBRE);
					$json_cliente=array(
										"id"=>"$cl->CLAVE",
										"UsoCFDI"=>"$uso",
										"nombre"=>"$nombre",
										"rfc"=>"$cl->RFC",
										"correo"=>"ofarias@ftcenlinea.com"
										);
					$df =array( "conceptos"=>$conceptos,
								"datos_factura"=>$datos_factura,
								"method"=>'nueva_factura', 
								"cliente"=>$json_cliente
								);
					//var_dump($df).'<br/>';
					$factura = json_encode($df,JSON_UNESCAPED_UNICODE);
					$fh = fopen("C:\\xampp\\htdocs\\Facturas\\EntradaJson\\".'FP-'.$nf.".json", 'w');
					fwrite($fh, $factura);
					fclose($fh);
					$espera= 3;
					sleep(3);
					$fecha = date('d-m-Y');
					while ( $espera <= 15){	
						if(file_exists("C:\\xampp\\htdocs\\Facturas\\originales\\".'FP-'.$nf.".json")){
							$factura = 'ok';
							sleep(2);
							copy("C:\\xampp\\htdocs\\Facturas\\FacturasJson\\".str_replace(" ","",trim($cl->RFC))."(FP".$nf.")".$fecha.".xml", "C:\\xampp\\htdocs\\Facturas\\facturaPegaso\\FP".$nf.".xml");
							$espera = 15;
						}elseif(file_exists("C:\\xampp\\htdocs\\Facturas\\ErroresJson\\".'FP-'.$nf.".json")){
							$factura = 'error';
							$mensaje = 'Error la factura no se timbro';
							$espera = 15; 
						}
						sleep(2);
						$espera = $espera+3;
					}

					if($factura){
						//// Codigo para cerrar la caja se actualiza lo facturado en la tabla de control facturas.
						$this->query="SELECT * FROM FTC_FACTURAS_DETALLE WHERE DOCUMENTO = 'FP'||$nf and (status= 0 or status is null)"; 
						$result=$this->EjecutaQuerySimple();
						while ($tsArray3=ibase_fetch_object($result)){
							$partidas[]=$tsArray3;
						}
						$i = 0;
						foreach ($partidas as $key) {
							$documento = $key->DOCUMENTO;
							$idcaja = $key->IDCAJA;
							$i++;
							$this->query="SELECT * FROM control_fact_rem where 
									caja = $idcaja 
									and idpreoc = $key->IDPREOC 
									and (status = 'Nuevo' or status= 'remisionado')";
							$result=$this->EjecutaQuerySimple();
							$tipoControl=ibase_fetch_object($result);
							$res = false;
							if($tipoControl->STATUS == 'remisionado'){
								$this->query="UPDATE control_fact_rem set fact_rem = fact_rem - $key->CANTIDAD, FACTURAS = '$key->DOCUMENTO', STATUS = 'facturado', usuario_factura='$usuario', fecha_factura= current_timestamp
											WHERE caja = $idcaja and idpreoc = $key->IDPREOC and status= 'remisionado'";
								@$res=$this->queryActualiza();
							
							}elseif ($tipoControl->STATUS == 'Nuevo'){
								$this->query="UPDATE control_fact_rem set pxf = pxf - $key->CANTIDAD , USUARIO_FACTURA = '$usuario', FECHA_FACT_REM = current_timestamp, FECHA_FACTURA= CURRENT_TIMESTAMP,
											FACTURAS = '$key->DOCUMENTO', STATUS = 'facturado'
											WHERE caja = $idcaja and idpreoc = $key->IDPREOC and status = 'Nuevo'";
								@$res=$this->queryActualiza();
							}

							if($res==1){
								$this->query="UPDATE PREOC01 SET FACTURADO = FACTURADO + $key->CANTIDAD, 
																 FACTURA = iif(factura is null,  'FP'||$nf, factura||','||'FP'||$nf),
																 PENDIENTE_FACTURAR = PENDIENTE_FACTURAR - $key->CANTIDAD 
																 where id = $key->IDPREOC";
								$this->EjecutaQuerySimple();
								$this->query="UPDATE CAJAS SET PAR_FACTURADAS = $i WHERE ID = $key->IDCAJA";
								$this->EjecutaQuerySimple();
								$this->query="UPDATE FTC_FACTURAS_DETALLE SET STATUS = 1 WHERE IDFP= $key->IDFP";
								$this->queryActualiza();
							}
						}		
						$this->query="SELECT COUNT(IDFP) AS PARTIDAS FROM FTC_FACTURAS_DETALLE WHERE DOCUMENTO='$documento' and status = 1";
						$resultado= $this->EjecutaQuerySimple();
						$valfact=ibase_fetch_object($resultado);
						$partidasFacturadas = $valfact->PARTIDAS;
						//exit('Partidas afectadas '.$partidasFacturadas.' validacion:'.$i);
							if($partidasFacturadas == $i){
								$this->query="UPDATE FTC_FACTURAS SET STATUS = 1 WHERE DOCUMENTO='$documento'";
								$this->EjecutaQuerySimple();

								if($statusOriginal == 'cerrado'){
									$this->query="UPDATE CAJAS SET FACTURA='$documento' where id=$idcaja";
									$this->EjecutaQuerySimple();
								}else{
									$this->query="UPDATE CAJAS SET STATUS='cerrado', ruta='N', FACTURA='$documento', Docs='No', status_recepcion = 0 where id=$idcaja";
									$this->EjecutaQuerySimple();
								}

								if($factura == 'ok'){
									$mensaje = array("status"=>'ok', "factura"=>'FP'.$nf,"razon"=>'Se ha cerrado la caja', "rfc"=>$cl->RFC, "fecha"=>$fecha);	
								}elseif($factura == 'error'){
									$mensaje = array("status"=>'No', "factura"=>'FP'.$nf,"razon"=>'Se ha cerrado la caja', "rfc"=>$cl->RFC, "fecha"=>$fecha);
								}
							}else{
								$this->query="UPDATE CAJAS SET STATUS = 'revisar' where id=$idcaja";
								$this->EjecutaQuerySimple();
								$this->query="UPDATE FTC_FACTURAS SET STATUS = 8 WHERE DOCUMENTO='$documento'";
								$this->EjecutaQuerySimple();
								//$avisoCorreo = $this->avisoCorreo($docuemnto);
									//if($avisoCorreo == 'ok'){
										$this->query="UPDATE FTC_FACTURAS SET STATUS = 9 WHERE DOCUMENTO = '$documento'";
										$this->EjecutaQuerySimple();
									//}
								$mensaje = array("status"=>'No', "razon"=>'No se actualizaron todas las partidas, se envio correo con la informacion.');
							}
					}else{
						//Echo "No Existe y no se creo la facura";
						$this->query="UPDATE CAJAS SET status='CFDI' where id = $idc";
						$this->queryActualiza();
						$mensaje = array("status"=>'No', "razon"=>'No se timbro la factura');
					}
				}else{
					$mensaje = array("status"=>'No', "razon"=>'No se creo el folio');
				}
		}else{
			if($valRefacturacion->STATUS == 'CFDI'){
				$mensaje = array("status"=>'No', "razon"=>'La Factura se encuentra el proceso de timbrado, favor de esperar');
			}elseif($valRefacturacion->STATUS == 'PENDIENTE'){
				$mensaje = array("status"=>'No', "razon"=>'La caja esta en proceso de facturacion');	
			}else{
				$mensaje = array("status"=>'No', "razon"=>'Ya se facturo la Caja');	
			}
		}
		$this->query="update cajas set status= 'abierto', PAR_FACTURADAS= 0  where id = 41489";
		$this->EjecutaQuerySimple();
		return $mensaje;//$mensaje = array("status"=>'ok',"factura"=>'FP'.$nf);
	}

	function truncarNumero($numero, $dect){
		$numero = number_format($numero,2,".","");
		//split(pattern, string)
		$numero = explode(".", $numero);
		$decimal = substr($numero[1],0,$dect);
		return $numero[0].".".$decimal; 
	}

	function infoFiscal($factura){		
		$data=array();
		$this->query="SELECT cast(NoCertificadoSAT AS VARCHAR(1000)) AS NoCertificadoSAT,
							CAST(SELLOCFD AS VARCHAR(1000)) AS SELLOCFD,
							CAST(SELLOSAT AS VARCHAR(1000)) AS SELLOSAT,
							CAST(CERTIFICADO AS VARCHAR(4000)) AS CERTIFICADO,
							CAST(SELLO AS VARCHAR(1000)) AS SELLO,
							VERSIONSAT, 
							UUID,
							FECHATIMBRADO,
							RFCPROV,
							No_cert_contr, 
							FORMAPAGO, 
							LUGAREXPEDICION,
							METODOPAGO,
							MONEDA, 
							TIPOCAMBIO,
							coalesce(
							 	(SELECT USO_CFDI FROM FTC_FACTURAS WHERE (DOCUMENTO) = '$factura'),
							 	(SELECT USO_CFDI FROM FTC_NC WHERE (DOCUMENTO) = '$factura')
							 	) AS USO_CFDI,
							IMPORTE
							FROM XML_DATA WHERE (SERIE||FOLIO) = '$factura'";
		$res=$this->EjecutaQuerySimple();
		while ($tsArray = ibase_fetch_object($res)) {
			$data[]=$tsArray;
		}
		return $data;
	}
	
	function traeCancelaciones($factura){
		$data=array();
		$this->query="SELECT * FROM FTC_CANCELACIONES WHERE FACTURA_NUEVA = '$factura' and aplicado = 1";
		$res=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($res)) {
			$data[]=$tsArray;
		}
		return $data;
	}

	function detalleFacturaPegaso($factura){
		$data=array();
		if(substr($factura, 0,3) =='NCR' or substr($factura, 0,3) =='NCS' or substr($factura, 0,3) =='NCD' or substr($factura, 0,3) =='NCB'){
			$this->query="SELECT nc.*, (select descripcion from claves_sat cs where cs.cve_prod_serv = nc.clave_sat) as descCve, 
				(select descripcion from unidades_sat us where  us.clave = nc.medida_sat) as descUni 
				 FROM FTC_NC_DETALLE nc WHERE DOCUMENTO = '$factura'";
			$res=$this->EjecutaQuerySimple();
		}elseif(substr($factura,0,3)=='NCI'){
			$this->query="SELECT nc.*, (select descripcion from claves_sat cs where cs.cve_prod_serv = nc.clave_sat) as descCve, 
				(select descripcion from unidades_sat us where  us.clave = nc.medida_sat) as descUni 
				 FROM FTC_NCI_DETALLE nc WHERE DOCUMENTO = '$factura'";
			$res=$this->EjecutaQuerySimple();
		}else{
			$this->query="SELECT fd.*, 
				(select descripcion from claves_sat cs where cs.cve_prod_serv = fd.clave_sat) as descCve, 
				(select descripcion from unidades_sat us where  us.clave = fd.medida_sat) as descUni 
				FROM FTC_FACTURAS_DETALLE fd WHERE DOCUMENTO = '$factura'";
			$res=$this->EjecutaQuerySimple();	
		}
		while ($tsArray=ibase_fetch_object($res)) {
			$data[]=$tsArray;
		}
		return $data;
	}


	function ocAyer(){
		$usuario = $_SESSION['user']->NOMBRE;
		$hoy=date("d.m.Y"); $ayer=strtotime('-1 day',strtotime($hoy)); $ayer = date('d.m.Y', $ayer);
		$data = array();
		$data1 = array();
		$data2 = array();
		$data3 = array();
		$data4 = array();
		$data5 = array();
		$data6 = array();
		$this->query="SELECT * FROM FTC_POC WHERE CAST(FECHA_OC AS DATE) = '$ayer'";
		$rs=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($rs)) {
			$data[]=$tsArray;
		}
		$this->query = "SELECT * FROM FTC_POC WHERE CAST(FECHA_OC AS DATE) = '$ayer' and tp_tes is null";
		$res = $this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($res)) {
			$data1[]=$tsArray;
		}
		
		$this->query = "SELECT * FROM FTC_POC WHERE CAST(FECHA_OC AS DATE) = '$ayer' and tp_tes is not null and (status='PAGADA' OR STATUS CONTAINING ('LOGISTICA')) ";
		$res = $this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($res)) {
			$data2[]=$tsArray;
		}

		$this->query="SELECT * FROM FTC_POC WHERE CAST(FECHA_OC AS DATE )= '$ayer' and STATUS='RECEPCIONADA'";
		$res = $this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($res)) {
			$data3[] =$tsArray; 
		}

		$this->query="SELECT * FROM FTC_POC WHERE CAST(FECHA_OC AS DATE )= '$ayer' and STATUS='CANCELADA_TOT'";
		$res = $this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($res)) {
			$data4[] =$tsArray; 
		}

		$this->query="SELECT * FROM FTC_POC WHERE CAST(FECHA_OC AS DATE )= '$ayer' and STATUS='CANCELADA_PAR'";
		$res = $this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($res)) {
			$data5[] =$tsArray; 
		}
		$this->query="SELECT * FROM FTC_POC WHERE CAST(FECHA_OC AS DATE )= '$ayer' and (STATUS='REENRUTADA' OR STATUS = 'TESORERIA')";
		$res = $this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($res)) {
			$data6[] =$tsArray; 
		}

		$oc  = count($data);
		$ocsp = count($data1);
		$ocruta = count($data2);
		$ocrec = count($data3);
		$occant = count($data4);
		$occanp = count($data5);
		$ocreen = count($data6);

		return $info=array("oc"=>$oc, "pago"=>$ocsp,"ruta"=>$ocruta, "recolectadas"=>$ocrec, "cTotal"=>$occant, "cPar"=>$occanp, "reen"=>$ocreen);
	}

	function ocHoy(){
		$usuario = $_SESSION['user']->NOMBRE;
		$hoy=date("d.m.Y"); $ayer=strtotime('-1 day',strtotime($hoy)); $ayer = date('d.m.Y', $ayer);
		$data = array();
		$data1 = array();
		$data2 = array();
		$data3 = array();
		$data4 = array();
		$data5 = array();
		$data6 = array();

		$this->query="SELECT * FROM FTC_POC WHERE CAST(FECHA_OC AS DATE) = '$hoy'";
		$rs=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($rs)) {
			$data[]=$tsArray;
		}

		$this->query = "SELECT * FROM FTC_POC WHERE CAST(FECHA_OC AS DATE) = '$hoy' and tp_tes is null";
		$res = $this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($res)) {
			$data1[]=$tsArray;
		}
		
		$this->query = "SELECT * FROM FTC_POC WHERE CAST(FECHA_OC AS DATE) = '$hoy' and tp_tes is not null and (status='PAGADA' OR STATUS CONTAINING ('LOGISTICA')) ";
		$res = $this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($res)) {
			$data2[]=$tsArray;
		}

		$this->query="SELECT * FROM FTC_POC WHERE CAST(FECHA_OC AS DATE )= '$hoy' and STATUS='RECEPCIONADA'";
		$res = $this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($res)) {
			$data3[] =$tsArray; 
		}

		$this->query="SELECT * FROM FTC_POC WHERE CAST(FECHA_OC AS DATE )= '$hoy' and STATUS='CANCELADA_TOT'";
		$res = $this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($res)) {
			$data4[] =$tsArray; 
		}

		$this->query="SELECT * FROM FTC_POC WHERE CAST(FECHA_OC AS DATE )= '$hoy' and STATUS='CANCELADA_PAR'";
		$res = $this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($res)) {
			$data5[] =$tsArray; 
		}
		$this->query="SELECT * FROM FTC_POC WHERE CAST(FECHA_OC AS DATE )= '$hoy' and (STATUS='REENRUTADA' OR STATUS = 'TESORERIA')";
		$res = $this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($res)) {
			$data6[] =$tsArray; 
		}

		$oc  = count($data);
		$ocsp = count($data1);
		$ocruta = count($data2);
		$ocrec = count($data3);
		$occant = count($data4);
		$occanp = count($data5);
		$ocreen = count($data6);

		return $info=array("oc"=>$oc, "pago"=>$ocsp,"ruta"=>$ocruta, "recolectadas"=>$ocrec, "cTotal"=>$occant, "cPar"=>$occanp, "reen"=>$ocreen);
	}


	function verRechazados(){
		$data=array();
		$usuario=$_SESSION['user']->NOMBRE;
		if($usuario == 'Gerente Logistica'){
			$this->query="SELECT * FROM CABECERA_POC WHERE STATUS='Retorno a Suministros'";
			$rs=$this->EjecutaQuerySimple();
		}else{
			$this->query="SELECT * FROM CABECERA_POC WHERE STATUS='Retorno a Suministros' and usuario = '$usuario' ";
			$rs=$this->EjecutaQuerySimple();
		}
		while ($tsArray=ibase_fetch_object($rs)) {
			$data[]=$tsArray;
		}
		return $data;
	}

	function verOC($tipo, $fecha){
		if($tipo == 1){
			$tipo = '';
		}elseif ($tipo == 2) {
			$tipo = 'and TP_TES IS NULL';
		}elseif ($tipo == 3) {
			$tipo = "and tp_tes is not null and (status='PAGADA' OR STATUS CONTAINING ('LOGISTICA'))";
		}elseif ($tipo == 4) {
			$tipo = "and STATUS='RECEPCIONADA'";
		}elseif ($tipo == 5) {
			$tipo = "and STATUS='CANCELADA_TOT'";
		}elseif ($tipo == 6){
			$tipo = "and STATUS='CANCELADA_PAR'";
		}elseif ($tipo == 7) {
			$tipo = "and (STATUS='REENRUTADA' OR STATUS = 'TESORERIA')";
		}

		$this->query="SELECT F.*, (SELECT NOMBRE FROM PROV01 WHERE CLAVE = CVE_PROV) AS NOMBRE FROM FTC_POC F WHERE CAST(FECHA_OC AS DATE )= '$fecha' $tipo";
		$rs=$this->EjecutaQuerySimple();

		while ($tsArray=ibase_fetch_object($rs)) {
			$data[]=$tsArray;
		}
		return $data;
	}

	function verOCmes(){
		$info = array();$data=array();$data2=array();
		$this->query="SELECT count(ID) as oc, cast(fecha_oc as date) as fecha FROM FTC_POC WHERE CAST(FECHA_OC AS DATE ) >= DATEADD(DAY, -31, CURRENT_DATE) group by cast(fecha_oc as date)";
		$rs=$this->EjecutaQuerySimple();
		while($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}
		foreach ($data as $key) {
			$fecha = $key->FECHA;
			$oc =$key->OC;
			$this->query="SELECT count(id) as oc, status, cast(fecha_oc as date ) as fecha FROM FTC_POC WHERE CAST(FECHA_OC AS DATE )= '$fecha' group by status, cast(fecha_oc as date)";
			$res = $this->EjecutaQuerySimple();
			while ($tsArray2=ibase_fetch_object($res)) {
				$data2[]=$tsArray2;
			}
		}
		if(!empty($data) or !empty($data2)){
		$info=array($data,$data2);
				foreach ($info[1] as $key2) {
					$status = $key2->STATUS;
					$fecha = $key2->FECHA;
					$oc = $key2->OC;
					//echo 'Fecha: '.$fecha.' Status: '.$status.' OC: '.$oc.'<br>';
				}
		}
		return $info;
	}

	function cajasSinProcesar(){
		$data = array();
		$usuario = $_SESSION['user']->NOMBRE;
		$tipoUsuario = $_SESSION['user']->LETRA;
		if($tipoUsuario == 'G'){
			$data1 = array();
			$data2 = array();
			$this->query="SELECT * FROM STATUS_CAJA WHERE (STATUS_RECEPCION = 5 or STATUS_RECEPCION = 6) and datediff(day, fecha, current_date) >= 3";
			$rs=$this->EjecutaQuerySimple();
			while($tsArray=ibase_fetch_object($rs)){
				$data1[]=$tsArray;
			}
			$this->query="SELECT * FROM FACTURAS_PENDIENTES where vencimiento >=9 and vencimiento <= 29";
			$rs=$this->EjecutaQuerySimple();
			while($tsArray = ibase_fetch_object($rs)){
				$data2[]=$tsArray;
			}
			if(count($data1) > 0 or count($data2)>0){
				$this->bloqueos($usuario, $tipoUsuario);
				return $data = array($data1, $data2);
			}
		}elseif(substr($tipoUsuario,0,1) =='R'){
			// Revisamos si tiene documentos con status_recepcion de mas de 8 dias;
			$this->query="SELECT * FROM STATUS_CAJA WHERE (STATUS_RECEPCION = 5 or STATUS_RECEPCION = 6) and datediff(day, fecha, current_date) >= 3";
			$rs=$this->EjecutaQuerySimple();
			while($tsArray = ibase_fetch_object($rs)){
				$data[]=$tsArray;
			}
		}elseif(substr($tipoUsuario,0,1)=='C'){
			/// Revisamos si tiene documentos entre los 9 y 28 duas de vencidos;
			$grupo = " and c_cobranza = '".$tipoUsuario."'";
			$this->query="SELECT * FROM FACTURAS_PENDIENTES where vencimiento >=9 and vencimiento <= 29";
			$rs=$this->EjecutaQuerySimple();
			while($tsArray = ibase_fetch_object($rs)){
				$data[]=$tsArray;
			}
		}elseif($tipoUsuario== '' or empty($tipoUusario)){
			/// Revisamos si existen documentos sin entregar a Revision;
			$this->query="SELECT * FROM STATUS_CAJA WHERE (STATUS_RECEPCION < 5) and datediff(day, fecha, current_date) >= 1";
			$rs=$this->EjecutaQuerySimple();
			while($tsArray = ibase_fetch_object($rs)){
				$data[]=$tsArray;
			}
			
		}
		$this->query="SELECT c.*,cc.* ,iif(c.factura = '', remision, factura) as documento,
						datediff(day, c.fecha_creacion, CURRENT_DATE ) as dias 
						FROM CAJAS c
						left join cabecera_caja cc on cc.id = c.id
						WHERE (c.STATUS_RECEPCION < 5 or c.STATUS_RECEPCION IS NULL) 
						AND CAST(c.FECHA_CREACION AS DATE) > DATEADD(DAY, -15, current_date) 
						and cast(c.fecha_creacion as date) < CURRENT_DATE";
		$rs=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($rs)) {
			$data[]=$tsArray;
		}

		if(count($data) > 0){
				$this->bloqueos($usuario, $tipoUsuario);
			}
		return $data;
	}
	
	function bloqueos($usuario, $tipo ){
			//exit($tipo);

			if($tipo == 'G'){
				$tipo = 'Gerencia Cobranza';
			}elseif(substr($tipo,0,1) == 'R'){
				$tipo = 'Cartera Revision '.$tipo;
			}elseif(substr($tipo,0,1) =='C'){
				$tipo = 'Cartera Cobranza '.$tipo;
			}
			$this->query="SELECT count(id) AS ID FROM FTC_BLOQUEOS WHERE TIPO ='$tipo' AND USUARIO = '$usuario' and fecha_bloqueo = current_date";
				$rs=$this->EjecutaQuerySimple();
				$row=ibase_fetch_object($rs);
				$val = $row->ID;
				if($val == 0){
					$this->query="INSERT INTO FTC_BLOQUEOS (ID, TIPO, USUARIO, FECHA, LIBERADO, CONTADOR, fecha_bloqueo) 
								VALUES (NULL, '$tipo', '$usuario', current_timestamp, 'No', iif((select max(contador) from ftc_bloqueos where tipo ='Gerencia Cobranza' and Usuario = '$usuario') is null, 1,(select max(contador) from ftc_bloqueos where tipo ='$tipo' and Usuario = '$usuario')) + 1, current_date)";
					$this->grabaBD();
				}	
			return; 	
		}

	function correosProv($confirma){
		$this->query="SELECT emailpred FROM PROV01 WHERE clave = (select cve_prov from ftc_poc where oc = '$confirma' )";
		$rs=$this->EjecutaQuerySimple();
		$row =ibase_fetch_object($rs);
		$correos = $row->EMAILPRED;

		return $correos;
	}

	function obtenerDatos($row){
		$iddoc = $row['IDDOC'];
		$data3=array();
		if($row['TIPO'] == 2){
			$this->query="SELECT * FROM FTC_POC WHERE ID = $iddoc";
			$rs=$this->EjecutaQuerySimple();
			$row1=ibase_fetch_object($rs);
			$this->query="SELECT * 
							FROM FTC_DOC_RECOLECCION D
							LEFT JOIN FTC_POC F ON F.ID = D.DOC
							WHERE D.OPERADOR = (SELECT FD.OPERADOR FROM FTC_DOC_RECOLECCION FD WHERE FD.DOC =$iddoc) AND (D.STATUS = 0 or D.STATUS = 1 or D.STATUS IS NULL)";
			$res=$this->EjecutaQuerySimple();
			while($tsArray=ibase_fetch_object($res)){
				$data3[]=$tsArray;
			}
			foreach($data3 as $d){
				$id=$d->DOC;
				$operador = $d->OPERADOR;
				$monto = $d->COSTO_TOTAL;
				$cveprov = $d->CVE_PROV;
				$docpago = $d->TP_TES;
				$usrsum = $d->USUARIO;
				$usrconf = $d->CONFIRMADO;
				$tipo = $d->TIPO;
				$oc = $d->OC;
				$status = $d->STATUS;
				$fechareg = $d->FECHA_REG_OPE;
				$folio = $d->FOLIO;
				$datos1[]=array($id, $operador, $monto, $cveprov, $docpago, $usrsum, $usrconf, $tipo, $oc,$status, $fechareg, $folio);
			}

			if(count($data3)>0){
				$datos = array("documento"=>$row1->OC,"documentos"=>$datos1);	
			}else{
				$datos = array("documento"=>$row1->OC,"documentos"=>'No se encontro la ruta');	
			}
			
		}elseif($row->TIPO == 3){
			$this->query="SELECT * FROM CAJAS WHERE ID = $iddoc";
			$rs=$this->EjecutaQuerySimple();
			$row1=ibase_fetch_object($rs);
			$datos = array("documento"=>$row1->FACTURA);		
		}else{

		}
		return $datos;
	}

	function verHC($idc){
		$data=array();
		$this->query="SELECT * FROM FTC_HISTORIA_CAJA WHERE CAJA = $idc order by id asc ";
		$rs=$this->EjecutaQuerySimple();
		
		while ($tsArray=ibase_fetch_object($rs)) {
			$data[]=$tsArray;
		}
		return $data;
	}

	function seguimientoCajasRecibir($tipo){
		$usuario=$_SESSION['user']->NOMBRE;
		$tipoUsuario= $_SESSION['user']->LETRA;
		$this->query="SELECT * FROM PG_USERS WHERE NOMBRE = '$usuario'";
		$res=$this->EjecutaQuerySimple();
		$row=ibase_fetch_object($res);
		$cartera = $row->CC;
		$recibidos = '';
		$cr = '';
		//exit('Tipo de Usuario'.$tipoUsuario);
		if($tipoUsuario != 'G'){
			$cr = " and m.cartera_revision = '".$tipoUsuario."'";
			//ventasleon@biotecsa.com
		}
		if($tipo==6 or $tipo == 62){
			$recibidos = " or STATUS_RECEPCION = 61";
			$campo = 'm.cartera_revision';

		}elseif($tipo==7 or $tipo == 72){
			$recibidos=" or STATUS_RECEPCION = 71";
			$campo = 'cartera';
		}

		if($tipo == 6 or $tipo == 7){
			
			$this->query="SELECT count(ca.id) as documentos ,  max(c.cve_maestro), $campo as cartera, 
									coalesce(sum(f.saldofinal), sum(fp.saldofinal))  as facturas, 
									sum(r.importe) as remisiones 
						from cajas ca
					    left join factp01 p on p.cve_doc = ca.cve_fact
					    left join clie01 c on c.clave = p.cve_clpv
					    left join maestros m on c.cve_maestro = m.clave
					    left join facturas f on f.cve_doc = ca.factura
					    left join factr01 r on r.cve_doc = ca.remision and r.enlazado != 'T' and r.status != 'C'
					    left join facturas_fp fp on fp.cve_doc = ca.factura
					    where STATUS_RECEPCION = $tipo $recibidos
					    group by $campo";

		}elseif($tipo == 62){
			$tipo = 6; 
			$this->query="SELECT F.*, C.*, CT.*, cl.*, iif(factura = '', remision, factura) as documento,
				(select count(id) from FTC_COMPROBANTES_RECIBO where idcaja = C.ID) as archivos, 
				datediff(day, C.fecha_rev, CURRENT_DATE) as dias, 
				(select FIRST 1 saldoFinal from facturas fa where fa.cve_doc = C.FACTURA) AS SALDOFINAL,
				(SELECT FIRST 1 importe from factr01 r where r.cve_doc = C.REMISION ) AS IMPREM
				FROM CAJAS C 
				LEFT JOIN FACTP01 F  ON F.CVE_DOC = C.CVE_FACT 
				LEFT JOIN CARTERA CT ON CT.IDCLIENTE = F.CVE_CLPV
				left join clie01 cl on cl.clave = f.cve_clpv
				left join maestros m on m.clave = cl.cve_maestro
				WHERE STATUS_RECEPCION = $tipo $recibidos
				$cr";
			//echo $this->query;
		}
		
		$res=$this->EjecutaQuerySimple();

		while ($tsArray=ibase_fetch_object($res)) {
			$data[]=$tsArray;
		}
		
		return $data;
	}

	function grabaCtrCbo($idc, $info){
		$usuario =$_SESSION['user']->NOMBRE;
		$this->query="SELECT * FROM CAJAS WHERE ID = $idc";
		$rs=$this->EjecutaQuerySimple();
		$row=ibase_fetch_object($rs);
		//echo('idc: '.$idc.' info: '.$info.' status: '.$row->STATUS_RECEPCION);
		if($info == 'cob'.$idc){
			if($row->STATUS_RECEPCION == 7 or $row->STATUS_RECEPCION == 71){
				$this->query="INSERT INTO FTC_HISTORIA_CAJA VALUES(NULL,(SELECT STATUS_RECEPCION FROM CAJAS WHERE ID = $idc), 9, CURRENT_TIMESTAMP, '$usuario', $idc, (SELECT iif(factura = '', remision , factura) from cajas where id = $idc))";
				$this->grabaBD();

				$this->query="UPDATE CAJAS SET FECHA_INI_COB= CURRENT_TIMESTAMP, FECHA_REC_COBRANZA = CURRENT_TIMESTAMP, USUARIO_REC_COBRANZA = '$usuario', status_recepcion = 8, status_log = 'Cobranza' where id = $idc";
				$this->grabaBD();
				$mensaje = array("status"=>'ok', "razon"=>'Se marco como recibido el documento');
			}else{
				$mensaje = array("status"=>'error', "razon"=>'ya procedado por el usuario: '.$row->USUARIO_REC_COBRANZA);
			}
		}else{
			if($row->STATUS_RECEPCION == 6 or $row->STATUS_RECEPCION == 61){
				$this->query="INSERT INTO FTC_HISTORIA_CAJA VALUES(NULL,(SELECT STATUS_RECEPCION FROM CAJAS WHERE ID = $idc), 8, CURRENT_TIMESTAMP, '$usuario', $idc, (SELECT iif(factura = '', remision , factura) from cajas where id = $idc))";
				$this->grabaBD();

				$this->query="UPDATE CAJAS SET CONTRARECIBO ='$info', FECHA_REVDP = CURRENT_TIMESTAMP, USUARIO_REVDP = '$usuario', status_recepcion = 7, status_log='ContraRec' where id = $idc";
				$this->grabaBD();
				$mensaje = array("status"=>'ok', "razon"=>'Se guardo correctamente el contra recibo: '.$info);
			}else{
				$mensaje = array("status"=>'error', "razon"=>'ya procedado por el usuario: '.$row->USUARIO_REVDP);
			}	
		}
		return $mensaje;
	}

	function caratula($cl, $idc){
		$this->query="SELECT * FROM SP_DOCUMENTOS_CLIENTE('$cl', $idc)";
		$rs=$this->EjecutaQuerySimple();
		
		while ($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}
		return $data;
	}

	function caratula2($cl, $idc){
		$data = array();
		$this->query="SELECT * FROM SP_DOCUMENTOS_CLIENTE('$cl', $idc)";
		$rs=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}
		
		if(count($data)>0){
			$mensaje=array("status"=>'ok');
		}else{
			$mensaje=array("status"=>'error');
		}
		return $mensaje;
	}

	function invFisBod($prod, $canto, $cantn, $um){
		$usuario = $_SESSION['user']->NOMBRE;
		$data = array();
		$this->query = "SELECT * FROM FTC_INVFISBOD WHERE PRODUCTO = '$prod' and status = 0 and um = '$um'";
		$rs=$this->EjecutaQuerySimple();

		while ($tsArray=ibase_fetch_object($rs)) {
			$data[] = $tsArray;
		}
		
			if(count($data) == 0){
				$this->query="INSERT INTO FTC_INVFISBOD (ID, PRODUCTO, FECHA, USUARIO, ORIGINAL, NUEVA, STATUS, UM) 
							VALUES (NULL , '$prod', current_timestamp, '$usuario', $canto, $cantn, 0, '$um' )";
				$this->grabaBD();
				$mensaje =array("status"=>'ok',"mensaje"=>'Se agrego');
			}else{
				$this->query = "UPDATE FTC_INVFISBOD SET nueva = $cantn where producto = '$prod' and status = 0 and um = '$um'";
				$this->EjecutaQuerySimple();
				$mensaje =array("status"=>'ok', "mensaje"=>'Se Actualizo');
			}
		return $mensaje;
	}

	function verInvFisBod(){
		$this->query="SELECT * FROM FTC_INVFISBOD ifs left join producto_ftc pftc on pftc.clave = ifs.producto WHERE ifs.STATUS = 8 AND CAST(ifs.FECHA AS DATE) = CURRENT_DATE";
		$rs=$this->EjecutaQuerySimple();
		while ($tsArray = ibase_fetch_object($rs)) {
			$data[]=$tsArray;
		}
		$this->query="UPDATE FTC_INVFISBOD SET STATUS = 9 WHERE STATUS = 8 AND CAST(FECHA AS DATE) = CURRENT_DATE";
		$rs=$this->EjecutaQuerySimple();
		
		return $data;
	}


 function procesarDoco($doco){
        
        $this->query="SELECT * FROM CABECERA_POC cpoc left join FTC_CTR_QR qr on qr.iddoc = cpoc.id WHERE qr.qr = '$doco'";
        $rs=$this->EjecutaQuerySimple();
        $row=ibase_fetch_object($rs);
        return $row;
    }

function procesarDocoDetalle($doco){
	    $this->query="SELECT * FROM DETALLE_POC F LEFT JOIN FTC_REP_OPE O ON O.IDDOC = F.OC left join ftc_ctr_qr qr on qr.iddoc = f.iddoc WHERE qr.qr='$doco'";
        //echo $this->query;
        $rs=$this->EjecutaQuerySimple();
        while ($tsArray=ibase_fetch_object($rs)) {
            $data[]=$tsArray;
        }
        return $data;
}

function finalizaoperador($oc){
	$this->query="SELECT * FROM CABECERA_POC WHERE OC = '$oc'";
	$rs=$this->EjecutaQuerySimple();
	$row=ibase_fetch_object($rs);
	$status = $row->URGENCIA;

	if($status == 2){
		$this->query="SELECT * FROM DETALLE_POC WHERE OC = '$oc'";
		$res=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($res)) {
				$data[]=$tsArray;
			}	
			$cantoc = 0;
			$cantop = 0;
			foreach ($data as $key) {
				$cantoc += $key->CANTIDAD;
				$cantop += $key->CANT_OP;
			}
			if($cantoc == 0){
				$tipo = 'Fallida';
			}elseif($cantoc > $cantop){
				$tipo = 'faltante';
			}elseif($cantoc < $cantop){
				$tipo = 'sobrante';
			}elseif ($cantoc == $cantop) {
				$tipo = 'finalizado';
			}
		$mensaje=array("status"=>0, "mensaje"=>$tipo); 
	}elseif ($status == 1){
		$mensaje=array("status"=>1);
	}else{
		$mensaje=array("status"=>2);
	}
	return $mensaje;
}


	function preordenes(){
		$this->query="SELECT * FROM CABECERA_POC C WHERE C.STATUS = 'Nueva' and fecha_doc >= '15.03.2018' order by fecha_doc";
		$rs=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($rs)) {
			$data[]=$tsArray;
		}
		return $data;
	}

	function comprobacion($oc, $qr){

		if($qr == 0){
		//echo 'Se valida el QR:'.$qr; 
			$this->query="SELECT count(id) as val, max(q.status) as status FROM FTC_CTR_QR q left join ftc_poc f on f.id = q.iddoc WHERE oc='$oc'";
			$rs=$this->EjecutaQuerySimple();
			$row=ibase_fetch_object($rs);
			$val = $row->VAL;
			$status = $row->STATUS;

			/*
			SELECT count(id) as val, max(q.status) as status FROM FTC_CTR_QR q left join ftc_poc f on f.id = q.iddoc WHERE oc='OP11856'

			$this->query="UPDATE FTC_POC SET FECHA_REG = current_timestamp  where oc = '$oc'";
			$this->queryActualiza();

			$this->query="UPDATE FTC_POC SET PRE_RECEP = (SELECT IIF(PRE_RECEP is null, 0, PRE_RECEP) from ftc_poc where cast(fecha_reg as date)= current_date) + 1 where oc = '$oc'";
			$this->queryActualiza();
			//echo $this->query;
			*/
		}else{
			$this->query="SELECT count(id) as val, max(q.status) as status FROM FTC_CTR_QR q left join ftc_poc f on f.id = q.iddoc WHERE upper(q.QR) = '$qr' and oc='$oc'";
			$rs=$this->EjecutaQuerySimple();
			$row=ibase_fetch_object($rs);
			$val = $row->VAL;
			$status = $row->STATUS;		
		}
		//echo $this->query;

		return array("validacion"=>$val,"status"=>$status);
	}

	function prerecep($doco, $cantr, $partida, $producto){
		$this->query="SELECT COUNT(ID) as id FROM FTC_REP_OPE WHERE iddoc = '$doco' and partida = $partida and status_recep <999999";
		$rs=$this->EjecutaQuerySimple();
		$row=ibase_fetch_object($rs);
		$val = $row->ID;
		if($val> 0){
			$this->query="UPDATE FTC_REP_OPE set CANT = $cantr, fecha = current_timestamp, status_recep = status_recep +1 where iddoc = '$doco' and partida=$partida";
			$rs=$this->queryActualiza();
			if($rs==1){
				$response = array("status"=>'ok',"mensaje"=>'Se Actualizo');
			}else{
				$response = array("status"=>'no',"mensaje"=>'Hay un error');
			}
		}else{	
			$this->query="INSERT INTO FTC_REP_OPE (ID,FECHA, IDDOC, PARTIDA, CANT, STATUS_RECEP) VALUES (NULL, current_timestamp, '$doco',  $partida, $cantr,1)";
			$this->grabaBD();
			$response = array("status"=>'ok',"mensaje"=>'Se Grabo');
		}
		return $response;
	}

function buscaID($id){
		$this->query="SELECT p.*, (select nombre from prov01 where trim(clave) = trim(p.prov_alt)) as PROVALT FROM PREOC01 p WHERE p.ID=$id";
		$rs=$this->EjecutaQuerySimple();
		$row=ibase_fetch_object($rs);
		if(isset($row)){
			$data=array();
			$this->query="SELECT D.*, F.*, F.STATUS AS STOC FROM FTC_POC_DETALLE D LEFT JOIN FTC_POC F ON F.CVE_DOC =  D.CVE_DOC WHERE IDPREOC = $id and pxr >0";
			$rs=$this->EjecutaQuerySimple();
			while ($tsArray=ibase_fetch_object($rs)) {
				$data[]=$tsArray;
			}
			$data3=array();
			foreach ($data as $key) {
				$status_log='';
				if($key->STATUS_LOG =='Nuevo' ){
					$status_log = 'Asignacion de Unidad';
				}
				$data3[]=array($key->CVE_DOC,$key->FECHA_DOC, $key->CANTIDAD, $key->PXR, $key->OC, $key->FECHA_OC,$key->STOC, $key->USUARIO, $key->TP_TES , $status_log , $key->UNIDAD);
			}
			$producto = utf8_encode($row->PROD.'--->'.$row->NOMPROD);
			$status = $row->STATUS;
			$proveedor = utf8_encode($row->PROVE);
			$nomprov = utf8_encode($row->NOM_PROV);
			$cvealt = $row->PROV_ALT;
			$nomalt = utf8_encode($row->PROVALT);
			$ordenado = $row->ORDENADO;
			$faltante = $row->REC_FALTANTE;
			$pedido = $row->COTIZA;
			
			$mensaje=array("status"=>'ok',"resultado"=>'ok', "idstatus"=>$status, "idprov"=>'('.$proveedor.')'.$nomprov,"ordenado"=>$ordenado,"rec_faltante"=>$faltante,  "idpalterno"=>'('.$cvealt.')'.$nomalt,"Ordenes"=>$data3, "cotiza"=>$pedido, "idproducto"=>$producto);
			//print_r($mensaje);

		}else{
			$mensaje=array("status"=>'no',"resultado"=>'No se encontro');
		}

		return $mensaje;
	}

	function motivosFallidos($oc){
		$data=array();
		$this->query="SELECT * FROM FTC_MOTIVO_OC_FALLIDAS WHERE OC = '$oc'";
		$rs=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}
		return $data;
	}

	function partidasOC($oc){
		$this->query="SELECT * FROM DETALLE_POC WHERE OC='$oc' and status= 8";
		$rs=$this->EjecutaQuerySimple();
		while($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}
		return $data;
	}

function ejecutaOC($oc, $tipo, $motivo, $partida, $final){
		$usuario = $_SESSION['user']->NOMBRE;
		if(trim($motivo) == 'Motivo del fallo general:' or $motivo == ''){
			return $response=array("status"=>"no","mensaje"=>"resgitrar un motivo por favor");
		}
		$this->query="SELECT * FROM FTC_POC_DETALLE WHERE OC ='$oc' and partida = $partida";
		$res=$this->EjecutaQuerySimple();
		$val=ibase_fetch_object($res);
		$validacion = $val->STATUS;
		$pxrr = $val->PXR;
		if($validacion != 8){
			return $response=array("status"=>"no","mensaje"=>"Partida ya procesada con el status".$val->STATUS_REAL);
		}
		if($tipo == 'ind'){
			if($final == 'reenrutar'){
					$this->query="UPDATE FTC_POC_DETALLE SET STATUS = 0, STATUS_LOG2 = 'Logistica' where oc = '$oc' and partida = $partida";
					$res=$this->queryActualiza();
				if($res == 1){
					$this->query="UPDATE FTC_POC SET STATUS_LOG = 'Nuevo', status= 'LOGISTICA', STATUS_RECEPCION = NULL WHERE OC = '$oc'";
					$this->queryActualiza();
					$this->query="INSERT INTO FTC_MOTIVO_OC_FALLIDAS (ID, OC, USUARIO, MOTIVO, FECHA, ARCHIVOS, PARTIDA, STATUS_O, STATUS_N,CANTIDAD, PROVEEDOR, TIPO) 
												VALUES (NULL, '$oc', '$usuario', '$motivo', current_timestamp, 0, $partida, 'Retorno a Suministros', '$final', $pxrr, (select CVE_PROV FROM FTC_POC WHERE OC = '$oc'), 'RI')";
							$this->grabaBD();
							
					$response = array("status"=>'ok',"mensaje"=>'Se reenruto la OC y la partida'.$partida);
				}
			}elseif($final == 'fallar'){
					$this->query="SELECT * FROM FTC_POC_DETALLE where pxr > 0 and oc = '$oc' and partida = $partida";
					$rs=$this->EjecutaQuerySimple();
					$row=ibase_fetch_object($rs);
					$pxr = $row->PXR;
					$idp = $row->IDPREOC;
					 $this->query="INSERT INTO FTC_SOLICITUD_PROV (id, cantidad, cve_prod,cve_prov_orig, nombre_prov_orig, idpreoc, descripcion, usuario_solicita, fecha_solicita, usuario_cambia, fecha_cambia, cve_nuevo_prov, nombre_nuevo_prov, oc) 
			    			values(null,$pxr,'$row->ART', (SELECT CVE_PROV FROM FTC_POC WHERE OC = '$oc'),(SELECT NOMBRE FROM CABECERA_POC WHERE OC = '$oc') , $idp, 
			    			(SELECT DESCRIPCION FROM DETALLE_POC WHERE ID = $row->ID), '$usuario', current_timestamp, null, null, null, null, '$oc')";
					    $this->grabaBD();
					    
					$this->query="UPDATE PREOC01 SET prov_alt = '999999999', STATUS='J', REST=REST+$pxr, ordenado=ordenado-$pxr, canti=cant_orig-(ordenado+$pxr) where id= $idp";
					$result=$this->queryActualiza();
					if($result == 1){
						$this->query="UPDATE FTC_POC_DETALLE SET pxr = 0, STATUS=3, STATUS_LOG2='Fallido', status_real = 'Fallido' where oc = '$oc' and partida = $partida ";
						$resultado=$this->queryActualiza();
						if($resultado == 1){
							$this->query="UPDATE FTC_POC SET STATUS_LOG = 'FALLIDO', STATUS='FALLIDO' WHERE OC = '$oc'";
							$this->queryActualiza();

							$this->query="INSERT INTO FTC_MOTIVO_OC_FALLIDAS (ID, OC, USUARIO, MOTIVO, FECHA, ARCHIVOS, PARTIDA, STATUS_O, STATUS_N,CANTIDAD, PROVEEDOR, TIPO) 
												VALUES (NULL, '$oc', '$usuario', '$motivo', current_timestamp, 0, $partida, 'Retorno a Suministros', '$final', $pxrr, (select CVE_PROV FROM FTC_POC WHERE OC = '$oc'), 'FI')";
							$this->grabaBD();
							$response = array("status"=>'ok',"mensaje"=>'Fallo Partida');
						}
					}
			}elseif($final == 'noreq'){

			}else{
				$response=array('status'=>'no', "mensaje"=>'Seleccione un final, por favor');
			}
		}elseif($tipo == 'gen'){
			//echo 'Entro a General<br/>';
			if($final == 'reenrutar'){
				//echo 'Entro a Reenrutar';
					$this->query="SELECT * FROM FTC_POC_DETALLE where pxr > 0 and oc = '$oc' and status = 8";
					$rs=$this->EjecutaQuerySimple();
					while ($tsArray=ibase_fetch_object($rs)) {
						$data[]=$tsArray;
					}
					$this->query="UPDATE FTC_POC_DETALLE SET STATUS = 0, STATUS_LOG2 = 'Logistica' where oc = '$oc' and pxr > 0 and status = 8";
					$res=$this->queryActualiza();
				if($res >= 1){

					foreach ($data as $key ) {
						$pxr = $key->PXR;
						$idp = $key->IDPREOC;
						$partida = $key->PARTIDA;						

						$this->query="INSERT INTO FTC_MOTIVO_OC_FALLIDAS (ID, OC, USUARIO, MOTIVO, FECHA, ARCHIVOS, PARTIDA, STATUS_O, STATUS_N, CANTIDAD, PROVEEDOR, TIPO) 
												VALUES (NULL, '$oc', '$usuario', '$motivo', current_timestamp, 0, $partida, 'Retorno a Suministros', '$final', $pxr, (select CVE_PROV FROM FTC_POC WHERE OC = '$oc'), 'RG')";
							$this->grabaBD();
					}
					$this->query="UPDATE FTC_POC SET STATUS_LOG = 'Nuevo', status= 'LOGISTICA', STATUS_RECEPCION = NULL WHERE OC = '$oc'";
					$this->queryActualiza();	
					$response = array("status"=>'ok',"mensaje"=>'Se reenruto la OC');
				}
			}elseif($final == 'fallar'){
					$this->query="SELECT * FROM FTC_POC_DETALLE where pxr > 0 and oc = '$oc' and status = 8";
					$rs=$this->EjecutaQuerySimple();
					while ($tsArray=ibase_fetch_object($rs)) {
						$data[]=$tsArray;
					}
					foreach ($data as $key) {
						$pxr = $key->PXR;
						$idp = $key->IDPREOC;
						$partida = $key->PARTIDA;

						$this->query="INSERT INTO FTC_SOLICITUD_PROV (id, cantidad, cve_prod,cve_prov_orig, nombre_prov_orig, idpreoc, descripcion, usuario_solicita, fecha_solicita, usuario_cambia, fecha_cambia, cve_nuevo_prov, nombre_nuevo_prov, oc) 
			    			values(null,$pxr,'$key->ART', (SELECT CVE_PROV FROM FTC_POC WHERE OC = '$oc'),(SELECT NOMBRE FROM CABECERA_POC WHERE OC = '$oc') , $idp, 
			    			(SELECT substring(DESCRIPCION from 1 for 250) FROM DETALLE_POC WHERE ID = $key->ID), '$usuario', current_timestamp, null, null, null, null, '$oc')";
					    $this->grabaBD();
					    		
						$this->query="UPDATE PREOC01 SET prov_alt = '999999999', STATUS='J', REST=REST+$pxr, ordenado=ordenado-$pxr, canti=cant_orig - (ordenado+$pxr)  where id = $idp";
						$result=$this->queryActualiza();
						
						if($result == 1){
							$this->query="UPDATE FTC_POC_DETALLE SET  PXR = 0, STATUS=3, STATUS_LOG2 ='Fallido', status_real = 'Fallido' where oc = '$oc' and partida = $partida ";
							$resultado=$this->queryActualiza();
							
							if($resultado == 1){
								$this->query="UPDATE FTC_POC SET STATUS_LOG = 'FALLIDO', STATUS='FALLIDO' WHERE OC = '$oc'";
								$this->queryActualiza();
								$this->query="INSERT INTO FTC_MOTIVO_OC_FALLIDAS (ID, OC, USUARIO, MOTIVO, FECHA, ARCHIVOS, PARTIDA, STATUS_O, STATUS_N, CANTIDAD, PROVEEDOR, tipo) 
													VALUES (NULL, '$oc', '$usuario', '$motivo', current_timestamp, 0, $partida, 'Retorno a Suministros', '$final', $pxr, (select CVE_PROV FROM FTC_POC WHERE OC = '$oc'), 'FG')";
								$this->grabaBD();
								
								$response = array("status"=>'ok',"mensaje"=>'Fallo general');
							}	
						}
					}
			}elseif($final == 'noreq'){

			}else{

				$response=array('status'=>'no', "mensaje"=>'Seleccione un final, por favor');
			}
		}

		$this->query="SELECT SUM(PXR) AS PXR FROM FTC_POC_DETALLE WHERE OC = '$oc'";
		$res=$this->EjecutaQuerySimple();
		$sf=ibase_fetch_object($res);
		$pxrf = $sf->PXR;

		if($pxrf > 0){
			$this->query="UPDATE FTC_POC SET STATUS_LOG = 'Nuevo', status= 'LOGISTICA', STATUS_RECEPCION = NULL WHERE OC = '$oc'";
			//$this->queryActualiza();
		}
		return $response;
	}


	function verOrdenesFallidas(){
		$data = array(); $datos = array();
		$rol = $_SESSION['user']->USER_ROL;
		$usuario = $_SESSION['user']->NOMBRE;
		if($rol == 'tesoreria'){
				$this->query="SELECT ftcm.oc, max(tp_tes) as tp_tes, MAX(FECHA) AS FECHA, MAX(ftcm.USUARIO) AS USUARIO, MAX(ftcm.MOTIVO) AS MOTIVO, (SELECT NOMBRE FROM PROV01
					WHERE CLAVE = MAX(ftcm.PROVEEDOR)) AS PROVEEDOR
					FROM FTC_MOTIVO_OC_FALLIDAS ftcm left join ftc_poc poc on poc.oc = ftcm.oc
					WHERE (ftcm.TIPO = 'FG' OR ftcm.TIPO = 'FI') AND (STATUS_SUM IS NULL OR STATUS_SUM = 0) GROUP BY ftcm.OC";
    			$rs=$this->EjecutaQuerySimple();
		}else{
				$this->query="SELECT ftcm.oc, max(tp_tes) as tp_tes, MAX(FECHA) AS FECHA, MAX(ftcm.USUARIO) AS USUARIO, MAX(ftcm.MOTIVO) AS MOTIVO, (SELECT NOMBRE FROM PROV01
				WHERE CLAVE = MAX(ftcm.PROVEEDOR)) AS PROVEEDOR
				FROM FTC_MOTIVO_OC_FALLIDAS ftcm left join ftc_poc poc on poc.oc = ftcm.oc
				WHERE (ftcm.TIPO = 'FG' OR ftcm.TIPO = 'FI') AND (STATUS_SUM IS NULL OR STATUS_SUM = 0) 
				and ftcm.usuario = '$usuario' GROUP BY ftcm.OC";
    			$rs=$this->EjecutaQuerySimple();
		}
    	while ($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	foreach ($data as $key) {
    		$oc = $key->OC;
    		unset($data2);
    		$this->query="SELECT ocf.oc, ocf.partida, ocf.cantidad, ocd.costo, ocd.descuento 
    						FROM FTC_MOTIVO_OC_FALLIDAS ocf 
    						left join  FTC_POC_DETALLE ocd on ocd.oc = ocf.oc and ocd.partida = ocf.partida  
    						WHERE ocf.OC = '$oc'";
    		$res=$this->EjecutaQuerySimple();
    
    		while ($tsArray=ibase_fetch_object($res)) {
    			$data2[]=$tsArray;
    		}
    		$subtotal = 0;
    		foreach ($data2 as $key2) {
    			$cantidad = $key2->CANTIDAD;
    			$costo = $key2->COSTO;
    			$descuento = $key2->DESCUENTO;
    			$subtotal= $subtotal + (($cantidad * $costo) - ($descuento));
    		}
    		$datos[]=array("OC"=>$oc,"TP_TES"=>$key->TP_TES,"FECHA"=>$key->FECHA,"USUARIO"=>$key->USUARIO,"MOTIVO"=>$key->MOTIVO,"PROVEEDOR"=>$key->PROVEEDOR,"SUBTOTAL"=>$subtotal);	
    	}
    	return $datos;
	}

	function verDetalleOCF($oc){
		$this->query="SELECT ftcm.*, fd.*, (SELECT NOMBRE FROM PRODUCTO_FTC WHERE CLAVE = fd.art) AS DESCRIPCION FROM FTC_MOTIVO_OC_FALLIDAS ftcm left join FTC_POC_DETALLE fd on fd.oc = ftcm.oc and fd.partida=ftcm.partida
								 WHERE ftcm.OC = '$oc' and status_n = 'fallar' and (status_sum is null or status_sum = 0)";
		$rs=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($rs)) {
			$data[]=$tsArray;
		}
		return $data;
	}

	function regDocOp($doc){
		$row=array();
		$this->query="SELECT f.*, (SELECT ID FROM FTC_POC WHERE OC = '$doc') as id  FROM FTC_DOC_RECOLECCION f 
							WHERE DOC = (select id from FTC_POC WHERE OC = '$doc') and status != 0";
		$rs=$this->EjecutaQuerySimple();
		$row=ibase_fetch_object($rs);
		if(!$row){
			$this->query="SELECT MAX(FOLIO) AS FOLIO FROM FTC_DOC_RECOLECCION WHERE CAST(FECHA_REG_OPE AS DATE) = current_date";
			$res= $this->EjecutaQuerySimple();
			$row = ibase_fetch_object($res);
			$folio = $row->FOLIO + 1;

			$this->query="UPDATE FTC_DOC_RECOLECCION SET STATUS = 1, FOLIO = $folio, FECHA_REG_OPE = current_timestamp WHERE DOC=(SELECT ID FROM FTC_POC WHERE OC = '$doc')";
			$rs=$this->queryActualiza();

			$response = array("status"=>'ok',"mensaje"=>'Se ha registrado su OC correctamente');
			

		}else{
			$response=array("status"=>'no',"mensaje"=>'Ya se ha registrado la orde '.$doc.' a las: '.$row->FECHA_REG_OPE.' con el numero '.$row->FOLIO);
		}
		
		return $response;
	}

	function ocPendientes(){
		$data=array();
		$this->query="SELECT FR.*, (SELECT OC FROM FTC_POC F WHERE F.ID = FR.DOC) AS OC FROM FTC_DOC_RECOLECCION FR WHERE STATUS = 0 or STATUS = 1";
		$rs=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($rs)) {
			$data[]=$tsArray;
		}

		return $data;
	}

	function obtieneQR($oc){
		$this->query="SELECT QR FROM FTC_CTR_QR WHERE IDDOC = (SELECT ID FROM FTC_POC WHERE OC='$oc')";
		$rs=$this->EjecutaQuerySimple();
		$row=ibase_fetch_object($rs);
		return $response=array("qr"=>$row->QR);
	}

	function leeXML($archivo){
    	$myFile = fopen("$archivo", "r") or die ("No se ha logrado abrir el archivo ($file)!");
		$myXMLData = fread($myFile, filesize($archivo));
        $xml = @simplexml_load_string($myXMLData) or die ("Error: No se ha logrado crear el objeto XML ($file)");
        $ns = $xml->getNamespaces(true);
        $xml->registerXPathNamespace('c', $ns['cfdi']);
        $xml->registerXPathNamespace('t', $ns['tfd']);   
        foreach ($xml->xpath('//cfdi:Comprobante') as $cfdiComprobante){
            $version = $cfdiComprobante['version'];
			if($version == ''){
			$version = $cfdiComprobante['Version'];
			}
		}
        foreach ($xml->xpath('//t:TimbreFiscalDigital') as $tfd) {
		    if($version == '3.2'){
		    	$uuid = $tfd['UUID'];
		    }else{
		    	$uuid = $tfd['UUID'];
		    }
		}
		if($version == '3.2'){
			$tipo = $cfdiComprobante['tipoDeComprobante'];
		}elseif($version == '3.3'){
			$tipo = $cfdiComprobante['TipoDeComprobante'];
		}
		foreach ($xml->xpath('//cfdi:Comprobante//cfdi:Receptor') as $Receptor) {
			if($version == '3.2'){
				$rfc= $Receptor['rfc'];
			 	$nombre_recep = utf8_encode($Receptor['nombre']);
				$usoCFDI = '';
			}elseif($version == '3.3'){
				$rfc= $Receptor['Rfc'];
				$nombre_recep=utf8_encode($Receptor['Nombre']);
				$usoCFDI =$Receptor['UsoCFDI'];
			 }
		}
		foreach ($xml->xpath('//cfdi:Comprobante//cfdi:Emisor') as $Emisor){
			if($version == '3.2'){
				$rfce = $Emisor['rfc'];
				$nombreE = '';
				$regimen = '';	
			}elseif($version == '3.3'){
				$rfce = $Emisor['Rfc'];
				$nombreE = utf8_encode($Emisor['Nombre']);
				$regimen = $Emisor['RegimenFiscal'];
			}
		}
		$rfcEmpresa = $_SESSION['rfc'];
		//echo '<br/>'.utf8_decode($nombre_recep);
		if($rfcEmpresa != $rfce and $rfcEmpresa!=$rfc){
			echo ('<br/><font color="red">El RFC NO CORRESPONDE A LA EMPRESA SELECCIONADA, SOLO SE PUEDEN SUBIR RFC DE LA EMPRESA SELECCIONA....'. $uuid.'</font><br/>');
			$tipo = 'falso';
		}
		return array("uuid"=>$uuid, "tcf"=>$tipo);
    }

	function seleccionarArchivoXMLCargado($archivo, $uuid){
		$this->query= "SELECT NOMBRE,ARCHIVO,FECHA,USUARIO,TIPO FROM XML_DATA_FILES WHERE UUID = '$uuid';";
        $rs = $this->QueryObtieneDatosN();
      	while($tsArray=ibase_fetch_object($rs)){
      		$data[]=$tsArray;
      	}
      	return @$data;
    }
       
    function insertarArchivoXMLCargado($archivo, $tipo, $a){
        $TIME = time();
        $HOY = date("Y-m-d H:i:s", $TIME);
        $usuario = $_SESSION['user']->USER_LOGIN;
        $file=substr($archivo, 37,200);
        $file=str_replace(".xml", "", $file);
        $uuid=$a['uuid'];
        $tcf=$a['tcf'];
        $this->query= "INSERT INTO XML_DATA_FILES (ID,NOMBRE,ARCHIVO,FECHA,USUARIO,TIPO, UUID, TIPO_FISCAL)VALUES(NULL,'$archivo','$file','$HOY','$usuario', '$tipo', '$uuid','$tcf')";
        //echo "sql = ".$this->query;
        $respuesta = $this->grabaBD();
        $this->insertaXMLData($archivo, $tipo, $uuid);
        $this->actParametros($uuid, $tipo);
        $this->revisaParametros($uuid);
        return $respuesta;
    }

    function actParametros($uuid, $tipo){
    	$data = array();
    	$this->query="SELECT XD.CLIENTE AS RFCR, XD.RFCE AS RFCE, XP.* FROM XML_PARTIDAS XP LEFT JOIN XML_DATA XD ON XD.UUID = XP.UUID WHERE xp.UUID = '$uuid'";
    	//echo '<br/>'.$this->query.'<br/>';
    	$rs=$this->EjecutaQuerySimple();
    	while ($tsArray=ibase_fetch_object($rs)) {
    		$data[]=$tsArray;
    	}
    	foreach($data as $pd){
    		$rfce = $pd->RFCE; /// Cuando el rfc emisor es de la empresa que se trabaja es una venta
    		$rfcr = $pd->RFCR; /// Cuando el rfc receptor es de la empresa que se trabaja es una compra 
    		$this->query="SELECT MAX(CUENTA_CONTABLE) as CUENTA_CONTABLE from xml_partidas where rfc = '$rfcr' and CLAVE_SAT = '$pd->CLAVE_SAT' and UNIDAD_SAT = '$pd->UNIDAD_SAT'";
    		$r=$this->EjecutaQuerySimple();
    		//print '<br/>'.$this->query.'<br/>';
    		$row=ibase_fetch_object($r);
    		if(strlen($row->CUENTA_CONTABLE) > 0){
    			$this->query="UPDATE XML_PARTIDAS SET CUENTA_CONTABLE = '$row->CUENTA_CONTABLE' WHERE uuid='$uuid' and partida=$pd->PARTIDA";
    			//print '<br/>'.$this->query.'<br/>';
    			$this->queryActualiza();
    		}
    	}
    	return;
    }

    function insertaXMLData($archivo, $tipo, $uuid){
    	$tipo2 = $tipo;
    	$data = $this->seleccionarArchivoXMLCargado($archivo,$uuid);
        if($data!=null and $tipo2 == 'F'){
            foreach ($data as $row):
                $file = $row->NOMBRE;
            endforeach;
            $myFile = fopen("$file", "r") or die("No se ha logrado abrir el archivo ($file)!");
            $myXMLData = fread($myFile, filesize($file));
            $xml = @simplexml_load_string($myXMLData) or die("Error: No se ha logrado crear el objeto XML ($file)");
            $ns = $xml->getNamespaces(true);
            $xml->registerXPathNamespace('c', $ns['cfdi']);
            $xml->registerXPathNamespace('t', $ns['tfd']);
            @$xml->registerXPathNamespace('impl', $ns['implocal']);
            @$xml->registerXPathNamespace('p10',$ns['pago10']);
            foreach ($xml->xpath('//cfdi:Comprobante') as $cfdiComprobante){
            	  $version = $cfdiComprobante['version'];
				  if($version == ''){
				  	$version = $cfdiComprobante['Version'];
				  }
				  if($version == '3.2'){
				      $serie = $cfdiComprobante['serie'];                  
	                  $folio = $cfdiComprobante['folio'];
	                  $total = $cfdiComprobante['total'];
	                  $subtotal = $cfdiComprobante['subTotal'];
					  $descuento = $cfdiComprobante['descuento'];
					  $tipo = $cfdiComprobante['tipoDeComprobante'];
				  	  $condicion = $cfdiComprobante['condicionesDePago'];
					  $metodo = $cfdiComprobante['metodoDePago'];
       				  $moneda = $cfdiComprobante['Moneda'];
					  $lugar = $cfdiComprobante['LugarExpedicion'];
					  $tc = empty($cfdiComprobante['TipoCambio'])? 1:$cfdiComprobante['TipoCambio'];
					  $Certificado = $cfdiComprobante['certificado'];
					  $Sello = $cfdiComprobante['sello'];
					  $noCert = $cfdiComprobante['noCertificado'];
					  $formaPago = $cfdiComprobante['formaDePago'];
					  $LugarExpedicion = $cfdiComprobante['LugarExpedicion'];
					  $MetodoPago = $cfdiComprobante['metodoDePago'];
				  }elseif($version == '3.3'){
				      $serie = $cfdiComprobante['Serie'];                  
	                  $folio = $cfdiComprobante['Folio'];
	                  $total = $cfdiComprobante['Total'];
	                  $subtotal = $cfdiComprobante['SubTotal'];
					  $descuento = $cfdiComprobante['Descuento'];
					  $tipo = $cfdiComprobante['TipoDeComprobante'];
					  $condicion = $cfdiComprobante['CondicionesDePago'];
					  $metodo = $cfdiComprobante['MetodoPago'];
					  $moneda = $cfdiComprobante['Moneda'];
					  $lugar = $cfdiComprobante['LugarExpedicion'];
					  $tc = empty($cfdiComprobante['TipoCambio'])? 1:$cfdiComprobante['TipoCambio'];
					  $Certificado = $cfdiComprobante['Certificado'];
					  $Sello = $cfdiComprobante['Sello'];
					  $noCert = $cfdiComprobante['NoCertificado'];
					  $formaPago = $cfdiComprobante['FormaPago'];
					  $LugarExpedicion = $cfdiComprobante['LugarExpedicion'];
					  $MetodoPago = $cfdiComprobante['MetodoPago'];
				  }
			}
            /*foreach ($xml->xpath('//cfdi:Comprobante//cfdi:Complemento//nomina:Nomina//nomina:Percepciones//nomina:Percepcion') as $Percepcion){
               $nombreper = $Percepcion['TipoPercepcion'];
               //$nombre = $Receptor['nombre'];
            }*/
            //$this->query="DELETE FROM XML_DATA_FILES WHERE nombre = '$archivo'";
            //$this->EjecutaQuerySimple();
            if(($tipo == 'I' or $tipo == 'E' or $tipo == 'ingreso' or $tipo == 'egreso' or $tipo== 'P') and $serie != 'NOMINA'){
            			$this->query="UPDATE XML_DATA_FILES SET TIPO = '$tipo' WHERE NOMBRE='$archivo'";
            			$this->EjecutaQuerySimple();



			        	foreach ($xml->xpath('//cfdi:Comprobante//cfdi:Receptor') as $Receptor) {
			            	if($version == '3.2'){
			            		$rfc= $Receptor['rfc'];
			           		 	$nombre_recep = utf8_encode($Receptor['nombre']);
			            		$usoCFDI = '';
			            	}elseif($version == '3.3'){
			            		$rfc= $Receptor['Rfc'];
			            		$nombre_recep=utf8_encode($Receptor['Nombre']);
			            		$usoCFDI =$Receptor['UsoCFDI'];
			            	 }
			            }
			            foreach ($xml->xpath('//cfdi:Comprobante//cfdi:Emisor') as $Emisor){
			            	if($version == '3.2'){
			            		$rfce = $Emisor['rfc'];
			            		$nombreE = '';
			            		$regimen = '';	
			            	}elseif($version == '3.3'){
			            		$rfce = $Emisor['Rfc'];
			            		$nombreE = utf8_encode($Emisor['Nombre']);
			            		$regimen = $Emisor['RegimenFiscal'];
			            	}
			            }
			            		$recep_calle='';
				            	$recep_noExterior='';
				            	$recep_noInterior='';
				            	$recep_colonia='';
				            	$recep_municipio='';
				            	$recep_estado='';
				            	$recep_pais='';
				            	$recep_cp='';

			            foreach($xml->xpath('//cfdi:Comprobante//cfdi:Receptor//cfdi:Domicilio') as $Emisor_dir){
			            	if($version == '3.2'){
			            		$recep_calle=$Emisor_dir['calle'];
				            	$recep_noExterior=$Emisor_dir['noExterior'];
				            	$recep_noInterior=$Emisor_dir['noInterior'];
				            	$recep_colonia=$Emisor_dir['colonia'];
				            	$recep_municipio=$Emisor_dir['municipio'];
				            	$recep_estado=$Emisor_dir['estado'];
				            	$recep_pais=$Emisor_dir['pais'];
				            	$recep_cp=$Emisor_dir['codigoPostal'];
			            	}elseif($version == '3.3'){
			            		$recep_calle='';
				            	$recep_noExterior='';
				            	$recep_noInterior='';
				            	$recep_colonia='';
				            	$recep_municipio='';
				            	$recep_estado='';
				            	$recep_pais='';
				            	$recep_cp='';
			            	}
			            }
			            /// debemos traer el RFC de la empresa que se esta trabajando.
			            $rfcEmpresa = $_SESSION['rfc'];
			            //echo 'Este es el RFC: '.$rfc.'<br/>';

			            if($rfc == $rfcEmpresa){
			            	$tipoC = 'Proveedor';
							$this->query="SELECT * FROM XML_CLIENTES WHERE RFC = '$rfce' and tipo ='$tipoC'";
			            	$res=$this->EjecutaQuerySimple();
			            	$row=ibase_fetch_object($res);
			            	$nombreE=$nombreE;
			            	if(empty($row)){
			            		$this->query="INSERT INTO XML_CLIENTES (IDcliente, RFC, NOMBRE, CALLE, EXTERIOR, INTERIOR, COLONIA, MUNICIPIO, ESTADO, PAIS, CP, TIPO)
			            				  VALUES (NULL, '$rfce', '$nombreE', '$recep_calle', '$recep_noExterior', '$recep_noInterior', '$recep_colonia', '$recep_municipio', '$recep_estado', '$recep_pais', '$recep_cp', '$tipoC' )";
			            		if($this->grabaBD() === false){
			            			echo 'Error en la insercion de '.$tipoC.'<br/>';
			            			echo $this->query.'<br/>';
			            		}  	
			            	}			            	
			            }else{
			            	$tipoC = 'Cliente';
			            	$this->query="SELECT * FROM XML_CLIENTES WHERE RFC = '$rfc' and tipo ='$tipoC'";
			            	$res=$this->EjecutaQuerySimple();
			            	$row=ibase_fetch_object($res);
			            	$nombre_recep=$nombre_recep;
			            	if(empty($row)){
			            		$this->query="INSERT INTO XML_CLIENTES (IDcliente, RFC, NOMBRE, CALLE, EXTERIOR, INTERIOR, COLONIA, MUNICIPIO, ESTADO, PAIS, CP, TIPO)
			            					  VALUES (NULL, '$rfc', '$nombre_recep', '$recep_calle', '$recep_noExterior', '$recep_noInterior', '$recep_colonia', '$recep_municipio', '	$recep_estado', '$recep_pais', '$recep_cp', '$tipoC' )";	
			            		if($this->grabaBD() === false){  	
			            			echo 'Error en la insercion de '.$tipoC.'<br/>';
			            			echo $this->query.'<br/>';
			            		}
			            	}
			            }
			            //echo $this->query;			            
			            $parIT=0;
			            $partidaImp=array();
			          	$parte_partida=array();
			          	$parInfoAduana=array();
			           	foreach($xml->xpath('//cfdi:Comprobante//cfdi:Conceptos//cfdi:Concepto') as $Concepto){
			            	$parIT++;
			            	if($version ==  '3.2'){
				            	$unidad = $Concepto['unidad'];
				            	$importe = $Concepto['importe'];
				            	$cantidad = $Concepto['cantidad'];
				            	$descripcion = htmlentities($Concepto['descripcion']);
				            	$valor = $Concepto['valorUnitario'];
				            	$claveSat='';
				            	$claveUni='';
				            	$partida[] =array($unidad, $importe, $cantidad, $descripcion, $valor,$claveSat, $claveUni); 
			            	}elseif($version =='3.3'){
			            		$unidad = $Concepto['Unidad'];
				            	$importe = $Concepto['Importe'];
				            	$cantidad = $Concepto['Cantidad'];
				            	$descripcion = htmlentities($Concepto['Descripcion']);
				            	$valor = $Concepto['ValorUnitario'];
				            	$claveSat=$Concepto['ClaveProdServ'];
				            	$claveUni=$Concepto['ClaveUnidad'];
				            	$descp = isset($Concepto['Descuento'])? $Concepto['Descuento']:0;
				            	$partida[]=array($unidad, $importe, $cantidad, $descripcion, $valor, $claveSat, $claveUni, $descp); 
			            	}
			            	//echo '<br/>Valor de parIT antes de los Impuestos: '.$parIT.'<br/>';
			           		if($Concepto->xpath('cfdi:Impuestos')){
			           			if($Concepto->xpath('cfdi:Impuestos//cfdi:Traslados')){
			           				//echo '<br/> La partida '.$parIT.' tiene Traslados';
									foreach ($Concepto->xpath('cfdi:Impuestos//cfdi:Traslados//cfdi:Traslado') as $TrasladoPartida) {
			           					if($version ==  '3.2'){
							            	$base='';
							            	$parImpuesto='';
							            	$parTipoFact='';
							            	$parTasaCuota='';
							            	$parImpImporte='';
							           		$partidaImp[]=array($base, $parImpuesto, $parTipoFact, $parTasaCuota, $parImpImporte); 
						            	}elseif($version =='3.3'){
						            		$base = $TrasladoPartida['Base'];
							            	$parImpuesto= $TrasladoPartida['Impuesto'];
							            	$parTipoFact = $TrasladoPartida['TipoFactor'];
							            	$parTasaCuota = $TrasladoPartida['TasaOCuota'];
							            	$parImpImporte = $TrasladoPartida['Importe'];
							            	$tipoImp = 'Traslado';
							            	$partidaImp[]=array($base, $parImpuesto, $parTipoFact, $parTasaCuota, $parImpImporte, $tipoImp, $parIT); 
						            	}
			           					//echo '<br/>Impuesto: '.$a.' base='.$b.' tipo: '.$tipo.' de la partida: '.$parIT.'<br/>';
			           				}
			           			}else{
			           				//echo '<br/> La partida '.$parIT.' No tiene Traslados<br/>';
			           			}
			           			if($Concepto->xpath('cfdi:Impuestos//cfdi:Retenciones')){
			           				//echo '<br/> La partida '.$parIT.' tiene Retenciones<br/>';
			           				foreach ($Concepto->xpath('cfdi:Impuestos//cfdi:Retenciones//cfdi:Retencion') as $RetencionPartida) {
			           					if($version ==  '3.2'){
							            	$base='';
							            	$parImpuesto='';
							            	$parTipoFact='';
							            	$parTasaCuota='';
							            	$parImpImporte='';
							           		$partidaImp[]=array($base, $parImpuesto, $parTipoFact, $parTasaCuota, $parImpImporte); 
						            	}elseif($version =='3.3'){
						            		$base = $RetencionPartida['Base'];
							            	$parImpuesto= $RetencionPartida['Impuesto'];
							            	$parTipoFact = $RetencionPartida['TipoFactor'];
							            	$parTasaCuota = $RetencionPartida['TasaOCuota'];
							            	$parImpImporte = $RetencionPartida['Importe'];
							            	$tipoImp = 'Retencion';
							            	$partidaImp[]=array($base, $parImpuesto, $parTipoFact, $parTasaCuota, $parImpImporte, $tipoImp, $parIT); 
						            	}
			           					//echo '<br/>Impuesto: '.$a.' base='.$b.' tipo: '.$tipo.' de la partida: '.$parIT.'<br/>';
			           				}
			           			}else{
			           				//echo '<br/> La partida '.$parIT.' no tiene Retenciones<br/>';
			           			}
			           		}else{
			           			//echo 'La partida '.$parIT.' no Tiene impuestos<br/>';
			           		}
			            
			           		if($Concepto->xpath('cfdi:InformacionAduanera')){
			          			foreach ($Concepto->xpath('cfdi:InformacionAduanera') as $infoAdu) {
			          				if($version == '3.2'){
			          					$numPed = $infoAdu['NumeroPedimento'];
			          					$fechaPed = isset($infoAdu['fechaPedimento'])? $infoAdu['fechaPedimento']:'01.01.1909';
			          					$parInfoAduana[]=array($numPed, $parIT, $fechaPed, $cantiPed, $descripcion);
			          				}elseif($version == '3.3'){
			          					$numPed = $infoAdu['NumeroPedimento'];
			          					$fechaPed = isset($infoAdu['fechaPedimento'])? $infoAdu['fechaPedimento']:'01.01.1909';
			          					$cantiPed = isset($infoAdu['cantidad'])? $infoAdu['cantidad']:$cantidad; 
			          					$parInfoAduana[]=array($numPed, $parIT, $fechaPed, $cantiPed, $descripcion);
			          				}
			          			}
			          		}
			          		if($Concepto->xpath('cfdi:Parte')){
			          			foreach ($Concepto->xpath('cfdi:Parte') as $parte){
			          				if($version == '3.2'){
			          					$parte_unidad = $Concepto['unidad'];
				            			$parte_importe = $Concepto['importe'];
				            			$parte_cantidad = $Concepto['cantidad'];
				            			$parte_descripcion = htmlentities($Concepto['descripcion']);
				            			$parte_valor = $Concepto['valorUnitario'];
				            			$parte_claveSat='';
				            			$parte_claveUni='';
				            			$parte_partida[] =array($parte_unidad, $parte_importe, $parte_cantidad, $parte_descripcion, $parte_valor,$parte_claveSat, $parte_claveUni, $parIT);
			          				}elseif($version == '3.3'){
			          					$parte_unidad = $Concepto['Unidad'];
				            			$parte_importe = $Concepto['Importe'];
				            			$parte_cantidad = $Concepto['Cantidad'];
				            			$parte_descripcion = htmlentities($Concepto['Descripcion']);
				            			$parte_valor = $Concepto['ValorUnitario'];
				            			$parte_claveSat=$Concepto['ClaveProdServ'];
				            			$parte_claveUni=$Concepto['ClaveUnidad'];
				            			$parte_descp = isset($Concepto['Descuento'])? $Concepto['Descuento']:0;
				            			$parte_partida[]=array($parte_unidad, $parte_importe, $parte_cantidad, $parte_descripcion, $parte_valor, $parte_claveSat, $parte_claveUni, $parte_descp, $parIT); 
			            			}
			          			}
			          		}

			            }
			          	//// Revisamos si tiene el nodo Pago  $xml->xpath('//impl:ImpuestosLocales//impl:TrasladosLocales'
			          	$pago = array();
			          	$pagoDetalle=array();
			          	if($xml->xpath('//p10:Pagos')){
			          		foreach ($xml->xpath('//p10:Pagos') as $pg){
			          			foreach ($pg->xpath('//pago10:Pago') as $pggen){
			          				$fechaPago =isset($pggen['FechaPago'])? $pggen['FechaPago']:'01.01.1999';
			          				$formaPago =isset($pggen['FormaDePagoP'])? $pggen['FormaDePagoP']:'';
			          				$mondedaPago =isset($pggen['MonedaP'])? $pggen['MonedaP']:'';
			          				$monto =isset($pggen['Monto'])? $pggen['Monto']:0;
			          				$numOperacion =isset($pggen['NumOperacion'])? $pggen['NumOperacion']:'';
			          				$rfcEmisorCtaOrd =isset($pggen['rfcEmisorCtaOrd'])? $pggen['rfcEmisorCtaOrd']:'';
 			          				$ctaOrdenante =isset($pggen['CtaOrdenante'])? $pggen['CtaOrdenante']:'';
			          				$rfcEmisorCtaBen=isset($pggen['RfcEmisorCtaBen'])? $pggen['RfcEmisorCtaBen']:'';
			          				$ctaBeneficiario=isset($pggen['CtaBeneficiario'])? $pggen['CtaBeneficiario']:'';
			          				$pago[]=array("fechaPago"=>$fechaPago,"formaPago"=>$formaPago,"mondedaPago"=>$mondedaPago,"monto"=>$monto,"numOperacion"=>$numOperacion,"rfcEmisorCtaOrd"=>$rfcEmisorCtaOrd,"ctaOrdenante"=>$ctaOrdenante,"rfcEmisorCtaBen"=>$rfcEmisorCtaBen,"ctaBeneficiario"=>$ctaBeneficiario);
			          			}
			          			foreach ($pg->xpath('//pago10:DoctoRelacionado') as $pgdet){
			          				$idDocumento =isset($pgdet['IdDocumento'])? $pgdet['IdDocumento']:''; 
			          				$serie =isset($pgdet['Serie'])? $pgdet['Serie']:''; 
			          				$folio =isset($pgdet['Folio'])? $pgdet['Folio']:''; 
			          				$monedaDr =isset($pgdet['MonedaDR'])? $pgdet['MonedaDR']:''; 
			          				$metodoPago =isset($pgdet['MetodoDePagoDR'])? $pgdet['MetodoDePagoDR']:''; 
			          				$numParcialidad =isset($pgdet['NumParcialidad'])? $pgdet['NumParcialidad']:1; 
			          				$impSaldoAnt =isset($pgdet['ImpSaldoAnt'])? $pgdet['ImpSaldoAnt']:0; 
			          				$impPago =isset($pgdet['ImpPagado'])? $pgdet['ImpPagado']:0; 
			          				$impSaldoIns =isset($pgdet['ImpSaldoInsoluto'])? $pgdet['ImpSaldoInsoluto']:0; 
			          				$pagoDetalle[]=array('idDocumento'=>$idDocumento,'serie'=>$serie,'folio'=>$folio,'monedaDr'=>$monedaDr,'metodoPago'=>$metodoPago,'numParcialidad'=>$numParcialidad,'impSaldoAnt'=>$impSaldoAnt,'impPago'=>$impPago,'impSaldoIns'=>$impSaldoIns);
			          			}
			          		}
			          	}
			            //// Obtenemos las retenciones de los impuestos:
			            foreach ($xml->xpath('//cfdi:Comprobante//cfdi:Impuestos') as $Timp){	
			            	if($version == '3.2'){
				            	$titra=0.00;
					            $tiret=0.00;
				            }elseif($version == '3.3'){
				            	$titra= isset($Timp['TotalImpuestosTrasladados'])? $Timp['TotalImpuestosTrasladados']:0;
					            $tiret= isset($Timp['TotalImpuestosRetenidos'])? $Timp['TotalImpuestosRetenidos']:0;
				            }
				            //var_dump($Traslado);   	
			               //$impuesto = $Traslado['impuesto']; 
			            }

			            //HASTA AQUI TODA LA INFORMACION ES LEIDA E IMPRESA CORRECTAMENTE
			            //ESTA ULTIMA PARTE ES LA QUE GENERA ERROR, AL PARECER NO ENCUENTRA EL NODO
			            foreach ($xml->xpath('//t:TimbreFiscalDigital') as $tfd) {
			               if($version == '3.2'){
			               		$fecha = $tfd['FechaTimbrado']; 
			               		$fecha = str_replace("T", " ", $fecha); 
			               		$uuid = $tfd['UUID'];
			               		$noNoCertificadoSAT = $tfd['noCertificadoSAT'];
			               		$RfcProvCertif=$tfd['RfcProvCertif'];
			               		$SelloCFD=$tfd['selloCFD'];
			               		$SelloSAT=$tfd['selloSAT'];
			               		$version = $tfd['version'];
			               		$rfcprov = empty($tfd['RfcProvCertif'])? '':$tfd['RfcProvCertif'];
			               }else{
			               		$fecha = $tfd['FechaTimbrado']; 
			               		$fecha = str_replace("T", " ", $fecha); 
			               		$uuid = $tfd['UUID'];
			               		$noNoCertificadoSAT = $tfd['NoCertificadoSAT'];
			               		$RfcProvCertif=$tfd['RfcProvCertif'];
			               		$SelloCFD=$tfd['SelloCFD'];
			               		$SelloSAT=$tfd['SelloSAT'];
			               		$version = $tfd['Version'];
			               		$rfcprov = $tfd['RfcProvCertif'];
			               }
			            }
			            /*
			            foreach ($xml->xpath() as $key => $value) {
			            	# code...
			            }
			            */
			            if(empty($descuento)){
			            	$descuento = 0;
			            }
			            ///foreach($xml->xpath('//cfdi:Comprobante//cfdi:CfdiRelacionados//cfdi:CfdiRelacionado//') as $rel){
			            ///	if($version == '3.2'){
			            ///		$relacion= '';
			            ///	}elseif($version == '3.3'){
			            ///		$relacion= $rel['Rfc'];
			            ///		$nombre_recep=$Receptor['Nombre'];
			            ///		$usoCFDI =$Receptor['UsoCFDI'];
			            ///	 }
			            ///}
			            if($tipo2 == 'F'){
			            	$this->query = "INSERT INTO XML_DATA (UUID, CLIENTE, SUBTOTAL, IMPORTE, FOLIO, SERIE, FECHA, RFCE, DESCUENTO, STATUS, TIPO, NOCERTIFICADOSAT, SELLOCFD, SELLOSAT, FECHATIMBRADO, CERTIFICADO, SELLO, versionSAT, no_cert_contr, rfcprov,formaPago, LugarExpedicion, metodoPago, moneda, TipoCambio, FILE, USO, RELACION, ID_RELACION)";
				            $this->query.= "VALUES ('$uuid', '$rfc', '$subtotal', '$total', '$folio', '$serie', '$fecha', '$rfce', $descuento, 'S', '$tipo', '$noNoCertificadoSAT', '$SelloCFD', '$SelloSAT', '$fecha','$Certificado', '$Sello', '$version', '$noCert', '$rfcprov', '$formaPago', '$LugarExpedicion', '$MetodoPago', '$moneda', $tc, '$archivo','$usoCFDI', '',null )";
				            //echo "<p>query: ".$this->query."</p>";
							//$respuesta = $this->grabaDB();
							if($respuesta = @$this->grabaBD() === false){
								//echo 'error'.$archivo;
								$this->query="DELETE FROM XML_DATA_FILES WHERE nombre = '$archivo'";
								$this->grabaBD();

            					$this->query="INSERT INTO XML_EXCEPCION (ID, UUID, TIPO) VALUES (NULL, '$archivo', 'X')";
            					$this->grabaBD();

            					return;
							}
							/// creamos el folder para el movimiento de las facturas a nuestro sistema. 
				            if($rfce == 'FPE980326GH9'){
                                copy($archivo, "C:\\xampp\\htdocs\\Facturas\\facturaPegaso\\".$serie.$folio.".xml");    
                            }else{
                            	if($rfce == $rfcEmpresa){
                            		$carpeta = 'Emitidos';
                            		$carpeta2= $rfc;
                            	}else{
                            		$carpeta = 'Recibidos';
                            		$carpeta2= $rfce;
                            	}
                            	$path='C:\\xampp\\htdocs\\uploads\\xml\\'.$rfcEmpresa.'\\'.$carpeta.'\\'.$carpeta2;
                            	//echo '<br/>'.$path.'<br/>';
                            	if(is_dir($path)){
                            		//echo '<br/> El directorio existe<br/>';
                            	}else{
                            		//echo '<br/> El Direcotirio no existe y se debe de crear<br/>';
                            		mkdir($path,0777, true);
                            	}
                                   copy($archivo, $path.'\\'.$rfce.'-'.utf8_encode($serie).utf8_encode($folio).'-'.$uuid.".xml");
                            }

                            /// Insertamos en la tabla de CFIDsss

                            $this->query="UPDATE FTC_FACTURAS SET UUID = '$uuid' WHERE SERIE='$serie' AND FOLIO='$folio'";
                            $this->EjecutaQuerySimple();
				            $i=1;
				            //echo 'Valor del arreglo'.var_dump($impuestos);
				            //echo '<br/>'.count($partidaImp).'<br/>';
							if(count($partidaImp)<0){
								//echo $uuid.' --- '.$tipo.'  ---<br/>';
							}else{
								foreach ($partidaImp as $key){
									$base = empty($key[0])? 0:$key[0];;
					            	$nombre = $key[1];
					            	$tasa = $key[3];
					            	$importe = empty($key[4])? 0:$key[4];
					            	$tipoFactor = $key[2];
					            	$tipoImp = $key[5];
					            	$pi = $key[6];
					            	//$partidaImp[]=array($base, $parImpuesto, $parTipoFact, $parTasaCuota, $parImpImporte); 
					            	$this->query = "INSERT INTO XML_IMPUESTOS values (null,'$nombre', '$tasa', $importe, $pi, '$uuid', ('$serie'||'-'||'$folio'), '$tipoFactor', $base, '$tipoImp')";
					            	if($rs=$this->grabaBD() === false){
					            		echo 'Fallo al insertar en la tabla de impuestos <br/>'; 
					            		echo $this->query.'<br/>';
					            	}          
					            	$i=$i+1;	
								//echo $this->query;
								}
							}

							if($xml->xpath('//impl:ImpuestosLocales//impl:TrasladosLocales')){
								foreach ($xml->xpath('//impl:ImpuestosLocales//impl:TrasladosLocales') as $il){
				            		//echo '<br/><br/>'.print_r($il).'<br/>'.$version;
				            		$iltrasN= isset($il['ImpLocTrasladado'])? $il['ImpLocTrasladado']:'';
						        	//$ilretImp= isset($il['Impuesto'])? $il['Impuesto']:'';
						        	$iltrasM= isset($il['Importe'])? $il['Importe']:0;
						        	$ilretM= isset($il['Importe'])? $il['Importe']:0;
						        	$iltrasF= isset($il['TipoFactor'])? $il['TipoFactor']:'';
						        	$ilretF= isset($il['TipoFactor'])? $il['TipoFactor']:'';
				            		$this->query="INSERT INTO XML_IMPUESTOS values (null,'$iltrasN', '', $iltrasM, $pi + 1, '$uuid', ('$serie'||'-'||'$folio'), '$iltrasF', 0, 'local')";
				            		if($rs=$this->grabaBD() === false){
					            		echo 'Fallo al insertar en la tabla de impuestos <br/>'; 
					            		echo $this->query.'<br/>';
					            	}
			            		}	
							}
				            //echo 'Valor del arrego partida'.var_dump($partida);
				            $i=1;
				            foreach ($partida as $data){
				            	$unidad = str_replace(array("'", "<code>"),' ',$data[0]);
				            	$importe = $data[1];
				            	$cantidad = $data[2];
				            	//$descripcion = str_replace(array("\\", "¨", "º", "-", "~",
								//             "#", "@", "|", "!", "\"",
								//             "·", "$", "%", "&", "/",
								//             "(", ")", "?", "'", "¡",
								//             "¿", "[", "^", "<code>", "]",
								//             "+", "}", "{", "¨", "´",
								//             ">", "< ", ";", ",", ":",
								//             ".", " "),' ',$data[3]);
				            	$descripcion = str_replace(array("'", "<code>"),' ',$data[3]);
				            	$unitario=$data[4];
				            	$cvesat = $data[5];
				            	$unisat = $data[6];
				            	$descp = empty($data[7])? 0:$data[7];
				            	$this->query = "INSERT INTO XML_PARTIDAS (id, unidad, importe, cantidad, partida, descripcion, unitario, uuid, documento, cliente_SAE, rfc, fecha, descuento, cve_art, cve_clpv, unitario_original, CLAVE_SAT, UNIDAD_SAT) values (null, '$unidad', $importe, $cantidad, $i, '$descripcion', $unitario, '$uuid', ('$serie'||'-'||'$folio'), '', '$rfc', '$fecha', $descp, '', '', $unitario, '$cvesat','$unisat')";
				            	if($rs=$this->grabaBD() === false){
				            		echo 'Falla al insertar la partida:<br/>';
				            		echo $this->query.'<br/>';
				            	}          
				            	$i=$i+1;
			            	}

			            	if(count($parte_partida) > 0){
			            		foreach ($parte_partida as $pp ){
			            			$parte_unidad = $pp[0];
					            	$parte_importe = $pp[1];
					            	$parte_cantidad = $pp[2];
					            	//$descripcion = str_replace(array("\\", "¨", "º", "-", "~",
									//             "#", "@", "|", "!", "\"",
									//             "·", "$", "%", "&", "/",
									//             "(", ")", "?", "'", "¡",
									//             "¿", "[", "^", "<code>", "]",
									//             "+", "}", "{", "¨", "´",
									//             ">", "< ", ";", ",", ":",
									//             ".", " "),' ',$pp[3]);
					            	$parte_descripcion = str_replace(array("'", "<code>"),' ',$pp[3]);
					            	$parte_unitario=$pp[4];
					            	$parte_cvesat = $pp[5];
					            	$parte_unisat = $pp[6];
					            	$parte_descp = empty($pp[7])? 0:$pp[7];
					            	$parte_pi= $pp[8];
					            	//var_dump($parte_partida);
					            	$this->query = "INSERT INTO XML_PARTIDAS_PARTE (id, unidad, importe, cantidad, partida, descripcion, unitario, uuid, documento, cliente_SAE, rfc, fecha, descuento, cve_art, cve_clpv, unitario_original, CLAVE_SAT, UNIDAD_SAT) values (null, '$parte_unidad', $parte_importe, $parte_cantidad, $parte_pi, '$parte_descripcion', $parte_unitario, '$uuid', ('$serie'||'-'||'$folio'), '', '$rfc', '$fecha', $parte_descp, '', '', $parte_unitario, '$parte_cvesat','$parte_unisat')";
					            	if($rs=$this->grabaBD() === false){
					            		echo 'Falla al insertar la partida informacion de parte:<br/>';
					            		echo $this->query.'<br/>';
					            	}   	
			            		}       
			            	}

			            	if(count($parInfoAduana)>0){
			            		foreach ($parInfoAduana as $pia){
			            			$pia_pedimento = $pia[0];
			            			$pia_par=$pia[1];
			            			$pia_fecha = $pia[2];
			            			$pia_cantidad = $pia[3];
			            			$pia_descripcion = str_replace(array("'", "<code>"),' ',$pia[4]);
			            			$this->query="INSERT INTO XML_PARTIDA_INFO_ADUANA (ID, UUID, PARTIDA, PEDIMENTO, FECHA_PEDIMENTO, LOTE, FECHA_LOTE, CANTIDAD, DESCRIPCION) VALUES (NULL, '$uuid', $pia_par, '$pia_pedimento','$pia_fecha', '', null, $pia_cantidad, '$pia_descripcion' )";
			            			if($rs=$this->grabaBD() === false){
					            		echo 'Falla al insertar la partida informacion Aduanera :<br/>';
					            		echo $this->query.'<br/>';
					            	}
			            		}
			            	}

			            	if(count($pago)>0){
			            		foreach ($pago as $keyPago){
			            			///$pago[]=array("fechaPago"=>$fechaPago,"formaPago"=>$formaPago,"mondedaPago"=>$mondedaPago,"monto"=>$monto,"numOperacion"=>$numOperacion,"rfcEmisorCtaOrd"=>$rfcEmisorCtaOrd,"ctaOrdenante"=>$ctaOrdenante,"rfcEmisorCtaBen"=>$rfcEmisorCtaBen,"ctaBeneficiario"=>$ctaBeneficiario);
			            			$fpa = $keyPago['fechaPago'];
			            			$fmpa = $keyPago['formaPago'];
			            			$monpa =$keyPago['mondedaPago'];
			            			$motpa = $keyPago['monto'];
			            			$numpa =$keyPago['numOperacion'];
			            			$rfcord =$keyPago['rfcEmisorCtaOrd'];
			            			$ctaord = $keyPago['ctaOrdenante'];
			            			$rfcben = $keyPago['rfcEmisorCtaBen'];
			            			$ctaben =$keyPago['ctaBeneficiario'];
			            			$this->query="INSERT INTO XML_COMPROBANTE_PAGO (ID, UUID, FECHA, FORMA, MONEDA, MONTO, NUMOPERACION, RFC_BANCO_ORDENANTE, CTA_ORDENANTE, RFC_BANCO_BENEFICIARIO, CTA_BENEFICIARIO, STATUS) VALUES (NULL,'$uuid', '$fpa', '$fmpa', '$monpa', $motpa, '$numpa', '$rfcord', '$ctaord', '$rfcben', '$ctaben', 'P')";
			            			$this->grabaBD();
			            		}
			            	}

			            	if(count($pagoDetalle)>0){
			            		//$pagoDetalle[]=array('idDocumento'=>$idDocumento,'serie'=>$serie,'folio'=>$folio,'monedaDr'=>$monedaDr,'metodoPago'=>$metodoPago,'numParcialidad'=>$numParcialidad,'impSaldoAnt'=>$impSaldoAnt,'impPago'=>$impPago,'impSaldoIns'=>$impSaldoIns);
								foreach ($pagoDetalle as $keyPD){
									$idDocumento = $keyPD['idDocumento'];
									$serie = $keyPD['serie'];
									$folio = $keyPD['folio'];
									$monedaDr = $keyPD['monedaDr'];
									$metodoPago = $keyPD['metodoPago'];
									$numParcialidad = $keyPD['numParcialidad'];
									$impSaldoAnt = $keyPD['impSaldoAnt'];
									$impPago = $keyPD['impPago'];
									$impSaldoIns = $keyPD['impSaldoIns'];
			            			$this->query="INSERT INTO XML_COMPROBANTE_PAGO_DETALLE (ID, ID_DOCUMENTO,SERIE,FOLIO,	MONEDA,METODO_PAGO,NUM_PARCIALIDAD,SALDO,PAGO,SALDO_INSOLUTO,STATUS, UUID_PAGO) VALUES ( null, '$idDocumento', '$serie', '$folio', '$monedaDr', '$metodoPago', $numParcialidad, $impSaldoAnt, $impPago, $impSaldoIns, 'P', '$uuid')";
			            			$this->grabaBD();
			            		}
								
			            	}

							if($xml->xpath('//cfdi:CfdiRelacionados')){
        	    				foreach ($xml->xpath('//cfdi:CfdiRelacionados') as $rel){
    	        					$tipoRelacion = isset($rel['TipoRelacion'])? $rel['TipoRelacion']:'';
    	        					foreach ($rel->xpath('//cfdi:CfdiRelacionado') as $docRel){
    	        						$docUUID = isset($docRel['UUID'])? $docRel['UUID']:'';
    	        						$this->query = "INSERT INTO XML_RELACIONES (ID, UUID, TIPO, UUID_DOC_REL) VALUES (NULL, '$uuid', '$tipoRelacion', '$docUUID')";
    	        						$this->grabaBD();
    	        					}
    	        				}
	            			}
	
			            	$this->calcularImpuestos($uuid);
			            }elseif($tipo2 == 'C'){
			            	$this->query = "INSERT INTO XML_DATA_CANCELADOS (UUID, CLIENTE, SUBTOTAL, IMPORTE, FOLIO, SERIE, FECHA, RFCE, DESCUENTO, STATUS, TIPO, FILE )";
				            $this->query.= "VALUES ('$uuid', '$rfc', '$subtotal', '$total', '$folio', '$serie', '$fecha', '$rfce', $descuento, 'C', '$tipo2', '$archivo')";
				            //echo "<p>query: ".$this->query."</p>";
							//$respuesta = $this->grabaDB();
							$respuesta = $this->grabaBD();
			            }
			        }	
			        //return;// $respuesta;
    		}
    		
    		if($tipo == 'N'){
    			$this->query="UPDATE XML_DATA_FILES SET TIPO = 'N' WHERE nombre = '$archivo'";
    			$this->queryActualiza();

    			foreach ($xml->xpath('//cfdi:Comprobante//cfdi:Receptor') as $Receptor){
    				foreach ($xml->xpath('//cfdi:Comprobante//cfdi:Receptor') as $Receptor) {
			            	if($version == '3.2'){
			            		$rfc= $Receptor['rfc'];
			           		 	$nombre_recep = utf8_encode($Receptor['nombre']);
			            		$usoCFDI = '';
			            	}elseif($version == '3.3'){
			            		$rfc= $Receptor['Rfc'];
			            		$nombre_recep=utf8_encode($Receptor['Nombre']);
			            		$usoCFDI =$Receptor['UsoCFDI'];
			            	 }
			    			$this->query="INSERT INTO XML_EMPLEADOS (IDE, RFC, NOMBRE, USOCFDI ) VALUES (NULL, '$rfc', '$nombre_recep', '$usoCFDI')";
			    			$this->grabaBD();
			        }
			        foreach ($xml->xpath('//cfdi:Comprobante//cfdi:Complemento//nomina12:Receptor') as $Nomina12Receptor) {
			            	if($version == '3.2'){
			            		$rfc= $Nomina12Receptor['rfc'];
			           		 	$nombre_recep = $Nomina12Receptor['nombre'];
			            		$usoCFDI = '';
			            	}elseif($version == '3.3'){
			            		$curp= $Nomina12Receptor['Curp'];
			            		$numss=$Nomina12Receptor['NumSeguridadSocial'];
			            		$FechaInicioRelLaboral =$Nomina12Receptor['FechaInicioRelLaboral'];
			            		$Antiguedad=$Nomina12Receptor['Antigüedad']; 
								$TipoContrato=$Nomina12Receptor['TipoContrato'];
								$Sindicalizado=$Nomina12Receptor['Sindicalizado'];
								$TipoJornada=$Nomina12Receptor['TipoJornada'];
								$TipoRegimen=$Nomina12Receptor['TipoRegimen'];
								$NumEmpleado= $Nomina12Receptor['NumEmpleado'];
								$Departamento= $Nomina12Receptor['Departamento'];
								$Puesto= $Nomina12Receptor['Puesto'];
								$RiesgoPuesto= $Nomina12Receptor['RiesgoPuesto'];
								$PeriodicidadPago= $Nomina12Receptor['PeriodicidadPago'];
								$SalarioBaseCotApor= $Nomina12Receptor['SalarioBaseCotApor'];
								$SalarioDiarioIntegrado= $Nomina12Receptor['SalarioDiarioIntegrado'];
								$ClaveEntFed=$Nomina12Receptor['ClaveEntFed'];
			            	 }
			    			$this->query="INSERT INTO XML_NOMINA_RECEPTOR (ID, CURP, NumSeguridadSocial, 
			    										FechaInicioRelLaboral,
			    										Antiguedad, 
														TipoContrato, 
														Sindicalizado, 
														TipoJornada, 
														TipoRegimen, 
														NumEmpleado, 
														Departamento, 
														Puesto, 
														RiesgoPuesto, 
														PeriodicidadPago, 
														SalarioBaseCotApor, 
														SalarioDiarioIntegrado, 
														ClaveEntFed, 
														Archivo
			    										 ) 
			    					VALUES (NULL, '$curp', '$numss', '$FechaInicioRelLaboral',
			    								'$Antiguedad', 
												'$TipoContrato', 
												'$Sindicalizado', 
												'$TipoJornada', 
												'$TipoRegimen', 
												'$NumEmpleado', 
												'$Departamento', 
												'$Puesto', 
												'$RiesgoPuesto', 
												'$PeriodicidadPago', 
												'$SalarioBaseCotApor', 
												'$SalarioDiarioIntegrado', 
												'$ClaveEntFed',
												'$archivo'
												)";
			    			$this->grabaBD();
			        }

    			}
    		}

    		if($tipo2 == 'C'){
       
            	foreach ($data as $row):
            	    $file = $row->NOMBRE;
            	endforeach;
	
	            	$myFile = fopen("$file", "r") or die("No se ha logrado abrir el archivo ($file)!");
	            	$myXMLData = fread($myFile, filesize($file));
	            	//exit(print_r($file));
	            	$xml = simplexml_load_string($myXMLData) or die("Error: No se ha logrado crear el objeto XML ($file)");
	            	//$xml = simplexml_load_string($myFile) or die("Error: No se ha logrado crear el objeto XML ($file)");
	            	
	            	$ns = $xml->getNamespaces(true);
	            	foreach ($xml->xpath('//CancelaCFDResult') as $acuse){
	            	    $fecha = substr($acuse['Fecha'],0,19);    
	            	    $rfc = $acuse['RfcEmisor'];
	            	}
	            	
	            	foreach ($xml->Folios as $fol) {
	            	    $UUID= $fol->UUID;
	            	    $estadoUUID=$fol->EstatusUUID;
	            	}
	            	foreach ($xml->Signature as $signature) {
	            	    $signatureValue= $signature->SignatureValue;
	            	    $digestValue=$signature->SignedInfo->Reference->DigestValue;
	            	}
	            	$this->query="INSERT INTO XML_CANCEL_DET (ID, FECHA, RFCEMISOR, STATUS_UUID, UUID, SIGNATUREVALUE, DIGESTVALUE, EXPONENT) 
	            	        VALUES (NULL, '$fecha', '$rfc', '$estadoUUID', '$UUID', '$signatureValue', '$digestValue', '$exponent')";
            	$this->EjecutaQuerySimple();
	            //echo $this->query;
	            //$this->query="DELETE FROM XML_DATA_files WHERE NOMBRE = 'C:/xampp/htdocs/uploads/xml/cancelados/FPE980326GH9-CAN-FRF912.xml'";
	            //s$this->EjecutaQuerySimple();
            	exit($UUID);
        	}


        return;
     }

    function calcularImpuestos($uuid){
    	$data=array();
    	if(strlen($uuid)>=5){
    		$uuid = " and uuid ='".$uuid."'";
    	}else{
    		$uuid = '';
    	}	

    	$this->query="SELECT  *  FROM XML_DATA  WHERE STATUS = 'S' $uuid  ";
    	$rs=$this->EjecutaQuerySimple();
    	//echo $this->query;
    	while ($tsArray=ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	foreach ($data as $key) {
    		$data2 = array();
    		$this->query="SELECT IMPUESTO, rpad(tasa, 8, '0') as TASA, SUM(MONTO) as monto, TIPOFACTOR,  tipo FROM XML_IMPUESTOS I WHERE I.UUID = '$key->UUID' group by IMPUESTO, TASA, TIPOFACTOR, tipo";
    		$res = $this->EjecutaQuerySimple();
    		//echo '<br/>'.$this->query.'<br/>';
    		while ($tsArray2 = ibase_fetch_object($res)) {
				$data2[]=$tsArray2;    			
    		}

    		if(count($data2) > 0){
    			foreach ($data2 as $row) {
    				$impuesto =$row->IMPUESTO;
    				$monto = $row->MONTO;
    				$tipo = $row->TIPOFACTOR;
    				$TASA = $row->TASA;
    				if($tipo == 'Tasa'){
    					//echo  '<br/>TASA: '.$TASA.'<br/>';
    					$tasa = $TASA == '0.000000'? '000':substr($TASA, 2, 3);
    				}elseif($tipo == 'Cuota'){
    					$tasa = 'C';
    				}elseif($tipo == 'Exento'){
    					$tasa = '000';
    				}
    				//echo  '<br/>tasa: '.$tasa.'<br/>';
    				
    			if($impuesto == '002' and $row->TIPO == 'Traslado'){/// IVA
    				$campo = 'IVA'.$tasa; /// Aqui debemos de diferenciar del trasladado al retenido.	
    			}elseif($impuesto == '003' and $row->TIPO == 'Traslado'){//// IEPS  Aqui debemos de diferenciar del trasladado al retenido.
    				$campo = 'IEPS'.$tasa;
    			}elseif($impuesto == '001' and $row->TIPO == 'Traslado'){/// ISR  Siempre es Retencion.
    				$campo = 'ISR'.$tasa;
    			}elseif($impuesto == '001' and $row->TIPO == 'Retencion'){
    				$campo = 'ISR_RET';
    			}elseif($impuesto == '002' and $row->TIPO == 'Retencion'){
    				$campo = 'IVA_RET';
    			}elseif($impuesto == '003' and $row->TIPO == 'Retencion'){
    				$campo = 'IEPS_RET';
    			}
    			//exit('Este es el campo donde se pretende al actualizacion'.$campo);
    			$this->query="UPDATE XML_DATA SET $campo = $monto where UUID = '$key->UUID'";
    			//echo '<br/>Error al guardar: <br/>'.$this->query;
    			$result=$this->queryActualiza();
    			//print_r($result);
    			if($result < 1){
    				echo '<br/>Error al guardar Impuesto: <br/>'.$this->query;
    				$this->query="INSERT INTO XML_EXCEPCION (ID, UUID, TIPO) VALUES (NULL, '$key->UUID', 'IMP')";
    				if($this->grabaBD()){
    	
    				}else{
    					echo '<br/>Error al guardar: <br/>'.$this->query;
    				}
    			}elseif($result >= 1){
    				$this->query="UPDATE XML_DATA SET STATUS = 'P'  WHERE UUID = '$key->UUID'";
	    			$this->queryActualiza();
    			}
    			unset($data2);
	    		}
    		}
    	}
    }

    function resumenCxC(){
    	//$this->query="SELECT count(id), status_recepcion from cajas group by status_recepcion";
    	$data=array();
    	$tipoUsuario = $_SESSION['user']->LETRA;
    	if(substr($tipoUsuario,0,1) == 'R'){
    		$cr = " where m.cartera_revision = '".$tipoUsuario."' ";
    	}elseif(substr($tipoUsuario,0,1) == 'C'){
			$cr = " where m.cartera = '".$tipoUsuario."' ";
    	}else{
    		$cr = '';
    	}
    	$this->query="SELECT count(s.id) as documentos, s.status_recepcion from status_caja s left join maestros m on m.clave = s.maestro $cr group by status_recepcion";
    	$rs=$this->EjecutaQuerySimple();
    	//echo $this->query;
    	while ($tsArray = ibase_fetch_object($rs)) {
    		$data[]=$tsArray;
    	}
    	return $data;
    }

    function recDocRev($idc){
    	$usuario=$_SESSION['user']->NOMBRE;
    	$this->query="UPDATE CAJAS SET STATUS_RECEPCION = 61 WHERE ID = $idc ";
    	$rs=$this->queryActualiza();
    	if($rs == 1){
    		$this->query="SELECT max(status_orig) AS STATUS, MAX(documento) as factura FROM FTC_HISTORIA_CAJA WHERE CAJA = $idc";
    		$rs=$this->EjecutaQuerySimple();
    		$row=ibase_fetch_object($rs);
    		$statuso = $row->STATUS;
    		($statuso = '' or empty($statuso))? $statuso = 0:''; 
    		$this->query="INSERT INTO FTC_HISTORIA_CAJA (ID, status_orig, status_dest, fecha, usuario, caja, documento) 
    		values (null,$statuso, 61, CURRENT_TIMESTAMP, '$usuario', $idc, '$row->FACTURA')";
    		$this->grabaBD();
    		//echo $this->query;
    		$response = array("status"=>"ok", "mensaje"=>"Se Recibio el documento");
    	}else{
    		$response = array("status"=>"no", "mensaje"=>"Ocurrio un error favor de revisar");
    	}
    	return $response;
    }

    function buscaDocv($docv){
    	$data=array();
    	$this->query="SELECT * FROM CAJAS WHERE upper(FACTURA) containing upper('$docv') OR upper(REMISION) containing upper('$docv') or upper(observaciones) containing upper('$docv')";
    	$rs=$this->EjecutaQuerySimple();
    	while ($tsArray = ibase_fetch_object($rs)){
    		$data[]=$tsArray;
    	}
    	if(count($data)> 0){
    		foreach ($data as $key) {
	    		$caja = $key->ID;
	    		$fechaCaja = $key->FECHA_CREACION;
	    		$recepcion = $key->STATUS_RECEPCION;
	    		$logistica = $key->STATUS_LOG;
	    		$status = $key->STATUS;
	    		$fechaCierre =$key->FECHA_CIERRE;
	    		$response = array("st"=>'ok',"documento"=>$docv,"caja"=>$caja, "fechaCaja"=>$fechaCaja, "recepcion"=>$recepcion, "logistica"=>$logistica, "status"=>$status, "fechaCierre"=>$fechaCierre);
    		}	
    	}else{
    			$response = array("st"=>'no');
    	}
    	
    	return $response;
    }

    function verXMLSP($mes, $anio, $ide, $uuid, $doc){
    	$data=array();
    	if(!empty($uuid)){
    		$uuid = "and uuid = '".$uuid."'"; 
    	}elseif ($mes == 0 and $ide == 'Emitidos') {
    		$uuid = "and extract(year from cast(fechatimbrado as timestamp)) = ".$anio." and x.cliente != '".$_SESSION['rfc']."' and x.TIPO = '".$doc."'";
    	}elseif ($mes == 0 and $ide == 'Recibidos') {
    		$uuid = "and extract(year from cast(fechatimbrado as timestamp)) = ".$anio." and cliente = '".$_SESSION['rfc']."' and x.TIPO = '".$doc."'";
    	}elseif($ide == 'Emitidos'){
    		$uuid = "and extract(year from cast(fechatimbrado as timestamp)) = ".$anio." and extract(month from cast(fechatimbrado as timestamp))=".$mes." and x.cliente != '".$_SESSION['rfc']."' and x.TIPO = '".$doc."'";
    	}elseif($ide == 'Recibidos'){
    		$uuid = "and extract(year from cast(fechatimbrado as timestamp)) = ".$anio." and extract(month from cast(fechatimbrado as timestamp))=".$mes." and cliente = '".$_SESSION['rfc']."' and x.TIPO = '".$doc."'";
    	}
    	if($ide== 'Emitidos'){
					$this->query="SELECT x.importe  as importexml, x.* , cr.*, 
    					(IEPS030+ cast(IEPS000 as double precision)+ IEPS018+ IEPS020+ IEPS060+ IEPS250+ IEPS300+ IEPS600+ IEPS090+ IEPS304+ IEPS500+ IEPS530+ IEPS070+ IEPS080+ IEPS265+ IEPSC) AS IEPS, 
    					(select first 1 nombre from xml_clientes xc where xc.rfc = x.cliente) as nombre, 
    					(SELECT first 1 RAZON_SOCIAL FROM FTC_EMPRESAS WHERE rfc = rfce) as emisor,
    					(SELECT first 1 CUENTA_CONTABLE FROM XML_CLIENTES WHERE rfc = x.cliente and tipo = 'Cliente') as cuenta_Contable,
    					COALESCE( CAST((SELECT LIST(TIPO||trim(POLIZA)||' - '||PERIODO||'/'||EJERCICIO) FROM XML_POLIZAS XP WHERE XP.UUID = x.uuid and status='A') AS VARCHAR(100)),'') as poliza
    					,'' as tp_tes
    					, fecha_recep as fecha_edo_cta
						FROM XML_DATA x left join carga_pagos cr on cr.id = x.idpago WHERE (x.STATUS = 'P' OR x.STATUS  = 'S' or x.STATUS= 'D' or x.STATUS= 'I' or x.STATUS= 'E' or x.status ='F') $uuid";
    	}else{
    				$this->query="SELECT x.importe  as importexml, x.* , cr.*, 
    					(IEPS030+ cast(IEPS000 as double precision)+ IEPS018+ IEPS020+ IEPS060+ IEPS250+ IEPS300+ IEPS600+ IEPS090+ IEPS304+ IEPS500+ IEPS530+ IEPS070+ IEPS080+ IEPS265+ IEPSC) AS IEPS, 
    					(select first 1 nombre from xml_clientes where rfc = cliente) as nombre, 
    					(SELECT first 1 NOMBRE FROM XML_CLIENTES WHERE rfc = rfce) as emisor,
    					(SELECT first 1 CUENTA_CONTABLE FROM XML_CLIENTES WHERE rfc = rfce and tipo = 'Proveedor') as cuenta_Contable,
    					COALESCE( CAST((SELECT LIST(TIPO||trim(POLIZA)||' - '||PERIODO||'/'||EJERCICIO) FROM XML_POLIZAS XP WHERE XP.UUID = x.uuid and status='A') AS VARCHAR(100)),'') as poliza
						FROM XML_DATA x left join cr_directo cr on cr.id = x.idpago 
						WHERE (STATUS = 'P' OR STATUS  = 'S' or STATUS= 'D' or STATUS= 'I' or STATUS= 'E' or status = 'F') $uuid";
    	}
    	//echo $this->query;
    	$res=$this->EjecutaQuerySimple();
    	while($tsArray = ibase_fetch_object($res)){
    		$data[]=$tsArray;
    	}

    	return ($data);
    }

	function verXMLIngreso($uuid){
    	$data=array();
    	if(!empty($uuid)){
    		$uuid=explode(":", $uuid);
    		$tipo = $uuid[0];
  			if($tipo =='D'){
  				$documento=$uuid[1];
    			$uuid = " where f.documento containing('".$documento."')"; 
    			$uuid_nc = " where nc.documento containing('".$documento."')"; 

  			}elseif($tipo =='R'){
  				$fi = $uuid[1];
  				$ff = $uuid[3];
  				$uuid = " where f.fecha_doc between '".$fi."' and '".$ff."'";
  				$uuid_nc = " where nc.fecha_doc between '".$fi."' and '".$ff."'";
  			}elseif($tipo =='H'){
  				$uuid = '';
  			}elseif($tipo =='A'){
  				$documento=$uuid[1];
    			$uuid = " where c.cve_fact containing('".$documento."') or c.id containing('".$documento."') or c.remision containing('".$documento."')"; 
    			$uuid_nc = " where c.cve_fact containing('".$documento."') or c.id containing('".$documento."') or c.remision containing('".$documento."')"; 
  			}elseif($tipo == 'M'){
  				$documento=trim($uuid[1]);
  				$f=explode(" ", $documento);
  				$mes=strtoupper($f[0]);
  				$anio=$f[1];
  				$uuid= " where x.fecha between (SELECT FECHA_INI FROM PERIODOS_2016 WHERE upper(NOMBRE) = '".$mes."' and anhio = ".$anio.") and (SELECT FECHA_FIN FROM PERIODOS_2016 WHERE upper(NOMBRE) = '".$mes."' and anhio = ".$anio.")";
  				$uuid_nc= " where x.fecha between (SELECT FECHA_INI FROM PERIODOS_2016 WHERE upper(NOMBRE) = '".$mes."' and anhio = ".$anio.") and (SELECT FECHA_FIN FROM PERIODOS_2016 WHERE upper(NOMBRE)= '".$mes."' and anhio = ".$anio.")";
   			}
    	}else{
    		return $data;
    	}
    	$this->query="SELECT  x.uuid as uuid, f.*, x.*, f.status as stf, f.IVA as iva1, 'PF'||f.idcaja as PREFACT,
			(select c.cve_fact from cajas c where c.id = f.idcaja ),
			cast((select list(nc.documento) from ftc_nc nc where nc.idcaja = f.idcaja) as varchar(200)) as Notas,
			cl.nombre 
			from ftc_facturas f  
			left join xml_data x on f.documento = x.documento 
			--left join ftc_nc nc on nc.documento = x.documento
			left join clie01 cl on cl.clave_trim = f.cliente
			left join cajas C on c.id = f.idcaja
			$uuid
			order by f.fecha_doc";
		$res=$this->EjecutaQuerySimple();
    	while($tsArray = ibase_fetch_object($res)){
    		$data[]=$tsArray;
    	}

    	$this->query="SELECT x.uuid as uuid, nc.*,x.*,  nc.status as stf, nc.IVA as iva1, 'PF'||nc.idcaja as PREFACT,
			(select c.cve_fact from cajas c where c.id = nc.idcaja ),
			--cast((select list(nc.documento) from ftc_nc nc where nc.idcaja = nc.idcaja) as varchar(200)) as Notas,
			'' as notas,
			cl.nombre 
			from ftc_nc nc  
			left join xml_data x on nc.documento = x.documento 
			--left join ftc_nc nc on nc.documento = x.documento
			left join clie01 cl on cl.clave_trim = nc.cliente 
			left join cajas C on c.id = nc.idcaja
			$uuid_nc
			order by nc.fecha_doc";
			//echo $this->query.'<br/>';
    	$res=$this->EjecutaQuerySimple();
    	while($tsArray = ibase_fetch_object($res)){
    		$data[]=$tsArray;
    	}
    	return ($data);
    }

    
    function verXML($uuid){
    	$this->query="SELECT x.*,
    						(select RFCE FROM XML_DATA WHERE UUID = '$uuid') as RFC_E, 
    						(select descripcion from claves_sat where cve_prod_serv = CLAVE_SAT) as DescSAT,
    						(select sum(monto) from xml_impuestos xi where impuesto = '001' and xi.partida = x.partida and xi.uuid = x.uuid and xi.tipo='Traslado') as ISR,
    						(select sum(monto) from xml_impuestos xi where impuesto = '002' and xi.partida = x.partida and xi.uuid = x.uuid and xi.tipo='Traslado') as IVA, 
    						(select sum(monto) from xml_impuestos xi where impuesto = '003' and xi.partida = x.partida and xi.uuid = x.uuid and xi.tipo='Traslado') as IEPS,
     						(select TASA from xml_impuestos xi where impuesto = '001' and xi.partida = x.partida and xi.uuid = x.uuid and xi.tipo='Traslado') as TASA_ISR,
    						(select TASA from xml_impuestos xi where impuesto = '002' and xi.partida = x.partida and xi.uuid = x.uuid and xi.tipo='Traslado') as TASA_IVA, 
    						(select TASA from xml_impuestos xi where impuesto = '003' and xi.partida = x.partida and xi.uuid = x.uuid and xi.tipo='Traslado') as TASA_IEPS,
     						(select TIPOFACTOR from xml_impuestos xi where impuesto = '001' and xi.partida = x.partida and xi.uuid = x.uuid and xi.tipo='Traslado') as FACT_ISR,
    						(select TIPOFACTOR from xml_impuestos xi where impuesto = '002' and xi.partida = x.partida and xi.uuid = x.uuid and xi.tipo='Traslado') as FACT_IVA, 
    						(select TIPOFACTOR from xml_impuestos xi where impuesto = '003' and xi.partida = x.partida and xi.uuid = x.uuid and xi.tipo='Traslado')  as FACT_IEPS,
    						(select BASE from xml_impuestos xi where impuesto = '001' and xi.partida = x.partida and xi.uuid = x.uuid and xi.tipo='Traslado') as B_ISR,
    						(select BASE from xml_impuestos xi where impuesto = '002' and xi.partida = x.partida and xi.uuid = x.uuid and xi.tipo='Traslado') as B_IVA, 
    						(select BASE from xml_impuestos xi where impuesto = '003' and xi.partida = x.partida and xi.uuid = x.uuid and xi.tipo='Traslado') as B_IEPS,
    						(select sum(monto) from xml_impuestos xi where impuesto = '001' and xi.partida = x.partida and xi.uuid = x.uuid and xi.tipo='Retencion') as ISR_R,
    						(select sum(monto) from xml_impuestos xi where impuesto = '002' and xi.partida = x.partida and xi.uuid = x.uuid and xi.tipo='Retencion') as IVA_R, 
    						(select sum(monto) from xml_impuestos xi where impuesto = '003' and xi.partida = x.partida and xi.uuid = x.uuid and xi.tipo='Retencion') as IEPS_R,
    						(select TASA from xml_impuestos xi where impuesto = '001' and xi.partida = x.partida and xi.uuid = x.uuid and xi.tipo='Retencion') as TASA_ISR_R,
    						(select TASA from xml_impuestos xi where impuesto = '002' and xi.partida = x.partida and xi.uuid = x.uuid and xi.tipo='Retencion') as TASA_IVA_R, 
    						(select TASA from xml_impuestos xi where impuesto = '003' and xi.partida = x.partida and xi.uuid = x.uuid and xi.tipo='Retencion') as TASA_IEPS_R,
     						(select TIPOFACTOR from xml_impuestos xi where impuesto = '001' and xi.partida = x.partida and xi.uuid = x.uuid and xi.tipo='Retencion') as FACT_ISR_R,
    						(select TIPOFACTOR from xml_impuestos xi where impuesto = '002' and xi.partida = x.partida and xi.uuid = x.uuid and xi.tipo='Retencion') as FACT_IVA_R, 
    						(select TIPOFACTOR from xml_impuestos xi where impuesto = '003' and xi.partida = x.partida and xi.uuid = x.uuid and xi.tipo='Retencion') as FACT_IEPS_R,
    						(select BASE from xml_impuestos xi where impuesto = '001' and xi.partida = x.partida and xi.uuid = x.uuid and xi.tipo='Retencion') as B_ISR_R,
    						(select BASE from xml_impuestos xi where impuesto = '002' and xi.partida = x.partida and xi.uuid = x.uuid and xi.tipo='Retencion') as B_IVA_R, 
    						(select BASE from xml_impuestos xi where impuesto = '003' and xi.partida = x.partida and xi.uuid = x.uuid and xi.tipo='Retencion') as B_IEPS_R
     						FROM  XML_PARTIDAS x where uuid = '$uuid'";
    	//echo $this->query;
    	$res=$this->EjecutaQuerySimple();
    	while ($tsArray=ibase_fetch_object($res)) {
    		$data[]=$tsArray;
    	}
    	return $data;
    }

    function actualizaCuentaCliente($cliente, $partidas, $ide){
    	$cliente = explode(":", $cliente);
    	$partidas = explode("###", $partidas);
    	$cc =$cliente[1];
    	$rfc = $cliente[3];
    	$rfcr = $cliente[0];
    	$uuid = $cliente[2];
    	if($ide == 'Emitidos'){
			$this->query="UPDATE XML_CLIENTES SET CUENTA_CONTABLE ='$cc' where rfc = '$rfcr' and tipo = 'Cliente'";
	    	$this->queryActualiza();
	    	foreach ($partidas as $key){
	    		$key=explode(":", $key);
	    		$par = $key[0];
	    		$cve_sat = $key[1];
	    		$uni_sat = $key[2];
	    		$ccp = $key[3];
	    		$this->query="UPDATE XML_PARTIDAS SET CUENTA_CONTABLE = '$ccp' where rfc = '$rfcr' and  CLAVE_SAT = '$cve_sat' and UNIDAD_SAT = '$uni_sat' and PARTIDA = $par";
	    		$this->queryActualiza();
	      	}
    	}else{
    		$this->query="UPDATE XML_CLIENTES SET CUENTA_CONTABLE ='$cc' where rfc = '$rfc' and tipo = 'Proveedor'";
	    	$this->queryActualiza();	
	    	foreach ($partidas as $key){
	    		$key=explode(":", $key);
	    		$par = $key[0];
	    		$cve_sat = $key[1];
	    		$uni_sat = $key[2];
	    		$ccp = $key[3];
	    		$this->query="UPDATE XML_PARTIDAS SET CUENTA_CONTABLE = '$ccp' where rfc = '$rfcr' and (select rfce from xml_data where uuid = '$uuid') = '$rfc' and  CLAVE_SAT = '$cve_sat' and UNIDAD_SAT = '$uni_sat' and PARTIDA = $par";
	    		$this->queryActualiza();
	      	}	
    	}
    }

    function editarArticulo($art, $tipo){
   		$data = array();
    	$datos = array();
    	$usuario = $_SESSION['user']->NOMBRE;
    	if($tipo ==  'e' or $tipo == 'b'){
	    	$this->query="SELECT * FROM FTC_COTIZACION_DETALLE fd left join ftc_cotizacion f on f.cdfolio = fd.cdfolio left join clie01 c on trim(c.clave) = trim(cve_cliente) WHERE CVE_ART = '$art' 
	    		and instatus = 'PENDIENTE'";
	    	$res=$this->EjecutaQuerySimple();
	    	while ($tsArray=ibase_fetch_object($res)) {
	    		$data[]=$tsArray;
	    	}
	    	foreach ($data as $key ) {
	    		$cotizacion = $key->CVE_COTIZACION;
	    		$vendedor = $key->VENDEDOR;
	    		$fecha = $key->DTFECREG;
	    		$cliente = utf8_encode('('.$key->CVE_CLIENTE.') '.$key->NOMBRE);
	    		$datos[]=array("cotizacion"=>$cotizacion, "vendedor"=>$vendedor, "fecha"=>$fecha,"cliente"=>$cliente); 
	    	}
	    	if(count($datos) == 0 and $tipo == 'b'){
	    		$this->query="SELECT * FROM FTC_ARTICULOS WHERE ID = $art";
	    		$res=$this->EjecutaQuerySimple();
	    		$row=ibase_fetch_object($res);
	    		if($row->STATUS == 'B'){
	    			$status = 'A';
	    		}else{
	    			$status = 'B';
	    		}

	    		$this->query="UPDATE FTC_ARTICULOS SET STATUS = '$status', USUARIO_BAJA='$usuario', FECHA_BAJA = current_timestamp WHERE ID = $art";
    			$this->EjecutaQuerySimple();
    			return $datos = array("status"=>'ok', 'BAJA'=>'SI');
	    	}else{
	    		return $cdfolio = array("status"=>'ok',"cotizaciones"=>$datos);	
	    	}
    	}else{
    			$this->query="UPDATE FTC_ARTICULOS SET STATUS = 'M' WHERE ID = $art";
    			$this->EjecutaQuerySimple();
    			return $datos=array("status"=>'ok');	
    	}
    }

    function prodSAT(){
    	$data=array();
    	$this->query="SELECT c.producto, c.idpreoc, (select nombre from producto_ftc  where clave = c.producto) as descripcion,
        	c.cotizacion, c.cantidad, i.uni_med, i.cve_unidad, i.cve_prodserv  FROM control_fact_rem c left join inve01 i on c.producto = i.cve_art WHERE (facturas = '' or FACTURAS IS NULL) 
        			  AND (REMISIONES = '' or REMISIONES IS NULL) 
        			  and fecha > '01.07.2018'
        			  and ( (i.cve_prodserv is null or i.cve_prodserv = '') or (i.cve_unidad is null or i.cve_unidad = ''))";
    	$rs=$this->EjecutaQuerySimple();
    	while ($tsArray=ibase_fetch_object($rs)) {
    		$data[]=$tsArray;
    	}
    	return $data;
    }

      function gcvesat($prod, $cvesat, $idp, $nuni, $tipo){
    	$this->query="SELECT * FROM INVE01 WHERE CVE_ART = '$prod'";
    	$rs=$this->EjecutaQuerySimple();
    	$row=ibase_fetch_object($rs);

    	if($tipo == 'cve'){
	    	//if(empty($row->CVE_PRODSERV)){
	    		$sat = explode(':', $cvesat);
	    		$cve=$sat[0];
	    		$this->query="SELECT * FROM CLAVES_SAT WHERE CVE_PROD_SERV = '$cve'";
	    		$r = $this->EjecutaQuerySimple();
	    		$row=ibase_fetch_object($r);
	    		if(!empty($row)){
	    			$this->query="UPDATE INVE01 SET CVE_PRODSERV = '$cve' where cve_art='$prod'";
	    			$res=$this->queryActualiza();
	    			if($res == 1){
			    		$this->query="UPDATE FTC_FACTURAS_DETALLE SET CLAVE_SAT ='$cve' where articulo = '$prod' and status = 0 ";
			    		$this->queryActualiza();

			    		return $mensaje=array("status"=>'ok');	
		    		}else{
		 		   		return $mensaje=array("statsu"=>'No', "mensaje"=>'No se pudo actualizar, el producto '.$prod.' con la clave: '.$cvesat.' revise la informacion e intente nuevamente.');
		    		}
	    		}else{
	    			return $mensaje=array("statsu"=>'No','mensaje'=>'No se encontro la clave.');
	    		}
	    	//}else{
	    	//	return $mensaje=array("statsu"=>'No', "mensaje"=>'Ya tiene una clave previa, no se puede cambiar desde aqui.');
	    	//}
    	}elseif($tipo == 'uni'){
    		//if(empty($row->CVE_UNIDAD)){
	    		$this->query="SELECT * FROM UNIDADES_SAT WHERE CLAVE = '$nuni'";
	    		$r = $this->EjecutaQuerySimple();
	    		$row=ibase_fetch_object($r);
	    		if(!empty($row)){
	    			$this->query="UPDATE INVE01 SET CVE_UNIDAD = '$nuni' where cve_art='$prod'";
	    			$res=$this->queryActualiza();
	    			if($res == 1){
	    				$this->query="UPDATE FTC_FACTURAS_DETALLE SET MEDIDA_SAT ='$nuni' where articulo = '$prod' and status = 0 ";
			    		$this->queryActualiza();
			    		return $mensaje=array("status"=>'ok');	
		    		}else{
		 		   		return $mensaje=array("statsu"=>'No', "mensaje"=>'No se pudo actualizar, el producto '.$prod.' con la clave: '.$nuni.' revise la informacion e intente nuevamente.');
		    		}
	    		}else{
	    			return $mensaje=array("statsu"=>'No','mensaje'=>'No se encontro la clave.');
	    		}
	    	//}else{
	    	//	return $mensaje=array("statsu"=>'No', "mensaje"=>'Ya tiene una clave previa, no se puede cambiar desde aqui.');
	    	//}
    	}
    }

	function prefacturasPendientes(){
		$data=array();
		$this->query="SELECT a.*, c.NOMBRE, d.CAMPLIB7, c.CODIGO, b.FECHAELAB, 
			b.importe, c.cve_maestro,
			(select sum(Cantidad * Precio) from detalle_caja dc where dc.idcaja = a.id) as importeprefact,
			(select max(FOLIO_DEV) FROM detalle_caja dc where dc.idcaja = a.id) as folio_dev,
			 b.cita, (datediff(day, b.fechaelab, current_date)) as DIAS, b.DOC_SIG,
		  	(select count(i.cve_art) from preoc01 idp left join inve01 i on idp.prod =i.cve_art where idp.cotiza = a.cve_fact and ((i.cve_prodserv = '' or i.cve_prodserv is null) or (i.cve_unidad = '' or i.cve_unidad is null))) as validacion,
		  	CAST(coalesce( (SELECT list(documento) FROM FTC_FACTURAS WHERE IDCAJA = a.id and status = 8), 0) AS VARCHAR(100)) as canceladas,
		  	(SELECT CT.DETALLISTA FROM CARTERA CT WHERE TRIM(CT.IDCLIENTE) = C.CLAVE_TRIM ) AS DET
		    FROM CAJAS a
		    left join factP01 b on b.cve_doc = a.cve_fact
		    left join clie01 c on b.cve_clpv = c.clave
		    left join CLIE_CLIB01 d on d.cve_clie = c.clave
			WHERE (a.STATUS = 'cerrado' OR a.STATUS = 'NC') and a.embalaje = 'TOTAL'
			and fecha_creacion >= '16.03.2017' and REMISION CONTAINING ('PF') AND (FACTURA IS NULL OR FACTURA = '')
			and (SELECT SUM(CANTIDAD) FROM PAQUETES WHERE IDCAJA = a.id) > (SELECT SUM(DEVUELTO) FROM PAQUETES WHERE IDCAJA = a.id)";
		$result=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($result)){
			$data[]=$tsArray;
		}
		return $data;
	}

	function infoRefacturacion($documento){
		$campo = ' FACTURA_NUEVA ';
		if(substr($documento,0,3)=='NCR'){
			$campo ='NC';
		}
		$this->query="SELECT * FROM REFACTURACION WHERE $campo = '$documento'";
		$rs=$this->EjecutaQuerySimple();
		$row=ibase_fetch_object($rs);
		if(!empty($row)){
			return array("Factura Original"=>$row->FACT_ORIGINAL,"Nota de Credito"=>$row->NC,"Pedido Asociado"=>$row->PEDIDO_REMISION_ASOCIADO,"Caja"=>$row->CAJA,"Razon"=>$row->TIPO_SOLICITUD,"Observaciones"=>htmlentities($row->OBSERVACIONES));	
		}else{
			return array("Factura Original"=>'',"Nota de Credito"=>'',"Pedido Asociado"=>'',"Caja"=>'',"Razon"=>'',"Observaciones"=>'');
		}
		
	}

	function chkstat($idsol){
		$this->query="SELECT R.*, CASE STATUS_SOLICITUD
								when 0 then 'ok' 
								WHEN 1 THEN 'ok'
								when 2 then 'Autorizado'
								when 3 then 'Rechazado'
								when 4 then 'Autorizado / Ejecutado'
								when 5 then 'ejecutado'
								else 'otro'
								end AS STATUS
							 from refacturacion R where id = $idsol";
		$rs=$this->EjecutaQuerySimple();
		$row = ibase_fetch_object($rs);
		return array("status"=>$row->STATUS,"usuario"=>utf8_encode($row->USUARIO_EJECUTA),"fecha"=>$row->FECHA_EJECUTA, "nc"=>$row->NC,"rf"=>$row->FACTURA_NUEVA);
	}


   function addenda($docf){
    	$clienteRFC= "Aceitera";
    	if($clienteRFC =="Elektra"){ /// Addenda Azteca-	
    		$rfe="RegimenFiscalEmisor";
    		$mp="";
    		$xml= new SimpleXMLElement('C:\\xampp\\htdocs\\uploads\\xml\\emitidos\\CCA930729P99(FP29)17-07-2018.xml', null, true);
    		$xmlDom = dom_import_simplexml($xml)->ownerDocument;
    		$padre = $xmlDom->getElementsByTagName("Comprobante")->item(0);
    		//print_r($padre);
			//$addenda = $xml->addChild('Addenda');
			//$if=$xml->registerXPathNamespace("if","https://www.interfactura.com/Schemas/Documentos");
    		$addenda = $xmlDom->createElement("cfdi:Addenda");
    			$addenda = $padre->appendChild($addenda);
    			$facturaIF=$xmlDom->createElement("if:FacturaInterfacura");
    			   	$addenda->appendChild($facturaIF);
    				$xnl=$facturaIF->setAttribute("xmlns:if","https://www.interfactura.com/Schemas/Documentos");
    				$tipoDoc=$facturaIF->setAttribute("TipoDocumento","Factura");
    			$emisor=$xmlDom->createElement("if:Emisor");
    				$addenda->appendChild($emisor);
    				$eri=$emisor->setAttribute("RI","0503590");
    				$nprov=$emisor->setAttribute("NumProveedor","80011057");
    			$receptor=$xmlDom->createElement("if:Receptor");
    				$addenda->appendChild($receptor);
    				$rri=$receptor->setAttribute("RI","0109990");
    			$encabezado=$xmlDom->createElement("if:Encabezado");
    				$addenda->appendChild($encabezado);
    				$encabezado->setAttribute("TipoProveedorEKT","");
    				$encabezado->setAttribute("Fecha","");
    				$encabezado->setAttribute("MonedaDoc","");
    				$encabezado->setAttribute("IVAPCT","");
    				$encabezado->setAttribute("Iva","");
    				$encabezado->setAttribute("SubTotal","");
    				$encabezado->setAttribute("Total","");
    				$encabezado->setAttribute("NumProveedor","");
    				$encabezado->setAttribute("FolioOrdenCompra","");
    				$encabezado->setAttribute("PorcentajeDescuentoPromo","");
    				$encabezado->setAttribute("PorcentajeMerma","");
    				$encabezado->setAttribute("TotalDescuento","");
    				$encabezado->setAttribute("TotalMerma","");
    				$encabezado->setAttribute("Descuento","");
    			///array para el cuerpo:
    			$cuerpo=$xmlDom->createElement("Cuerpo");
    				$encabezado->appendChild($cuerpo);
    				$cuerpo->setAttribute("Renglon","1");
    				$cuerpo->setAttribute("Cantidad","");
    				$cuerpo->setAttribute("Concepto","");
    				$cuerpo->setAttribute("PUnitario","");
    				$cuerpo->setAttribute("Importe","");
			$xmlDom->formatOutput = true;
			$xmlDom->save("C:\\xampp\\htdocs\\uploads\\xml\\emitidos\\CCA930729P99(FP29)17-07-2018_addenda.xml");
		}elseif($clienteRFC=="Mabe"){
			$tmoneda="MXN";
			$tc=1.00;
			$letras='Un Peso';
	 		$xml= new SimpleXMLElement('C:\\xampp\\htdocs\\uploads\\xml\\emitidos\\CCA930729P99(FP29)17-07-2018.xml', null, true);
    		$xmlDom=dom_import_simplexml($xml)->ownerDocument;
    		$padre=$xmlDom->getElementsByTagName("Comprobante")->item(0);
    		$addenda=$xmlDom->createElement("cfdi:Addenda");
    			$addenda=$padre->appendChild($addenda);
    			$factura=$xmlDom->createElement("mabe:Factura");
    				$addenda->appendChild($factura);
    				$factura->setAttribute("xmlns:mabe","http://recepcionfe.mabempresa.com/cfd/addenda/v1");
    				$factura->setAttribute("xmlns:xsi","http://www.w3.org/2001/XMLSchema-instance");
    				$factura->setAttribute("xsi:schemaLocation","http://recepcionfe.mabempresa.com/cfd/addenda/v1 http://recepcionfe.mabempresa.com/cfd/addenda/v1/mabev1.xsd");
    				$factura->setAttribute("Version","1.0");
    				$factura->setAttribute("tipoDocumento","FACTURA");
    				$factura->setAttribute("folio","");
    				$factura->setAttribute("fecha","");
    				$factura->setAttribute("ordenCompra","");
    				$factura->setAttribute("referencia1","");
    			$moneda=$xmlDom->createElement("mabe:Moneda");
    				$factura->appendChild($moneda);
    				$moneda->setAttribute("tipoMoneda","");
    				$moneda->setAttribute("tipoCambio","");
    				$moneda->setAttribute("impodteConLetra","");
    			$proveedor=$xmlDom->createElement("mabe:Proveedor");
    				$proveedor->setAttribute("codigo","4000176");
    			$entrega=$xmlDom->createElement("mabe:Entrega");
    				$factura->appendChild($entrega);
    				$entrega->setAttribute("plantaEntrega","");
    			$detalles=$xmlDom->createElement("mabe:Detalles");
    				$factura->appendChild($detalles);
    			//// for para las partidas
    			$detalle=$xmlDom->createElement("mabe:Detalle");
    				$detalles->appendChild($detalle);
    				$detalle->setAttribute("noLineaArticulo","");
    				$detalle->setAttribute("codigoArticulo","");
    				$detalle->setAttribute("descripcion","");
    				$detalle->setAttribute("unidad","");
    				$detalle->setAttribute("cantidad","");
    				$detalle->setAttribute("precioSinIva","");
    				$detalle->setAttribute("precioConIva","");
    				$detalle->setAttribute("importeSinIva","");
    				$detalle->setAttribute("importeConIva","");
    			$descuentos=$xmlDom->createElement("mabe:Descuentos");
    				$factura->appendChild($descuentos);
    				$descuentos->setAttribute("tipo","");
    				$descuentos->setAttribute("descripcion","");
    				$descuentos->setAttribute("importe","");
    			$subtotal=$xmlDom->createElement("mabe:SubTotal","");
    				$factura->appendChild($subtotal);
    				$subtotal->setAttribute("importe","");
    			$traslados=$xmlDom->createElement("mabe:Traslados","");
    				$factura->appendChild($traslados);
    			$traslado=$xmlDom->createElement("mabe:Traslado","");
    				$traslados->appendChild($traslado);
    				$traslado->setAttribute("tipo","");
    				$traslado->setAttribute("tasa","");
    				$traslado->setAttribute("importe","");
    			$retenciones=$xmlDom->createElement("mabe:Retenciones","");
    				$factura->appendChild($retenciones);
    			$retencion=$xmlDom->createElement("mabe:Retencion","");
    				$retenciones->appendChild($retencion);
    				$retencion->setAttribute("tipo","");
    				$retencion->setAttribute("tasa","");
    				$retencion->setAttribute("importe","");
    			$total=$xmlDom->createElement("mabe:Total","");
    				$factura->appendChild($total);
    				$total->setAttribute("importe","");		
			$xmlDom->formatOutput = true;
			$xmlDom->save("C:\\xampp\\htdocs\\uploads\\xml\\emitidos\\CCA930729P99(FP29)17-07-2018_addenda.xml");
		}elseif($clienteRFC=='Liverpool' or $clienteRFC=='Suburbia'){
			$xml= new SimpleXMLElement('C:\\xampp\\htdocs\\uploads\\xml\\emitidos\\CCA930729P99(FP29)17-07-2018.xml', null, true);
    		$xmlDom = dom_import_simplexml($xml)->ownerDocument;
    		$padre = $xmlDom->getElementsByTagName("Comprobante")->item(0);
    		$complemento=$xmlDom->createElement("Complemento");
    			$complemento=$padre->appendChild($complemento);
    		$detallista=$xmlDom->createElement("detallista:detallista");
    			$complemento->appendChild($detallista);
    			$detallista->setAttribute("type","SimpleInvoiceType");
    			$detallista->setAttribute("documentStructureVersion","AMC8.1");
    			$detallista->setAttribute("documentStatus","ORIGINAL");
    			$detallista->setAttribute("contentVersion","1.3.1");
    		$rfpi=$xmlDom->createElement("detallista:requestForPaymentIdentification");
    			$detallista->appendChild($rfpi);
    				$et=$xmlDom->createElement("detallista:entityType","Documento");
    				$rfpi->appendChild($et);
    		$si=$xmlDom->createElement("detallista:specialInstruction");
    			$detallista->appendChild($si);
    			$si->setAttribute("code","ZZZ");
    				$dt=$xmlDom->createElement("detallista:text","Importe con Letras");
    				$si->appendChild($dt);
    		$oi=$xmlDom->createElement("detallista:orderIdentification");
    			$detallista->appendChild($oi);
    				$dri=$xmlDom->createElement("detallista:referenceIdentification","Condicion");
    					$oi->appendChild($dri);
    					$dri->setAttribute("type","ON");
    				$drd=$xmlDom->createElement("detallista:ReferenceDate","fecha de entrega");
    					$oi->appendChild($drd);
    		$ai=$xmlDom->createElement("detallista:AdditionalInformation");
    			$detallista->appendChild($ai);
    				$ri=$xmlDom->createElement("detallista:referenceIdentification","Parte No Numerica");
    					$ai->appendChild($ri);
    					$ri->setAttribute("type","IV");
    		$dn=$xmlDom->createElement("detallista:DeliveryNote");
    			$detallista->appendChild($dn);
    				$dnri=$xmlDom->createElement("detallista:referenceIdentification","Observaciones");
    				$dn->appendChild($dnri);
    				$dnrd=$xmlDom->createElement("detallista:ReferenceDate","Fecha Entrega");
    				$dn->appendChild($dnrd);
    		$buy=$xmlDom->createElement("detallista:buyer");
    			$detallista->appendChild($buy);
    				$buygln=$xmlDom->createElement("detallista:gln","750400107903");
    					$buy->appendChild($buygln);
    				$buyci=$xmlDom->createElement("detallista:contactInformation");
    					$buy->appendChild($buyci);
    						$buyciperson=$xmlDom->createElement("detallista:personOrDepartmentName");
    							$buyci->appendChild($buyciperson);
    								$buycipersontext=$xmlDom->createElement("detallista:text", "SUPEDIDO");
    									$buyciperson->appendChild($buycipersontext);	
    		$seller=$xmlDom->createElement("detallista:seller");
    			$detallista->appendChild($seller);
    				$sellergln=$xmlDom->createElement("detallista:gln","0000000059137");
    					$seller->appendChild($sellergln);
    				$sellerapi=$xmlDom->createElement("detallista:alternatePartyIdentification", "59137");
    					$seller->appendChild($sellerapi);
    					$sellerapi->setAttribute("type","SELLER_ASSIGNED_IDENTIFIER_FOR_A_PARTY");
    		$allch=$xmlDom->createElement("detallista:allowanceCharge");
    			$detallista->appendChild($allch);
    				$allch->setAttribute("allowanceChargeType","ALLOWANCE_GLOBAL");
    				$allch->setAttribute("settlementType","OFF_INVOICE");
    				$allchsst=$xmlDom->createElement("detallista:specialServicesType","AJ");
    					$allch->appendChild($allchsst);
    				$allchmaop=$xmlDom->createElement("detallista:monetaryAmountOrPercentage");
    					$allch->appendChild($allchmaop);
    						$allchaoprate=$xmlDom->createElement("detallista:rate");
    							$allchmaop->appendChild($allchaoprate);
    							$allchaoprate->setAttribute("base","INVOICE_VALUE");
    							$allchaopratepor=$xmlDom->createElement("detallista:percentage","PORNCENTAJE DESC FIN");
    								$allchaoprate->appendChild($allchaopratepor);
    		//// Partidas:
    		$li=$xmlDom->createElement("detallista:lineItem");
    			$detallista->appendChild($li);
    				$li->setAttribute("type","SimpleInvoiceLineItemType");
    				$li->setAttribute("number","Partida");
    					$liTII=$xmlDom->createElement("detallista:tradeItemIdentification");
    						$li->appendChild($liTII);
    							$liTTIgtin=$xmlDom->createElement("detallista:gtin","ProdLibre2");
    							$liTII->appendChild($liTTIgtin);
    							$liTTIalter=$xmlDom->createElement("detallista:alternateTradeItemIdentification", "Prodlibre2");
    								$li->appendChild($liTTIalter);
    								$liTTIalter->setAttribute("type","SUPPLIER_ASSIGNED");	
    							$liTIDI=$xmlDom->createElement("detallista:tradeItemDescriptionInformation");
    								$li->appendChild($liTIDI);
    								$liTIDI->setAttribute("language","ES");
    									$liTIDItext=$xmlDom->createElement("detallista:longText","DESCRIPCION A 35 CARACTERES");
    									$liTIDI->appendChild($liTIDItext);
    							$liIQ=$xmlDom->createElement("detallista:invoicedQuantity","CANTIDAD");
    								$li->appendChild($liIQ);
    								$liIQ->setAttribute("unitOfMeasure", "PCE");
    							$liGP=$xmlDom->createElement("detallista:grossPrice");
    								$li->appendChild($liGP);
    									$liGPA=$xmlDom->createElement("detallista:Amount","Precio a 2 digitos");
    									$liGP->appendChild($liGPA);
    							$liNP=$xmlDom->createElement("detallista:netPrice");
    								$li->appendChild($liNP);
    									$liNPA=$xmlDom->createElement("detallista:Amount","PrecioBruto a 2 digitos");
    									$liNP->appendChild($liNPA);
    							$litLA=$xmlDom->createElement("detallista:totalLineAmount");
    								$li->appendChild($litLA);
    									$litLAG=$xmlDom->createElement("detallista:grossAmount");
    										$litLA->appendChild($litLAG);
    											$litLAGA=$xmlDom->createElement("detallista:Amount", "Subtotal de la partida");
    											$litLAG->appendChild($litLAGA);
    									$litLAGnA=$xmlDom->createElement("detallista:netAmount");
    										$litLA->appendChild($litLAGnA);
    											$litLAGnAA=$xmlDom->createElement("detallista:Amount", "Total de la Partida");
    											$litLAGnA->appendChild($litLAGnAA);

    		$ta=$xmlDom->createElement("detallista:totalAmount");
    			$detallista->appendChild($ta);
    				$taa=$xmlDom->createElement("detallista:Amount","Subtotal del documento");
    				$ta->appendChild($taa);
    		$tac=$xmlDom->createElement("detallista:TotalAllowanceCharge");
    			$detallista->appendChild($tac);
    			$tac->setAttribute("allowanceOrChargeType","ALLOWANCE");
    			$tacsst=$xmlDom->createElement("detallista:specialServicesType","AJ");
    				$tac->appendChild($tacsst);
    			$taca=$xmlDom->createElement("detallista:Amount", "Total Descuentos");
    				$tac->appendChild($taca);
    		$xmlDom->formatOutput = true;
			$xmlDom->save("C:\\xampp\\htdocs\\uploads\\xml\\emitidos\\CCA930729P99(FP29)17-07-2018_addenda_Suburbia.xml");
		}elseif($clienteRFC=="Propimex"){
			$xml= new SimpleXMLElement('C:\\xampp\\htdocs\\uploads\\xml\\emitidos\\CCA930729P99(FP29)17-07-2018.xml', null, true);
    		$xmlDom = dom_import_simplexml($xml)->ownerDocument;
    		$padre = $xmlDom->getElementsByTagName("Comprobante")->item(0);
    
    		$addenda=$xmlDom->createElement("Addenda");
    			$padre->appendChild($addenda);
    			$documento=$xmlDom->createElement("Documento");
    				$addenda->appendChild($documento);
    				$factura=$xmlDom->createElement("FacturaFemsa");
    					$documento->appendChild($factura);
    					$nova=$xmlDom->createElement("noVersAdd","01");
    						$factura->appendChild($nova);
    					$claseDoc=$xmlDom->createElement("claseDoc","1");
    						$factura->appendChild($claseDoc);
    					$noSociedad=$xmlDom->createElement("noSociedad","F142");
    						$factura->appendChild($noSociedad);
    					$noProveedor=$xmlDom->createElement("noProveedor","000004004512");
    						$factura->appendChild($noProveedor);
    					$noPedido=$xmlDom->createElement("noPedido","SUPEDIDO");
							$factura->appendChild($noPedido);
						$moneda=$xmlDom->createElement("moneda","MXP");
							$factura->appendChild($moneda);
						$noEntrada=$xmlDom->createElement("noEntrada", "GUIA");
							$factura->appendChild($noEntrada);
						$noRemision=$xmlDom->createElement("noRemision", "No Recepcion");
							$factura->appendChild($noRemision);
						$noSocio=$xmlDom->createElement("noSocio");
							$factura->appendChild($noSocio);
						$centroCostos=$xmlDom->createElement("centroCostos");
							$factura->appendChild($centroCostos);
						$iniPerLiq=$xmlDom->createElement("iniPerLiq");
							$factura->appendChild($iniPerLiq);
						$finPerLiq=$xmlDom->createElement("finPerLiq");
							$factura->appendChild($finPerLiq);
						$retencion1=$xmlDom->createElement("retencion1");
							$factura->appendChild($retencion1);
						$retencion2=$xmlDom->createElement("retencion2");
							$factura->appendChild($retencion2);
						$email=$xmlDom->createElement("email","ferreterapegaso@hotmail.com");
							$factura->appendChild($email);


    		$xmlDom->formatOutput = true;
			$xmlDom->save("C:\\xampp\\htdocs\\uploads\\xml\\emitidos\\CCA930729P99(FP29)17-07-2018_addenda_FEMSA.xml");
		}elseif($clienteRFC=='Aceitera'){
			$xml= new SimpleXMLElement('C:\\xampp\\htdocs\\uploads\\xml\\emitidos\\CCA930729P99(FP29)17-07-2018.xml', null, true);
    		$xmlDom = dom_import_simplexml($xml)->ownerDocument;
    		$padre = $xmlDom->getElementsByTagName("Comprobante")->item(0);
    		$addenda=$xmlDom->createElement("Addenda");
    		$padre->appendChild($addenda);

    			$ia=$xmlDom->createElement("IA");
    				$addenda->appendChild($ia);
    			$proveedor=$xmlDom->createElement("Proveeedor","2832");
    				$ia->appendChild($proveedor);
    			/// Partidas
    				$partida=$xmlDom->createElement("Partida");
    					$ia->appendChild($partida);
    					$partida->setAttribute("Posicion","Partida x 10 ");
    					$partida->setAttribute("Pedido","SUPEDIDO");
    					$entrada=$xmlDom->createElement("Entrada", "Condicion");
    						$partida->appendChild($entrada);
    		$xmlDom->formatOutput = true;
			$xmlDom->save("C:\\xampp\\htdocs\\uploads\\xml\\emitidos\\CCA930729P99(FP29)17-07-2018_addenda_FEMSA.xml");
		}
	}

	function obtieneAddenda($docf){
		$this->query="SELECT REPLACE(RFC, ' ', '')  AS RFC FROM CLIE01 WHERE CLAVE=(SELECT CLIENTE FROM FTC_FACTURAS WHERE DOCUMENTO = '$docf') or clave_trim =(SELECT CLIENTE FROM FTC_FACTURAS WHERE DOCUMENTO = '$docf')";
		$res=$this->EjecutaQuerySimple();
		$row=ibase_fetch_object($res);
		$rfc = trim($row->RFC);
		$this->query="SELECT f.*,c.rfc, (select a.ruta from FTC_ADDENDA a WHERE trim(a.RFC)='$rfc') as ruta  FROM FTC_FACTURAS f left join CLIE01 c on c.clave_trim = trim(f.cliente) WHERE DOCUMENTO='$docf'";
		//echo $this->query;
		$rs=$this->EjecutaQuerySimple();
		$row=ibase_fetch_object($rs);
		return $row->RUTA;
	}

	function addendaMabe($docf, $oc, $planta){
			$letras = new NumberToLetterConverter();
			$this->query="SELECT * FROM FTC_FACTURAS f left join FTC_FACTURAS_DETALLE d on f.documento = d.documento where f.documento = '$docf'";
			$rs=$this->EjecutaQuerySimple();

			while ($tsArray=ibase_fetch_object($rs)) {
				$data[]=$tsArray;
			}
				foreach ($data as $key) {
					$fecha=$key->FECHA_DOC;
					$importe=$key->TOTAL;
					$subTotal=$key->SUBTOTAL;
					$iva=$key->IVA;
				}
				$m = $importe;
				$Monto=number_format($m,0);
				$M1=number_format($m,2);
				$M4=substr($M1, 0,-2);
		        $centavos=substr($M1,-2);
		   		$m5= $M4.'00';
		   		$res=$letras->to_word($m5);
		        if ($centavos == 00){
		        	$leyenda = 'PESOS 00/100 M.N.';
		        }else{
		        	$leyenda = 'PESOS '.$centavos.'/100 M.N.';
		        }
		        $importeLetras=$res.$leyenda;
				$fecha=strtotime($fecha);
				$fechaAddenda=date("Y-m-d", $fecha);

			$xml= new SimpleXMLElement('C:\\xampp\\htdocs\\Facturas\\facturaPegaso\\'.$docf.'.xml', null, true);
    		$xmlDom=dom_import_simplexml($xml)->ownerDocument;
    		$padre=$xmlDom->getElementsByTagName("Comprobante")->item(0);
    		$addenda=$xmlDom->createElement("cfdi:Addenda");
    			$addenda=$padre->appendChild($addenda);
    			$factura=$xmlDom->createElement("mabe:Factura");
    				$addenda->appendChild($factura);
    				$factura->setAttribute("xmlns:mabe","http://recepcionfe.mabempresa.com/cfd/addenda/v1");
    				$factura->setAttribute("xmlns:xsi","http://www.w3.org/2001/XMLSchema-instance");
    				$factura->setAttribute("xsi:schemaLocation","http://recepcionfe.mabempresa.com/cfd/addenda/v1 http://recepcionfe.mabempresa.com/cfd/addenda/v1/mabev1.xsd");
    				$factura->setAttribute("Version","1.0");
    				$factura->setAttribute("tipoDocumento","FACTURA");
    				$factura->setAttribute("folio",$docf);
    				$factura->setAttribute("fecha",$fechaAddenda);
    				$factura->setAttribute("ordenCompra",$oc);
    				$factura->setAttribute("referencia1",$docf);
    			$moneda=$xmlDom->createElement("mabe:Moneda");
    				$factura->appendChild($moneda);
    				$moneda->setAttribute("tipoMoneda","MXN");
    				$moneda->setAttribute("tipoCambio","1.00");
    				$moneda->setAttribute("impodteConLetra",$importeLetras);
    			$proveedor=$xmlDom->createElement("mabe:Proveedor");
    				$proveedor->setAttribute("codigo","4000176");
    			$entrega=$xmlDom->createElement("mabe:Entrega");
    				$factura->appendChild($entrega);
    				$entrega->setAttribute("plantaEntrega",$planta);
    			$detalles=$xmlDom->createElement("mabe:Detalles");
    				$factura->appendChild($detalles);
    			//// for para las partidas
    			foreach ($data as $key2) {
    				$detalle=$xmlDom->createElement("mabe:Detalle");
    					$detalles->appendChild($detalle);
    					$detalle->setAttribute("noLineaArticulo",$key2->PARTIDA);
    					$detalle->setAttribute("codigoArticulo",$key2->ARTICULO);
    					$detalle->setAttribute("descripcion",utf8_encode($key2->DESCRIPCION));
    					$detalle->setAttribute("unidad","UN");
    					$detalle->setAttribute("cantidad",number_format($key2->CANTIDAD,2,".",""));
    					$detalle->setAttribute("precioSinIva",number_format($key2->PRECIO,2,".",""));
    					$detalle->setAttribute("precioConIva",number_format($key2->PRECIO *1.16,2,".",""));
    					$detalle->setAttribute("importeSinIva", number_format($key2->PRECIO * $key2->CANTIDAD,2,".","") );
    					$detalle->setAttribute("importeConIva",number_format(($key2->PRECIO * $key2->CANTIDAD) *1.16,2,".",""));
    			}
    			
    			$descuentos=$xmlDom->createElement("mabe:Descuentos");
    				$factura->appendChild($descuentos);
    				$descuentos->setAttribute("tipo","CARGO");
    				$descuentos->setAttribute("descripcion","OTROS CARGOS");
    				$descuentos->setAttribute("importe","0.00");
    			$subtotal=$xmlDom->createElement("mabe:SubTotal",number_format($subTotal,2,".",""));
    				$factura->appendChild($subtotal);
    				$subtotal->setAttribute("importe","");
    			$traslados=$xmlDom->createElement("mabe:Traslados","");
    				$factura->appendChild($traslados);
    			$traslado=$xmlDom->createElement("mabe:Traslado","");
    				$traslados->appendChild($traslado);
    				$traslado->setAttribute("tipo","IVA");
    				$traslado->setAttribute("tasa","16.000000");
    				$traslado->setAttribute("importe",number_format($iva,2,".",""));
    			$retenciones=$xmlDom->createElement("mabe:Retenciones","");
    				$factura->appendChild($retenciones);
    			$retencion=$xmlDom->createElement("mabe:Retencion","");
    				$retenciones->appendChild($retencion);
    				$retencion->setAttribute("tipo","NA");
    				$retencion->setAttribute("tasa","0.00");
    				$retencion->setAttribute("importe","0.00");
    			$total=$xmlDom->createElement("mabe:Total","");
    				$factura->appendChild($total);
    				$total->setAttribute("importe",number_format($importe,2,".",""));		
			$xmlDom->formatOutput = true;
			$xmlDom->save('C:\\xampp\\htdocs\\Facturas\\facturaPegaso\\'.$docf.'_addenda.xml');
			$descarga = "/Facturas/facturaPegaso/".$docf."_addenda.xml";
			echo '<a href="'.$descarga.'" download >Descarga Addenda</a><br/>';
			echo '<a href="#" onclick="javascritp:window.self.close();" class="btn btn-info">Cerrar ventana</a>';
			return;
	}

	function addendaAzteca($docf, $oc, $recepcion, $cc){
		$letras = new NumberToLetterConverter();
		$this->query="SELECT * FROM FTC_FACTURAS f left join FTC_FACTURAS_DETALLE d on f.documento = d.documento where f.documento = '$docf'";
		$rs=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($rs)) {
				$data[]=$tsArray;
			}
			foreach ($data as $key) {
					$fecha=$key->FECHA_DOC;
					$importe=$key->TOTAL;
					$subTotal=$key->SUBTOTAL;
					$iva=$key->IVA;
				}
			$fecha=strtotime($fecha);
			$fechaAddenda=date("Y-m-d T h:i:s", $fecha);
			$rfe="REGIMEN GENERAL DE LEY PERSONAS MORALES";
    		$mp="";
    		$xml= new SimpleXMLElement('C:\\xampp\\htdocs\\Facturas\\facturaPegaso\\'.$docf.'.xml', null, true);
    		$xmlDom = dom_import_simplexml($xml)->ownerDocument;
    		$padre = $xmlDom->getElementsByTagName("Comprobante")->item(0);
    		$addenda = $xmlDom->createElement("cfdi:Addenda");
    			$addenda = $padre->appendChild($addenda);
    			$facturaIF=$xmlDom->createElement("if:FacturaInterfacura");
    			   	$addenda->appendChild($facturaIF);
    				$xnl=$facturaIF->setAttribute("xmlns:if","https://www.interfactura.com/Schemas/Documentos");
    				$tipoDoc=$facturaIF->setAttribute("TipoDocumento","Factura");
    			$emisor=$xmlDom->createElement("if:Emisor");
    				$facturaIF->appendChild($emisor);
    				$eri=$emisor->setAttribute("RI","0503590");
    				$nprov=$emisor->setAttribute("NumProveedor","80011057");
    			$receptor=$xmlDom->createElement("if:Receptor");
    				$facturaIF->appendChild($receptor);
    				$rri=$receptor->setAttribute("RI","0109990");
    			$encabezado=$xmlDom->createElement("if:Encabezado");
    				$facturaIF->appendChild($encabezado);
    				$encabezado->setAttribute("RegimenFiscalEmisor",$rfe);
    				$encabezado->setAttribute("metodoDePago","NO IDENTIFICADO");
    				$encabezado->setAttribute("LugarExpedicion","TLALNEPANTLA DE BAZ, ESTADO DE MEXCIO");
    				$encabezado->setAttribute("NumProveedor","0080011057");
    				$encabezado->setAttribute("Fecha",$fechaAddenda);
    				$encabezado->setAttribute("FolioOrdenCompra",$oc);
    				$encabezado->setAttribute("SubTotal",number_format($subTotal,2,".",""));
    				$encabezado->setAttribute("Iva",number_format($iva,2,".",""));
    				$encabezado->setAttribute("IVAPCT","16");
    				$encabezado->setAttribute("SubTotalIva",number_format($importe,2,".",""));
    				$encabezado->setAttribute("Total",number_format($importe,2,".",""));
    				$encabezado->setAttribute("Moneda","MXN");
    				$encabezado->setAttribute("NombreSolicitante","Juan Rene");
    				$encabezado->setAttribute("PaternoSolicitante","SantaMaria");
    				$encabezado->setAttribute("MaternoSolicitante","Martinez");
    			///array para el cuerpo:
    				foreach ($data as $key2) {
    					$cuerpo=$xmlDom->createElement("if:Cuerpo");
		    				$encabezado->appendChild($cuerpo);
		    				$cuerpo->setAttribute("Renglon",$key2->PARTIDA);
		    				$cuerpo->setAttribute("Cantidad",$key2->CANTIDAD);
		    				$cuerpo->setAttribute("Concepto",$key2->ARTICULO);
		    				$cuerpo->setAttribute("PUnitario",number_format($key2->PRECIO,2,".",""));
		    				$cuerpo->setAttribute("Importe",number_format($key2->PRECIO * $key2->CANTIDAD,2,".",""));
    				}
    		$xmlDom->formatOutput = true;
			$xmlDom->save('C:\\xampp\\htdocs\\Facturas\\facturaPegaso\\'.$docf.'_addenda.xml');
			$descarga = "/Facturas/facturaPegaso/".$docf."_addenda.xml";
			echo '<a href="'.$descarga.'" download >Descarga Addenda</a><br/>';
			echo '<a href="#" onclick="javascritp:window.self.close();" class="btn btn-info">Cerrar ventana</a>';
			return;
	}

	function addendaLiverpool($docf, $oc, $entrega, $infoAdicional, $depopersona ){
		$letras = new NumberToLetterConverter();
		$this->query="SELECT * FROM FTC_FACTURAS f left join FTC_FACTURAS_DETALLE d on f.documento = d.documento where f.documento = '$docf'";
		$rs=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($rs)) {
				$data[]=$tsArray;
			}
			foreach ($data as $key) {
					$fecha=$key->FECHA_DOC;
					$importe=$key->TOTAL;
					$subTotal=$key->SUBTOTAL;
					$iva=$key->IVA;
					$serie = $key->SERIE;
				}
				$m = number_format($importe,4,".","");
				$ms = explode(".", $importe);
				$valor=$ms[0];
				$dec=substr($ms[1],0,2);
				$m=$ms[0].'.'.$dec;
				$Monto=number_format($m,0);
				$M1=number_format($m,2);
				$M4=substr($M1, 0,-2);
		        $centavos=substr($M1,-2);
		   		$m5= $M4.'00';
		   		$res=$letras->to_word($m5);
		        if ($centavos == 00){
		        	$leyenda = 'PESOS CON 00/100 MN';
		        }else{
		        	$leyenda = 'PESOS CON '.$centavos.'/100 MN';
		        }
		        $importeLetras=$res.$leyenda;

			$fecha=strtotime($fecha);
			$fechaAddenda=date("Y-m-d", $fecha);
			//$rfe="REGIMEN GENERAL DE LEY PERSONAS MORALES";
			$xml= new SimpleXMLElement('C:\\xampp\\htdocs\\Facturas\\facturaPegaso\\'.$docf.'.xml', null, true);
    		$xmlDom = dom_import_simplexml($xml)->ownerDocument;
    		$padre = $xmlDom->getElementsByTagName("Comprobante")->item(0);
    			$padre->setAttribute("xmlns:detallista","http://www.sat.gob.mx/detallista");
    		$complemento= $xmlDom->getElementsByTagName("Complemento")->item(0);
    		//$complemento=$xmlDom->createElement("Complemento");
    		//	$complemento=$padre->appendChild($complemento);
    		$detallista=$xmlDom->createElement("detallista:detallista");
    			$complemento->appendChild($detallista);
    			$detallista->setAttribute("type","SimpleInvoiceType");
    			$detallista->setAttribute("documentStructureVersion","AMC8.1");
    			$detallista->setAttribute("documentStatus","ORIGINAL");
    			$detallista->setAttribute("contentVersion","1.3.1");
    		$rfpi=$xmlDom->createElement("detallista:requestForPaymentIdentification");
    			$detallista->appendChild($rfpi);
    				$et=$xmlDom->createElement("detallista:entityType","INVOICE");
    				$rfpi->appendChild($et);
    		$si=$xmlDom->createElement("detallista:specialInstruction");
    			$detallista->appendChild($si);
    			$si->setAttribute("code","ZZZ");
    				$dt=$xmlDom->createElement("detallista:text",$importeLetras);
    				$si->appendChild($dt);
    		$oi=$xmlDom->createElement("detallista:orderIdentification");
    			$detallista->appendChild($oi);
    				$dri=$xmlDom->createElement("detallista:referenceIdentification",$oc);
    					$oi->appendChild($dri);
    					$dri->setAttribute("type","ON");
    				$drd=$xmlDom->createElement("detallista:ReferenceDate",$fechaAddenda);
    					$oi->appendChild($drd);
    		$ai=$xmlDom->createElement("detallista:AdditionalInformation");
    			$detallista->appendChild($ai);
    				$ri=$xmlDom->createElement("detallista:referenceIdentification",$serie);
    					$ai->appendChild($ri);
    					$ri->setAttribute("type","IV");
    		$dn=$xmlDom->createElement("detallista:DeliveryNote");
    			$detallista->appendChild($dn);
    				$dnri=$xmlDom->createElement("detallista:referenceIdentification",$entrega);
    				$dn->appendChild($dnri);
    				$dnrd=$xmlDom->createElement("detallista:ReferenceDate",$fechaAddenda);
    				$dn->appendChild($dnrd);
    		$buy=$xmlDom->createElement("detallista:buyer");
    			$detallista->appendChild($buy);
    				$buygln=$xmlDom->createElement("detallista:gln","750400107903");
    					$buy->appendChild($buygln);
    				$buyci=$xmlDom->createElement("detallista:contactInformation");
    					$buy->appendChild($buyci);
    						$buyciperson=$xmlDom->createElement("detallista:personOrDepartmentName");
    							$buyci->appendChild($buyciperson);
    								$buycipersontext=$xmlDom->createElement("detallista:text", $depopersona);
    									$buyciperson->appendChild($buycipersontext);	
    		$seller=$xmlDom->createElement("detallista:seller");
    			$detallista->appendChild($seller);
    				$sellergln=$xmlDom->createElement("detallista:gln","0000000059137");
    					$seller->appendChild($sellergln);
    				$sellerapi=$xmlDom->createElement("detallista:alternatePartyIdentification", "59137");
    					$seller->appendChild($sellerapi);
    					$sellerapi->setAttribute("type","SELLER_ASSIGNED_IDENTIFIER_FOR_A_PARTY");
    		$allch=$xmlDom->createElement("detallista:allowanceCharge");
    			$detallista->appendChild($allch);
    				$allch->setAttribute("allowanceChargeType","ALLOWANCE_GLOBAL");
    				$allch->setAttribute("settlementType","OFF_INVOICE");
    				$allchsst=$xmlDom->createElement("detallista:specialServicesType","AJ");
    					$allch->appendChild($allchsst);
    				$allchmaop=$xmlDom->createElement("detallista:monetaryAmountOrPercentage");
    					$allch->appendChild($allchmaop);
    						$allchaoprate=$xmlDom->createElement("detallista:rate");
    							$allchmaop->appendChild($allchaoprate);
    							$allchaoprate->setAttribute("base","INVOICE_VALUE");
    							$allchaopratepor=$xmlDom->createElement("detallista:percentage","0.00");
    								$allchaoprate->appendChild($allchaopratepor);
    		//// Partidas:
    		foreach ($data as $key2 ) {
    			$this->query="SELECT * FROM INVE01 I LEFT JOIN inve_clib01 icl on i.cve_art = icl.cve_prod where cve_art = '$key2->ARTICULO'";
    			$rs=$this->EjecutaQuerySimple();
    			$row=ibase_fetch_object($rs);
    			
    		$li=$xmlDom->createElement("detallista:lineItem");
    			$detallista->appendChild($li);
    				$li->setAttribute("type","SimpleInvoiceLineItemType");
    				$li->setAttribute("number",$key2->PARTIDA);
    					$liTII=$xmlDom->createElement("detallista:tradeItemIdentification");
    						$li->appendChild($liTII);
    							$liTTIgtin=$xmlDom->createElement("detallista:gtin",$row->CAMPLIB2);
    							$liTII->appendChild($liTTIgtin);
    							$liTTIalter=$xmlDom->createElement("detallista:alternateTradeItemIdentification", $row->CAMPLIB2);
    								$li->appendChild($liTTIalter);
    								$liTTIalter->setAttribute("type","SUPPLIER_ASSIGNED");	
    							$liTIDI=$xmlDom->createElement("detallista:tradeItemDescriptionInformation");
    								$li->appendChild($liTIDI);
    								$liTIDI->setAttribute("language","ES");
    									$liTIDItext=$xmlDom->createElement("detallista:longText",utf8_encode(utf8_encode(substr($key2->DESCRIPCION, 0,34))));
    									$liTIDI->appendChild($liTIDItext);
    							$liIQ=$xmlDom->createElement("detallista:invoicedQuantity",$key2->CANTIDAD);
    								$li->appendChild($liIQ);
    								$liIQ->setAttribute("unitOfMeasure", "PCE");
    							$liGP=$xmlDom->createElement("detallista:grossPrice");
    								$li->appendChild($liGP);
    									$liGPA=$xmlDom->createElement("detallista:Amount",number_format($key2->PRECIO,2,".",""));
    									$liGP->appendChild($liGPA);
    							$liNP=$xmlDom->createElement("detallista:netPrice");
    								$li->appendChild($liNP);
    									$liNPA=$xmlDom->createElement("detallista:Amount",number_format($key2->PRECIO *1.16,2,".",""));
    									$liNP->appendChild($liNPA);
    							$litLA=$xmlDom->createElement("detallista:totalLineAmount");
    								$li->appendChild($litLA);
    									$litLAG=$xmlDom->createElement("detallista:grossAmount");
    										$litLA->appendChild($litLAG);
    											$litLAGA=$xmlDom->createElement("detallista:Amount",number_format(($key2->PRECIO * $key2->CANTIDAD),2,".",""));
    											$litLAG->appendChild($litLAGA);
    									$litLAGnA=$xmlDom->createElement("detallista:netAmount");
    										$litLA->appendChild($litLAGnA);
    											$litLAGnAA=$xmlDom->createElement("detallista:Amount",number_format(($key2->PRECIO * $key2->CANTIDAD)*1.16,2,".",""));
    											$litLAGnA->appendChild($litLAGnAA);
    		}
    		$ta=$xmlDom->createElement("detallista:totalAmount");
    			$detallista->appendChild($ta);
    				$taa=$xmlDom->createElement("detallista:Amount",number_format($subTotal,2,".",""));
    				$ta->appendChild($taa);
    		$tac=$xmlDom->createElement("detallista:TotalAllowanceCharge");
    			$detallista->appendChild($tac);
    			$tac->setAttribute("allowanceOrChargeType","ALLOWANCE");
    			$tacsst=$xmlDom->createElement("detallista:specialServicesType","AJ");
    				$tac->appendChild($tacsst);
    			$taca=$xmlDom->createElement("detallista:Amount", "0.00");
    				$tac->appendChild($taca);
    		$xmlDom->formatOutput = true;
			$xmlDom->save('C:\\xampp\\htdocs\\Facturas\\facturaPegaso\\'.$docf.'_addenda.xml');
			$descarga = "/Facturas/facturaPegaso/".$docf."_addenda.xml";
			echo '<a href="'.$descarga.'" download >Descarga Addenda</a><br/>';
			echo '<a href="#" onclick="javascritp:window.self.close();" class="btn btn-info">Cerrar ventana</a>';
	}

	function addendaElektra($docf, $oc, $rri){
			$letras = new NumberToLetterConverter();
			$this->query="SELECT * FROM FTC_FACTURAS f left join FTC_FACTURAS_DETALLE d on f.documento = d.documento where f.documento = '$docf'";
			$rs=$this->EjecutaQuerySimple();
			while ($tsArray=ibase_fetch_object($rs)) {
				$data[]=$tsArray;
			}
			foreach ($data as $key) {
					$fecha=$key->FECHA_DOC;
					$importe=$key->TOTAL;
					$subTotal=$key->SUBTOTAL;
					$iva=$key->IVA;
				}
			$fecha=strtotime($fecha);
			$fechaAddenda=date("Y-m-d T h:i:s", $fecha);
			$rfe="RegimenFiscalEmisor";
    		$mp="";
    		$xml= new SimpleXMLElement('C:\\xampp\\htdocs\\Facturas\\facturaPegaso\\'.$docf.'.xml', null, true);
    		$xmlDom = dom_import_simplexml($xml)->ownerDocument;
    		$padre = $xmlDom->getElementsByTagName("Comprobante")->item(0);
    	
    		$addenda = $xmlDom->createElement("cfdi:Addenda");
    			$addenda = $padre->appendChild($addenda);
    			$facturaIF=$xmlDom->createElement("if:FacturaInterfacura");
    			   	$addenda->appendChild($facturaIF);
    				$xnl=$facturaIF->setAttribute("xmlns:if","https://www.interfactura.com/Schemas/Documentos");
    				$tipoDoc=$facturaIF->setAttribute("TipoDocumento","Factura");
    			$emisor=$xmlDom->createElement("if:Emisor");
    				$facturaIF->appendChild($emisor);
    				$eri=$emisor->setAttribute("RI","0503590");
    				$nprov=$emisor->setAttribute("NumProveedor","80011057");
    			$receptor=$xmlDom->createElement("if:Receptor");
    				$facturaIF->appendChild($receptor);
    				$rri=$receptor->setAttribute("RI","0109990");
    			$encabezado=$xmlDom->createElement("if:Encabezado");
    				$facturaIF->appendChild($encabezado);
    				$encabezado->setAttribute("TipoProveedorEKT","3s");
    				$encabezado->setAttribute("Fecha",$fechaAddenda);
    				$encabezado->setAttribute("MonedaDoc","Pesos");
    				$encabezado->setAttribute("IVAPCT","16.00");
    				$encabezado->setAttribute("Iva",number_format($iva,2,".",""));
    				$encabezado->setAttribute("SubTotal",number_format($subTotal,2,".",""));
    				$encabezado->setAttribute("Total",number_format($importe,2,".",""));
    				$encabezado->setAttribute("NumProveedor","80011057");
    				$encabezado->setAttribute("FolioOrdenCompra",$oc);
    				$encabezado->setAttribute("PorcentajeDescuentoPromo","0.00");
    				$encabezado->setAttribute("PorcentajeMerma","0");
    				$encabezado->setAttribute("TotalDescuento","0.00");
    				$encabezado->setAttribute("TotalMerma","0");
    				$encabezado->setAttribute("Descuento","0.0");
    			///array para el cuerpo:
    			foreach ($data as $key2) {
    			$cuerpo=$xmlDom->createElement("Cuerpo");
    				$encabezado->appendChild($cuerpo);
    				$cuerpo->setAttribute("Renglon",$key2->PARTIDA);
    				$cuerpo->setAttribute("Cantidad",$key2->CANTIDAD);
    				$cuerpo->setAttribute("Concepto",utf8_encode(substr($key2->DESCRIPCION,0,35)));
    				$cuerpo->setAttribute("PUnitario",number_format($key2->PRECIO,2,".",""));
    				$cuerpo->setAttribute("Importe",number_format($key2->PRECIO*$key2->CANTIDAD,2,".",""));
    			}
			$xmlDom->formatOutput = true;
			$xmlDom->save("C:\\xampp\\htdocs\\Facturas\\facturaPegaso\\".$docf."_addenda.xml");
			$descarga = "/Facturas/facturaPegaso/".$docf."_addenda.xml";
			echo '<a href="'.$descarga.'" download >Descarga Addenda</a><br/>';
			echo '<a href="#" onclick="javascritp:window.self.close();" class="btn btn-info">Cerrar ventana</a>';
			return;
	}

	function addendaPropimex($docf, $oc, $entrada, $remision){
		$letras = new NumberToLetterConverter();
			$this->query="SELECT * FROM FTC_FACTURAS f left join FTC_FACTURAS_DETALLE d on f.documento = d.documento where f.documento = '$docf'";
			$rs=$this->EjecutaQuerySimple();
			while ($tsArray=ibase_fetch_object($rs)) {
				$data[]=$tsArray;
			}
			foreach ($data as $key) {
					$fecha=$key->FECHA_DOC;
					$importe=$key->TOTAL;
					$subTotal=$key->SUBTOTAL;
					$iva=$key->IVA;
				}
			$fecha=strtotime($fecha);
			$fechaAddenda=date("Y-m-d T h:i:s", $fecha);
			$rfe="RegimenFiscalEmisor";
    		$mp="";

    		$xml= new SimpleXMLElement('C:\\xampp\\htdocs\\Facturas\\facturaPegaso\\'.$docf.'.xml', null, true);
    		$xmlDom = dom_import_simplexml($xml)->ownerDocument;
    		$padre = $xmlDom->getElementsByTagName("Comprobante")->item(0);
    
    		$addenda=$xmlDom->createElement("Addenda");
    			$padre->appendChild($addenda);
    			$documento=$xmlDom->createElement("Documento");
    				$addenda->appendChild($documento);
    				$factura=$xmlDom->createElement("FacturaFemsa");
    					$documento->appendChild($factura);
    					$nova=$xmlDom->createElement("noVersAdd","01");
    						$factura->appendChild($nova);
    					$claseDoc=$xmlDom->createElement("claseDoc","1");
    						$factura->appendChild($claseDoc);
    					$noSociedad=$xmlDom->createElement("noSociedad","F142");
    						$factura->appendChild($noSociedad);
    					$noProveedor=$xmlDom->createElement("noProveedor","000004004512");
    						$factura->appendChild($noProveedor);
    					$noPedido=$xmlDom->createElement("noPedido",$oc);
							$factura->appendChild($noPedido);
						$moneda=$xmlDom->createElement("moneda","MXP");
							$factura->appendChild($moneda);
						$noEntrada=$xmlDom->createElement("noEntrada", $entrada);
							$factura->appendChild($noEntrada);
						$noRemision=$xmlDom->createElement("noRemision", $remision);
							$factura->appendChild($noRemision);
						$noSocio=$xmlDom->createElement("noSocio");
							$factura->appendChild($noSocio);
						$centroCostos=$xmlDom->createElement("centroCostos");
							$factura->appendChild($centroCostos);
						$iniPerLiq=$xmlDom->createElement("iniPerLiq");
							$factura->appendChild($iniPerLiq);
						$finPerLiq=$xmlDom->createElement("finPerLiq");
							$factura->appendChild($finPerLiq);
						$retencion1=$xmlDom->createElement("retencion1");
							$factura->appendChild($retencion1);
						$retencion2=$xmlDom->createElement("retencion2");
							$factura->appendChild($retencion2);
						$email=$xmlDom->createElement("email","ferreterapegaso@hotmail.com");
							$factura->appendChild($email);
    		$xmlDom->formatOutput = true;
			$xmlDom->save('C:\\xampp\\htdocs\\Facturas\\facturaPegaso\\'.$docf.'_addenda.xml');
			$descarga = "/Facturas/facturaPegaso/".$docf."_addenda.xml";
			echo '<a href="'.$descarga.'" download >Descarga Addenda</a><br/>';
			echo '<a href="#" onclick="javascritp:window.self.close();" class="btn btn-info">Cerrar ventana</a>';
	}

	function addendaAceitera($docf, $oc, $ent ){
		$letras = new NumberToLetterConverter();
		$this->query="SELECT * FROM FTC_FACTURAS f left join FTC_FACTURAS_DETALLE d on f.documento = d.documento where f.documento = '$docf'";
		$rs=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($rs)) {
			$data[]=$tsArray;
		}
		foreach ($data as $key) {
				$fecha=$key->FECHA_DOC;
				$importe=$key->TOTAL;
				$subTotal=$key->SUBTOTAL;
				$iva=$key->IVA;
			}
		$fecha=strtotime($fecha);
		$fechaAddenda=date("Y-m-d T h:i:s", $fecha);
		$rfe="RegimenFiscalEmisor";
    	$mp="";
		$xml= new SimpleXMLElement('C:\\xampp\\htdocs\\Facturas\\facturaPegaso\\'.$docf.'.xml', null, true);
    		$xmlDom = dom_import_simplexml($xml)->ownerDocument;
    		$padre = $xmlDom->getElementsByTagName("Comprobante")->item(0);
    		$addenda=$xmlDom->createElement("Addenda");
    		$padre->appendChild($addenda);

    			$ia=$xmlDom->createElement("IA");
    				$addenda->appendChild($ia);
    			$proveedor=$xmlDom->createElement("Proveeedor","2832");
    				$ia->appendChild($proveedor);
    			/// Partidas
    				foreach ($data as $key2) {
    					$partida=$xmlDom->createElement("Partida");
    					$ia->appendChild($partida);
    					$partida->setAttribute("Posicion",$key2->PARTIDA*10);
    					$partida->setAttribute("Pedido",$oc);
    					$entrada=$xmlDom->createElement("Entrada", $ent);
    					$partida->appendChild($entrada);	
    				}
    				
    		$xmlDom->formatOutput = true;
			$xmlDom->save('C:\\xampp\\htdocs\\Facturas\\facturaPegaso\\'.$docf.'_addenda .xml');
			$descarga = "/Facturas/facturaPegaso/".$docf."_addenda.xml";
			echo '<a href="'.$descarga.'" download >Descarga Addenda</a><br/>';
			echo '<a href="#" onclick="javascritp:window.self.close();" class="btn btn-info">Cerrar ventana</a>';
	}

	function addendaLoreal($docf, $oc, $recepcion, $cc){
		$letras = new NumberToLetterConverter();
		$this->query="SELECT * FROM FTC_FACTURAS f left join FTC_FACTURAS_DETALLE d on f.documento = d.documento where f.documento = '$docf'";
		$rs=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($rs)) {
				$data[]=$tsArray;
			}
			foreach ($data as $key) {
					$fecha=$key->FECHA_DOC;
					$importe=$key->TOTAL;
					$subTotal=$key->SUBTOTAL;
					$iva=$key->IVA;
					$folio=$key->FOLIO; 
					$serie=$key->SERIE;
				}
			$fecha=strtotime($fecha);
			$fechaAddenda=date("Y-m-d T h:i:s", $fecha);
			$rfe="REGIMEN GENERAL DE LEY PERSONAS MORALES";
    		$mp="";
    		$xml= new SimpleXMLElement('C:\\xampp\\htdocs\\Facturas\\facturaPegaso\\'.$docf.'.xml', null, true);
    		$xmlDom = dom_import_simplexml($xml)->ownerDocument;
    		$padre = $xmlDom->getElementsByTagName("Comprobante")->item(0);
    		$addenda = $xmlDom->createElement("cfdi:Addenda");
    			$addenda = $padre->appendChild($addenda);
    			$facturaIF=$xmlDom->createElement("if:FacturaInterfacura");
    			   	$addenda->appendChild($facturaIF);
    				$xnl=$facturaIF->setAttribute("xmlns:if","https://www.interfactura.com/Schemas/Documentos");
    				$tipoDoc=$facturaIF->setAttribute("TipoDocumento","Factura");
    			$emisor=$xmlDom->createElement("if:Emisor");
    				$facturaIF->appendChild($emisor);
    				$eri=$emisor->setAttribute("RI","0503590");
    				//$nprov=$emisor->setAttribute("NumProveedor","80011057");
    			$receptor=$xmlDom->createElement("if:Receptor");
    				$facturaIF->appendChild($receptor);
    				$rri=$receptor->setAttribute("RI","0130466");
    			$encabezado=$xmlDom->createElement("if:Encabezado");
    				$facturaIF->appendChild($encabezado);
    				$encabezado->setAttribute("Moneda","MXN");
    				$encabezado->setAttribute("FolioOrdenCompra",$oc);
    				$encabezado->setAttribute("FolioNotaRecepcion",$recepcion);
    				$encabezado->setAttribute("Fecha",$fechaAddenda);
    				$encabezado->setAttribute("Folio",$folio);
    				$encabezado->setAttribute("Serie","$serie");
    				$encabezado->setAttribute("CondicionPago", "60");
    				$encabezado->setAttribute("CargoTipo","");
    				$encabezado->setAttribute("IVAPCT","16");
    				$encabezado->setAttribute("Iva",number_format($iva,2,".",""));
    				$encabezado->setAttribute("NumProveedor","5974");
    				$encabezado->setAttribute("SubTotal",number_format($subTotal,2,".",""));
    				$encabezado->setAttribute("Total",number_format($importe,2,".",""));
    				$encabezado->setAttribute("Observaciones","");
    			///array para el cuerpo:
    				foreach ($data as $key2) {
    					$partida = (strlen($key2->PARTIDA) == 1)? '000'.$key2->PARTIDA:'00'.$key2->PARTIDA;
    					$cuerpo=$xmlDom->createElement("if:Cuerpo");
		    				$encabezado->appendChild($cuerpo);
		    				$cuerpo->setAttribute("Cantidad",$key2->CANTIDAD);
		    				$cuerpo->setAttribute("Concepto",utf8_encode($key2->DESCRIPCION));
		    				$cuerpo->setAttribute("PUnitario",number_format($key2->PRECIO,2,".",""));
		    				$cuerpo->setAttribute("Importe",number_format($key2->PRECIO * $key2->CANTIDAD,2,".",""));
		    				$cuerpo->setAttribute("UnidadMedida","");
		    				$cuerpo->setAttribute("Partida",$partida);
		    				$cuerpo->setAttribute("Iva","");
		    				$cuerpo->setAttribute("IVAPCT","16.00");
    				}
    		$xmlDom->formatOutput = true;
			$xmlDom->save('C:\\xampp\\htdocs\\Facturas\\facturaPegaso\\'.$docf.'_addenda.xml');
			$descarga = "/Facturas/facturaPegaso/".$docf."_addenda.xml";
			echo '<a href="'.$descarga.'" download >Descarga Addenda</a><br/>';
			echo '<a href="#" onclick="javascritp:window.self.close();" class="btn btn-info">Cerrar ventana</a>';
			return;
	}

	function verFTCNCpendientes($docnc){
		$data=array();
		if($docnc == ''){
			$this->query="SELECT * FROM FTC_NC WHERE SERIE = 'NCD' AND STATUS = 7";
			$rs=$this->EjecutaQuerySimple();
			while ($tsArray=ibase_fetch_object($rs)){
				$data[]=$tsArray;
			}
			$this->query="SELECT * FROM FTC_NCI WHERE SERIE = 'NCI' AND STATUS = 7";
			$rs=$this->EjecutaQuerySimple();
			while ($tsArray=ibase_fetch_object($rs)){
				$data[]=$tsArray;
			}
		}else{
			$this->query="SELECT NCD.*, NC.*, CAST((SELECT LIST(CL.NOMBRE, CL.CALLE||', '||CL.numExt) FROM CLIE01 CL WHERE CL.CLAVE_TRIM = NC.CLIENTE) AS VARCHAR(100)) AS NOMBRE FROM FTC_NC_DETALLE NCD left join FTC_NC NC ON NCD.DOCUMENTO = NC.DOCUMENTO WHERE NCD.DOCUMENTO = '$docnc'";
			$rs=$this->EjecutaQuerySimple();
			while ($tsArray=ibase_fetch_object($rs)){
				$data[]=$tsArray;
			}
			$this->query="SELECT NCD.*, NC.*, CAST((SELECT LIST(CL.NOMBRE, CL.CALLE||', '||CL.numExt) FROM CLIE01 CL WHERE CL.CLAVE_TRIM = NC.CLIENTE) AS VARCHAR(100)) AS NOMBRE FROM FTC_NCI_DETALLE NCD left join FTC_NCI NC ON NCD.DOCUMENTO = NC.DOCUMENTO WHERE NCD.DOCUMENTO = '$docnc'";
			$rs=$this->EjecutaQuerySimple();
			while ($tsArray=ibase_fetch_object($rs)){
				$data[]=$tsArray;
			}
		}
		return $data;
	}

	function revisaNCold($idd){
		$usuario=$_SESSION['user']->NOMBRE;
		$this->query="SELECT * FROM FTC_FOLIOS_DEV WHERE idd=$idd";
		$rs=$this->EjecutaQuerySimple();
		$row=ibase_fetch_object($rs);
		if(empty($row->STATUS)){
			$this->query="UPDATE FTC_FOLIOS_DEV SET STATUS = 1, USUARIO='$usuario', fecha=current_timestamp where idd= $idd";
			$this->queryActualiza();
			$status = 2;
		}else{
			$status = $row->STATUS;
		}
		return $val=$status;
	}


	function generaNCold($idd){
		$fact = new factura;
		$usuario=$_SESSION['user']->NOMBRE;
			$this->query="SELECT p.*, (select max(factura) from cajas where id = idcaja) AS FACTURA FROM PAQUETES p WHERE FOLIO_DEV = $idd";
			$rs=$this->EjecutaQuerySimple();
			while ($tsArray=ibase_fetch_object($rs)) {
				$data[]=$tsArray;
			}
			foreach ($data as $key) {
				$factura=$key->FACTURA;
				$docf =$key->DOCUMENTO;
				$idc=$key->IDCAJA;
			}
				$folsig = $idd;
				$docNC = $fact->creaFolioNCD();
		    	$docNCD=$docNC['docNCD'];
		    	$folio = $docNC['folioNC'];
		    	$serie = $docNC['serieNC'];
		    	
		    	$tabla = 'FTC_NC';
		    	$tablad = 'FTC_NC_DETALLE';
		    	if(substr($factura, 0,3) == 'FAA' or (substr($factura,0,2) == 'RF' and substr($factura,0,3) != 'RFP')){
		    		$this->query="EXECUTE PROCEDURE SP_FAA_NCD ('$factura', '$docNCD','$folio','$serie', '$usuario')";
		    		$r=$this->EjecutaQuerySimple();
		    		$row2=ibase_fetch_object($r);		
		    	}else{
		    		$this->query="EXECUTE PROCEDURE SP_FP_NC('$folio','$serie','$factura', '$usuario', '$docNCD')";
		    		$r=$this->EjecutaQuerySimple();
		    		$row2=ibase_fetch_object($r);
		    	}
		    	$this->insertaDetalleNC($folsig, $tablad, $row2->TERMINO, $docNCD, $docf, $usuario, $idc,$factura );
		    	$this->query="UPDATE $tabla SET 
			 	SUBTOTAL = (select sum(subtotal) from FTC_NC_DETALLE where DOCUMENTO = '$docNCD'),
			  	TOTAL = (SELECT SUM(TOTAL) FROM FTC_NC_DETALLE WHERE DOCUMENTO = '$docNCD'),
			  	IVA = (SELECT SUM(SUBTOTAL)*.16 from FTC_NC_DETALLE WHERE DOCUMENTO = '$docNCD'), 
			  	 desc1 = (SELECT sum(DESC1) FROM FTC_NC_DETALLE WHERE DOCUMENTO = '$docNCD') 
			  	where documento = '$docNCD'";
				$this->EjecutaQuerySimple();

				$this->query="UPDATE FACTF01 SET 
								SALDOFINAL = SALDOFINAL-(SELECT TOTAL FROM FTC_NC WHERE DOCUMENTO = '$docNCD'),
								importe_nc = importe_nc+(SELECT TOTAL FROM FTC_NC WHERE DOCUMENTO = '$docNCD'), 
								nc_aplicadas =  iif(nc_aplicadas = '' or nc_aplicadas is null, '$docNCD', nc_aplicadas||','||'$docNCD')
								where cve_doc = '$factura'";
				$this->EjecutaQuerySimple();
				echo '<br/> Actualiza FACT01: '.$this->query;
				
				$this->query="UPDATE FTC_FACTURAS SET 
								SALDO_FINAL = SALDO_FINAL-(SELECT TOTAL FROM FTC_NC WHERE DOCUMENTO = '$docNCD'),
								MONTO_nc = MONTO_nc+(SELECT TOTAL FROM FTC_NC WHERE DOCUMENTO = '$docNCD'), 
								NOTAS_CREDITO = iif(NOTAS_CREDITO = '', '$docNCD', NOTAS_CREDITO||','||'$docNCD')
								where DOCUMENTO = '$factura'"; 
				$this->EjecutaQuerySimple();
				echo '<br/> Actualiza FP: '.$this->query;

		return $docNCD;
	}

	function verDetalleDevolucion($idd){
		$this->query="SELECT p.*, 
			iif((select factura from cajas where id = p.idcaja) is null or (select factura from cajas where id = p.idcaja) = '', (select remision from cajas where id=p.idcaja), (select factura from cajas where id=p.idcaja)) as documento_venta FROM PAQUETES p WHERE FOLIO_DEV = $idd";
		$rs=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($rs)) {
			$data[]=$tsArray;
		}
		return $data;
	}

	function ctrlParcial($idc){
		$this->query="SELECT * FROM CAJAS WHERE ID = $idc";
		$rs=$this->EjecutaQuerySimple();
		$row=ibase_fetch_object($rs);
		$pedido=$row->CVE_FACT;

		$this->query="SELECT * FROM ctrlparcial WHERE caja = '$idc'";
		$res=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($res)) {
				$data[]=$tsArray;
			}	
		$pedido=0;
		$paquete=0;
			foreach ($data as $key){
			//$response[] = 	array("Pedido"=>$key->PEDIDO,"CantidadP"=>$key->CANTP,"CantidadPa"=>$key->CANTPA,"CAJA"=>$key->CAJA);
				$pedido+=$key->CANTP;
				$paquete+=$key->CANTPA;
			}
			if($pedido == $paquete){
				$response= array("status"=>"Completo");
			}else{
				$response =array("status"=>"Parcial");
			}
		return $response;
	}

	function entidades(){
		$data=array();
		$this->query="SELECT * FROM FTC_ENTIDADES WHERE TIPO = 'Fide' and status = 'A'";
		$res=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($res)){
			$data[]=$tsArray;
		}
		return $data;
	}

	function traeBancosSAT(){
		$this->query="SELECT * FROM BANCOS_SAT ";
		$rs=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($rs)) {
			$data[]=$tsArray;
		}
		return $data;
	}

	function traePedido($docp){
		$data=array();
		$this->query="SELECT * FROM PREOC01 WHERE COTIZA = upper('$docp')";
		$res=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($res)) {
			$data[]=$tsArray;
		}
		return $data;
	}

	function prefactura($docp){
		/// Obtenemos los valores originales.
		/// Simulamos la entrada.
		$this->query="UPDATE PREOC01 SET RECEPCION = CANT_ORIG, caja_pegaso = RECEPCION WHERE COTIZA = '$docp'";
		$this->queryActualiza();
		/// Insertamos la caja
		$caja=$this->NuevaCaja($docp);
		if(isset($caja)){
			$this->query="SELECT * FROM PREOC01 WHERE COTIZA ='$docp'";
			$rs=$this->EjecutaQuerySimple();
			while($tsArray=ibase_fetch_object($rs)){
				$data[]=$tsArray;
			}
			foreach ($data as $key) {
				$idpreoc =$key->ID;
				/// Asignamos.
				$this->ActEmpaque($idpreoc, 1, $caja, 'Caja', $docp);
				/// Embalamos.
				$this->AsignaEmbalaje($docp,1,1,'Caja',1,1,1,1,1,$caja,1);
				/// Actualizamos la caja a los valores correcto.
			}
			$this->query="UPDATE PREOC01 SET RECEPCION = CAST(caja_pegaso AS INT) WHERE COTIZA = '$docp'";
			$this->queryActualiza();
			return array("status"=>'ok', "mensaje"=>"Se creo la nueva Caja".$caja.", favor de revisar en el modulo Documentar Caja");
		}else{
			$this->query="UPDATE PREOC01 SET RECEPCION = CAST(caja_pegaso AS INT) WHERE COTIZA = '$docp'";
			$this->queryActualiza();
			return array("status"=>'no',"mensaje"=>'Ya existe una caja Abierta');
		}
		
	}

	function copiarProd($idp){
		$usuario=$_SESSION['user']->NOMBRE;
		$this->query="SELECT * FROM FTC_ARTICULOS_N WHERE REFERENCIA = $idp";
		$rs=$this->EjecutaQuerySimple();
		$val = ibase_fetch_object($rs);
		if($val){
			return array("status"=>"ok", "nuevo"=>$val->ID);
		}else{
			$this->query ="EXECUTE PROCEDURE SP_COPIA_FTC_ART('$idp', '$usuario')";
			$res=$this->EjecutaQuerySimple();
			$row = ibase_fetch_object($res);
			return array("status"=>"ok","nuevo"=>$row->IDN);	
		}	
	}

	function traeCajas($docp){
		$data=array();
		$this->query="SELECT * FROM CAJAS WHERE (status = 'abierto' or (status='cerrado' and (factura= '' or remision = ''))) and cve_fact =upper('$docp')";
		//echo $this->query;
		$res=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($res)) {
			$data[]=$tsArray;
		}
		return $data;
	}


	function guardaProveedor($nombre,$rfc,$marca,$telefono,$calle,$ext,$int,$ciudad,$cp,$pais,$deleg,$mun,$correoGen,$contPrim){
		
		$this->query="SELECT * FROM TBLCONTROL01 where ID_TABLA = 12";
		$res=$this->EjecutaQuerySimple();
		$row=ibase_fetch_object($res);
		$clave = $row->ULT_CVE + 1;

		$this->query="UPDATE TBLCONTROL01 SET ULT_CVE = $clave where ID_TABLA = 12";
		$this->grabaBD();

		$this->query="INSERT INTO PROV01 (CLAVE, STATUS, NOMBRE, RFC, CALLE, NUMINT, NUMEXT, COLONIA, CODIGO, MUNICIPIO, ESTADO, CVE_PAIS, TELEFONO, EMAILPRED, RESP_COMPRA )
		 VALUES (LPAD('$clave',10), 'A', '$nombre', '$rfc', '$calle', '$int', '$ext','$mun', '$cp', '$deleg', '$ciudad', '$pais', '$telefono', '$correoGen', '$contPrim')";
		$this->grabaBD();

		return $nombre;
	}

	function validaRFC($rfc, $tipo){
		if($tipo=='cliente'){
			$tabla = 'CLIE01';
		}elseif($tipo =='Proveedor'){
			$tabla = 'PROV01';
		}
		$this->query="SELECT cast(LIST(CLAVE||'-->'||NOMBRE) as varchar(100)) AS ENTIDAD FROM $tabla WHERE upper(RFC) containing(upper('$rfc'))";
		$res=$this->EjecutaQuerySimple();
		$row=ibase_fetch_object($res);
		if(!empty($row->ENTIDAD)){
			$mensaje=array("status"=>'no', "aviso"=>"El RFC existe en el ".$tipo.' -->'.$row->ENTIDAD);
		}else{
			$mensaje=array("status"=>'ok', "aviso"=>"No existe el RFC eb la BD");
		}

		return $mensaje;
	}

	function crearCliente($nombre, $direccionC, $direccionE, $colonia, $ciudad, $rfc, $motivo){
		$this->query="SELECT * FROM TBLCONTROL01 where ID_TABLA = 0";
		$res=$this->EjecutaQuerySimple();
		$row=ibase_fetch_object($res);
		$clave = $row->ULT_CVE + 1;

		$this->query="UPDATE TBLCONTROL01 SET ULT_CVE = $clave where ID_TABLA = 0";
		$this->grabaBD();
		
		$this->query="INSERT INTO CLIE01 (CLAVE, NOMBRE, STATUS, RFC, CALLE, NUMEXT, COLONIA, ESTADO, CLAVE_TRIM, MODELO) 
					VALUES (LPAD('$clave',10), '$nombre', 'A', '$rfc', '$direccionC', '$direccionE', '$colonia', '$ciudad', '$clave','$motivo') ";
		$this->EjecutaQuerySimple();
		return;
	}


	function verFactura($docf){
		$this->query="SELECT DF.*, F.*, (SELECT NOMBRE FROM CLIE01 WHERE CLAVE_TRIM = F.CLIENTE) AS NOMBRE_cliente  FROM DETALLE_FACTURAS_FP DF LEFT JOIN FTC_FACTURAS F ON F.DOCUMENTO = DF.CVE_DOC WHERE CVE_DOC = '$docf'";
		$res=$this->EjecutaQuerySimple();
		while($tsArray=ibase_fetch_object($res)){
			$data[]=$tsArray;
		}
		return $data;
	}

	function catColaboradores(){
		$data = array();
		$this->query="SELECT * FROM FTC_COLABORADORES WHERE STATUS=0";
		$res=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($res)) {
			$data[]=$tsArray;
		}
		$this->creaLayoutCol();
		return $data;
	}

	function crearColaborador($nombre, $segundo, $paterno, $materno, $compania, $puesto, $clave, $tarjeta, $cveBanco, $tarBanco){
		$this->query="INSERT INTO FTC_COLABORADORES (ID, CIA, AREA, NOMBRE, SEGUNDO_NOMBRE, PATERNO, MATERNO, CLAVE_INTERBANCARIA, NUMERO_TARJETA, BANCO_TARJETA, BANCO_CLAVE, STATUS ) 
		VALUES (NULL, '$compania', '$puesto','$nombre', '$segundo', '$paterno', '$materno',  '$clave', '$tarjeta', '$cveBanco', '$tarBanco',0)";
		$this->grabaBD();
		return;
	}

	function creaLayoutCol(){
		$this->query="SELECT * FROM FTC_COLABORADORES WHERE STATUS = 0";
		$res=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($res)) {
			$data[]=$tsArray;
		}
		$i=0;
		$subTotal= 0;
		foreach ($data as $k) {
			$i++;
			$subTotal=$subTotal+(100+$i); 
		}

		$file = fopen("app/LayoutBBVA/Alta/pagoBNMX.txt","a");
		/// Escribimos la Primera linea.
		$nombre = 'Oscar';
		$alias = 'Farias';
		$correo = 'ofarias@ftcenlinea.com';
		// Primera Linea
		$anio='18'; 
		$mes ='10';
		$dia ='31';
		$empresa = str_pad("FERRETERA PEGASO SA DE CV", 35," ", STR_PAD_RIGHT);
		$leyenda = str_pad("Pago de nomina", 20," ", STR_PAD_RIGHT);
		fwrite($file,'1000098497507'.$anio.$mes.$dia."0001".$empresa.$leyenda.'15D01'.PHP_EOL);
		// Segunda linea.
		$monto = $subTotal;
		$monto = str_pad($monto, 18, "0",STR_PAD_LEFT);
		$cuenta = '70046234055';
		fwrite($file, '21001'.$monto.'01000000000'.$cuenta.'000011'.PHP_EOL);
		// Informacion del Layput;
		$i = 0;
		foreach ($data as $key ) {
			$i++;
			$imp = 100+$i;
			$importe= str_pad($imp,19,"0",STR_PAD_LEFT);
			$cuenta = ($key->NUMERO_TARJETA ==  '1111111111111111')? $key->CLAVE_INTERBANCARIA:$key->NUMERO_TARJETA;
			$cuenta = str_pad($cuenta,20," ",STR_PAD_RIGHT);
			$nombre = empty($key->SEGUNDO_NOMBRE)? $key->NOMBRE:$key->NOMBRE.' '.$key->SEGUNDO_NOMBRE; 
			$apellidos = $key->PATERNO.'/'.$key->MATERNO;
			$nombreCompleto=str_pad($nombre.','.$apellidos,195," ",STR_PAD_RIGHT);
			$complemento = str_pad('000000',158," ",STR_PAD_RIGHT);
			fwrite($file, '3000101001'.$importe.'30000'.$cuenta.'Pegaso SA CV'.$nombreCompleto.$complemento.PHP_EOL);
		}
		/// Ultima Linea;
		fwrite($file, '4001000011'.$monto.'000001'.$monto.PHP_EOL);

		/*
					$i++;
	    			$nombre=str_pad(substr($key->NOMBRE,0,30),30," ");
	    			$ctabbva = str_pad($cuentaOK, 18, 0, STR_PAD_LEFT);
	    			$alias = str_pad(substr(trim($cve_prov).'_'.$nombre,0,30),30," ");
	    			$correo = str_pad(trim($correo),80," ");
	    			$file = fopen("app/LayoutBBVA/Alta/archivo_clabe.txt", "a");
					fwrite($file, substr($ctabbva,0,3).$ctabbva."MXP"."0000004999999.00".$nombre.$alias.'40'.$correo.PHP_EOL);
					fclose($file);
		*/

		return;
	}


	function crearCajaC($docf){
		$refac=array();
		$ref=array();
		$this->query="SELECT * FROM REFACTURACION WHERE FACTURA_NUEVA = '$docf'";
		$res=$this->EjecutaQuerySimple();
		$ref = ibase_fetch_object($res);
		if($ref){ /// es una refacturacion.
			$caja = $ref->CAJA; 
			$factOld=$ref->FACT_ORIGINAL;
			if(!empty($caja)){ //// Si tiene la caja la refacturacion, actualiza y se sale.
				$this->query="UPDATE CAJAS SET FACTURA = '$docf' where id = $caja";
				$this->queryActualiza();
				return $mensaje=array("status"=>'ok', "caja"=>$caja,"lugar"=>'Refacturacion');
			}else{ /// La refacturacion no tiene cajas capturada
				$control = $this->buscaControlFac($docf, $factOld);
				return $control;
			}	
		}else{/// Si no es una refacturacion la buscas en el control de facturacion.
				$control = $this->buscaControlFac($docf, $factOld=$docf);
				return $control;
		}

	}

	function buscaControlFac($docf, $factOld){
		$ref=array();
		$this->query="SELECT * FROM CONTROL_FACT_REM WHERE FACTURAS CONTAINING('$factOld')";
				$r=$this->EjecutaQuerySimple();
				while($tsArray=ibase_fetch_object($r)){
					$ref[]=$tsArray;
				}
				if(count($ref)>0){ /// Si la encuentra en el control de Facturas.
					foreach ($ref as $key) {/// Obtenemos la caja desde el control de factura.
							$this->query="UPDATE CAJAS SET FACTURA = '$docf' where id = $key->CAJA";
							$this->EjecutaQuerySimple();
							
							$this->query="UPDATE REFACTURACION SET CAJA = $key->CAJA WHERE FACTURA_NUEVA = '$docf'";
							$this->EjecutaQuerySimple();
							return array("status"=>'ok', "caja"=>$key->CAJA, "lugar"=>'Control Facturas');
					}			
				}else{/// No la encontro el el control de Facturas Remisiones, CREAMOS LA NUEVA CAJA CERRADA PARA ENVIAR A lOGISTICA.
					$creaCaja=$this->cambiarFactura($docf, 'C');
					$this->query="UPDATE FTC_FACTURAS SET IDCAJA = $crearCaja where documento = '$docf'";
					$this->queryActualiza();
					$this->query="UPDATE REFACTURACION SET CAJA = $key->CAJA WHERE FACTURA_NUEVA = '$docf'";
					$this->queryActualiza();
					return array("status"=>'ok', "caja"=>$creaCaja,"lugar"=>'Crear Caja');
				}
	}

	function verDatosEnvio($clie){
		$data = array();
		$this->query="SELECT C.*, CAST(CAMPLIB7 AS VARCHAR(1000)) AS CAMPLIB7 FROM CLIE01 C LEFT JOIN CLIE_CLIB01 CL ON C.CLAVE = CL.CVE_CLIE WHERE C.CLAVE= '$clie'";
		$rs=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($rs)) {
			$data[]=$tsArray;
		}
		return $data;
	}

	function salvarDatosEnvio($clave,$calle,$ext,$int,$col,$del,$ciudad,$edo,$pais,$cp,$obs){
		$this->query="UPDATE CLIE01 SET CALLE_ENVIO ='$calle', NUMINT_ENVIO='$ext', NUMEXT_ENVIO='$int', COLONIA_ENVIO ='$col', LOCALIDAD_ENVIO ='$ciudad', MUNICIPIO_ENVIO='$del', ESTADO_ENVIO ='$edo', PAIS_ENVIO='$pais', CODIGO_ENVIO='$cp' where clave = '$clave'";
		$this->queryActualiza();

		$this->query="UPDATE CLIE_CLIB01 SET CAMPLIB7 = '$obs' where CVE_CLIE = '$clave'";
		$this->queryActualiza();

		return;
	}

	function traeRoles(){
		$data= array();
		$this->query="SELECT * FROM FTC_ROLES WHERE STATUS = 0";
		$res=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($res)) {
			$data[]=$tsArray;
		}
		return $data;
	}

	function mXMLSP($tipo, $anio){
		$data= array();
		if($tipo=='R'){	
			$rfc=$_SESSION['rfc'];
			$condicion = "and cliente = '".$rfc."'";
		}else{
			$rfc=$_SESSION['rfc'];
			$condicion = "and cliente != '".$rfc."'";
		}
		//// Obtenemos los datos del RFC de la empresas Emisora para distingir lo los emitidos con los recibidos.
		$this->query="SELECT count(ID) as xmls,tipo, extract(month from fecha) as mes, extract(year from fecha) as anio, 
					sum(subtotal * TipoCambio) as egresosS,
					sum(importe * TipoCambio) as egresosT,
					(select max(nombre) from PERIODOS_2016 where numero = extract(month from fecha)) as nombre,
					(select count(ID) FROM XML_DATA WHERE extract(year from fecha) = $anio and extract(month from fecha) = extract(month from x.fecha) $condicion And status = 'P' and tipo = x.tipo ) as Faltantes
					FROM XML_DATA x
					  WHERE STATUS != 'Procesado'
						  	and extract(year from fecha) = $anio 
							$condicion
					group by extract(month from fecha),extract(year from fecha), tipo";
		//echo $this->query;
		$res=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($res)) {
			$data []=$tsArray;
		}
		return $data;
	}

	function cabeceraPoliza($uuid, $ide){
		$data=array();
		$val = '';
		if($ide == 'Emitidos'){
			$this->query="SELECT x.*, xc.*, extract(month from x.fecha) as periodo, extract(year from x.fecha) as ejercicio  FROM XML_DATA x left join xml_clientes xc on xc.rfc = x.cliente  and xc.tipo = 'Cliente' WHERE x.UUID ='$uuid'";
		}else{
			$this->query="SELECT x.*, xc.*, extract(month from x.fecha) as periodo, extract(year from x.fecha) as ejercicio  FROM XML_DATA x left join xml_clientes xc on xc.rfc = x.rfce  and xc.tipo = 'Proveedor' WHERE x.UUID ='$uuid'";
		}
		$res=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($res)){
			$data[]=$tsArray;
		}
		foreach ($data as $key) {
			$cc = $key->CUENTA_CONTABLE;
			//echo 'Valor de CC: '.$cc.'<br/>';
			if(empty($cc)){
				$val = 'error';
			}elseif($key->STATUS == 'D'){
				$val = 'error';
			}
		}
		if($val == 'error'){
			$data = $val;	
		}
		return $data;
	}

	function cabeceraDocumento($uuid){
		$data=array();
		$rfcEmp = $_SESSION['rfc'];
		$this->query="SELECT x.*, xc.*, extract(month from x.fecha) as periodo, extract(year from x.fecha) as ejercicio  FROM XML_DATA x left join xml_clientes xc on xc.rfc = x.rfce  and xc.tipo = iif(x.CLIENTE = '$rfcEmp','Proveedor', 'Cliente') WHERE x.UUID ='$uuid'";
		//echo $this->query;
		$res=$this->EjecutaQuerySimple();

		while ($tsArray=ibase_fetch_object($res)){
			$data[]=$tsArray;
		}
		return $data;	
	}

	function detallePoliza($uuid){
		$data = array();
		$val = '';
		$this->query="SELECT * FROM XML_PARTIDAS WHERE UUID = '$uuid'";
		$res=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($res)){
			$data[]=$tsArray;
		}
		foreach ($data as $key) {
			$cc = $key->CUENTA_CONTABLE;
			if(empty($cc)){
				$val = 'error';
			}
		}
		if($val == 'error'){
			$data = $val;	
		}
		return $data;
	}

	function impuestosPoliza($uuid){
		$data = array();
		$this->query="SELECT * FROM XML_IMPUESTOS WHERE UUID = '$uuid'";
		$res=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($res)){
			$data[]=$tsArray;
		}
		return $data;	
	}

	function impuestosPolizaFinal($uuid){
		$data = array();	
		$this->query="SELECT impuesto, tasa, tipofactor, tipo, sum(MONTO) AS MONTO, SUM(BASE) AS BASE  FROM XML_IMPUESTOS WHERE UUID in ('$uuid') group by impuesto, tasa, tipofactor, Tipo";
		$res=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($res)){
			$data[]=$tsArray;
		}	
		//print_r($data);
		//exit();
		return $data;	
	}

	function actXml($uuid, $tipo, $crea){
		$poliza = str_pad($crea['numero'], 5, ' ', STR_PAD_LEFT);
		$periodo = $crea['periodo'];
		$ejercicio = $crea['ejercicio'];
		$usuario =$_SESSION['user']->NOMBRE; 
		$status = 'D';
		if($tipo == 'Ig'){
			$status='I';	
		}elseif($tipo == 'Eg'){
			$status='E';	
		}
		$this->query="UPDATE XML_DATA set STATUS='$status' where uuid='$uuid'";
		$this->EjecutaQuerySimple();
		$this->query="INSERT INTO XML_POLIZAS (ID, UUID, STATUS, POLIZA, TIPO, PERIODO, EJERCICIO, USUARIO, FECHA) 
							VALUES (NULL, '$uuid', 'A', '$poliza', '$tipo', $periodo, $ejercicio, '$usuario', current_timestamp)";
		$this->grabaBD();
		return;
	}

	function verPolizas($uuid){
		$data=array();
		$this->query="SELECT * FROM XML_POLIZAS WHERE UUID = '$uuid' and status = 'A'";
		$res=$this->EjecutaQuerySimple();
		while($tsArray=ibase_fetch_object($res)){
			$data[]=$tsArray;
		}
		return $data;
	}

	function traeDF($ide){
		$this->query="SELECT e.*, d.* FROM FTC_EMPRESAS e left join ftc_empresas_dir d on d.ide = e.id WHERE e.ID = $ide";
		$res=$this->EjecutaQuerySimple();
		$row=ibase_fetch_object($res);
		return $row;
	}

	 function facturasMaestro($pago){
	 	//echo '<br/> Pago: '.print_r($pago);
    	foreach ($pago as $k) {
    		$maestro = $k->CLAVE_MAESTRO;
    	}
    	///echo '<br/> Maestro '.$maestro.'<br/>';
		$data=array();
		$this->query="SELECT F.*, (SELECT NOMBRE FROM CLIE01 C WHERE C.CLAVE=F.CVE_CLPV) AS CLIENTE FROM FACTURAS_PENDIENTES F WHERE F.CLAVE_MAESTRO = '$maestro'";
		$res=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($res)) {
			$data[]=$tsArray;
		}
		$this->query="SELECT f.*, (SELECT NOMBRE FROM CLIE01 C WHERE C.CLAVE_TRIM=f.CVE_CLPV) AS CLIENTE FROM FACTURAS_PENDIENTES_FP f WHERE f.CLAVE_MAESTRO = '$maestro'";
		$res=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($res)) {
			$data[]=$tsArray;
		}
		if(empty($maestro)){
			$rfc = $_SESSION['rfc'];
			$this->query="SELECT X.*, IMPORTE - COALESCE( (SELECT SUM(A.MONTO_APLICADO) FROM APLICACIONES A WHERE A.DOCUMENTO = X.DOCUMENTO),0) as saldofinal, x.documento as cve_doc, x.fecha as fechaelab, (SELECT NOMBRE FROM XML_CLIENTES XC WHERE X.CLIENTE = XC.RFC AND XC.TIPO = 'Cliente') AS NOMBRE  FROM XML_DATA X WHERE TIPO = 'I' AND (IMPORTE - COALESCE( (SELECT SUM(A.MONTO_APLICADO) FROM APLICACIONES A WHERE A.DOCUMENTO = X.DOCUMENTO),0) )> 1 AND RFCE ='$rfc' ";

			$res=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($res)){
			$data[]=$tsArray;
		}
		}
		return $data;
    }

	function verBancos($idb){
        $data = array();
        $condicion='';
        if($idb > 0){
        	$condicion=' and bp.id = '.$idb;
        }
        $this->query="SELECT BP.*, B.NOMBRE AS FISCAL, B.BANCO AS COMERCIAL, B.CLAVE  FROM PG_BANCOS BP LEFT JOIN BANCOS_SAT B ON B.ID = BP.ID_BANCO WHERE BP.STATUS = 1 $condicion";
        $res=$this->EjecutaQuerySimple();
        while ($tsArray=ibase_fetch_object($res)){
            $data[]=$tsArray;
        }
        return $data;
    }

    function editaBanco($idb, $si, $cuenta, $dia, $cc, $tipo){
    	$this->query="UPDATE PG_BANCOS SET saldoi = $si, num_cuenta = '$cuenta', dia_corte = $dia, cta_Contab='$cc', tipo='$tipo' where id= $idb";
    	$this->queryActualiza();
    	return;
    }

    function insertaBanco($banco, $cuenta, $tipo, $moneda, $saldo, $fecha, $observaciones){
    	$this->query="INSERT INTO PG_BANCOS (id, BANCO, NUM_CUENTA, tipo, MONEDA, SALDOI, DIA_CORTE, SERIE, status, id_banco, RFC ) VALUES (NULL, (SELECT BANCO FROM BANCOS_SAT WHERE ID = $banco), '$cuenta', '$tipo', '$moneda', $saldo, $fecha, '$observaciones', 1, $banco, (select rfc from bancos_sat where id= $banco))";
    	$this->grabaBD();
    }

    function traeBancoSat(){
    	$data=array();
    	$this->query="SELECT * FROM BANCOS_SAT";
    	$res=$this->EjecutaQuerySimple();
    	while ($tsArray=ibase_fetch_object($res)) {
    		$data[]=$tsArray;
    	}
    	return $data;
    }

     function bajaM($idm, $cvem){
    	$dc=array();
    	$df=array();
    	$dfp=array();
    	$da=0;
    	$this->query="SELECT * FROM CLIE01 WHERE CVE_MAESTRO = '$cvem' and status = 'A'";
    	$res=$this->EjecutaQuerySimple();
    	while ($tsArray=ibase_fetch_object($res)) {
    		$dc[]=$tsArray;
    	}
    	if(count($dc)==0){
    		$this->query="SELECT * FROM FACTF01 WHERE CVE_MAESTRO = '$cvem' and saldoFinal > 5 and fecha_doc >= '01.01.2017'";
    		$res=$this->EjecutaQuerySimple();
    		while ($tsArray=ibase_fetch_object($res)) {
    			$df[]=$tsArray;
    		}
    		if(count($df)==0){
    			$this->query="SELECT * FROM FACTURAS_FP WHERE CVE_MAESTRO = '$cvem' and saldofinal > 5";
	    		$res=$this->EjecutaQuerySimple();
	    		while ($tsArray=ibase_fetch_object($res)) {
	    			$dfp[]=$tsArray;
	    		}
	    		if(count($dfp)==0){
	    			$this->query="SELECT coalesce(sum(saldo),0) as saldo FROM CARGA_PAGOS WHERE cliente = cast($idm as varchar(100))";
		    		$res=$this->EjecutaQuerySimple();
		    		$row=ibase_fetch_object($res);
		    		$da=$row->SALDO;
		    		if($da < 10){
		    			$this->query="UPDATE MAESTROS SET STATUS='B' WHERE ID =$idm";
	    				$res=$this->EjecutaQuerySimple();
    					return array("status"=>'ok', "mensaje"=>'Se realizo la baja del Maestros y ya no esta disponible');		
		    		}else{
    					return array("status"=>'no', "mensaje"=>'Aun hay $ '.number_format($da,2).' en pendientes por aplicar del Maestro');
		    		}
	    		}else{
    				return array("status"=>'no', "mensaje"=>'Aun hay '.count($dfp).' FACTURAS FP asignados al Maestro');
	    		}		
    		}else{
	    		return array("status"=>'no', "mensaje"=>'Aun hay '.count($df).' FACTURAS asignados al Maestro');
    		}
    	}else{
    		return array("status"=>'no', "mensaje"=>'Aun hay '.count($dc).' Clientes asignados al Maestro');
    	}    	
    }

    function libVal(){
    	$this->query="UPDATE ftc_detalle_recepciones set STATUS_VALIDACION = null where STATUS_VALIDACION= 9";
    	$this->EjecutaQuerySimple();
    	return array("status"=>'ok', "mensaje"=>'Se han liberado las validaciones.');
    }

    function buscaDoc($docf){
    	$path='C:\\xampp\\htdocs\\Facturas\\FacturasJson\\';
    	$files = array_diff(scandir($path), array('.', '..'));
    	foreach($files as $file){
		    // Divides en dos el nombre de tu archivo utilizando el . 
		    $data = explode(".", $file);
		    // Nombre del archivo
		    $fileName = $data[0];
		    // Extensión del archivo 
		    $fileExtension = $data[1];
		    if(strpos(substr($fileName,12), $docf) !== false){
		        //echo 'Encontramos el archivo: '.$fileName.'.xml';
		        // Realizamos un break para que el ciclo se interrumpa
		        return array("status"=>'ok',"mensaje"=>'Se Encontro el Archivo', "archivo"=>$fileName.'.xml', "factura"=>$docf);
		        break;
		    }
		}
		return array("status"=>'no',"mensaje"=>'No se encontro el Archivo', "archivo"=>'no');
    }

    function xmlAnual($tipo, $anio){
		$data= array();
		if($tipo=='R'){	
			$rfc=$_SESSION['rfc'];
			$condicion = "and cliente = '".$rfc."'";
		}else{
			$rfc=$_SESSION['rfc'];
			$condicion = "and cliente != '".$rfc."'";
		}
		//// Obtenemos los datos del RFC de la empresas Emisora para distingir lo los emitidos con los recibidos.
		$this->query="SELECT count(ID) as xmls,tipo, extract(year from fecha) as anio, 
					sum(subtotal * tipocambio) as egresosS,
					sum(importe * tipocambio) as egresosT,
					(select count(ID) FROM XML_DATA WHERE extract(year from fecha) = $anio $condicion And status = 'P' and tipo = x.tipo group by extract(year from fecha)) as Faltantes
					FROM XML_DATA x
					  WHERE extract(year from fecha) = $anio 
							$condicion
					group by extract(year from fecha), tipo";
		//echo $this->query;
		$res=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($res)) {
			$data []=$tsArray;
		}
		return $data;
	}

	function cabeceraUUID($uuid){
		$data = array();
		$this->query="SELECT X.*, COALESCE((SELECT FIRST 1 NOMBRE FROM XML_CLIENTES WHERE RFC = RFCE ), (SELECT F.RAZON_SOCIAL FROM FTC_EMPRESAS F WHERE F.RFC = X.RFCE)) AS NOMBRE_EMISOR, coalesce((SELECT FIRST 1 NOMBRE FROM XML_CLIENTES WHERE RFC=CLIENTE), (SELECT F.RAZON_SOCIAL FROM FTC_EMPRESAS F WHERE F.RFC = X.CLIENTE)) AS NOMBRE_RECEPTOR FROM XML_DATA X WHERE upper(UUID) =upper('$uuid')";
		$res=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($res)) {
			$data[]=$tsArray;
		}
		return $data;
	}

	function detalleUUID($uuid){
		$data = array();
		$this->query="SELECT * FROM XML_PARTIDAS WHERE UUID = '$uuid'";
		$res=$this->EjecutaQuerySimple();
		while($tsArray=ibase_fetch_object($res)){
			$data[]=$tsArray;
		}
		return $data;
	}

	function impuestosUUID($uuid){
		$data = array();
		$this->query="SELECT * FROM XML_IMPUESTOS WHERE UUID = '$uuid'";
		$res=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($res)) {
			$data[]=$tsArray;
		}
		return $data;
	}

	function ctaXML($uuid, $cta, $t, $obs, $fecha, $tpago){
		$usuario = $_SESSION['user']->NOMBRE;
		if($t != 'venta' and $t !='otroIngreso'){
			$this->query="SELECT * FROM XML_DATA WHERE UUID= '$uuid'";
			$res=$this->EjecutaQuerySimple();
			$rowV=ibase_fetch_object($res);
			if(empty($rowV->IDPAGO)){
				$this->query="INSERT INTO CR_DIRECTO( FACTURA, FECHA_FACTURA, FECHA_MOV, PROVEEDOR, IMPORTE, FECHA_EDO_CTA, TP_TES, REFERENCIA, BANCO, CUENTA, TIPO, idgasto, usuario)
	   							VALUES (
	   								(SELECT FIRST 1 DOCUMENTO FROM XML_DATA WHERE UUID = '$uuid' and idpago is null), 
	   								(SELECT FIRST 1 FECHA FROM XML_DATA WHERE UUID = '$uuid' and idpago is null),  
	   								current_timestamp, 
	   								'xml_'||(SELECT FIRST 1 idcliente from xml_clientes where tipo='Proveedor' and RFC = (SELECT RFCE FROM XML_DATA WHERE UUID='$uuid'and idpago is null) ), 
	   								(SELECT FIRST 1 IMPORTE FROM XML_DATA WHERE UUID = '$uuid' and idpago is null), 
	   								'$fecha',
	   								'$t', 
	   								'$obs', 
	   								(SELECT BANCO FROM PG_BANCOS WHERE ID = $cta),
	   								(SELECT NUM_CUENTA FROM PG_BANCOS WHERE ID = $cta),
	   								'$t',
	   								9999,
	   								'$usuario') RETURNING id";
	   			//echo $this->query;
		  		$rs=$this->EjecutaQuerySimple();
		  		$row = ibase_fetch_object($rs);
		  		if($row->ID > 0){
					$mensaje = array("status"=>'ok', "mensaje"=>"Se ha insertado el gasto".$row->ID);
					$this->query="UPDATE XML_DATA SET IDPAGO = $row->ID where uuid = '$uuid'";
					$this->queryActualiza();
				}else{
					$mensaje = array("status"=>'no', "mensaje"=>"Favor de verificar los datos");
				}	
			}else{
				$mensaje = array("status"=>'no', "mensaje"=>"Ya se ha registrado con el id ".$rowV->IDPAGO);
			}
		//	$mensaje = "El estado de cuenta se encuentra cerrado, no se pueden insetar gastos";
		}else{
			$this->query="SELECT * FROM PG_BANCOS WHERE ID = $cta";
			$rs=$this->EjecutaQuerySimple();
			$row=ibase_fetch_object($rs);
			$sb=$row->SERIE;
			$sbl=0;
			if(!empty($sb)){
				$sbl=strlen($sb)+2;
			}
			$cuentaCompleta=$row->BANCO.' - '.$row->NUM_CUENTA;
			$this->query="SELECT coalesce( MAX(cast(substring(FOLIO_X_BANCO from $sbl) as int)), 0) as ULTIMO FROM CARGA_PAGOS	WHERE FOLIO_X_BANCO STARTING WITH '$sb'";
		    $rs=$this->	QueryObtieneDatosN();
		    //echo $this->query;
		    $row=ibase_fetch_object($rs);
		    if($row){
		    	$folio=$sb.'-'.($row->ULTIMO+1);
		    }

			$this->query="INSERT INTO CARGA_PAGOS (ID, CLIENTE, FECHA, MONTO, SALDO, USUARIO, BANCO, FECHA_APLI, FECHA_RECEP, FOLIO_X_BANCO, RFC, STATUS, CF, FOLIO_ACREEDOR, TIPO_PAGO, REGISTRO, CONTABILIZADO, POLIZA_INGRESO, APLICACIONES, MONTO_ACREEDOR, MONTO_CF, CVE_MAESTRO, CIERRE_CONTA, USUARIO_CONTA, FECHA_CONTA, SELECCIONADO, GUARDADO, ARCHIVO, CEP, ARCHIVO_CEP, OBS)
                 VALUES (null
                 		, 'xml_'||(SELECT IDCLIENTE FROM XML_CLIENTES WHERE tipo='Cliente' and rfc = (SELECT CLIENTE FROM XML_DATA WHERE UUID = '$uuid'))
                 		, current_timestamp
                 		, (SELECT IMPORTE FROM XML_DATA WHERE uuid = '$uuid')
                 		, 0
                 		, '$usuario', '$cuentaCompleta', '$fecha', '$fecha' 
                 		, '$folio'
                 		, (SELECT CLIENTE FROM XML_DATA WHERE UUID = '$uuid')
                 		, 0, 0, 0, null, '0', '$tpago', '', 0, 0, 0, NULL, NULL, NULL, NULL, 0, 0, '$uuid', 0,''
                 		, (SELECT SERIE||FOLIO FROM XML_DATA WHERE UUID = '$uuid')||' -- '||'$obs')
                 		 RETURNING ID";
            $res=$this->grabaBD();
            $ridp=ibase_fetch_object($res);
            if($ridp->ID > 0 ){
            	$mensaje = array("status"=>'ok', "mensaje"=>"Se ha insertado el abono al banco".$ridp->ID);
	            $this->query="UPDATE XML_DATA SET IDPAGO = $ridp->ID WHERE UUID = '$uuid'";
	            $res = $this->queryActualiza();
	            if($res == 1){
	            	$this->query="INSERT INTO APLICACIONES (ID, FECHA, IDPAGO, DOCUMENTO, MONTO_APLICADO, SALDO_DOC, SALDO_PAGO, USUARIO, STATUS, RFC, FORMA_PAGO, CANCELADO, PROCESADO, CIERRE_CC, REC_CONTA, FECHA_CIERRE_CC, USUARIO_CIERRE_CC, FECHA_REC_CONTA, FOLIO_REC_CONTA, USUARIO_REC_CONTA, OBSERVACIONES, CONTABILIZADO, TIPO, POLIZA_INGRESO) VALUES (NULL, CURRENT_TIMESTAMP, $ridp->ID, (SELECT SERIE||FOLIO FROM XML_DATA WHERE UUID = '$uuid'), (SELECT IMPORTE FROM XML_DATA WHERE uuid = '$uuid'), 0, 0, '$usuario', 'E', (SELECT CLIENTE FROM XML_DATA WHERE UUID = '$uuid'), '$tpago', 0, 1, 0, 0, null, null, null, 0,null, null, null,null,null)";
	            	$this->grabaBD();
	            }
            }
		}
		return $mensaje;
   }

	function traePago($idp, $t){
		if($t == 'Egreso'){
			$this->query="SELECT C.*, (SELECT CTA_CONTAB FROM PG_BANCOS b WHERE b.BANCO =  C.banco and b.NUM_cuenta = c.cuenta) AS CCOI, (SELECT NOMBRE FROM XML_CLIENTES WHERE IDCLIENTE = substring(c.proveedor from 5) ) as nom_prov, (SELECT CUENTA_CONTABLE FROM XML_CLIENTES WHERE IDCLIENTE = substring(c.proveedor from 5) ) as ctaCoiProv, extract(month from c.fecha_edo_cta) as periodo, extract(year from c.fecha_edo_cta) as ejercicio FROM CR_DIRECTO C WHERE ID = $idp";
			$res=$this->EjecutaQuerySimple();
			$row=ibase_fetch_object($res);
			return array("status"=>'ok', "info"=>"Banco: ".$row->BANCO." Cuenta: ".$row->CUENTA." Importe: ".$row->IMPORTE, "banco"=>$row->BANCO, "cuenta"=>$row->CUENTA, "cuentaCoi"=>$row->CCOI, "proveedor"=>$row->NOM_PROV,"monto"=>"$ ".number_format($row->IMPORTE,2), "ctaProvCoi"=>$row->CTACOIPROV, "fecha_edo"=>$row->FECHA_EDO_CTA, "conciliado"=>$row->GUARDADO, "perido"=>$row->PERIODO, "ejercicio"=>$row->EJERCICIO, "factura"=>$row->FACTURA, "importe"=>$row->IMPORTE);
		}elseif($t = 'Ingreso'){
			$this->query="SELECT C.*, 
               				(select CTA_CONTAB
               				 from PG_BANCOS B
               				 where B.BANCO || ' - ' || B.NUM_CUENTA = C.BANCO) as CCOI,
               				 (select BANCO
               				 from PG_BANCOS B
               				 where B.BANCO || ' - ' || B.NUM_CUENTA = C.BANCO) as BBANCO,
               				 (select NUM_CUENTA
               				 from PG_BANCOS B
               				 where B.BANCO || ' - ' || B.NUM_CUENTA = C.BANCO) as CUENTA,
               				(select NOMBRE
               				 from XML_CLIENTES
               				 where IDCLIENTE = substring(C.CLIENTE from 5 )) as NOM_PROV,
               				(select CUENTA_CONTABLE
               				 from XML_CLIENTES
               				 where IDCLIENTE = substring(C.CLIENTE from 5 )) as CTACOIPROV, extract(month from C.FECHA_RECEP) as PERIODO,
               				extract(year from C.FECHA_RECEP) as EJERCICIO
        		from CARGA_PAGOS c where C.ID = $idp";
			//echo $this->query;
			$res=$this->EjecutaQuerySimple();
			$row=ibase_fetch_object($res);

			return array("statsu"=>'ok', "info"=>"Banco: ".$row->BANCO." Cuenta: ".$row->CUENTA." Importe: ".$row->MONTO, "banco"=>$row->BANCO, "cuenta"=>$row->CUENTA, "cuentaCoi"=>$row->CCOI, "proveedor"=>$row->NOM_PROV,"monto"=>"$ ".number_format($row->MONTO,2), "ctaProvCoi"=>$row->CTACOIPROV, "fecha_edo"=>$row->FECHA_RECEP, "conciliado"=>$row->GUARDADO, "perido"=>$row->PERIODO, "ejercicio"=>$row->EJERCICIO, "factura"=>$row->OBS, "importe"=>$row->MONTO);
		}
	}

	function traePeriodosXML(){
		$data = array();
		$rfce = $_SESSION['empresa']['rfc'];
		$this->query="SELECT 'e' as T, extract(year from fecha) as ejercicio FROM xml_data WHERE rfce='$rfce' group by extract(year from fecha)";
		$res=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($res)) {
			$data[]=$tsArray;
		}
		$this->query="SELECT 'r' as T, extract(year from fecha) as ejercicio FROM xml_data WHERE cliente='$rfce' group by extract(year from fecha)";
		$res=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($res)) {
			$data[]=$tsArray;
		}
		return $data;
	}

	function revisaXLSX($target_file, $datos){
		$data=array();
		if($xlsx = SimpleXLSX::parse($target_file)){
			echo "<h2>$target_file</h2>";
			echo '<pre>';
			//print_r( $xlsx->rows() );
			echo '</pre>';
			$i=0;
			$l=1;
			$e=0;
			foreach ($xlsx->rows() as $key) {
				if($i > 0 ){
					$clave = $key[0];
					$fecha = $key[1];
					$desc = $key[2];
					$abono = empty($key[3])? 0:$key[3];
					$cargo = empty($key[4])? 0:$key[4];
					$tipo = $key[6];
					$uuid = $key[7];
					$obs = substr(utf8_encode($key[8]),0,255);
					if($cargo <> 0 and $abono <> 0 ){
						$e++;
						echo $clave.' <font color="red">No Inserta la linea por que el valor cargo y valor de abono son mayores a 0.00 .</font><br/>';
					}else{
						if((gettype($abono) == 'integer' or gettype($abono) =='double') and (gettype($cargo) == 'integer' or gettype($cargo)=='double')){
							//echo '<br/>'.$e.' Abono: '.$abono.'-->'.$tipo;
							//echo '<br/>Cargo: '.$cargo;
							//echo '<br/>Monto de la transaccion: '.($abono + $cargo);
							if(($abono + $cargo) > 0 and !empty($tipo) and ($tipo == 'EFE' or $tipo == 'CHQ' or $tipo =='TNS' or $tipo == 'TDC')){
								$ca = ($abono>0)? 'a':'c';
								$monto = ($abono>0)? $abono:$cargo;
								//echo $clave.' <b>Inserta el '.$ca.' con la informacion</b> de tipo : '.$tipo.'<br/>';
							}else{
								$e++;
								echo ($i+1)." <font color='red'>No Inserta la linea por que no tiene Valor o no contiene tipo valido.</font><br/>".$tipo;
							}
						}else{
							$e++;
							echo $clave.' <font color="red">error valor de abono '.gettype($abono).' Valor de Cargo '.gettype($cargo).'</font><br/>';
						}
					}
					if(!empty($fecha)){
						$fecha = substr(trim($fecha),0,10);						
						if(strpos($fecha, "-")){
							$val= explode('-', $fecha);
						}else{
							$val= explode('/', $fecha);	
						} 
						//echo '<br/>'.print_r($val).' --'.count($val);
						echo '<br/>Anio'.$val[0];
						echo 'mes'.$val[1];
						echo 'Dia'.$val[2].'<br/>';
						if(checkdate($val[1], $val[2],$val[0])){
						}else{	
							$e++;
							echo $clave.'<br/>No se encontro una fecha valida en '.$fecha.', la celda B2 debe de tener el formato de fecha dd/mm/yyyy';
						}
					}else{
						$e++;
					}
					if($e == 0){
						$data[]=array("linea"=>$clave, "fecha"=>$fecha, "desc"=>$desc, "ca"=>$ca, "monto"=>$monto,"tipo"=>$tipo, "uuid"=>$uuid, "obs"=>$obs);
					}
				}		
				$i++;
				$l++;
			}
		} else {
			echo SimpleXLSX::parseError();
		}
		if($e >0 ){
			exit();
			return array("status"=>'No');
		}else{
			return array("status"=>'ok', "data"=>$data);
		}
	}

	function cargaXLSX($datos, $data, $banco, $cuenta){
		$usuario = $_SESSION['user']->NOMBRE;
		foreach ($data as $key) {
			$monto = $key['monto'];
			$fecha = $key['fecha'];
			$uuid=$key['uuid'];
			$tipo = $key['tipo'];
			$desc = $key['desc'];
			$obs=$key['obs'];	
			if($key['ca']=='a'){
				$folio=$this->folioBanco($banco, $cuenta);
				$this->query="INSERT INTO CARGA_PAGOS (ID, CLIENTE, FECHA, MONTO, SALDO, USUARIO, BANCO, FECHA_RECEP, FOLIO_X_BANCO, RFC, STATUS, ARCHIVO, CONTABILIZADO, OBS) values (NULL, '2', current_timestamp, $monto, $monto, '$usuario', '$banco'||' - '||'$cuenta', '$fecha', '$folio', null, 0, '$uuid', '$tipo', '$obs' ) ";
				$this->grabaBD();
			}elseif($key['ca']=='c'){
				$this->query="INSERT INTO GASTOS (ID, STATUS, CVE_CATGASTOS, CVE_PROV, REFERENCIA, DOC, AUTORIZACION, PRESUPUESTO, USUARIO, TIPO_PAGO, MONTO_PAGO, IVA_GEN, TOTAL, SALDO, FECHA_CREACION, MOV_PAR, CLASIFICACION, fecha_edo_cta) VALUES (NULL, 'V', 1, '', substring('$desc' from 1 for 30), substring('$obs' from 1 for 255), 1, $monto, '$usuario', '$tipo', $monto, ($monto-($monto / 1.16)),$monto, $monto, current_timestamp, 'N', 1, '$fecha') RETURNING ID";
				$foliog=$this->grabaBD();
				$row=ibase_fetch_object($foliog);
				switch ($tipo) {
				 	case 'TNS':
				 		$tipo = 'TR';
				 		break;
					default:
						$tipo = $tipo;
				 		break;
				 }
				$tipo = substr($tipo,0,2);
				//exit($tipo.$row->ID);
				$folio=$this->generaFolio($tipo);
				$folio=$folio[0]->FOLIO;
				$this->query="INSERT INTO PAGO_GASTO (ID, IDGASTO, CUENTA_BANCARIA, MONTO, FECHA_REGISTRO, USUARIO_REGISTRA, FECHA_PAGO, CONCILIADO, FOLIO_PAGO) VALUES ((select coalesce(max(ID),0)+1 FROM PAGO_GASTO), '$row->ID','$banco'||' - '||'$cuenta', $monto, current_timestamp, '$usuario', '$fecha', 0, '$folio')";
				//echo '<br/>'.$this->query;
				$this->grabaBD();
			}
		}
		exit();
	}

	function folioBanco($banco, $cuenta){
		$this->query="SELECT * FROM PG_BANCOS WHERE BANCO = '$banco' and NUM_CUENTA = '$cuenta'";
			$rs=$this->EjecutaQuerySimple();
			$row=ibase_fetch_object($rs);
			$sb=$row->SERIE;
			$sbl=0;
			if(!empty($sb)){
				$sbl=strlen($sb)+2;
			}
			$cuentaCompleta=$row->BANCO.' - '.$row->NUM_CUENTA;
			$this->query="SELECT coalesce( MAX(cast(substring(FOLIO_X_BANCO from $sbl) as int)), 0) as ULTIMO FROM CARGA_PAGOS	WHERE FOLIO_X_BANCO STARTING WITH '$sb'";
		    $rs=$this->	QueryObtieneDatosN();
		    //echo $this->query;
		    $row=ibase_fetch_object($rs);
		    if($row){
		    	$folio=$sb.'-'.($row->ULTIMO+1);
		    }
		return $folio;
	}

	function detalleGasto($idg){
		$data = array();
		$this->query="SELECT G.*, Pg.CUENTA_BANCARIA, pg.FOLIO_PAGO, (select CTA_CONTAB FROM PG_BANCOS PB WHERE PB.BANCO||' - '||PB.NUM_CUENTA = pg.cuenta_bancaria ) as cta_banco, COALESCE((SELECT NOMBRE FROM XML_CLIENTES XC WHERE G.CVE_PROV = ('xml_'||XC.IDCLIENTE)),'Sin Proveedor') AS PROV , (SELECT COALESCE(SUM(APLICADO), 0) FROM APLICACIONES_GASTOS AG WHERE AG.IDG = G.ID AND AG.STATUS = 0) AS APLICADO FROM GASTOS G left join PAGO_GASTO PG on pg.idgasto = g.id WHERE g.ID = $idg";
		$res=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($res)) {
			$data[]=$tsArray;
		}
		return $data;
	}

	function facturasProvPendientes($uuid){
		$data=array();
		$rfc = $_SESSION['rfc'];
		$a = '';
		if($uuid){
			$a =" and X.UUID = '".$uuid."'";
		}
		$this->query="SELECT X.*, (SELECT COALESCE(SUM(APLICADO), 0) FROM APLICACIONES_GASTOS AG WHERE X.UUID = AG.UUID AND STATUS = 0) AS APLICADO, (SELECT NOMBRE FROM XML_CLIENTES XC WHERE XC.RFC = X.RFCE AND TIPO = 'Proveedor') as Prov, (SELECT CUENTA_CONTABLE FROM XML_CLIENTES XC WHERE XC.RFC = X.RFCE AND TIPO = 'Proveedor') FROM XML_DATA X WHERE X.RFCE != '$rfc' and X.IMPORTE > (SELECT COALESCE(SUM(APLICADO), 0) FROM APLICACIONES_GASTOS AG WHERE X.UUID = AG.UUID AND STATUS = 0) $a";
		$res=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($res)) {
			$data[]=$tsArray;
		}
		if($uuid){
			foreach ($data as $vc) {
				if(empty($vc->CUENTA_CONTABLE)){
					return array("status"=>'no', "mensaje"=>'El Proveedor '.$vc->PROV.' no tiene cuenta contable');
				}elseif($vc->STATUS == 'P'){
					return array("status"=>'no', "mensaje"=>'Aun no se crea la poliza de Dr del Documento '.$vc->DOCUMENTO);
				}
			}	
		}
		return $data;
	}
	
	function valContable($uuid){
		$this->query="SELECT * FROM XML_PARTIDAS WHERE UUID = '$uuid'";
		$rs=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($rs)){
			$data[]=$tsArray;
		}
		foreach ($data as $pc) {
			if(empty($pc->CUENTA_CONTABLE)){
				return array("status"=>'no', "mensaje"=>'La partida '.$pc->PARTIDA.' no tiene cuenta contable');
			}
		}
		return $data;
	}

	function aplicacionesGasto($idg, $tipo){
		$data=array();
		$a='';
		if($tipo == 'c'){
			$a = 'and ap.status = 0';
		}
		$this->query="SELECT AP.*, g.*, x.*,(SELECT xc.NOMBRE FROM XML_CLIENTES xc WHERE xc.RFC=(SELECT x.RFCE FROM XML_DATA x WHERE x.uuid = ap.uuid) and tipo ='Proveedor') as PROV, (SELECT xc.CUENTA_CONTABLE FROM XML_CLIENTES xc WHERE xc.RFC=(SELECT x.RFCE FROM XML_DATA x WHERE x.uuid = ap.uuid) and tipo ='Proveedor'), AP.DOCUMENTO AS DESCRIPCION FROM APLICACIONES_GASTOS AP left join gastos g on g.id = AP.IDG left join xml_data x on x.uuid = ap.uuid WHERE AP.IDG = $idg  $a";
		$res=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($res)) {
			$data[]=$tsArray;
		}
		if($tipo == 'c'){
			$uuid= '';
			foreach ($data as $key){
				$uuid .= $key->UUID.',';
			}
			$uuid=substr($uuid,0, strlen($uuid)-1);
			return array("datos"=>$data,"uuid"=>$uuid);
		}
		return $data;
	}

	function aplicaGasto($idp , $uuid, $valor){
		$usuario=$_SESSION['user']->NOMBRE;
		$valFact=$this->facturasProvPendientes($uuid);
		$valConta = $this->valContable($uuid);
		if(isset($valFact['status'])){
			return $valFact;
		}elseif(isset($valConta['status'])){
			return $valConta;
		}
		//echo 'res1: '.($valFact[0]->IMPORTE - $valFact[0]->APLICADO); 
		//echo '<br/>Res2: '.(($valFact[0]->IMPORTE - $valFact[0]->APLICADO)- $valor);
		if( ($valFact[0]->IMPORTE - $valFact[0]->APLICADO) > 0 and  ((($valFact[0]->IMPORTE - $valFact[0]->APLICADO) - $valor) >= (-0.01)) and $valor > 0){ // Validacion de la factura
			$this->query="SELECT * FROM gastos where id = $idp";
			$res=$this->EjecutaQuerySimple();
			$row = ibase_fetch_object($res);
			if($row->SALDO >= $valor){ // Valida que el saldo sea mayor a lo que se va a aplicar.
				$this->query="UPDATE GASTOS SET SALDO = SALDO - $valor where id = $idp";
				$res=$this->queryActualiza();
				if($res == 1){
					$this->query="SELECT * FROM APLICACIONES_GASTOS WHERE IDG = $idp and status = 0 and uuid = '$uuid'";
					$res=$this->EjecutaQuerySimple();
					$row=ibase_fetch_object($res);
					if($row){
						$this->query="UPDATE APLICACIONES_GASTOS SET APLICADO = APLICADO + $valor where idg=$idp and status = 0 and uuid='$uuid'";
						$this->queryActualiza();
						$mensaje = array("status"=>'ok', "mensajse"=>'Se actualizo la aplicacion del pago');
					}else{
						$this->query="INSERT INTO APLICACIONES_GASTOS (ID, IDG, UUID, DOCUMENTO, APLICADO, FECHA, USUARIO, STATUS) VALUES (NULL, $idp, '$uuid', (SELECT DOCUMENTO FROM XML_DATA WHERE UUID = '$uuid'), $valor, current_timestamp, '$usuario', 0) RETURNING id";
						$res=$this->grabaBD();
						$g=ibase_fetch_object($res);
						if($g->ID > 0 ){
							$this->query="UPDATE XML_DATA SET idpago = $g->ID WHERE uuid = '$uuid'";
							$ru=$this->queryActualiza();
							if($ru==1){
								$mensaje = array("status"=>'ok', "mensajse"=>'Se ejecuto correctamente el pago');
							}
						}
					}
				}
			}	
		}else{
			if($valor == 0){
				$mensaje= array("status"=>'no',"mensaje"=>'No se puede aplicar 0.00 al documento');
			}else{
				$mensaje= array("status"=>'no', "mensaje"=>'Fallo la validacion del documento');
			}
		}
		return $mensaje;
	}

	function canapl($idp, $ida, $valor, $uuid){
		$this->query="UPDATE APLICACIONES_GASTOS SET STATUS = 9 WHERE uuid='$uuid' and id =$ida and idg = $idp";
		$this->queryActualiza();
		$this->query="UPDATE GASTOS G SET SALDO = MONTO_PAGO - (SELECT COALESCE(SUM(APLICADO),0) FROM APLICACIONES_GASTOS AG WHERE AG.IDG = G.ID AND STATUS = 0) where id = $idp";
		$this->queryActualiza();
		$mensaje=array("status"=>'ok', "mensaje"=>'Se elimino correctamente la aplicacion al documento');
		return $mensaje;
	}

	function insertaLTPD(){
		$data= array();
		$data2 = array();
		$this->query="SELECT X.*, (SELECT FIRST 1 CVE_ART FROM INVE01 I WHERE I.DESCR = X.DESCRIPCION) FROM XML_PARTIDA_INFO_ADUANA X WHERE FECHA_LOTE IS NULL ORDER BY ID";
		$res=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($res)) {
			$data[]=$tsArray;
		}
		$i = 0;
		foreach ($data as $key){
			/// Obtenemos el numero de pedimento descriminando la cantidad y 
			$i++;
			$this->query="SELECT FIRST 1 * FROM LTPD01 WHERE PEDIMENTOSAT='$key->PEDIMENTO' AND CVE_ART = '$key->CVE_ART' and cantidad > 0 ";
			$rs=$this->EjecutaQuerySimple();
			while ($tsArray2 = ibase_fetch_object($rs)){
				$data2[]=$tsArray2;
			}
			
			foreach($data2 as $d2){
					echo 'Del producto'.$key->CVE_ART.'Cantidad a descontar'.$key->CANTIDAD.' de '.$d2->CANTIDAD.' al registro de lote '.$d2->REG_LTPD.'<br>';
			}

			if($i == 10){
				break;
			}
			$data2=array();
		}
		exit();
	}

	function consolidaPolizas($mes, $anio, $ide, $polizas){
		$mensaje='a';
		$this->query="SELECT * FROM XML_POLIZAS WHERE PERIODO = $mes AND  EJERCICIO = $anio and status = 'A'";
		$res=$this->EjecutaQuerySimple();
		while ($tsArray=ibase_fetch_object($res)) {
			$data[] = $tsArray;
		}
		$ps=count($data);
		$ln=0;
		foreach ($polizas as $pc){
			$this->query="SELECT ID FROM XML_POLIZAS WHERE POLIZA = '$pc->NUM_POLIZ' and tipo = '$pc->TIPO_POLI' AND PERIODO = $pc->PERIODO AND  EJERCICIO = $pc->EJERCICIO AND uuid = '$pc->UUID' AND STATUS = 'A'";
			$res=$this->EjecutaQuerySimple();
			$row=ibase_fetch_object($res);
			if($row){
				$ln++;
			}
			unset($row);
		}
		//echo '<br/> Total Polizas: '.count($polizas).' Total con informacion '.$ln. ' total de polizas en el sistemna '.$ps;
		if(count($data)>0){
			$ok= 0;
			foreach($data as $ps){
				$in=0;
				foreach ($polizas as $pcc){
					if($ps->POLIZA == $pcc->NUM_POLIZ and $ps->EJERCICIO == $pcc->EJERCICIO and $ps->TIPO == $pcc->TIPO_POLI and $ps->PERIODO == $pcc->PERIODO and $ps->UUID == $pcc->UUID){
						$ok++;
						$in++;
						if($in > 1){
							$mensaje .= '-->Poliza duplicada '.$ps->POLIZA.'<--';
							exit();
						}
					}
				}
				if($in == 0){
					$mensaje.= '--> No se encontro la poliza '.$ps->POLIZA.'<--';
					$this->query="UPDATE XML_POLIZAS SET status = 'C' where UUID = '$ps->UUID' and tipo = '$ps->TIPO' AND periodo = $ps->PERIODO and ejercicio = $ps->EJERCICIO and status = 'A'";
					$ra=$this->queryActualiza();
					if($ra == 1 and $ps->TIPO == 'Dr'){
						$this->query="UPDATE XML_DATA SET STATUS = 'P' WHERE UUID = '$ps->UUID'";
						$r=$this->queryActualiza();
						if($r==1){
							$mensaje.=' --> Se actualizo correctamente el xml y se marco como Pendiente <--';
						}
					}
				}
			}
			//echo 'Total polizas con coincidencia: '.$ok.'<br/>';
		}else{
			exit('Nada que consolidar');
		}
		return array("status"=>'C', "mensaje"=>$mensaje);
	}

	function actualizaUUID($res){
		$uuid = $res['uuid'];
		$poliza = $res['numpoliza'];
		$tipo = $res['tipopoliza'];
		$ejercicio = $res['ejercicio'];
		$periodo = $res['periodo'];
		$this->query="UPDATE XML_DATA SET STATUS= 'P' WHERE UUID='$uuid' ";
		$this->EjecutaQuerySimple();
		$this->query="UPDATE XML_POLIZAS set STATUS = 'C' WHERE UUID='$uuid' and status = 'A' and poliza = '$poliza' and tipo = '$tipo' and periodo = $periodo and ejercicio = $ejercicio";
		echo $this->query;
		$this->EjecutaQuerySimple();
		return;
	}
}?>
