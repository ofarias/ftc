begin
    

    begin
    VAL = 0;
    select TIP_DOC,
              CVE_DOC,
              CVE_CLPV,
              status,
              DAT_MOSTR,
              CVE_VEND,
              CVE_PEDI,
              FECHA_DOC,
              FECHA_ENT,
              FECHA_VEN,
              FECHA_CANCELA,
              CAN_TOT,
              IMP_TOT1,
              IMP_TOT2,
              IMP_TOT3,
              IMP_TOT4,
              DES_TOT,
              DES_FIN,
              COM_TOT,
              CONDICION,
              CVE_OBS,
              NUM_ALMA,
              ACT_CXC,
              ACT_COI,
              ENLAZADO,
              TIP_DOC_E,
              NUM_MONED,
              TIPCAMB,
              NUM_PAGOS,
              FECHAELAB,
              PRIMERPAGO,
              RFC,
              CTLPOL,
              ESCFD,
              AUTORIZA,
              SERIE,
              folio,
              AUTOANIO,
              DAT_ENVIO,
              CONTADO,
              CVE_BITA,
              BLOQ,
              FORMAENVIO,
              DES_FIN_PORC,
              DES_TOT_PORC,
              IMPORTE,
              COM_TOT_PORC,
              METODODEPAGO,
              NUMCTAPAGO,
              TIP_DOC_ANT,
              DOC_ANT,
              TIP_DOC_SIG,
              DOC_SIG,
              ID_SEG,
              STATUS_FACT,
              STATUS_MAT,
              cita,
              STATUS_EMB,
              status_log,
              IMPRESO,
              VAL_ADUANA,
              CONTRARECIBO_CR,
              STATUSCR_CR,
              FECHA_CR,
              UUID,
              VERSION_SINC,
              FECHA_VENCIMIENTO,
              IDC,
              IDCO,
              ENTREGA_BODEGA,
              U_ENTREGA,
              FECHA_ENTREGA,
              LOTE,
              U_RECIBE,
              FECHA_RECIBE,
              SALDO,
              PAGOS,
              APLICADO,
              SALDOFINAL,
              erroR,
              IMPORTE_NC,
              ID_PAGOS,
              ID_APLICACIONES,
              NC_APLICADAS,
              DEUDA2015,
              CVE_MAESTRO,
              ENLACE_REMISION,
              CONTABILIZADO,
              POLIZA,
              FECHA_REV,
              STATUS_VENCIMIENTO,
              ACT_DIA,
              PRORROGA,
              FOLIO_RUTA_COBRANZA,
              FORMADEPAGOSAT,
              USO_CFDI,
              SALDOFINAL_BU,
              validacion
        from factf01 where cve_doc = :factura_old into
        :TIP_DOC,
        :CVE_DOC,
        :CVE_CLPV,
        :STATUS,
        :DAT_MOSTR,
        :CVE_VEND,
        :CVE_PEDI,
        :FECHA_DOC,
        :FECHA_ENT,
        :FECHA_VEN,
        :FECHA_CANCELA,
        :CAN_TOT,
        :IMP_TOT1,
        :IMP_TOT2,
        :IMP_TOT3,
        :IMP_TOT4,
        :DES_TOT,
        :DES_FIN,
        :COM_TOT,
        :CONDICION,
        :CVE_OBS,
        :NUM_ALMA,
        :ACT_CXC,
        :ACT_COI,
        :ENLAZADO,
        :TIP_DOC_E,
        :NUM_MONED,
        :TIPCAMB,
        :NUM_PAGOS,
        :FECHAELAB,
        :PRIMERPAGO,
        :RFC,
        :CTLPOL,
        :ESCFD,
        :AUTORIZA,
        :SERIE,
        :FOLIO,
        :AUTOANIO,
        :DAT_ENVIO,
        :CONTADO,
        :CVE_BITA,
        :BLOQ,
        :FORMAENVIO,
        :DES_FIN_PORC,
        :DES_TOT_PORC,
        :IMPORTE,
        :COM_TOT_PORC,
        :METODODEPAGO,
        :NUMCTAPAGO,
        :TIP_DOC_ANT,
        :DOC_ANT,
        :TIP_DOC_SIG,
        :DOC_SIG,
        :ID_SEG,
        :STATUS_FACT,
        :STATUS_MAT,
        :CITA,
        :STATUS_EMB,
        :STATUS_LOG,
        :IMPRESO,
        :VAL_ADUANA,
        :CONTRARECIBO_CR,
        :STATUSCR_CR,
        :FECHA_CR,
        :UUID,
        :VERSION_SINC,
        :FECHA_VENCIMIENTO,
        :IDC,
        :IDCO,
        :ENTREGA_BODEGA,
        :U_ENTREGA,
        :FECHA_ENTREGA,
        :LOTE,
        :U_RECIBE,
        :FECHA_RECIBE,
        :SALDO,
        :PAGOS,
        :APLICADO,
        :SALDOFINAL,
        :ERROR,
        :IMPORTE_NC,
        :ID_PAGOS,
        :ID_APLICACIONES,
        :NC_APLICADAS,
        :DEUDA2015,
        :CVE_MAESTRO,
        :ENLACE_REMISION,
        :CONTABILIZADO,
        :POLIZA,
        :FECHA_REV,
        :STATUS_VENCIMIENTO,
        :ACT_DIA,
        :PRORROGA,
        :FOLIO_RUTA_COBRANZA,
        :FORMADEPAGOSAT,
        :USO_CFDI,
        :SALDOFINAL_BU,
        :VALIDACION;

        select iif(max(folio)is null, 0, max(folio)) from factv01 where serie = 'REF' into :folioa;
        update factF01 set doc_sig = :nc_nueva, tip_doc_sig = 'D' where cve_doc = :factura_old;
        folion = folioa + 1;
        cve_doc = 'REF'||:folion;

    end
if (folion > 0 ) then
  VAL=1;
  begin
        INSERT INTO FACTV01 (
              TIP_DOC,
              CVE_DOC,
              CVE_CLPV,
              status,
              DAT_MOSTR,
              CVE_VEND,
              CVE_PEDI,
              FECHA_DOC,
              FECHA_ENT,
              FECHA_VEN,
              FECHA_CANCELA,
              CAN_TOT,
              IMP_TOT1,
              IMP_TOT2,
              IMP_TOT3,
              IMP_TOT4,
              DES_TOT,
              DES_FIN,
              COM_TOT,
              CONDICION,
              CVE_OBS,
              NUM_ALMA,
              ACT_CXC,
              ACT_COI,
              ENLAZADO,
              TIP_DOC_E,
              NUM_MONED,
              TIPCAMB,
              NUM_PAGOS,
              FECHAELAB,
              PRIMERPAGO,
              RFC,
              CTLPOL,
              ESCFD,
              AUTORIZA,
              SERIE,
              folio,
              AUTOANIO,
              DAT_ENVIO,
              CONTADO,
              CVE_BITA,
              BLOQ,
              FORMAENVIO,
              DES_FIN_PORC,
              DES_TOT_PORC,
              IMPORTE,
              COM_TOT_PORC,
              METODODEPAGO,
              NUMCTAPAGO,
              TIP_DOC_ANT,
              DOC_ANT,
              TIP_DOC_SIG,
              DOC_SIG,
              ID_SEG,
              STATUS_FACT,
              STATUS_MAT,
              cita,
              STATUS_EMB,
              status_log,
              IMPRESO,
              VAL_ADUANA,
              CONTRARECIBO_CR,
              STATUSCR_CR,
              FECHA_CR,
              UUID,
              VERSION_SINC,
              FECHA_VENCIMIENTO,
              IDC,
              IDCO,
              ENTREGA_BODEGA,
              U_ENTREGA,
              FECHA_ENTREGA,
              LOTE,
              U_RECIBE,
              FECHA_RECIBE,
              SALDO,
              PAGOS,
              APLICADO,
              SALDOFINAL,
              erroR,
              IMPORTE_NC,
              ID_PAGOS,
              ID_APLICACIONES,
              NC_APLICADAS,
              DEUDA2015,
              CVE_MAESTRO,
              ENLACE_REMISION,
              CONTABILIZADO,
              POLIZA,
              FECHA_REV,
              STATUS_VENCIMIENTO,
              ACT_DIA,
              PRORROGA,
              FOLIO_RUTA_COBRANZA,
              FORMADEPAGOSAT,
              USO_CFDI,
              SALDOFINAL_BU,
              validacion
              )VALUES(
        'V',
        :CVE_DOC,
        :CLIENTE,
        :STATUS,
        0,
        :CVE_VEND,
        :CVE_PEDI,
        :nueva_fecha,
        :FECHA_ENT,
        :FECHA_VEN,
        :FECHA_CANCELA,
        :CAN_TOT,
        :IMP_TOT1,
        :IMP_TOT2,
        :IMP_TOT3,
        :IMP_TOT4,
        :DES_TOT,
        :DES_FIN,
        :COM_TOT,
        :CONDICION,
        :CVE_OBS,
        :NUM_ALMA,
        :ACT_CXC,
        :ACT_COI,
        'O',
        'O',
        :NUM_MONED,
        :TIPCAMB,
        :NUM_PAGOS,
        CURRENT_TIMESTAMP,
        :PRIMERPAGO,
        :RFC,
        :CTLPOL,
        'N',
        :AUTORIZA,
        'REF',
        :folion,
        :AUTOANIO,
        :DAT_ENVIO,
        :CONTADO,
        :CVE_BITA,
        :BLOQ,
        null,
        :DES_FIN_PORC,
        :DES_TOT_PORC,
        :IMPORTE,
        :COM_TOT_PORC,
        :METODODEPAGO,
        :NUMCTAPAGO,
        :TIP_DOC_ANT,
        :DOC_ANT,
        null,
        null,
        :ID_SEG,
        :STATUS_FACT,
        :STATUS_MAT,
        :CITA,
        :STATUS_EMB,
        :STATUS_LOG,
        :IMPRESO,
        :VAL_ADUANA,
        :CONTRARECIBO_CR,
        :STATUSCR_CR,
        :FECHA_CR,
        '',
        null,
        :FECHA_VENCIMIENTO,
        :IDC,
        :IDCO,
        :ENTREGA_BODEGA,
        :U_ENTREGA,
        :FECHA_ENTREGA,
        :LOTE,
        :U_RECIBE,
        :fecha_recibe, 
        :SALDO,
        :PAGOS,
        :APLICADO,
        :SALDOFINAL,
        :ERROR,
        :IMPORTE_NC,
        :ID_PAGOS,
        :ID_APLICACIONES,
        :NC_APLICADAS,
        :DEUDA2015,
        :CVE_MAESTRO,
        :ENLACE_REMISION,
        :CONTABILIZADO,
        :POLIZA,
        :FECHA_REV,
        :STATUS_VENCIMIENTO,
        :ACT_DIA,
        :PRORROGA,
        :FOLIO_RUTA_COBRANZA,
        :FORMADEPAGOSAT,
        :USO_CFDI,
        :SALDOFINAL_BU,
        :VALIDACION);
  end

  UPDATE foliosf01 SET  ULT_DOC = :folion WHERE  SERIE = 'REF';
  update factp01 SET DOC_SIG = :cve_doc WHERE DOC_SIG = :FACTURA_OLD;
  update factr01 set DOC_SIG = :CVE_DOC where doc_sig = :FACTURA_OLD;
  update cajas set FACTURA = :CVE_DOC WHERE FACTURA = :FACTURA_OLD;
  update control_fact_rem set FACTURAS = iif(facturas is null, :CVE_DOC, facturas||','||:CVE_DOC) where facturas containing (:FACTURA_OLD);

  insert into ftc_facturas (
        IDF,
        DOCUMENTO,
        SERIE,
        FOLIO,
        FORMADEPAGOSAT,
        VERSION,
        TIPO_CAMBIO,
        METODO_PAGO,
        REGIMEN_FISCAL,
        LUGAR_EXPEDICION,
        MONEDA,
        TIPO_COMPROBANTE,
        CONDICIONES_PAGO,
        SUBTOTAL,
        IVA,
        IEPS,
        DESC1,
        DESC2,
        TOTAL,
        SALDO_FINAL,
        ID_PAGOS,
        ID_APLICACIONES,
        NOTAS_CREDITO,
        MONTO_NC,
        MONTO_PAGOS,
        MONTO_APLICACIONES,
        CLIENTE,
        USO_CFDI,
        STATUS,
        USUARIO,
        FECHA_DOC,
        FECHAELAB,
        IDIMP,
        UUID,
        DESCF,
        IDCAJA
        )
        values
        (
        null,
        :foliof,
        :serief,
        :folioRFP,
        :sfp,
        :"VERSION",
        :TIPO_CAMBIO,
        :smp,
        :REGIMEN_FISCAL,
        :LUGAR_EXPEDICION,
        :MONEDA,
        :TIPO_COMPROBANTE,
        :CONDICIONES_PAGO,
        :SUBTOTAL,
        :IVA,
        :IEPS,
        :DESC1,
        :DESC2,
        :TOTAL,
        :SALDO_FINAL,
        :ID_PAGOS,
        :ID_APLICACIONES,
        :NOTAS_CREDITO,
        :MONTO_NC,
        :MONTO_PAGOS,
        :MONTO_APLICACIONES,
        :nclie,
        :suso,
        :STATUS,
        :usuario_pegaso,
        current_timestamp,
        current_timestamp,
        :IDIMP,
        :UUID,
        :DESCF,
        :IDCAJA
        );
        update refacturacion set factura_nueva = :foliof, resultado = 'ejecutado', status_solicitud = 5, usuario_autoriza = :usuario, usuario_ejecuta = :usuario, fecha_ejecuta = current_timestamp,  fecha_autoriza = current_timestamp where id = :idsol;
        termino = 1;
        uso= :suso;
        mp = :smp;
        fp = :sfp;
        ncliente = :nclie;
        nrfc = :rfc;



  factura_nueva = cve_doc;
  usoCFDI = :uso_cfdi;
  mpago = :formadepagosat;
  tpago = :metododepago;


end